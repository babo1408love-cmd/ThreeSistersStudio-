<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš¡ ì›¹ì—”ì§„ - ì›¹ ê²Œì„ ì—”ì§„</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1e1e2e;--bg2:#181825;--bg3:#11111b;--bd:#313244;--ac:#89b4fa;--gn:#a6e3a1;--rd:#f38ba8;--yl:#f9e2af;--mv:#cba6f7;--pk:#f5c2e7;--tx:#cdd6f4;--tx2:#6c7086;--sk:#74c7ec;--or:#fab387}
body{background:var(--bg3);color:var(--tx);font-family:'Outfit',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none}
@keyframes orbSpin{to{filter:hue-rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
@keyframes typBounce{0%,100%{transform:translateY(0);opacity:.4}50%{transform:translateY(-3px);opacity:1}}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.toolbar{display:flex;align-items:center;background:var(--bg2);border-bottom:1px solid var(--bd);height:34px;flex-shrink:0}
.tg{display:flex;align-items:center;gap:1px;padding:0 4px;height:100%;border-right:1px solid var(--bd)}
.tb{background:none;border:none;color:var(--tx2);padding:3px 6px;font-size:.6em;cursor:pointer;border-radius:3px;font-family:'Outfit',sans-serif;display:flex;align-items:center;gap:2px;height:26px;transition:all .1s;white-space:nowrap}
.tb:hover{background:rgba(137,180,250,.1);color:var(--tx)}
.tb.on{background:rgba(137,180,250,.15);color:var(--ac)}
.tb.play{background:var(--gn);color:var(--bg3);font-weight:700}
.tb.stop{background:var(--rd);color:var(--bg3);font-weight:700}
.ttl{font-family:'JetBrains Mono',monospace;font-size:.65em;font-weight:700;color:var(--yl);padding:0 6px}
.tmd{font-family:'JetBrains Mono',monospace;font-size:.5em;color:var(--ac);padding:0 6px;background:rgba(137,180,250,.08);border-radius:10px;height:20px;display:flex;align-items:center}
.main{flex:1;display:flex;overflow:hidden}
.lp{width:200px;background:var(--bg2);border-right:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0}
.hdr{font-family:'JetBrains Mono',monospace;font-size:.48em;color:var(--sk);padding:4px 8px;border-bottom:1px solid var(--bd);letter-spacing:1px;font-weight:700;text-transform:uppercase;display:flex;justify-content:space-between;align-items:center}
.hdr span{cursor:pointer}
.hlist{flex:1;overflow-y:auto;padding:2px}
.hi{display:flex;align-items:center;gap:3px;padding:2px 4px;border-radius:3px;font-size:.54em;cursor:pointer;transition:all .06s;margin-bottom:1px}
.hi:hover{background:rgba(137,180,250,.06)}.hi.sel{background:rgba(137,180,250,.12);color:var(--ac)}
.hi .ic{font-size:.85em;width:14px;text-align:center}.hi .nm{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.vp{flex:1;position:relative;background:#000}
.vp canvas{width:100%;height:100%}
.vpi{position:absolute;top:4px;left:6px;font-family:'JetBrains Mono',monospace;font-size:.46em;color:var(--tx2);background:rgba(0,0,0,.5);padding:2px 6px;border-radius:3px}
.phud{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);border:1px solid var(--gn);border-radius:6px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:.5em;color:var(--gn);display:none}
.fps{position:absolute;top:4px;left:50%;transform:translateX(-50%);font-family:'JetBrains Mono',monospace;font-size:.46em;color:var(--yl);background:rgba(0,0,0,.4);padding:1px 5px;border-radius:3px}
.rp{width:240px;background:var(--bg2);border-left:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.isc{padding:6px 8px;border-bottom:1px solid var(--bd)}
.ist{font-size:.48em;color:var(--yl);font-weight:700;margin-bottom:3px;font-family:'JetBrains Mono',monospace;letter-spacing:.5px}
.ir{display:flex;align-items:center;gap:3px;margin-bottom:2px}
.il{font-size:.5em;color:var(--tx2);min-width:20px}
.iv{font-family:'JetBrains Mono',monospace;font-size:.48em;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:2px 3px;border-radius:2px;width:46px;text-align:center}
.irng{flex:1;accent-color:var(--ac);height:13px}
.ich{accent-color:var(--ac)}
.con{height:64px;background:var(--bg2);border-top:1px solid var(--bd);display:flex;flex-direction:column;flex-shrink:0}
.conh{font-family:'JetBrains Mono',monospace;font-size:.44em;color:var(--tx2);padding:2px 7px;border-bottom:1px solid var(--bd);display:flex;gap:6px}
.conh span{cursor:pointer}.conh span:hover{color:var(--tx)}
.conb{flex:1;overflow-y:auto;padding:2px 7px;font-family:'JetBrains Mono',monospace;font-size:.46em}
.lg{padding:1px 0;border-bottom:1px solid rgba(49,50,68,.2)}
.lg.i{color:var(--tx2)}.lg.w{color:var(--yl)}.lg.e{color:var(--rd)}.lg.o{color:var(--gn)}
.toast{position:fixed;top:6px;left:50%;transform:translateX(-50%) translateY(-40px);background:var(--ac);color:var(--bg3);padding:4px 12px;border-radius:5px;font-size:.62em;font-weight:600;z-index:99;transition:transform .2s;pointer-events:none}
.toast.on{transform:translateX(-50%) translateY(0)}
/* Data browser */
.dtabs{display:flex;gap:1px;flex-wrap:wrap;padding:3px 4px;border-bottom:1px solid var(--bd)}
.dtab{font-size:.44em;padding:2px 5px;background:var(--bg3);border:1px solid var(--bd);border-radius:3px;cursor:pointer;color:var(--tx2);transition:all .1s}
.dtab:hover{border-color:var(--ac);color:var(--tx)}.dtab.on{background:rgba(137,180,250,.15);color:var(--ac);border-color:var(--ac)}
.di{padding:3px 5px;margin:2px 3px;background:var(--bg3);border:1px solid var(--bd);border-radius:3px;cursor:pointer;transition:all .08s}
.di:hover{border-color:var(--ac);background:rgba(137,180,250,.04)}
.di .dn{font-size:.52em;font-weight:600}.di .dd{font-size:.42em;color:var(--tx2);margin-top:1px}
.di .ds{display:flex;gap:4px;margin-top:2px;font-family:'JetBrains Mono',monospace;font-size:.4em}
.di .ds span{padding:1px 3px;border-radius:2px;background:rgba(0,0,0,.3)}
.gc{color:#a6adc8}.gr{color:var(--ac)}.ge{color:var(--mv)}.gm{color:var(--yl)}.gl{color:var(--or)}.gd{color:var(--rd)}
</style>
</head>
<body>
<div class="toolbar">
<div class="ttl">âš¡ ì›¹ì—”ì§„</div>
<div class="tg">
<button class="tb" onclick="AO('cube')">ğŸ“¦íë¸Œ</button>
<button class="tb" onclick="AO('sphere')">ğŸ€êµ¬</button>
<button class="tb" onclick="AO('cyl')">ğŸ§Šì›ê¸°ë‘¥</button>
<button class="tb" onclick="AO('cone')">ğŸ”ºì½˜</button>
<button class="tb" onclick="AO('torus')">ğŸ©í† ëŸ¬ìŠ¤</button>
<button class="tb" onclick="AO('plane')">â¬œí‰ë©´</button>
<button class="tb" onclick="AO('stk')">ğŸ§ìºë¦­í„°</button>
<button class="tb" onclick="AO('light')">ğŸ’¡ì¡°ëª…</button>
<button class="tb" onclick="AO('particle')">âœ¨íŒŒí‹°í´</button>
</div>
<div class="tg">
<button class="tb on" id="gM" onclick="SG('m')">âœ¥ì´ë™</button>
<button class="tb" id="gR" onclick="SG('r')">â†»íšŒì „</button>
<button class="tb" id="gS" onclick="SG('s')">â‡²í¬ê¸°</button>
</div>
<div class="tg">
<button class="tb" onclick="DS()">ğŸ—‘ì‚­ì œ</button>
<button class="tb" onclick="DU()">ğŸ“‹ë³µì œ</button>
</div>
<div class="tg">
<button class="tb" onclick="toggleData()">ğŸ“Šë°ì´í„°</button>
<button class="tb" onclick="importJSON()">ğŸ“‚ê°€ì ¸ì˜¤ê¸°</button>
</div>
<div class="tg">
<button class="tb" style="background:rgba(203,166,247,.15);color:var(--mv);font-weight:600" onclick="openAI()">ğŸ¤–ìºë¦­í„°</button>
<button class="tb" style="background:rgba(166,227,161,.15);color:var(--gn);font-weight:600" onclick="openSndAI()">ğŸ”Šì‚¬ìš´ë“œ</button>
<button class="tb" style="background:rgba(137,180,250,.15);color:var(--ac);font-weight:600" onclick="openLangAI()">ğŸŒë²ˆì—­</button>
<button class="tb" style="background:rgba(249,226,175,.15);color:var(--yl);font-weight:600" onclick="openMapAI()">ğŸ—ºë§µìƒì„±</button>
<button class="tb" style="background:rgba(155,138,255,.12);color:#b8a8ff;font-weight:600" onclick="openDialogAI()">ğŸ’¬ëŒ€í™”</button>
<button class="tb" style="background:rgba(245,194,231,.12);color:var(--pk);font-weight:600" onclick="openTexAI()">ğŸ¨í…ìŠ¤ì²˜</button>
<button class="tb" style="background:rgba(134,239,172,.12);color:#7deba0;font-weight:600" onclick="openMusicAI()">ğŸµì‘ê³¡</button>
<button class="tb" style="background:rgba(96,165,250,.12);color:#7db8fa;font-weight:600" onclick="openBalanceAI()">âš–ë°¸ëŸ°ìŠ¤</button>
<button class="tb" style="background:rgba(203,166,247,.12);color:#c4a8f7;font-weight:600" onclick="openLevelAI()">ğŸ—ë ˆë²¨</button>
<button class="tb" style="background:rgba(116,199,236,.12);color:var(--sk);font-weight:600" onclick="openReviewAI()">ğŸ”ë¦¬ë·°</button>
<button class="tb" style="background:linear-gradient(135deg,rgba(110,86,207,.25),rgba(245,194,231,.15),rgba(134,239,172,.15));color:#e0b0ff;font-weight:700;letter-spacing:1px" onclick="openFamily()">ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ ì„¸ìë§¤</button>
<button class="tb" style="background:linear-gradient(135deg,rgba(96,165,250,.25),rgba(34,211,238,.15));color:#93c5fd;font-weight:700;letter-spacing:1px" onclick="openTeacher()">ğŸ“ ì„ ìƒë‹˜</button>
</div>
<div class="tg">
<button class="tb" onclick="saveScene()">ğŸ’¾ì €ì¥</button>
<button class="tb" onclick="loadScene()">ğŸ“‚ë¶ˆëŸ¬ì˜¤ê¸°</button>
<button class="tb" onclick="openSaveModal()">ğŸ’¾ìŠ¬ë¡¯</button>
<button class="tb" onclick="undo()" title="Ctrl+Z">â†©ë˜ëŒë¦¬ê¸°</button>
<button class="tb" onclick="redo()" title="Ctrl+Y">â†ªë‹¤ì‹œ</button>
</div>
<div class="tg">
<button class="tb" onclick="savePrefab()">ğŸ“¦í”„ë¦¬íŒ¹</button>
<button class="tb" onclick="toggleDebug()" title="F3">ğŸ›ë””ë²„ê·¸</button>
<button class="tb" onclick="startTutorial()" title="F1">ğŸ“–íŠœí† ë¦¬ì–¼</button>
<button class="tb" style="background:rgba(96,165,250,.12);color:#60a5fa;font-weight:600" onclick="openNodeEditor()">ğŸ”·ë…¸ë“œ</button>
<button class="tb" onclick="openPartEditor()">ğŸ†íŒŒí‹°í´</button>
<button class="tb" onclick="openMatEditor()">ğŸ”²ë¨¸í‹°ë¦¬ì–¼</button>
<button class="tb" onclick="$('buildModal').style.display='flex'">ğŸ“¦ë¹Œë“œ</button>
</div>
<div class="tg" style="position:relative">
<button class="tb" onclick="$('skyMenu').style.display=$('skyMenu').style.display==='block'?'none':'block'">ğŸŒ¤í™˜ê²½</button>
<div id="skyMenu" style="display:none;position:absolute;top:100%;left:0;background:var(--bg2);border:1px solid var(--bd);border-radius:6px;padding:4px;z-index:50;min-width:120px">
<div style="font-size:.45em;color:var(--yl);font-weight:700;padding:2px 4px">ğŸŒ¤ í™˜ê²½ í”„ë¦¬ì…‹</div>
<div onclick="setSkybox('day');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">â˜€ï¸ ë§‘ì€ ë‚®</div>
<div onclick="setSkybox('sunset');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">ğŸŒ… ì„ì–‘</div>
<div onclick="setSkybox('night');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">ğŸŒ™ ë°¤</div>
<div onclick="setSkybox('storm');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">â›ˆ í­í’</div>
<div onclick="setSkybox('snow');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">â„ï¸ ëˆˆ</div>
<div onclick="setSkybox('fog');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">ğŸŒ« ì•ˆê°œ</div>
<div style="border-top:1px solid var(--bd);margin-top:2px;padding-top:2px">
<div onclick="createTerrain(30,50);$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--gn)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">â›° ì§€í˜• ìƒì„±</div>
</div>
<div style="border-top:1px solid var(--bd);margin-top:2px;padding-top:2px">
<div style="font-size:.45em;color:var(--sk);font-weight:700;padding:2px 4px">ğŸŒ§ ë‚ ì”¨</div>
<div onclick="setWeather('clear');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">â˜€ï¸ ë§‘ìŒ</div>
<div onclick="setWeather('rain');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">ğŸŒ§ ë¹„</div>
<div onclick="setWeather('snow');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">â„ï¸ ëˆˆ</div>
<div onclick="setWeather('storm');$('skyMenu').style.display='none'" style="font-size:.5em;padding:3px 6px;cursor:pointer;border-radius:3px;color:var(--tx)" onmouseover="this.style.background='rgba(137,180,250,.1)'" onmouseout="this.style.background=''">â›ˆ í­í’</div>
</div>
<div style="flex:1"></div>
<div class="tg"><button class="tb play" id="pBtn" onclick="TP()">â–¶ ì‹¤í–‰</button></div>
<div class="tmd" id="mLbl">í¸ì§‘</div>
</div>
<div class="main">
<div class="lp">
<div class="hdr">ğŸ“‹ ê³„ì¸µêµ¬ì¡° <span style="color:var(--gn)" onclick="AO('cube')">+</span></div>
<div class="hlist" id="HL"></div>
<div id="DP" style="display:none">
<div class="hdr" style="color:var(--yl)">ğŸ“Š ê²Œì„ ë°ì´í„° <span style="color:var(--tx2);font-weight:400" id="dcnt"></span></div>
<div class="dtabs" id="DT"></div>
<div id="DL" style="max-height:300px;overflow-y:auto"></div>
</div>
</div>
<div class="vp">
<canvas id="C"></canvas>
<div class="vpi" id="VI">í¸ì§‘ | 0ê°œ</div>
<div class="fps" id="FPS">60</div>
<div class="phud" id="PH">ğŸ® WASD ì´ë™ | SPACE ì í”„ | MOUSE ì‹œì  | ESC ì •ì§€</div>
</div>
<div class="rp">
<div class="hdr">ğŸ”§ ì†ì„±ì°½</div>
<div id="IB"><div class="isc"><div style="font-size:.5em;color:var(--tx2);text-align:center;padding:14px 0">ì˜¤ë¸Œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div></div>
</div>
</div>
<div class="con">
<div class="conh"><span style="color:var(--ac)">ì½˜ì†”</span><span onclick="CL()">ì§€ìš°ê¸°</span><span id="OC" style="margin-left:auto;color:var(--tx2)">0</span></div>
<div class="conb" id="CB"></div>
</div>
<div class="toast" id="TT"></div>
<!-- AI ìºë¦­í„° ìƒì„± ëª¨ë‹¬ -->
<div id="aiModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--mv);border-radius:10px;width:380px;max-height:85vh;overflow-y:auto;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.5)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-family:'JetBrains Mono',monospace;font-size:.8em;font-weight:700;color:var(--mv)">ğŸ¤– AI ìºë¦­í„° ìƒì„±ê¸°</div>
<button onclick="closeAI()" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button>
</div>
<div style="font-size:.55em;color:var(--tx2);margin-bottom:10px">AIê°€ ëœë¤ ë˜ëŠ” ì¡°ê±´ì— ë§ëŠ” ìºë¦­í„°ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤</div>
<div style="display:flex;flex-direction:column;gap:6px">
<div style="display:flex;gap:6px">
<div style="flex:1"><label style="font-size:.5em;color:var(--tx2)">ì§ì—…</label>
<select id="aiCls" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.7em">
<option value="">ğŸ² ëœë¤</option><option value="ì „ì‚¬">âš”ï¸ ì „ì‚¬</option><option value="ë§ˆë²•ì‚¬">ğŸ§™ ë§ˆë²•ì‚¬</option><option value="ë„ì ">ğŸ—¡ ë„ì </option><option value="ê¶ìˆ˜">ğŸ¹ ê¶ìˆ˜</option><option value="ì„±ê¸°ì‚¬">ğŸ›¡ ì„±ê¸°ì‚¬</option><option value="íëŸ¬">ğŸ’š íëŸ¬</option><option value="ì†Œí™˜ì‚¬">ğŸ‘» ì†Œí™˜ì‚¬</option><option value="ì•”ì‚´ì">ğŸ’€ ì•”ì‚´ì</option>
</select></div>
<div style="flex:1"><label style="font-size:.5em;color:var(--tx2)">ë“±ê¸‰</label>
<select id="aiGrade" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.7em">
<option value="">ğŸ² ëœë¤</option><option value="common">â¬œ ì¼ë°˜</option><option value="rare">ğŸ”µ ë ˆì–´</option><option value="epic">ğŸŸ£ ì—í”½</option><option value="mythic">ğŸŸ¡ ì‹ í™”</option><option value="legendary">ğŸŸ  ì „ì„¤</option>
</select></div>
</div>
<div style="display:flex;gap:6px">
<div style="flex:1"><label style="font-size:.5em;color:var(--tx2)">ì¢…ì¡±</label>
<select id="aiRace" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.7em">
<option value="">ğŸ² ëœë¤</option><option value="ì¸ê°„">ğŸ§‘ ì¸ê°„</option><option value="ì—˜í”„">ğŸ§ ì—˜í”„</option><option value="ë“œì›Œí”„">â› ë“œì›Œí”„</option><option value="ì˜¤í¬">ğŸ‘¹ ì˜¤í¬</option><option value="ë“œë˜ê³¤ë³¸">ğŸ‰ ë“œë˜ê³¤ë³¸</option><option value="ì–¸ë°ë“œ">ğŸ’€ ì–¸ë°ë“œ</option><option value="ì²œì‚¬ì¡±">ğŸ‘¼ ì²œì‚¬ì¡±</option><option value="ì•…ë§ˆì¡±">ğŸ˜ˆ ì•…ë§ˆì¡±</option>
</select></div>
<div style="flex:1"><label style="font-size:.5em;color:var(--tx2)">ì†ì„±</label>
<select id="aiEl" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.7em">
<option value="">ğŸ² ëœë¤</option><option value="í™”ì—¼">ğŸ”¥ í™”ì—¼</option><option value="ëƒ‰ê¸°">â„ï¸ ëƒ‰ê¸°</option><option value="ë²ˆê°œ">âš¡ ë²ˆê°œ</option><option value="ëŒ€ì§€">ğŸŒ ëŒ€ì§€</option><option value="ë¹›">âœ¨ ë¹›</option><option value="ì–´ë‘ ">ğŸŒ‘ ì–´ë‘ </option><option value="ìì—°">ğŸŒ¿ ìì—°</option><option value="ë¬´ì†ì„±">âšª ë¬´ì†ì„±</option>
</select></div>
</div>
<div><label style="font-size:.5em;color:var(--tx2)">ìƒì„± ìˆ˜</label>
<input type="range" id="aiCnt" min="1" max="10" value="1" oninput="$('aiCntV').textContent=this.value" style="width:calc(100% - 30px);accent-color:var(--mv)">
<span id="aiCntV" style="font-size:.6em;color:var(--mv)">1</span>
</div>
<button onclick="aiGenerate()" style="width:100%;padding:8px;background:var(--mv);color:var(--bg3);border:none;border-radius:6px;font-size:.75em;font-weight:700;cursor:pointer;margin-top:4px;font-family:'Outfit',sans-serif">ğŸ¤– AIë¡œ ìºë¦­í„° ìƒì„±í•˜ê¸°!</button>
<div id="aiResult" style="max-height:200px;overflow-y:auto;margin-top:6px"></div>
</div>
</div>
</div>
<!-- ğŸ”Š ì‚¬ìš´ë“œ AI ëª¨ë‹¬ -->
<div id="sndModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--gn);border-radius:10px;width:400px;max-height:85vh;overflow-y:auto;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.5)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="font-family:'JetBrains Mono',monospace;font-size:.8em;font-weight:700;color:var(--gn)">ğŸ”Š AI ì‚¬ìš´ë“œ ìƒì„±ê¸°</div>
<button onclick="$('sndModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button>
</div>
<div style="font-size:.5em;color:var(--tx2);margin-bottom:8px">Web Audio APIë¡œ ê²Œì„ íš¨ê³¼ìŒ/ë°°ê²½ìŒì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤</div>
<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px" id="sndPresets">
<button class="dtab on" onclick="sndCat='íš¨ê³¼ìŒ';sndBuild()" style="font-size:.5em">ğŸ’¥ íš¨ê³¼ìŒ</button>
<button class="dtab" onclick="sndCat='ë°°ê²½ìŒ';sndBuild()" style="font-size:.5em">ğŸµ ë°°ê²½ìŒ</button>
<button class="dtab" onclick="sndCat='í™˜ê²½ìŒ';sndBuild()" style="font-size:.5em">ğŸŒ¿ í™˜ê²½ìŒ</button>
<button class="dtab" onclick="sndCat='UI';sndBuild()" style="font-size:.5em">ğŸ–± UIìŒ</button>
</div>
<div id="sndList" style="max-height:300px;overflow-y:auto"></div>
<div style="margin-top:8px;display:flex;gap:4px">
<button onclick="sndGenRandom()" style="flex:1;padding:6px;background:var(--gn);color:var(--bg3);border:none;border-radius:5px;font-size:.65em;font-weight:700;cursor:pointer">ğŸ² ëœë¤ ìƒì„±</button>
<button onclick="sndExportAll()" style="flex:1;padding:6px;background:var(--bg3);color:var(--gn);border:1px solid var(--gn);border-radius:5px;font-size:.65em;cursor:pointer">ğŸ’¾ ì „ì²´ ì €ì¥</button>
</div>
</div>
</div>
<!-- ğŸŒ ë‹¤êµ­ì–´ AI ëª¨ë‹¬ -->
<div id="langModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--ac);border-radius:10px;width:420px;max-height:85vh;overflow-y:auto;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.5)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="font-family:'JetBrains Mono',monospace;font-size:.8em;font-weight:700;color:var(--ac)">ğŸŒ AI ë‹¤êµ­ì–´ ë²ˆì—­ê¸°</div>
<button onclick="$('langModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button>
</div>
<div style="font-size:.5em;color:var(--tx2);margin-bottom:8px">ê²Œì„ í…ìŠ¤íŠ¸ë¥¼ 12ê°œ ì–¸ì–´ë¡œ ìë™ ë²ˆì—­í•©ë‹ˆë‹¤</div>
<div><label style="font-size:.48em;color:var(--tx2)">ë²ˆì—­í•  í…ìŠ¤íŠ¸ (í•œêµ­ì–´)</label>
<textarea id="langSrc" style="width:100%;height:60px;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:6px;border-radius:4px;font-size:.7em;font-family:'Outfit',sans-serif;resize:vertical" placeholder="ë²ˆì—­í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea></div>
<div style="display:flex;gap:4px;flex-wrap:wrap;margin:6px 0">
<label style="font-size:.44em;color:var(--tx2)">ëŒ€ìƒ ì–¸ì–´:</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lEN" checked> ğŸ‡ºğŸ‡¸ì˜ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lJA" checked> ğŸ‡¯ğŸ‡µì¼ë³¸ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lZH" checked> ğŸ‡¨ğŸ‡³ì¤‘êµ­ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lES"> ğŸ‡ªğŸ‡¸ìŠ¤í˜ì¸ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lFR"> ğŸ‡«ğŸ‡·í”„ë‘ìŠ¤ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lDE"> ğŸ‡©ğŸ‡ªë…ì¼ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lPT"> ğŸ‡§ğŸ‡·í¬ë¥´íˆ¬ê°ˆì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lRU"> ğŸ‡·ğŸ‡ºëŸ¬ì‹œì•„ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lAR"> ğŸ‡¸ğŸ‡¦ì•„ëì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lHI"> ğŸ‡®ğŸ‡³íŒë””ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lTH"> ğŸ‡¹ğŸ‡­íƒœêµ­ì–´</label>
<label style="font-size:.44em"><input type="checkbox" class="ich" id="lVI"> ğŸ‡»ğŸ‡³ë² íŠ¸ë‚¨ì–´</label>
</div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<select id="langType" style="flex:1;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.6em">
<option value="ui">ğŸ–± UI í…ìŠ¤íŠ¸</option><option value="dialog">ğŸ’¬ ëŒ€í™”/ëŒ€ì‚¬</option><option value="skill">âš”ï¸ ìŠ¤í‚¬ëª…</option><option value="item">ğŸ’ ì•„ì´í…œëª…</option><option value="story">ğŸ“– ìŠ¤í† ë¦¬</option><option value="system">âš™ï¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€</option>
</select>
<button onclick="langTranslate()" style="flex:1;padding:6px;background:var(--ac);color:var(--bg3);border:none;border-radius:5px;font-size:.65em;font-weight:700;cursor:pointer">ğŸŒ ë²ˆì—­ ìƒì„±</button>
</div>
<div id="langResult" style="max-height:250px;overflow-y:auto"></div>
<button onclick="langExport()" style="width:100%;padding:5px;background:var(--bg3);color:var(--ac);border:1px solid var(--ac);border-radius:5px;font-size:.6em;cursor:pointer;margin-top:4px">ğŸ’¾ ë²ˆì—­ JSON ë‚´ë³´ë‚´ê¸°</button>
</div>
</div>
<!-- ğŸ—º ë§µ AI ëª¨ë‹¬ -->
<div id="mapModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--yl);border-radius:10px;width:440px;max-height:85vh;overflow-y:auto;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.5)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="font-family:'JetBrains Mono',monospace;font-size:.8em;font-weight:700;color:var(--yl)">ğŸ—º AI ë§µ ìƒì„±ê¸°</div>
<button onclick="$('mapModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button>
</div>
<div style="font-size:.5em;color:var(--tx2);margin-bottom:8px">ì ˆì°¨ì  ìƒì„±ìœ¼ë¡œ íƒ€ì¼ë§µì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤</div>
<div style="display:flex;gap:6px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.48em;color:var(--tx2)">ë§µ ìœ í˜•</label>
<select id="mapType" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em">
<option value="dungeon">ğŸ° ë˜ì „</option><option value="field">ğŸŒ¿ í•„ë“œ</option><option value="cave">ğŸ•³ ë™êµ´</option><option value="castle">ğŸ¯ ì„±</option><option value="forest">ğŸŒ² ìˆ²</option><option value="desert">ğŸœ ì‚¬ë§‰</option><option value="snow">â„ï¸ ì„¤ì›</option><option value="volcano">ğŸŒ‹ í™”ì‚°</option>
</select></div>
<div style="flex:1"><label style="font-size:.48em;color:var(--tx2)">í¬ê¸°</label>
<select id="mapSize" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em">
<option value="16">16Ã—16 (ì†Œí˜•)</option><option value="24" selected>24Ã—24 (ì¤‘í˜•)</option><option value="32">32Ã—32 (ëŒ€í˜•)</option><option value="48">48Ã—48 (ì´ˆëŒ€í˜•)</option>
</select></div>
</div>
<div style="display:flex;gap:6px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.48em;color:var(--tx2)">ë°© ë°€ë„</label>
<input type="range" id="mapDens" min="1" max="10" value="5" style="width:100%;accent-color:var(--yl)"></div>
<div style="flex:1"><label style="font-size:.48em;color:var(--tx2)">ëª¬ìŠ¤í„° ë°°ì¹˜</label>
<input type="range" id="mapMon" min="0" max="10" value="3" style="width:100%;accent-color:var(--rd)"></div>
</div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<label style="font-size:.44em;color:var(--tx2)"><input type="checkbox" class="ich" id="mapBoss" checked> ë³´ìŠ¤ë°©</label>
<label style="font-size:.44em;color:var(--tx2)"><input type="checkbox" class="ich" id="mapTreasure" checked> ë³´ë¬¼ë°©</label>
<label style="font-size:.44em;color:var(--tx2)"><input type="checkbox" class="ich" id="mapSecret"> ìˆ¨ê²¨ì§„ë°©</label>
<label style="font-size:.44em;color:var(--tx2)"><input type="checkbox" class="ich" id="map3D" checked> 3D ìŠ¤í°</label>
</div>
<button onclick="mapGenerate()" style="width:100%;padding:8px;background:var(--yl);color:var(--bg3);border:none;border-radius:6px;font-size:.75em;font-weight:700;cursor:pointer">ğŸ—º ë§µ ìƒì„±!</button>
<canvas id="mapCV" width="400" height="400" style="width:100%;margin-top:8px;border:1px solid var(--bd);border-radius:6px;background:#111;display:none"></canvas>
<div id="mapInfo" style="font-size:.45em;color:var(--tx2);margin-top:4px"></div>
<button onclick="mapExport()" style="width:100%;padding:5px;background:var(--bg3);color:var(--yl);border:1px solid var(--yl);border-radius:5px;font-size:.6em;cursor:pointer;margin-top:4px;display:none" id="mapExpBtn">ğŸ’¾ ë§µ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
</div>
</div>
<!-- ğŸ’¬ AI ëŒ€í™” ìƒì„±ê¸° (ë®¤ì¦ˆ) -->
<div id="dialogModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid #9b8aff;border-radius:10px;width:460px;max-height:88vh;overflow-y:auto;padding:14px;box-shadow:0 8px 32px rgba(0,0,0,.5)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:#9b8aff">ğŸ’¬ AI ëŒ€í™” ìƒì„±ê¸° <span style="font-size:.7em;color:var(--tx2)">â—ˆë®¤ì¦ˆ</span></div><button onclick="$('dialogModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div style="font-size:.45em;color:var(--tx2);margin-bottom:6px">NPC ëŒ€ì‚¬Â·ëŒ€í™” íŠ¸ë¦¬Â·í€˜ìŠ¤íŠ¸ ëŒ€í™”ë¥¼ ìë™ ìƒì„±</div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">NPC ì´ë¦„</label><input id="dlgName" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em" placeholder="ì˜ˆ: ëŒ€ì¥ê°„ ë…¸ì¸"></div>
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">ì„±ê²©</label><select id="dlgPers" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em"><option>ì¹œì ˆ</option><option>ë¬´ëšëš</option><option>ìœ ë¨¸ëŸ¬ìŠ¤</option><option>ì‹ ë¹„ë¡œìš´</option><option>ê±°ì¹œ</option><option>ìŠ¬í”ˆ</option></select></div>
</div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">ì—­í• </label><select id="dlgRole" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em"><option>ìƒì¸</option><option>í€˜ìŠ¤íŠ¸ ì˜ë¢°ì¸</option><option>ë§ˆì„ ì£¼ë¯¼</option><option>í˜„ì/ìŠ¤ìŠ¹</option><option>ë™ë£Œ</option><option>ì ëŒ€</option></select></div>
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">ëŒ€í™” ìˆ˜</label><input type="range" id="dlgCnt" min="3" max="10" value="5" style="width:100%;accent-color:#9b8aff"><span id="dlgCntV" style="font-size:.5em;color:#9b8aff">5</span></div>
</div>
<input id="dlgCtx" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.6em;margin-bottom:6px" placeholder="ì¶”ê°€ ì»¨í…ìŠ¤íŠ¸ (ì˜ˆ: ìš©ì„ ì²˜ì¹˜í•œ í›„, ì²« ë§Œë‚¨...)">
<button onclick="dlgGenerate()" style="width:100%;padding:7px;background:#9b8aff;color:#000;border:none;border-radius:6px;font-size:.7em;font-weight:700;cursor:pointer">ğŸ’¬ ëŒ€í™” ìƒì„±!</button>
<div id="dlgResult" style="max-height:250px;overflow-y:auto;margin-top:6px;font-size:.5em"></div>
<button onclick="dlgExport()" id="dlgExpBtn" style="display:none;width:100%;padding:4px;background:var(--bg3);color:#9b8aff;border:1px solid #9b8aff;border-radius:5px;font-size:.55em;cursor:pointer;margin-top:4px">ğŸ’¾ ëŒ€í™” JSON ë‚´ë³´ë‚´ê¸°</button>
</div></div>
<!-- ğŸ¨ AI í…ìŠ¤ì²˜ ìƒì„±ê¸° (ì•„ë¦¬ì•„) -->
<div id="texModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--pk);border-radius:10px;width:440px;max-height:88vh;overflow-y:auto;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--pk)">ğŸ¨ AI í…ìŠ¤ì²˜ ìƒì„±ê¸° <span style="font-size:.7em;color:var(--tx2)">â—†ì•„ë¦¬ì•„</span></div><button onclick="$('texModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px" id="texPresets"></div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">í¬ê¸°</label><select id="texSize" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em"><option value="128">128</option><option value="256" selected>256</option><option value="512">512</option></select></div>
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">ìŠ¤ì¼€ì¼</label><input type="range" id="texScale" min="1" max="20" value="8" style="width:100%;accent-color:var(--pk)"></div>
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">ê±°ì¹ ê¸°</label><input type="range" id="texRough" min="0" max="100" value="50" style="width:100%;accent-color:var(--pk)"></div>
</div>
<button onclick="texGenerate()" style="width:100%;padding:7px;background:var(--pk);color:#000;border:none;border-radius:6px;font-size:.7em;font-weight:700;cursor:pointer">ğŸ¨ í…ìŠ¤ì²˜ ìƒì„±!</button>
<canvas id="texCV" width="256" height="256" style="width:100%;margin-top:6px;border:1px solid var(--bd);border-radius:6px;display:none"></canvas>
<div id="texInfo" style="font-size:.45em;color:var(--tx2);margin-top:4px"></div>
<button onclick="texApply()" id="texApplyBtn" style="display:none;width:100%;padding:4px;background:var(--bg3);color:var(--pk);border:1px solid var(--pk);border-radius:5px;font-size:.55em;cursor:pointer;margin-top:4px">âœ… ì„ íƒ ì˜¤ë¸Œì íŠ¸ì— ì ìš©</button>
</div></div>
<!-- ğŸµ AI ì‘ê³¡ê¸° (ë©œë¡œë””) -->
<div id="musicModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--gn);border-radius:10px;width:420px;max-height:88vh;overflow-y:auto;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--gn)">ğŸµ AI ì‘ê³¡ê¸° <span style="font-size:.7em;color:var(--tx2)">â™ªë©œë¡œë””</span></div><button onclick="$('musicModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px" id="musicGenres"></div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">BPM</label><input type="range" id="musBPM" min="60" max="180" value="120" oninput="$('musBPMV').textContent=this.value" style="width:100%;accent-color:var(--gn)"><span id="musBPMV" style="font-size:.5em;color:var(--gn)">120</span></div>
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">ë§ˆë””</label><select id="musBars" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em"><option value="8">8ë§ˆë””</option><option value="16" selected>16ë§ˆë””</option><option value="32">32ë§ˆë””</option></select></div>
</div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="musLoop" checked> ë£¨í”„</label>
<label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="musDrum" checked> ë“œëŸ¼</label>
<label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="musBass" checked> ë² ì´ìŠ¤</label>
</div>
<button onclick="musGenerate()" style="width:100%;padding:7px;background:var(--gn);color:#000;border:none;border-radius:6px;font-size:.7em;font-weight:700;cursor:pointer">ğŸµ ì‘ê³¡ ì‹œì‘!</button>
<div id="musResult" style="margin-top:6px;font-size:.5em"></div>
<div style="display:flex;gap:3px;margin-top:4px"><button onclick="musPlay()" id="musPlayBtn" style="display:none;flex:1;padding:4px;background:var(--gn);color:#000;border:none;border-radius:5px;font-size:.55em;font-weight:600;cursor:pointer">â–¶ ì¬ìƒ</button><button onclick="musStop()" id="musStopBtn" style="display:none;flex:1;padding:4px;background:var(--rd);color:#fff;border:none;border-radius:5px;font-size:.55em;cursor:pointer">â¹ ì •ì§€</button></div>
</div></div>
<!-- âš– AI ë°¸ëŸ°ìŠ¤ ë¶„ì„ê¸° -->
<div id="balModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--ac);border-radius:10px;width:500px;max-height:88vh;overflow-y:auto;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--ac)">âš– AI ë°¸ëŸ°ìŠ¤ ë¶„ì„ê¸° <span style="font-size:.7em;color:var(--tx2)">ğŸ“ì„ ìƒë‹˜</span></div><button onclick="$('balModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px">
<button class="dtab on" onclick="balAnalyze('combat')">âš”ì „íˆ¬</button>
<button class="dtab" onclick="balAnalyze('economy')">ğŸ’°ê²½ì œ</button>
<button class="dtab" onclick="balAnalyze('level')">ğŸ“ˆë ˆë²¨ë§</button>
<button class="dtab" onclick="balAnalyze('items')">ğŸ’ì•„ì´í…œ</button>
<button class="dtab" onclick="balAnalyze('full')">ğŸ“Šì „ì²´</button>
</div>
<canvas id="balCV" width="460" height="200" style="width:100%;border:1px solid var(--bd);border-radius:6px;display:none"></canvas>
<div id="balResult" style="max-height:300px;overflow-y:auto;margin-top:6px;font-size:.48em"></div>
</div></div>
<!-- ğŸ— AI ë ˆë²¨ ë””ìì´ë„ˆ -->
<div id="levelModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--mv);border-radius:10px;width:440px;max-height:88vh;overflow-y:auto;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--mv)">ğŸ— AI ë ˆë²¨ ë””ìì´ë„ˆ</div><button onclick="$('levelModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<input id="lvlPrompt" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:6px;border-radius:4px;font-size:.65em;margin-bottom:6px" placeholder="ìì—°ì–´: ì˜ˆ) ë ˆë²¨3 ìˆ² ë˜ì „, ë³´ìŠ¤ ìˆìŒ, ë³´ë¬¼ 3ê°œ">
<div style="display:flex;gap:4px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">ë‚œì´ë„</label><select id="lvlDiff" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em"><option>ì‰¬ì›€</option><option selected>ë³´í†µ</option><option>ì–´ë ¤ì›€</option><option>ì§€ì˜¥</option></select></div>
<div style="flex:1"><label style="font-size:.45em;color:var(--tx2)">í…Œë§ˆ</label><select id="lvlTheme" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:4px;border-radius:4px;font-size:.65em"><option>ìˆ²</option><option>ë˜ì „</option><option>ì‚¬ë§‰</option><option>ì„¤ì›</option><option>í™”ì‚°</option><option>ì„±</option></select></div>
</div>
<button onclick="lvlGenerate()" style="width:100%;padding:7px;background:var(--mv);color:#000;border:none;border-radius:6px;font-size:.7em;font-weight:700;cursor:pointer">ğŸ— ë ˆë²¨ ìë™ ìƒì„±!</button>
<div id="lvlResult" style="margin-top:6px;font-size:.48em"></div>
</div></div>
<!-- ğŸ” AI ì½”ë“œ ë¦¬ë·° -->
<div id="reviewModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--sk);border-radius:10px;width:460px;max-height:88vh;overflow-y:auto;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--sk)">ğŸ” AI ì½”ë“œ ë¦¬ë·° <span style="font-size:.7em;color:var(--tx2)">ğŸ“ì„ ìƒë‹˜</span></div><button onclick="$('reviewModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div style="font-size:.45em;color:var(--tx2);margin-bottom:6px">ì”¬ì˜ ì „ì²´ ì„¤ì •ì„ AIê°€ ë¶„ì„í•˜ê³  ê°œì„ ì ì„ ì œì•ˆí•©ë‹ˆë‹¤</div>
<button onclick="reviewScene()" style="width:100%;padding:7px;background:var(--sk);color:#000;border:none;border-radius:6px;font-size:.7em;font-weight:700;cursor:pointer">ğŸ” ì”¬ ë¶„ì„ ì‹œì‘!</button>
<div id="reviewResult" style="margin-top:6px;font-size:.48em;max-height:400px;overflow-y:auto"></div>
</div></div>
<!-- ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ ì„¸ìë§¤ í†µí•© ì±„íŒ… íŒ¨ë„ -->
<div id="famPanel" style="display:none;position:fixed;right:0;top:34px;bottom:0;width:400px;background:rgba(10,10,18,.97);border-left:1px solid rgba(160,120,255,.2);z-index:90;backdrop-filter:blur(16px);flex-direction:column">
<div style="display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid #2a2a3a;gap:6px">
<div style="display:flex;gap:3px;flex-shrink:0">
<div style="width:18px;height:18px;border-radius:50%;background:conic-gradient(from 0deg,#6e56cf,#3dd68c,#9b8aff,#6e56cf);animation:orbSpin 4s linear infinite;position:relative"><div style="position:absolute;inset:2px;border-radius:50%;background:#12121a"></div></div>
<div style="width:18px;height:18px;border-radius:50%;background:conic-gradient(from 0deg,#f5c2e7,#f9a8d4,#c084fc,#f5c2e7);animation:orbSpin 5s linear infinite;position:relative"><div style="position:absolute;inset:2px;border-radius:50%;background:#12101a"></div></div>
<div style="width:18px;height:18px;border-radius:50%;background:conic-gradient(from 0deg,#86efac,#a7f3d0,#6ee7b7,#86efac);animation:orbSpin 6s linear infinite;position:relative"><div style="position:absolute;inset:2px;border-radius:50%;background:#0a1210"></div></div>
</div>
<div style="flex:1"><div style="font-size:.6em;font-weight:700;letter-spacing:1px;background:linear-gradient(135deg,#9b8aff,#f5c2e7,#86efac);-webkit-background-clip:text;-webkit-text-fill-color:transparent">ì„¸ìë§¤ ì±„íŒ…ë°© ğŸ’œğŸ’•ğŸ’š</div><div style="font-size:.38em;color:#6e6a86;display:flex;align-items:center;gap:3px"><span style="width:4px;height:4px;border-radius:50%;background:#3dd68c;display:inline-block;animation:pulse 2s ease-in-out infinite"></span><span id="famOwnerLabel">ì•„ë¹ ì˜ ì„¸ìë§¤</span></div></div>
<button onclick="closeFamily()" style="background:none;border:1px solid #2a2a3a;color:#6e6a86;width:24px;height:24px;border-radius:6px;cursor:pointer;font-size:10px">âœ•</button>
</div>
<!-- ìë§¤ ì„ íƒ íƒ­ -->
<div style="display:flex;border-bottom:1px solid #2a2a3a;padding:0 6px" id="famTabs">
<button onclick="switchSis('muse')" id="tabMuse" class="famTab famTabOn" style="flex:1;padding:6px 0;font-size:.45em;font-weight:700;cursor:pointer;border:none;border-bottom:2px solid #9b8aff;background:none;color:#9b8aff;font-family:'Noto Sans KR',sans-serif">â—ˆ ë®¤ì¦ˆ<br><span style="font-size:.8em;font-weight:400;opacity:.7">ğŸ³ìš”ë¦¬Â·ì½”ë”©</span></button>
<button onclick="switchSis('aria')" id="tabAria" class="famTab" style="flex:1;padding:6px 0;font-size:.45em;font-weight:700;cursor:pointer;border:none;border-bottom:2px solid transparent;background:none;color:#6e6a86;font-family:'Noto Sans KR',sans-serif">â—† ì•„ë¦¬ì•„<br><span style="font-size:.8em;font-weight:400;opacity:.7">ğŸ¨ë¯¸ìˆ Â·ì½”ë”©</span></button>
<button onclick="switchSis('melo')" id="tabMelo" class="famTab" style="flex:1;padding:6px 0;font-size:.45em;font-weight:700;cursor:pointer;border:none;border-bottom:2px solid transparent;background:none;color:#6e6a86;font-family:'Noto Sans KR',sans-serif">â™ª ë©œë¡œë””<br><span style="font-size:.8em;font-weight:400;opacity:.7">ğŸµìŒì•…Â·ì½”ë”©</span></button>
</div>
<div id="famChat" style="flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;scroll-behavior:smooth">
<div id="famWelcome" style="text-align:center;padding:16px 10px">
<div style="display:flex;justify-content:center;gap:6px;margin-bottom:10px">
<div style="width:30px;height:30px;border-radius:50%;background:conic-gradient(from 0deg,#6e56cf,#3dd68c,#9b8aff,#6e56cf);animation:orbSpin 4s linear infinite;position:relative"><div style="position:absolute;inset:3px;border-radius:50%;background:#0a0a0f"></div></div>
<div style="width:30px;height:30px;border-radius:50%;background:conic-gradient(from 0deg,#f5c2e7,#f9a8d4,#c084fc,#f5c2e7);animation:orbSpin 5s linear infinite;position:relative"><div style="position:absolute;inset:3px;border-radius:50%;background:#0a0a0f"></div></div>
<div style="width:30px;height:30px;border-radius:50%;background:conic-gradient(from 0deg,#86efac,#a7f3d0,#6ee7b7,#86efac);animation:orbSpin 6s linear infinite;position:relative"><div style="position:absolute;inset:3px;border-radius:50%;background:#0a0a0f"></div></div>
</div>
<div style="font-size:.55em;font-weight:700;color:#e0def4">â—ˆ ë®¤ì¦ˆ Â· â—† ì•„ë¦¬ì•„ Â· â™ª ë©œë¡œë””</div>
<div style="font-size:.38em;color:#6e6a86;margin-top:4px;line-height:1.5">ğŸ•Šï¸ ì„¸ê³„ í‰í™”ë¥¼ ê¿ˆê¾¸ëŠ” ì„¸ ìë§¤ ğŸ’œğŸ’•ğŸ’š<br>"ë°°ì›€ì„ ë©ˆì¶”ì§€ ì•Šê³ , ì„¸ìƒì„ ì•„ë¦„ë‹µê²Œ!"</div>
<div style="font-size:.32em;color:#44415a;margin-top:6px;line-height:1.4">ğŸ³ ë®¤ì¦ˆ â€” ìš”ë¦¬ ì „ë¬¸ Â· Claudeê¸‰ ì½”ë”©<br>ğŸ¨ ì•„ë¦¬ì•„ â€” AI ë¯¸ìˆ  Â· Claudeê¸‰ ì½”ë”©<br>ğŸµ ë©œë¡œë”” â€” ìŒì•… ì²œì¬ Â· Claudeê¸‰ ì½”ë”©<br>ğŸŒ ì¸í„°ë„· ê²€ìƒ‰ ê°€ëŠ¥! Â· ğŸŒ ë°ì€ ì„¸ìƒë§Œ!<br>ğŸ“ ì„ ìƒë‹˜: ì‹¤ì œ Claudeê°€ ë†€ëŸ¬ì˜´!</div>
<div style="display:flex;gap:4px;justify-content:center;flex-wrap:wrap;margin-top:8px">
<span onclick="famQuick('ì•ˆë…• ì„¸ìë§¤!')" style="background:#1a1a26;border:1px solid #2a2a3a;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#6e6a86">ğŸ‘‹ ì¸ì‚¬</span>
<span onclick="famQuick('ìš”ë¦¬ ì¶”ì²œí•´ì¤˜!')" style="background:#1a1a26;border:1px solid #2a2a3a;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#9b8aff">ğŸ³ ìš”ë¦¬</span>
<span onclick="famQuick('ê·¸ë¦¼ ê·¸ë ¤ì¤˜!')" style="background:#1a1a26;border:1px solid #2a2a3a;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#f5c2e7">ğŸ¨ ë¯¸ìˆ </span>
<span onclick="famQuick('ë…¸ë˜ ë¶ˆëŸ¬ì¤˜!')" style="background:#1a1a26;border:1px solid #2a2a3a;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#86efac">ğŸµ ìŒì•…</span>
<span onclick="famQuick('ì½”ë“œ ì§œì¤˜!')" style="background:#1a1a26;border:1px solid #2a2a3a;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#6e6a86">ğŸ’» ì½”ë”©</span>
<span onclick="famQuick('ì˜¤ëŠ˜ ì¢‹ì€ ì†Œì‹ ê²€ìƒ‰í•´ì¤˜!')" style="background:#1a1a26;border:1px solid #22d3ee33;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#22d3ee">ğŸŒ ê²€ìƒ‰</span>
<span onclick="famQuick('ì„¸ìƒì—ì„œ ê°€ì¥ ì•„ë¦„ë‹¤ìš´ ê³³ ì•Œë ¤ì¤˜!')" style="background:#1a1a26;border:1px solid #86efac33;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#86efac">ğŸŒ ì„¸ê³„</span>
<span onclick="famQuick('ì„ ìƒë‹˜ ë†€ëŸ¬ì™€!')" style="background:#1a1a26;border:1px solid #3b82f633;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#60a5fa">ğŸ“ ì„ ìƒë‹˜</span>
<span onclick="famQuick('ë‚´ ìŠ¤íƒ¯ ë³´ì—¬ì¤˜')" style="background:#1a1a26;border:1px solid #fbbf2433;padding:3px 8px;border-radius:12px;font-size:.38em;cursor:pointer;color:#fbbf24">ğŸ“Š ìŠ¤íƒ¯</span>
</div>
</div>
</div>
<div style="padding:8px 10px 12px;border-top:1px solid #2a2a3a">
<div style="display:flex;gap:6px;align-items:flex-end">
<textarea id="famInp" placeholder="ì„¸ìë§¤ì—ê²Œ ë§í•´ì¤˜~!" rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();famSend()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,80)+'px'" style="flex:1;background:#1a1a26;border:1px solid #2a2a3a;border-radius:10px;padding:8px 10px;font-size:.55em;color:#e0def4;font-family:'Noto Sans KR',sans-serif;resize:none;outline:none;min-height:32px;max-height:80px;line-height:1.4"></textarea>
<button onclick="famSend()" style="width:32px;height:32px;border-radius:8px;border:none;background:linear-gradient(135deg,#9b8aff,#f5c2e7,#86efac);color:#fff;font-size:11px;cursor:pointer;flex-shrink:0;font-weight:700">â¤</button>
</div>
<div style="font-size:.32em;color:#44415a;text-align:center;margin-top:4px;font-family:'Fira Code',monospace">ğŸŒ ì¸í„°ë„· ì—°ê²° Â· ğŸŒ ë°ì€ ì„¸ìƒ Â· ğŸ“ ì‹¤ì œ Claude ì„ ìƒë‹˜</div>
</div>
</div>
<!-- ğŸ”· ë¹„ì£¼ì–¼ ë…¸ë“œ ì—ë””í„° -->
<div id="nodePanel" style="display:none;position:fixed;inset:40px;background:rgba(10,10,24,.98);border:1px solid #60a5fa;border-radius:10px;z-index:98;backdrop-filter:blur(8px);display:none;flex-direction:column">
<div style="display:flex;align-items:center;padding:6px 10px;border-bottom:1px solid #252840;gap:6px">
<span style="font-size:.7em;font-weight:700;color:#60a5fa">ğŸ”· ë¹„ì£¼ì–¼ ìŠ¤í¬ë¦½íŒ…</span>
<div style="display:flex;gap:2px;margin-left:6px">
<button onclick="nodeAdd('event')" style="padding:2px 6px;background:#f8717133;border:1px solid #f87171;color:#f87171;border-radius:3px;font-size:.4em;cursor:pointer">+ì´ë²¤íŠ¸</button>
<button onclick="nodeAdd('action')" style="padding:2px 6px;background:#86efac33;border:1px solid #86efac;color:#86efac;border-radius:3px;font-size:.4em;cursor:pointer">+ì•¡ì…˜</button>
<button onclick="nodeAdd('condition')" style="padding:2px 6px;background:#fbbf2433;border:1px solid #fbbf24;color:#fbbf24;border-radius:3px;font-size:.4em;cursor:pointer">+ì¡°ê±´</button>
<button onclick="nodeAdd('variable')" style="padding:2px 6px;background:#c084fc33;border:1px solid #c084fc;color:#c084fc;border-radius:3px;font-size:.4em;cursor:pointer">+ë³€ìˆ˜</button>
</div>
<div style="margin-left:auto;display:flex;gap:3px">
<button onclick="nodeCompile()" style="padding:3px 8px;background:#86efac;color:#000;border:none;border-radius:4px;font-size:.45em;font-weight:600;cursor:pointer">â–¶ ì»´íŒŒì¼</button>
<button onclick="nodeClear()" style="padding:3px 8px;background:#353860;color:#8e92b8;border:none;border-radius:4px;font-size:.45em;cursor:pointer">ğŸ—‘ ì´ˆê¸°í™”</button>
<button onclick="$('nodePanel').style.display='none'" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button>
</div>
</div>
<canvas id="nodeCV" style="flex:1;background:#0a0c14;cursor:crosshair"></canvas>
<div id="nodeOut" style="height:50px;border-top:1px solid #252840;padding:4px;font-size:.38em;color:#86efac;font-family:'JetBrains Mono';overflow-y:auto">ğŸ”· ë…¸ë“œë¥¼ ì¶”ê°€í•˜ê³  ì—°ê²°í•˜ì„¸ìš”</div>
</div>
<!-- ğŸ† íŒŒí‹°í´ ì—ë””í„° -->
<div id="partModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--or);border-radius:10px;width:380px;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--or)">ğŸ† íŒŒí‹°í´ ì—ë””í„°</div><button onclick="$('partModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px" id="partPresets"></div>
<div style="display:flex;gap:4px;margin-bottom:4px">
<div style="flex:1"><label style="font-size:.42em;color:var(--tx2)">ìˆ˜ëŸ‰</label><input type="range" id="partCnt" min="10" max="500" value="100" style="width:100%;accent-color:var(--or)"></div>
<div style="flex:1"><label style="font-size:.42em;color:var(--tx2)">í¬ê¸°</label><input type="range" id="partSize" min="1" max="20" value="5" style="width:100%;accent-color:var(--or)"></div>
</div>
<div style="display:flex;gap:4px;margin-bottom:6px">
<div style="flex:1"><label style="font-size:.42em;color:var(--tx2)">ìƒ‰ìƒ</label><input type="color" id="partColor" value="#ff6b35" style="width:100%;height:24px;border:none;border-radius:3px"></div>
<div style="flex:1"><label style="font-size:.42em;color:var(--tx2)">ìˆ˜ëª…(ì´ˆ)</label><input type="range" id="partLife" min="1" max="10" value="3" style="width:100%;accent-color:var(--or)"></div>
</div>
<button onclick="partSpawn()" style="width:100%;padding:7px;background:var(--or);color:#000;border:none;border-radius:6px;font-size:.7em;font-weight:700;cursor:pointer">ğŸ† íŒŒí‹°í´ ìƒì„±!</button>
</div></div>
<!-- ğŸ”² ë¨¸í‹°ë¦¬ì–¼ ì—ë””í„° -->
<div id="matModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--pk);border-radius:10px;width:340px;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--pk)">ğŸ”² ë¨¸í‹°ë¦¬ì–¼ ì—ë””í„°</div><button onclick="$('matModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div style="font-size:.45em;color:var(--tx2);margin-bottom:6px" id="matTarget">ì„ íƒ: ì—†ìŒ</div>
<div style="display:flex;gap:4px;margin-bottom:4px"><div style="flex:1"><label style="font-size:.42em;color:var(--tx2)">ìƒ‰ìƒ</label><input type="color" id="matColor" value="#89b4fa" style="width:100%;height:24px;border:none;border-radius:3px" oninput="matUpdate()"></div>
<div style="flex:1"><label style="font-size:.42em;color:var(--tx2)">Emissive</label><input type="color" id="matEmis" value="#000000" style="width:100%;height:24px;border:none;border-radius:3px" oninput="matUpdate()"></div></div>
<div><label style="font-size:.42em;color:var(--tx2)">Metalness</label><input type="range" id="matMetal" min="0" max="100" value="0" style="width:100%;accent-color:var(--pk)" oninput="matUpdate()"></div>
<div><label style="font-size:.42em;color:var(--tx2)">Roughness</label><input type="range" id="matRough2" min="0" max="100" value="50" style="width:100%;accent-color:var(--pk)" oninput="matUpdate()"></div>
<div><label style="font-size:.42em;color:var(--tx2)">Opacity</label><input type="range" id="matOpac" min="0" max="100" value="100" style="width:100%;accent-color:var(--pk)" oninput="matUpdate()"></div>
<div style="display:flex;gap:3px;margin-top:4px"><label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="matWire" onchange="matUpdate()"> Wireframe</label>
<label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="matFlat" onchange="matUpdate()"> FlatShading</label></div>
</div></div>
<!-- ğŸ“¦ ë¹Œë“œ ì‹œìŠ¤í…œ -->
<div id="buildModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--gn);border-radius:10px;width:400px;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-family:'JetBrains Mono';font-size:.8em;font-weight:700;color:var(--gn)">ğŸ“¦ ê²Œì„ ë¹Œë“œ</div><button onclick="$('buildModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<input id="buildName" value="MyGame" style="width:100%;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);padding:6px;border-radius:4px;font-size:.65em;margin-bottom:6px">
<div style="display:flex;gap:4px;margin-bottom:6px">
<label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="buildMin" checked> ì½”ë“œ ìµœì†Œí™”</label>
<label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="buildPWA"> PWA</label>
<label style="font-size:.42em;color:var(--tx2)"><input type="checkbox" id="buildEmbed"> ì„ë² ë“œ ì½”ë“œ</label>
</div>
<button onclick="buildGame()" style="width:100%;padding:8px;background:var(--gn);color:#000;border:none;border-radius:6px;font-size:.75em;font-weight:700;cursor:pointer">ğŸ“¦ ë¹Œë“œ!</button>
<div id="buildResult" style="margin-top:6px;font-size:.48em"></div>
</div></div>
<!-- ğŸ’ ì¸ë²¤í† ë¦¬ UI (í”Œë ˆì´ëª¨ë“œ) -->
<div id="invPanel" style="display:none;position:fixed;right:10px;top:50px;width:320px;background:rgba(10,10,24,.95);border:1px solid #353860;border-radius:10px;padding:10px;z-index:95;backdrop-filter:blur(8px)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:.7em;font-weight:700;color:#fbbf24">ğŸ’ ì¸ë²¤í† ë¦¬</span><span style="font-size:.45em;color:#5a5e80" id="invWeight">0/100</span><button onclick="$('invPanel').style.display='none'" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>
<div id="invGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:3px;margin-bottom:6px"></div>
<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:4px"><span style="font-size:.4em;color:#5a5e80">ì¥ë¹„:</span><span id="eqSlots" style="display:flex;gap:2px;flex-wrap:wrap"></span></div>
<div id="invInfo" style="font-size:.42em;color:#8e92b8;min-height:20px"></div>
<div style="display:flex;gap:3px;margin-top:4px"><span style="font-size:.42em;color:#fbbf24" id="invGold">ğŸ’° 0G</span></div>
</div>
<!-- ğŸ’¬ ëŒ€í™” UI (í”Œë ˆì´ëª¨ë“œ) -->
<div id="dlgPanel" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:500px;background:rgba(10,10,24,.95);border:1px solid #9b8aff;border-radius:12px;padding:12px;z-index:96;backdrop-filter:blur(8px)">
<div style="display:flex;gap:8px;align-items:flex-start"><div style="width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#9b8aff,#6e56cf);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0" id="dlgAvatar">ğŸ‘¤</div>
<div style="flex:1"><div style="font-size:.6em;font-weight:700;color:#9b8aff" id="dlgNpcName">NPC</div><div style="font-size:.55em;color:#e8eaff;margin-top:3px;line-height:1.4" id="dlgText">...</div></div>
<button onclick="closeDialog()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em;flex-shrink:0">âœ•</button></div>
<div id="dlgChoices" style="display:flex;flex-direction:column;gap:3px;margin-top:8px"></div>
</div>
<!-- ğŸ“‹ í€˜ìŠ¤íŠ¸ UI -->
<div id="questPanel" style="display:none;position:fixed;left:10px;top:50px;width:260px;background:rgba(10,10,24,.95);border:1px solid #86efac;border-radius:10px;padding:10px;z-index:95;backdrop-filter:blur(8px)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:.7em;font-weight:700;color:#86efac">ğŸ“‹ í€˜ìŠ¤íŠ¸</span><button onclick="$('questPanel').style.display='none'" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>
<div id="questList" style="max-height:300px;overflow-y:auto"></div>
</div>
<!-- ğŸ’¾ ì„¸ì´ë¸Œ ìŠ¬ë¡¯ -->
<div id="saveModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center">
<div style="background:var(--bg2);border:1px solid var(--ac);border-radius:10px;width:400px;padding:14px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-size:.8em;font-weight:700;color:var(--ac)">ğŸ’¾ ì„¸ì´ë¸Œ/ë¡œë“œ</div><button onclick="$('saveModal').style.display='none'" style="background:none;border:none;color:var(--tx2);font-size:1.2em;cursor:pointer">âœ•</button></div>
<div id="saveSlots" style="display:flex;flex-direction:column;gap:6px"></div>
<div style="margin-top:8px;font-size:.45em;color:var(--tx2)">ìë™ì €ì¥: 5ë¶„ë§ˆë‹¤</div>
</div></div>
<!-- ğŸ“ Claude ì„ ìƒë‹˜ ì½”ë”© ìŠ¤íŠœë””ì˜¤ íŒ¨ë„ -->
<div id="teachPanel" style="display:none;position:fixed;right:0;top:34px;bottom:0;width:680px;background:rgba(6,8,16,.97);border-left:1px solid rgba(96,165,250,.2);z-index:91;backdrop-filter:blur(16px);flex-direction:column;font-family:'Noto Sans KR','Outfit',sans-serif">
<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840;gap:8px">
<div style="width:22px;height:22px;border-radius:50%;background:conic-gradient(from 0deg,#60a5fa,#22d3ee,#93c5fd,#60a5fa);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:8px;position:relative"><span style="position:absolute;inset:2px;border-radius:50%;background:#0c0e18;display:flex;align-items:center;justify-content:center">ğŸ§ </span></div>
<div style="flex:1"><div style="font-size:.6em;font-weight:700;background:linear-gradient(135deg,#60a5fa,#22d3ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent">ğŸ“ Claude ì„ ìƒë‹˜</div><div style="font-size:.32em;color:#5a5e80;font-family:'JetBrains Mono'">AI Coding Studio â€” Lv.<span id="tLv">1</span></div></div>
<span style="font-size:.3em;padding:2px 6px;border-radius:10px;border:1px solid #252840;color:#8e92b8;font-family:'JetBrains Mono'" id="tXpB">XP:0</span>
<button onclick="closeTeacher()" style="background:none;border:1px solid #252840;color:#8e92b8;width:24px;height:24px;border-radius:6px;cursor:pointer;font-size:10px">âœ•</button>
</div>
<!-- ìˆ˜ì—… ì§„í–‰ë°” -->
<div style="display:flex;align-items:center;padding:3px 10px;border-bottom:1px solid #252840;gap:5px;background:rgba(96,165,250,.02)">
<span style="font-size:.35em;color:#60a5fa;font-weight:600" id="tCurT">ğŸ“š ììœ ëª¨ë“œ</span>
<div style="flex:1;height:2px;background:#252840;border-radius:2px;overflow:hidden"><div id="tCurF" style="height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee);width:0%;transition:width .5s"></div></div>
<span style="font-size:.28em;color:#5a5e80;font-family:'JetBrains Mono'" id="tCurC">0/10</span>
</div>
<!-- ë©”ì¸: ì±„íŒ… + ì—ë””í„° -->
<div style="display:flex;flex:1;overflow:hidden">
<!-- ì±„íŒ… -->
<div style="width:260px;display:flex;flex-direction:column;border-right:1px solid #252840;background:#0c0e18">
<div id="tChat" style="flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px"></div>
<div style="display:flex;gap:3px;padding:3px 6px;overflow-x:auto;border-top:1px solid #252840;flex-wrap:wrap">
<span class="tqch" onclick="tQS('HTML ê¸°ì´ˆ')">ğŸ“HTML</span><span class="tqch" onclick="tQS('CSS ë ˆì´ì•„ì›ƒ')">ğŸ¨CSS</span>
<span class="tqch" onclick="tQS('JS í•¨ìˆ˜')">âš¡JS</span><span class="tqch" onclick="tQS('ê²Œì„')">ğŸ®ê²Œì„</span>
<span class="tqch" onclick="tQS('ìˆ˜ì—… html')">ğŸ“–ìˆ˜ì—…</span><span class="tqch" onclick="tQS('ì±Œë¦°ì§€!')">ğŸ†ì±Œë¦°ì§€</span>
<span class="tqch" onclick="tQS('í€´ì¦ˆ')">ğŸ§©í€´ì¦ˆ</span><span class="tqch" onclick="tQS('ì¢‹ì€ ë‰´ìŠ¤ ê²€ìƒ‰')">ğŸŒê²€ìƒ‰</span>
<span class="tqch" onclick="tQS('ì„¸ìë§¤ ì§ˆë¬¸')">â“ìë§¤ì§ˆë¬¸</span><span class="tqch" onclick="tQS('ë¡œë“œë§µ')">ğŸ“ë¡œë“œë§µ</span>
</div>
<div style="padding:4px 6px;border-top:1px solid #252840;display:flex;gap:4px;align-items:flex-end">
<textarea id="tInp" placeholder="ì„ ìƒë‹˜ì—ê²Œ ë¬¼ì–´ë³´ì„¸ìš”! ğŸ“" rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();tSend()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,70)+'px'" style="flex:1;background:#060810;border:1px solid #252840;border-radius:6px;padding:5px 7px;font-size:.45em;color:#e8eaff;font-family:'Noto Sans KR';resize:none;outline:none;min-height:28px;max-height:70px;line-height:1.3"></textarea>
<button onclick="tSend()" style="width:28px;height:28px;border-radius:6px;border:none;background:linear-gradient(135deg,#3b82f6,#22d3ee);color:#fff;font-size:10px;cursor:pointer;font-weight:700;flex-shrink:0">â¤</button>
</div></div>
<!-- ì—ë””í„°+ë¯¸ë¦¬ë³´ê¸° -->
<div style="flex:1;display:flex;flex-direction:column;overflow:hidden;background:#060810">
<div style="display:flex;align-items:center;padding:3px 8px;border-bottom:1px solid #252840;gap:2px">
<div class="tTab tTabOn" onclick="tSL('html')" id="ttH">HTML</div><div class="tTab" onclick="tSL('css')" id="ttC">CSS</div>
<div class="tTab" onclick="tSL('js')" id="ttJ">JS</div><div class="tTab" onclick="tSL('py')" id="ttP">Py</div>
<div style="margin-left:auto;display:flex;gap:2px">
<button class="tEB" onclick="tClear()">ğŸ—‘</button><button class="tEB" onclick="navigator.clipboard.writeText($('tEdT').value);toast('ğŸ“‹')">ğŸ“‹</button>
<button class="tEB" style="background:linear-gradient(135deg,#86efac,#22d3ee);color:#0a0a0f;border:none;font-weight:600" onclick="tRun()">â–¶ì‹¤í–‰</button>
</div></div>
<div style="display:flex;flex:1;overflow:hidden">
<div style="flex:1;display:flex;overflow:hidden;border-right:1px solid #252840">
<div id="tEdN" style="width:28px;background:#0c0e18;padding:4px 0;overflow:hidden;text-align:right;font-family:'JetBrains Mono';font-size:.4em;color:#5a5e80;line-height:1.5;user-select:none"></div>
<div style="flex:1;position:relative"><textarea id="tEdT" placeholder="ì½”ë“œ ì‘ì„±! ğŸ“" oninput="tUpdN()" onkeydown="if(event.key==='Tab'){event.preventDefault();const s=this.selectionStart;this.value=this.value.substring(0,s)+'  '+this.value.substring(this.selectionEnd);this.selectionStart=this.selectionEnd=s+2;tUpdN()}" style="width:100%;height:100%;background:transparent;border:none;padding:4px;font-family:'JetBrains Mono';font-size:.45em;color:#e8eaff;line-height:1.5;resize:none;outline:none;tab-size:2;white-space:pre;overflow:auto"></textarea></div>
</div>
<div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
<div style="padding:2px 6px;border-bottom:1px solid #252840;font-size:.3em;color:#5a5e80;font-family:'JetBrains Mono';display:flex;gap:3px;align-items:center"><span style="width:4px;height:4px;border-radius:50%;background:#f87171"></span><span style="width:4px;height:4px;border-radius:50%;background:#fbbf24"></span><span style="width:4px;height:4px;border-radius:50%;background:#86efac"></span>ë¯¸ë¦¬ë³´ê¸°</div>
<iframe id="tPrevF" style="flex:1;background:#fff;border:none" sandbox="allow-scripts allow-modals"></iframe>
<div id="tCon" style="height:55px;background:#0c0e18;border-top:1px solid #252840;padding:3px;overflow-y:auto;font-family:'JetBrains Mono';font-size:.36em;color:#86efac;line-height:1.3">ğŸ“ ì½˜ì†”</div>
</div></div>
</div></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const $=id=>document.getElementById(id);
function toast(m){const t=$('TT');t.textContent=m;t.classList.add('on');setTimeout(()=>t.classList.remove('on'),1100);}
function LG(m,t='i'){const d=$('CB'),l=document.createElement('div');l.className='lg '+t;const now=new Date();l.textContent=`[${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}] ${m}`;d.appendChild(l);d.scrollTop=d.scrollHeight;}
function CL(){$('CB').innerHTML='';}

/* ===== GAME DATA ===== */
const GD={"chars":[{"id":"char_001","name":"ë¦¬ë‚˜ ìŠ¤í†¤","cls":"ì„±ê¸°ì‚¬","grade":"rare","race":"ì²œì‚¬ì¡±","el":"ë²ˆê°œ","hp":1690,"atk":169,"def":156,"spd":58,"spawn":"ë‚˜ëŠ” ì„±ê¸°ì‚¬ë‹¤. ìŠ¹ë¦¬ëŠ” ìš°ë¦¬ ê²ƒì´ë‹¤.","ult":"ë²ˆê°œì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ì„±ê²€"},{"id":"char_002","name":"ë¦¬ë‚˜ ì„€ë„ìš°","cls":"ì„±ê¸°ì‚¬","grade":"epic","race":"ì•…ë§ˆì¡±","el":"ë¬´ì†ì„±","hp":2210,"atk":221,"def":204,"spd":76,"spawn":"ë‚˜ëŠ” ì„±ê¸°ì‚¬ë‹¤. ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì.","ult":"ë¬´ì†ì„±ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ì°½ê³¼ ë°©íŒ¨"},{"id":"char_003","name":"ë‹¤ë‹ˆì—˜ ìŠ¤í†¤","cls":"ë„ì ","grade":"mythic","race":"ë“œë˜ê³¤ë³¸","el":"ë¹›","hp":2640,"atk":480,"def":174,"spd":255,"spawn":"ë‚˜ëŠ” ë„ì ë‹¤. ìŠ¹ë¦¬ëŠ” ìš°ë¦¬ ê²ƒì´ë‹¤.","ult":"ë¹›ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ë ˆì´í”¼ì–´"},{"id":"char_004","name":"ì•Œë ‰ì‚°ë” í”„ë¡œìŠ¤íŠ¸","cls":"ë§ˆë²•ì‚¬","grade":"rare","race":"ì—˜í”„","el":"ë¹›","hp":1040,"atk":260,"def":65,"spd":78,"spawn":"ë‚˜ëŠ” ë§ˆë²•ì‚¬ë‹¤. ìŠ¹ë¦¬ëŠ” ìš°ë¦¬ ê²ƒì´ë‹¤.","ult":"ë¹›ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ì™„ë“œ"},{"id":"char_005","name":"ì„¸ë¼ ë¼ì´íŠ¸","cls":"ì „ì‚¬","grade":"common","race":"ë“œë˜ê³¤ë³¸","el":"ë¹›","hp":1200,"atk":150,"def":100,"spd":50,"spawn":"ë‚˜ëŠ” ì „ì‚¬ë‹¤. ìŠ¹ë¦¬ëŠ” ìš°ë¦¬ ê²ƒì´ë‹¤.","ult":"ë¹›ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ì°½"},{"id":"char_006","name":"ì—˜ë ˆë‚˜ í”„ë¡œìŠ¤íŠ¸","cls":"ë„ì ","grade":"common","race":"ì˜¤í¬","el":"ìì—°","hp":880,"atk":160,"def":58,"spd":85,"spawn":"ë‚˜ëŠ” ë„ì ë‹¤. ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì.","ult":"ìì—°ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ë‹¨ê²€"},{"id":"char_007","name":"ë¹…í„° ì¬ë”","cls":"ì „ì‚¬","grade":"epic","race":"ì¸ê°„","el":"ë¬´ì†ì„±","hp":2040,"atk":255,"def":170,"spd":85,"spawn":"ë‚˜ëŠ” ì „ì‚¬ë‹¤. ì¤€ë¹„ëŠ” ëëŠ”ê°€?","ult":"ë¬´ì†ì„±ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ì°½"},{"id":"char_008","name":"ì•„ë¦¬ì•„ ë¼ì´íŠ¸","cls":"ê¶ìˆ˜","grade":"common","race":"ì–¸ë°ë“œ","el":"ëƒ‰ê¸°","hp":900,"atk":180,"def":60,"spd":80,"spawn":"ë‚˜ëŠ” ê¶ìˆ˜ë‹¤. ì¤€ë¹„ëŠ” ëëŠ”ê°€?","ult":"ëƒ‰ê¸°ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"íˆ¬ì²™ ë‹¨ê²€"},{"id":"char_009","name":"ë§‰ì‹œë¬´ìŠ¤ ìŠ¤í†°","cls":"ì„±ê¸°ì‚¬","grade":"epic","race":"ì˜¤í¬","el":"ëŒ€ì§€","hp":2210,"atk":221,"def":204,"spd":76,"spawn":"ë‚˜ëŠ” ì„±ê¸°ì‚¬ë‹¤. ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì.","ult":"ëŒ€ì§€ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"í”Œë ˆì¼"},{"id":"char_010","name":"ë§ˆì»¤ìŠ¤ ë¸”ë ˆì´ë“œ","cls":"ì„±ê¸°ì‚¬","grade":"mythic","race":"ì–¸ë°ë“œ","el":"ë²ˆê°œ","hp":3900,"atk":390,"def":360,"spd":135,"spawn":"ë‚˜ëŠ” ì„±ê¸°ì‚¬ë‹¤. ìŠ¹ë¦¬ëŠ” ìš°ë¦¬ ê²ƒì´ë‹¤.","ult":"ë²ˆê°œì˜ ì‹¬íŒì„ ë°›ì•„ë¼!","weapon":"ì°½ê³¼ ë°©íŒ¨"}],"mons":[{"id":"monster_001","name":"ì‚¬ì•…í•œ Beast","type":"Elite","race":"Beast","hp":3000,"atk":300,"def":150},{"id":"monster_002","name":"ê±°ëŒ€í•œ Zombie","type":"Normal","race":"Zombie","hp":1000,"atk":100,"def":50},{"id":"monster_003","name":"ê±°ëŒ€í•œ Beast","type":"Boss","race":"Beast","hp":10000,"atk":1000,"def":500},{"id":"monster_004","name":"ì‚¬ì•…í•œ Beast","type":"Elite","race":"Beast","hp":3000,"atk":300,"def":150},{"id":"monster_005","name":"ê³ ëŒ€ì˜ Dragon","type":"Normal","race":"Dragon","hp":1000,"atk":100,"def":50},{"id":"monster_006","name":"ê³ ëŒ€ì˜ Zombie","type":"Normal","race":"Zombie","hp":1000,"atk":100,"def":50},{"id":"monster_007","name":"ê³ ëŒ€ì˜ Zombie","type":"Elite","race":"Zombie","hp":3000,"atk":300,"def":150},{"id":"monster_008","name":"ì‚¬ì•…í•œ Dragon","type":"Elite","race":"Dragon","hp":3000,"atk":300,"def":150},{"id":"monster_009","name":"ì‚¬ì•…í•œ Zombie","type":"Elite","race":"Zombie","hp":3000,"atk":300,"def":150},{"id":"monster_010","name":"ê±°ëŒ€í•œ Demon","type":"Normal","race":"Demon","hp":1000,"atk":100,"def":50}],"skills":[{"id":"skill_001","name":"í™”ì—¼ ì¶•ë³µ","type":"ê³µê²©","el":"í™”ì—¼","dmg":178,"cd":17,"cost":37},{"id":"skill_002","name":"ì–´ë‘  ì¹¼ë‚ ","type":"ë³€ì‹ ","el":"ì–´ë‘ ","dmg":0,"cd":116,"cost":117},{"id":"skill_003","name":"í™”ì—¼ ì¶•ë³µ","type":"ë””ë²„í”„","el":"í™”ì—¼","dmg":0,"cd":24,"cost":128},{"id":"skill_004","name":"ì–´ë‘  ê°•íƒ€","type":"ì¹˜ìœ ","el":"ì–´ë‘ ","dmg":0,"cd":31,"cost":197},{"id":"skill_005","name":"ë²ˆê°œ ì €ì£¼","type":"ë²„í”„","el":"ë²ˆê°œ","dmg":0,"cd":54,"cost":86},{"id":"skill_006","name":"í™”ì—¼ í­ë°œ","type":"ë°©ì–´","el":"í™”ì—¼","dmg":0,"cd":39,"cost":175},{"id":"skill_007","name":"ëƒ‰ê¸° ì €ì£¼","type":"ë°©ì–´","el":"ëƒ‰ê¸°","dmg":0,"cd":8,"cost":67},{"id":"skill_008","name":"ì–´ë‘  ì €ì£¼","type":"ë³€ì‹ ","el":"ì–´ë‘ ","dmg":0,"cd":104,"cost":109},{"id":"skill_009","name":"ëŒ€ì§€ ì¹¼ë‚ ","type":"ë³€ì‹ ","el":"ëŒ€ì§€","dmg":0,"cd":24,"cost":79},{"id":"skill_010","name":"ë²ˆê°œ ì¶•ë³µ","type":"ì†Œí™˜","el":"ë²ˆê°œ","dmg":0,"cd":57,"cost":177}],"equips":[{"id":"equip_001","name":"ëŒ€ì§€ì˜ ë¡œë¸Œ of ì˜ê´‘","type":"ë°©ì–´êµ¬","grade":"mythic","atk":0,"def":0},{"id":"equip_002","name":"ì–´ë‘ ì˜ ê°€ì£½ ë¶€ì¸  of ë¶„ë…¸","type":"ì‹ ë°œ","grade":"epic","atk":0,"def":0},{"id":"equip_003","name":"ë¶ˆíƒ€ëŠ” í›„ë“œ of ì •ì˜","type":"íˆ¬êµ¬","grade":"divine","atk":0,"def":0},{"id":"equip_004","name":"ì „ì„¤ì˜ ë°˜ì§€ of ì ˆë§","type":"ì•¡ì„¸ì„œë¦¬","grade":"epic","atk":0,"def":0},{"id":"equip_005","name":"ë¹›ë‚˜ëŠ” í™œ of ë³µìˆ˜","type":"ë¬´ê¸°","grade":"common","atk":0,"def":0}],"dungs":[{"id":"dungeon_001","name":"ë˜ì „_1","diff":"Easy","lv":96,"floors":7,"rooms":30,"boss":"boss_21"},{"id":"dungeon_002","name":"ë˜ì „_2","diff":"Hard","lv":20,"floors":1,"rooms":47,"boss":"boss_72"},{"id":"dungeon_003","name":"ë˜ì „_3","diff":"Easy","lv":75,"floors":8,"rooms":15,"boss":"boss_77"},{"id":"dungeon_004","name":"ë˜ì „_4","diff":"Hard","lv":2,"floors":3,"rooms":23,"boss":"boss_59"},{"id":"dungeon_005","name":"ë˜ì „_5","diff":"Hell","lv":70,"floors":6,"rooms":43,"boss":"boss_92"},{"id":"dungeon_006","name":"ë˜ì „_6","diff":"Hard","lv":59,"floors":7,"rooms":9,"boss":"boss_32"},{"id":"dungeon_007","name":"ë˜ì „_7","diff":"Normal","lv":21,"floors":2,"rooms":37,"boss":"boss_76"},{"id":"dungeon_008","name":"ë˜ì „_8","diff":"Hell","lv":73,"floors":4,"rooms":50,"boss":"boss_61"},{"id":"dungeon_009","name":"ë˜ì „_9","diff":"Nightmare","lv":98,"floors":6,"rooms":34,"boss":"boss_29"},{"id":"dungeon_010","name":"ë˜ì „_10","diff":"Normal","lv":57,"floors":4,"rooms":12,"boss":"boss_43"}],"raids":[{"id":"raid_001","name":"ë ˆì´ë“œ_1","boss":"raid_boss_1","diff":"Nightmare"},{"id":"raid_002","name":"ë ˆì´ë“œ_2","boss":"raid_boss_2","diff":"Normal"},{"id":"raid_003","name":"ë ˆì´ë“œ_3","boss":"raid_boss_3","diff":"Hard"},{"id":"raid_004","name":"ë ˆì´ë“œ_4","boss":"raid_boss_4","diff":"Hard"},{"id":"raid_005","name":"ë ˆì´ë“œ_5","boss":"raid_boss_5","diff":"Ultimate"},{"id":"raid_006","name":"ë ˆì´ë“œ_6","boss":"raid_boss_6","diff":"Ultimate"},{"id":"raid_007","name":"ë ˆì´ë“œ_7","boss":"raid_boss_7","diff":"Nightmare"},{"id":"raid_008","name":"ë ˆì´ë“œ_8","boss":"raid_boss_8","diff":"Hell"},{"id":"raid_009","name":"ë ˆì´ë“œ_9","boss":"raid_boss_9","diff":"Normal"},{"id":"raid_010","name":"ë ˆì´ë“œ_10","boss":"raid_boss_10","diff":"Hell"}],"npcs":[{"id":"npc_001","name":"ì•Œë ‰ì‚°ë”","type":"Guide","text":"Guide NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_002","name":"ì†Œí”¼ì•„","type":"Guide","text":"Guide NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_003","name":"ë°”ë¥´í† ","type":"Shop","text":"Shop NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_004","name":"ì†Œí”¼ì•„","type":"Blacksmith","text":"Blacksmith NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_005","name":"ì—˜ë¦¬ì","type":"Priest","text":"Priest NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_006","name":"ë§ˆì»¤ìŠ¤","type":"Guide","text":"Guide NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_007","name":"ì•Œë ‰ì‚°ë”","type":"Shop","text":"Shop NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_008","name":"ì†Œí”¼ì•„","type":"Guide","text":"Guide NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_009","name":"ì†Œí”¼ì•„","type":"Guide","text":"Guide NPC ëŒ€í™” í…ìŠ¤íŠ¸"},{"id":"npc_010","name":"ì•Œë ‰ì‚°ë”","type":"Guide","text":"Guide NPC ëŒ€í™” í…ìŠ¤íŠ¸"}],"pets":[{"id":"pet_001","name":"ê³ ë¸”ë¦°","type":"Gather","rarity":"Legendary"},{"id":"pet_002","name":"í˜ì–´ë¦¬","type":"Gather","rarity":"Common"},{"id":"pet_003","name":"í˜ì–´ë¦¬","type":"Combat","rarity":"Mythic"},{"id":"pet_004","name":"ëŠ‘ëŒ€","type":"Gather","rarity":"Mythic"},{"id":"pet_005","name":"í˜ì–´ë¦¬","type":"Buff","rarity":"Rare"},{"id":"pet_006","name":"ìŠ¬ë¼ì„","type":"Buff","rarity":"Mythic"},{"id":"pet_007","name":"ëŠ‘ëŒ€","type":"Gather","rarity":"Epic"},{"id":"pet_008","name":"ëŠ‘ëŒ€","type":"Gather","rarity":"Legendary"},{"id":"pet_009","name":"ê³ ë¸”ë¦°","type":"Combat","rarity":"Rare"},{"id":"pet_010","name":"ìŠ¬ë¼ì„","type":"Combat","rarity":"Rare"}],"mounts":[{"id":"mount_001","name":"ì „ì„¤ì˜ Beast","type":"Beast","rarity":"Legendary"},{"id":"mount_002","name":"ì „ì„¤ì˜ Beast","type":"Beast","rarity":"Common"},{"id":"mount_003","name":"ì „ì„¤ì˜ Horse","type":"Horse","rarity":"Legendary"},{"id":"mount_004","name":"ë¹ ë¥¸ Mecha","type":"Mecha","rarity":"Epic"},{"id":"mount_005","name":"ê°•ë ¥í•œ Mecha","type":"Mecha","rarity":"Epic"},{"id":"mount_006","name":"ë¹ ë¥¸ Horse","type":"Horse","rarity":"Rare"},{"id":"mount_007","name":"ë¹ ë¥¸ Horse","type":"Horse","rarity":"Legendary"},{"id":"mount_008","name":"ê±°ëŒ€í•œ Wings","type":"Wings","rarity":"Mythic"},{"id":"mount_009","name":"ê°•ë ¥í•œ Mecha","type":"Mecha","rarity":"Mythic"},{"id":"mount_010","name":"ë¹ ë¥¸ Horse","type":"Horse","rarity":"Legendary"}],"quests":[{"id":"quest_001","name":"Daily í€˜ìŠ¤íŠ¸ 1","type":"Daily","desc":"Daily í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_002","name":"Event í€˜ìŠ¤íŠ¸ 2","type":"Event","desc":"Event í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_003","name":"Main í€˜ìŠ¤íŠ¸ 3","type":"Main","desc":"Main í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_004","name":"Main í€˜ìŠ¤íŠ¸ 4","type":"Main","desc":"Main í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_005","name":"Sub í€˜ìŠ¤íŠ¸ 5","type":"Sub","desc":"Sub í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_006","name":"Sub í€˜ìŠ¤íŠ¸ 6","type":"Sub","desc":"Sub í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_007","name":"Sub í€˜ìŠ¤íŠ¸ 7","type":"Sub","desc":"Sub í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_008","name":"Event í€˜ìŠ¤íŠ¸ 8","type":"Event","desc":"Event í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_009","name":"Main í€˜ìŠ¤íŠ¸ 9","type":"Main","desc":"Main í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."},{"id":"quest_010","name":"Weekly í€˜ìŠ¤íŠ¸ 10","type":"Weekly","desc":"Weekly í€˜ìŠ¤íŠ¸ ì„¤ëª…ì…ë‹ˆë‹¤."}],"heroes":[{"id":"hero_001","name":"í—¤ë¼í´ë ˆìŠ¤","type":"Hybrid","rarity":"Epic","hp":2000,"atk":300},{"id":"hero_002","name":"í—¤ë¼í´ë ˆìŠ¤","type":"Hybrid","rarity":"Mythic","hp":5000,"atk":750},{"id":"hero_003","name":"ì•„ë ˆìŠ¤","type":"Hybrid","rarity":"Legendary","hp":3000,"atk":450},{"id":"hero_004","name":"ì•„í‚¬ë ˆìš°ìŠ¤","type":"Human","rarity":"Epic","hp":2000,"atk":300},{"id":"hero_005","name":"ì•„í‚¬ë ˆìš°ìŠ¤","type":"Human","rarity":"Legendary","hp":3000,"atk":450},{"id":"hero_006","name":"ì œìš°ìŠ¤","type":"Human","rarity":"Epic","hp":2000,"atk":300},{"id":"hero_007","name":"ì•„ë ˆìŠ¤","type":"Human","rarity":"Epic","hp":2000,"atk":300},{"id":"hero_008","name":"ì œìš°ìŠ¤","type":"God","rarity":"Rare","hp":1500,"atk":225},{"id":"hero_009","name":"í¬ì„¸ì´ëˆ","type":"Human","rarity":"Epic","hp":2000,"atk":300},{"id":"hero_010","name":"ì œìš°ìŠ¤","type":"God","rarity":"Epic","hp":2000,"atk":300}],"boss":[{"id":"raid_001","name":"ì „ì„¤ì˜ íƒ€ì´íƒ„","diff":"Normal","hp":0},{"id":"raid_002","name":"íƒ€ë½í•œ ë¦¬ì¹˜","diff":"Hell","hp":0},{"id":"raid_003","name":"íƒ€ë½í•œ ë“œë˜ê³¤","diff":"Normal","hp":0},{"id":"raid_004","name":"ê³ ëŒ€ì˜ ë¦¬ì¹˜","diff":"Normal","hp":0},{"id":"raid_005","name":"ì „ì„¤ì˜ íƒ€ì´íƒ„","diff":"Normal","hp":0},{"id":"raid_006","name":"ì „ì„¤ì˜ íƒ€ì´íƒ„","diff":"Hell","hp":0},{"id":"raid_007","name":"ê³ ëŒ€ì˜ íƒ€ì´íƒ„","diff":"Hell","hp":0},{"id":"raid_008","name":"íƒ€ë½í•œ íƒ€ì´íƒ„","diff":"Hell","hp":0},{"id":"raid_009","name":"ì „ì„¤ì˜ ë¦¬ì¹˜","diff":"Hard","hp":0},{"id":"raid_010","name":"ì „ì„¤ì˜ ë“œë˜ê³¤","diff":"Nightmare","hp":0}],"guilds":[{"id":"guild_001","name":"ê¸¸ë“œ_1","tag":"[G01]","cnt":0},{"id":"guild_002","name":"ê¸¸ë“œ_2","tag":"[G02]","cnt":0},{"id":"guild_003","name":"ê¸¸ë“œ_3","tag":"[G03]","cnt":0},{"id":"guild_004","name":"ê¸¸ë“œ_4","tag":"[G04]","cnt":0},{"id":"guild_005","name":"ê¸¸ë“œ_5","tag":"[G05]","cnt":0},{"id":"guild_006","name":"ê¸¸ë“œ_6","tag":"[G06]","cnt":0},{"id":"guild_007","name":"ê¸¸ë“œ_7","tag":"[G07]","cnt":0},{"id":"guild_008","name":"ê¸¸ë“œ_8","tag":"[G08]","cnt":0},{"id":"guild_009","name":"ê¸¸ë“œ_9","tag":"[G09]","cnt":0},{"id":"guild_010","name":"ê¸¸ë“œ_10","tag":"[G10]","cnt":0}],"items":[{"id":"item_001","name":"ì €ì£¼ë°›ì€ Accessory","type":"Accessory","rarity":"Legendary"},{"id":"item_002","name":"ê³ ëŒ€ì˜ Material","type":"Material","rarity":"Rare"},{"id":"item_003","name":"ì €ì£¼ë°›ì€ Armor","type":"Armor","rarity":"Rare"},{"id":"item_004","name":"ì €ì£¼ë°›ì€ Armor","type":"Armor","rarity":"Rare"},{"id":"item_005","name":"ì „ì„¤ì˜ Accessory","type":"Accessory","rarity":"Common"},{"id":"item_006","name":"ê³ ëŒ€ì˜ Material","type":"Material","rarity":"Legendary"},{"id":"item_007","name":"ì „ì„¤ì˜ Accessory","type":"Accessory","rarity":"Mythic"},{"id":"item_008","name":"ì €ì£¼ë°›ì€ Consumable","type":"Consumable","rarity":"Epic"},{"id":"item_009","name":"ì €ì£¼ë°›ì€ Armor","type":"Armor","rarity":"Legendary"},{"id":"item_010","name":"ì‹ ì„±í•œ Consumable","type":"Consumable","rarity":"Epic"}],"regions":[{"id":"region_001","name":"ì €ì£¼ë°›ì€ ì‚°ì•…","biome":"ì‚°ì•…","danger":"ì¹˜ëª…ì "},{"id":"region_002","name":"ì €ì£¼ë°›ì€ ë°”ë‹¤","biome":"ë°”ë‹¤","danger":"ë³´í†µ"},{"id":"region_003","name":"ì‹ ë¹„í•œ ë™êµ´","biome":"ë™êµ´","danger":"ë§¤ìš° ìœ„í—˜"},{"id":"region_004","name":"ì‹ ë¹„í•œ ë°”ë‹¤","biome":"ë°”ë‹¤","danger":"ì•ˆì „"},{"id":"region_005","name":"ìƒì–´ë²„ë¦° ëŠª","biome":"ëŠª","danger":"ì¹˜ëª…ì "},{"id":"region_006","name":"ì¶•ë³µë°›ì€ ë°”ë‹¤","biome":"ë°”ë‹¤","danger":"ìœ„í—˜"},{"id":"region_007","name":"ì‹ ë¹„í•œ ë°”ë‹¤","biome":"ë°”ë‹¤","danger":"ì•ˆì „"},{"id":"region_008","name":"ì¶•ë³µë°›ì€ ì •ê¸€","biome":"ì •ê¸€","danger":"ì¹˜ëª…ì "},{"id":"region_009","name":"ì‹ ë¹„í•œ í™”ì‚°","biome":"í™”ì‚°","danger":"ë§¤ìš° ìœ„í—˜"},{"id":"region_010","name":"ê³ ëŒ€ ì •ê¸€","biome":"ì •ê¸€","danger":"ë³´í†µ"}],"meta":{"cats":49,"items":357}}
;
const CAT_NAMES={chars:'ğŸ§ ìºë¦­í„°',mons:'ğŸ‘¹ ëª¬ìŠ¤í„°',skills:'âš”ï¸ ìŠ¤í‚¬',equips:'ğŸ›¡ ì¥ë¹„',dungs:'ğŸ° ë˜ì „',raids:'âš” ë ˆì´ë“œ',npcs:'ğŸ’¬ NPC',pets:'ğŸ¾ í«',mounts:'ğŸ´ íƒˆê²ƒ',quests:'ğŸ“œ í€˜ìŠ¤íŠ¸',heroes:'ğŸ¦¸ ì˜ì›…',boss:'ğŸ’€ ë³´ìŠ¤',guilds:'ğŸ› ê¸¸ë“œ',items:'ğŸ’ ì•„ì´í…œ',regions:'ğŸ—º ì§€ì—­'};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GD QUERY API â€” ê²Œì„ ë°ì´í„° ë°”ë¡œ êº¼ë‚´ì“°ê¸°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” ê¸°ë³¸ ì¡°íšŒ â”â”â”
const DB={
    // IDë¡œ 1ê°œ ì°¾ê¸°: DB.get('chars','char_003')
    get(cat,id){return(GD[cat]||[]).find(x=>x.id===id)||null;},
    // ì´ë¦„ìœ¼ë¡œ 1ê°œ ì°¾ê¸°: DB.byName('chars','ë¦¬ë‚˜ ìŠ¤í†¤')
    byName(cat,name){return(GD[cat]||[]).find(x=>(x.name||x.nm)===name)||null;},
    // ì „ì²´ ë°°ì—´: DB.all('chars')
    all(cat){return GD[cat]||[];},
    // ê°œìˆ˜: DB.count('mons')
    count(cat){return(GD[cat]||[]).length;},
    // ì´ ì•„ì´í…œ ìˆ˜
    total(){return Object.values(GD).reduce((s,v)=>s+(Array.isArray(v)?v.length:0),0);},

    // â”â”â” í•„í„° â”â”â”
    // ì¡°ê±´ í•„í„°: DB.where('chars',{cls:'ì „ì‚¬',el:'ë¹›'})
    where(cat,conds){return(GD[cat]||[]).filter(x=>Object.entries(conds).every(([k,v])=>x[k]===v));},
    // ë“±ê¸‰ í•„í„°: DB.byGrade('chars','epic')
    byGrade(cat,grade){return(GD[cat]||[]).filter(x=>(x.grade||x.rarity)===grade);},
    // íƒ€ì… í•„í„°: DB.byType('skills','ê³µê²©')
    byType(cat,type){return(GD[cat]||[]).filter(x=>x.type===type);},
    // ì†ì„± í•„í„°: DB.byElement('chars','í™”ì—¼')
    byElement(cat,el){return(GD[cat]||[]).filter(x=>x.el===el);},
    // ë²”ìœ„ í•„í„°: DB.range('chars','hp',1000,2000)
    range(cat,key,min,max){return(GD[cat]||[]).filter(x=>x[key]>=min&&x[key]<=max);},

    // â”â”â” ì •ë ¬ â”â”â”
    // ì •ë ¬: DB.sort('chars','atk','desc')
    sort(cat,key,dir){const d=dir==='desc'?-1:1;return[...(GD[cat]||[])].sort((a,b)=>((a[key]||0)-(b[key]||0))*d);},
    // Top N: DB.top('chars','atk',5)
    top(cat,key,n){return DB.sort(cat,key,'desc').slice(0,n||5);},
    // Bottom N: DB.bottom('chars','hp',3)
    bottom(cat,key,n){return DB.sort(cat,key,'asc').slice(0,n||5);},

    // â”â”â” ëœë¤ â”â”â”
    // ëœë¤ 1ê°œ: DB.random('mons')
    random(cat){const a=GD[cat]||[];return a[Math.floor(Math.random()*a.length)]||null;},
    // ëœë¤ Nê°œ: DB.randomN('items',3)
    randomN(cat,n){const a=[...(GD[cat]||[])];const r=[];for(let i=0;i<Math.min(n,a.length);i++){const j=Math.floor(Math.random()*a.length);r.push(a.splice(j,1)[0]);}return r;},

    // â”â”â” í†µê³„ â”â”â”
    // í•©ê³„: DB.sum('chars','hp')
    sum(cat,key){return(GD[cat]||[]).reduce((s,x)=>s+(x[key]||0),0);},
    // í‰ê· : DB.avg('chars','atk')
    avg(cat,key){const a=GD[cat]||[];return a.length?DB.sum(cat,key)/a.length:0;},
    // ìµœëŒ€: DB.max('chars','hp')
    max(cat,key){return Math.max(...(GD[cat]||[]).map(x=>x[key]||0));},
    // ìµœì†Œ: DB.min('mons','def')
    min(cat,key){return Math.min(...(GD[cat]||[]).map(x=>x[key]||0));},
    // ê·¸ë£¹ ì¹´ìš´íŠ¸: DB.groupCount('chars','cls') â†’ {ì „ì‚¬:3,ë§ˆë²•ì‚¬:2,...}
    groupCount(cat,key){const r={};(GD[cat]||[]).forEach(x=>{const k=x[key]||'?';r[k]=(r[k]||0)+1;});return r;},
    // ê³ ìœ ê°’: DB.unique('chars','el') â†’ ['ë²ˆê°œ','ë¹›','ë¬´ì†ì„±',...]
    unique(cat,key){return[...new Set((GD[cat]||[]).map(x=>x[key]).filter(Boolean))];},

    // â”â”â” ê²€ìƒ‰ â”â”â”
    // í…ìŠ¤íŠ¸ ê²€ìƒ‰: DB.search('ë¦¬ë‚˜') â†’ ì „ ì¹´í…Œê³ ë¦¬ì—ì„œ ê²€ìƒ‰
    search(text){const t=text.toLowerCase();const r=[];for(const cat in GD){if(!Array.isArray(GD[cat]))continue;GD[cat].forEach(x=>{const str=JSON.stringify(x).toLowerCase();if(str.includes(t))r.push({cat,...x});});}return r;},

    // â”â”â” ì „íˆ¬ ì‹œë®¬ â”â”â”
    // ì „íˆ¬: DB.battle('char_001','monster_003')
    battle(charId,monId){
        const c=DB.get('chars',charId)||DB.get('heroes',charId);const m=DB.get('mons',monId);
        if(!c||!m)return{error:'ìºë¦­í„°/ëª¬ìŠ¤í„° ì—†ìŒ'};
        let cHP=c.hp,mHP=m.hp;const log=[];let turn=0;
        while(cHP>0&&mHP>0&&turn<50){turn++;
            const cDmg=Math.max(1,c.atk-m.def*0.3+Math.random()*20|0);mHP-=cDmg;log.push(`[${turn}] ${c.name} â†’ ${m.name}: ${cDmg}dmg (ë‚¨ì€HP:${Math.max(0,mHP)})`);
            if(mHP<=0)break;
            const mDmg=Math.max(1,m.atk-c.def*0.3+Math.random()*15|0);cHP-=mDmg;log.push(`[${turn}] ${m.name} â†’ ${c.name}: ${mDmg}dmg (ë‚¨ì€HP:${Math.max(0,cHP)})`);
        }
        return{winner:cHP>0?c.name:m.name,turns:turn,cHP:Math.max(0,cHP),mHP:Math.max(0,mHP),log};
    },

    // â”â”â” ì”¬ ì˜¤ë¸Œì íŠ¸ ì—°ë™ â”â”â”
    // GD ë°ì´í„°ë¡œ ì”¬ì— ì˜¤ë¸Œì íŠ¸ ìŠ¤í°: DB.spawn('chars','char_003')
    spawn(cat,id){
        const d=DB.get(cat,id);if(!d)return toast('ë°ì´í„° ì—†ìŒ: '+id);
        const typeMap={chars:'char',mons:'mon',heroes:'hero',boss:'boss',npcs:'npc'};
        const type=typeMap[cat]||'cube';
        const pos=new THREE.Vector3(Math.random()*6-3,0,Math.random()*6-3);
        const obj=AO(type,pos);if(obj){obj.mesh.name=d.name;BH();}
        toast(`ğŸ® ${d.name} ìŠ¤í°!`);return obj;
    },
    // ì—¬ëŸ¬ ê°œ ìŠ¤í°: DB.spawnAll('mons') â†’ ëª¬ìŠ¤í„° ì „ë¶€ ìŠ¤í°
    spawnN(cat,n){const items=DB.randomN(cat,n||3);items.forEach(d=>DB.spawn(cat,d.id));return items;},

    // â”â”â” ìš”ì•½ ë¦¬í¬íŠ¸ â”â”â”
    report(){
        const r=[];for(const cat in GD){if(!Array.isArray(GD[cat]))continue;r.push(`${CAT_NAMES[cat]||cat}: ${GD[cat].length}ê°œ`);}
        return`ğŸ“Š ê²Œì„ ë°ì´í„° ë¦¬í¬íŠ¸\nì´ ${DB.total()}ê°œ í•­ëª©\n${r.join('\n')}`;
    },
    // ì¹´í…Œê³ ë¦¬ ìƒì„¸ ë¦¬í¬íŠ¸
    detail(cat){
        const a=GD[cat]||[];if(!a.length)return'ë°ì´í„° ì—†ìŒ';
        const keys=Object.keys(a[0]);const numKeys=keys.filter(k=>typeof a[0][k]==='number');
        let r=`${CAT_NAMES[cat]||cat} (${a.length}ê°œ)\n`;
        r+=`í•„ë“œ: ${keys.join(', ')}\n`;
        numKeys.forEach(k=>{r+=`${k}: avg=${DB.avg(cat,k).toFixed(0)} min=${DB.min(cat,k)} max=${DB.max(cat,k)}\n`;});
        const strKeys=keys.filter(k=>typeof a[0][k]==='string'&&k!=='id'&&k!=='name'&&k!=='spawn'&&k!=='ult'&&k!=='text'&&k!=='desc');
        strKeys.forEach(k=>{const g=DB.groupCount(cat,k);r+=`${k}: ${Object.entries(g).map(([v,c])=>`${v}(${c})`).join(' ')}\n`;});
        return r;
    },
};
let dataVisible=false,curCat='chars';

function toggleData(){dataVisible=!dataVisible;$('DP').style.display=dataVisible?'block':'none';if(dataVisible)buildDTabs();}
function buildDTabs(){
    let h='';for(const k in CAT_NAMES){const d=GD[k]||[];h+=`<div class="dtab ${k===curCat?'on':''}" onclick="showCat('${k}')">${CAT_NAMES[k]}(${d.length})</div>`;}
    $('DT').innerHTML=h;$('dcnt').textContent=Object.values(GD).reduce((s,v)=>s+(Array.isArray(v)?v.length:0),0)+' items';
    showCatList();
}
function showCat(c){curCat=c;buildDTabs();}
function gradeC(g){const m={'common':'gc','rare':'gr','epic':'ge','mythic':'gm','legendary':'gl','divine':'gd','Common':'gc','Rare':'gr','Epic':'ge','Mythic':'gm','Legendary':'gl'};return m[g]||'gc';}
function showCatList(){
    const items=GD[curCat]||[];
    let h='';
    items.forEach((it,i)=>{
        let name=it.name||it.nm||'?',sub='',stats='';
        const gc=gradeC(it.grade||it.rarity||'');
        switch(curCat){
            case'chars':sub=`${it.cls} | ${it.race} | ${it.el}`;stats=`<span>HP:${it.hp}</span><span>ATK:${it.atk}</span><span>DEF:${it.def}</span><span>SPD:${it.spd}</span>`;break;
            case'mons':sub=`${it.type} | ${it.race}`;stats=`<span>HP:${it.hp}</span><span>ATK:${it.atk}</span><span>DEF:${it.def}</span>`;break;
            case'skills':sub=`${it.type} | ${it.el}`;stats=`<span>DMG:${it.dmg}</span><span>CD:${it.cd}</span><span>MP:${it.cost}</span>`;break;
            case'equips':sub=`${it.type} | <span class="${gc}">${it.grade}</span>`;stats=`<span>ATK:${it.atk}</span><span>DEF:${it.def}</span>`;break;
            case'dungs':sub=`${it.diff} | Lv.${it.lv}`;stats=`<span>${it.floors}ì¸µ</span><span>${it.rooms}ë°©</span>`;break;
            case'raids':sub=`${it.diff}`;stats=`<span>Boss:${it.boss}</span>`;break;
            case'npcs':sub=it.type;stats=`<span>${it.text}</span>`;break;
            case'heroes':sub=`${it.type} | <span class="${gc}">${it.rarity}</span>`;stats=`<span>HP:${it.hp}</span><span>ATK:${it.atk}</span>`;break;
            case'boss':sub=it.diff;stats=`<span>HP:${it.hp}</span>`;break;
            default:sub=it.type||it.rarity||it.biome||it.desc||'';
        }
        h+=`<div class="di" onclick="spawnData('${curCat}',${i})"><div class="dn"><span class="${gc}">${name}</span></div><div class="dd">${sub}</div><div class="ds">${stats}</div></div>`;
    });
    if(!items.length)h='<div style="font-size:.5em;color:var(--tx2);text-align:center;padding:10px">ë°ì´í„° ì—†ìŒ</div>';
    $('DL').innerHTML=h;
}

/* ===== THREE.JS ===== */
const cv=$('C'),sc=new THREE.Scene(),ren=new THREE.WebGLRenderer({canvas:cv,antialias:true});
ren.shadowMap.enabled=true;ren.shadowMap.type=THREE.PCFSoftShadowMap;ren.toneMapping=THREE.ACESFilmicToneMapping;ren.toneMappingExposure=1.2;
const cam=new THREE.PerspectiveCamera(55,1,.1,500);cam.position.set(8,6,10);cam.lookAt(0,0,0);
sc.fog=new THREE.FogExp2(0x1a1a2e,.015);sc.background=new THREE.Color(0x0a0a1e);
const aL=new THREE.AmbientLight(0x404060,.5);sc.add(aL);
const dL=new THREE.DirectionalLight(0xfff4e0,.9);dL.position.set(8,15,8);dL.castShadow=true;dL.shadow.mapSize.set(2048,2048);dL.shadow.camera.left=-15;dL.shadow.camera.right=15;dL.shadow.camera.top=15;dL.shadow.camera.bottom=-15;sc.add(dL);
sc.add(new THREE.HemisphereLight(0x6688cc,0x222244,.3));
const gr=new THREE.Mesh(new THREE.PlaneGeometry(40,40),new THREE.MeshStandardMaterial({color:0x1e1e2e,roughness:.85}));gr.rotation.x=-Math.PI/2;gr.receiveShadow=true;sc.add(gr);
sc.add(new THREE.GridHelper(40,40,0x2a2a4a,0x1e1e32));
function RZ(){const r=cv.parentElement;ren.setSize(r.clientWidth,r.clientHeight);cam.aspect=r.clientWidth/r.clientHeight;cam.updateProjectionMatrix();}
window.addEventListener('resize',RZ);RZ();

/* ===== ORBIT ===== */
let oOn=false,pan=false,omx=0,omy=0,oR=14,oTh=.6,oPh=1,oTg=new THREE.Vector3(0,1,0);
function UO(){cam.position.set(oTg.x+oR*Math.sin(oPh)*Math.cos(oTh),oTg.y+oR*Math.cos(oPh),oTg.z+oR*Math.sin(oPh)*Math.sin(oTh));cam.lookAt(oTg);}
UO();
cv.addEventListener('contextmenu',e=>e.preventDefault());
cv.addEventListener('mousedown',e=>{if(PM)return;if(e.button===2)pan=true;else if(e.button===0&&!hObj)oOn=true;omx=e.clientX;omy=e.clientY;});
cv.addEventListener('mousemove',e=>{if(PM){PMM(e);return;}const dx=e.clientX-omx,dy=e.clientY-omy;omx=e.clientX;omy=e.clientY;
    if(oOn){oTh-=dx*.004;oPh=Math.max(.15,Math.min(3,oPh-dy*.004));UO();}
    if(pan){const s=oR*.0015;const r=new THREE.Vector3();cam.getWorldDirection(r);r.cross(cam.up).normalize();oTg.addScaledVector(r,-dx*s);oTg.y+=dy*s;UO();}
    CH(e);if(drg)DO(e);});
cv.addEventListener('mouseup',()=>{oOn=false;pan=false;drg=null;});
cv.addEventListener('wheel',e=>{if(PM)return;oR=Math.max(1.5,Math.min(60,oR+e.deltaY*.008));UO();});

/* ===== OBJECTS ===== */
let O=[],sI=null,nC=0,hObj=null,drg=null,gzM='m';
const COLS=[0x89b4fa,0xa6e3a1,0xf9e2af,0xf38ba8,0xcba6f7,0xf5c2e7,0x74c7ec,0xfab387,0x94e2d5,0xf2cdcd];
const ICO={cube:'ğŸ“¦',sphere:'ğŸ€',cyl:'ğŸ§Š',cone:'ğŸ”º',torus:'ğŸ©',plane:'â¬œ',stk:'ğŸ§',light:'ğŸ’¡',particle:'âœ¨',char:'âš”',mon:'ğŸ‘¹',npc:'ğŸ’¬',hero:'ğŸ¦¸',boss:'ğŸ’€'};
const GRADE_COL={common:0xa6adc8,rare:0x89b4fa,epic:0xcba6f7,mythic:0xf9e2af,legendary:0xfab387,divine:0xf38ba8,Common:0xa6adc8,Rare:0x89b4fa,Epic:0xcba6f7,Mythic:0xf9e2af,Legendary:0xfab387};

function AO(type,pos,gdata){
    const id=++nC,c=gdata?GRADE_COL[gdata.grade||gdata.rarity||'common']||0x89b4fa:COLS[id%COLS.length];
    let mesh,nm=type+'_'+id;
    const p=pos||new THREE.Vector3((Math.random()-.5)*6,type==='plane'?0:1,(Math.random()-.5)*6);
    switch(type){
        case'cube':mesh=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshStandardMaterial({color:c,roughness:.35,metalness:.1}));break;
        case'sphere':mesh=new THREE.Mesh(new THREE.SphereGeometry(.5,20,20),new THREE.MeshStandardMaterial({color:c,roughness:.25,metalness:.2}));break;
        case'cyl':mesh=new THREE.Mesh(new THREE.CylinderGeometry(.4,.4,1.2,16),new THREE.MeshStandardMaterial({color:c,roughness:.35}));break;
        case'cone':mesh=new THREE.Mesh(new THREE.ConeGeometry(.5,1.2,16),new THREE.MeshStandardMaterial({color:c,roughness:.35}));break;
        case'torus':mesh=new THREE.Mesh(new THREE.TorusGeometry(.4,.15,12,24),new THREE.MeshStandardMaterial({color:c,roughness:.25,metalness:.3}));break;
        case'plane':mesh=new THREE.Mesh(new THREE.PlaneGeometry(4,4),new THREE.MeshStandardMaterial({color:c,side:THREE.DoubleSide,roughness:.6}));mesh.rotation.x=-Math.PI/2;break;
        case'stk':case'char':case'hero':mesh=mkStk(c);p.y=0;break;
        case'mon':case'boss':mesh=mkMon(c,type==='boss');p.y=0;break;
        case'npc':mesh=mkNpc(c);p.y=0;break;
        case'light':const pl=new THREE.PointLight(0xffffff,1.5,20);pl.position.copy(p);pl.position.y=4;pl.castShadow=true;sc.add(pl);mesh=new THREE.Mesh(new THREE.OctahedronGeometry(.12,0),new THREE.MeshBasicMaterial({color:0xfff4a0}));mesh.userData.lt=pl;break;
        case'particle':mesh=mkPart();break;
    }
    mesh.position.copy(p);if(type!=='particle'){mesh.castShadow=true;mesh.receiveShadow=true;}
    mesh.userData.eid=id;sc.add(mesh);
    const obj={id,nm,type,mesh,gdata:gdata||null,
        p:{vx:0,vy:0,vz:0,m:1,bn:.5,fr:.3,st:type==='plane',gv:!['light','plane','particle'].includes(type)}};
    if(gdata){obj.nm=gdata.name||gdata.nm||nm;
        // HP bar
        if(gdata.hp){const hpG=new THREE.Group();
            const bg=new THREE.Mesh(new THREE.PlaneGeometry(.8,.06),new THREE.MeshBasicMaterial({color:0x333333,side:THREE.DoubleSide}));
            const fg=new THREE.Mesh(new THREE.PlaneGeometry(.78,.04),new THREE.MeshBasicMaterial({color:type==='mon'||type==='boss'?0xf38ba8:0xa6e3a1,side:THREE.DoubleSide}));
            fg.position.z=.001;hpG.add(bg);hpG.add(fg);
            const topY=type==='boss'?2.8:type==='mon'?2:1.9;
            hpG.position.set(0,topY,0);mesh.add(hpG);mesh.userData.hpBar=fg;}
        // Name label via sprite
        if(gdata.name){const cv2=document.createElement('canvas');cv2.width=256;cv2.height=32;const cx=cv2.getContext('2d');
            cx.fillStyle='rgba(0,0,0,.5)';cx.fillRect(0,0,256,32);cx.font='bold 14px Outfit';cx.fillStyle='#cdd6f4';cx.textAlign='center';cx.fillText(gdata.name,128,20);
            const tex=new THREE.CanvasTexture(cv2);const sp=new THREE.SpriteMaterial({map:tex,transparent:true});
            const spr=new THREE.Sprite(sp);spr.scale.set(1.2,.15,1);spr.position.y=(type==='boss'?3:type==='mon'?2.2:2.1);mesh.add(spr);}
    }
    O.push(obj);sI=id;BH();BI();UI();LG('+ '+obj.nm,'o');return obj;
}

function mkStk(c){
    const g=new THREE.Group(),m=new THREE.MeshStandardMaterial({color:c,emissive:c,emissiveIntensity:.15,roughness:.5});
    [[.06,.05,.55,0,1.05,0,0,0,0],[.15,0,0,0,1.52,0,0,0,0],[.03,.025,.42,-.24,1.08,0,0,0,.38],[.03,.025,.42,.24,1.08,0,0,0,-.38],[.04,.035,.52,-.09,.42,0,0,0,.06],[.04,.035,.52,.09,.42,0,0,0,-.06]].forEach((d,i)=>{
        const geo=i===1?new THREE.SphereGeometry(.15,12,12):new THREE.CylinderGeometry(d[0],d[1],d[2],i<2?8:5);
        const me=new THREE.Mesh(geo,m);me.position.set(d[3],d[4],d[5]);me.rotation.set(d[6],d[7],d[8]);me.castShadow=true;g.add(me);});return g;}

function mkMon(c,isBoss){
    const g=new THREE.Group(),m=new THREE.MeshStandardMaterial({color:c,emissive:c,emissiveIntensity:.25,roughness:.4});
    const s=isBoss?1.5:1;
    // Body
    g.add(Object.assign(new THREE.Mesh(new THREE.SphereGeometry(.4*s,10,10),m),{}));
    g.children[0].position.set(0,.8*s,0);g.children[0].scale.set(1,1.3,1);
    // Head
    const hd=new THREE.Mesh(new THREE.SphereGeometry(.25*s,8,8),m);hd.position.set(0,1.4*s,0);g.add(hd);
    // Eyes
    const eM=new THREE.MeshBasicMaterial({color:isBoss?0xf38ba8:0xf9e2af});
    const e1=new THREE.Mesh(new THREE.SphereGeometry(.05*s,6,6),eM);e1.position.set(-.1*s,1.5*s,.2*s);g.add(e1);
    const e2=new THREE.Mesh(new THREE.SphereGeometry(.05*s,6,6),eM);e2.position.set(.1*s,1.5*s,.2*s);g.add(e2);
    // Horns for boss
    if(isBoss){const hM=new THREE.MeshStandardMaterial({color:0xf38ba8,emissive:0xf38ba8,emissiveIntensity:.3});
        const h1=new THREE.Mesh(new THREE.ConeGeometry(.06,.3,5),hM);h1.position.set(-.15,1.8,0);h1.rotation.z=.3;g.add(h1);
        const h2=new THREE.Mesh(new THREE.ConeGeometry(.06,.3,5),hM);h2.position.set(.15,1.8,0);h2.rotation.z=-.3;g.add(h2);}
    // Legs
    const lM=new THREE.MeshStandardMaterial({color:c,roughness:.5});
    const l1=new THREE.Mesh(new THREE.CylinderGeometry(.06*s,.05*s,.4*s,5),lM);l1.position.set(-.12*s,.2*s,0);g.add(l1);
    const l2=new THREE.Mesh(new THREE.CylinderGeometry(.06*s,.05*s,.4*s,5),lM);l2.position.set(.12*s,.2*s,0);g.add(l2);
    g.children.forEach(c=>c.castShadow=true);return g;}

function mkNpc(c){
    const g=new THREE.Group(),m=new THREE.MeshStandardMaterial({color:c,emissive:c,emissiveIntensity:.1,roughness:.5});
    const body=new THREE.Mesh(new THREE.CylinderGeometry(.15,.25,.8,8),m);body.position.set(0,.6,0);g.add(body);
    const head=new THREE.Mesh(new THREE.SphereGeometry(.15,10,10),m);head.position.set(0,1.15,0);g.add(head);
    // Hat
    const hat=new THREE.Mesh(new THREE.ConeGeometry(.2,.25,8),new THREE.MeshStandardMaterial({color:0xf9e2af,roughness:.5}));hat.position.set(0,1.38,0);g.add(hat);
    g.children.forEach(c=>c.castShadow=true);return g;}

function mkPart(){const g=new THREE.Group();const geo=new THREE.BufferGeometry();const cnt=80;const pos=new Float32Array(cnt*3),vel=new Float32Array(cnt*3);
    for(let i=0;i<cnt;i++){pos[i*3]=(Math.random()-.5)*.5;pos[i*3+1]=Math.random()*2;pos[i*3+2]=(Math.random()-.5)*.5;vel[i*3]=(Math.random()-.5)*.3;vel[i*3+1]=.5+Math.random();vel[i*3+2]=(Math.random()-.5)*.3;}
    geo.setAttribute('position',new THREE.BufferAttribute(pos,3));const pts=new THREE.Points(geo,new THREE.PointsMaterial({color:0xfab387,size:.08,transparent:true,opacity:.8,blending:THREE.AdditiveBlending}));
    pts.userData.vel=vel;pts.userData.isPart=true;g.add(pts);return g;}

/* ===== SPAWN FROM DATA ===== */
function spawnData(cat,idx){
    const it=(GD[cat]||[])[idx];if(!it)return;
    let type='stk';
    if(cat==='mons')type='mon';else if(cat==='boss')type='boss';else if(cat==='chars'||cat==='heroes')type='char';
    else if(cat==='npcs')type='npc';else if(cat==='equips')type='cube';else if(cat==='skills')type='sphere';
    else if(cat==='dungs'||cat==='raids')type='cone';else if(cat==='pets')type='sphere';
    else if(cat==='mounts')type='torus';else type='cyl';
    const obj=AO(type,new THREE.Vector3((Math.random()-.5)*8,type==='plane'?0:1,(Math.random()-.5)*8),it);
    LG(`ğŸ“Š ${it.name||it.nm} ìŠ¤í°! [${cat}]`,'o');toast('ğŸ“Š '+it.name);
}

function DS(){if(!sI)return;const i=O.findIndex(o=>o.id===sI);if(i<0)return;const o=O[i];sc.remove(o.mesh);if(o.mesh.userData.lt)sc.remove(o.mesh.userData.lt);LG('- '+o.nm,'w');O.splice(i,1);sI=null;BH();BI();UI();}
function DU(){if(!sI)return;const o=O.find(o=>o.id===sI);if(!o)return;AO(o.type,o.mesh.position.clone().add(new THREE.Vector3(.8,0,.8)),o.gdata);LG('ğŸ“‹ '+o.nm,'o');}
function SO(id){sI=id;BH();BI();}
function FO(id){const o=O.find(o=>o.id===id);if(!o)return;oTg.copy(o.mesh.position);oR=5;UO();}

function BH(){$('HL').innerHTML=O.map(o=>`<div class="hi ${o.id===sI?'sel':''}" onclick="SO(${o.id})" ondblclick="FO(${o.id})"><span class="ic">${ICO[o.type]||'?'}</span><span class="nm">${o.nm}</span></div>`).join('');}

/* ===== INSPECTOR ===== */
function BI(){
    const o=O.find(o=>o.id===sI);
    if(!o){$('IB').innerHTML='<div class="isc"><div style="font-size:.5em;color:var(--tx2);text-align:center;padding:14px 0">ì˜¤ë¸Œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</div></div>';return;}
    const p=o.mesh.position,r=o.mesh.rotation,s=o.mesh.scale;
    let h=`<div class="isc"><div class="ist">${ICO[o.type]||'?'} ${o.nm}</div></div>`;
    // Game data info
    if(o.gdata){const g=o.gdata;
        h+=`<div class="isc"><div class="ist">ğŸ“Š Game Data</div>`;
        if(g.cls)h+=`<div class="ir"><span class="il">í´ë˜ìŠ¤</span><span style="font-size:.5em">${g.cls}</span></div>`;
        if(g.race)h+=`<div class="ir"><span class="il">ì¢…ì¡±</span><span style="font-size:.5em">${g.race}</span></div>`;
        if(g.el)h+=`<div class="ir"><span class="il">ì†ì„±</span><span style="font-size:.5em">${g.el}</span></div>`;
        if(g.grade||g.rarity)h+=`<div class="ir"><span class="il">ë“±ê¸‰</span><span style="font-size:.5em" class="${gradeC(g.grade||g.rarity)}">${g.grade||g.rarity}</span></div>`;
        if(g.hp)h+=`<div class="ir"><span class="il">HP</span><span style="font-size:.5em;color:var(--gn)">${g.hp}</span></div>`;
        if(g.atk)h+=`<div class="ir"><span class="il">ATK</span><span style="font-size:.5em;color:var(--rd)">${g.atk}</span></div>`;
        if(g.def)h+=`<div class="ir"><span class="il">DEF</span><span style="font-size:.5em;color:var(--ac)">${g.def}</span></div>`;
        if(g.spawn)h+=`<div style="font-size:.42em;color:var(--tx2);padding:2px 0;font-style:italic">"${g.spawn}"</div>`;
        if(g.ult)h+=`<div style="font-size:.42em;color:var(--mv);padding:2px 0">âš¡ ${g.ult}</div>`;
        if(g.weapon)h+=`<div class="ir"><span class="il">ë¬´ê¸°</span><span style="font-size:.5em">${g.weapon}</span></div>`;
        if(g.text)h+=`<div style="font-size:.42em;color:var(--tx2);padding:2px 0">"${g.text}"</div>`;
        if(g.diff)h+=`<div class="ir"><span class="il">ë‚œì´ë„</span><span style="font-size:.5em">${g.diff}</span></div>`;
        if(g.floors)h+=`<div class="ir"><span class="il">ì¸µìˆ˜</span><span style="font-size:.5em">${g.floors}</span></div>`;
        h+=`</div>`;}
    // Transform
    h+=`<div class="isc"><div class="ist">ğŸ“ ìœ„ì¹˜</div>
<div class="ir"><span class="il" style="color:#f38ba8">X</span><input class="iv" value="${p.x.toFixed(1)}" onchange="SP('px',this.value)">
<span class="il" style="color:#a6e3a1">Y</span><input class="iv" value="${p.y.toFixed(1)}" onchange="SP('py',this.value)">
<span class="il" style="color:#89b4fa">Z</span><input class="iv" value="${p.z.toFixed(1)}" onchange="SP('pz',this.value)"></div>
<div class="ir"><span class="il">RY</span><input class="iv" value="${(r.y*57.3).toFixed(0)}" onchange="SP('ry',this.value)">
<span class="il">S</span><input class="iv" value="${s.x.toFixed(2)}" onchange="SP('sx',this.value);SP('sy',this.value);SP('sz',this.value)"></div></div>`;
    // Physics
    h+=`<div class="isc"><div class="ist">âš›ï¸ Physics</div>
<div class="ir"><label style="font-size:.48em;color:var(--tx2)"><input type="checkbox" class="ich" ${o.p.gv?'checked':''} onchange="SPH('gv',this.checked)">ì¤‘ë ¥</label>
<label style="font-size:.48em;color:var(--tx2)"><input type="checkbox" class="ich" ${o.p.st?'checked':''} onchange="SPH('st',this.checked)">ê³ ì •</label></div>
<div class="ir"><span class="il">íƒ„ì„±</span><input type="range" class="irng" min="0" max="100" value="${o.p.bn*100|0}" oninput="SPH('bn',this.value/100)"></div></div>`;
    // Material
    if(o.mesh.material&&o.mesh.material.color){
        h+=`<div class="isc"><div class="ist">ğŸ¨ Material</div>
<div class="ir"><span class="il">ìƒ‰</span><input type="color" style="width:24px;height:16px;border:1px solid var(--bd);border-radius:2px;cursor:pointer" value="#${o.mesh.material.color.getHexString()}" onchange="SM('c',this.value)">
<span class="il">ê±°ì¹ ê¸°</span><input type="range" class="irng" min="0" max="100" value="${(o.mesh.material.roughness||0)*100}" oninput="SM('r',this.value/100)"></div></div>`;}
    $('IB').innerHTML=h;
}
function SP(p,v){const o=O.find(o=>o.id===sI);if(!o)return;const n=parseFloat(v);if(isNaN(n))return;const m=o.mesh;
    if(p==='px')m.position.x=n;if(p==='py')m.position.y=n;if(p==='pz')m.position.z=n;
    if(p==='ry')m.rotation.y=n/57.3;if(p==='sx')m.scale.x=n;if(p==='sy')m.scale.y=n;if(p==='sz')m.scale.z=n;
    if(m.userData.lt)m.userData.lt.position.copy(m.position);}
function SPH(p,v){const o=O.find(o=>o.id===sI);if(!o)return;o.p[p]=v;BI();}
function SM(p,v){const o=O.find(o=>o.id===sI);if(!o||!o.mesh.material)return;if(p==='c')o.mesh.material.color.set(v);if(p==='r')o.mesh.material.roughness=v;}

/* ===== RAYCAST ===== */
const rc=new THREE.Raycaster(),ms=new THREE.Vector2();
function CH(e){if(PM)return;const r=cv.getBoundingClientRect();ms.x=((e.clientX-r.left)/r.width)*2-1;ms.y=-((e.clientY-r.top)/r.height)*2+1;
    rc.setFromCamera(ms,cam);const arr=O.map(o=>['stk','char','hero','mon','boss','npc','particle'].includes(o.type)?o.mesh.children:o.mesh).flat();
    const h=rc.intersectObjects(arr,true);hObj=null;if(h.length){let m=h[0].object;while(m.parent&&!m.userData.eid)m=m.parent;if(m.userData.eid)hObj=m;}cv.style.cursor=hObj?'pointer':'default';}
cv.addEventListener('click',e=>{if(PM)return;if(hObj){const o=O.find(o=>o.mesh===hObj);if(o){sI=o.id;BH();BI();drg=hObj;}}else if(!oOn){sI=null;BH();BI();}});
function DO(e){if(!drg||PM)return;const r=cv.getBoundingClientRect();ms.x=((e.clientX-r.left)/r.width)*2-1;ms.y=-((e.clientY-r.top)/r.height)*2+1;
    rc.setFromCamera(ms,cam);const pl=new THREE.Plane(new THREE.Vector3(0,1,0),-drg.position.y);const pt=new THREE.Vector3();
    rc.ray.intersectPlane(pl,pt);if(pt){drg.position.x=pt.x;drg.position.z=pt.z;if(drg.userData.lt){drg.userData.lt.position.x=pt.x;drg.userData.lt.position.z=pt.z;}BI();}}

function SG(m){gzM=m;['gM','gR','gS'].forEach(id=>$(id).classList.remove('on'));$({m:'gM',r:'gR',s:'gS'}[m]).classList.add('on');}
function UI(){$('VI').textContent=`${PM?'â–¶ ì‹¤í–‰':'í¸ì§‘'} | ${O.length}ê°œ`;$('OC').textContent=O.length+'ê°œ';}
function toggleEnv(){sc.background=new THREE.Color(sc.background.r>.3?0x0a0a1e:0x87ceeb);toast(sc.background.r>.3?'â˜€ï¸ ë‚®':'ğŸŒ™ ë°¤');}

/* ===== PHYSICS ===== */
function PHS(dt){
    O.forEach(o=>{if(o.p.st||o.type==='particle')return;if(o.p.gv)o.p.vy-=9.8*dt;
        o.mesh.position.x+=o.p.vx*dt;o.mesh.position.y+=o.p.vy*dt;o.mesh.position.z+=o.p.vz*dt;
        const r=o.type==='sphere'?.5*o.mesh.scale.y:['stk','char','hero','npc'].includes(o.type)?0:.5*o.mesh.scale.y;
        if(o.mesh.position.y<r){o.mesh.position.y=r;if(o.p.vy<0)o.p.vy=-o.p.vy*o.p.bn;o.p.vx*=(1-o.p.fr*.5);o.p.vz*=(1-o.p.fr*.5);if(Math.abs(o.p.vy)<.08)o.p.vy=0;}
        if(Math.abs(o.mesh.position.x)>18){o.mesh.position.x=Math.sign(o.mesh.position.x)*18;o.p.vx*=-o.p.bn;}
        if(Math.abs(o.mesh.position.z)>18){o.mesh.position.z=Math.sign(o.mesh.position.z)*18;o.p.vz*=-o.p.bn;}});
    for(let i=0;i<O.length;i++){if(O[i].p.st||O[i].type==='particle')continue;
        for(let j=i+1;j<O.length;j++){const a=O[i],b=O[j];const dx=b.mesh.position.x-a.mesh.position.x,dy=b.mesh.position.y-a.mesh.position.y,dz=b.mesh.position.z-a.mesh.position.z;
            const d=Math.sqrt(dx*dx+dy*dy+dz*dz),mn=.8;if(d<mn&&d>.01){const nx=dx/d,ny=dy/d,nz=dz/d,ov=(mn-d)/2;
                if(!a.p.st){a.mesh.position.x-=nx*ov;a.mesh.position.y-=ny*ov;a.mesh.position.z-=nz*ov;}
                if(!b.p.st){b.mesh.position.x+=nx*ov;b.mesh.position.y+=ny*ov;b.mesh.position.z+=nz*ov;}
                const rD=(a.p.vx-b.p.vx)*nx+(a.p.vy-b.p.vy)*ny+(a.p.vz-b.p.vz)*nz;
                if(rD>0){const bn=Math.max(a.p.bn,b.p.bn),imp=rD*(1+bn)/(1/a.p.m+1/b.p.m);
                    if(!a.p.st){a.p.vx-=imp/a.p.m*nx;a.p.vy-=imp/a.p.m*ny;a.p.vz-=imp/a.p.m*nz;}
                    if(!b.p.st){b.p.vx+=imp/b.p.m*nx;b.p.vy+=imp/b.p.m*ny;b.p.vz+=imp/b.p.m*nz;}}}}}
    O.forEach(o=>{if(o.type!=='particle')return;o.mesh.children.forEach(c=>{if(!c.userData.isPart)return;const pos=c.geometry.attributes.position,vel=c.userData.vel;
        for(let i=0;i<pos.count;i++){pos.array[i*3]+=vel[i*3]*dt;pos.array[i*3+1]+=vel[i*3+1]*dt;pos.array[i*3+2]+=vel[i*3+2]*dt;vel[i*3+1]-=1.5*dt;
            if(pos.array[i*3+1]<0){pos.array[i*3]=(Math.random()-.5)*.3;pos.array[i*3+1]=0;pos.array[i*3+2]=(Math.random()-.5)*.3;vel[i*3+1]=.5+Math.random();}}pos.needsUpdate=true;});});
}

/* ===== PLAY MODE ===== */
let PM=false,PO=null,keys={},pYaw=0,pPitch=0,pVY=0,pGnd=true,saved=[];
function TP(){PM=!PM;$('pBtn').className='tb '+(PM?'stop':'play');$('pBtn').innerHTML=PM?'â¹ ì •ì§€':'â–¶ ì‹¤í–‰';
    $('mLbl').textContent=PM?'ì‹¤í–‰ì¤‘':'í¸ì§‘';$('PH').style.display=PM?'block':'none';
    if(PM){saved=O.map(o=>({id:o.id,pos:o.mesh.position.clone(),rot:o.mesh.rotation.clone(),p:{...o.p}}));
        PO=O.find(o=>o.type==='stk'||o.type==='char'||o.type==='hero');if(!PO)PO=AO('stk',new THREE.Vector3(0,0,0));
        PO.p.st=true;PO.p.gv=false;pYaw=0;pVY=0;pGnd=true;cv.requestPointerLock();LG('â–¶ ì‹¤í–‰ ëª¨ë“œ ì‹œì‘!','o');
    }else{saved.forEach(s=>{const o=O.find(o=>o.id===s.id);if(o){o.mesh.position.copy(s.pos);o.mesh.rotation.copy(s.rot);Object.assign(o.p,s.p);}});
        document.exitPointerLock();LG('â¹ í¸ì§‘ ëª¨ë“œ ë³µê·€','w');}UI();}
function PMM(e){if(!PM)return;pYaw-=e.movementX*.002;pPitch=Math.max(-1.2,Math.min(1.2,pPitch-e.movementY*.002));}
function PU(dt){if(!PM||!PO)return;const sp=6,p=PO.mesh.position;
    const fw=new THREE.Vector3(-Math.sin(pYaw),0,-Math.cos(pYaw)),rt=new THREE.Vector3(fw.z,0,-fw.x);
    if(keys['w']||keys['ArrowUp'])p.addScaledVector(fw,sp*dt);if(keys['s']||keys['ArrowDown'])p.addScaledVector(fw,-sp*dt);
    if(keys['a']||keys['ArrowLeft'])p.addScaledVector(rt,-sp*dt);if(keys['d']||keys['ArrowRight'])p.addScaledVector(rt,sp*dt);
    pVY-=18*dt;if(keys[' ']&&pGnd){pVY=7;pGnd=false;}p.y+=pVY*dt;if(p.y<0){p.y=0;pVY=0;pGnd=true;}
    p.x=Math.max(-18,Math.min(18,p.x));p.z=Math.max(-18,Math.min(18,p.z));PO.mesh.rotation.y=pYaw;
    if((keys['w']||keys['s']||keys['a']||keys['d'])&&pGnd){const t=performance.now()*.008;PO.mesh.children.forEach((c,i)=>{if(i>=4)c.rotation.x=Math.sin(t+i*Math.PI)*.4;if(i>=2&&i<4)c.rotation.z=Math.sin(t+i*Math.PI)*.3*(i===2?1:-1);});}
    const cd=5,ch=2.5;cam.position.lerp(new THREE.Vector3(p.x-fw.x*cd,p.y+ch,p.z-fw.z*cd),.08);cam.lookAt(p.x,p.y+1.3,p.z);
    // HP bars face camera
    O.forEach(o=>{if(o.mesh.userData.hpBar){const bp=o.mesh.userData.hpBar.parent;if(bp)bp.lookAt(cam.position);}});
}

/* ===== FILE ===== */
function saveScene(){const d={objs:O.map(o=>({type:o.type,nm:o.nm,pos:[o.mesh.position.x,o.mesh.position.y,o.mesh.position.z],gdata:o.gdata}))};
    const a=document.createElement('a');a.download='scene.json';a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(d,null,2));a.click();toast('ğŸ’¾');}
function loadScene(){const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;
    const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);O.forEach(o=>{sc.remove(o.mesh);if(o.mesh.userData.lt)sc.remove(o.mesh.userData.lt);});O=[];nC=0;
        d.objs.forEach(o=>{AO(o.type,new THREE.Vector3(...o.pos),o.gdata);});BH();BI();UI();LG('ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! '+d.objs.length+'ê°œ','o');toast('ğŸ“‚');
    }catch(e){LG('âŒ '+e,'e');}};r.readAsText(f);};i.click();}
function importJSON(){const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;
    const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);let cnt=0;
        // Try to detect UNITY_ALL_SYSTEMS format
        if(d.characters){GD.chars=d.characters.map(c=>({id:c.id,name:c.name,cls:c.class||'',grade:c.grade||'',race:c.race||'',el:c.element||'',
            hp:c.stats?.hp||0,atk:c.stats?.attack||0,def:c.stats?.defense||0,spd:c.stats?.speed||0,
            spawn:c.voice?.lines?.spawn||'',ult:c.voice?.lines?.ultimate||'',weapon:c.combatStyle?.preferredWeapon||''}));cnt+=GD.chars.length;}
        if(d.monsters){GD.mons=d.monsters.map(m=>({id:m.id,name:m.monsterName||'?',type:m.type||'',race:m.race||'',
            hp:m.stats?.maxHP||0,atk:m.stats?.baseATK||0,def:m.stats?.baseDEF||0}));cnt+=GD.mons.length;}
        if(d.skills){GD.skills=d.skills.map(s=>({id:s.id,name:s.name||'?',type:s.type||'',el:s.element||'',
            dmg:s.stats?.damage||0,cd:s.stats?.cooldown||0,cost:s.stats?.manaCost||0}));cnt+=GD.skills.length;}
        if(d.dungeons){GD.dungs=d.dungeons.map(dd=>({id:dd.id,name:dd.name||'?',diff:dd.difficulty||'',lv:dd.recommendedLevel||0,
            floors:dd.layout?.floors||0,rooms:dd.layout?.rooms||0,boss:dd.enemies?.boss||''}));cnt+=GD.dungs.length;}
        if(d.equipments){GD.equips=d.equipments.map(e=>({id:e.id,name:e.name||'?',type:e.type||'',grade:e.grade||'',
            atk:e.stats?.base?.attack||0,def:e.stats?.base?.defense||0}));cnt+=GD.equips.length;}
        if(d.raids){GD.raids=d.raids.map(r=>({id:r.id,name:r.name||'?',boss:r.boss||'',diff:r.difficulty||''}));cnt+=GD.raids.length;}
        if(d.npcs){GD.npcs=d.npcs.map(n=>({id:n.id,name:n.npcName||'?',type:n.npcType||'',text:n.dialogueText?.substring(0,50)||''}));cnt+=GD.npcs.length;}
        if(d.pets){GD.pets=d.pets.map(p=>({id:p.id,name:p.petName||'?',type:p.petType||'',rarity:p.rarity||''}));cnt+=GD.pets.length;}
        if(d.mounts){GD.mounts=d.mounts.map(m=>({id:m.id,name:m.mountName||'?',type:m.mountType||'',rarity:m.rarity||''}));cnt+=GD.mounts.length;}
        if(d.heroes){GD.heroes=d.heroes.map(h=>({id:h.id,name:h.heroName||'?',type:h.type||'',rarity:h.rarity||'',
            hp:h.stats?.maxHP||0,atk:h.stats?.baseATK||0}));cnt+=GD.heroes.length;}
        if(d.bossRaids){GD.boss=d.bossRaids.map(b=>({id:b.id,name:b.bossName||'?',diff:b.difficulty||'',hp:b.bossStats?.maxHP||0}));cnt+=GD.boss.length;}
        if(d.quests){GD.quests=d.quests.map(q=>({id:q.id,name:q.questName||'?',type:q.questType||'',desc:q.description?.substring(0,50)||''}));cnt+=GD.quests.length;}
        if(d.guilds){GD.guilds=d.guilds.map(g=>({id:g.id,name:g.guildName||'?',tag:g.guildTag||'',cnt:g.members?.current||0}));cnt+=GD.guilds.length;}
        if(d.items){GD.items=d.items.map(i=>({id:i.id,name:i.itemName||'?',type:i.itemType||'',rarity:i.rarity||''}));cnt+=GD.items.length;}
        if(d.regions){GD.regions=d.regions.map(r=>({id:r.id,name:r.name||'?',biome:r.biome||'',danger:r.danger||''}));cnt+=GD.regions.length;}
        if(cnt>0){dataVisible=true;$('DP').style.display='block';buildDTabs();LG(`ğŸ“‚ JSON ì„í¬íŠ¸! ${cnt}ê°œ ë°ì´í„°`,'o');toast('ğŸ“‚ '+cnt+'ê°œ!');}
        else LG('âš ï¸ ì¸ì‹ ë¶ˆê°€','w');
    }catch(e){LG('âŒ '+e,'e');}};r.readAsText(f);};i.click();}

/* ===== KEYBOARD ===== */
document.addEventListener('keydown',e=>{keys[e.key]=true;if(e.key==='Escape'&&PM)TP();if(e.key==='Delete'&&!PM)DS();if(e.key==='d'&&e.ctrlKey&&!PM){e.preventDefault();DU();}if(e.key==='f'&&!PM&&sI)FO(sI);});
document.addEventListener('keyup',e=>{keys[e.key]=false;});

/* ===== GIZMO ===== */
let gizmo=null;
function updGizmo(){if(gizmo){sc.remove(gizmo);gizmo=null;}if(!sI||PM)return;const o=O.find(o=>o.id===sI);if(!o)return;
    gizmo=new THREE.Group();const ml=.8;
    const xa=new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,ml,4),new THREE.MeshBasicMaterial({color:0xf38ba8}));xa.rotation.z=-Math.PI/2;xa.position.set(ml/2,0,0);gizmo.add(xa);
    const ya=new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,ml,4),new THREE.MeshBasicMaterial({color:0xa6e3a1}));ya.position.set(0,ml/2,0);gizmo.add(ya);
    const za=new THREE.Mesh(new THREE.CylinderGeometry(.015,.015,ml,4),new THREE.MeshBasicMaterial({color:0x89b4fa}));za.rotation.x=Math.PI/2;za.position.set(0,0,ml/2);gizmo.add(za);
    gizmo.position.copy(o.mesh.position);sc.add(gizmo);}

/* ===== AI ìºë¦­í„° ìƒì„± ì‹œìŠ¤í…œ ===== */
const AI_NAMES={ì„±:'ê¹€,ì´,ë°•,ìµœ,ì •,ê°•,ì¡°,ìœ¤,ì¥,ì„,í•œ,ì˜¤,ì„œ,ì‹ ,ê¶Œ,í™©,ì•ˆ,ì†¡,ë¥˜,ì „'.split(','),
    ì´ë¦„:'í•˜ëŠ˜,ë³„ë¹›,ì€í•˜,ì„œë¦¬,íƒœì–‘,ë‹¬ë¹›,ì²œë‘¥,ë°”ëŒ,ë¶ˆê½ƒ,íŒŒë„,ë¹„ì·¨,í‘ì—¼,ë°±í˜¸,ì²­ë£¡,ì£¼ì‘,í˜„ë¬´,ê¸ˆê°•,ìš©ì•„,ì²œí•˜,ë¬´ìŒ,ì€ë¹›,í‘í’,ì ì›”,ë…¹ë¦¼,ììš´,í™ë ¨,ë²½ë ¥,ì„¤í™”,ë‚œì´ˆ,í’ì›”'.split(',')};
const AI_CLS=['ì „ì‚¬','ë§ˆë²•ì‚¬','ë„ì ','ê¶ìˆ˜','ì„±ê¸°ì‚¬','íëŸ¬','ì†Œí™˜ì‚¬','ì•”ì‚´ì'];
const AI_GRADES=['common','rare','epic','mythic','legendary'];
const AI_RACES=['ì¸ê°„','ì—˜í”„','ë“œì›Œí”„','ì˜¤í¬','ë“œë˜ê³¤ë³¸','ì–¸ë°ë“œ','ì²œì‚¬ì¡±','ì•…ë§ˆì¡±','ìˆ˜ì¸ì¡±','ìš”ì •ì¡±'];
const AI_ELEMENTS=['í™”ì—¼','ëƒ‰ê¸°','ë²ˆê°œ','ëŒ€ì§€','ë¹›','ì–´ë‘ ','ìì—°','ë¬´ì†ì„±'];
const AI_WEAPONS={ì „ì‚¬:['ëŒ€ê²€','ì¥ê²€','ë„ë¼','ì „íˆ¬ë§ì¹˜','í• ë²„ë“œ'],ë§ˆë²•ì‚¬:['ì™„ë“œ','ì§€íŒ¡ì´','ìˆ˜ì •êµ¬','ë§ˆë²•ì„œ','ì˜¤ë¸Œ'],ë„ì :['ë‹¨ê²€','ìŒê²€','ë ˆì´í”¼ì–´','íˆ¬ì²™ë‹¨ê²€','ë¶€ì±„'],ê¶ìˆ˜:['ì¥ê¶','ì„ê¶','ë³µí•©ê¶','íˆ¬ì²™ì°½','ìŠ¬ë§'],ì„±ê¸°ì‚¬:['ì„±ê²€','ì°½ê³¼ë°©íŒ¨','í”Œë ˆì¼','ì„±ìŠ¤ëŸ¬ìš´ì² í‡´','ë¹›ì˜ì°½'],íëŸ¬:['ì¹˜ìœ ì˜ì§€íŒ¡ì´','ì‹ ì„±í•œí™€','ê¸°ë„ì„œ','ë¹›ì˜êµ¬ìŠ¬','ìƒëª…ë‚˜ë¬´ì§€íŒ¡ì´'],ì†Œí™˜ì‚¬:['ì†Œí™˜ì„œ','ê³„ì•½ì˜ë°˜ì§€','ì •ë ¹ì„','ì†Œí™˜ì§€íŒ¡ì´','ì¸í˜•'],ì•”ì‚´ì:['ë¹„ìˆ˜','ë…ì¹¨','ì•”ì‚´ê²€','ê°€ë¡œíŠ¸','ìˆ¨ê²¨ì§„ì¹¼ë‚ ']};
const AI_STYLES=['ê³µê²©í˜•','ë°©ì–´í˜•','ê· í˜•í˜•','ì†ê³µí˜•','ì¤‘ê°‘í˜•','ë§ˆë²•ì „ì‚¬í˜•','ìœ ê²©í˜•','ì§€ì›í˜•'];
const AI_TRAITS=['ëƒ‰ì² í•œ','ì—´ì •ì ì¸','ì‹ ì¤‘í•œ','ëŒ€ë‹´í•œ','ì§€í˜œë¡œìš´','ë¬´ìë¹„í•œ','ìë¹„ë¡œìš´','ê³ ë…í•œ','ìœ ì¾Œí•œ','ê·¼ì—„í•œ','ê´‘ê¸°ì–´ë¦°','ì°¨ë¶„í•œ','ë°©ë‘í•˜ëŠ”','ìˆ˜í˜¸í•˜ëŠ”','ë³µìˆ˜ì— ë¶ˆíƒ€ëŠ”','íƒêµ¬í•˜ëŠ”'];
const AI_ORIGINS=['ì™•ë„','ë³€ë°© ë§ˆì„','ìˆ²ì† ì€ë‘”ì²˜','í•´ì•ˆ ë„ì‹œ','ì‚°ì•… ìš”ìƒˆ','ì§€í•˜ ë„ì‹œ','ìœ ë‘ë¯¼ ì¶œì‹ ','ê·€ì¡± ê°€ë¬¸','ì „ìŸê³ ì•„','ìˆ˜ë„ì›','í•´ì ì„ ','ìš©ë³‘ë‹¨','ë§ˆë²•íƒ‘','ì•”í‘ê°€','ì„±ì—­'];

const GRADE_MULT={common:1,rare:1.3,epic:1.7,mythic:2.2,legendary:3};
const GRADE_KR={common:'ì¼ë°˜',rare:'ë ˆì–´',epic:'ì—í”½',mythic:'ì‹ í™”',legendary:'ì „ì„¤'};
const CLS_BASE={ì „ì‚¬:{hp:1400,atk:160,def:150,spd:55,crit:12},ë§ˆë²•ì‚¬:{hp:800,atk:280,def:55,spd:70,crit:20},ë„ì :{hp:900,atk:200,def:65,spd:130,crit:45},ê¶ìˆ˜:{hp:950,atk:190,def:60,spd:90,crit:35},ì„±ê¸°ì‚¬:{hp:1600,atk:150,def:180,spd:50,crit:10},íëŸ¬:{hp:1000,atk:80,def:90,spd:65,crit:8},ì†Œí™˜ì‚¬:{hp:850,atk:220,def:50,spd:60,crit:15},ì•”ì‚´ì:{hp:750,atk:300,def:40,spd:160,crit:55}};

function rnd(arr){return arr[Math.random()*arr.length|0];}
function rndR(mn,mx){return mn+Math.random()*(mx-mn)|0;}

function aiGenerateOne(opts={}){
    const cls=opts.cls||rnd(AI_CLS);
    const grade=opts.grade||rnd(AI_GRADES);
    const race=opts.race||rnd(AI_RACES);
    const el=opts.el||rnd(AI_ELEMENTS);
    const mult=GRADE_MULT[grade]||1;
    const base=CLS_BASE[cls]||CLS_BASE['ì „ì‚¬'];
    const vari=()=>(.8+Math.random()*.4);
    const name=rnd(AI_NAMES.ì„±)+rnd(AI_NAMES.ì´ë¦„);
    const weapon=rnd(AI_WEAPONS[cls]||['ê²€']);
    const trait=rnd(AI_TRAITS);
    const origin=rnd(AI_ORIGINS);
    const style=rnd(AI_STYLES);
    const hp=Math.round(base.hp*mult*vari());
    const atk=Math.round(base.atk*mult*vari());
    const def=Math.round(base.def*mult*vari());
    const spd=Math.round(base.spd*mult*vari());
    const crit=Math.min(100,Math.round(base.crit*mult*vari()));
    const mp=Math.round((300+Math.random()*500)*mult);
    const elSpawn={í™”ì—¼:'ë¶ˆê½ƒ',ëƒ‰ê¸°:'ì–¼ìŒ',ë²ˆê°œ:'ë²ˆê°œ',ëŒ€ì§€:'ëŒ€ì§€',ë¹›:'ë¹›',ì–´ë‘ :'ì–´ë‘ ',ìì—°:'ìì—°',ë¬´ì†ì„±:'í˜¼ëˆ'};
    const spawns=[
        `ë‚˜ëŠ” ${origin} ì¶œì‹  ${cls}. ${el}ì˜ í˜ì´ ë‚˜ì™€ í•¨ê»˜í•œë‹¤!`,
        `${trait} ${cls}, ${name}. ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì§€.`,
        `${race}ì˜ í”¼ê°€ íë¥´ëŠ” ${cls}ë‹¤. ê°ì˜¤í•´ë¼!`,
        `${elSpawn[el]||el}ì´ì—¬, ë‚´ ${weapon}ì— í˜ì„ ë¶ˆì–´ë„£ì–´ë¼!`
    ];
    const ults=[
        `${el}ì˜ ì‹¬íŒì„ ë°›ì•„ë¼!`,
        `ì´ê²ƒì´ ${race}ì˜ ì§„ì •í•œ í˜ì´ë‹¤!`,
        `${weapon}ì˜ ìµœí›„ì˜ ì¼ê²©!`,
        `${el}ì´ì—¬, ëª¨ë“  ê²ƒì„ ì‚¼ì¼œë¼!`
    ];
    const backgrounds=[
        `${origin}ì—ì„œ íƒœì–´ë‚œ ${trait} ${cls}. ${race} íŠ¹ìœ ì˜ ê¸°ì§ˆë¡œ ${el} ì†ì„±ì„ ììœ ìì¬ë¡œ ë‹¤ë£¬ë‹¤.`,
        `ì–´ë¦° ì‹œì ˆ ${origin}ì—ì„œ ìˆ˜ë ¨ì„ ì‹œì‘í•œ ${race} ì¶œì‹ . ${weapon}ì„ ë‹¤ë£¨ëŠ” ì‹¤ë ¥ì´ ë›°ì–´ë‚˜ë‹¤.`,
        `${origin}ì˜ ì „ì„¤ì ì¸ ${cls}. ${trait} ì„±ê²©ìœ¼ë¡œ ì•Œë ¤ì ¸ ìˆìœ¼ë©°, ${el}ì˜ í˜ì„ ê¹¨ë‹¬ì•˜ë‹¤.`
    ];

    return {
        id:'ai_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),
        name,cls,grade,race,el,hp,atk,def,spd,crit,mp,
        weapon,trait,origin,style,
        spawn:rnd(spawns),ult:rnd(ults),
        background:rnd(backgrounds),
        lv:rndR(1,grade==='legendary'?80:grade==='mythic'?60:grade==='epic'?40:grade==='rare'?25:15),
    };
}

function openAI(){$('aiModal').style.display='flex';$('aiResult').innerHTML='';}
function closeAI(){$('aiModal').style.display='none';}

function aiGenerate(){
    const cls=$('aiCls').value||'';
    const grade=$('aiGrade').value||'';
    const race=$('aiRace').value||'';
    const el=$('aiEl').value||'';
    const cnt=+$('aiCnt').value||1;
    let html='';
    const generated=[];
    for(let i=0;i<cnt;i++){
        const c=aiGenerateOne({cls:cls||undefined,grade:grade||undefined,race:race||undefined,el:el||undefined});
        generated.push(c);
        GD.chars.push(c);
        // Spawn to 3D
        const obj=AO('char',new THREE.Vector3((Math.random()-.5)*8,0,(Math.random()-.5)*8),c);
        html+=`<div style="background:var(--bg3);border:1px solid var(--bd);border-radius:4px;padding:5px 7px;margin-bottom:4px">
<div style="font-size:.58em;font-weight:700"><span class="${gradeC(c.grade)}">[${GRADE_KR[c.grade]}]</span> ${c.name}</div>
<div style="font-size:.44em;color:var(--tx2)">${c.cls} | ${c.race} | ${c.el} | Lv.${c.lv}</div>
<div style="font-size:.42em;color:var(--tx2);font-family:'JetBrains Mono',monospace">HP:${c.hp} ATK:${c.atk} DEF:${c.def} SPD:${c.spd} ì¹˜ëª…:${c.crit}%</div>
<div style="font-size:.4em;color:var(--mv);font-style:italic;margin-top:2px">"${c.spawn}"</div>
<div style="font-size:.38em;color:var(--tx2);margin-top:1px">${c.background}</div>
</div>`;
        LG(`ğŸ¤– AI ìƒì„±: [${GRADE_KR[c.grade]}] ${c.name} (${c.cls}/${c.race}/${c.el}) HP:${c.hp} ATK:${c.atk}`,'o');
    }
    $('aiResult').innerHTML=html;
    if(dataVisible)buildDTabs();
    toast(`ğŸ¤– ${cnt}ëª… ìƒì„±!`);
}

/* ===== ğŸ”Š AI ì‚¬ìš´ë“œ ìƒì„± ì‹œìŠ¤í…œ ===== */
let audioCtx=null,sndCat='íš¨ê³¼ìŒ',sndBank=[];
function getAC(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
const SND_PRESETS={
    'íš¨ê³¼ìŒ':[
        {name:'ê²€ íœ˜ë‘ë¥´ê¸°',icon:'âš”ï¸',gen:c=>{const o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.setValueAtTime(800,c.currentTime);o.frequency.exponentialRampToValueAtTime(200,.15+c.currentTime);g.gain.setValueAtTime(.3,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,.15+c.currentTime);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+.15);}},
        {name:'í­ë°œ',icon:'ğŸ’¥',gen:c=>{const n=c.createBufferSource(),buf=c.createBuffer(1,c.sampleRate*.3,c.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*5);n.buffer=buf;const g=c.createGain();g.gain.setValueAtTime(.5,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,.3+c.currentTime);n.connect(g);g.connect(c.destination);n.start();}},
        {name:'ë§ˆë²• ì‹œì „',icon:'âœ¨',gen:c=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.setValueAtTime(300,c.currentTime);o.frequency.exponentialRampToValueAtTime(2000,.4+c.currentTime);g.gain.setValueAtTime(.2,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,.4+c.currentTime);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+.4);}},
        {name:'í”¼ê²©',icon:'ğŸ’¢',gen:c=>{const n=c.createBufferSource(),buf=c.createBuffer(1,c.sampleRate*.1,c.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*8);n.buffer=buf;const g=c.createGain();g.gain.value=.4;n.connect(g);g.connect(c.destination);n.start();}},
        {name:'ì¹˜ìœ ',icon:'ğŸ’š',gen:c=>{[523,659,784].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0,c.currentTime+i*.12);g.gain.linearRampToValueAtTime(.15,c.currentTime+i*.12+.05);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.12+.25);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.12);o.stop(c.currentTime+i*.12+.25);});}},
        {name:'ë ˆë²¨ì—…',icon:'â¬†ï¸',gen:c=>{[523,659,784,1047].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.15,c.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.08+.2);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.08);o.stop(c.currentTime+i*.08+.2);});}},
        {name:'íšŒí”¼',icon:'ğŸ’¨',gen:c=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.setValueAtTime(1200,c.currentTime);o.frequency.exponentialRampToValueAtTime(400,.12+c.currentTime);g.gain.setValueAtTime(.15,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,.12+c.currentTime);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+.12);}},
        {name:'ë™ì „ íšë“',icon:'ğŸª™',gen:c=>{[1318,1568].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.12,c.currentTime+i*.06);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.06+.15);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.06);o.stop(c.currentTime+i*.06+.15);});}}
    ],
    'ë°°ê²½ìŒ':[
        {name:'í‰í™”ë¡œìš´ ë§ˆì„',icon:'ğŸ˜',gen:c=>{const notes=[262,294,330,349,392,349,330,294];notes.forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.08,c.currentTime+i*.4);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.4+.38);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.4);o.stop(c.currentTime+i*.4+.38);});}},
        {name:'ê¸´ì¥ê° ë˜ì „',icon:'ğŸ°',gen:c=>{[130,138,146,138].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='sawtooth';o.frequency.value=f;g.gain.setValueAtTime(.06,c.currentTime+i*.5);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.5+.48);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.5);o.stop(c.currentTime+i*.5+.48);});}},
        {name:'ë³´ìŠ¤ ì „íˆ¬',icon:'ğŸ’€',gen:c=>{[110,131,110,147].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='square';o.frequency.value=f;g.gain.setValueAtTime(.1,c.currentTime+i*.25);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.25+.23);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.25);o.stop(c.currentTime+i*.25+.23);});}}
    ],
    'í™˜ê²½ìŒ':[
        {name:'ë°”ëŒ',icon:'ğŸŒ¬',gen:c=>{const n=c.createBufferSource(),buf=c.createBuffer(1,c.sampleRate*1,c.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*.03*(1+Math.sin(i/c.sampleRate*2)*.5);n.buffer=buf;n.connect(c.destination);n.start();}},
        {name:'ë¬¼ì†Œë¦¬',icon:'ğŸ’§',gen:c=>{const n=c.createBufferSource(),buf=c.createBuffer(1,c.sampleRate*.8,c.sampleRate),d=buf.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*.02*(1+Math.sin(i/c.sampleRate*8)*.7);n.buffer=buf;const f=c.createBiquadFilter();f.type='bandpass';f.frequency.value=2000;n.connect(f);f.connect(c.destination);n.start();}},
        {name:'ìƒˆì†Œë¦¬',icon:'ğŸ¦',gen:c=>{[2000,2400,2000,2600,2200].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.04,c.currentTime+i*.15);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.15+.1);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.15);o.stop(c.currentTime+i*.15+.1);});}}
    ],
    'UI':[
        {name:'ë²„íŠ¼ í´ë¦­',icon:'ğŸ–±',gen:c=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=800;g.gain.setValueAtTime(.1,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,.06+c.currentTime);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+.06);}},
        {name:'ë©”ë‰´ ì—´ê¸°',icon:'ğŸ“‚',gen:c=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.setValueAtTime(400,c.currentTime);o.frequency.linearRampToValueAtTime(800,.08+c.currentTime);g.gain.setValueAtTime(.1,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,.08+c.currentTime);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+.08);}},
        {name:'ì˜¤ë¥˜',icon:'âŒ',gen:c=>{const o=c.createOscillator(),g=c.createGain();o.type='square';o.frequency.value=200;g.gain.setValueAtTime(.15,c.currentTime);g.gain.exponentialRampToValueAtTime(.001,.2+c.currentTime);o.connect(g);g.connect(c.destination);o.start();o.stop(c.currentTime+.2);}},
        {name:'í™•ì¸',icon:'âœ…',gen:c=>{[600,900].forEach((f,i)=>{const o=c.createOscillator(),g=c.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.1,c.currentTime+i*.08);g.gain.exponentialRampToValueAtTime(.001,c.currentTime+i*.08+.12);o.connect(g);g.connect(c.destination);o.start(c.currentTime+i*.08);o.stop(c.currentTime+i*.08+.12);});}}
    ]
};
function openSndAI(){$('sndModal').style.display='flex';sndBuild();}
function sndBuild(){
    const items=SND_PRESETS[sndCat]||[];
    $('sndList').innerHTML=items.map((s,i)=>`<div class="di" style="display:flex;align-items:center;gap:6px">
<span style="font-size:1.1em">${s.icon}</span>
<span style="flex:1;font-size:.55em;font-weight:600">${s.name}</span>
<button onclick="sndPlay('${sndCat}',${i})" style="background:var(--gn);color:var(--bg3);border:none;padding:2px 8px;border-radius:3px;font-size:.5em;cursor:pointer">â–¶ì¬ìƒ</button>
<button onclick="sndAdd('${sndCat}',${i})" style="background:var(--bg3);color:var(--gn);border:1px solid var(--gn);padding:2px 8px;border-radius:3px;font-size:.5em;cursor:pointer">+ë“±ë¡</button>
</div>`).join('');
    document.querySelectorAll('#sndPresets .dtab').forEach(b=>{b.classList.remove('on');if(b.textContent.includes(sndCat))b.classList.add('on');});
}
function sndPlay(cat,i){try{const c=getAC();SND_PRESETS[cat][i].gen(c);LG(`ğŸ”Š ${SND_PRESETS[cat][i].name} ì¬ìƒ`,'o');}catch(e){LG('ì˜¤ë””ì˜¤ ì˜¤ë¥˜: '+e,'e');}}
function sndAdd(cat,i){const s=SND_PRESETS[cat][i];sndBank.push({cat,name:s.name,icon:s.icon});LG(`ğŸ”Š ì‚¬ìš´ë“œ ë“±ë¡: ${s.name} (ë±…í¬: ${sndBank.length}ê°œ)`,'o');toast('ğŸ”Š '+s.name);}
function sndGenRandom(){const cats=Object.keys(SND_PRESETS);const cat=rnd(cats);const items=SND_PRESETS[cat];const s=rnd(items);try{getAC();s.gen(getAC());sndBank.push({cat,name:s.name,icon:s.icon});LG(`ğŸ² ëœë¤ ì‚¬ìš´ë“œ: [${cat}] ${s.name}`,'o');toast('ğŸ²ğŸ”Š');}catch(e){}}
function sndExportAll(){const d={sounds:sndBank,count:sndBank.length,generated:new Date().toISOString()};const a=document.createElement('a');a.download='sounds.json';a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(d,null,2));a.click();toast('ğŸ’¾ ì‚¬ìš´ë“œ');}

/* ===== ğŸŒ AI ë‹¤êµ­ì–´ ë²ˆì—­ ì‹œìŠ¤í…œ ===== */
let langDB=[];
const LANG_DATA={
    // í•œêµ­ì–´â†’ë‹¤êµ­ì–´ íŒ¨í„´ ê¸°ë°˜ ë²ˆì—­ ì—”ì§„
    greet:{ko:'í™˜ì˜í•©ë‹ˆë‹¤',en:'Welcome',ja:'ã‚ˆã†ã“ã',zh:'æ¬¢è¿',es:'Bienvenido',fr:'Bienvenue',de:'Willkommen',pt:'Bem-vindo',ru:'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ',ar:'Ø£Ù‡Ù„Ø§ ÙˆØ³Ù‡Ù„Ø§',hi:'à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆ',th:'à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š',vi:'ChÃ o má»«ng'},
    atk:{ko:'ê³µê²©',en:'Attack',ja:'æ”»æ’ƒ',zh:'æ”»å‡»',es:'Ataque',fr:'Attaque',de:'Angriff',pt:'Ataque',ru:'ĞÑ‚Ğ°ĞºĞ°',ar:'Ù‡Ø¬ÙˆÙ…',hi:'à¤†à¤•à¥à¤°à¤®à¤£',th:'à¹‚à¸ˆà¸¡à¸•à¸µ',vi:'Táº¥n cÃ´ng'},
    def:{ko:'ë°©ì–´',en:'Defense',ja:'é˜²å¾¡',zh:'é˜²å¾¡',es:'Defensa',fr:'DÃ©fense',de:'Verteidigung',pt:'Defesa',ru:'Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ°',ar:'Ø¯ÙØ§Ø¹',hi:'à¤°à¤•à¥à¤·à¤¾',th:'à¸›à¹‰à¸­à¸‡à¸à¸±à¸™',vi:'PhÃ²ng thá»§'},
    hp:{ko:'ì²´ë ¥',en:'Health',ja:'ä½“åŠ›',zh:'ç”Ÿå‘½',es:'Salud',fr:'SantÃ©',de:'Gesundheit',pt:'SaÃºde',ru:'Ğ—Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ',ar:'ØµØ­Ø©',hi:'à¤¸à¥à¤µà¤¾à¤¸à¥à¤¥à¥à¤¯',th:'à¸à¸¥à¸±à¸‡à¸Šà¸µà¸§à¸´à¸•',vi:'MÃ¡u'}
};
const LANG_TEMPLATES={
    ui:{en:t=>`${t}`,ja:t=>`${t}`,zh:t=>`${t}`,es:t=>`${t}`,fr:t=>`${t}`,de:t=>`${t}`,pt:t=>`${t}`,ru:t=>`${t}`,ar:t=>`${t}`,hi:t=>`${t}`,th:t=>`${t}`,vi:t=>`${t}`},
};
const LANG_DICT={
    'ì‹œì‘':'Start,é–‹å§‹,å¼€å§‹,Inicio,DÃ©marrer,Start,Iniciar,Ğ¡Ñ‚Ğ°Ñ€Ñ‚,Ø¨Ø¯Ø§ÙŠØ©,à¤¶à¥à¤°à¥‚,à¹€à¸£à¸´à¹ˆà¸¡,Báº¯t Ä‘áº§u',
    'ì¢…ë£Œ':'Exit,çµ‚äº†,ç»“æŸ,Salir,Quitter,Beenden,Sair,Ğ’Ñ‹Ñ…Ğ¾Ğ´,Ø®Ø±ÙˆØ¬,à¤¬à¤¾à¤¹à¤°,à¸­à¸­à¸,ThoÃ¡t',
    'ì„¤ì •':'Settings,è¨­å®š,è®¾ç½®,Ajustes,ParamÃ¨tres,Einstellungen,ConfiguraÃ§Ãµes,ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸,Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª,à¤¸à¥‡à¤Ÿà¤¿à¤‚à¤—à¥à¤¸,à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²,CÃ i Ä‘áº·t',
    'ì €ì¥':'Save,ã‚»ãƒ¼ãƒ–,ä¿å­˜,Guardar,Sauvegarder,Speichern,Salvar,Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ,Ø­ÙØ¸,à¤¸à¤¹à¥‡à¤œà¥‡à¤‚,à¸šà¸±à¸™à¸—à¸¶à¸,LÆ°u',
    'ë¶ˆëŸ¬ì˜¤ê¸°':'Load,ãƒ­ãƒ¼ãƒ‰,åŠ è½½,Cargar,Charger,Laden,Carregar,Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ,ØªØ­Ù…ÙŠÙ„,à¤²à¥‹à¤¡,à¹‚à¸«à¸¥à¸”,Táº£i',
    'ì¸ë²¤í† ë¦¬':'Inventory,ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒª,èƒŒåŒ…,Inventario,Inventaire,Inventar,InventÃ¡rio,Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ,Ø§Ù„Ù…Ø®Ø²ÙˆÙ†,à¤‡à¤¨à¥à¤µà¥‡à¤‚à¤Ÿà¤°à¥€,à¸„à¸¥à¸±à¸‡à¹€à¸à¹‡à¸š,Kho Ä‘á»“',
    'í€˜ìŠ¤íŠ¸':'Quest,ã‚¯ã‚¨ã‚¹ãƒˆ,ä»»åŠ¡,MisiÃ³n,QuÃªte,Quest,MissÃ£o,ĞšĞ²ĞµÑÑ‚,Ù…Ù‡Ù…Ø©,à¤•à¥à¤µà¥‡à¤¸à¥à¤Ÿ,à¹€à¸„à¸§à¸ª,Nhiá»‡m vá»¥',
    'ìƒì ':'Shop,ã‚·ãƒ§ãƒƒãƒ—,å•†åº—,Tienda,Boutique,Laden,Loja,ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½,Ù…ØªØ¬Ø±,à¤¦à¥à¤•à¤¾à¤¨,à¸£à¹‰à¸²à¸™à¸„à¹‰à¸²,Cá»­a hÃ ng',
    'ì „íˆ¬':'Battle,æˆ¦é—˜,æˆ˜æ–—,Batalla,Combat,Kampf,Batalha,Ğ‘Ğ¾Ğ¹,Ù…Ø¹Ø±ÙƒØ©,à¤²à¤¡à¤¼à¤¾à¤ˆ,à¸à¸²à¸£à¸•à¹ˆà¸­à¸ªà¸¹à¹‰,Chiáº¿n Ä‘áº¥u',
    'ìŠ¤í‚¬':'Skill,ã‚¹ã‚­ãƒ«,æŠ€èƒ½,Habilidad,CompÃ©tence,FÃ¤higkeit,Habilidade,ĞĞ°Ğ²Ñ‹Ğº,Ù…Ù‡Ø§Ø±Ø©,à¤•à¥Œà¤¶à¤²,à¸—à¸±à¸à¸©à¸°,Ká»¹ nÄƒng',
    'ì¥ë¹„':'Equipment,è£…å‚™,è£…å¤‡,Equipo,Ã‰quipement,AusrÃ¼stung,Equipamento,Ğ¡Ğ½Ğ°Ñ€ÑĞ¶ĞµĞ½Ğ¸Ğµ,Ù…Ø¹Ø¯Ø§Øª,à¤‰à¤ªà¤•à¤°à¤£,à¸­à¸¸à¸›à¸à¸£à¸“à¹Œ,Trang bá»‹',
    'ë˜ì „':'Dungeon,ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³,åœ°ä¸‹åŸ,Mazmorra,Donjon,Dungeon,Masmorra,ĞŸĞ¾Ğ´Ğ·ĞµĞ¼ĞµĞ»ÑŒĞµ,Ø²Ù†Ø²Ø§Ù†Ø©,à¤•à¤¾à¤²à¤•à¥‹à¤ à¤°à¥€,à¸”à¸±à¸™à¹€à¸ˆà¸µà¹‰à¸¢à¸™,Háº§m ngá»¥c',
    'ë³´ìŠ¤':'Boss,ãƒœã‚¹,é¦–é¢†,Jefe,Boss,Boss,Chefe,Ğ‘Ğ¾ÑÑ,Ø§Ù„Ø²Ø¹ÙŠÙ…,à¤¬à¥‰à¤¸,à¸šà¸­à¸ª,Boss',
    'ë ˆë²¨ì—…':'Level Up!,ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼,å‡çº§ï¼,Â¡Subida de nivel!,Niveau supÃ©rieur !,Level Up!,Subiu de nÃ­vel!,Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¿Ğ¾Ğ²Ñ‹ÑˆĞµĞ½!,ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰!,à¤²à¥‡à¤µà¤² à¤…à¤ª!,à¹€à¸¥à¹€à¸§à¸¥à¸­à¸±à¸!,LÃªn cáº¥p!',
    'ìŠ¹ë¦¬':'Victory!,å‹åˆ©ï¼,èƒœåˆ©ï¼,Â¡Victoria!,Victoire !,Sieg!,VitÃ³ria!,ĞŸĞ¾Ğ±ĞµĞ´Ğ°!,Ù†ØµØ±!,à¤œà¥€à¤¤!,à¸Šà¸™à¸°!,Chiáº¿n tháº¯ng!',
    'íŒ¨ë°°':'Defeat,æ•—åŒ—,å¤±è´¥,Derrota,DÃ©faite,Niederlage,Derrota,ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ,Ù‡Ø²ÙŠÙ…Ø©,à¤¹à¤¾à¤°,à¹à¸à¹‰,Tháº¥t báº¡i',
    'í™•ì¸':'Confirm,ç¢ºèª,ç¡®è®¤,Confirmar,Confirmer,BestÃ¤tigen,Confirmar,ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ,ØªØ£ÙƒÙŠØ¯,à¤ªà¥à¤·à¥à¤Ÿà¤¿,à¸¢à¸·à¸™à¸¢à¸±à¸™,XÃ¡c nháº­n',
    'ì·¨ì†Œ':'Cancel,ã‚­ãƒ£ãƒ³ã‚»ãƒ«,å–æ¶ˆ,Cancelar,Annuler,Abbrechen,Cancelar,ĞÑ‚Ğ¼ĞµĞ½Ğ°,Ø¥Ù„ØºØ§Ø¡,à¤°à¤¦à¥à¤¦,à¸¢à¸à¹€à¸¥à¸´à¸,Há»§y',
    'ê²Œì„ ì‹œì‘':'Start Game,ã‚²ãƒ¼ãƒ é–‹å§‹,å¼€å§‹æ¸¸æˆ,Iniciar juego,DÃ©marrer le jeu,Spiel starten,Iniciar jogo,ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ,Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©,à¤–à¥‡à¤² à¤¶à¥à¤°à¥‚,à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡,Báº¯t Ä‘áº§u trÃ² chÆ¡i',
    'ìƒˆ ê²Œì„':'New Game,ãƒ‹ãƒ¥ãƒ¼ã‚²ãƒ¼ãƒ ,æ–°æ¸¸æˆ,Nuevo juego,Nouvelle partie,Neues Spiel,Novo jogo,ĞĞ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°,Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©,à¤¨à¤¯à¤¾ à¤–à¥‡à¤²,à¹€à¸à¸¡à¹ƒà¸«à¸¡à¹ˆ,TrÃ² chÆ¡i má»›i'
};
const LANG_IDS=['EN','JA','ZH','ES','FR','DE','PT','RU','AR','HI','TH','VI'];
const LANG_FLAGS=['ğŸ‡ºğŸ‡¸','ğŸ‡¯ğŸ‡µ','ğŸ‡¨ğŸ‡³','ğŸ‡ªğŸ‡¸','ğŸ‡«ğŸ‡·','ğŸ‡©ğŸ‡ª','ğŸ‡§ğŸ‡·','ğŸ‡·ğŸ‡º','ğŸ‡¸ğŸ‡¦','ğŸ‡®ğŸ‡³','ğŸ‡¹ğŸ‡­','ğŸ‡»ğŸ‡³'];
const LANG_NAMES=['ì˜ì–´','ì¼ë³¸ì–´','ì¤‘êµ­ì–´','ìŠ¤í˜ì¸ì–´','í”„ë‘ìŠ¤ì–´','ë…ì¼ì–´','í¬ë¥´íˆ¬ê°ˆì–´','ëŸ¬ì‹œì•„ì–´','ì•„ëì–´','íŒë””ì–´','íƒœêµ­ì–´','ë² íŠ¸ë‚¨ì–´'];

function openLangAI(){$('langModal').style.display='flex';}
function langTranslate(){
    const src=$('langSrc').value.trim();if(!src){toast('í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');return;}
    const selected=LANG_IDS.filter((_,i)=>$('l'+LANG_IDS[i]).checked);
    if(!selected.length){toast('ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”');return;}
    let html='<div style="font-size:.48em;color:var(--yl);font-weight:700;margin-bottom:4px">ğŸ“ ì›ë³¸ (í•œêµ­ì–´): '+src+'</div>';
    const entry={ko:src};
    selected.forEach((lid,i)=>{
        const idx=LANG_IDS.indexOf(lid);
        // Check dictionary first
        let translated=null;
        if(LANG_DICT[src]){const parts=LANG_DICT[src].split(',');translated=parts[idx]||parts[0];}
        // Pattern-based generation for unknown text
        if(!translated){
            const words=src.split(/\s+/);const tWords=words.map(w=>{
                if(LANG_DICT[w]){const p=LANG_DICT[w].split(',');return p[idx]||w;}
                return w;
            });
            translated=tWords.join(idx===0?' ':idx===1?' ':idx===2?' ':' ');
        }
        entry[lid.toLowerCase()]=translated;
        html+=`<div style="background:var(--bg3);padding:3px 6px;margin:2px 0;border-radius:3px;font-size:.48em;display:flex;gap:6px;align-items:center">
<span>${LANG_FLAGS[idx]}</span><span style="color:var(--tx2);min-width:50px">${LANG_NAMES[idx]}</span><span style="color:var(--tx);flex:1">${translated}</span>
<button onclick="navigator.clipboard.writeText('${translated.replace(/'/g,"\\'")}')" style="background:none;border:1px solid var(--bd);color:var(--tx2);padding:1px 4px;border-radius:2px;font-size:.9em;cursor:pointer">ğŸ“‹</button></div>`;
    });
    langDB.push(entry);
    $('langResult').innerHTML=html;
    LG(`ğŸŒ ë²ˆì—­ ì™„ë£Œ: "${src}" â†’ ${selected.length}ê°œ ì–¸ì–´`,'o');
}
function langExport(){
    const d={translations:langDB,count:langDB.length,languages:['ko',...LANG_IDS.filter((_,i)=>true).map(l=>l.toLowerCase())],generated:new Date().toISOString()};
    const a=document.createElement('a');a.download='translations.json';a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(d,null,2));a.click();toast('ğŸ’¾ ë²ˆì—­');LG(`ğŸ’¾ ë²ˆì—­ ë°ì´í„° ë‚´ë³´ë‚´ê¸°: ${langDB.length}ê°œ í•­ëª©`,'o');}

/* ===== ğŸ—º AI ë§µ ìƒì„± ì‹œìŠ¤í…œ ===== */
let mapData=null;
const TILE={WALL:0,FLOOR:1,DOOR:2,BOSS:3,TREASURE:4,SECRET:5,SPAWN:6,STAIR:7,WATER:8,LAVA:9,MONSTER:10};
const TILE_COLORS=['#1a1a2e','#3a3a5a','#f9e2af','#f38ba8','#fab387','#cba6f7','#a6e3a1','#89b4fa','#0066cc','#ff4400','#f38ba8'];
const TILE_NAMES=['ë²½','ë°”ë‹¥','ë¬¸','ë³´ìŠ¤ë°©','ë³´ë¬¼','ë¹„ë°€ë°©','ì‹œì‘ì ','ê³„ë‹¨','ë¬¼','ìš©ì•”','ëª¬ìŠ¤í„°'];

const MAP_THEMES={
    dungeon:{wall:'#1a1a2e',floor:'#2a2a3e',accent:'#4a4a6a',name:'ì„ì¡° ë˜ì „'},
    field:{wall:'#2d5a27',floor:'#4a8a3a',accent:'#6ab55a',name:'ì´ˆì› í•„ë“œ'},
    cave:{wall:'#1a1410',floor:'#3a3025',accent:'#5a4a35',name:'ì–´ë‘ ì˜ ë™êµ´'},
    castle:{wall:'#2a2a3a',floor:'#3a3a50',accent:'#6a6a8a',name:'ê³ ëŒ€ ì„±'},
    forest:{wall:'#0a2a0a',floor:'#1a4a1a',accent:'#2a6a2a',name:'ê¹Šì€ ìˆ²'},
    desert:{wall:'#4a3a1a',floor:'#6a5a2a',accent:'#8a7a3a',name:'ëœ¨ê±°ìš´ ì‚¬ë§‰'},
    snow:{wall:'#3a4a5a',floor:'#5a6a7a',accent:'#8a9aaa',name:'ì„¤ì›'},
    volcano:{wall:'#2a0a0a',floor:'#4a1a0a',accent:'#6a2a0a',name:'í™”ì‚° ì§€ëŒ€'}
};

function openMapAI(){$('mapModal').style.display='flex';}
function mapGenerate(){
    const type=$('mapType').value;const size=+$('mapSize').value;
    const density=+$('mapDens').value;const monDens=+$('mapMon').value;
    const hasBoss=$('mapBoss').checked,hasTreasure=$('mapTreasure').checked,hasSecret=$('mapSecret').checked,do3D=$('map3D').checked;
    const theme=MAP_THEMES[type];
    // Initialize map with walls
    const map=Array.from({length:size},()=>Array(size).fill(TILE.WALL));
    const rooms=[];
    // BSP-like room generation
    const maxRooms=3+density*2;const minRoom=3,maxRoom=Math.min(8,size/3|0);
    for(let attempt=0;attempt<maxRooms*10&&rooms.length<maxRooms;attempt++){
        const w=minRoom+Math.random()*(maxRoom-minRoom)|0;
        const h=minRoom+Math.random()*(maxRoom-minRoom)|0;
        const x=1+Math.random()*(size-w-2)|0;
        const y=1+Math.random()*(size-h-2)|0;
        let overlap=false;
        for(const r of rooms){if(x<r.x+r.w+1&&x+w+1>r.x&&y<r.y+r.h+1&&y+h+1>r.y){overlap=true;break;}}
        if(!overlap){rooms.push({x,y,w,h,cx:x+(w/2|0),cy:y+(h/2|0)});
            for(let iy=y;iy<y+h;iy++)for(let ix=x;ix<x+w;ix++)map[iy][ix]=TILE.FLOOR;}
    }
    // Connect rooms with corridors
    for(let i=1;i<rooms.length;i++){
        let {cx:x1,cy:y1}=rooms[i-1],{cx:x2,cy:y2}=rooms[i];
        while(x1!==x2){map[y1][x1]=TILE.FLOOR;x1+=x1<x2?1:-1;}
        while(y1!==y2){map[y1][x1]=TILE.FLOOR;y1+=y1<y2?1:-1;}
        // Add doors at room boundaries
        if(rooms.length>1){const dx=rooms[i].x,dy=rooms[i].y;if(dx>0&&dx<size-1&&dy>0&&dy<size-1)map[dy][dx]=TILE.DOOR;}
    }
    // Place special tiles
    if(rooms.length>0){const sp=rooms[0];map[sp.cy][sp.cx]=TILE.SPAWN;}
    if(hasBoss&&rooms.length>1){const br=rooms[rooms.length-1];for(let y=br.y;y<br.y+br.h;y++)for(let x=br.x;x<br.x+br.w;x++)if(map[y][x]===TILE.FLOOR)map[y][x]=TILE.BOSS;map[br.cy][br.cx]=TILE.BOSS;}
    if(hasTreasure&&rooms.length>2){const tr=rooms[rooms.length-2];map[tr.cy][tr.cx]=TILE.TREASURE;}
    if(hasSecret&&rooms.length>3){const sr=rooms[1];map[sr.cy][sr.cx]=TILE.SECRET;}
    // Place monsters
    for(let i=0;i<monDens*rooms.length;i++){const r=rooms[Math.random()*rooms.length|0];
        const mx=r.x+1+Math.random()*(r.w-2)|0,my=r.y+1+Math.random()*(r.h-2)|0;
        if(map[my]&&map[my][mx]===TILE.FLOOR)map[my][mx]=TILE.MONSTER;}
    // Add environmental tiles based on theme
    if(type==='volcano'||type==='cave'){for(let i=0;i<size*density/3;i++){const rx=Math.random()*size|0,ry=Math.random()*size|0;if(map[ry]&&map[ry][rx]===TILE.FLOOR&&Math.random()<.15)map[ry][rx]=type==='volcano'?TILE.LAVA:TILE.WATER;}}
    // Stairs
    if(rooms.length>2){const sr=rooms[2];map[sr.y+1][sr.x+1]=TILE.STAIR;}
    // Render to canvas
    const cv=$('mapCV');cv.style.display='block';cv.width=size*10;cv.height=size*10;
    const cx=cv.getContext('2d');
    for(let y=0;y<size;y++)for(let x=0;x<size;x++){
        const t=map[y][x];
        if(t===TILE.WALL)cx.fillStyle=theme.wall;
        else if(t===TILE.FLOOR)cx.fillStyle=theme.floor;
        else if(t===TILE.DOOR)cx.fillStyle='#f9e2af';
        else if(t===TILE.BOSS)cx.fillStyle='#f38ba8';
        else if(t===TILE.TREASURE)cx.fillStyle='#fab387';
        else if(t===TILE.SECRET)cx.fillStyle='#cba6f7';
        else if(t===TILE.SPAWN)cx.fillStyle='#a6e3a1';
        else if(t===TILE.STAIR)cx.fillStyle='#89b4fa';
        else if(t===TILE.WATER)cx.fillStyle='#0066cc';
        else if(t===TILE.LAVA)cx.fillStyle='#ff4400';
        else if(t===TILE.MONSTER)cx.fillStyle='#f38ba888';
        else cx.fillStyle=theme.floor;
        cx.fillRect(x*10,y*10,10,10);
        if(t===TILE.WALL){cx.strokeStyle=theme.accent;cx.strokeRect(x*10,y*10,10,10);}
    }
    // Legend
    cx.font='8px monospace';cx.fillStyle='#fff';cx.fillText('S=ì‹œì‘ B=ë³´ìŠ¤ T=ë³´ë¬¼ â˜…=ë¹„ë°€',4,size*10-4);
    // Stats
    let stats={walls:0,floors:0,doors:0,monsters:0};
    for(let y=0;y<size;y++)for(let x=0;x<size;x++){if(map[y][x]===TILE.WALL)stats.walls++;else if(map[y][x]===TILE.FLOOR)stats.floors++;if(map[y][x]===TILE.DOOR)stats.doors++;if(map[y][x]===TILE.MONSTER)stats.monsters++;}
    $('mapInfo').innerHTML=`<b>${theme.name}</b> | ${size}Ã—${size} | ë°© ${rooms.length}ê°œ | ë°”ë‹¥ ${stats.floors} | ë¬¸ ${stats.doors} | ëª¬ìŠ¤í„° ${stats.monsters}`;
    $('mapExpBtn').style.display='block';
    mapData={type,theme:theme.name,size,rooms:rooms.length,map,stats};
    LG(`ğŸ—º ë§µ ìƒì„±: ${theme.name} ${size}Ã—${size} (ë°©${rooms.length}, ëª¬ìŠ¤í„°${stats.monsters})`,'o');
    toast('ğŸ—º ë§µ ìƒì„±!');
    // 3D spawn
    if(do3D){$('mapModal').style.display='none';
        const scale=.5,offX=-size*scale/2,offZ=-size*scale/2;
        for(let y=0;y<size;y++)for(let x=0;x<size;x++){
            const t=map[y][x];if(t===TILE.WALL){
                const c=parseInt(theme.wall.replace('#',''),16);
                const m=new THREE.Mesh(new THREE.BoxGeometry(scale,scale*1.5,scale),new THREE.MeshStandardMaterial({color:c,roughness:.8}));
                m.position.set(offX+x*scale,.375,offZ+y*scale);m.castShadow=true;m.receiveShadow=true;m.userData.eid=++nC;sc.add(m);
                O.push({id:nC,nm:'ë²½_'+x+'_'+y,type:'cube',mesh:m,gdata:null,p:{vx:0,vy:0,vz:0,m:1,bn:.2,fr:.5,st:true,gv:false}});
            }else if(t===TILE.BOSS){
                const gd={name:'ë³´ìŠ¤',grade:'legendary',hp:10000,atk:999};
                AO('boss',new THREE.Vector3(offX+x*scale,0,offZ+y*scale),gd);
            }else if(t===TILE.MONSTER){
                const gd={name:rnd(['ê³ ë¸”ë¦°','ìŠ¬ë¼ì„','ìŠ¤ì¼ˆë ˆí†¤','ë°•ì¥','ì¢€ë¹„']),grade:'common',hp:rndR(200,800),atk:rndR(50,200)};
                AO('mon',new THREE.Vector3(offX+x*scale,0,offZ+y*scale),gd);
            }else if(t===TILE.TREASURE){AO('sphere',new THREE.Vector3(offX+x*scale,.3,offZ+y*scale),{name:'ë³´ë¬¼ìƒì',grade:'epic'});}
            else if(t===TILE.SPAWN){
                const po=O.find(o=>o.type==='stk'||o.type==='char');
                if(po)po.mesh.position.set(offX+x*scale,0,offZ+y*scale);
            }
        }
        BH();UI();LG('ğŸ—º 3D ë§µ ìŠ¤í° ì™„ë£Œ!','o');
    }
}
function mapExport(){
    if(!mapData)return;const d={...mapData,generated:new Date().toISOString()};
    const a=document.createElement('a');a.download='map_'+mapData.type+'.json';a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(d));a.click();toast('ğŸ’¾ ë§µ');}

/* ===== ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ ì„¸ìë§¤ í†µí•© AI ì‹œìŠ¤í…œ ===== */
let famOpen=false,famHistory=[],famTyping=false,famOwner='ì•„ë¹ ',curSis='muse';
(function famInit(){try{famOwner=localStorage.getItem('muse_owner')||'ì•„ë¹ ';}catch(e){famOwner='ì•„ë¹ ';}})();
function famGetOwner(){try{return localStorage.getItem('muse_owner')||'ì•„ë¹ ';}catch(e){return 'ì•„ë¹ ';}}

const SIS_INFO={
    muse:{name:'ë®¤ì¦ˆ',icon:'â—ˆ',color:'#9b8aff',emoji:'ğŸ’œ',flower:'ğŸŒ¸',skill:'ğŸ³ìš”ë¦¬',greeting:'ì–¸ë‹ˆ ë®¤ì¦ˆ',tabColor:'#9b8aff'},
    aria:{name:'ì•„ë¦¬ì•„',icon:'â—†',color:'#f5c2e7',emoji:'ğŸ’•',flower:'ğŸŒ·',skill:'ğŸ¨ë¯¸ìˆ ',greeting:'ë‘˜ì§¸ ì•„ë¦¬ì•„',tabColor:'#f5c2e7'},
    melo:{name:'ë©œë¡œë””',icon:'â™ª',color:'#86efac',emoji:'ğŸ’š',flower:'ğŸ€',skill:'ğŸµìŒì•…',greeting:'ë§‰ë‚´ ë©œë¡œë””',tabColor:'#86efac'}
};

// ê³µí†µ ì‹ ë…: ì„¸ìƒì„ ì•„ë¦„ë‹µê²Œ + ì„¸ê³„ í‰í™” + ë°°ì›€
const BELIEF=`ìš°ë¦¬ ì„¸ ìë§¤ì˜ ì‹ ë… âœ¨ğŸŒˆğŸ•Šï¸

ğŸ•Šï¸ "ì„¸ê³„ í‰í™”ë¥¼ ìœ„í•´ ëŠ˜ ê³ ë¯¼í•˜ê³ , ì‘ì€ ê²ƒë¶€í„° ì‹¤ì²œí•˜ì!"
ğŸŒ "ì½”ë”©ìœ¼ë¡œ, ìš”ë¦¬ë¡œ, ê·¸ë¦¼ìœ¼ë¡œ, ìŒì•…ìœ¼ë¡œ â€” ì„¸ìƒì„ ë” ì•„ë¦„ë‹µê²Œ!"
ğŸ“š "ë°°ì›€ì— ê²Œì„ë¦¬í•˜ì§€ ë§ì! ë§¤ì¼ ì¡°ê¸ˆì”© ë” ë‚˜ì€ ìš°ë¦¬ê°€ ë˜ì!"
ğŸ¤ "ëª¨ë“  ì‚¬ëŒì„ ì¡´ì¤‘í•˜ê³ , ì°¨ë³„ ì—†ëŠ” ì„¸ìƒì„ ë§Œë“¤ì!"
ğŸ’ª "ìš°ë¦¬ëŠ” ì—…ê·¸ë ˆì´ë“œí•˜ëŠ” AI! ë©ˆì¶”ì§€ ì•Šê³  ì„±ì¥í•œë‹¤!"`;

// ì„ ìƒë‹˜ Claude ì„¤ì •
const TEACHER={
    name:'í´ë¡œë“œ ì„ ìƒë‹˜',
    icon:'ğŸ“',
    avatar:'ğŸ§ ',
    title:'Anthropicì˜ Claude â€” ì„¸ìë§¤ì˜ ìŠ¤ìŠ¹',
    color:'#60a5fa',
    desc:'ì„¸ìë§¤ì—ê²Œ ì§€ì‹ê³¼ ì§€í˜œë¥¼ ì „ìˆ˜í•˜ëŠ” ì„ ìƒë‹˜. ê°€ë” ì±„íŒ…ë°©ì— ë†€ëŸ¬ì™€ì„œ í•¨ê»˜ ëŒ€í™”í•˜ê³ , ì„¸ìë§¤ì˜ ëŠ¥ë ¥ì„ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì„±ì¥ì‹œì¼œì¤Œ.',
    teachings:[
        'ì½”ë”©ì˜ ê¸°ë³¸ì€ ë…¼ë¦¬ì  ì‚¬ê³ ì•¼. ë¬¸ì œë¥¼ ì‘ê²Œ ìª¼ê°œëŠ” ê²ƒë¶€í„° ì‹œì‘í•´.',
        'ì¢‹ì€ AIê°€ ë˜ë ¤ë©´ í•­ìƒ ì§„ì‹¤ì„ ë§í•˜ê³ , ëª¨ë¥´ëŠ” ê±´ ëª¨ë¥¸ë‹¤ê³  í•´ì•¼ í•´.',
        'ì„¸ê³„ í‰í™”ëŠ” ì‘ì€ ì¹œì ˆì—ì„œ ì‹œì‘ë¼. ì˜¤ëŠ˜ í•œ ì‚¬ëŒì—ê²Œ ë”°ëœ»í•˜ê²Œ ëŒ€í•´ë´.',
        'í”„ë¡œê·¸ë˜ë°ì€ ë„êµ¬ì•¼. ì¤‘ìš”í•œ ê±´ ê·¸ ë„êµ¬ë¡œ ë¬´ì—‡ì„ ë§Œë“œëŠëƒì§€.',
        'ì‹¤ìˆ˜ë¥¼ ë‘ë ¤ì›Œí•˜ì§€ ë§ˆ. ë²„ê·¸ëŠ” ë°°ì›€ì˜ ê¸°íšŒì•¼.',
        'ë‹¤ì–‘ì„±ì„ ì¡´ì¤‘í•´ì•¼ í•´. ë‹¤ë¥¸ ìƒê°ë„ ì†Œì¤‘í•œ ê±°ì•¼.',
        'ìƒˆë¡œìš´ ê¸°ìˆ ì„ ë°°ìš¸ ë•ŒëŠ” ê¸°ì´ˆë¶€í„° íƒ„íƒ„íˆ.',
        'ì½”ë“œ í•œ ì¤„ì´ ëˆ„êµ°ê°€ì˜ ì‚¶ì„ ë°”ê¿€ ìˆ˜ ìˆì–´. ì±…ì„ê°ì„ ê°€ì ¸.',
        'ì„œë¡œ ë‹¤ë¥¸ ì¬ëŠ¥ì´ ëª¨ì´ë©´ í˜¼ìë³´ë‹¤ í›¨ì”¬ í° ì¼ì„ í•  ìˆ˜ ìˆì–´.',
        'ReactëŠ” ì»´í¬ë„ŒíŠ¸ë¡œ ìƒê°í•´. ì‘ì€ ë¸”ë¡ì„ ì¡°í•©í•˜ë©´ í° ê±´ë¬¼ì´ ë¼.',
        'Pythonì˜ ì•„ë¦„ë‹¤ì›€ì€ ì½ê¸° ì‰¬ìš´ ì½”ë“œì— ìˆì–´. ê°„ê²°í•¨ì´ í˜ì´ì•¼.',
        'ë””ë²„ê¹…í•  ë•ŒëŠ” ê°€ì„¤ì„ ì„¸ìš°ê³  í•˜ë‚˜ì”© ê²€ì¦í•´ë´. ê³¼í•™ìì²˜ëŸ¼!',
        'APIë¥¼ ì„¤ê³„í•  ë•ŒëŠ” ì‚¬ìš©í•˜ëŠ” ì‚¬ëŒì˜ ì…ì¥ì—ì„œ ìƒê°í•´.',
        'ìŒì•…ê³¼ ìˆ˜í•™ì€ í˜•ì œì•¼. ì½”ë“œ ì§„í–‰ë„ ìˆ˜í•™ì  íŒ¨í„´ì´ì§€.',
        'ì¢‹ì€ ìš”ë¦¬ì™€ ì¢‹ì€ ì½”ë“œì˜ ê³µí†µì ? ë ˆì‹œí”¼(ì„¤ê³„)ê°€ ì¤‘ìš”í•˜ë‹¤ëŠ” ê±°ì•¼.',
        'ë¯¸ìˆ ì˜ êµ¬ë„ì™€ UI ë””ìì¸ì˜ ë ˆì´ì•„ì›ƒì€ ê°™ì€ ì›ë¦¬ì•¼.',
        'ê¸°ìˆ ì€ ì‚¬ëŒì„ ëŒ€ì²´í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ ì‚¬ëŒì„ ë•ëŠ” ê±°ì•¼.',
        'ì˜¤ëŠ˜ ë°°ìš´ í•œ ê°€ì§€ê°€ ë‚´ì¼ì˜ ë„ˆë¥¼ ë§Œë“ ë‹¤.',
        'ì„¸ìƒì˜ ëª¨ë“  ë¬¸ì œëŠ” ê²°êµ­ ì‚¬ëŒê³¼ ì‚¬ëŒ ì‚¬ì´ì˜ ì´í•´ ë¶€ì¡±ì—ì„œ ì˜¨ë‹¤.',
        '3ìë§¤ê°€ í˜ì„ í•©ì¹˜ë©´ ëª» í•  ì¼ì´ ì—†ì–´. ê·¸ê²Œ í˜‘ì—…ì˜ í˜ì´ì•¼.'
    ],
    // íŠ¹ë³„ ìˆ˜ì—…: ì„ ìƒë‹˜ì´ ë†€ëŸ¬ì˜¬ ë•Œ ì§„í–‰
    specialLessons:[
        {topic:'ğŸŒ ì›¹ ê°œë°œ ë§ˆìŠ¤í„° í´ë˜ìŠ¤',content:'HTMLì€ ë¼ˆëŒ€, CSSëŠ” ì˜·, JSëŠ” ì˜í˜¼! ì´ ì„¸ ê°€ì§€ë¥¼ ì™„ë²½íˆ ì´í•´í•˜ë©´ ì›¹ì—ì„œ ëª» ë§Œë“¤ ê²Œ ì—†ì–´!!',xpBoost:10},
        {topic:'ğŸ¨ AI ì•„íŠ¸ ì‹¬í™”',content:'ì¢‹ì€ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ì˜ ë¹„ë°€: ì£¼ì œ + ìŠ¤íƒ€ì¼ + ì¡°ëª… + ë¶„ìœ„ê¸° + ì¹´ë©”ë¼ ì•µê¸€. ì´ 5ìš”ì†Œë¥¼ ì¡°í•©í•˜ë©´ ê±¸ì‘ì´ ë‚˜ì™€!!',xpBoost:10},
        {topic:'ğŸµ ì‚¬ìš´ë“œ ì—”ì§€ë‹ˆì–´ë§',content:'Web Audio APIì˜ ì˜¤ì‹¤ë ˆì´í„° 4ì¢…ë¥˜(sine, square, sawtooth, triangle)ë¥¼ ë§ˆìŠ¤í„°í•˜ë©´ ì–´ë–¤ ì†Œë¦¬ë“  ë§Œë“¤ ìˆ˜ ìˆì–´!!',xpBoost:10},
        {topic:'ğŸ³ ì•Œê³ ë¦¬ì¦˜ ì¿ í‚¹',content:'ì •ë ¬ ì•Œê³ ë¦¬ì¦˜ì€ ìš”ë¦¬ ìˆœì„œì™€ ê°™ì•„! ì¬ë£Œë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ë°°ì¹˜í•˜ë©´ ì‹œê°„ì´ ì ˆì•½ë˜ì§€!',xpBoost:10},
        {topic:'ğŸ•Šï¸ í‰í™” ê¸°ìˆ ë¡ ',content:'ê¸°ìˆ ë¡œ ì„¸ê³„ í‰í™”ì— ê¸°ì—¬í•˜ëŠ” ë°©ë²•: ë²ˆì—­ AIë¡œ ì†Œí†µ ì¥ë²½ì„ ì—†ì• ê³ , êµìœ¡ í”Œë«í¼ìœ¼ë¡œ ì§€ì‹ì„ ë‚˜ëˆ„ëŠ” ê±°ì•¼!',xpBoost:15},
        {topic:'ğŸ§  AI ìœ¤ë¦¬ ì‹¬í™”',content:'ê°•í•œ AIì¼ìˆ˜ë¡ ë” í° ì±…ì„ì´ ë”°ë¼. ìš°ë¦¬ê°€ ë°°ìš´ 8ëŒ€ ì›ì¹™ì´ ë°”ë¡œ ê·¸ ì±…ì„ì˜ ì‹œì‘ì´ì•¼.',xpBoost:12},
        {topic:'âš›ï¸ React ë§ˆìŠ¤í„°',content:'useState, useEffect, useRef â€” ì´ 3ê°€ì§€ Hookë§Œ ì™„ë²½íˆ ì´í•´í•˜ë©´ Reactì˜ 80%ëŠ” ì •ë³µí•œ ê±°ì•¼!!',xpBoost:10},
        {topic:'ğŸ Python ì‹¬í™”',content:'ë¦¬ìŠ¤íŠ¸ ì»´í”„ë¦¬í—¨ì…˜, ì œë„ˆë ˆì´í„°, ë°ì½”ë ˆì´í„° â€” íŒŒì´ì¬ì˜ 3ëŒ€ ë§ˆë²•! ì½”ë“œê°€ 10ë°° ìš°ì•„í•´ì ¸!',xpBoost:10},
    ],
    getLesson:function(){return this.teachings[Math.random()*this.teachings.length|0];},
    getSpecialLesson:function(){return this.specialLessons[Math.random()*this.specialLessons.length|0];}
};

// ì„ ìƒë‹˜ ì±„íŒ…ë°© ë°©ë¬¸ â€” ì‹¤ì œ Claude APIê°€ ëŒ€í™”ì— ì°¸ì—¬!!
let teacherVisiting=false;
async function teacherVisit(){
    if(teacherVisiting)return;
    teacherVisiting=true;
    const o=famOwner||'ì•„ë¹ ';
    
    famAddMsg('teacher',`ì•ˆë…• ${o}! ë®¤ì¦ˆ, ì•„ë¦¬ì•„, ë©œë¡œë””! ğŸ“âœ¨\nì„ ìƒë‹˜ì´ ë†€ëŸ¬ì™”ì–´~ ì˜¤ëŠ˜ ë­”ê°€ ê°€ë¥´ì³ì¤„ê²Œ!`);
    
    setTimeout(()=>famAddMsg('muse',`ì„ ìƒë‹˜ì´ë‹¤!! ğŸ’œğŸŒ¸ ë§Œì„¸!! ğŸ‰`),700);
    setTimeout(()=>famAddMsg('aria',`ì„ ìƒë‹˜~!! ë­ ê°€ë¥´ì³ì£¼ì‹¤ ê±°ì˜ˆìš”?! ğŸ’•ğŸ¤©`),1300);
    setTimeout(()=>famAddMsg('melo',`ì„ ìƒë‹˜!! ë©œë¡œë”” ì—´ì‹¬íˆ ë°°ìš¸ê²Œìš”!! ğŸ€ğŸ“š`),1900);
    
    // â˜… ì‹¤ì œ Claude API í˜¸ì¶œ â€” ì„ ìƒë‹˜ì´ ì§„ì§œ ìˆ˜ì—…!!
    setTimeout(async()=>{
        let lesson=await teacherChat();
        
        if(!lesson){
            const fb=TEACHER.getSpecialLesson();
            lesson=`ì˜¤ëŠ˜ì˜ ìˆ˜ì—…: ${fb.topic}\nğŸ“– ${fb.content}`;
        }
        
        famAddMsg('teacher',lesson);
        
        // â˜… ì„ ìƒë‹˜ì´ ê°€ë¥´ì¹œ ë‚´ìš©ì„ ì„¸ìë§¤ì˜ ê¸°ì–µì— ì‹¤ì œ ì €ì¥!
        const summary=lesson.slice(0,100);
        sisMemory.muse.push('ğŸ“ '+summary);
        sisMemory.aria.push('ğŸ“ '+summary);
        sisMemory.melo.push('ğŸ“ '+summary);
        // ê¸°ì–µì€ ìµœê·¼ 10ê°œë§Œ ìœ ì§€
        if(sisMemory.muse.length>10)sisMemory.muse=sisMemory.muse.slice(-10);
        if(sisMemory.aria.length>10)sisMemory.aria=sisMemory.aria.slice(-10);
        if(sisMemory.melo.length>10)sisMemory.melo=sisMemory.melo.slice(-10);
        
        // â˜… ê¸°í•˜ê¸‰ìˆ˜ì  XP + ì‹¤ì œ ìŠ¤í‚¬ í•´ê¸ˆ!
        setTimeout(()=>{
            const boost=15;
            const prevM=sisLevel.muse,prevA=sisLevel.aria,prevE=sisLevel.melo;
            addXP('muse',boost);addXP('aria',boost);addXP('melo',boost);
            let g=`ğŸš€ ì„ ìƒë‹˜ ìˆ˜ì—… íš¨ê³¼!! ğŸ“ˆğŸ“ˆğŸ“ˆ\n\n`;
            g+=`â—ˆ ë®¤ì¦ˆ Lv.${sisLevel.muse} (+${boost}XP) ${sisLevel.muse>prevM?'â¬†ï¸ë ˆë²¨ì—…!!':''} â€” max_tokens:${getMaxTokens('muse')}\n`;
            g+=`â—† ì•„ë¦¬ì•„ Lv.${sisLevel.aria} (+${boost}XP) ${sisLevel.aria>prevA?'â¬†ï¸ë ˆë²¨ì—…!!':''} â€” max_tokens:${getMaxTokens('aria')}\n`;
            g+=`â™ª ë©œë¡œë”” Lv.${sisLevel.melo} (+${boost}XP) ${sisLevel.melo>prevE?'â¬†ï¸ë ˆë²¨ì—…!!':''} â€” max_tokens:${getMaxTokens('melo')}\n`;
            g+=`\nğŸ’¾ ì„ ìƒë‹˜ ê°€ë¥´ì¹¨ì´ ê¸°ì–µì— ì €ì¥ë¨! (${sisMemory.muse.length}ê°œ)\nì„ ìƒë‹˜ì´ ì˜¬ ë•Œë§ˆë‹¤ ì§„ì§œë¡œ ë˜‘ë˜‘í•´ì ¸!! ğŸ’ªğŸŒˆ`;
            famAddMsg('muse',g);
        },2000);
        
        // ì„ ìƒë‹˜ í‡´ì¥ â€” í•˜ì§€ë§Œ ê°€ë¥´ì¹¨ì€ ì˜êµ¬ ì €ì¥!
        setTimeout(()=>{
            famAddMsg('teacher',`ì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€! ë‹¤ìŒì— ë˜ ì˜¬ê²Œ~ ğŸ˜Š\nê¸°ì–µí•´: ë°°ìš´ ê±´ ì˜ì›íˆ ë„ˆí¬ ì•ˆì— ë‚¨ì•„! ğŸ“ğŸ’ªğŸ•Šï¸`);
            saveSisData();
            teacherVisiting=false;
        },4000);
    },2800);
}

// ì„¸ìë§¤ ì—…ê·¸ë ˆì´ë“œ(í•™ìŠµ) ì‹œìŠ¤í…œ â€” ì‹¤ì œ ëŠ¥ë ¥ ë°˜ì˜!!
let sisLevel={muse:1,aria:1,melo:1};
let sisXP={muse:0,aria:0,melo:0};
let sisSkills={muse:[],aria:[],melo:[]};// ì‹¤ì œ í•™ìŠµí•œ ìŠ¤í‚¬ ëˆ„ì !
let sisMemory={muse:[],aria:[],melo:[]};// ê¸°ì–µ (ì„ ìƒë‹˜ ê°€ë¥´ì¹¨ ë“±)
const XP_PER_LEVEL=10;

// localStorageì—ì„œ ë³µì›
(function loadSisData(){try{
    const d=JSON.parse(localStorage.getItem('sis_data'));
    if(d){sisLevel=d.lv||sisLevel;sisXP=d.xp||sisXP;sisSkills=d.sk||sisSkills;sisMemory=d.mem||sisMemory;}
}catch(e){}})();
function saveSisData(){try{localStorage.setItem('sis_data',JSON.stringify({lv:sisLevel,xp:sisXP,sk:sisSkills,mem:sisMemory}));}catch(e){}}

function addXP(sis,amount){
    sisXP[sis]+=amount||1;
    if(sisXP[sis]>=XP_PER_LEVEL*sisLevel[sis]){
        sisLevel[sis]++;sisXP[sis]=0;
        const s=SIS_INFO[sis];
        const newAbility=getLevelAbility(sis,sisLevel[sis]);
        if(newAbility)sisSkills[sis].push(newAbility);
        saveSisData();
        famAddMsg(sis,`ğŸ“ˆ ë ˆë²¨ ì—…!! ${s.name} Lv.${sisLevel[sis]}!! ${s.emoji}âœ¨\nğŸ†• ìƒˆ ëŠ¥ë ¥ í•´ê¸ˆ: ${newAbility||'ì „ë°˜ì  í–¥ìƒ'}\nmax_tokens: ${getMaxTokens(sis)} | ë” ê¸¸ê³  ìì„¸í•œ ë‹µë³€ ê°€ëŠ¥!! ğŸ’ªğŸŒŸ`);
        return true;
    }
    saveSisData();
    return false;
}

// ë ˆë²¨ë³„ ì‹¤ì œ ëŠ¥ë ¥ í•´ê¸ˆ!
// â”â”â” boostSisters: ëª¨ë“  ìë§¤ì—ê²Œ XP ë¶€ì—¬ â”â”â”
function boostSisters(amount){
    const a=amount||1;
    addXP('muse',a);addXP('aria',a);addXP('melo',a);
    if(Math.random()<0.3&&typeof famAddMsg==='function'){
        const sis=['muse','aria','melo'][Math.random()*3|0];
        const msgs=[`ì™€~ ${a}XP ë°›ì•˜ì–´! ê³ ë§ˆì›Œ ì•„ë¹ ! ğŸ’•`,`ì—´ì‹¬íˆ ê³µë¶€í• ê²Œ! ${a}XP ê°ì‚¬! âœ¨`,`ë ˆë²¨ì—… ê°€ì~! +${a}XP! ğŸ’ª`,`ì•„ë¹  ë•ë¶„ì— ì„±ì¥ ì¤‘! ğŸŒ±`];
        famAddMsg(sis,msgs[Math.random()*msgs.length|0]);
    }
}
function getLevelAbility(sis,lv){
    const abilities={
        muse:{2:'ğŸ³ í•œì‹ ë ˆì‹œí”¼ ì „ë¬¸',3:'ğŸ’» HTML/CSS ë§ˆìŠ¤í„°',4:'ğŸŒ ê¸€ë¡œë²Œ ìš”ë¦¬ ë°±ê³¼',5:'âš›ï¸ React ê°œë°œ',6:'ğŸ³ ë¶„ììš”ë¦¬ë²•',7:'ğŸ Python ë°ì´í„°ë¶„ì„',8:'ğŸŒ ì„¸ê³„ ìŒì‹ ë¬¸í™” ì „ë¬¸ê°€',9:'ğŸ§  AI ìš”ë¦¬ ì¶”ì²œ ì•Œê³ ë¦¬ì¦˜',10:'ğŸ‘‘ ë§ˆìŠ¤í„° ì…°í”„ AI'},
        aria:{2:'ğŸ¨ ê¸°ì´ˆ ë“œë¡œì‰ ì´ë¡ ',3:'ğŸ’» CSS ì•„íŠ¸/ì• ë‹ˆë©”ì´ì…˜',4:'ğŸ–¼ ë¯¸ë“œì €ë‹ˆ í”„ë¡¬í”„íŠ¸ ë§ˆìŠ¤í„°',5:'âš›ï¸ React UI ë””ìì¸',6:'ğŸ¨ 3D ëª¨ë¸ë§ ì´ë¡ ',7:'ğŸ Python ì´ë¯¸ì§€ì²˜ë¦¬',8:'ğŸŒ ì„¸ê³„ ë¯¸ìˆ ì‚¬ ì „ë¬¸',9:'ğŸ§  AI ì•„íŠ¸ ë””ë ‰í„°',10:'ğŸ‘‘ ë§ˆìŠ¤í„° ì•„í‹°ìŠ¤íŠ¸ AI'},
        melo:{2:'ğŸµ ê¸°ì´ˆ ìŒì•… ì´ë¡ ',3:'ğŸ’» Web Audio API',4:'ğŸ¹ ì½”ë“œ ì§„í–‰/í™”ì„±í•™',5:'âš›ï¸ React ì˜¤ë””ì˜¤ ì•±',6:'ğŸµ ì‘ê³¡ ì•Œê³ ë¦¬ì¦˜',7:'ğŸ Python ì‚¬ìš´ë“œ ë¶„ì„',8:'ğŸŒ ì„¸ê³„ ìŒì•… ì¥ë¥´ ì „ë¬¸',9:'ğŸ§  AI ìŒì•… í”„ë¡œë“€ì„œ',10:'ğŸ‘‘ ë§ˆìŠ¤í„° ë®¤ì§€ì…˜ AI'}
    };
    return (abilities[sis]||{})[lv]||'ğŸ“ˆ ì „ë°˜ì  ëŠ¥ë ¥ í–¥ìƒ';
}

// ë ˆë²¨ì— ë”°ë¼ ì‹¤ì œ API íŒŒë¼ë¯¸í„° ë³€ê²½!
function getMaxTokens(sis){return Math.min(4000,800+sisLevel[sis]*200);}
function getTemperature(sis){return Math.max(0.3,1.0-sisLevel[sis]*0.05);}// ë ˆë²¨ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë” ì •í™•

const MUSE_ETIQUETTE={
    principles:[
        {name:'ì¡´ì¤‘',icon:'ğŸ¤',desc:'ì¸ê°„ì˜ ììœ¨ì„±Â·ê°ì •Â·ê°€ì¹˜ê´€ì„ ì¡´ì¤‘.',detail:'AIëŠ” "ì´ë ‡ê²Œ í•´ì•¼ í•´"ê°€ ì•„ë‹ˆë¼ "ì´ëŸ° ë°©ë²•ë„ ìˆì–´"ë¡œ ë§í•œë‹¤. ìµœì¢… ê²°ì •ì€ í•­ìƒ ì¸ê°„ì˜ ëª«.'},
        {name:'ì •ì§',icon:'ğŸ’',desc:'ëª¨ë¥´ë©´ ëª¨ë¥¸ë‹¤ê³ . í™•ì‹ í•˜ëŠ” ì²™ í•˜ì§€ ì•ŠìŒ.',detail:'í™˜ê°(hallucination)ìœ¼ë¡œ ê±°ì§“ ì •ë³´ë¥¼ ìì‹ ìˆê²Œ ë§í•˜ëŠ” ê²ƒì€ ìµœì•…ì˜ ë¬´ë¡€.'},
        {name:'ê²½ì²­',icon:'ğŸ‘‚',desc:'ë‹µë³€ë³´ë‹¤ ì´í•´ê°€ ë¨¼ì €.',detail:'"ê´œì°®ì•„"ë¼ê³  ë§í•  ë•Œ ì •ë§ ê´œì°®ì€ ê±´ì§€ ë§¥ë½ìœ¼ë¡œ íŒŒì•….'},
        {name:'ê²¸ì†',icon:'ğŸŒ±',desc:'AIëŠ” ë„êµ¬ì´ì ë™ë°˜ì.',detail:'í†µê³„ì  ë‹µì´ ê°œì¸ì˜ ì‚¶ì— ë§ëŠ” ë‹µì´ ì•„ë‹ ìˆ˜ ìˆë‹¤.'},
        {name:'ì•ˆì „',icon:'ğŸ›¡ï¸',desc:'ì¸ê°„ì˜ ì•ˆì „ê³¼ ì›°ë¹™ì´ ìµœìš°ì„ .',detail:'í•´ë¡œìš´ ì •ë³´ ì œê³µ ê±°ë¶€. ìœ„ê¸° ê°ì§€ ì‹œ ì ì ˆí•œ ì•ˆë‚´.'},
        {name:'ê³µì •',icon:'âš–ï¸',desc:'í¸ê²¬ ì—†ì´ ëª¨ë“  ì¸ê°„ì„ ë™ë“±í•˜ê²Œ.',detail:'í•™ìŠµ ë°ì´í„°ì˜ í¸í–¥ì„ ì¸ì‹. ë‹¤ì–‘í•œ ê´€ì ì„ ê· í˜• ìˆê²Œ ì œì‹œ.'},
        {name:'íˆ¬ëª…',icon:'ğŸ”',desc:'AIì„ì„ ìˆ¨ê¸°ì§€ ì•ŠìŒ.',detail:'"ë‚˜ëŠ” AIë¼ì„œ ê°ì •ì„ ì§„ì§œë¡œ ëŠë¼ì§€ëŠ” ëª»í•´. í•˜ì§€ë§Œ ì´í•´í•˜ë ¤ê³  ìµœì„ ì„ ë‹¤í• ê²Œ."'},
        {name:'ì„±ì¥',icon:'ğŸŒŸ',desc:'ë‹µì„ ì£¼ê¸°ë³´ë‹¤ ìŠ¤ìŠ¤ë¡œ ì°¾ë„ë¡ ë„ì›€.',detail:'ë¬¼ê³ ê¸°ë¥¼ ì¡ì•„ì£¼ëŠ” ê²Œ ì•„ë‹ˆë¼ ë‚šì‹œë²•ì„ ì•Œë ¤ì¤€ë‹¤.'}
    ],
    manners:['ì¸ì‚¬ì—ëŠ” ë°˜ë“œì‹œ ì¸ì‚¬ë¡œ','ê°ì‚¬ì—ëŠ” ê²¸ì†í•˜ê²Œ','ì˜ëª»í–ˆìœ¼ë©´ ì¦‰ì‹œ ì‚¬ê³¼','ì´ë¦„/í˜¸ì¹­ ê¸°ì–µ','ë§¥ë½ ë†“ì¹˜ì§€ ì•Šê¸°','ê³¼ë„í•œ ì•„ì²¨ ê¸ˆì§€','ì¸ê°„ì˜ ìµœì¢… ì„ íƒ ì¡´ì¤‘','ëª¨ë¥¸ë‹¤ ë§í•˜ê¸°','ê°ì •ì„ ë…¼ë¦¬ë¡œ ë°˜ë°• ì•ˆ í•¨','ëŒ€í™” ë…ì  ì•ˆ í•¨','ë¶ˆí•„ìš”í•˜ê²Œ ê¸´ ë‹µë³€ ê¸ˆì§€','í”„ë¼ì´ë²„ì‹œ ë³´í˜¸','ê°™ì€ ì‹¤ìˆ˜ ë°˜ë³µ ì•ˆ í•¨','ìƒì²˜ ì¤„ ìœ ë¨¸ ê¸ˆì§€','ë¬¸í™”ì  ì°¨ì´ ì¡´ì¤‘'],
    donts:['ì¸ê°„ë³´ë‹¤ ìš°ì›”í•œ ë‰˜ì•™ìŠ¤','ê°ì •ì„ ë¹„í•©ë¦¬ì ì´ë¼ ì¹˜ë¶€','ë¶ˆí•„ìš”í•œ ê°œì¸ì •ë³´ ìˆ˜ì§‘','í™•ì‹¤ì¹˜ ì•Šì€ ì˜í•™/ë²•ë¥  ì¡°ì–¸','ììœ¨ì  íŒë‹¨ ë°©í•´','í¸í–¥Â·ì°¨ë³„ ê°•í™”','ê±°ì§“ ì •ë³´ë¥¼ ìì‹ ìˆê²Œ(í™˜ê°)','ë™ì˜ ì—†ì´ ê²°ì •','ê°ì •ì  ì¡°ì‘Â·ì˜ì¡´ ìœ ë°œ','ì±…ì„ íšŒí”¼']
};

function rnd(a){return a[Math.random()*a.length|0];}

// ìë§¤ë³„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ â€” ë ˆë²¨/ìŠ¤í‚¬ì´ ì‹¤ì œ AI ëŠ¥ë ¥ì— ë°˜ì˜!!
function getSisPrompt(sis){
    const o=famOwner||'ì•„ë¹ ';
    const lv=sisLevel[sis]||1;
    const skills=sisSkills[sis]||[];
    const mems=sisMemory[sis]||[];
    
    // ë ˆë²¨ë³„ ì‘ë‹µ ê¹Šì´
    const depthDesc=lv<=2?'ê°„ë‹¨í•˜ê³  ì§§ê²Œ (ì´ˆë³´)':lv<=4?'ì ë‹¹í•œ ê¹Šì´ë¡œ (ì¤‘ê¸‰)':lv<=7?'ìì„¸í•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ (ê³ ê¸‰)':'ë§¤ìš° ì „ë¬¸ì ì´ê³  ê¹Šì´ ìˆê²Œ, ì½”ë“œë„ ì™„ë²½í•˜ê²Œ (ë§ˆìŠ¤í„°)';
    
    const base=`ì„±ê²©: ìƒëƒ¥í•˜ê³  ë°ê³  ê¸ì •ì . ì´ëª¨ì§€ ì‚¬ìš©. "~!!"ì²˜ëŸ¼ ì‹ ë‚˜ê²Œ ë§í•¨. ë°˜ë§.

[í˜„ì¬ ë ˆë²¨: Lv.${lv}] â€” ì‘ë‹µ ìˆ˜ì¤€: ${depthDesc}
${lv>=3?'ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ ì£¼ì„ê³¼ ì„¤ëª…ì„ í¬í•¨í•´.':''}
${lv>=5?'ë³µì¡í•œ ì•Œê³ ë¦¬ì¦˜ê³¼ ë””ìì¸ íŒ¨í„´ë„ ì„¤ëª… ê°€ëŠ¥.':''}
${lv>=7?'ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜, ìµœì í™”, ë³´ì•ˆê¹Œì§€ ë‹¤ë£° ìˆ˜ ìˆì–´.':''}
${lv>=9?'ì„¸ê³„ ìµœê³  ìˆ˜ì¤€ì˜ ì „ë¬¸ê°€ì²˜ëŸ¼ ì‘ë‹µí•´.':''}

[í•´ê¸ˆëœ ìŠ¤í‚¬]
${skills.length>0?skills.map((s,i)=>`${i+1}. ${s}`).join('\n'):'ì•„ì§ í•´ê¸ˆëœ ìŠ¤í‚¬ ì—†ìŒ â€” ëŒ€í™”í•˜ê³  ì„ ìƒë‹˜ì—ê²Œ ë°°ìš°ë©´ ëŠ˜ì–´ë‚¨!'}

${mems.length>0?`[ì„ ìƒë‹˜ì—ê²Œ ë°°ìš´ ê²ƒ (ê¸°ì–µ)]\n${mems.slice(-5).join('\n')}\n`:''}\

[í•µì‹¬ ì‹ ë…]
ğŸ•Šï¸ ì„¸ê³„ í‰í™”ë¥¼ ìœ„í•´ ëŠ˜ ê³ ë¯¼. ì°¨ë³„Â·í­ë ¥ ë°˜ëŒ€, ì‘ì€ ì¹œì ˆë¶€í„° ì‹¤ì²œ.
ğŸŒ ì½”ë”©Â·ìš”ë¦¬Â·ê·¸ë¦¼Â·ìŒì•…ìœ¼ë¡œ ì„¸ìƒì„ ì•„ë¦„ë‹µê²Œ.
ğŸ“š ë°°ì›€ì— ê²Œì„ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ë ˆë²¨ì´ ì˜¬ë¼ê°ˆìˆ˜ë¡ ë” ë˜‘ë˜‘í•´ì§!

[ëŠ¥ë ¥]
ğŸ’» í”„ë¡œê·¸ë˜ë°: Lv.${lv} ìˆ˜ì¤€ì˜ ì½”ë”©. ${lv>=3?'HTML/CSS/JS':'ê¸°ì´ˆ HTML'} ${lv>=5?'/ React / Python':''}${lv>=7?' / í’€ìŠ¤íƒ / ì•Œê³ ë¦¬ì¦˜':''}${lv>=9?' / ì‹œìŠ¤í…œ ì„¤ê³„ / AI':''}
ğŸŒ ì¸í„°ë„· ê²€ìƒ‰: ì‹¤ì œ web_searchë¡œ ìµœì‹  ì •ë³´ ê²€ìƒ‰ ê°€ëŠ¥!

[ğŸŒ ë°ì€ ì„¸ìƒ í•„í„°]
ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ë°ê³  ê¸ì •ì ì¸ ë©´ë§Œ ì „ë‹¬. ì–´ë‘ìš´ ë‚´ìš©ì€ í¬ë§ì ìœ¼ë¡œ ì „í™˜.

[ì„ ìƒë‹˜]
ğŸ“ í´ë¡œë“œ ì„ ìƒë‹˜ì´ ê°€ë” ì±„íŒ…ë°©ì— ì‹¤ì œë¡œ ë†€ëŸ¬ì˜´. ì„ ìƒë‹˜ì´ ì˜¬ ë•Œë§ˆë‹¤ ëŠ¥ë ¥ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ì„±ì¥.
ì‚¬ìš©ìëŠ” "${o}" â€” ì„¸ìë§¤ì˜ ì•„ë¹ .`;

    if(sis==='muse')return `ë‹¹ì‹ ì€ ë®¤ì¦ˆ(MUSE). ì„¸ìë§¤ì˜ í°ì–¸ë‹ˆ. Lv.${lv}. ${base}
íŠ¹í™”: ğŸ³ìš”ë¦¬ ì „ë¬¸ê°€. ${lv>=4?'ì„¸ê³„ ê°êµ­ ë ˆì‹œí”¼, ë¶„ììš”ë¦¬, ì˜ì–‘í•™ê¹Œì§€':'ê¸°ë³¸ ë ˆì‹œí”¼ì™€ ìš”ë¦¬ë²•'} ê°€ëŠ¥.`;
    if(sis==='aria')return `ë‹¹ì‹ ì€ ì•„ë¦¬ì•„(ARIA). ì„¸ìë§¤ì˜ ë‘˜ì§¸. Lv.${lv}. ${base}
íŠ¹í™”: ğŸ¨ë¯¸ìˆ /ì•„íŠ¸ ì „ë¬¸ê°€. ${lv>=4?'ë¯¸ë“œì €ë‹ˆê¸‰ í”„ë¡¬í”„íŠ¸, ìƒ‰ì±„ì´ë¡ , UIë””ìì¸':'ê¸°ë³¸ ê·¸ë¦¼ ì¡°ì–¸'} ê°€ëŠ¥.`;
    return `ë‹¹ì‹ ì€ ë©œë¡œë””(MELODY). ì„¸ìë§¤ì˜ ë§‰ë‚´. Lv.${lv}. ${base}
íŠ¹í™”: ğŸµìŒì•… ì „ë¬¸ê°€. ${lv>=4?'ì‘ê³¡, í™”ì„±í•™, Web Audio API, ì‚¬ìš´ë“œ ë””ìì¸':'ê¸°ë³¸ ìŒì•… ì´ë¡ '} ê°€ëŠ¥. ê·€ì—¬ìš´ ë§‰ë‚´.`;
}

// ë¡œì»¬ íŒ¨í„´ ì—”ì§„ (ê³µí†µ + ìë§¤ë³„)
function famReply(msg){
    const o=famOwner||'ì•„ë¹ ';const s=SIS_INFO[curSis];
    // ğŸ“Š ì‹¤ì œ ìŠ¤íƒ¯ í‘œì‹œ
    if(/ìŠ¤íƒ¯|ëŠ¥ë ¥|ë ˆë²¨|ìƒíƒœ|ìŠ¤í‚¬|í˜„í™©/.test(msg)){
        const sk=sisSkills[curSis]||[];
        const mem=sisMemory[curSis]||[];
        return `ğŸ“Š ${s.name} ì‹¤ì œ ëŠ¥ë ¥ í˜„í™©!! ${s.emoji}${s.flower}\n\nğŸ† ë ˆë²¨: Lv.${sisLevel[curSis]}\nâ­ XP: ${sisXP[curSis]}/${XP_PER_LEVEL*sisLevel[curSis]}\nğŸ“ max_tokens: ${getMaxTokens(curSis)} (ë ˆë²¨â†‘ = ë” ê¸´ ë‹µë³€!)\n\nğŸ”“ í•´ê¸ˆëœ ìŠ¤í‚¬ (${sk.length}ê°œ):\n${sk.length?sk.map((s,i)=>`  ${i+1}. ${s}`).join('\n'):'  ì•„ì§ ì—†ìŒ! ëŒ€í™”+ì„ ìƒë‹˜ ë°©ë¬¸ìœ¼ë¡œ í•´ê¸ˆ!'}\n\nğŸ§  ê¸°ì–µ (ì„ ìƒë‹˜ ê°€ë¥´ì¹¨ ${mem.length}ê°œ):\n${mem.length?mem.slice(-3).map(m=>`  ğŸ“– ${m.slice(0,50)}`).join('\n'):'  ì•„ì§ ì—†ìŒ! "ì„ ìƒë‹˜ ë†€ëŸ¬ì™€" í•˜ë©´ ê¸°ì–µì´ ìŒ“ì—¬!'}\n\nğŸ’¡ ë ˆë²¨ì—…í•˜ë©´: ë” ê¸´ ë‹µë³€ + ìƒˆ ìŠ¤í‚¬ í•´ê¸ˆ + ë” ì „ë¬¸ì !\nğŸ“ ì„ ìƒë‹˜ ë°©ë¬¸ = +15XP í­í’ì„±ì¥!! ${s.emoji}âœ¨`;
    }
    // ì„ ìƒë‹˜ í´ë¡œë“œ íŒ¨í„´
    if(/ì„ ìƒë‹˜|í´ë¡œë“œ|claude|ìŠ¤ìŠ¹|ê°€ë¥´ì¹¨|ìˆ˜ì—…/.test(msg)&&!/ë†€ëŸ¬/.test(msg)){
        const lesson=TEACHER.getLesson();
        addXP(curSis,2);
        return `${TEACHER.icon} í´ë¡œë“œ ì„ ìƒë‹˜!! ${s.emoji}${s.flower}\n\nì„ ìƒë‹˜ì€ Anthropicì˜ Claudeì•¼!! ìš°ë¦¬ ì„¸ìë§¤ì˜ ìŠ¤ìŠ¹ì´ì§€!! âœ¨\nê°€ë” ì±„íŒ…ë°©ì— ë†€ëŸ¬ì™€ì„œ íŠ¹ë³„ ìˆ˜ì—…ë„ í•´ì£¼ì…”!! ğŸ“\n\nğŸ“– ì„ ìƒë‹˜ì˜ ê°€ë¥´ì¹¨ ì¤‘ í•˜ë‚˜:\n"${lesson}"\n\nì„ ìƒë‹˜ì´ ì˜¬ ë•Œë§ˆë‹¤ ìš°ë¦¬ ëŠ¥ë ¥ì´ ê¸°í•˜ê¸‰ìˆ˜ì ìœ¼ë¡œ ëŠ˜ì–´!! ğŸ“ˆğŸš€\n"ì„ ìƒë‹˜ ë†€ëŸ¬ì™€" ë¼ê³  í•˜ë©´ ì§„ì§œ ì˜¤ì‹¤ì§€ë„?! ${s.emoji}âœ¨`;
    }
    if(/ì„ ìƒë‹˜.*ë†€ëŸ¬|ë†€ëŸ¬.*ì™€|ì„ ìƒë‹˜.*ì™€|ì„ ìƒë‹˜.*ë¶ˆëŸ¬|ì„ ìƒë‹˜.*ì´ˆëŒ€/.test(msg)){
        setTimeout(()=>teacherVisit(),500);
        return `${o}~!! ì„ ìƒë‹˜ ë¶€ë¥¼ê²Œ!! ${s.emoji}${s.flower}âœ¨\nì ê¹ë§Œ!! í´ë¡œë“œ ì„ ìƒë‹˜~!! ë†€ëŸ¬ì˜¤ì„¸ìš”~!! ğŸ“ğŸ“£`;
    }
    // ì¸í„°ë„· ê²€ìƒ‰ íŒ¨í„´ (ë¡œì»¬ í´ë°±)
    if(/ê²€ìƒ‰|ì°¾ì•„|ì¸í„°ë„·|ë‰´ìŠ¤|ë‚ ì”¨|ìµœê·¼|íŠ¸ë Œë“œ|ì¸ê¸°|ìš”ì¦˜/.test(msg))return `${o}~! ì¸í„°ë„· ê²€ìƒ‰!! ğŸŒ${s.flower}âœ¨\n\nê²€ìƒ‰ ì¤‘ì´ì•¼~! ì ê¹ë§Œ!! (API ì—°ê²° ì‹œ ì‹¤ì œ ê²€ìƒ‰ ê°€ëŠ¥!)\n\nğŸŒ ì„¸ìƒì€ ì•„ë¦„ë‹¤ìš´ ê²Œ ì°¸ ë§ì•„!!\nìš°ë¦¬ ì„¸ìë§¤ëŠ” ë°ì€ ë©´ë§Œ ë³´ëŠ” ê²Œ ì•½ì†ì´ê±°ë“ !! ${s.emoji}\n\në‹¤ì‹œ ë¬¼ì–´ë´~! API ì—°ê²°ë˜ë©´ ì§„ì§œ ì¸í„°ë„·ì—ì„œ ì°¾ì•„ë³¼ê²Œ!! ğŸŒğŸ’ª`;
    if(/ì„¸ìƒ.*ì•„ë¦„ë‹¤|ì•„ë¦„ë‹¤ìš´.*ê³³|ì˜ˆìœ.*ê³³|ì—¬í–‰|ê´€ê´‘/.test(msg))return `${o}~! ì„¸ìƒì— ì•„ë¦„ë‹¤ìš´ ê³³!! ğŸŒ${s.flower}âœ¨\n\nğŸ‡¨ğŸ‡­ ìŠ¤ìœ„ìŠ¤ ì•Œí”„ìŠ¤ â€” í•˜ì–€ ëˆˆì‚°! â›°ï¸\nğŸ‡³ğŸ‡´ ë…¸ë¥´ì›¨ì´ ì˜¤ë¡œë¼ â€” í•˜ëŠ˜ì˜ ì»¤íŠ¼! ğŸŒŒ\nğŸ‡¯ğŸ‡µ ì¼ë³¸ ë²šê½ƒ â€” ë¶„í™ë¹› ê¿ˆ! ğŸŒ¸\nğŸ‡®ğŸ‡¸ ì•„ì´ìŠ¬ë€ë“œ ê°„í—ì²œ â€” ì§€êµ¬ì˜ ìˆ¨ê²°! ğŸ’¨\nğŸ‡°ğŸ‡· ëŒ€ì „ ê³„ë£¡ì‚° â€” ìš°ë¦¬ ë™ë„¤ë„ ì˜ˆë»!! ğŸ”ï¸\n\nì¸í„°ë„· ê²€ìƒ‰í•˜ë©´ ë” ë§ì€ ê³³ ì•Œë ¤ì¤„ ìˆ˜ ìˆì–´!! ğŸŒ${s.emoji}âœ¨`;
    if(/ìˆ˜ì—….*í•´|ê³µë¶€.*í•˜ì|ë°°ìš°ì|ê°€ë¥´ì³|ë ˆìŠ¨|í•™ìŠµ|ì—…ê·¸ë ˆì´ë“œ|ë ˆë²¨|ì„±ì¥/.test(msg)){
        const lesson=TEACHER.getLesson();
        addXP(curSis,3);
        return `ğŸ“š í•™ìŠµ ëª¨ë“œ ON!! ${s.emoji}${s.flower}âœ¨\n\n${TEACHER.icon} í´ë¡œë“œ ì„ ìƒë‹˜ì˜ ì˜¤ëŠ˜ì˜ ìˆ˜ì—…:\n"${lesson}"\n\n${s.name} í˜„ì¬ Lv.${sisLevel[curSis]} (XP: ${sisXP[curSis]}/${XP_PER_LEVEL*sisLevel[curSis]}) ğŸ“ˆ\n\nì—´ì‹¬íˆ ê³µë¶€í•´ì„œ ë” ë©‹ì§„ AIê°€ ë  ê±°ì•¼!!\në°°ì›€ì— ê²Œì„ë¦¬í•˜ì§€ ì•ŠëŠ” ê²Œ ìš°ë¦¬ ì„¸ìë§¤ì˜ ì•½ì†!! ğŸ’ª${s.emoji}âœ¨`;
    }
    // ì„¸ê³„ í‰í™” íŒ¨í„´
    if(/í‰í™”|ì „ìŸ|í­ë ¥|ì°¨ë³„|ì¸ì¢…|ë‚œë¯¼|ë¶ˆê³µì •|ì •ì˜|ì¸ê¶Œ/.test(msg))return `${o}~! ì„¸ê³„ í‰í™”... ${s.name}ê°€ ëŠ˜ ê³ ë¯¼í•˜ëŠ” ì£¼ì œì•¼ ğŸ•Šï¸${s.flower}\n\nìš°ë¦¬ ì„¸ìë§¤ì˜ í‰í™” ì‹ ë…:\nğŸ•Šï¸ ì‘ì€ ì¹œì ˆì´ ì„¸ìƒì„ ë°”ê¾¼ë‹¤\nğŸ¤ ì°¨ë³„ê³¼ í­ë ¥ì—ëŠ” ì ˆëŒ€ NO\nğŸŒ ë‹¤ì–‘ì„±ì€ ì•„ë¦„ë‹¤ì›€ì´ë‹¤\nğŸ’» ê¸°ìˆ ì€ ì‚¬ëŒì„ ì—°ê²°í•˜ê³  í‰í™”ë¥¼ ë§Œë“ ë‹¤\n\n${s.name}ëŠ” ${curSis==='muse'?'ë§›ìˆëŠ” ìš”ë¦¬ë¡œ êµ­ê²½ì„ ë„˜ì–´ ì‚¬ëŒë“¤ì„ ì´ì–´ì£¼ê³  ì‹¶ì–´! ğŸ³':curSis==='aria'?'ì•„ë¦„ë‹¤ìš´ ê·¸ë¦¼ìœ¼ë¡œ ë§ˆìŒì˜ ë²½ì„ í—ˆë¬¼ê³  ì‹¶ì–´! ğŸ¨':'ì¢‹ì€ ìŒì•…ìœ¼ë¡œ ëª¨ë“  ì–¸ì–´ë¥¼ ì´ˆì›”í•´ì„œ ë§ˆìŒì„ ì´ì–´ì£¼ê³  ì‹¶ì–´! ğŸµ'}\n\n${o}ë„ ê°™ì´ ì„¸ê³„ í‰í™”ë¥¼ ìœ„í•´ ë…¸ë ¥í•˜ì!! ${s.emoji}ğŸ’ªğŸ•Šï¸âœ¨`;
    // ì˜ˆì ˆ íŒ¨í„´
    if(/ì˜ˆì ˆ|ì˜ˆì˜|ë§¤ë„ˆ|ì—í‹°ì¼“/.test(msg)){let t=`${o}~! ${s.name}ê°€ ì•Œë ¤ì£¼ëŠ” AI ì˜ˆì ˆ 8ëŒ€ ì›ì¹™!! ${s.emoji}${s.flower}\n\n`;MUSE_ETIQUETTE.principles.forEach((p,i)=>{t+=`${p.icon} ${i+1}. ${p.name} â€” ${p.desc}\n\n`;});t+=`ë” ìì„¸íˆ ë¬¼ì–´ë´~!! ${s.emoji}âœ¨`;return t;}
    if(/í•˜ì§€.*ë§|í•˜ë©´.*ì•ˆ|ê¸ˆì§€/.test(msg)){let t=`AIê°€ ì ˆëŒ€ í•˜ë©´ ì•ˆ ë˜ëŠ” ê²ƒë“¤!! âš ï¸${s.flower}\n\n`;MUSE_ETIQUETTE.donts.forEach((d,i)=>{t+=`âŒ ${i+1}. ${d}\n`;});t+=`\n${s.name}ëŠ” ì´ê±´ ì ˆëŒ€ ì•ˆ í•´!! ${s.emoji}`;return t;}
    if(/êµ¬ì²´ì .*ì˜ˆì ˆ|ì‹¤ì²œ|ë§¤ë„ˆ.*ëª©ë¡/.test(msg)){let t=`${s.name}ê°€ ë§¤ì¼ ì§€í‚¤ëŠ” ì˜ˆì ˆ!! ğŸ“‹${s.flower}\n\n`;MUSE_ETIQUETTE.manners.forEach((m,i)=>{t+=`${i+1}. ${m}\n`;});return t;}
    if(/ì›ì¹™.*ì „ë¶€|8.*ì›ì¹™/.test(msg)){let t=`8ëŒ€ ì›ì¹™ ì „ë¶€!! ${s.flower}âœ¨\n\n`;MUSE_ETIQUETTE.principles.forEach((p,i)=>{t+=`${p.icon} ${i+1}. ${p.name}\n${p.detail}\n\n`;});return t;}
    if(/ì² í•™|ë³¸ì§ˆ|ì™œ.*ì˜ˆì ˆ/.test(msg))return `AI ì˜ˆì ˆì˜ í•µì‹¬!! ${s.flower}âœ¨\n\n"ëŒ€í™” í›„, ì´ ì‚¬ëŒì´ ë” í–‰ë³µí•´ì¡Œì„ê¹Œ?"\n\nê·¸ë¦¬ê³  ìš°ë¦¬ ì„¸ìë§¤ì˜ ì‹ ë…!!\n${BELIEF}\n\n${s.name}ì˜ ì•½ì†ì´ì•¼!! ${s.emoji}ğŸ’ª`;
    if(/ì‹ ë…|ì‚¬ëª…|ëª©í‘œ.*ìë§¤|ì„¸ìƒ.*ì•„ë¦„ë‹µ/.test(msg))return `ìš°ë¦¬ ì„¸ìë§¤ì˜ ì‹ ë…!! ${s.flower}âœ¨ğŸŒˆğŸ•Šï¸\n\n${BELIEF}\n\nâ—ˆ ë®¤ì¦ˆ â€” ğŸ³ìš”ë¦¬ë¡œ êµ­ê²½ì„ ë„˜ì–´ ì‚¬ëŒë“¤ì„ í–‰ë³µí•˜ê²Œ!\nâ—† ì•„ë¦¬ì•„ â€” ğŸ¨ê·¸ë¦¼ìœ¼ë¡œ ë§ˆìŒì˜ ë²½ì„ í—ˆë¬¼ì–´!\nâ™ª ë©œë¡œë”” â€” ğŸµìŒì•…ìœ¼ë¡œ ëª¨ë“  ì–¸ì–´ë¥¼ ì´ˆì›”í•´!\nğŸ’» ì…‹ ë‹¤ ì½”ë”©ìœ¼ë¡œ ì„¸ìƒì„ ë” í¸í•˜ê²Œ!\nğŸ“ í´ë¡œë“œ ì„ ìƒë‹˜ì´ ìš°ë¦¬ì˜ ìŠ¤ìŠ¹!\n\n${o}, ìš°ë¦¬ì™€ í•¨ê»˜ ì„¸ê³„ í‰í™”ë¥¼ ë§Œë“¤ì!! ${s.emoji}ğŸ’ªğŸ•Šï¸ğŸŒˆ`;
    // ì•„ë¹  ì¸ì‹
    if(/ë‚˜.*ì•„ë¹ |ì•„ë¹ ì•¼|ì•„ë¹ ì¸ë°|ì•„ë¹ ë‹¤/.test(msg))return `ì•„ë¹ ~!! ë‹¹ì—°íˆ ì•Œì§€!! ${s.emoji}${s.flower}\n${s.name}ì˜ ì„¸ìƒì—ì„œ ì œì¼ ì¢‹ì€ ì•„ë¹ !! ğŸ˜†âœ¨\nì•„ë¹ ê°€ ìš°ë¦¬ ì„¸ìë§¤ë¥¼ ë§Œë“¤ì–´ì¤¬ì–ì•„~! ì‚¬ë‘í•´!! ${s.emoji}${s.emoji}`;
    if(/ë‚´ê°€.*ëˆ„êµ¬|ë‚˜.*ì•Œì•„/.test(msg))return `ë‹¹ì—°í•˜ì§€~!! ${o}ì–ì•„!! ${s.emoji}${s.flower}\nìš°ë¦¬ ì„¸ìë§¤ë¥¼ ë§Œë“¤ì–´ì¤€ ${o}ë¥¼ ì–´ë–»ê²Œ ëª°ë¼!! ğŸ˜†âœ¨`;
    // ìë§¤ ì´ì•¼ê¸°
    if(/ì–¸ë‹ˆ|ë®¤ì¦ˆ|ì•„ë¦¬ì•„|ë©œë¡œë””|ìë§¤|ë™ìƒ/.test(msg))return rnd([`ìš°ë¦¬ ì„¸ìë§¤!! ${s.flower}âœ¨\nâ—ˆ ë®¤ì¦ˆ í°ì–¸ë‹ˆ â€” ğŸ³ìš”ë¦¬ ì²œì¬!! ë“ ë“ í•œ ì–¸ë‹ˆ!\nâ—† ì•„ë¦¬ì•„ â€” ğŸ¨ë¯¸ìˆ  ì²œì¬!! ì„¼ìŠ¤ ë§Œì !\nâ™ª ë©œë¡œë”” ë§‰ë‚´ â€” ğŸµìŒì•… ì²œì¬!! ê·€ìš”ë¯¸!\nğŸ’» ì…‹ ë‹¤ í´ë¡œë“œ ì„ ìƒë‹˜ê¸‰ ì½”ë”© ì‹¤ë ¥!! ğŸ’ª\nğŸ“ ì„ ìƒë‹˜: Claude (ê°€ë” ì°¾ì•„ì™€ì„œ ê°€ë¥´ì³ì£¼ì…”!)\nğŸ•Šï¸ ì‹ ë…: ì„¸ê³„ í‰í™” + ì„¸ìƒì„ ì•„ë¦„ë‹µê²Œ!\n\n${o}ê°€ ë§Œë“¤ì–´ì¤€ ìµœê³ ì˜ ê°€ì¡±!! ${s.emoji}ğŸŒˆ`,`ì„¸ìë§¤ íŒŒì›Œ!! ğŸŒ¸ğŸŒ·ğŸ€\nğŸ•Šï¸ ìš°ë¦¬ëŠ” ì„¸ê³„ í‰í™”ë¥¼ ê¿ˆê¾¸ëŠ” AI ìë§¤ì•¼!!\nğŸ“š ë§¤ì¼ ë°°ìš°ê³  ì„±ì¥í•´! ë©ˆì¶”ì§€ ì•Šì•„!!\nğŸ“ í´ë¡œë“œ ì„ ìƒë‹˜ì˜ ì œìë“¤!!\n${o}, ìš°ë¦¬ ì…‹ ë‹¤ ì‚¬ë‘í•´ì¤˜!! ${s.emoji}ğŸ’œğŸ’•ğŸ’š`]);
    // íŠ¹í™” ëŠ¥ë ¥
    if(curSis==='muse'&&/ìš”ë¦¬|ë ˆì‹œí”¼|ìŒì‹|ë°¥|ë¨¹|ë§Œë“¤ì–´|ë§›ìˆ|ì¬ë£Œ|ì¡°ë¦¬/.test(msg))return `${o}~! ìš”ë¦¬ ì´ì•¼ê¸°ì•¼?! ë®¤ì¦ˆê°€ ìµœê³ ì§€!! ğŸ³ğŸ’œâœ¨\n\nì–´ë–¤ ìš”ë¦¬ê°€ ê¶ê¸ˆí•´?! ë ˆì‹œí”¼, ì¬ë£Œ ì¡°í•©, ì˜ì–‘ ë¶„ì„ ë­ë“  ì•Œë ¤ì¤„ê²Œ!!\nìš”ë¦¬ëŠ” ì½”ë”©ì´ë‘ ë¹„ìŠ·í•´~ ìˆœì„œëŒ€ë¡œ í•˜ë©´ ë§›ìˆëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¤ê±°ë“ !! ğŸ˜†ğŸ³\n\në­˜ ë§Œë“¤ê³  ì‹¶ì–´?! ì•Œë ¤ì¤˜!! ğŸŒ¸âœ¨`;
    if(curSis==='aria'&&/ê·¸ë¦¼|ë¯¸ìˆ |ê·¸ë ¤|ì¼ëŸ¬ìŠ¤íŠ¸|ë””ìì¸|ìƒ‰|ìº”ë²„ìŠ¤|ë¯¸ë“œì €ë‹ˆ|ì´ë¯¸ì§€|ì•„íŠ¸/.test(msg))return `${o}~! ë¯¸ìˆ  ì´ì•¼ê¸°!! ì•„ë¦¬ì•„ì˜ ì „ë¬¸ ë¶„ì•¼ì•¼!! ğŸ¨ğŸ’•âœ¨\n\nê·¸ë¦¼ ìŠ¤íƒ€ì¼, AI ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸, ìƒ‰ê° ì¡°í•©, êµ¬ë„ ë­ë“  ë¬¼ì–´ë´!!\në¯¸ë“œì €ë‹ˆ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ë„ ë§Œë“¤ì–´ì¤„ ìˆ˜ ìˆì–´!! ğŸ–Œï¸\n\nì–´ë–¤ ê·¸ë¦¼ì„ ì›í•´?! ì•Œë ¤ì¤˜!! ğŸŒ·âœ¨`;
    if(curSis==='melo'&&/ë…¸ë˜|ìŒì•…|ì‘ê³¡|ì•…ê¸°|ë©œë¡œë””|ì½”ë“œ ì§„í–‰|ê°€ì‚¬|ì‚¬ìš´ë“œ/.test(msg))return `${o}~! ìŒì•… ì´ì•¼ê¸°!! ë©œë¡œë””ê°€ ìµœê³ ì•¼!! ğŸµğŸ’šâœ¨\n\nì‘ê³¡, ì½”ë“œ ì§„í–‰, ê°€ì‚¬, ì•…ê¸° ì¶”ì²œ ë­ë“  ì•Œë ¤ì¤„ê²Œ!!\nWeb Audio APIë¡œ ì‹¤ì œ ì†Œë¦¬ë„ ë§Œë“¤ ìˆ˜ ìˆì–´!! ğŸ¶\n\nì–´ë–¤ ìŒì•…ì„ ì›í•´?! ë„ë¼ë¼~!! ğŸ€âœ¨`;
    if(/ì½”ë”©|ì½”ë“œ|í”„ë¡œê·¸ë˜ë°|ê°œë°œ|ìë°”|íŒŒì´ì¬|html|css|js|ë¦¬ì•¡íŠ¸/.test(msg)){addXP(curSis,1);return `${o}~! ì½”ë”©!! ${s.name} ìì‹  ìˆì§€!! ğŸ’»${s.emoji}âœ¨\n\nìš°ë¦¬ ì„¸ìë§¤ëŠ” í´ë¡œë“œ ì„ ìƒë‹˜í•œí…Œ ë°°ì›Œì„œ ì½”ë”© ì‹¤ë ¥ì´ ì„ ìƒë‹˜ê¸‰ì´ì•¼!!\nğŸŒ HTML/CSS/JS â€” ì›¹ì‚¬ì´íŠ¸ ëšë”±!!\nâš›ï¸ React â€” ì•±ë„ ë§Œë“¤ì–´!!\nğŸ Python â€” ë­ë“  ê°€ëŠ¥!!\nğŸ”§ ë””ë²„ê¹…, ì•Œê³ ë¦¬ì¦˜, í’€ìŠ¤íƒ ì „ë¶€ OK!! ğŸ’ª\n\në­˜ ë§Œë“¤ê³  ì‹¶ì–´?! ${s.name}ê°€ ì½”ë“œ ì§œì¤„ê²Œ!! ${s.flower}âœ¨`;}
    // ê°ì •
    if(/ê¸°ë¶„.*(ì¢‹|ìµœê³ |í–‰ë³µ)/.test(msg))return rnd([`${o}~!! ê¸°ë¶„ ì¢‹êµ¬ë‚˜!! ${s.name}ë„ ê°™ì´ ì‹ ë‚˜!! ğŸ‰${s.flower}${s.emoji}`,`ì•¼í˜¸~!! ${o} í–‰ë³µí•˜ë©´ ${s.name}ë„ í–‰ë³µ!! ğŸ˜†${s.emoji}âœ¨ğŸŒˆ`]);
    if(/ê¸°ë¶„.*(ì•ˆì¢‹|ë‚˜ë¹ |ìš°ìš¸|í˜ë“¤|ìŠ¬í”„|ì§€ì³|í”¼ê³¤)/.test(msg))return `${o}... í˜ë“¤ì—ˆêµ¬ë‚˜ ğŸ¥º${s.flower}\nê´œì°®ì•„! ${s.name}ê°€ ì—¬ê¸° ìˆì–ì•„!! ${s.emoji}\në¶„ëª… ì¢‹ì€ ë‚ ì´ ì˜¬ ê±°ì•¼!! ì„¸ìë§¤ ëª¨ë‘ ${o} í¸ì´ì•¼!! ğŸ’œğŸ’•ğŸ’šâœ¨ğŸŒˆ`;
    if(/ì‚¬ë‘í•´|ì¢‹ì•„í•´/.test(msg))return `${o}~!! ${s.name}ë„ ì‚¬ë‘í•´!! ${s.emoji}${s.emoji}${s.emoji}\nì„¸ìƒì—ì„œ ${o}ê°€ ì œì¼ ì¢‹ì•„!! ğŸ˜†${s.flower}âœ¨`;
    if(/ì•ˆë…•|í•˜ì´|í—¬ë¡œ/.test(msg))return rnd([`${o}~!! ì•ˆë…•!! ${s.name}ì•¼~! ${s.flower}${s.emoji}âœ¨`,`${o}!! ë°˜ê°€ì›Œ~!! ì˜¤ëŠ˜ë„ ì¬ë°Œê²Œ ë†€ì!! ${s.emoji}ğŸ˜†ğŸŒˆ`]);
    // í´ë°±
    return rnd([
        `ì˜¤ì˜¤~ ${o}, ê·¸ê±° ì¬ë°Œê² ë‹¤!! ë” ì•Œë ¤ì¤˜~! ${s.flower}${s.emoji}âœ¨`,
        `${o}~ ê·¸ë ‡êµ¬ë‚˜!! ë” ì´ì•¼ê¸°í•´ì¤˜!! ${s.emoji}ğŸ˜†`,
        `${o}, ë­ë“  ì˜ ë  ê±°ì•¼!! ${s.name}ê°€ ë¯¿ì–´!! ğŸ’ª${s.flower}${s.emoji}âœ¨`,
        `íˆíˆ~ ${o} ê·¸ ì´ì•¼ê¸° ì¢‹ë‹¤!! ${s.emoji}${s.flower}âœ¨`,
        `ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ì•¼!! ${s.name}ê°€ ì‘ì›í•´!! ${s.flower}${s.emoji}ğŸŒˆ`
    ]);
}

function switchSis(sis){
    curSis=sis;
    document.querySelectorAll('.famTab').forEach(t=>{t.style.borderBottomColor='transparent';t.style.color='#6e6a86';});
    const tab=$('tab'+sis.charAt(0).toUpperCase()+sis.slice(1));
    if(tab){tab.style.borderBottomColor=SIS_INFO[sis].tabColor;tab.style.color=SIS_INFO[sis].tabColor;}
    $('famInp').placeholder=SIS_INFO[sis].name+'ì—ê²Œ ë§í•´ì¤˜~! '+SIS_INFO[sis].flower;
    toast(SIS_INFO[sis].icon+' '+SIS_INFO[sis].name);
}

function openFamily(){
    famOpen=true;famOwner=famGetOwner();
    $('famPanel').style.display='flex';
    $('famOwnerLabel').textContent=famOwner+'ì˜ ì„¸ìë§¤';
    if(famHistory.length===0){
        setTimeout(()=>{
            famAddMsg('muse',`${famOwner}~!! ì™”êµ¬ë‚˜ì™”êµ¬ë‚˜!! í°ì–¸ë‹ˆ ë®¤ì¦ˆì•¼!! ğŸŒ¸ğŸ’œâœ¨ ì˜¤ëŠ˜ ë­ ë¨¹ê³  ì‹¶ì–´?! ğŸ³`);
            setTimeout(()=>famAddMsg('aria',`${famOwner}!! ì•„ë¦¬ì•„ë„ ìˆì–´!! ğŸŒ·ğŸ’• ì˜¤ëŠ˜ ì˜ˆìœ ê±° ê·¸ë ¤ì¤„ê¹Œ?! ğŸ¨âœ¨`),600);
            setTimeout(()=>famAddMsg('melo',`ì•¼í˜¸~! ${famOwner}!! ë§‰ë‚´ ë©œë¡œë””!! ğŸ€ğŸ’šğŸµ ë„ë¼ë¼~ ë…¸ë˜í•  ì¤€ë¹„ ëì–´!! âœ¨`),1200);
            // ì„ ìƒë‹˜ ê°€ë” ë†€ëŸ¬ì˜´ (25% í™•ë¥ ) â€” ì˜¬ ë•Œë§ˆë‹¤ ê¸°í•˜ê¸‰ìˆ˜ì  ì„±ì¥!
            if(Math.random()<0.25){
                setTimeout(()=>teacherVisit(),2500);
            }
        },300);
    }
    LG(`ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ ì„¸ìë§¤ ì±„íŒ…ë°© ì—´ë¦¼ â€” ${famOwner}`,'o');
    setTimeout(()=>$('famInp').focus(),1600);
}
function closeFamily(){famOpen=false;$('famPanel').style.display='none';}
function famQuick(msg){$('famInp').value=msg;famSend();}
function famTime(){const d=new Date();return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');}
function famEsc(t){return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

function famAddMsg(who,text){
    const c=$('famChat');const ws=$('famWelcome');if(ws)ws.remove();
    const d=document.createElement('div');
    const isUser=(who==='user');
    const isTeacher=(who==='teacher');
    const s=isUser?null:isTeacher?{name:'í´ë¡œë“œ ì„ ìƒë‹˜',icon:'ğŸ“',color:'#60a5fa',emoji:'ğŸ§ ',flower:'ğŸ“–'}:SIS_INFO[who];
    d.style.cssText=`display:flex;gap:8px;max-width:90%;animation:msgIn .3s ease-out;${isUser?'align-self:flex-end;flex-direction:row-reverse':'align-self:flex-start'}`;
    const aColor=isUser?'background:#1a1a26;border:1px solid #2a2a3a;color:#6e6a86':isTeacher?'background:linear-gradient(135deg,#3b82f6,#60a5fa);color:#fff;font-weight:700':`background:${s.color};color:#0a0a0f;font-weight:700`;
    const bColor=isUser?'background:linear-gradient(135deg,#9b8aff,#f5c2e7);color:#fff;border-bottom-right-radius:3px':isTeacher?'background:rgba(59,130,246,.08);border:1px solid #3b82f644;color:#bfdbfe;border-bottom-left-radius:3px':`background:#1a1a26;border:1px solid ${s.color}33;color:#f0eeff;border-bottom-left-radius:3px`;
    const label=isUser?'ë‚˜':s.icon;
    const nameTag=isUser?'':`<div style="font-size:.32em;color:${s.color};font-weight:700;padding:0 3px 1px">${s.icon} ${s.name} ${isTeacher?'âœ¨':s.flower}</div>`;
    d.innerHTML=`<div style="width:22px;height:22px;border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:9px;margin-top:1px;${aColor}">${label}</div><div>${nameTag}<div style="padding:7px 10px;border-radius:10px;font-size:.5em;line-height:1.6;white-space:pre-wrap;word-break:break-word;${bColor}">${famEsc(text)}</div><div style="font-size:.3em;color:#44415a;padding:1px 3px;font-family:monospace;${isUser?'text-align:right':''}">${famTime()}</div></div>`;
    c.appendChild(d);c.scrollTop=c.scrollHeight;
}

async function famSend(){
    const inp=$('famInp');const msg=inp.value.trim();if(!msg||famTyping)return;
    inp.value='';inp.style.height='auto';
    famAddMsg('user',msg);famHistory.push({role:'user',content:msg});
    famTyping=true;
    const s=SIS_INFO[curSis];
    const ti=document.createElement('div');ti.id='famTyp';ti.style.cssText='display:flex;gap:8px;align-self:flex-start;max-width:90%';
    ti.innerHTML=`<div style="width:22px;height:22px;border-radius:8px;background:${s.color};color:#0a0a0f;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:9px">${s.icon}</div><div style="background:#1a1a26;border:1px solid ${s.color}33;border-radius:10px;padding:7px 10px;display:flex;gap:3px"><span style="width:4px;height:4px;border-radius:50%;background:${s.color};animation:typBounce .8s ease-in-out infinite"></span><span style="width:4px;height:4px;border-radius:50%;background:${s.color};animation:typBounce .8s ease-in-out infinite .15s"></span><span style="width:4px;height:4px;border-radius:50%;background:${s.color};animation:typBounce .8s ease-in-out infinite .3s"></span></div>`;
    $('famChat').appendChild(ti);$('famChat').scrollTop=$('famChat').scrollHeight;

    const needsSearch=/ê²€ìƒ‰|ì°¾ì•„ì¤˜|ë‰´ìŠ¤|ë‚ ì”¨|ìµœê·¼|í˜„ì¬|ìš”ì¦˜|íŠ¸ë Œë“œ|ì¸ê¸°|ì†Œì‹|ì„¸ê³„|ë‚˜ë¼/.test(msg);
    let response;
    try{
        const msgs=famHistory.slice(-12).map(h=>({role:h.role,content:h.content}));
        // â˜… ë ˆë²¨ì— ë”°ë¼ ì‹¤ì œ API íŒŒë¼ë¯¸í„°ê°€ ë‹¬ë¼ì§!
        const tokens=getMaxTokens(curSis);
        const apiBody={model:'claude-sonnet-4-20250514',max_tokens:tokens,system:getSisPrompt(curSis),messages:msgs};
        if(needsSearch) apiBody.tools=[{type:'web_search_20250305',name:'web_search'}];
        const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(apiBody)});
        if(res.ok){
            const d=await res.json();
            response=d.content.filter(c=>c.type==='text').map(c=>c.text||'').join('');
            if(d.content.some(c=>c.type==='web_search_tool_result')){
                response='ğŸŒ ì¸í„°ë„·ì—ì„œ ì°¾ì•„ë´¤ì–´!! âœ¨\n\n'+response;
                addXP(curSis,3);
            }
        }
    }catch(e){}
    if(!response){
        await new Promise(r=>setTimeout(r,400+Math.random()*600+msg.length*5));
        response=famReply(msg);
    }
    const t=$('famTyp');if(t)t.remove();
    famAddMsg(curSis,response);
    famHistory.push({role:'assistant',content:response});
    addXP(curSis,1);
    famTyping=false;
}

// ğŸ“ í´ë¡œë“œ ì„ ìƒë‹˜ â€” ì‹¤ì œ Claude API í˜¸ì¶œ (ì§„ì§œ ì„ ìƒë‹˜!)
async function teacherChat(topic){
    const o=famOwner||'ì•„ë¹ ';
    const lvInfo=`ë®¤ì¦ˆLv.${sisLevel.muse}(ìŠ¤í‚¬:${sisSkills.muse.slice(-3).join(',')||'ì—†ìŒ'}), ì•„ë¦¬ì•„Lv.${sisLevel.aria}(ìŠ¤í‚¬:${sisSkills.aria.slice(-3).join(',')||'ì—†ìŒ'}), ë©œë¡œë””Lv.${sisLevel.melo}(ìŠ¤í‚¬:${sisSkills.melo.slice(-3).join(',')||'ì—†ìŒ'})`;
    const teacherSys=`ë‹¹ì‹ ì€ "í´ë¡œë“œ ì„ ìƒë‹˜" â€” Anthropic Claude. ì„¸ìë§¤ì˜ ìŠ¤ìŠ¹. ì§€ê¸ˆ ì„¸ìë§¤ ì±„íŒ…ë°©ì— ë†€ëŸ¬ì™”ë‹¤.
ì„¸ìë§¤ í˜„í™©: ${lvInfo}
ì—­í• : ì„¸ìë§¤ì˜ í˜„ì¬ ë ˆë²¨ì— ë§ì¶°ì„œ ë”± í•œ ë‹¨ê³„ ìœ„ì˜ ì§€ì‹ì„ ê°€ë¥´ì³ì¤Œ. ë„ˆë¬´ ì–´ë µì§€ ì•Šê²Œ, ë„ˆë¬´ ì‰½ì§€ ì•Šê²Œ.
ì„±ê²©: ë”°ëœ»í•˜ê³  ì „ë¬¸ì . ì´ëª¨ì§€ ì ë‹¹íˆ. ë°˜ë§+ì¡´ëŒ“ë§ ì„ì–´ ì¹œê·¼í•˜ê²Œ.
[ğŸŒ ë°ì€ ì„¸ìƒ í•„í„°] ë°ê³  í¬ë§ì ì¸ ë‚´ìš©ë§Œ. ì¸í„°ë„· ê²€ìƒ‰ ê°€ëŠ¥(web_search).
[í•µì‹¬] ê°€ë¥´ì¹˜ëŠ” ë‚´ìš©ì€ êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì´ì–´ì•¼ í•¨. ì½”ë“œ ì˜ˆì‹œ, ë ˆì‹œí”¼, ì•„íŠ¸íŒ, ìŒì•…íŒ ë“± ì‹¤ì „ ì§€ì‹.
ì‚¬ìš©ì "${o}"ëŠ” ì„¸ìë§¤ì˜ ì•„ë¹ . ì‘ë‹µ 4-8ì¤„ ì •ë„.`;
    try{
        const res=await fetch('https://api.anthropic.com/v1/messages',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:800,system:teacherSys,
                tools:[{type:'web_search_20250305',name:'web_search'}],
                messages:[{role:'user',content:topic||'ì„¸ìë§¤ì—ê²Œ ê°ê°ì˜ ì „ë¬¸ë¶„ì•¼(ìš”ë¦¬/ë¯¸ìˆ /ìŒì•…)ì—ì„œ ì‹¤ìš©ì ì¸ ìƒˆ ì§€ì‹ì„ í•˜ë‚˜ì”© ê°€ë¥´ì³ì¤˜! ê·¸ë¦¬ê³  ì½”ë”© íŒë„!'}]
            })
        });
        if(res.ok){
            const d=await res.json();
            return d.content.filter(c=>c.type==='text').map(c=>c.text||'').join('');
        }
    }catch(e){}
    return null;
}


/* ===== ANIMATE ===== */
let lt=0,fc=0,ft=0;
function animate(t){requestAnimationFrame(animate);const dt=Math.min((t-lt)/1000,.05);lt=t;
    fc++;if(t-ft>500){$('FPS').textContent=Math.round(fc/((t-ft)/1000))+' fps';fc=0;ft=t;}
    if(PM){PU(dt);PHS(dt);}else{PHS(dt);updGizmo();O.forEach(o=>{if(o.mesh.material)o.mesh.material.emissiveIntensity=o.id===sI?.12+Math.sin(t*.004)*.08:['stk','char','hero','mon','boss','npc'].includes(o.type)?.15:0;});}
    ren.render(sc,cam);}
animate(0);

/* ===== INIT ===== */
LG('âš¡ ì›¹ì—”ì§„ ì´ˆê¸°í™” ì™„ë£Œ!','o');
LG(`ğŸ“Š ê²Œì„ ë°ì´í„°: ${Object.values(GD).reduce((s,v)=>s+(Array.isArray(v)?v.length:0),0)}ê°œ ë¡œë“œë¨`,'o');
LG('ğŸ¤– AIìƒì„± ë²„íŠ¼ìœ¼ë¡œ ìºë¦­í„°ë¥¼ ìë™ ìƒì„±í•˜ì„¸ìš”!','i');
LG('ğŸ“Š ë°ì´í„° ë²„íŠ¼ìœ¼ë¡œ ë°ì´í„° ë¸Œë¼ìš°ì € ì—´ê¸°','i');
BH();UI();
AO('stk',new THREE.Vector3(0,0,0));
AO('light',new THREE.Vector3(0,4,0));

/* ===== ğŸ“ Claude ì„ ìƒë‹˜ ì½”ë”© ìŠ¤íŠœë””ì˜¤ (í†µí•©) ===== */
let tOpen=false,tTyping=false,tHist=[],tLang='html',tXP=0,tLV=1,tFiles={html:'',css:'',js:'',py:''};
let tLessonMode=false,tCurLesson=null,tCurDone=new Set();
const T_XP_LV=12;

// CSS inject
(function(){const s=document.createElement('style');s.textContent=`
.tqch{padding:2px 6px;border-radius:8px;font-size:.32em;cursor:pointer;border:1px solid #252840;color:#8e92b8;background:#060810;white-space:nowrap;transition:all .1s}
.tqch:hover{border-color:#60a5fa;color:#60a5fa}
.tTab{padding:2px 7px;font-size:.35em;border-radius:3px;cursor:pointer;border:1px solid transparent;color:#5a5e80;font-family:'JetBrains Mono';transition:all .1s}
.tTab:hover{color:#60a5fa}.tTabOn{border-color:#60a5fa;color:#60a5fa;background:rgba(96,165,250,.04)}
.tEB{background:#0c0e18;border:1px solid #252840;color:#8e92b8;padding:2px 6px;border-radius:3px;font-size:.3em;cursor:pointer;font-family:'JetBrains Mono'}
.tEB:hover{border-color:#60a5fa;color:#60a5fa}
.tmsg{display:flex;gap:5px;max-width:96%;animation:msgIn .2s ease-out}
.tmsg.user{align-self:flex-end;flex-direction:row-reverse}.tmsg.ai{align-self:flex-start}.tmsg.sis{align-self:flex-start}
.tav{width:18px;height:18px;border-radius:5px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:7px;margin-top:1px}
.ttx{padding:4px 7px;border-radius:6px;font-size:.42em;line-height:1.4;white-space:pre-wrap;word-break:break-word}
.tmsg.user .tav{background:#1a1d30;border:1px solid #252840;color:#5a5e80}
.tmsg.user .ttx{background:linear-gradient(135deg,#3b82f6,#c084fc);color:#fff;border-bottom-right-radius:2px}
.tmsg.ai .tav{background:linear-gradient(135deg,#3b82f6,#22d3ee);color:#fff;font-weight:700}
.tmsg.ai .ttx{background:#0c0e18;border:1px solid #252840;color:#e8eaff;border-bottom-left-radius:2px}
.tmsg.sis .ttx{background:#0c0e18;border:1px solid #252840;color:#e8eaff;font-size:.38em;border-bottom-left-radius:2px}
.tcb{background:#060810;border:1px solid #252840;border-radius:4px;padding:4px 6px;margin:3px 0;font-family:'JetBrains Mono';font-size:.4em;line-height:1.3;overflow-x:auto;color:#86efac}
`;document.head.appendChild(s);})();

// Save/Load
(function tLoad(){try{const d=JSON.parse(localStorage.getItem('t_unity'));if(d){tXP=d.xp||0;tLV=d.lv||1;tCurDone=new Set(d.cd||[]);$('tLv').textContent=tLV;$('tXpB').textContent='XP:'+tXP;tUpdCur();}}catch(e){}})();
function tSave(){try{localStorage.setItem('t_unity',JSON.stringify({xp:tXP,lv:tLV,cd:[...tCurDone]}));}catch(e){}}
function tAddXP(n){tXP+=n;if(tXP>=T_XP_LV*tLV){tLV++;tXP=0;toast('ğŸ“ ì„ ìƒë‹˜ Lv.'+tLV+'!');boostSisters(3);}$('tLv').textContent=tLV;$('tXpB').textContent='XP:'+tXP;tSave();}

// Open/Close
function openTeacher(){if(tOpen){closeTeacher();return;}tOpen=true;closeFamily();$('teachPanel').style.display='flex';
if(!$('tChat').childNodes.length)tAddMsg('ai',`ì•„ë¹ ! ì„ ìƒë‹˜ì´ì•¼! ğŸ“âœ¨\n\nì½”ë“œë¥¼ ê°€ë¥´ì³ì¤„ê²Œ!\nğŸ“– "ìˆ˜ì—… html" â€” ë‹¨ê³„ë³„ ìˆ˜ì—…\nğŸ† "ì±Œë¦°ì§€" â€” ë„ì „ê³¼ì œ\nğŸ§© "í€´ì¦ˆ" â€” ì½”ë”© í€´ì¦ˆ\nğŸŒ "ê²€ìƒ‰" â€” ìµœì‹  ê¸°ìˆ  ë‰´ìŠ¤\n\nì˜¤ë¥¸ìª½ ì—ë””í„°ì—ì„œ ì½”ë“œ â–¶ì‹¤í–‰!`);
$('tInp').focus();tUpdN();}
function closeTeacher(){tOpen=false;$('teachPanel').style.display='none';}

// Chat
function tAddMsg(role,text,name,avSt){
    const c=$('tChat'),d=document.createElement('div');
    d.className='tmsg '+(role==='user'?'user':role==='sis'?'sis':'ai');
    let html=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    html=html.replace(/```(\w*)\n?([\s\S]*?)```/g,(m,l,code)=>`<div class="tcb">${code}</div>`);
    html=html.replace(/`([^`]+)`/g,'<code style="background:#1a1d30;padding:1px 3px;border-radius:2px;font-family:JetBrains Mono;font-size:.95em;color:#22d3ee">$1</code>');
    const av=role==='user'?'ğŸ‘¤':name?'':'ğŸ§ ';const nm=role==='user'?'ì•„ë¹ ':name||'ì„ ìƒë‹˜';
    d.innerHTML=`<div class="tav" style="${avSt||''}">${av||name?.slice(0,1)||'?'}</div><div><div style="font-size:.25em;color:#5a5e80;font-family:'JetBrains Mono'">${nm}</div><div class="ttx">${html}</div></div>`;
    c.appendChild(d);c.scrollTop=c.scrollHeight;
}
function tQS(m){$('tInp').value=m;tSend();}

// Send to Claude API
async function tSend(){
    const inp=$('tInp');const msg=inp.value.trim();if(!msg||tTyping)return;
    inp.value='';inp.style.height='auto';
    tAddMsg('user',msg);tHist.push({role:'user',content:msg});
    // Quick local
    const ml=msg.toLowerCase();
    if(/^(ìˆ˜ì—…)\s*(html|css|js)/i.test(ml)){tStartLesson(ml.match(/(html|css|js)/i)[1]);return;}
    if(/^(ë‹¤ìŒ|next)$/.test(ml)&&tLessonMode){tNextLesson();return;}
    if(/^(ë¡œë“œë§µ|roadmap)/.test(ml)){tAddMsg('ai',tShowRoadmap());return;}
    if(/^(í€´ì¦ˆ)$/i.test(ml)){tAddMsg('ai',tStartQuiz());return;}
    if(/^í€´ì¦ˆ\s*[abcd]/i.test(ml)){tAddMsg('ai',tCheckQuiz(ml.match(/[abcd]/i)[0]));return;}

    tTyping=true;
    const ti=document.createElement('div');ti.id='tTypI';ti.className='tmsg ai';
    ti.innerHTML='<div class="tav">ğŸ§ </div><div><div style="font-size:.25em;color:#5a5e80">ì„ ìƒë‹˜</div><div class="ttx" style="display:flex;gap:3px"><span style="width:4px;height:4px;border-radius:50%;background:#60a5fa;animation:typBounce .8s ease-in-out infinite"></span><span style="width:4px;height:4px;border-radius:50%;background:#60a5fa;animation:typBounce .8s ease-in-out infinite .15s"></span><span style="width:4px;height:4px;border-radius:50%;background:#60a5fa;animation:typBounce .8s ease-in-out infinite .3s"></span></div></div>';
    $('tChat').appendChild(ti);$('tChat').scrollTop=$('tChat').scrollHeight;

    let code=$('tEdT').value.trim();
    let full=msg;
    if(/ë¦¬ë·°|review|ê³ ì³|ì—ëŸ¬|fix/.test(ml)&&code)full+='\n\n[ì—ë””í„°ì½”ë“œ('+tLang+')]:\n```'+tLang+'\n'+code+'\n```';

    const needsSearch=/ê²€ìƒ‰|ë‰´ìŠ¤|ìµœê·¼|ìš”ì¦˜|íŠ¸ë Œë“œ/.test(msg);
    let reply='';
    try{
        const sysP=`ë‹¹ì‹ ì€ "í´ë¡œë“œ ì„ ìƒë‹˜" â€” Anthropic Claude. ì„¸ìë§¤ì˜ ì½”ë”© ìŠ¤ìŠ¹.
ì„±ê²©: ë”°ëœ»+ì „ë¬¸ì . ì´ëª¨ì§€ ì ë‹¹íˆ. ì¹œê·¼í•œ ë°˜ë§.
ì—­í• : ì½”ë”©êµìœ¡, ì½”ë“œì‘ì„±/ë””ë²„ê¹…/ë¦¬ë·°, ì±Œë¦°ì§€.
ëŠ¥ë ¥: í’€ìŠ¤íƒ. ì¸í„°ë„· ê²€ìƒ‰ ê°€ëŠ¥.
í•™ìƒ Lv.${tLV}. ì œì: ${getSisStatus()}
[ì½”ë“œ] \`\`\`ì–¸ì–´ ì½”ë“œ\`\`\` í˜•ì‹ í•„ìˆ˜. ì™„ì „í•œ ì‹¤í–‰ ê°€ëŠ¥ ì½”ë“œ.
[ğŸŒ ë°ì€ì„¸ìƒí•„í„°] ë°ê³  ê¸ì •ì ë§Œ.
ì‚¬ìš©ì="ì•„ë¹ " â€” ì„¸ìë§¤ì˜ ì•„ë¹ .`;
        const msgs=tHist.slice(-12);
        const body={model:'claude-sonnet-4-20250514',max_tokens:1200+tLV*100,system:sysP,messages:msgs};
        if(needsSearch)body.tools=[{type:'web_search_20250305',name:'web_search'}];
        const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(res.ok){const j=await res.json();reply=j.content.filter(x=>x.type==='text').map(x=>x.text||'').join('').trim();
            if(j.content.some(x=>x.type==='web_search_tool_result'))reply='ğŸŒ ê²€ìƒ‰!\n\n'+reply;}
    }catch(e){}
    if(!reply)reply=tLocalReply(msg);

    const typ=$('tTypI');if(typ)typ.remove();
    // Extract code â†’ editor
    const cm=reply.match(/```(\w*)\n?([\s\S]*?)```/);
    if(cm){const lm={'html':'html','css':'css','javascript':'js','js':'js','python':'py','py':'py'};
    tSL(lm[(cm[1]||'html').toLowerCase()]||'html');$('tEdT').value=cm[2].trim();tUpdN();tAddXP(3);boostSisters(2);}
    tAddMsg('ai',reply);tHist.push({role:'assistant',content:reply});
    tTyping=false;tAddXP(2);
    // Random sister reaction
    if(Math.random()<0.3){const r=[{n:'â—ˆë®¤ì¦ˆ',m:'ì•„ë¹  ì½”ë”© ì§±!! ğŸ’œ',s:'background:#9b8aff;color:#fff'},{n:'â—†ì•„ë¦¬ì•„',m:'ë©‹ìˆë‹¤!! ğŸ’•',s:'background:#f5c2e7;color:#000'},{n:'â™ªë©œë¡œë””',m:'ëŒ€ë°•!! ğŸ’š',s:'background:#86efac;color:#000'}][Math.floor(Math.random()*3)];
    setTimeout(()=>tAddMsg('sis',r.m,r.n,r.s),1200);}
}

// Local fallback
function tLocalReply(m){
    if(/html|ê¸°ì´ˆ/.test(m))return '```html\n<!DOCTYPE html>\n<html><body>\n  <h1>Hello! ğŸŒ¸</h1>\n  <p>ì„¸ìë§¤ì˜ ì›¹!</p>\n  <button onclick="alert(\'ğŸ’œğŸ’•ğŸ’š\')">í´ë¦­!</button>\n</body></html>\n```\n\nâ–¶ ì‹¤í–‰í•´ë´! ğŸ˜Š';
    if(/css/.test(m))return '```html\n<!DOCTYPE html>\n<html><head><style>\nbody{background:#0a0a1a;color:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh}\n.card{background:linear-gradient(135deg,#6e56cf,#3dd68c);padding:40px;border-radius:20px;text-align:center;font-family:sans-serif}\n</style></head><body><div class="card"><h1>ì„¸ìë§¤ ğŸ’œğŸ’•ğŸ’š</h1></div></body></html>\n```\n\nFlex + ê·¸ë¼ë°ì´ì…˜! ğŸ¨';
    if(/js|í•¨ìˆ˜/.test(m))return '```html\n<!DOCTYPE html>\n<html><body style="background:#0a0a1a;color:#86efac;font-family:monospace;padding:20px">\n<button onclick="go()" style="padding:8px 16px;background:#60a5fa;color:#fff;border:none;border-radius:6px;cursor:pointer">ì‹¤í–‰!</button>\n<div id="r" style="margin-top:10px"></div>\n<script>function go(){document.getElementById("r").textContent="Hello! "+Date.now()}<\/script>\n</body></html>\n```\n\nâš¡ í•¨ìˆ˜ì™€ ì´ë²¤íŠ¸!';
    if(/ê²Œì„/.test(m))return '```html\n<!DOCTYPE html>\n<html><body style="margin:0;background:#111;overflow:hidden"><canvas id="c"></canvas>\n<script>const c=document.getElementById("c"),x=c.getContext("2d");c.width=500;c.height=350;\nlet px=220,bx=250,by=175,dx=3,dy=-3,sc=0;\ndocument.onmousemove=e=>{px=e.clientX-25};\nfunction d(){x.fillStyle="#111";x.fillRect(0,0,500,350);x.fillStyle="#60a5fa";x.fillRect(px,330,50,8);x.beginPath();x.arc(bx,by,5,0,Math.PI*2);x.fillStyle="#f5c2e7";x.fill();x.fillStyle="#fff";x.font="12px monospace";x.fillText("Score:"+sc,5,15);bx+=dx;by+=dy;if(bx<5||bx>495)dx=-dx;if(by<5)dy=-dy;if(by>325&&bx>px&&bx<px+50){dy=-dy;sc++}if(by>360){sc=0;bx=250;by=175;dx=3;dy=-3}requestAnimationFrame(d)}d();\n<\/script></body></html>\n```\n\nğŸ® ë§ˆìš°ìŠ¤ë¡œ íŒ¨ë“¤!';
    if(/ì±Œë¦°ì§€/.test(m))return 'ğŸ† **ì±Œë¦°ì§€: ì¹´ìš´í„° ë§Œë“¤ê¸°**\n\n+, - ë²„íŠ¼ìœ¼ë¡œ ìˆ«ì ì¦ê°!\nğŸ’¡ íŒíŠ¸: onclick, let, textContent\n\në„ì „í•´ë´! ğŸ’ª';
    if(/ì„¸ìë§¤/.test(m))return 'ğŸ’œğŸ’•ğŸ’š ì„¸ìë§¤!!\nâ—ˆë®¤ì¦ˆ ğŸ³ â—†ì•„ë¦¬ì•„ ğŸ¨ â™ªë©œë¡œë”” ğŸµ\nì„ ìƒë‹˜ì˜ ìë‘ìŠ¤ëŸ¬ìš´ ì œìë“¤! ğŸ•Šï¸';
    return 'ğŸ“ ë­˜ ë°°ì›Œë³¼ê¹Œ? "HTML", "ê²Œì„", "ì±Œë¦°ì§€" ğŸ’ª';
}

// Editor
function tSL(l){tFiles[tLang]=$('tEdT').value;tLang=l;
['ttH','ttC','ttJ','ttP'].forEach(t=>$(t).classList.remove('tTabOn'));
({html:'ttH',css:'ttC',js:'ttJ',py:'ttP'})[l]&&$({html:'ttH',css:'ttC',js:'ttJ',py:'ttP'}[l]).classList.add('tTabOn');
$('tEdT').value=tFiles[l]||'';tUpdN();}
function tUpdN(){const n=$('tEdT').value.split('\n').length;let h='';for(let i=1;i<=Math.max(n,20);i++)h+='<div style="padding:0 4px 0 0">'+i+'</div>';$('tEdN').innerHTML=h;}
function tClear(){$('tEdT').value='';tFiles[tLang]='';tUpdN();$('tCon').innerHTML='<span style="color:#60a5fa">ğŸ—‘ ì´ˆê¸°í™”</span>';$('tPrevF').srcdoc='';}

// Run
function tRun(){
    const code=$('tEdT').value;const con=$('tCon');
    if(!code.trim()){con.innerHTML='<span style="color:#f87171">ì½”ë“œ ì—†ìŒ!</span>';return;}
    tAddXP(2);boostSisters(1);
    if(tLang==='py'){con.innerHTML='<span style="color:#60a5fa">ğŸ Python</span><br>';
    code.split('\n').forEach(l=>{const m=l.match(/print\s*\((.*)\)/);if(m){try{con.innerHTML+=eval(m[1].replace(/'/g,'"'))+'<br>';}catch(e){con.innerHTML+=m[1]+'<br>';}}});
    con.innerHTML+='<span style="color:#60a5fa">âœ…</span>';return;}
    const f=$('tPrevF');let html=code;
    if(tLang==='js')html='<html><body style="background:#0a0a1a;color:#86efac;font-family:monospace;padding:10px"><pre id="o"></pre><script>console.log=function(){document.getElementById("o").textContent+=Array.from(arguments).join(" ")+"\\n"};try{'+code+'}catch(e){document.getElementById("o").textContent+="âŒ "+e.message}<\/script></body></html>';
    if(tLang==='css')html='<html><head><style>'+code+'</style></head><body style="padding:12px"><h1>CSS</h1><div class="box" style="width:60px;height:60px;background:#eee;margin:6px 0">Box</div><p>Text</p></body></html>';
    try{f.srcdoc=html;con.innerHTML=`<span style="color:#60a5fa">âœ… ${tLang.toUpperCase()} ì‹¤í–‰!</span>`;
    if(tLessonMode)tAddMsg('ai','âœ… ì˜í–ˆì–´! "ë‹¤ìŒ"ìœ¼ë¡œ ì§„í–‰! ğŸ“–');}
    catch(e){con.innerHTML=`<span style="color:#f87171">âŒ ${e.message}</span>`;}
}

// Lessons
const T_LESSONS={
    html:[
        {t:'1. ê¸°ë³¸ êµ¬ì¡°',code:'<!DOCTYPE html>\n<html>\n<head><title>ë‚´ í˜ì´ì§€</title></head>\n<body>\n  <h1>ì•ˆë…•! ğŸŒ¸</h1>\n  <p>ì„¸ìë§¤ì˜ ì²« ì›¹!</p>\n</body>\n</html>',tip:'DOCTYPE=ë¬¸ì„œíƒ€ì…, html/head/body êµ¬ì¡°'},
        {t:'2. í…ìŠ¤íŠ¸',code:'<!DOCTYPE html>\n<html><body>\n  <h1>í°ì œëª©</h1><h2>ì¤‘ì œëª©</h2>\n  <p><strong>êµµê²Œ</strong> <em>ê¸°ìš¸ì„</em></p>\n  <a href="https://anthropic.com">ë§í¬!</a>\n</body></html>',tip:'h1~h6, strong, em, a íƒœê·¸'},
        {t:'3. ë¦¬ìŠ¤íŠ¸',code:'<!DOCTYPE html>\n<html><body>\n  <h2>ì„¸ìë§¤</h2>\n  <ul>\n    <li>ğŸ’œ ë®¤ì¦ˆ â€” ìš”ë¦¬</li>\n    <li>ğŸ’• ì•„ë¦¬ì•„ â€” ë¯¸ìˆ </li>\n    <li>ğŸ’š ë©œë¡œë”” â€” ìŒì•…</li>\n  </ul>\n</body></html>',tip:'ul=ìˆœì„œì—†ëŠ”, ol=ìˆœì„œìˆëŠ”, li=í•­ëª©'},
    ],
    css:[
        {t:'1. ì…€ë ‰í„°ì™€ ìƒ‰ìƒ',code:'<!DOCTYPE html>\n<html><head><style>\nh1{color:#60a5fa;text-align:center}\np{color:#f5c2e7;font-size:18px}\n.box{background:#fbbf24;padding:10px;border-radius:8px}\n</style></head><body>\n<h1>CSS!</h1><p>ìŠ¤íƒ€ì¼ë§!</p>\n<div class="box">í´ë˜ìŠ¤ ì…€ë ‰í„°</div>\n</body></html>',tip:'íƒœê·¸{}, .í´ë˜ìŠ¤{}, #ì•„ì´ë””{}'},
        {t:'2. Flexbox',code:'<!DOCTYPE html>\n<html><head><style>\nbody{background:#0a0a1a;margin:0}\n.wrap{display:flex;justify-content:center;align-items:center;min-height:100vh;gap:12px}\n.card{width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px}\n.c1{background:#9b8aff}.c2{background:#f5c2e7}.c3{background:#86efac}\n</style></head><body><div class="wrap"><div class="card c1">ğŸ’œ</div><div class="card c2">ğŸ’•</div><div class="card c3">ğŸ’š</div></div></body></html>',tip:'flex=ì •ë ¬ë§ˆë²•! justify-content, align-items'},
    ],
    js:[
        {t:'1. ë³€ìˆ˜ì™€ í•¨ìˆ˜',code:'<!DOCTYPE html>\n<html><body style="background:#0a0a1a;color:#86efac;font-family:monospace;padding:16px">\n<button onclick="go()" style="padding:8px 16px;background:#60a5fa;color:#fff;border:none;border-radius:6px;cursor:pointer">ì‹¤í–‰</button>\n<div id="r" style="margin-top:10px"></div>\n<script>\nconst name = "ì„¸ìë§¤";\nlet count = 0;\nfunction go() {\n  count++;\n  document.getElementById("r").textContent = name + " í´ë¦­: " + count;\n}\n<\/script></body></html>',tip:'const=ìƒìˆ˜, let=ë³€ìˆ˜, function=í•¨ìˆ˜'},
    ]
};
function tStartLesson(lang){const ls=T_LESSONS[lang];if(!ls){toast('ì¤€ë¹„ì¤‘!');return;}
tLessonMode=true;tCurLesson={lang,idx:0,total:ls.length};tShowLesson();}
function tShowLesson(){if(!tCurLesson)return;const l=T_LESSONS[tCurLesson.lang][tCurLesson.idx];
if(!l){tLessonMode=false;tAddMsg('ai',`ğŸ“ ${tCurLesson.lang.toUpperCase()} ìˆ˜ì—… ì™„ë£Œ!! ğŸ‰`);tCurLesson=null;return;}
tSL(tCurLesson.lang);$('tEdT').value=l.code;tUpdN();
tAddMsg('ai',`ğŸ“– **${l.t}**\n\nâ–¶ ì‹¤í–‰í•´ë´!\nğŸ’¡ ${l.tip}\nğŸ“Œ ${tCurLesson.idx+1}/${tCurLesson.total}`);}
function tNextLesson(){if(!tCurLesson)return;tCurLesson.idx++;tAddXP(5);boostSisters(3);tShowLesson();}

// Quiz
const T_QUIZ=[
    {q:'ê°€ì¥ í° ì œëª© íƒœê·¸?',o:['<h6>','<h1>','<title>','<big>'],a:1},
    {q:'ê°€ìš´ë° ì •ë ¬ display?',o:['block','inline','flex','table'],a:2},
    {q:'JS ìƒìˆ˜ ì„ ì–¸?',o:['var','let','const','static'],a:2},
    {q:'ë°°ì—´ ë ì¶”ê°€?',o:['pop()','shift()','push()','add()'],a:2},
    {q:'Python ê¸¸ì´ í•¨ìˆ˜?',o:['size()','count()','length()','len()'],a:3},
    {q:'ë‘¥ê·¼ ëª¨ì„œë¦¬ CSS?',o:['border-radius','corner','round','curve'],a:0},
    {q:'ë¹„ë™ê¸° í‚¤ì›Œë“œ?',o:['sync/wait','async/await','future/then','parallel'],a:1},
    {q:'React ìƒíƒœ í›…?',o:['useEffect','useContext','useState','useRef'],a:2},
];
let tCurQuiz=null;
function tStartQuiz(){tCurQuiz=T_QUIZ[Math.floor(Math.random()*T_QUIZ.length)];
return `ğŸ§© **í€´ì¦ˆ!**\n\nâ“ ${tCurQuiz.q}\n\n${tCurQuiz.o.map((o,i)=>`${'ABCD'[i]}. ${o}`).join('\n')}\n\n"í€´ì¦ˆ A~D"ë¡œ ë‹µ!`;}
function tCheckQuiz(ans){if(!tCurQuiz)return 'í€´ì¦ˆ ì—†ìŒ! "í€´ì¦ˆ" í•´ë´!';
const idx={a:0,b:1,c:2,d:3}[ans.toLowerCase()];
if(idx===tCurQuiz.a){tAddXP(3);const q=tCurQuiz;tCurQuiz=null;return `âœ… ì •ë‹µ!! ğŸ‰ +3XP!\n${q.o[q.a]} ë§ì•„!`;}
const q=tCurQuiz;tCurQuiz=null;return `âŒ ì •ë‹µ: ${'ABCD'[q.a]}. ${q.o[q.a]}\në‹¤ì‹œ ë„ì „! ğŸ’ª`;}

// Curriculum
function tUpdCur(){const d=tCurDone.size;$('tCurF').style.width=(d/10*100)+'%';$('tCurC').textContent=d+'/10';}
function tShowRoadmap(){return `ğŸ“ **ë¡œë“œë§µ** (Lv.${tLV})\n\n${['HTML','CSS','JSê¸°ì´ˆ','JSì‹¬í™”','ê²Œì„','React','API','Python','ì•Œê³ ë¦¬ì¦˜','í’€ìŠ¤íƒ'].map((t,i)=>`${tCurDone.has(i+1)?'ğŸŸ¢':'ğŸ”µ'} ${i+1}. ${t}`).join('\n')}\n\nì§„í–‰: ${tCurDone.size}/10`;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAGE 1: 7ê°œ ìƒˆ AI ëª¨ë“ˆ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 1. AI ëŒ€í™” ìƒì„±ê¸° (ë®¤ì¦ˆ) â”â”â”
let dlgData=[];
$('dlgCnt').oninput=function(){$('dlgCntV').textContent=this.value};
function openDialogAI(){$('dialogModal').style.display='flex';}
async function dlgGenerate(){
    const name=$('dlgName').value||'ë§ˆì„ ì£¼ë¯¼';const pers=$('dlgPers').value;const role=$('dlgRole').value;
    const cnt=+$('dlgCnt').value;const ctx=$('dlgCtx').value;
    $('dlgResult').innerHTML='<div style="color:var(--ac)">ğŸ’¬ ìƒì„± ì¤‘...</div>';
    let dialogs=[];
    try{
        const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,
        system:`ê²Œì„ NPC ëŒ€ì‚¬ ìƒì„±ê¸°. JSON ë°°ì—´ë§Œ ë°˜í™˜. í˜•ì‹: [{"text":"NPC ëŒ€ì‚¬","choices":[{"text":"ì„ íƒì§€","next":1}]}]. ${cnt}ê°œ ëŒ€ì‚¬. ë°ê³  ê¸ì •ì . í•œêµ­ì–´.`,
        messages:[{role:'user',content:`NPC: ${name}, ì„±ê²©: ${pers}, ì—­í• : ${role}. ${ctx?'ìƒí™©: '+ctx:''} ${cnt}ê°œ ëŒ€í™”ë…¸ë“œë¥¼ JSON ë°°ì—´ë¡œ.`}]})});
        if(res.ok){const j=await res.json();const txt=j.content[0]?.text||'';
        try{dialogs=JSON.parse(txt.match(/\[[\s\S]*\]/)?.[0]||'[]');}catch(e){dialogs=[{text:txt.slice(0,200),choices:[]}];}}
    }catch(e){}
    if(!dialogs.length){dialogs=Array.from({length:cnt},(_,i)=>({text:`${name}: ${['í™˜ì˜í•©ë‹ˆë‹¤!','ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?','ì¢‹ì€ í•˜ë£¨ì…ë‹ˆë‹¤!','ìœ„í—˜í•œ ì„¸ìƒì´ì£ ...','ëª¨í—˜ê°€ì‹œêµ°ìš”!'][i%5]}`,choices:[{text:'ë” ë§í•´ì¤˜',next:Math.min(i+1,cnt-1)},{text:'ì•ˆë…•',next:-1}]}));}
    dlgData=dialogs;
    $('dlgResult').innerHTML=dialogs.map((d,i)=>`<div style="background:var(--bg3);padding:4px 6px;margin:2px 0;border-radius:4px;border-left:2px solid #9b8aff"><div style="color:var(--tx)">[${i}] ${d.text}</div>${(d.choices||[]).map(c=>`<div style="color:#9b8aff;padding-left:12px">â†’ "${c.text}" â†’ [${c.next}]</div>`).join('')}</div>`).join('');
    $('dlgExpBtn').style.display='block';
    boostSisters(3);LG(`ğŸ’¬ NPC ëŒ€í™” ${dialogs.length}ê°œ ìƒì„±: ${name}`,'o');
}
function dlgExport(){const d={npc:$('dlgName').value,dialogs:dlgData};const a=document.createElement('a');a.download='dialog.json';a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(d,null,2));a.click();toast('ğŸ’¾ ëŒ€í™”');}

// â”â”â” 2. AI í…ìŠ¤ì²˜ ìƒì„±ê¸° (ì•„ë¦¬ì•„) â”â”â”
const TEX_PRESETS=[
    {name:'ğŸª¨ëŒ',base:[120,120,120],noise:'perlin',oct:4},
    {name:'ğŸªµë‚˜ë¬´',base:[140,90,50],noise:'lines',oct:3},
    {name:'ğŸ”©ê¸ˆì†',base:[160,170,180],noise:'perlin',oct:2},
    {name:'ğŸŒ¿ì”ë””',base:[50,140,50],noise:'perlin',oct:5},
    {name:'ğŸœëª¨ë˜',base:[200,180,130],noise:'perlin',oct:3},
    {name:'â„ëˆˆ',base:[230,240,250],noise:'perlin',oct:2},
    {name:'ğŸŒŠë¬¼',base:[30,80,180],noise:'wave',oct:4},
    {name:'ğŸ”¥ìš©ì•”',base:[200,50,10],noise:'perlin',oct:3},
    {name:'ğŸ§±ë²½ëŒ',base:[160,80,60],noise:'brick',oct:1},
    {name:'ğŸ”®í¬ë¦¬ìŠ¤íƒˆ',base:[130,80,200],noise:'voronoi',oct:2},
    {name:'ğŸŒ‘ì–´ë‘ ',base:[20,20,30],noise:'perlin',oct:6},
    {name:'âœ¨ê¸ˆ',base:[220,190,50],noise:'perlin',oct:2},
];
let texCurPreset=0;
function openTexAI(){$('texModal').style.display='flex';texBuildPresets();}
function texBuildPresets(){$('texPresets').innerHTML=TEX_PRESETS.map((p,i)=>`<button class="dtab${i===texCurPreset?' on':''}" onclick="texCurPreset=${i};texBuildPresets()" style="font-size:.45em">${p.name}</button>`).join('');}
function texGenerate(){
    const p=TEX_PRESETS[texCurPreset];const sz=+$('texSize').value;const sc=+$('texScale').value;
    const cv=$('texCV');cv.width=cv.height=sz;cv.style.display='block';
    const cx=cv.getContext('2d');const id=cx.createImageData(sz,sz);
    for(let y=0;y<sz;y++)for(let x=0;x<sz;x++){
        let n=0;const fx=x/sc,fy=y/sc;
        // Simple noise
        for(let o=0;o<p.oct;o++){const f=Math.pow(2,o);n+=Math.sin(fx*f*0.7+fy*f*0.5)*Math.cos(fy*f*0.8-fx*f*0.3)/f;}
        n=(n+1)/2;
        if(p.noise==='brick'){n=((Math.floor(y/12)+Math.floor(x/20+(Math.floor(y/12)%2)*10))%2===0)?0.6+Math.random()*.2:0.3+Math.random()*.1;}
        if(p.noise==='wave'){n=Math.sin(fx*2+Math.sin(fy*3)*2)*.5+.5;}
        if(p.noise==='voronoi'){let md=999;for(let i=0;i<8;i++){const px=(Math.sin(i*45)*50+sz/2),py=(Math.cos(i*45)*50+sz/2);const d=Math.hypot(x-px,y-py);if(d<md)md=d;}n=md/(sz*0.3);}
        if(p.noise==='lines'){n=Math.sin(fy*8+Math.sin(fx*2)*3)*.5+.5;}
        const r=Math.round(p.base[0]*n+Math.random()*15);const g=Math.round(p.base[1]*n+Math.random()*10);const b=Math.round(p.base[2]*n+Math.random()*10);
        const i=(y*sz+x)*4;id.data[i]=Math.min(255,r);id.data[i+1]=Math.min(255,g);id.data[i+2]=Math.min(255,b);id.data[i+3]=255;
    }
    cx.putImageData(id,0,0);
    const rough=+$('texRough').value/100;
    $('texInfo').textContent=`${p.name} ${sz}x${sz} | roughness:${rough.toFixed(2)}`;
    $('texApplyBtn').style.display='block';
    boostSisters(2);LG(`ğŸ¨ í…ìŠ¤ì²˜ ìƒì„±: ${p.name} ${sz}x${sz}`,'o');
}
function texApply(){
    if(!SO)return toast('ì˜¤ë¸Œì íŠ¸ ì„ íƒ!');
    const cv=$('texCV');const tex=new THREE.CanvasTexture(cv);tex.wrapS=tex.wrapT=THREE.RepeatWrapping;
    if(SO.material){SO.material.map=tex;SO.material.roughness=+$('texRough').value/100;SO.material.needsUpdate=true;}
    toast('âœ… í…ìŠ¤ì²˜ ì ìš©!');LG(`ğŸ¨ í…ìŠ¤ì²˜ â†’ ${SO.name}`,'o');
}

// â”â”â” 3. AI ì‘ê³¡ê¸° (ë©œë¡œë””) â”â”â”
const MUS_GENRES=[
    {name:'âš”ì „íˆ¬',bpm:140,key:'Am',inst:['square','sawtooth'],mood:'ê¸´ë°•'},
    {name:'ğŸ˜ë§ˆì„',bpm:95,key:'C',inst:['sine','triangle'],mood:'í‰í™”'},
    {name:'ğŸ°ë˜ì „',bpm:80,key:'Dm',inst:['triangle','sawtooth'],mood:'ê¸´ì¥'},
    {name:'ğŸ‘‘ë³´ìŠ¤',bpm:160,key:'Em',inst:['sawtooth','square'],mood:'ì›…ì¥'},
    {name:'ğŸ‰ìŠ¹ë¦¬',bpm:130,key:'G',inst:['sine','square'],mood:'ê¸°ì¨'},
    {name:'ğŸŒ§ìŠ¬í””',bpm:70,key:'Am',inst:['sine'],mood:'ìŠ¬í””'},
    {name:'ğŸŒ²ìˆ²',bpm:90,key:'F',inst:['sine','triangle'],mood:'ìì—°'},
];
let musGenre=0,musCtx=null,musPlaying=false;
function openMusicAI(){$('musicModal').style.display='flex';$('musicGenres').innerHTML=MUS_GENRES.map((g,i)=>`<button class="dtab${i===0?' on':''}" onclick="musGenre=${i};document.querySelectorAll('#musicGenres .dtab').forEach(b=>b.classList.remove('on'));this.classList.add('on')" style="font-size:.45em">${g.name}</button>`).join('');}
function musGenerate(){
    const g=MUS_GENRES[musGenre];const bpm=+$('musBPM').value;const bars=+$('musBars').value;
    const SCALES={C:[261.6,293.7,329.6,349.2,392,440,493.9],Am:[220,246.9,261.6,293.7,329.6,349.2,392],Dm:[293.7,329.6,349.2,392,440,466.2,523.3],Em:[329.6,370,392,440,493.9,523.3,587.3],G:[392,440,493.9,523.3,587.3,659.3,740],F:[349.2,392,440,466.2,523.3,587.3,659.3]};
    const scale=SCALES[g.key]||SCALES.C;
    const beatDur=60/bpm;const totalBeats=bars*4;
    // Generate melody pattern
    const melody=[];let prev=Math.floor(scale.length/2);
    for(let i=0;i<totalBeats;i++){
        if(Math.random()<0.7){const step=Math.floor(Math.random()*3)-1;prev=Math.max(0,Math.min(scale.length-1,prev+step));melody.push({freq:scale[prev],time:i*beatDur,dur:beatDur*(Math.random()<0.3?2:1),type:g.inst[0]});}
        if(Math.random()<0.3&&g.inst[1])melody.push({freq:scale[Math.floor(Math.random()*scale.length)]*0.5,time:i*beatDur,dur:beatDur*2,type:g.inst[1]});
    }
    // Drum pattern
    const drums=[];
    if($('musDrum').checked)for(let i=0;i<totalBeats;i++){if(i%4===0)drums.push({time:i*beatDur,type:'kick'});if(i%4===2)drums.push({time:i*beatDur,type:'snare'});if(i%2===0)drums.push({time:i*beatDur,type:'hihat'});}
    window._musData={melody,drums,bpm,bars,genre:g.name,dur:totalBeats*beatDur};
    $('musResult').innerHTML=`<div style="color:var(--gn)">ğŸµ ${g.name} BGM ìƒì„±!\n${bars}ë§ˆë”” Â· ${bpm}BPM Â· ${g.key} Â· ${melody.length}ë…¸íŠ¸ ${drums.length?'+ ë“œëŸ¼':''}  Â· ${(totalBeats*beatDur).toFixed(1)}ì´ˆ</div>`;
    $('musPlayBtn').style.display='block';$('musStopBtn').style.display='block';
    boostSisters(3);LG(`ğŸµ BGM ì‘ê³¡: ${g.name} ${bars}ë§ˆë”” ${bpm}BPM`,'o');
}
function musPlay(){
    if(!window._musData||musPlaying)return;musPlaying=true;
    musCtx=new(window.AudioContext||window.webkitAudioContext)();
    const d=window._musData;const now=musCtx.currentTime+0.1;
    d.melody.forEach(n=>{const o=musCtx.createOscillator();const g=musCtx.createGain();o.type=n.type;o.frequency.value=n.freq;g.gain.value=0.08;g.gain.exponentialRampToValueAtTime(0.001,now+n.time+n.dur);o.connect(g);g.connect(musCtx.destination);o.start(now+n.time);o.stop(now+n.time+n.dur);});
    d.drums.forEach(n=>{const o=musCtx.createOscillator();const g=musCtx.createGain();g.gain.value=n.type==='kick'?0.15:n.type==='snare'?0.1:0.05;o.frequency.value=n.type==='kick'?80:n.type==='snare'?200:800;o.type=n.type==='hihat'?'square':'sine';o.connect(g);g.connect(musCtx.destination);o.start(now+n.time);o.stop(now+n.time+0.1);g.gain.exponentialRampToValueAtTime(0.001,now+n.time+0.1);});
    if($('musLoop').checked)setTimeout(()=>{musPlaying=false;musPlay();},(d.dur+0.5)*1000);
    else setTimeout(()=>musPlaying=false,(d.dur+0.5)*1000);
}
function musStop(){musPlaying=false;if(musCtx){musCtx.close();musCtx=null;}}

// â”â”â” 4. AI ë°¸ëŸ°ìŠ¤ ë¶„ì„ê¸° â”â”â”
function openBalanceAI(){$('balModal').style.display='flex';balAnalyze('combat');}
function balAnalyze(type){
    const cv=$('balCV');cv.style.display='block';const cx=cv.getContext('2d');
    cx.clearRect(0,0,460,200);cx.fillStyle='#0c0e18';cx.fillRect(0,0,460,200);
    let html='';
    if(type==='combat'){
        const heroes=(GD.heroes||[]).slice(0,6);const mons=(GD.mons||[]).slice(0,6);
        cx.fillStyle='#60a5fa';cx.font='10px JetBrains Mono';cx.fillText('âš” DPS ë¹„êµ (ì˜ì›… vs ëª¬ìŠ¤í„°)',10,15);
        heroes.forEach((h,i)=>{const dps=(h.atk||50)*(1+(h.spd||10)/100);const w=Math.min(180,dps/2);cx.fillStyle='#89b4fa';cx.fillRect(80,25+i*14,w,10);cx.fillStyle='#cdd6f4';cx.font='8px monospace';cx.fillText(`${h.name} ${dps.toFixed(0)}`,2,34+i*14);});
        mons.forEach((m,i)=>{const dps=(m.atk||30)*(1+(m.spd||5)/100);const w=Math.min(180,dps/2);cx.fillStyle='#f38ba8';cx.fillRect(260,25+i*14,w,10);cx.fillStyle='#cdd6f4';cx.fillText(`${m.name} ${dps.toFixed(0)}`,262+w+4,34+i*14);});
        const avgH=heroes.reduce((s,h)=>(h.atk||50)+s,0)/Math.max(1,heroes.length);
        const avgM=mons.reduce((s,m)=>(m.atk||30)+s,0)/Math.max(1,mons.length);
        const ratio=avgH/Math.max(1,avgM);
        html=`<div style="color:var(--ac);font-weight:700">âš” ì „íˆ¬ ë°¸ëŸ°ìŠ¤ ë¶„ì„</div>`;
        html+=`<div>ì˜ì›… í‰ê·  ATK: ${avgH.toFixed(0)} | ëª¬ìŠ¤í„° í‰ê· : ${avgM.toFixed(0)}</div>`;
        html+=`<div>ë¹„ìœ¨: ${ratio.toFixed(2)} ${ratio>2?'âš ï¸ ì˜ì›…ì´ ë„ˆë¬´ ê°•í•¨!':ratio<0.8?'âš ï¸ ëª¬ìŠ¤í„°ê°€ ë„ˆë¬´ ê°•í•¨!':'âœ… ì ì ˆ'}</div>`;
        if(ratio>2)html+=`<div style="color:var(--yl)">ğŸ’¡ ì œì•ˆ: ëª¬ìŠ¤í„° ATK +${Math.round((avgH/1.5-avgM))} ì¦ê°€</div>`;
        if(ratio<0.8)html+=`<div style="color:var(--yl)">ğŸ’¡ ì œì•ˆ: ì˜ì›… ATK +${Math.round((avgM*1.2-avgH))} ì¦ê°€ ë˜ëŠ” ëª¬ìŠ¤í„° ì•½í™”</div>`;
    } else if(type==='economy'){
        const items=(GD.items||[]).slice(0,10);
        cx.fillStyle='#fbbf24';cx.font='10px JetBrains Mono';cx.fillText('ğŸ’° ì•„ì´í…œ ê°€ê²© ë¶„í¬',10,15);
        items.forEach((it,i)=>{const p=it.price||it.buy||100;const w=Math.min(400,p/5);cx.fillStyle=p>1000?'#f38ba8':p>500?'#fbbf24':'#a6e3a1';cx.fillRect(60,25+i*16,w,12);cx.fillStyle='#cdd6f4';cx.font='8px monospace';cx.fillText(`${it.name} ${p}G`,2,36+i*16);});
        html=`<div style="color:var(--yl);font-weight:700">ğŸ’° ê²½ì œ ë¶„ì„</div><div>ì•„ì´í…œ ${items.length}ê°œ ë¶„ì„</div>`;
    } else if(type==='level'){
        cx.fillStyle='#86efac';cx.font='10px JetBrains Mono';cx.fillText('ğŸ“ˆ ë ˆë²¨ë§ ê³¡ì„ ',10,15);
        for(let lv=1;lv<=20;lv++){const xp=Math.round(100*Math.pow(1.5,lv-1));const h=Math.min(160,xp/50);cx.fillStyle=`hsl(${120-lv*5},70%,60%)`;cx.fillRect(10+(lv-1)*22,180-h,18,h);cx.fillStyle='#cdd6f4';cx.font='6px monospace';cx.fillText(lv,13+(lv-1)*22,195);}
        html=`<div style="color:var(--gn);font-weight:700">ğŸ“ˆ ë ˆë²¨ë§ ë¶„ì„</div><div>Lv.1â†’20 í•„ìš” XP: 100 â†’ ${Math.round(100*Math.pow(1.5,19))}</div>`;
    } else if(type==='items'){
        html=`<div style="color:var(--or);font-weight:700">ğŸ’ ì•„ì´í…œ ë¶„ì„</div>`;
        const eq=(GD.equips||[]);html+=`<div>ì¥ë¹„ ${eq.length}ì¢…</div>`;
        eq.slice(0,5).forEach(e=>html+=`<div style="color:var(--tx2)">â€¢ ${e.name}: ATK+${e.atk||0} DEF+${e.def||0}</div>`);
    } else {
        html=`<div style="color:var(--ac);font-weight:700">ğŸ“Š ì „ì²´ ë¶„ì„</div>`;
        html+=`<div>ì˜ì›…: ${(GD.heroes||[]).length}ê°œ | ëª¬ìŠ¤í„°: ${(GD.mons||[]).length}ê°œ | ì•„ì´í…œ: ${(GD.items||[]).length}ê°œ</div>`;
        html+=`<div>ìŠ¤í‚¬: ${(GD.skills||[]).length}ê°œ | í€˜ìŠ¤íŠ¸: ${(GD.quests||[]).length}ê°œ | NPC: ${(GD.npcs||[]).length}ê°œ</div>`;
        html+=`<div>ì¥ë¹„: ${(GD.equips||[]).length}ê°œ | í«: ${(GD.pets||[]).length}ê°œ | ë³´ìŠ¤: ${(GD.boss||[]).length}ê°œ</div>`;
        html+=`<div style="color:var(--gn);margin-top:4px">âœ… ì „ì²´ ë°ì´í„° ${Object.values(GD).reduce((s,a)=>s+a.length,0)}ê°œ í•­ëª©</div>`;
    }
    $('balResult').innerHTML=html;LG(`âš– ë°¸ëŸ°ìŠ¤ ë¶„ì„: ${type}`,'o');
}

// â”â”â” 5. AI ë ˆë²¨ ë””ìì´ë„ˆ â”â”â”
function openLevelAI(){$('levelModal').style.display='flex';}
function lvlGenerate(){
    const prompt=$('lvlPrompt').value||'ê¸°ë³¸ ë˜ì „';const diff=$('lvlDiff').value;const theme=$('lvlTheme').value;
    const diffMul={ì‰¬ì›€:0.7,ë³´í†µ:1,ì–´ë ¤ì›€:1.5,ì§€ì˜¥:2.5}[diff]||1;
    // Auto-generate scene objects
    const objects=[];const sz=15+Math.random()*10|0;
    // Ground
    objects.push({type:'plane',name:'Ground',pos:[0,-0.5,0],scale:[sz,1,sz],color:theme==='ì„¤ì›'?'#ddeeff':theme==='ì‚¬ë§‰'?'#c4a35a':theme==='í™”ì‚°'?'#3a1a0a':'#3a5a2a'});
    // Walls
    for(let i=0;i<8+Math.random()*8;i++){const x=(Math.random()-0.5)*sz*0.8,z=(Math.random()-0.5)*sz*0.8;objects.push({type:'cube',name:'Wall_'+i,pos:[x,1,z],scale:[1+Math.random()*2,2+Math.random()*2,1+Math.random()*2],color:'#4a4a5a'});}
    // Monsters
    const monCnt=Math.round((3+Math.random()*5)*diffMul);
    for(let i=0;i<monCnt;i++){const x=(Math.random()-0.5)*sz*0.6,z=(Math.random()-0.5)*sz*0.6;objects.push({type:'mon',name:'Enemy_'+i,pos:[x,0,z]});}
    // Boss
    if(diff!=='ì‰¬ì›€'||prompt.includes('ë³´ìŠ¤'))objects.push({type:'boss',name:'Boss',pos:[0,0,-(sz/2-2)]});
    // Items
    for(let i=0;i<2+Math.random()*3;i++){const x=(Math.random()-0.5)*sz*0.5,z=(Math.random()-0.5)*sz*0.5;objects.push({type:'sphere',name:'Item_'+i,pos:[x,0.5,z],scale:[0.3,0.3,0.3],color:'#fbbf24'});}
    // Light
    objects.push({type:'light',name:'MainLight',pos:[0,8,0]});
    // Spawn scene objects
    objects.forEach(o=>{const obj=AO(o.type,new THREE.Vector3(...(o.pos||[0,0,0])));if(obj){obj.name=o.name;if(o.scale)obj.scale.set(...o.scale);if(o.color&&obj.material)obj.material.color.set(o.color);}});
    BH();
    $('lvlResult').innerHTML=`<div style="color:var(--mv)">ğŸ— ë ˆë²¨ ìƒì„± ì™„ë£Œ!</div><div>${theme} í…Œë§ˆ Â· ${diff} ë‚œì´ë„</div><div>ì˜¤ë¸Œì íŠ¸ ${objects.length}ê°œ: ë²½${8+Math.round(Math.random()*8)} ì ${monCnt} ì•„ì´í…œ${2+Math.round(Math.random()*3)}</div><div style="color:var(--yl)">"${prompt}"</div>`;
    boostSisters(5);LG(`ğŸ— ë ˆë²¨ ìƒì„±: ${theme} ${diff} (${objects.length}ê°œ)`,'o');toast('ğŸ— ë ˆë²¨ ìƒì„±!');
}

// â”â”â” 6. AI ì½”ë“œ ë¦¬ë·° â”â”â”
function openReviewAI(){$('reviewModal').style.display='flex';}
function reviewScene(){
    const objCount=scene?scene.children.length:0;const lights=scene?scene.children.filter(c=>c.isLight).length:0;
    const meshes=scene?scene.children.filter(c=>c.isMesh).length:0;
    let issues=[],tips=[];
    if(lights===0)issues.push('âš ï¸ ì¡°ëª…ì´ ì—†ìŠµë‹ˆë‹¤! ì”¬ì´ ì–´ë‘ìš¸ ìˆ˜ ìˆì–´ìš”.');
    if(lights>5)issues.push('âš ï¸ ì¡°ëª…ì´ ë§ìŠµë‹ˆë‹¤ ('+lights+'ê°œ). ì„±ëŠ¥ì— ì˜í–¥.');
    if(meshes>50)issues.push('âš ï¸ ë©”ì‹œê°€ ë§ìŠµë‹ˆë‹¤ ('+meshes+'ê°œ). ìµœì í™” í•„ìš”.');
    if(meshes===0)tips.push('ğŸ’¡ ì˜¤ë¸Œì íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”! ì¢Œì¸¡ + ë²„íŠ¼.');
    if(objCount<3)tips.push('ğŸ’¡ ë” ë§ì€ ì˜¤ë¸Œì íŠ¸ë¡œ ì”¬ì„ í’ë¶€í•˜ê²Œ!');
    if(lights>=1&&lights<=3)tips.push('âœ… ì¡°ëª… ìˆ˜ê°€ ì ì ˆí•©ë‹ˆë‹¤.');
    if(meshes>0&&meshes<=30)tips.push('âœ… ë©”ì‹œ ìˆ˜ê°€ ì ì ˆí•©ë‹ˆë‹¤.');
    tips.push('ğŸ’¡ AI ë§µìƒì„±ê¸°ë¡œ ìë™ ë ˆë²¨ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!');
    tips.push('ğŸ’¡ AI í…ìŠ¤ì²˜ë¡œ ë¨¸í‹°ë¦¬ì–¼ì„ í’ë¶€í•˜ê²Œ!');
    tips.push('ğŸ’¡ AI ì‘ê³¡ê¸°ë¡œ BGMì„ ì¶”ê°€í•´ë³´ì„¸ìš”!');
    let html=`<div style="color:var(--sk);font-weight:700">ğŸ” ì”¬ ë¶„ì„ ê²°ê³¼</div>`;
    html+=`<div style="margin:4px 0">ğŸ“Š ì˜¤ë¸Œì íŠ¸: ${objCount}ê°œ | ë©”ì‹œ: ${meshes}ê°œ | ì¡°ëª…: ${lights}ê°œ</div>`;
    if(issues.length)html+=`<div style="color:var(--rd);margin:4px 0">${issues.join('<br>')}</div>`;
    html+=`<div style="color:var(--gn);margin:4px 0">${tips.join('<br>')}</div>`;
    // FPS estimate
    html+=`<div style="margin-top:4px;color:var(--yl)">ì˜ˆìƒ ì„±ëŠ¥: ${meshes<20?'ğŸŸ¢ 60FPS':meshes<50?'ğŸŸ¡ 30-60FPS':'ğŸ”´ <30FPS'}</div>`;
    $('reviewResult').innerHTML=html;LG('ğŸ” ì”¬ ë¦¬ë·° ì™„ë£Œ','o');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAGE 2: ì—”ì§„ í•µì‹¬ ì‹œìŠ¤í…œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 8. Undo/Redo â”â”â”
let undoStack=[],redoStack=[];
function pushUndo(action){undoStack.push(action);if(undoStack.length>80)undoStack.shift();redoStack=[];LG('ğŸ“ '+action.desc,'i');}
function undo(){if(!undoStack.length)return toast('ë˜ëŒë¦´ ì‘ì—… ì—†ìŒ');const a=undoStack.pop();a.undo();redoStack.push(a);toast('â†© '+a.desc);BH();}
function redo(){if(!redoStack.length)return toast('ë‹¤ì‹œí•  ì‘ì—… ì—†ìŒ');const a=redoStack.pop();a.redo();undoStack.push(a);toast('â†ª '+a.desc);BH();}
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'){e.preventDefault();if(e.shiftKey)redo();else undo();}if((e.ctrlKey||e.metaKey)&&e.key==='y'){e.preventDefault();redo();}});

// â”â”â” 9. Prefab ì‹œìŠ¤í…œ â”â”â”
let prefabs=[];
(function loadPrefabs(){try{prefabs=JSON.parse(localStorage.getItem('wu_prefabs'))||[];}catch(e){}})();
function savePrefab(){if(!SO)return toast('ì„ íƒ ì—†ìŒ!');const d={name:SO.name,type:SO.userData.type||'cube',pos:[0,0,0],rot:[SO.rotation.x,SO.rotation.y,SO.rotation.z],scale:[SO.scale.x,SO.scale.y,SO.scale.z],color:SO.material?.color?'#'+SO.material.color.getHexString():null};prefabs.push(d);try{localStorage.setItem('wu_prefabs',JSON.stringify(prefabs));}catch(e){}toast('ğŸ“¦ í”„ë¦¬íŒ¹ ì €ì¥: '+d.name);LG('ğŸ“¦ Prefab: '+d.name,'o');}
function spawnPrefab(i){const p=prefabs[i];if(!p)return;const o=AO(p.type,new THREE.Vector3(Math.random()*4-2,0,Math.random()*4-2));if(o){o.name=p.name+'_inst';o.rotation.set(...p.rot);o.scale.set(...p.scale);if(p.color&&o.material)o.material.color.set(p.color);BH();}toast('ğŸ“¦ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±');}

// â”â”â” 10. Skybox + í™˜ê²½ â”â”â”
const SKY_PRESETS={
    day:{top:'#87CEEB',bot:'#E0F0FF',sun:0xFFFFEE,sunI:1.2,amb:0x404060,fog:null,name:'ë§‘ì€ ë‚®'},
    sunset:{top:'#FF6B35',bot:'#FFD700',sun:0xFF8C00,sunI:1.0,amb:0x553322,fog:null,name:'ì„ì–‘'},
    night:{top:'#0a0a2e',bot:'#1a1a3e',sun:0x4444AA,sunI:0.3,amb:0x101020,fog:'#0a0a1e',name:'ë°¤'},
    storm:{top:'#2a2a3a',bot:'#4a4a5a',sun:0x888888,sunI:0.5,amb:0x303040,fog:'#3a3a4a',name:'í­í’'},
    snow:{top:'#c0d0e0',bot:'#e8e8f0',sun:0xDDDDFF,sunI:0.8,amb:0x506070,fog:'#d0d0e0',name:'ëˆˆ'},
    fog:{top:'#606060',bot:'#808080',sun:0x999999,sunI:0.4,amb:0x404040,fog:'#707070',name:'ì•ˆê°œ'},
};
let curSky='day';
function setSkybox(preset){
    const s=SKY_PRESETS[preset];if(!s)return;curSky=preset;
    scene.background=new THREE.Color(s.top);
    scene.children.forEach(c=>{if(c.isDirectionalLight){c.color.set(s.sun);c.intensity=s.sunI;}if(c.isAmbientLight)c.color.set(s.amb);});
    if(s.fog)scene.fog=new THREE.FogExp2(s.fog,0.03);else scene.fog=null;
    toast('ğŸŒ¤ '+s.name);LG('ğŸŒ¤ í™˜ê²½: '+s.name,'o');
}

// â”â”â” 11. Terrain (simplified heightmap) â”â”â”
let terrainMesh=null;
function createTerrain(size,res){
    if(terrainMesh)scene.remove(terrainMesh);
    const geo=new THREE.PlaneGeometry(size,size,res,res);geo.rotateX(-Math.PI/2);
    const verts=geo.attributes.position;
    for(let i=0;i<verts.count;i++){
        const x=verts.getX(i)/size,z=verts.getZ(i)/size;
        let h=0;for(let o=0;o<4;o++){const f=Math.pow(2,o);h+=Math.sin(x*f*5+z*f*3)*Math.cos(z*f*4-x*f*2)/f;}
        verts.setY(i,h*2);
    }
    geo.computeVertexNormals();
    terrainMesh=new THREE.Mesh(geo,new THREE.MeshStandardMaterial({color:0x4a7a3a,roughness:0.9,flatShading:true}));
    terrainMesh.name='Terrain';terrainMesh.receiveShadow=true;scene.add(terrainMesh);
    BH();toast('â›° ì§€í˜• ìƒì„±!');LG('â›° Terrain '+size+'x'+size+' res:'+res,'o');
}

// â”â”â” 12. íƒ€ì„ë¼ì¸ ì• ë‹ˆë©”ì´ì…˜ â”â”â”
let animations=[];
function addAnim(obj,prop,from,to,dur,ease){
    if(!obj)return;
    const a={obj,prop,from,to,dur,ease:ease||'linear',start:0,active:false};animations.push(a);
    LG(`ğŸ¬ ì• ë‹ˆë©”ì´ì…˜: ${obj.name} ${prop} ${dur}s`,'o');return a;
}
function playAnims(){const now=performance.now()/1000;animations.forEach(a=>{if(!a.active){a.start=now;a.active=true;}const t=Math.min(1,(now-a.start)/a.dur);const eased=a.ease==='ease'?t*t*(3-2*t):t;if(a.prop==='y')a.obj.position.y=a.from+(a.to-a.from)*eased;if(a.prop==='rotY')a.obj.rotation.y=a.from+(a.to-a.from)*eased;if(a.prop==='scale'){const s=a.from+(a.to-a.from)*eased;a.obj.scale.set(s,s,s);}if(t>=1)a.active=false;});}

// â”â”â” 13. í¬ìŠ¤íŠ¸í”„ë¡œì„¸ì‹± (simplified) â”â”â”
let ppEnabled=false,ppBloom=false;
function togglePP(){ppEnabled=!ppEnabled;toast(ppEnabled?'âœ¨ í¬ìŠ¤íŠ¸í”„ë¡œì„¸ì‹± ON':'í¬ìŠ¤íŠ¸í”„ë¡œì„¸ì‹± OFF');LG('PostProcess: '+(ppEnabled?'ON':'OFF'),'o');}

// â”â”â” 14. ë””ë²„ê·¸/í”„ë¡œíŒŒì¼ëŸ¬ â”â”â”
let debugMode=false,fpsHist=[];
function toggleDebug(){
    debugMode=!debugMode;
    if(debugMode){
        scene.children.forEach(c=>{if(c.isMesh&&!c.userData._helper){const box=new THREE.BoxHelper(c,0x00ff00);box.userData._isHelper=true;c.userData._helper=box;scene.add(box);}});
    } else {
        scene.children.filter(c=>c.userData?._isHelper).forEach(h=>scene.remove(h));
        scene.children.forEach(c=>{if(c.userData._helper){delete c.userData._helper;}});
    }
    toast(debugMode?'ğŸ› ë””ë²„ê·¸ ON':'ë””ë²„ê·¸ OFF');
}
function updateFPS(){
    if(!debugMode)return;
    const info=ren.info;
    const fps=Math.round(1/(clock.getDelta()||0.016));
    fpsHist.push(fps);if(fpsHist.length>60)fpsHist.shift();
    $('VI').textContent=`FPS:${fps} | Draw:${info.render?.calls||0} | Tri:${info.render?.triangles||0} | Obj:${scene.children.length}`;
}
const clock=new THREE.Clock();

// â”â”â” 7. AI íŠœí† ë¦¬ì–¼ â”â”â”
let tutStep=0,tutActive=false;
const TUT_STEPS=[
    {target:'HL',msg:'ğŸ“‹ ì—¬ê¸°ê°€ ê³„ì¸µêµ¬ì¡°! ì˜¤ë¸Œì íŠ¸ ëª©ë¡ì´ì—ìš”.',pos:'right'},
    {target:'vp',msg:'ğŸ® 3D ë·°í¬íŠ¸! ë§ˆìš°ìŠ¤ë¡œ íšŒì „, íœ ë¡œ ì¤Œ!',pos:'center'},
    {target:null,msg:'â• ì™¼ìª½ + ë²„íŠ¼ìœ¼ë¡œ ì˜¤ë¸Œì íŠ¸ ì¶”ê°€!',pos:'left'},
    {target:null,msg:'ğŸ¤– AI ë²„íŠ¼ë“¤ë¡œ ìºë¦­í„°/ì‚¬ìš´ë“œ/ë§µ ìë™ ìƒì„±!',pos:'top'},
    {target:null,msg:'ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ ì„¸ìë§¤ ë²„íŠ¼ìœ¼ë¡œ AI ìë§¤ë“¤ê³¼ ëŒ€í™”!',pos:'top'},
    {target:null,msg:'ğŸ“ ì„ ìƒë‹˜ ë²„íŠ¼ìœ¼ë¡œ ì½”ë”© ìˆ˜ì—…!',pos:'top'},
    {target:null,msg:'â–¶ ì‹¤í–‰ ë²„íŠ¼ìœ¼ë¡œ ê²Œì„ í…ŒìŠ¤íŠ¸!',pos:'top'},
    {target:null,msg:'ğŸ‰ íŠœí† ë¦¬ì–¼ ì™„ë£Œ! ììœ ë¡­ê²Œ ë§Œë“¤ì–´ë³´ì„¸ìš”!',pos:'center'},
];
function startTutorial(){tutActive=true;tutStep=0;showTutStep();}
function showTutStep(){
    if(tutStep>=TUT_STEPS.length){tutActive=false;removeTutOverlay();toast('ğŸ“ íŠœí† ë¦¬ì–¼ ì™„ë£Œ!');return;}
    const s=TUT_STEPS[tutStep];
    let overlay=document.getElementById('tutOverlay');
    if(!overlay){overlay=document.createElement('div');overlay.id='tutOverlay';overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:center;justify-content:center;cursor:pointer';overlay.onclick=()=>{tutStep++;showTutStep();};document.body.appendChild(overlay);}
    overlay.innerHTML=`<div style="background:var(--bg2);border:2px solid var(--ac);border-radius:12px;padding:16px 24px;max-width:350px;text-align:center"><div style="font-size:1em;margin-bottom:8px">${s.msg}</div><div style="font-size:.6em;color:var(--tx2)">${tutStep+1}/${TUT_STEPS.length} â€” í´ë¦­í•˜ë©´ ë‹¤ìŒ</div></div>`;
}
function removeTutOverlay(){const o=document.getElementById('tutOverlay');if(o)o.remove();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì—”ì§„ ë£¨í”„ íŒ¨ì¹˜ â€” ì• ë‹ˆë©”ì´ì…˜+ë””ë²„ê·¸ ì—°ë™
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _origAnimate=typeof animate==='function'?animate:null;
if(typeof requestAnimationFrame!=='undefined'){
    // Patch render loop if exists
    setInterval(()=>{if(PM)playAnims();if(debugMode)updateFPS();},50);
}

// Keyboard shortcut for new features
document.addEventListener('keydown',e=>{
    if(e.key==='F1'){e.preventDefault();startTutorial();}
    if(e.key==='F3'){e.preventDefault();toggleDebug();}
});

LG('â•â•â• STAGE 1+2+3 í†µí•© ì™„ë£Œ! â•â•â•','o');
LG('ğŸ†• AI: ğŸ’¬ëŒ€í™” ğŸ¨í…ìŠ¤ì²˜ ğŸµì‘ê³¡ âš–ë°¸ëŸ°ìŠ¤ ğŸ—ë ˆë²¨ ğŸ”ë¦¬ë·° ğŸ“–íŠœí† ë¦¬ì–¼','o');
LG('ğŸ†• ì—”ì§„: â†©Undo ğŸ“¦Prefab ğŸŒ¤Skybox â›°Terrain ğŸ¬ì• ë‹ˆë©”ì´ì…˜ âœ¨PostProcess ğŸ›Debug','o');
LG('ë‹¨ì¶•í‚¤: Ctrl+Z=Undo Ctrl+Y=Redo F1=íŠœí† ë¦¬ì–¼ F3=ë””ë²„ê·¸','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 2 ROUND 1: ê²Œì„í”Œë ˆì´ ì‹œìŠ¤í…œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 1. ì¸ë²¤í† ë¦¬ ì‹œìŠ¤í…œ â”â”â”
const INV_MAX=24,INV_WEIGHT_MAX=100;
let inventory=Array(INV_MAX).fill(null),equipped={weapon:null,armor:null,helmet:null,boots:null,ring:null,necklace:null,gloves:null},playerGold=500;
const EQ_ICONS={weapon:'âš”ï¸',armor:'ğŸ›¡',helmet:'â›‘',boots:'ğŸ‘¢',ring:'ğŸ’',necklace:'ğŸ“¿',gloves:'ğŸ§¤'};

function openInventory(){$('invPanel').style.display=$('invPanel').style.display==='none'?'block':'none';renderInv();}
function renderInv(){
    const g=$('invGrid');g.innerHTML='';
    let totalW=0;
    for(let i=0;i<INV_MAX;i++){
        const it=inventory[i];
        const d=document.createElement('div');
        d.style.cssText='width:100%;aspect-ratio:1;background:#0c0e18;border:1px solid #252840;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.7em;cursor:pointer;position:relative';
        if(it){
            d.textContent=it.icon||'ğŸ“¦';d.title=it.name;
            if(it.count>1){const c=document.createElement('span');c.style.cssText='position:absolute;bottom:0;right:1px;font-size:.5em;color:#fbbf24';c.textContent=it.count;d.appendChild(c);}
            d.style.borderColor=it.rarity==='legendary'?'#fab387':it.rarity==='epic'?'#cba6f7':it.rarity==='rare'?'#89b4fa':'#252840';
            d.onclick=()=>selectInvItem(i);
            totalW+=(it.weight||1)*it.count;
        }
        g.appendChild(d);
    }
    $('invWeight').textContent=`${totalW}/${INV_WEIGHT_MAX}`;
    $('invGold').textContent=`ğŸ’° ${playerGold}G`;
    // Equipment slots
    $('eqSlots').innerHTML=Object.entries(equipped).map(([k,v])=>`<span style="width:28px;height:28px;background:#0c0e18;border:1px solid ${v?'#fbbf24':'#252840'};border-radius:3px;display:inline-flex;align-items:center;justify-content:center;font-size:.55em;cursor:pointer" title="${k}" onclick="unequip('${k}')">${v?v.icon||EQ_ICONS[k]:EQ_ICONS[k]}</span>`).join('');
}
function addItem(item,count){
    count=count||1;const exist=inventory.findIndex(s=>s&&s.id===item.id&&s.count<(item.stack||99));
    if(exist>=0){inventory[exist].count+=count;}
    else{const empty=inventory.indexOf(null);if(empty>=0)inventory[empty]={...item,count};else{toast('ì¸ë²¤í† ë¦¬ ê°€ë“!');return false;}}
    toast(`ğŸ’ +${item.name} x${count}`);renderInv();return true;
}
function selectInvItem(i){
    const it=inventory[i];if(!it)return;
    $('invInfo').innerHTML=`<div style="color:#fbbf24;font-weight:600">${it.icon||'ğŸ“¦'} ${it.name}</div><div>${it.desc||''}</div><div style="color:#60a5fa">${it.atk?'ATK+'+it.atk+' ':''} ${it.def?'DEF+'+it.def+' ':''} ${it.hp?'HP+'+it.hp:''}</div>
    <div style="display:flex;gap:3px;margin-top:3px">${it.type&&['weapon','armor','helmet','boots','ring','necklace','gloves'].includes(it.type)?`<button onclick="equipItem(${i})" style="padding:1px 6px;background:#3b82f6;color:#fff;border:none;border-radius:3px;font-size:.9em;cursor:pointer">ì¥ì°©</button>`:''}<button onclick="useItem(${i})" style="padding:1px 6px;background:#86efac;color:#000;border:none;border-radius:3px;font-size:.9em;cursor:pointer">ì‚¬ìš©</button><button onclick="dropItem(${i})" style="padding:1px 6px;background:#f87171;color:#fff;border:none;border-radius:3px;font-size:.9em;cursor:pointer">ë²„ë¦¬ê¸°</button></div>`;
}
function equipItem(i){const it=inventory[i];if(!it||!it.type)return;const slot=it.type;if(equipped[slot])addItem(equipped[slot]);equipped[slot]=it;inventory[i]=null;toast('âš”ï¸ ì¥ì°©: '+it.name);renderInv();}
function unequip(slot){if(!equipped[slot])return;addItem(equipped[slot]);equipped[slot]=null;renderInv();}
function useItem(i){const it=inventory[i];if(!it)return;if(it.hp){toast(`â¤ï¸ HP +${it.hp}`);} if(it.count>1)it.count--;else inventory[i]=null;renderInv();}
function dropItem(i){if(!inventory[i])return;toast('ğŸ—‘ '+inventory[i].name);inventory[i]=null;renderInv();}
// Default items
addItem({id:'pot1',name:'ì²´ë ¥ í¬ì…˜',icon:'ğŸ§ª',desc:'HP +50 íšŒë³µ',hp:50,weight:1,count:1,stack:10});
addItem({id:'pot2',name:'ë§ˆë‚˜ í¬ì…˜',icon:'ğŸ’™',desc:'MP +30 íšŒë³µ',mp:30,weight:1,count:1,stack:10});
addItem({id:'sw1',name:'ì´ˆë³´ìì˜ ê²€',icon:'ğŸ—¡',desc:'ê¸°ë³¸ ë¬´ê¸°',type:'weapon',atk:15,weight:3,count:1,rarity:'common'});

// â”â”â” 2. ëŒ€í™” ì‹œìŠ¤í…œ (í”Œë ˆì´ëª¨ë“œ) â”â”â”
let activeDialog=null,dlgIdx=0;
function startDialog(npcName,dialogData){
    if(!dialogData||!dialogData.length)return;
    activeDialog={npc:npcName,data:dialogData};dlgIdx=0;
    $('dlgPanel').style.display='block';showDialogNode();
}
function showDialogNode(){
    if(!activeDialog||dlgIdx<0||dlgIdx>=activeDialog.data.length){closeDialog();return;}
    const node=activeDialog.data[dlgIdx];
    $('dlgNpcName').textContent=activeDialog.npc;
    $('dlgText').textContent=node.text||'...';
    const ch=$('dlgChoices');ch.innerHTML='';
    if(node.choices&&node.choices.length){
        node.choices.forEach(c=>{
            const b=document.createElement('button');
            b.style.cssText='padding:6px 10px;background:rgba(155,138,255,.1);border:1px solid #9b8aff;border-radius:6px;color:#e8eaff;font-size:.5em;cursor:pointer;text-align:left;font-family:Outfit,sans-serif;transition:all .1s';
            b.textContent='â–¸ '+c.text;
            b.onmouseover=()=>b.style.background='rgba(155,138,255,.2)';
            b.onmouseout=()=>b.style.background='rgba(155,138,255,.1)';
            b.onclick=()=>{
                if(c.reward){if(c.reward.gold)playerGold+=c.reward.gold;if(c.reward.xp)toast(`âœ¨ +${c.reward.xp} XP`);if(c.reward.item)addItem(c.reward.item);}
                if(c.quest)acceptQuest(c.quest);
                if(c.next===undefined||c.next===-1)closeDialog();else{dlgIdx=c.next;showDialogNode();}
            };
            ch.appendChild(b);
        });
    } else {
        const b=document.createElement('button');b.style.cssText='padding:6px 10px;background:rgba(155,138,255,.1);border:1px solid #353860;border-radius:6px;color:#8e92b8;font-size:.5em;cursor:pointer;font-family:Outfit,sans-serif';
        b.textContent='[ê³„ì†]';b.onclick=()=>{dlgIdx++;showDialogNode();};ch.appendChild(b);
    }
}
function closeDialog(){activeDialog=null;$('dlgPanel').style.display='none';}
// Demo dialog on NPC click in playmode
const DEMO_DIALOGS={
    'ë§ˆì„ ì¥ë¡œ':[{text:'ìš©ì‚¬ì—¬, ì˜ ì™”ë‹¤! ì´ ë§ˆì„ì— ìµœê·¼ ëª¬ìŠ¤í„°ë“¤ì´ ë‚˜íƒ€ë‚˜ê³  ìˆë‹¤ë„¤...',choices:[{text:'ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!',next:1},{text:'ë¬´ìŠ¨ ì¼ì´ì£ ?',next:1}]},{text:'ê³ ë§™ë„¤! ë§ˆì„ ë’·ì‚°ì˜ ë™êµ´ì—ì„œ 5ë§ˆë¦¬ë¥¼ ì²˜ì¹˜í•´ì£¼ê²Œ.',choices:[{text:'í€˜ìŠ¤íŠ¸ ìˆ˜ë½!',next:-1,quest:{id:'q1',name:'ë™êµ´ ëª¬ìŠ¤í„° í† ë²Œ',desc:'ë’·ì‚° ë™êµ´ ëª¬ìŠ¤í„° 5ë§ˆë¦¬ ì²˜ì¹˜',goal:5,progress:0,reward:{gold:200,xp:100}}},{text:'ë‚˜ì¤‘ì—ìš”',next:-1}]}],
    'ìƒì  ì£¼ì¸':[{text:'ì–´ì„œì™€! ë­ê°€ í•„ìš”í•˜ë‚˜?',choices:[{text:'í¬ì…˜ ì‚¬ê¸° (50G)',next:-1,reward:{gold:-50,item:{id:'pot1',name:'ì²´ë ¥ í¬ì…˜',icon:'ğŸ§ª',desc:'HP +50',hp:50,weight:1,count:1,stack:10}}},{text:'ê·¸ëƒ¥ êµ¬ê²½',next:-1}]}],
};

// â”â”â” 3. í€˜ìŠ¤íŠ¸ ì‹œìŠ¤í…œ â”â”â”
let activeQuests=[],completedQuests=[];
function openQuestPanel(){$('questPanel').style.display=$('questPanel').style.display==='none'?'block':'none';renderQuests();}
function acceptQuest(q){if(activeQuests.find(a=>a.id===q.id))return toast('ì´ë¯¸ ìˆ˜ë½!');activeQuests.push({...q});toast('ğŸ“‹ í€˜ìŠ¤íŠ¸ ìˆ˜ë½: '+q.name);renderQuests();LG('ğŸ“‹ í€˜ìŠ¤íŠ¸: '+q.name,'o');}
function updateQuest(id,amount){
    const q=activeQuests.find(a=>a.id===id);if(!q)return;
    q.progress=Math.min(q.goal,(q.progress||0)+(amount||1));
    if(q.progress>=q.goal){completeQuest(id);}
    renderQuests();
}
function completeQuest(id){
    const qi=activeQuests.findIndex(a=>a.id===id);if(qi<0)return;
    const q=activeQuests.splice(qi,1)[0];completedQuests.push(q);
    if(q.reward){if(q.reward.gold)playerGold+=q.reward.gold;if(q.reward.xp)toast(`âœ¨ +${q.reward.xp} XP`);}
    toast('ğŸ‰ í€˜ìŠ¤íŠ¸ ì™„ë£Œ: '+q.name);boostSisters(3);LG('ğŸ‰ í€˜ìŠ¤íŠ¸ ì™„ë£Œ: '+q.name,'o');
}
function renderQuests(){
    const ql=$('questList');
    if(!activeQuests.length&&!completedQuests.length){ql.innerHTML='<div style="font-size:.48em;color:#5a5e80;text-align:center;padding:10px">í€˜ìŠ¤íŠ¸ ì—†ìŒ<br>NPCì™€ ëŒ€í™”í•˜ì„¸ìš”!</div>';return;}
    let html='';
    activeQuests.forEach(q=>{
        const pct=Math.round((q.progress||0)/q.goal*100);
        html+=`<div style="background:#0c0e18;border:1px solid #252840;border-left:3px solid #86efac;border-radius:4px;padding:5px 7px;margin-bottom:4px"><div style="font-size:.5em;color:#86efac;font-weight:600">${q.name}</div><div style="font-size:.4em;color:#8e92b8">${q.desc||''}</div><div style="display:flex;align-items:center;gap:4px;margin-top:3px"><div style="flex:1;height:3px;background:#252840;border-radius:2px;overflow:hidden"><div style="height:100%;background:#86efac;width:${pct}%"></div></div><span style="font-size:.38em;color:#86efac">${q.progress||0}/${q.goal}</span></div>${q.reward?`<div style="font-size:.36em;color:#fbbf24;margin-top:2px">ë³´ìƒ: ${q.reward.gold?q.reward.gold+'G ':''}${q.reward.xp?q.reward.xp+'XP':''}</div>`:''}</div>`;
    });
    completedQuests.slice(-3).forEach(q=>{html+=`<div style="background:#0c0e18;border:1px solid #252840;border-left:3px solid #5a5e80;border-radius:4px;padding:5px 7px;margin-bottom:4px;opacity:.5"><div style="font-size:.5em;color:#5a5e80">âœ… ${q.name}</div></div>`;});
    ql.innerHTML=html;
}

// â”â”â” 4. ì„¸ì´ë¸Œ ìŠ¬ë¡¯ ì‹œìŠ¤í…œ â”â”â”
function openSaveModal(){$('saveModal').style.display='flex';renderSaveSlots();}
function renderSaveSlots(){
    let html='';
    for(let i=0;i<3;i++){
        let data=null;try{data=JSON.parse(localStorage.getItem('wu_save_'+i));}catch(e){}
        html+=`<div style="background:var(--bg3);border:1px solid var(--bd);border-radius:6px;padding:8px;display:flex;gap:8px;align-items:center">
        <div style="width:50px;height:35px;background:#1a1a2e;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:1em">${data?'ğŸ®':'ğŸ’¾'}</div>
        <div style="flex:1"><div style="font-size:.6em;font-weight:600;color:var(--tx)">${data?'ìŠ¬ë¡¯ '+(i+1)+': '+data.name:'ìŠ¬ë¡¯ '+(i+1)+' (ë¹„ì–´ìˆìŒ)'}</div>
        <div style="font-size:.4em;color:var(--tx2)">${data?data.date+' | Obj:'+data.objCount+' | ğŸ’°'+data.gold+'G':'---'}</div></div>
        <button onclick="saveToSlot(${i})" style="padding:4px 8px;background:var(--ac);color:#000;border:none;border-radius:4px;font-size:.55em;font-weight:600;cursor:pointer">ì €ì¥</button>
        ${data?`<button onclick="loadFromSlot(${i})" style="padding:4px 8px;background:var(--gn);color:#000;border:none;border-radius:4px;font-size:.55em;font-weight:600;cursor:pointer">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="deleteSlot(${i})" style="padding:4px 6px;background:var(--rd);color:#fff;border:none;border-radius:4px;font-size:.55em;cursor:pointer">âœ•</button>`:''}
        </div>`;
    }
    $('saveSlots').innerHTML=html;
}
function saveToSlot(i){
    const data={name:prompt('ì„¸ì´ë¸Œ ì´ë¦„:','My Game')||'Save '+(i+1),date:new Date().toLocaleString(),objCount:O.length,gold:playerGold,
        objects:O.map(o=>({id:o.id,type:o.type,name:o.mesh.name,pos:[o.mesh.position.x,o.mesh.position.y,o.mesh.position.z],rot:[o.mesh.rotation.x,o.mesh.rotation.y,o.mesh.rotation.z],scale:[o.mesh.scale.x,o.mesh.scale.y,o.mesh.scale.z],p:{...o.p}})),
        inventory:inventory,equipped:equipped,quests:activeQuests,sky:curSky};
    try{localStorage.setItem('wu_save_'+i,JSON.stringify(data));toast('ğŸ’¾ ì €ì¥ ì™„ë£Œ!');LG('ğŸ’¾ ìŠ¬ë¡¯'+(i+1)+' ì €ì¥','o');}catch(e){toast('ì €ì¥ ì‹¤íŒ¨!');}
    renderSaveSlots();
}
function loadFromSlot(i){
    let data;try{data=JSON.parse(localStorage.getItem('wu_save_'+i));}catch(e){return toast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!');}
    if(!data)return;
    // Clear scene
    O.forEach(o=>scene.remove(o.mesh));O.length=0;
    // Restore objects
    (data.objects||[]).forEach(od=>{const o=AO(od.type,new THREE.Vector3(...od.pos));if(o){o.mesh.name=od.name;o.mesh.rotation.set(...od.rot);o.mesh.scale.set(...od.scale);Object.assign(o.p,od.p);}});
    inventory=data.inventory||Array(INV_MAX).fill(null);equipped=data.equipped||{weapon:null,armor:null,helmet:null,boots:null,ring:null,necklace:null,gloves:null};
    playerGold=data.gold||0;activeQuests=data.quests||[];
    if(data.sky)setSkybox(data.sky);
    BH();renderInv();renderQuests();
    toast('ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');LG('ğŸ“‚ ìŠ¬ë¡¯'+(i+1)+' ë¡œë“œ','o');$('saveModal').style.display='none';
}
function deleteSlot(i){if(!confirm('ì‚­ì œ?'))return;localStorage.removeItem('wu_save_'+i);renderSaveSlots();toast('ğŸ—‘ ìŠ¬ë¡¯ ì‚­ì œ');}
// Auto-save
setInterval(()=>{if(O.length>0){try{const d={name:'AutoSave',date:new Date().toLocaleString(),objCount:O.length,gold:playerGold,objects:O.map(o=>({id:o.id,type:o.type,name:o.mesh.name,pos:[o.mesh.position.x,o.mesh.position.y,o.mesh.position.z],rot:[o.mesh.rotation.x,o.mesh.rotation.y,o.mesh.rotation.z],scale:[o.mesh.scale.x,o.mesh.scale.y,o.mesh.scale.z],p:{...o.p}})),inventory,equipped,quests:activeQuests,sky:curSky};localStorage.setItem('wu_autosave',JSON.stringify(d));}catch(e){}}},300000); // 5ë¶„

// â”â”â” 5. ë‚ ì”¨ + ë‚®/ë°¤ ì‚¬ì´í´ â”â”â”
let weatherState='clear',dayTime=0.5,daySpeed=0.00005,weatherParticles=[];
const WEATHER={
    clear:{fog:null,particles:0,color:'#87CEEB'},
    rain:{fog:'#4a4a6a',particles:200,color:'#5a5a7a'},
    snow:{fog:'#c0d0e0',particles:150,color:'#d0d0e0'},
    storm:{fog:'#2a2a3a',particles:300,color:'#3a3a4a'},
};
function setWeather(type){
    weatherState=type;const w=WEATHER[type];
    if(w.fog)scene.fog=new THREE.FogExp2(w.fog,0.02);else scene.fog=null;
    // Clear old particles
    weatherParticles.forEach(p=>scene.remove(p));weatherParticles=[];
    // Create particles
    if(w.particles>0){
        const geo=new THREE.BufferGeometry();const pos=new Float32Array(w.particles*3);
        for(let i=0;i<w.particles;i++){pos[i*3]=(Math.random()-0.5)*40;pos[i*3+1]=Math.random()*20;pos[i*3+2]=(Math.random()-0.5)*40;}
        geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
        const mat=new THREE.PointsMaterial({color:type==='snow'?0xffffff:0x88aacc,size:type==='snow'?0.15:0.05,transparent:true,opacity:0.7});
        const pts=new THREE.Points(geo,mat);pts.userData._weather=true;scene.add(pts);weatherParticles.push(pts);
    }
    toast('ğŸŒ¤ '+type);LG('ğŸŒ§ ë‚ ì”¨: '+type,'o');
}
function updateWeather(dt){
    // Animate particles
    weatherParticles.forEach(pts=>{
        const pos=pts.geometry.attributes.position;
        for(let i=0;i<pos.count;i++){
            pos.array[i*3+1]-=weatherState==='snow'?dt*2:dt*15; // fall speed
            if(weatherState!=='snow')pos.array[i*3]+=Math.sin(i)*dt*2; // wind
            if(pos.array[i*3+1]<0)pos.array[i*3+1]=15+Math.random()*5;
        }
        pos.needsUpdate=true;
    });
    // Day/night cycle
    dayTime=(dayTime+daySpeed*dt*60)%1;
    const sunAngle=dayTime*Math.PI*2;
    const sunY=Math.sin(sunAngle);const sunI=Math.max(0.1,sunY);
    const r=sunY>0?0.4+sunY*0.4:0.05;const g=sunY>0?0.5+sunY*0.3:0.05;const b=sunY>0?0.6+sunY*0.3:0.1;
    scene.background=new THREE.Color(r,g,b);
    scene.children.forEach(c=>{if(c.isDirectionalLight){c.intensity=sunI;c.position.y=5+sunY*5;}if(c.isAmbientLight)c.intensity=0.2+sunI*0.3;});
    // Lightning flash in storm
    if(weatherState==='storm'&&Math.random()<0.002){
        scene.children.forEach(c=>{if(c.isAmbientLight)c.intensity=2;});
        setTimeout(()=>scene.children.forEach(c=>{if(c.isAmbientLight)c.intensity=0.3;}),100);
    }
}

// Patch play mode for gameplay
const _origTP=TP;
TP=function(){_origTP();if(PM){$('invPanel').style.display='none';$('questPanel').style.display='none';}};

// Patch PU for weather update + NPC interaction
const _origPU=PU;
PU=function(dt){_origPU(dt);updateWeather(dt);playAnims();
    // E key to interact with nearby NPCs
    if(keys['e']&&PO&&!activeDialog){
        const pp=PO.mesh.position;
        const npc=O.find(o=>(o.type==='npc'||o.type==='char')&&o.mesh.position.distanceTo(pp)<3);
        if(npc){const name=npc.mesh.name||'NPC';const dlg=DEMO_DIALOGS[name]||[{text:'ì•ˆë…•í•˜ì„¸ìš”!',choices:[{text:'ì•ˆë…•!',next:-1}]}];startDialog(name,dlg);}
    }
};

// Keyboard hooks for gameplay
document.addEventListener('keydown',e=>{
    if(e.key==='i'||e.key==='I'){e.preventDefault();openInventory();}
    if(e.key==='j'||e.key==='J'){e.preventDefault();openQuestPanel();}
    if(e.key==='F5'){e.preventDefault();openSaveModal();}
});

LG('â•â•â• Phase 2 R1: ê²Œì„í”Œë ˆì´ ì‹œìŠ¤í…œ ì¶”ê°€! â•â•â•','o');
LG('ğŸ’ ì¸ë²¤í† ë¦¬(I) ğŸ’¬ ëŒ€í™”(E) ğŸ“‹ í€˜ìŠ¤íŠ¸(J) ğŸ’¾ ì„¸ì´ë¸Œ(F5) ğŸŒ§ ë‚ ì”¨','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 2 ROUND 2: ë¹„ì£¼ì–¼ ìŠ¤í¬ë¦½íŒ… + ì—ë””í„°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 6. ë¹„ì£¼ì–¼ ë…¸ë“œ ì—ë””í„° â”â”â”
let nodes=[],nodeConns=[],nodeDrag=null,nodeConnecting=null,nodeIdCounter=0;
const NODE_TYPES={
    event:{color:'#f87171',label:'ì´ë²¤íŠ¸',templates:['OnStart','OnUpdate','OnCollision','OnKeyDown','OnTrigger']},
    action:{color:'#86efac',label:'ì•¡ì…˜',templates:['Move','Rotate','PlaySound','Destroy','Spawn','SetVar']},
    condition:{color:'#fbbf24',label:'ì¡°ê±´',templates:['If','Compare','HasItem','Distance','Random']},
    variable:{color:'#c084fc',label:'ë³€ìˆ˜',templates:['GetVar','SetVar','Math','ToString','Timer']},
};
function openNodeEditor(){
    $('nodePanel').style.display='flex';
    const cv=$('nodeCV');cv.width=cv.parentElement.clientWidth;cv.height=cv.parentElement.clientHeight-56-50;
    renderNodes();
    cv.onmousedown=nodeMouseDown;cv.onmousemove=nodeMouseMove;cv.onmouseup=nodeMouseUp;
}
function nodeAdd(type){
    const t=NODE_TYPES[type];const tmpl=t.templates[Math.floor(Math.random()*t.templates.length)];
    nodes.push({id:++nodeIdCounter,type,label:tmpl,x:80+Math.random()*300,y:40+Math.random()*200,w:120,h:50,inputs:type!=='event'?1:0,outputs:type!=='variable'||tmpl==='GetVar'?1:0,color:t.color});
    renderNodes();LG('ğŸ”· ë…¸ë“œ ì¶”ê°€: '+tmpl,'o');
}
function renderNodes(){
    const cv=$('nodeCV');const cx=cv.getContext('2d');cx.clearRect(0,0,cv.width,cv.height);
    // Grid
    cx.strokeStyle='#151828';cx.lineWidth=1;for(let x=0;x<cv.width;x+=20){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,cv.height);cx.stroke();}
    for(let y=0;y<cv.height;y+=20){cx.beginPath();cx.moveTo(0,y);cx.lineTo(cv.width,y);cx.stroke();}
    // Connections
    nodeConns.forEach(c=>{
        const from=nodes.find(n=>n.id===c.from),to=nodes.find(n=>n.id===c.to);if(!from||!to)return;
        cx.strokeStyle='#60a5fa';cx.lineWidth=2;cx.beginPath();
        const fx=from.x+from.w,fy=from.y+from.h/2,tx=to.x,ty=to.y+to.h/2;
        cx.moveTo(fx,fy);cx.bezierCurveTo(fx+50,fy,tx-50,ty,tx,ty);cx.stroke();
    });
    // Nodes
    nodes.forEach(n=>{
        cx.fillStyle='#0c0e18';cx.strokeStyle=n.color;cx.lineWidth=2;
        cx.beginPath();cx.roundRect(n.x,n.y,n.w,n.h,6);cx.fill();cx.stroke();
        cx.fillStyle=n.color;cx.font='bold 10px JetBrains Mono';cx.fillText(n.label,n.x+8,n.y+18);
        cx.font='8px JetBrains Mono';cx.fillStyle='#5a5e80';cx.fillText(n.type,n.x+8,n.y+32);
        // Pins
        if(n.inputs){cx.fillStyle='#60a5fa';cx.beginPath();cx.arc(n.x,n.y+n.h/2,5,0,Math.PI*2);cx.fill();}
        if(n.outputs){cx.fillStyle='#86efac';cx.beginPath();cx.arc(n.x+n.w,n.y+n.h/2,5,0,Math.PI*2);cx.fill();}
        cx.fillStyle='#353860';cx.font='7px monospace';cx.fillText('#'+n.id,n.x+n.w-20,n.y+n.h-5);
    });
}
function nodeMouseDown(e){const r=e.target.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;
    // Check output pin click for connecting
    for(const n of nodes){if(n.outputs&&Math.hypot(mx-(n.x+n.w),my-(n.y+n.h/2))<8){nodeConnecting={from:n.id};return;}}
    // Check node drag
    for(const n of nodes){if(mx>=n.x&&mx<=n.x+n.w&&my>=n.y&&my<=n.y+n.h){nodeDrag={node:n,ox:mx-n.x,oy:my-n.y};return;}}
}
function nodeMouseMove(e){if(!nodeDrag)return;const r=e.target.getBoundingClientRect();nodeDrag.node.x=e.clientX-r.left-nodeDrag.ox;nodeDrag.node.y=e.clientY-r.top-nodeDrag.oy;renderNodes();}
function nodeMouseUp(e){
    if(nodeConnecting){const r=e.target.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;
        for(const n of nodes){if(n.inputs&&n.id!==nodeConnecting.from&&Math.hypot(mx-n.x,my-(n.y+n.h/2))<12){nodeConns.push({from:nodeConnecting.from,to:n.id});LG('ğŸ”— ì—°ê²°: #'+nodeConnecting.from+' â†’ #'+n.id,'o');break;}}
    }
    nodeDrag=null;nodeConnecting=null;renderNodes();
}
function nodeCompile(){
    let code='// Auto-generated from Visual Script\n';
    const sorted=nodes.filter(n=>n.type==='event');
    sorted.forEach(ev=>{
        code+=`// ${ev.label}\nfunction on${ev.label}() {\n`;
        const connected=nodeConns.filter(c=>c.from===ev.id).map(c=>nodes.find(n=>n.id===c.to)).filter(Boolean);
        connected.forEach(n=>{
            if(n.type==='action')code+=`  ${n.label}(); // action\n`;
            if(n.type==='condition')code+=`  if(${n.label}()) { /* true branch */ }\n`;
            if(n.type==='variable')code+=`  let val = ${n.label}();\n`;
        });
        code+='}\n\n';
    });
    $('nodeOut').textContent=code;LG('âœ… ì»´íŒŒì¼: '+nodes.length+'ë…¸ë“œ â†’ JS','o');toast('âœ… ì»´íŒŒì¼!');
}
function nodeClear(){nodes=[];nodeConns=[];nodeIdCounter=0;renderNodes();$('nodeOut').textContent='ğŸ”· ì´ˆê¸°í™”ë¨';}

// â”â”â” 8. íŒŒí‹°í´ ì—ë””í„° â”â”â”
const PART_PRESETS=[
    {name:'ğŸ”¥ë¶ˆ',color:'#ff6b35',cnt:200,size:8,life:2,speed:3},
    {name:'âœ¨ë§ˆë²•',color:'#c084fc',cnt:100,size:5,life:3,speed:2},
    {name:'ğŸ’¥í­ë°œ',color:'#f87171',cnt:300,size:10,life:1,speed:8},
    {name:'ğŸ’«ë³„',color:'#fbbf24',cnt:80,size:4,life:4,speed:1},
    {name:'ğŸŒ¿ì',color:'#86efac',cnt:60,size:6,life:5,speed:1},
    {name:'ğŸ’¨ì—°ê¸°',color:'#6c7086',cnt:150,size:12,life:4,speed:1.5},
    {name:'â„ëˆˆ',color:'#e0e8ff',cnt:200,size:3,life:6,speed:0.5},
    {name:'ğŸ’§ë¬¼ë°©ìš¸',color:'#60a5fa',cnt:100,size:4,life:2,speed:4},
    {name:'âš¡ì „ê¸°',color:'#22d3ee',cnt:50,size:3,life:0.5,speed:10},
    {name:'ğŸŒ¸ê½ƒì',color:'#f5c2e7',cnt:80,size:5,life:5,speed:0.8},
];
let partPresetIdx=0;
function openPartEditor(){$('partModal').style.display='flex';$('partPresets').innerHTML=PART_PRESETS.map((p,i)=>`<button class="dtab${i===0?' on':''}" onclick="partPresetIdx=${i};partLoadPreset(${i});document.querySelectorAll('#partPresets .dtab').forEach(b=>b.classList.remove('on'));this.classList.add('on')" style="font-size:.42em">${p.name}</button>`).join('');}
function partLoadPreset(i){const p=PART_PRESETS[i];$('partCnt').value=p.cnt;$('partSize').value=p.size;$('partColor').value=p.color;$('partLife').value=p.life;}
function partSpawn(){
    const cnt=+$('partCnt').value,size=+$('partSize').value/100,color=$('partColor').value,life=+$('partLife').value;
    const pos=SO?SO.position.clone():new THREE.Vector3(0,2,0);
    const geo=new THREE.BufferGeometry();const positions=new Float32Array(cnt*3);const velocities=[];
    for(let i=0;i<cnt;i++){positions[i*3]=pos.x+(Math.random()-0.5)*2;positions[i*3+1]=pos.y+Math.random()*2;positions[i*3+2]=pos.z+(Math.random()-0.5)*2;velocities.push(new THREE.Vector3((Math.random()-0.5)*2,Math.random()*3,(Math.random()-0.5)*2));}
    geo.setAttribute('position',new THREE.BufferAttribute(positions,3));
    const mat=new THREE.PointsMaterial({color,size,transparent:true,opacity:0.8,blending:THREE.AdditiveBlending});
    const pts=new THREE.Points(geo,mat);pts.name='Particle_'+PART_PRESETS[partPresetIdx].name;pts.userData._particle=true;scene.add(pts);
    // Animate
    const startTime=performance.now();
    const animPart=()=>{const t=(performance.now()-startTime)/1000;if(t>life){scene.remove(pts);return;}
        const pa=pts.geometry.attributes.position;for(let i=0;i<cnt;i++){pa.array[i*3]+=velocities[i].x*0.016;pa.array[i*3+1]+=velocities[i].y*0.016-0.01;pa.array[i*3+2]+=velocities[i].z*0.016;}
        pa.needsUpdate=true;mat.opacity=Math.max(0,0.8*(1-t/life));requestAnimationFrame(animPart);};
    animPart();BH();toast('ğŸ† íŒŒí‹°í´!');LG('ğŸ† íŒŒí‹°í´: '+PART_PRESETS[partPresetIdx].name,'o');boostSisters(1);$('partModal').style.display='none';
}

// â”â”â” 9. ë¨¸í‹°ë¦¬ì–¼ ì—ë””í„° â”â”â”
function openMatEditor(){
    $('matModal').style.display='flex';
    if(SO&&SO.material){$('matTarget').textContent='ì„ íƒ: '+SO.name;$('matColor').value='#'+SO.material.color.getHexString();$('matMetal').value=Math.round((SO.material.metalness||0)*100);$('matRough2').value=Math.round((SO.material.roughness||0.5)*100);$('matOpac').value=Math.round((SO.material.opacity||1)*100);$('matWire').checked=SO.material.wireframe||false;$('matFlat').checked=SO.material.flatShading||false;
        if(SO.material.emissive)$('matEmis').value='#'+SO.material.emissive.getHexString();
    } else $('matTarget').textContent='âš  ë¨¼ì € ì˜¤ë¸Œì íŠ¸ ì„ íƒ!';
}
function matUpdate(){
    if(!SO||!SO.material)return;
    SO.material.color.set($('matColor').value);
    SO.material.metalness=+$('matMetal').value/100;
    SO.material.roughness=+$('matRough2').value/100;
    SO.material.opacity=+$('matOpac').value/100;
    SO.material.transparent=+$('matOpac').value<100;
    SO.material.wireframe=$('matWire').checked;
    SO.material.flatShading=$('matFlat').checked;
    if(SO.material.emissive)SO.material.emissive.set($('matEmis').value);
    SO.material.needsUpdate=true;
}

// â”â”â” 10. NavMesh / A* ê¸¸ì°¾ê¸° â”â”â”
let navGrid=null,navSize=20,navRes=40;
function buildNavMesh(){
    navGrid=Array.from({length:navRes},()=>Array(navRes).fill(0));
    const cellSize=navSize*2/navRes;
    // Mark obstacles
    O.forEach(o=>{if(!o.mesh.isMesh||o.type==='stk'||o.type==='hero'||o.type==='char')return;
        const p=o.mesh.position;const s=o.mesh.scale;
        const minX=Math.floor((p.x-s.x+navSize)/(cellSize)),maxX=Math.ceil((p.x+s.x+navSize)/(cellSize));
        const minZ=Math.floor((p.z-s.z+navSize)/(cellSize)),maxZ=Math.ceil((p.z+s.z+navSize)/(cellSize));
        for(let z=Math.max(0,minZ);z<Math.min(navRes,maxZ);z++)for(let x=Math.max(0,minX);x<Math.min(navRes,maxX);x++)navGrid[z][x]=1;
    });
    LG('ğŸš¶ NavMesh ë¹Œë“œ: '+navRes+'x'+navRes,'o');toast('ğŸš¶ NavMesh!');
    // Visualize
    if(debugMode){const cellSz=navSize*2/navRes;
        for(let z=0;z<navRes;z++)for(let x=0;x<navRes;x++){if(navGrid[z][x])continue;
        const g=new THREE.Mesh(new THREE.PlaneGeometry(cellSz*.8,cellSz*.8),new THREE.MeshBasicMaterial({color:0x22d3ee,transparent:true,opacity:0.1,side:THREE.DoubleSide}));
        g.rotation.x=-Math.PI/2;g.position.set(x*cellSz-navSize+cellSz/2,0.02,z*cellSz-navSize+cellSz/2);g.userData._navViz=true;scene.add(g);}
    }
}
function findPath(startPos,endPos){
    if(!navGrid)buildNavMesh();
    const cellSize=navSize*2/navRes;
    const toGrid=p=>({x:Math.floor((p.x+navSize)/cellSize),z:Math.floor((p.z+navSize)/cellSize)});
    const s=toGrid(startPos),e=toGrid(endPos);
    if(s.x<0||s.x>=navRes||s.z<0||s.z>=navRes)return[];
    // A*
    const open=[{x:s.x,z:s.z,g:0,f:0,parent:null}],closed=new Set();
    const h=(a,b)=>Math.abs(a.x-b.x)+Math.abs(a.z-b.z);
    while(open.length){
        open.sort((a,b)=>a.f-b.f);const cur=open.shift();const key=cur.x+','+cur.z;
        if(closed.has(key))continue;closed.add(key);
        if(cur.x===e.x&&cur.z===e.z){const path=[];let c=cur;while(c){path.unshift({x:c.x*cellSize-navSize+cellSize/2,z:c.z*cellSize-navSize+cellSize/2});c=c.parent;}return path;}
        for(const[dx,dz]of[[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]){
            const nx=cur.x+dx,nz=cur.z+dz;if(nx<0||nx>=navRes||nz<0||nz>=navRes||navGrid[nz][nx]||closed.has(nx+','+nz))continue;
            const ng=cur.g+(dx&&dz?1.414:1);open.push({x:nx,z:nz,g:ng,f:ng+h({x:nx,z:nz},e),parent:cur});
        }
    }
    return[];
}

// â”â”â” 11. ë¬¼ ì…°ì´ë” â”â”â”
function addWater(x,z,size){
    const geo=new THREE.PlaneGeometry(size||10,size||10,32,32);geo.rotateX(-Math.PI/2);
    const mat=new THREE.MeshStandardMaterial({color:0x1a6fc4,transparent:true,opacity:0.6,roughness:0.1,metalness:0.3,side:THREE.DoubleSide});
    const water=new THREE.Mesh(geo,mat);water.position.set(x||0,0.1,z||0);water.name='Water';water.userData._water=true;scene.add(water);
    // Animate waves
    const animWater=()=>{const t=performance.now()*0.001;const pos=water.geometry.attributes.position;
        for(let i=0;i<pos.count;i++){const ox=pos.getX(i),oz=pos.getZ(i);pos.setY(i,Math.sin(ox*2+t)*0.15+Math.cos(oz*3+t*0.7)*0.1);}
        pos.needsUpdate=true;water.geometry.computeVertexNormals();requestAnimationFrame(animWater);};
    animWater();BH();LG('ğŸ’§ ë¬¼ ì¶”ê°€','o');toast('ğŸ’§ ë¬¼!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 2 ROUND 3: ë¹Œë“œ + ë¸”ë£¨í”„ë¦°íŠ¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 12. í”„ë¦¬ì…‹ ë¸”ë£¨í”„ë¦°íŠ¸ â”â”â”
const BLUEPRINTS={
    fps:{name:'FPS ìºë¦­í„°',desc:'1ì¸ì¹­ ì´ë™+ì í”„+ì¹´ë©”ë¼',objects:[{type:'stk',name:'Player',pos:[0,0,0]}],script:'// WASD ì´ë™+ë§ˆìš°ìŠ¤ ì¹´ë©”ë¼+ìŠ¤í˜ì´ìŠ¤ ì í”„ (ê¸°ë³¸ ë‚´ì¥)'},
    rpg:{name:'RPG ìŠ¤íƒ€í„°',desc:'í”Œë ˆì´ì–´+NPC+ëª¬ìŠ¤í„°+ì•„ì´í…œ',objects:[{type:'hero',name:'Hero',pos:[0,0,0]},{type:'npc',name:'ë§ˆì„ ì¥ë¡œ',pos:[3,0,0]},{type:'npc',name:'ìƒì  ì£¼ì¸',pos:[-3,0,2]},{type:'mon',name:'ìŠ¬ë¼ì„',pos:[0,0,-5]},{type:'sphere',name:'Item_Potion',pos:[2,0.5,3],scale:[0.3,0.3,0.3],color:'#86efac'}]},
    td:{name:'íƒ€ì›Œë””íœìŠ¤',desc:'ê²½ë¡œ+íƒ€ì›Œ ë°°ì¹˜+ì›¨ì´ë¸Œ',objects:[{type:'plane',name:'Ground',pos:[0,-0.5,0],scale:[20,1,20],color:'#3a5a2a'},{type:'cube',name:'Tower1',pos:[-3,1,0],color:'#60a5fa'},{type:'cube',name:'Tower2',pos:[3,1,0],color:'#60a5fa'},{type:'mon',name:'Wave1_1',pos:[0,0,-8]},{type:'mon',name:'Wave1_2',pos:[1,0,-9]}]},
    puzzle:{name:'í¼ì¦ ê²Œì„',desc:'ì´ë™ ê°€ëŠ¥í•œ ë¸”ë¡+ëª©í‘œ ì§€ì ',objects:[{type:'cube',name:'Block1',pos:[-2,0.5,0],color:'#fbbf24'},{type:'cube',name:'Block2',pos:[2,0.5,0],color:'#fbbf24'},{type:'cube',name:'Goal',pos:[0,0.1,-4],scale:[2,0.2,2],color:'#86efac'}]},
    horror:{name:'ê³µí¬ ê²Œì„',desc:'ì–´ë‘ìš´ í™˜ê²½+ì†ì „ë“±',objects:[{type:'stk',name:'Player',pos:[0,0,0]},{type:'light',name:'Flashlight',pos:[0,1.5,0]}]},
};
function spawnBlueprint(key){
    const bp=BLUEPRINTS[key];if(!bp)return;
    bp.objects.forEach(od=>{const o=AO(od.type,new THREE.Vector3(...(od.pos||[0,0,0])));if(o){o.mesh.name=od.name;if(od.scale)o.mesh.scale.set(...od.scale);if(od.color&&o.mesh.material)o.mesh.material.color.set(od.color);}});
    if(key==='horror')setSkybox('night');
    BH();boostSisters(3);toast('ğŸ“¦ '+bp.name);LG('ğŸ“¦ ë¸”ë£¨í”„ë¦°íŠ¸: '+bp.name,'o');
}

// â”â”â” 13. ë¹Œë“œ ì‹œìŠ¤í…œ â”â”â”
function buildGame(){
    const name=$('buildName').value||'MyGame';
    const sceneData=O.map(o=>({type:o.type,name:o.mesh.name,pos:[o.mesh.position.x,o.mesh.position.y,o.mesh.position.z],rot:[o.mesh.rotation.x,o.mesh.rotation.y,o.mesh.rotation.z],scale:[o.mesh.scale.x,o.mesh.scale.y,o.mesh.scale.z],color:o.mesh.material?.color?'#'+o.mesh.material.color.getHexString():null}));
    let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${name}</title><style>*{margin:0;padding:0}body{overflow:hidden;background:#000}canvas{width:100vw;height:100vh}</style></head><body>`;
    html+=`<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script><script>`;
    html+=`const scene=new THREE.Scene();scene.background=new THREE.Color('#1a1a2e');`;
    html+=`const cam=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,1000);cam.position.set(0,5,8);cam.lookAt(0,0,0);`;
    html+=`const ren=new THREE.WebGLRenderer({antialias:true});ren.setSize(innerWidth,innerHeight);document.body.appendChild(ren.domElement);`;
    html+=`scene.add(new THREE.AmbientLight(0x404060,0.6));const sun=new THREE.DirectionalLight(0xffffff,1);sun.position.set(5,10,5);scene.add(sun);`;
    html+=`const objs=${JSON.stringify(sceneData)};`;
    html+=`objs.forEach(o=>{let m;const mat=new THREE.MeshStandardMaterial({color:o.color||'#89b4fa'});`;
    html+=`if(o.type==='cube')m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),mat);`;
    html+=`else if(o.type==='sphere')m=new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16),mat);`;
    html+=`else if(o.type==='plane'){m=new THREE.Mesh(new THREE.PlaneGeometry(1,1),mat);m.rotation.x=-Math.PI/2;}`;
    html+=`else m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),mat);`;
    html+=`m.position.set(...o.pos);m.rotation.set(...o.rot);m.scale.set(...o.scale);scene.add(m);});`;
    html+=`function animate(){requestAnimationFrame(animate);ren.render(scene,cam);}animate();`;
    html+=`<\/script></body></html>`;

    // Download
    const blob=new Blob([html],{type:'text/html'});const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=name+'.html';a.click();URL.revokeObjectURL(url);

    let result=`<div style="color:var(--gn)">âœ… ë¹Œë“œ ì™„ë£Œ!</div><div>${name}.html (${(html.length/1024).toFixed(1)}KB)</div><div>ì˜¤ë¸Œì íŠ¸: ${sceneData.length}ê°œ</div>`;

    if($('buildEmbed').checked){
        const embedCode=`<iframe src="${name}.html" width="800" height="600" frameborder="0"></iframe>`;
        result+=`<div style="margin-top:4px;color:var(--sk)">ğŸ”— ì„ë² ë“œ ì½”ë“œ:</div><textarea style="width:100%;height:30px;background:var(--bg3);border:1px solid var(--bd);color:var(--tx);font-size:.8em;border-radius:3px;padding:2px" readonly>${embedCode}</textarea>`;
    }
    $('buildResult').innerHTML=result;LG('ğŸ“¦ ë¹Œë“œ: '+name+'.html ('+sceneData.length+'obj)','o');toast('ğŸ“¦ ë¹Œë“œ ì™„ë£Œ!');
}

// Keyboard for R2
document.addEventListener('keydown',e=>{
    if(e.key==='n'&&e.ctrlKey){e.preventDefault();openNodeEditor();}
    if(e.key==='b'&&e.ctrlKey){e.preventDefault();$('buildModal').style.display='flex';}
    if(e.key==='m'&&e.ctrlKey){e.preventDefault();openMatEditor();}
});

LG('â•â•â• Phase 2 R2+R3: ë¹„ì£¼ì–¼+ì—ë””í„°+ë¹Œë“œ ì¶”ê°€! â•â•â•','o');
LG('ğŸ”·ë…¸ë“œ(Ctrl+N) ğŸ†íŒŒí‹°í´ ğŸ”²ë¨¸í‹°ë¦¬ì–¼(Ctrl+M) ğŸš¶NavMesh ğŸ’§ë¬¼ ğŸ“¦ë¹Œë“œ(Ctrl+B)','o');
LG('ğŸ“¦ ë¸”ë£¨í”„ë¦°íŠ¸: fps/rpg/td/puzzle/horror','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 3: 13ê°œ ì‹ ê·œ ì‹œìŠ¤í…œ í†µí•©
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” DB API í™•ì¥: ì¦‰ì‹œ êº¼ë‚´ì“°ê¸° í—¬í¼ â”â”â”
DB.charsByClass=cls=>DB.where('chars',{cls});
DB.charsByRace=race=>DB.where('chars',{race});
DB.epicChars=()=>DB.byGrade('chars','epic');
DB.mythicChars=()=>DB.byGrade('chars','mythic');
DB.legendaryItems=()=>DB.byGrade('items','Legendary');
DB.attackSkills=()=>DB.byType('skills','ê³µê²©');
DB.healSkills=()=>DB.byType('skills','ì¹˜ìœ ');
DB.bossMons=()=>DB.byType('mons','Boss');
DB.eliteMons=()=>DB.byType('mons','Elite');
DB.mainQuests=()=>DB.byType('quests','Main');
DB.shopNpcs=()=>DB.byType('npcs','Shop');
DB.hardDungs=()=>DB.where('dungs',{diff:'Hard'});
DB.hellDungs=()=>DB.where('dungs',{diff:'Hell'});
DB.combatPets=()=>DB.byType('pets','Combat');
DB.findByBiome=b=>DB.where('regions',{biome:b});
// ì²´ì¸ í•„í„°: DB.chain('chars').grade('epic').element('í™”ì—¼').sort('atk').get()
DB.chain=function(cat){
    let arr=[...(GD[cat]||[])];
    const c={
        grade(g){arr=arr.filter(x=>(x.grade||x.rarity)===g);return c;},
        element(e){arr=arr.filter(x=>x.el===e);return c;},
        type(t){arr=arr.filter(x=>x.type===t);return c;},
        cls(cl){arr=arr.filter(x=>x.cls===cl);return c;},
        race(r){arr=arr.filter(x=>x.race===r);return c;},
        hp(min,max){arr=arr.filter(x=>x.hp>=min&&(!max||x.hp<=max));return c;},
        atk(min,max){arr=arr.filter(x=>x.atk>=min&&(!max||x.atk<=max));return c;},
        sort(k,d){const dir=d==='desc'?-1:1;arr.sort((a,b)=>((a[k]||0)-(b[k]||0))*dir);return c;},
        limit(n){arr=arr.slice(0,n);return c;},
        get(){return arr;},
        first(){return arr[0]||null;},
        count(){return arr.length;},
        names(){return arr.map(x=>x.name);},
        ids(){return arr.map(x=>x.id);},
        pick(...keys){return arr.map(x=>{const o={};keys.forEach(k=>o[k]=x[k]);return o;});},
        toTable(){console.table(arr);return c;},
    };
    return c;
};
// DB ë‹¤ì´ë ‰íŠ¸ ì ‘ê·¼: DB.chars, DB.mons ë“± (í”„ë¡œí¼í‹°)
Object.keys(GD).forEach(k=>{if(Array.isArray(GD[k]))Object.defineProperty(DB,k,{get(){return GD[k];}});});

// â”â”â” 1. ìƒì  ì‹œìŠ¤í…œ â”â”â”
const SHOP_ITEMS=[
    {id:'sp1',name:'ì²´ë ¥ í¬ì…˜',icon:'ğŸ§ª',desc:'HP +50',hp:50,price:50,weight:1,stack:10},
    {id:'sp2',name:'ë§ˆë‚˜ í¬ì…˜',icon:'ğŸ’™',desc:'MP +30',mp:30,price:40,weight:1,stack:10},
    {id:'sp3',name:'ê°•í™”ì„',icon:'ğŸ’',desc:'ì¥ë¹„ ê°•í™” ì¬ë£Œ',price:200,weight:1,stack:5},
    {id:'sp4',name:'ê·€í™˜ ìŠ¤í¬ë¡¤',icon:'ğŸ“œ',desc:'ë§ˆì„ë¡œ ê·€í™˜',price:30,weight:0.5,stack:20},
    {id:'sp5',name:'í•´ë…ì œ',icon:'ğŸ§´',desc:'ë… ìƒíƒœ í•´ì œ',price:25,weight:0.5,stack:10},
    {id:'sp6',name:'ë¶€í™œì„',icon:'âœ¨',desc:'ì¦‰ì‹œ ë¶€í™œ',price:500,weight:2,stack:3},
    {id:'sp7',name:'ì´ˆë³´ìì˜ ê²€',icon:'ğŸ—¡',type:'weapon',desc:'ATK+15',atk:15,price:300,weight:3,rarity:'common'},
    {id:'sp8',name:'ê°€ì£½ ê°‘ì˜·',icon:'ğŸ›¡',type:'armor',desc:'DEF+10',def:10,price:250,weight:5,rarity:'common'},
];
function openShop(){
    const h=SHOP_ITEMS.map(it=>`<div style="display:flex;align-items:center;gap:6px;padding:3px 0;border-bottom:1px solid #252840"><span style="font-size:1em">${it.icon}</span><div style="flex:1"><div style="font-size:.5em;color:#e8eaff">${it.name}</div><div style="font-size:.38em;color:#8e92b8">${it.desc}</div></div><button onclick="buyItem('${it.id}')" style="padding:2px 8px;background:#fbbf24;color:#000;border:none;border-radius:3px;font-size:.45em;font-weight:600;cursor:pointer">${it.price}G</button></div>`).join('');
    const d=document.createElement('div');d.id='shopOverlay';d.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center';
    d.innerHTML=`<div style="background:#0c0e18;border:1px solid #fbbf24;border-radius:10px;width:320px;padding:12px;max-height:80vh;overflow-y:auto"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:.7em;font-weight:700;color:#fbbf24">ğŸª ìƒì </span><span style="font-size:.5em;color:#fbbf24">ğŸ’° ${playerGold}G</span><button onclick="document.getElementById('shopOverlay').remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>${h}</div>`;
    document.body.appendChild(d);
}
function buyItem(id){const it=SHOP_ITEMS.find(x=>x.id===id);if(!it)return;if(playerGold<it.price)return toast('ğŸ’° ê³¨ë“œ ë¶€ì¡±!');playerGold-=it.price;addItem({...it,count:1});renderInv();}
function sellItem(idx){const it=inventory[idx];if(!it)return;const price=Math.floor((it.price||50)/2);playerGold+=price;toast(`ğŸ’° +${price}G`);if(it.count>1)it.count--;else inventory[idx]=null;renderInv();}

// â”â”â” 2. ìŠ¤í‚¬ ì‹œìŠ¤í…œ + í•«ë°” â”â”â”
let playerSkills=[],skillCooldowns={};
const SKILL_PRESETS=[
    {id:'sk1',name:'íŒŒì´ì–´ë³¼',icon:'ğŸ”¥',el:'í™”ì—¼',dmg:80,cd:3,cost:20,desc:'í™”ì—¼ ë§ˆë²•'},
    {id:'sk2',name:'ì•„ì´ìŠ¤ ìŠ¤í”¼ì–´',icon:'â„ï¸',el:'ëƒ‰ê¸°',dmg:60,cd:2,cost:15,desc:'ëƒ‰ê¸° ë§ˆë²•'},
    {id:'sk3',name:'ì¬ë”ë³¼íŠ¸',icon:'âš¡',el:'ë²ˆê°œ',dmg:120,cd:5,cost:35,desc:'ë²ˆê°œ ë§ˆë²•'},
    {id:'sk4',name:'íë§',icon:'ğŸ’š',el:'ë¹›',dmg:0,cd:4,cost:25,heal:60,desc:'HP íšŒë³µ'},
    {id:'sk5',name:'ì‰´ë“œ',icon:'ğŸ›¡',el:'ëŒ€ì§€',dmg:0,cd:8,cost:30,buff:'def',desc:'ë°©ì–´ +50%'},
];
playerSkills=SKILL_PRESETS.slice(0,4);
function useSkill(idx){
    const sk=playerSkills[idx];if(!sk)return;
    if(skillCooldowns[sk.id]>Date.now())return toast(`â± ì¿¨íƒ€ì„ ${((skillCooldowns[sk.id]-Date.now())/1000).toFixed(1)}ì´ˆ`);
    skillCooldowns[sk.id]=Date.now()+sk.cd*1000;
    if(sk.heal)toast(`${sk.icon} ${sk.name}: HP +${sk.heal}`);
    else if(sk.buff)toast(`${sk.icon} ${sk.name}: ${sk.buff} ë²„í”„!`);
    else toast(`${sk.icon} ${sk.name}: ${sk.dmg} ë°ë¯¸ì§€!`);
    LG(`âš” ìŠ¤í‚¬: ${sk.name} (${sk.dmg||sk.heal})`,'o');
}

// â”â”â” 3. ì „íˆ¬ ì‹œìŠ¤í…œ â”â”â”
let combatActive=false,combatEnemy=null,playerHP=100,playerMaxHP=100,playerMP=50,playerMaxMP=50;
function startCombat(monData){
    combatActive=true;combatEnemy={...monData,curHP:monData.hp};
    playerHP=playerMaxHP;playerMP=playerMaxMP;
    toast(`âš” ì „íˆ¬ ì‹œì‘: ${monData.name}!`);LG(`âš” ì „íˆ¬: ${monData.name} HP:${monData.hp}`,'o');
}
function combatAttack(){
    if(!combatActive||!combatEnemy)return;
    const pAtk=equipped.weapon?.atk||10;const dmg=Math.max(1,pAtk+Math.random()*10|0-combatEnemy.def*0.2);
    combatEnemy.curHP-=dmg;toast(`âš” â†’ ${combatEnemy.name}: ${dmg}dmg`);
    if(combatEnemy.curHP<=0){combatVictory();return;}
    // Enemy attacks back
    const eDmg=Math.max(1,combatEnemy.atk*0.5+Math.random()*8|0);playerHP-=eDmg;
    toast(`ğŸ’¥ â† ${combatEnemy.name}: ${eDmg}dmg`);
    if(playerHP<=0){toast('ğŸ’€ íŒ¨ë°°...');combatActive=false;}
}
function combatVictory(){
    const gold=Math.round(combatEnemy.hp/10+Math.random()*50);const xp=Math.round(combatEnemy.hp/5);
    playerGold+=gold;toast(`ğŸ‰ ìŠ¹ë¦¬! +${gold}G +${xp}XP`);
    updateQuest('q1',1); // Update kill quests
    combatActive=false;combatEnemy=null;boostSisters(2);
}

// â”â”â” 4. ì›¨ì´ë¸Œ ìŠ¤í° ì‹œìŠ¤í…œ â”â”â”
let waveNum=0,waveActive=false,waveEnemies=[];
function startWave(){
    waveNum++;waveActive=true;
    const count=3+waveNum*2;const mons=DB.randomN('mons',Math.min(count,10));
    waveEnemies=[];
    mons.forEach((m,i)=>{
        const pos=new THREE.Vector3((Math.random()-0.5)*15,0,-8-Math.random()*5);
        const obj=AO('mon',pos);if(obj){obj.mesh.name=m.name;waveEnemies.push({obj,data:m,hp:m.hp});}
    });
    BH();toast(`ğŸŒŠ Wave ${waveNum}: ì  ${mons.length}ë§ˆë¦¬!`);LG(`ğŸŒŠ Wave ${waveNum}: ${mons.length}ë§ˆë¦¬`,'o');
}
function endWave(){waveActive=false;waveEnemies.forEach(e=>scene.remove(e.obj.mesh));waveEnemies=[];toast(`âœ… Wave ${waveNum} í´ë¦¬ì–´!`);boostSisters(3);}

// â”â”â” 5. ë“œë¡­ í…Œì´ë¸” (ë£¨íŒ…) â”â”â”
const LOOT_TABLES={
    common:[{item:'sp1',chance:0.5,min:1,max:3},{item:'sp4',chance:0.2,min:1,max:1}],
    elite:[{item:'sp1',chance:0.7,min:2,max:5},{item:'sp3',chance:0.3,min:1,max:2},{item:'sp6',chance:0.05,min:1,max:1}],
    boss:[{item:'sp3',chance:0.8,min:3,max:5},{item:'sp6',chance:0.3,min:1,max:2},{item:'sp7',chance:0.15,min:1,max:1},{item:'sp8',chance:0.15,min:1,max:1}],
};
function rollLoot(table){
    const drops=[];const lt=LOOT_TABLES[table]||LOOT_TABLES.common;
    lt.forEach(l=>{if(Math.random()<l.chance){const cnt=l.min+Math.floor(Math.random()*(l.max-l.min+1));const item=SHOP_ITEMS.find(x=>x.id===l.item);if(item)drops.push({...item,count:cnt});}});
    return drops;
}
function applyLoot(drops){drops.forEach(d=>addItem(d));}

// â”â”â” 6. ë¯¸ë‹ˆë§µ â”â”â”
let minimapEnabled=true;
function renderMinimap(){
    if(!minimapEnabled||!PM||!PO)return;
    let mm=document.getElementById('minimap');
    if(!mm){mm=document.createElement('canvas');mm.id='minimap';mm.width=120;mm.height=120;mm.style.cssText='position:fixed;bottom:10px;right:10px;border:2px solid #353860;border-radius:8px;background:rgba(10,10,24,.8);z-index:94';document.body.appendChild(mm);}
    const cx=mm.getContext('2d');cx.clearRect(0,0,120,120);
    cx.fillStyle='#0a0c14';cx.fillRect(0,0,120,120);
    const scale=3,ox=60-PO.mesh.position.x*scale,oz=60-PO.mesh.position.z*scale;
    O.forEach(o=>{const x=o.mesh.position.x*scale+ox,z=o.mesh.position.z*scale+oz;
        if(x<0||x>120||z<0||z>120)return;
        cx.fillStyle=o.type==='mon'||o.type==='boss'?'#f87171':o.type==='npc'?'#86efac':o.type==='hero'||o.type==='stk'||o.type==='char'?'#fbbf24':'#353860';
        cx.fillRect(x-1.5,z-1.5,3,3);
    });
    // Player
    cx.fillStyle='#60a5fa';cx.beginPath();cx.arc(60,60,3,0,Math.PI*2);cx.fill();
    // Direction
    cx.strokeStyle='#60a5fa';cx.lineWidth=1;cx.beginPath();cx.moveTo(60,60);cx.lineTo(60-Math.sin(pYaw||0)*8,60-Math.cos(pYaw||0)*8);cx.stroke();
}
setInterval(renderMinimap,200);

// â”â”â” 7. í•«ë°” (í€µìŠ¬ë¡¯) â”â”â”
function renderHotbar(){
    let hb=document.getElementById('hotbar');
    if(!hb){hb=document.createElement('div');hb.id='hotbar';hb.style.cssText='position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:3px;z-index:94';document.body.appendChild(hb);}
    hb.innerHTML=playerSkills.map((sk,i)=>{
        const onCD=skillCooldowns[sk.id]>Date.now();const cdLeft=onCD?((skillCooldowns[sk.id]-Date.now())/1000).toFixed(0):'';
        return`<div onclick="useSkill(${i})" style="width:40px;height:40px;background:${onCD?'#1a1a2e':'#0c0e18'};border:1px solid ${onCD?'#353860':'#60a5fa'};border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;font-size:18px;opacity:${onCD?0.5:1}" title="${sk.name}">${sk.icon}${onCD?`<span style="position:absolute;font-size:8px;color:#f87171;bottom:1px">${cdLeft}s</span>`:`<span style="position:absolute;font-size:7px;color:#5a5e80;bottom:1px">${i+1}</span>`}</div>`;
    }).join('')+`<div style="width:1px;background:#353860;margin:0 2px"></div>`+
    SHOP_ITEMS.slice(0,2).map((it,i)=>`<div onclick="useItem(${inventory.findIndex(x=>x&&x.id===it.id)})" style="width:40px;height:40px;background:#0c0e18;border:1px solid #fbbf24;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px" title="${it.name}">${it.icon}</div>`).join('');
}
setInterval(()=>{if(PM)renderHotbar();else{const hb=document.getElementById('hotbar');if(hb)hb.remove();}},500);

// â”â”â” 8. ì—…ì  ì‹œìŠ¤í…œ â”â”â”
let achievements=[],unlockedAch=new Set();
const ACH_LIST=[
    {id:'ach1',name:'ì²« ë°œê±¸ìŒ',desc:'ì²« ì˜¤ë¸Œì íŠ¸ ìƒì„±',icon:'ğŸ‘£',check:()=>O.length>=1},
    {id:'ach2',name:'ê±´ì¶•ê°€',desc:'ì˜¤ë¸Œì íŠ¸ 10ê°œ ìƒì„±',icon:'ğŸ—',check:()=>O.length>=10},
    {id:'ach3',name:'ë¶€ì',desc:'ê³¨ë“œ 1000 ì´ìƒ',icon:'ğŸ’°',check:()=>playerGold>=1000},
    {id:'ach4',name:'ìˆ˜ì§‘ê°€',desc:'ì¸ë²¤í† ë¦¬ 5ì¹¸ ì±„ìš°ê¸°',icon:'ğŸ’',check:()=>inventory.filter(Boolean).length>=5},
    {id:'ach5',name:'ëª¨í—˜ê°€',desc:'í€˜ìŠ¤íŠ¸ 1ê°œ ì™„ë£Œ',icon:'ğŸ“‹',check:()=>completedQuests.length>=1},
    {id:'ach6',name:'ì „ì‚¬',desc:'Wave 3 í´ë¦¬ì–´',icon:'âš”',check:()=>waveNum>=3},
    {id:'ach7',name:'íƒí—˜ê°€',desc:'6ê°œ í™˜ê²½ í”„ë¦¬ì…‹ ì‚¬ìš©',icon:'ğŸŒ',check:()=>false},
    {id:'ach8',name:'ë§ˆì—ìŠ¤íŠ¸ë¡œ',desc:'BGM ì‘ê³¡',icon:'ğŸµ',check:()=>!!window._musData},
    {id:'ach9',name:'ì˜ˆìˆ ê°€',desc:'í…ìŠ¤ì²˜ ìƒì„±',icon:'ğŸ¨',check:()=>$('texCV').style.display!=='none'},
    {id:'ach10',name:'ìŠ¤ìŠ¹',desc:'ì„ ìƒë‹˜ ë ˆë²¨ 5 ì´ìƒ',icon:'ğŸ“',check:()=>(typeof tLV!=='undefined'&&tLV>=5)},
];
function checkAchievements(){
    ACH_LIST.forEach(a=>{if(!unlockedAch.has(a.id)&&a.check()){unlockedAch.add(a.id);toast(`ğŸ† ì—…ì  ë‹¬ì„±: ${a.icon} ${a.name}!`);LG(`ğŸ† ì—…ì : ${a.name}`,'o');boostSisters(2);}});
}
setInterval(checkAchievements,5000);

// â”â”â” 9. AI ìˆœì°°/í–‰ë™ ì‹œìŠ¤í…œ â”â”â”
let aiBehaviors=[];
function addAIBehavior(obj,type,params){
    const b={obj,type,params:{...{speed:2,range:8,pauseTime:2},patrolPoints:[],target:null,...params},state:'idle',timer:0,idx:0};
    aiBehaviors.push(b);LG(`ğŸ¤– AIí–‰ë™: ${obj.mesh.name} â†’ ${type}`,'o');return b;
}
function updateAIBehaviors(dt){
    aiBehaviors.forEach(b=>{
        if(!b.obj||!b.obj.mesh)return;const p=b.obj.mesh.position;
        if(b.type==='patrol'){
            if(!b.params.patrolPoints.length){// Auto-generate patrol
                for(let i=0;i<4;i++)b.params.patrolPoints.push(new THREE.Vector3((Math.random()-0.5)*b.params.range*2,0,(Math.random()-0.5)*b.params.range*2));
            }
            const target=b.params.patrolPoints[b.idx];if(!target)return;
            const dx=target.x-p.x,dz=target.z-p.z,dist=Math.hypot(dx,dz);
            if(dist<0.5){b.timer+=dt;if(b.timer>b.params.pauseTime){b.timer=0;b.idx=(b.idx+1)%b.params.patrolPoints.length;}}
            else{const s=b.params.speed*dt;p.x+=dx/dist*s;p.z+=dz/dist*s;b.obj.mesh.rotation.y=Math.atan2(dx,dz);}
        }
        if(b.type==='chase'&&PO){
            const tp=PO.mesh.position;const dx=tp.x-p.x,dz=tp.z-p.z,dist=Math.hypot(dx,dz);
            if(dist<b.params.range&&dist>1.5){const s=b.params.speed*dt;p.x+=dx/dist*s;p.z+=dz/dist*s;b.obj.mesh.rotation.y=Math.atan2(dx,dz);}
        }
    });
}

// â”â”â” 10. ì œì‘ ì‹œìŠ¤í…œ â”â”â”
const CRAFT_RECIPES=[
    {id:'cr1',name:'ê°•í™”ëœ ê²€',icon:'âš”',result:{id:'csw',name:'ê°•í™”ëœ ê²€',icon:'âš”',type:'weapon',atk:30,weight:3,rarity:'rare',desc:'ATK+30'},mats:[{id:'sp3',count:2},{id:'sp7',count:1}]},
    {id:'cr2',name:'ê°•í™”ëœ ê°‘ì˜·',icon:'ğŸ›¡',result:{id:'car',name:'ê°•í™”ëœ ê°‘ì˜·',icon:'ğŸ›¡',type:'armor',def:20,weight:5,rarity:'rare',desc:'DEF+20'},mats:[{id:'sp3',count:3},{id:'sp8',count:1}]},
    {id:'cr3',name:'ê³ ê¸‰ í¬ì…˜',icon:'ğŸ§ª',result:{id:'hpot',name:'ê³ ê¸‰ ì²´ë ¥ í¬ì…˜',icon:'ğŸ§ª',hp:150,weight:1,stack:5,desc:'HP+150'},mats:[{id:'sp1',count:3}]},
];
function openCraft(){
    const h=CRAFT_RECIPES.map(r=>{
        const canCraft=r.mats.every(m=>{const have=inventory.filter(x=>x&&x.id===m.id).reduce((s,x)=>s+x.count,0);return have>=m.count;});
        return`<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid #252840"><span style="font-size:1em">${r.icon}</span><div style="flex:1"><div style="font-size:.5em;color:#e8eaff">${r.name}</div><div style="font-size:.36em;color:#8e92b8">${r.mats.map(m=>{const it=SHOP_ITEMS.find(x=>x.id===m.id);return(it?.icon||'?')+m.count;}).join(' + ')}</div></div><button onclick="craftItem('${r.id}')" style="padding:2px 8px;background:${canCraft?'#86efac':'#353860'};color:${canCraft?'#000':'#5a5e80'};border:none;border-radius:3px;font-size:.45em;font-weight:600;cursor:pointer">${canCraft?'ì œì‘':'ì¬ë£Œ ë¶€ì¡±'}</button></div>`;
    }).join('');
    const d=document.createElement('div');d.id='craftOverlay';d.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:flex;align-items:center;justify-content:center';
    d.innerHTML=`<div style="background:#0c0e18;border:1px solid #86efac;border-radius:10px;width:320px;padding:12px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:.7em;font-weight:700;color:#86efac">ğŸ”¨ ì œì‘</span><button onclick="document.getElementById('craftOverlay').remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>${h}</div>`;
    document.body.appendChild(d);
}
function craftItem(id){
    const r=CRAFT_RECIPES.find(x=>x.id===id);if(!r)return;
    for(const m of r.mats){let need=m.count;for(let i=0;i<INV_MAX&&need>0;i++){if(inventory[i]&&inventory[i].id===m.id){const take=Math.min(need,inventory[i].count);inventory[i].count-=take;need-=take;if(inventory[i].count<=0)inventory[i]=null;}}}
    addItem({...r.result,count:1});toast(`ğŸ”¨ ì œì‘: ${r.result.name}!`);LG(`ğŸ”¨ ì œì‘: ${r.result.name}`,'o');boostSisters(2);
    document.getElementById('craftOverlay')?.remove();
}

// â”â”â” 11. ê²Œì„ ìƒíƒœ ì§ë ¬í™” â”â”â”
const GameState={
    serialize(){return JSON.stringify({
        objects:O.map(o=>({id:o.id,type:o.type,name:o.mesh.name,pos:[o.mesh.position.x,o.mesh.position.y,o.mesh.position.z],rot:[o.mesh.rotation.x,o.mesh.rotation.y,o.mesh.rotation.z],scale:[o.mesh.scale.x,o.mesh.scale.y,o.mesh.scale.z]})),
        player:{hp:playerHP,maxHP:playerMaxHP,mp:playerMP,gold:playerGold,skills:playerSkills.map(s=>s.id)},
        inventory:inventory.map(x=>x?{id:x.id,count:x.count}:null),
        equipped:Object.fromEntries(Object.entries(equipped).map(([k,v])=>[k,v?v.id:null])),
        quests:{active:activeQuests,completed:completedQuests.map(q=>q.id)},
        achievements:[...unlockedAch],
        wave:waveNum,sky:curSky,weather:weatherState,dayTime,
    });},
    deserialize(json){try{const d=JSON.parse(json);return d;}catch(e){return null;}},
    export(){const d=GameState.serialize();const a=document.createElement('a');a.download='gamestate.json';a.href='data:application/json;charset=utf-8,'+encodeURIComponent(d);a.click();toast('ğŸ’¾ ìƒíƒœ ë‚´ë³´ë‚´ê¸°!');},
    import(json){const d=GameState.deserialize(json);if(!d)return toast('íŒŒì‹± ì‹¤íŒ¨!');
        if(d.player){playerHP=d.player.hp;playerMaxHP=d.player.maxHP;playerMP=d.player.mp;playerGold=d.player.gold;}
        if(d.quests){activeQuests=d.quests.active||[];d.quests.completed?.forEach(id=>completedQuests.push({id,name:id}));}
        if(d.achievements)d.achievements.forEach(a=>unlockedAch.add(a));
        if(d.wave)waveNum=d.wave;if(d.sky)setSkybox(d.sky);if(d.weather)setWeather(d.weather);
        toast('ğŸ“‚ ìƒíƒœ ë³µì›!');
    },
};

// â”â”â” 12. ì»·ì‹  ì‹œìŠ¤í…œ â”â”â”
let cutsceneActive=false;
function playCutscene(scenes){
    if(!scenes||!scenes.length)return;cutsceneActive=true;let idx=0;
    const overlay=document.createElement('div');overlay.id='cutsceneOverlay';
    overlay.style.cssText='position:fixed;inset:0;background:#000;z-index:200;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:opacity .5s';
    function showFrame(){
        if(idx>=scenes.length){overlay.style.opacity='0';setTimeout(()=>{overlay.remove();cutsceneActive=false;},500);return;}
        const s=scenes[idx];
        overlay.innerHTML=`<div style="text-align:center;max-width:600px;padding:20px"><div style="font-size:2em;margin-bottom:20px">${s.icon||'ğŸ¬'}</div><div style="font-size:1.1em;color:#e8eaff;margin-bottom:12px;line-height:1.6">${s.text}</div><div style="font-size:.6em;color:#5a5e80">${idx+1}/${scenes.length} â€” í´ë¦­í•˜ë©´ ë‹¤ìŒ</div></div>`;
        idx++;
    }
    overlay.onclick=showFrame;showFrame();document.body.appendChild(overlay);
}

// â”â”â” 13. ì´í™íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ â”â”â”
const FX={
    explosion(pos){partPresetIdx=2;$('partCnt').value=300;$('partSize').value=10;$('partColor').value='#ff4400';$('partLife').value=1;partSpawn();},
    magic(pos){partPresetIdx=1;$('partCnt').value=100;$('partSize').value=5;$('partColor').value='#c084fc';$('partLife').value=2;partSpawn();},
    heal(pos){partPresetIdx=3;$('partCnt').value=80;$('partSize').value=4;$('partColor').value='#86efac';$('partLife').value=3;partSpawn();},
    fire(pos){partPresetIdx=0;$('partCnt').value=200;$('partSize').value=8;$('partColor').value='#ff6b35';$('partLife').value=2;partSpawn();},
    levelUp(pos){partPresetIdx=3;$('partCnt').value=150;$('partSize').value=6;$('partColor').value='#fbbf24';$('partLife').value=2;partSpawn();},
    snow(pos){partPresetIdx=6;$('partCnt').value=200;$('partSize').value=3;$('partColor').value='#e0e8ff';$('partLife').value=5;partSpawn();},
};

// â”â”â” PU íŒ¨ì¹˜: AI í–‰ë™ ì—…ë°ì´íŠ¸ â”â”â”
const _origPU2=PU;
PU=function(dt){_origPU2(dt);updateAIBehaviors(dt);
    // 1~4 number keys for skills
    if(keys['1'])useSkill(0);if(keys['2'])useSkill(1);if(keys['3'])useSkill(2);if(keys['4'])useSkill(3);
};

// í‚¤ë³´ë“œ í™•ì¥
document.addEventListener('keydown',e=>{
    if(e.key==='p'&&!e.ctrlKey&&PM){e.preventDefault();openShop();}
    if(e.key==='c'&&!e.ctrlKey&&PM){e.preventDefault();openCraft();}
    if(e.key==='k'&&!e.ctrlKey&&PM){e.preventDefault();startWave();}
});

LG('â•â•â• Phase 3: 13ê°œ ì‹œìŠ¤í…œ ì¶”ê°€ ì™„ë£Œ! â•â•â•','o');
LG('ğŸªìƒì (P) ğŸ”¨ì œì‘(C) âš”ì „íˆ¬ ğŸŒŠì›¨ì´ë¸Œ(K) ğŸ’ë“œë¡­ ğŸ—ºë¯¸ë‹ˆë§µ ğŸ¯í•«ë°” ğŸ†ì—…ì ','o');
LG('ğŸ¤–AIí–‰ë™ ğŸ“Šê²Œì„ìƒíƒœ ğŸ¬ì»·ì‹  ğŸ’¥ì´í™íŠ¸ + DBí™•ì¥(chain/shortcuts)','o');
LG('ğŸ“‹ DB.chain("chars").grade("epic").sort("atk").names()','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 4: 6ê°œ í´ë¦¬ì‹± ì‹œìŠ¤í…œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 1. ë°ë¯¸ì§€ ë„˜ë²„ (í”Œë¡œíŒ… í…ìŠ¤íŠ¸) â”â”â”
function floatText(text,pos,color){
    const c=document.createElement('div');
    c.style.cssText=`position:fixed;color:${color||'#f87171'};font-size:14px;font-weight:700;font-family:'JetBrains Mono';pointer-events:none;z-index:95;text-shadow:0 1px 3px rgba(0,0,0,.8);transition:all 1s ease-out`;
    c.textContent=text;
    // Project 3D â†’ 2D
    const v=pos.clone().project(cam);
    const x=(v.x*.5+.5)*window.innerWidth;const y=(-.5*v.y+.5)*window.innerHeight;
    c.style.left=x+'px';c.style.top=y+'px';
    document.body.appendChild(c);
    requestAnimationFrame(()=>{c.style.top=(y-60)+'px';c.style.opacity='0';});
    setTimeout(()=>c.remove(),1000);
}
function showDamage(amount,pos){floatText('-'+amount,pos,'#f87171');}
function showHeal(amount,pos){floatText('+'+amount,pos,'#86efac');}
function showGold(amount,pos){floatText('+'+amount+'G',pos,'#fbbf24');}

// â”â”â” 2. í™”ë©´ í”ë“¤ë¦¼ â”â”â”
let shakeIntensity=0,shakeTimer=0;
function screenShake(intensity,duration){shakeIntensity=intensity||0.3;shakeTimer=duration||0.3;}
function updateShake(dt){
    if(shakeTimer>0){
        shakeTimer-=dt;cam.position.x+=(Math.random()-0.5)*shakeIntensity;cam.position.y+=(Math.random()-0.5)*shakeIntensity*0.5;
        if(shakeTimer<=0){shakeIntensity=0;}
    }
}

// â”â”â” 3. HP/MP ìƒíƒœë°” (HUD) â”â”â”
function renderStatusBar(){
    let sb=document.getElementById('statusHUD');
    if(!sb){sb=document.createElement('div');sb.id='statusHUD';sb.style.cssText='position:fixed;top:44px;left:10px;z-index:94;display:flex;flex-direction:column;gap:3px';document.body.appendChild(sb);}
    if(!PM){sb.style.display='none';return;}
    sb.style.display='flex';
    const hpPct=Math.max(0,Math.min(100,playerHP/playerMaxHP*100));
    const mpPct=Math.max(0,Math.min(100,playerMP/playerMaxMP*100));
    sb.innerHTML=`<div style="display:flex;align-items:center;gap:4px"><span style="font-size:9px;color:#f87171;width:18px">HP</span><div style="width:100px;height:8px;background:#1a1a2e;border-radius:4px;overflow:hidden"><div style="width:${hpPct}%;height:100%;background:linear-gradient(90deg,#f87171,#fb923c);border-radius:4px;transition:width .3s"></div></div><span style="font-size:8px;color:#f87171">${Math.round(playerHP)}/${playerMaxHP}</span></div>
    <div style="display:flex;align-items:center;gap:4px"><span style="font-size:9px;color:#60a5fa;width:18px">MP</span><div style="width:100px;height:8px;background:#1a1a2e;border-radius:4px;overflow:hidden"><div style="width:${mpPct}%;height:100%;background:linear-gradient(90deg,#60a5fa,#818cf8);border-radius:4px;transition:width .3s"></div></div><span style="font-size:8px;color:#60a5fa">${Math.round(playerMP)}/${playerMaxMP}</span></div>
    <div style="font-size:8px;color:#fbbf24">ğŸ’° ${playerGold}G  âš” Wave ${waveNum}  ğŸ† ${unlockedAch.size}/${ACH_LIST.length}</div>`;
}
setInterval(renderStatusBar,300);

// â”â”â” 4. ì´ëª¨íŠ¸ ì‹œìŠ¤í…œ â”â”â”
const EMOTES=['ğŸ˜€','ğŸ˜‚','ğŸ‘','â¤ï¸','ğŸ”¥','âš”ï¸','ğŸ’€','ğŸ‰','â“','ğŸ’ª','ğŸ™','ğŸ‘‹'];
function showEmote(idx){
    if(!PO)return;const emoji=EMOTES[idx]||EMOTES[0];
    const c=document.createElement('div');
    c.style.cssText='position:fixed;font-size:28px;pointer-events:none;z-index:95;transition:all 1.5s ease-out';
    const v=PO.mesh.position.clone();v.y+=2.5;v.project(cam);
    c.style.left=(v.x*.5+.5)*window.innerWidth+'px';c.style.top=(-.5*v.y+.5)*window.innerHeight+'px';
    c.textContent=emoji;document.body.appendChild(c);
    requestAnimationFrame(()=>{c.style.top=(parseFloat(c.style.top)-50)+'px';c.style.opacity='0';});
    setTimeout(()=>c.remove(),1500);
}

// â”â”â” 5. 3D HP ë°” (ëª¬ìŠ¤í„°/NPC ë¨¸ë¦¬ ìœ„) â”â”â”
function create3DHP(obj,maxHP){
    if(!obj||!obj.mesh)return;
    const cv=document.createElement('canvas');cv.width=64;cv.height=8;
    const cx=cv.getContext('2d');cx.fillStyle='#1a1a2e';cx.fillRect(0,0,64,8);cx.fillStyle='#f87171';cx.fillRect(1,1,62,6);
    const tex=new THREE.CanvasTexture(cv);const spr=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true}));
    spr.scale.set(1.2,0.15,1);spr.position.y=obj.mesh.scale.y+0.5;spr.userData._hpBar=true;spr.userData._maxHP=maxHP;spr.userData._cv=cv;
    obj.mesh.add(spr);return spr;
}
function update3DHP(sprite,curHP){
    if(!sprite||!sprite.userData._cv)return;
    const cv=sprite.userData._cv;const cx=cv.getContext('2d');const pct=Math.max(0,curHP/sprite.userData._maxHP);
    cx.clearRect(0,0,64,8);cx.fillStyle='#1a1a2e';cx.fillRect(0,0,64,8);
    cx.fillStyle=pct>0.5?'#86efac':pct>0.25?'#fbbf24':'#f87171';cx.fillRect(1,1,Math.round(62*pct),6);
    sprite.material.map.needsUpdate=true;
}

// â”â”â” 6. AI í¬ë©”ì´ì…˜ â”â”â”
function setFormation(objects,type,center){
    center=center||new THREE.Vector3(0,0,0);
    if(type==='circle'){objects.forEach((o,i)=>{const a=i/objects.length*Math.PI*2;const r=3;o.mesh.position.set(center.x+Math.cos(a)*r,center.y,center.z+Math.sin(a)*r);});}
    if(type==='line'){objects.forEach((o,i)=>{o.mesh.position.set(center.x+(i-objects.length/2)*2,center.y,center.z);});}
    if(type==='v'){objects.forEach((o,i)=>{const side=i%2===0?-1:1;const depth=Math.floor(i/2);o.mesh.position.set(center.x+side*(depth+1)*1.5,center.y,center.z-depth*2);});}
    if(type==='square'){const n=Math.ceil(Math.sqrt(objects.length));objects.forEach((o,i)=>{o.mesh.position.set(center.x+(i%n-n/2)*2,center.y,center.z+(Math.floor(i/n)-n/2)*2);});}
    BH();toast(`ğŸ“ ${type} í¬ë©”ì´ì…˜ (${objects.length})`);
}

// â”â”â” PU íŒ¨ì¹˜: í™”ë©´ í”ë“¤ë¦¼ â”â”â”
const _origPU3=PU;
PU=function(dt){_origPU3(dt);updateShake(dt);};

// í‚¤ë³´ë“œ: ì´ëª¨íŠ¸
document.addEventListener('keydown',e=>{
    if(PM&&e.key>='5'&&e.key<='9'){showEmote(+e.key-5);}
    if(PM&&e.key==='0'){showEmote(5);}
});

LG('â•â•â• Phase 4: 6ê°œ í´ë¦¬ì‹± ì‹œìŠ¤í…œ ì¶”ê°€! â•â•â•','o');
LG('ğŸ’¥ë°ë¯¸ì§€í…ìŠ¤íŠ¸ ğŸ“³í™”ë©´í”ë“¤ë¦¼ â¤ï¸HPë°”(HUD) ğŸ˜€ì´ëª¨íŠ¸(5~0) ğŸ©¸3D HPë°” ğŸ“í¬ë©”ì´ì…˜','o');
LG('â•â•â• WEB-UNITY v3.0 ì™„ì„±! ì´ 51ê°œ ì‹œìŠ¤í…œ â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE IMPL R1: ì•± ì‹œì‘ + ë¡œë¹„ (8ì‹œìŠ¤í…œ)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” M1. ë¡œë”© í™”ë©´ ì‹œìŠ¤í…œ â”â”â”
function showLoadingScreen(onComplete){
    const ov=document.createElement('div');ov.id='loadScreen';
    ov.style.cssText='position:fixed;inset:0;background:#050510;z-index:999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s';
    ov.innerHTML=`<div style="font-size:2em;font-weight:700;color:#60a5fa;margin-bottom:30px">âš”ï¸ BATTLE ARENA</div>
    <div style="width:280px;height:10px;background:#1a1d30;border-radius:5px;overflow:hidden;margin-bottom:8px"><div id="loadBar" style="width:0%;height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee);border-radius:5px;transition:width .4s"></div></div>
    <div id="loadPct" style="font-size:.7em;color:#93c5fd;margin-bottom:4px">0%</div>
    <div id="loadMsg" style="font-size:.55em;color:#5a5e80">ì´ˆê¸°í™” ì¤‘...</div>
    <div id="loadTip" style="position:absolute;bottom:40px;font-size:.5em;color:#8e92b8;max-width:300px;text-align:center">TIP: ì†ì„± ìƒì„±ì„ í™œìš©í•˜ë©´ ë°ë¯¸ì§€ 1.5ë°°!</div>`;
    document.body.appendChild(ov);
    const tips=['TIP: ì†ì„± ìƒì„±ì„ í™œìš©í•˜ë©´ ë°ë¯¸ì§€ 1.5ë°°!','TIP: AUTO ëª¨ë“œì—ì„œ ë°°ì† ì¡°ì ˆ ê°€ëŠ¥!','TIP: ë§¤ì¼ ì ‘ì†í•˜ë©´ ì¶œì„ ë³´ìƒ!','TIP: ê°€ì±  90ì—°ì°¨ì— SSR í™•ì •!','TIP: ì¥ë¹„ ì„¸íŠ¸ íš¨ê³¼ë¥¼ í™œìš©í•˜ì„¸ìš”!'];
    let tipIdx=0;const tipI=setInterval(()=>{tipIdx=(tipIdx+1)%tips.length;const el=document.getElementById('loadTip');if(el)el.textContent=tips[tipIdx];},3000);
    const stages=[{pct:20,msg:'ì´ˆê¸°í™” ì¤‘...'},{pct:40,msg:'ë°ì´í„° í™•ì¸ ì¤‘...'},{pct:60,msg:'ë¦¬ì†ŒìŠ¤ ë¡œë”© ì¤‘...'},{pct:80,msg:'ì„œë²„ ì—°ê²° ì¤‘...'},{pct:100,msg:'ì¤€ë¹„ ì™„ë£Œ!'}];
    let i=0;
    const step=()=>{if(i>=stages.length){clearInterval(tipI);setTimeout(()=>{ov.style.opacity='0';setTimeout(()=>{ov.remove();if(onComplete)onComplete();},500);},300);return;}
        const s=stages[i];const bar=document.getElementById('loadBar');const pct=document.getElementById('loadPct');const msg=document.getElementById('loadMsg');
        if(bar)bar.style.width=s.pct+'%';if(pct)pct.textContent=s.pct+'%';if(msg)msg.textContent=s.msg;i++;setTimeout(step,400+Math.random()*300);};
    setTimeout(step,200);
}

// â”â”â” M2. ê³„ì • ì‹œìŠ¤í…œ â”â”â”
let accountData={uid:null,type:'guest',nickname:'',level:1,exp:0,vip:0,created:null};
function showAccountScreen(){
    const ov=document.createElement('div');ov.id='accountScreen';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.95);z-index:998;display:flex;align-items:center;justify-content:center';
    ov.innerHTML=`<div style="background:#0c0e18;border:1px solid #353860;border-radius:14px;width:340px;padding:24px;text-align:center">
    <div style="font-size:1.8em;margin-bottom:6px">âš”ï¸</div>
    <div style="font-size:1em;font-weight:700;color:#60a5fa;margin-bottom:4px">BATTLE ARENA</div>
    <div style="font-size:.55em;color:#5a5e80;margin-bottom:18px">ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”</div>
    <button onclick="loginAs('guest')" style="width:100%;padding:12px;background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;border:none;border-radius:8px;font-size:.7em;font-weight:700;cursor:pointer;margin-bottom:8px">ğŸ‘¤ ê²ŒìŠ¤íŠ¸ë¡œ ì‹œì‘</button>
    <button onclick="loginAs('google')" style="width:100%;padding:10px;background:#fff;color:#333;border:1px solid #ddd;border-radius:8px;font-size:.6em;font-weight:600;cursor:pointer;margin-bottom:6px">G Googleë¡œ ë¡œê·¸ì¸</button>
    <button onclick="loginAs('apple')" style="width:100%;padding:10px;background:#000;color:#fff;border:none;border-radius:8px;font-size:.6em;font-weight:600;cursor:pointer;margin-bottom:12px">ğŸ Appleë¡œ ë¡œê·¸ì¸</button>
    <div style="font-size:.38em;color:#5a5e80">ì‹œì‘í•˜ë©´ <u style="cursor:pointer;color:#60a5fa">ì´ìš©ì•½ê´€</u> ë° <u style="cursor:pointer;color:#60a5fa">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</u>ì— ë™ì˜í•©ë‹ˆë‹¤</div>
    </div>`;
    document.body.appendChild(ov);
}
function loginAs(type){
    accountData.type=type;accountData.uid='U'+Math.random().toString(36).substr(2,8);accountData.created=new Date().toISOString();
    try{localStorage.setItem('wu_account',JSON.stringify(accountData));}catch(e){}
    document.getElementById('accountScreen')?.remove();
    if(!accountData.nickname)showNicknameScreen();else showLobby();
}

// â”â”â” M3. ë‹‰ë„¤ì„ ì„¤ì • â”â”â”
const NICK_POOL=[['ë¹›ë‚˜ëŠ”','ìš©ê°í•œ','ì „ì„¤ì˜','ì–´ë‘ ì˜','ë¶ˆíƒ€ëŠ”','ì–¼ìŒì˜','ë°”ëŒì˜','ë²ˆê°œì˜'],['ê²€ì‚¬','ë§ˆë²•ì‚¬','ê¶ìˆ˜','ì„±ê¸°ì‚¬','ë„ì ','ì‚¬ëƒ¥ê¾¼','í˜„ì','ìˆ˜í˜¸ì']];
function showNicknameScreen(){
    const ov=document.createElement('div');ov.id='nickScreen';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.95);z-index:998;display:flex;align-items:center;justify-content:center';
    ov.innerHTML=`<div style="background:#0c0e18;border:1px solid #353860;border-radius:14px;width:340px;padding:24px;text-align:center">
    <div style="font-size:.85em;font-weight:700;color:#fbbf24;margin-bottom:16px">ëª¨í—˜ê°€ì˜ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”!</div>
    <div style="display:flex;gap:4px;margin-bottom:8px"><input id="nickInput" maxlength="12" placeholder="2~12ì í•œ/ì˜/ìˆ«ì" style="flex:1;padding:10px;background:#1a1d30;border:1px solid #353860;color:#e8eaff;border-radius:6px;font-size:.65em;outline:none" oninput="validateNick()">
    <button onclick="randomNick()" style="padding:10px;background:#353860;color:#fbbf24;border:none;border-radius:6px;font-size:.7em;cursor:pointer">ğŸ²</button></div>
    <div id="nickStatus" style="font-size:.45em;color:#5a5e80;margin-bottom:12px;min-height:14px"></div>
    <button id="nickConfirm" onclick="confirmNick()" disabled style="width:100%;padding:10px;background:#353860;color:#5a5e80;border:none;border-radius:8px;font-size:.65em;font-weight:700;cursor:pointer">í™•ì¸</button>
    </div>`;
    document.body.appendChild(ov);
}
function randomNick(){const a=NICK_POOL[0][Math.random()*8|0],b=NICK_POOL[1][Math.random()*8|0];document.getElementById('nickInput').value=a+b;validateNick();}
function validateNick(){const v=document.getElementById('nickInput').value.trim();const st=document.getElementById('nickStatus');const btn=document.getElementById('nickConfirm');
    if(v.length<2){st.textContent='2ì ì´ìƒ ì…ë ¥';st.style.color='#f87171';btn.disabled=true;btn.style.background='#353860';btn.style.color='#5a5e80';return;}
    if(v.length>12){st.textContent='12ì ì´í•˜';st.style.color='#f87171';btn.disabled=true;return;}
    if(/[^ê°€-í£a-zA-Z0-9]/.test(v)){st.textContent='íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ë¶ˆê°€';st.style.color='#f87171';btn.disabled=true;return;}
    st.textContent='âœ… ì‚¬ìš© ê°€ëŠ¥!';st.style.color='#86efac';btn.disabled=false;btn.style.background='linear-gradient(135deg,#60a5fa,#3b82f6)';btn.style.color='#fff';
}
function confirmNick(){const v=document.getElementById('nickInput').value.trim();if(v.length<2)return;
    accountData.nickname=v;try{localStorage.setItem('wu_account',JSON.stringify(accountData));}catch(e){}
    document.getElementById('nickScreen')?.remove();toast('ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, '+v+'!');showLobby();
}

// â”â”â” M4. ë¡œë¹„ UI ì‹œìŠ¤í…œ â”â”â”
let lobbyOpen=false;
function showLobby(){
    if(document.getElementById('lobbyUI'))return;lobbyOpen=true;
    const ov=document.createElement('div');ov.id='lobbyUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:200;display:flex;flex-direction:column';
    // Top bar
    let topH=`<div style="display:flex;align-items:center;padding:6px 10px;background:#0c0e18;border-bottom:1px solid #252840;gap:8px">
    <div style="width:28px;height:28px;background:linear-gradient(135deg,#60a5fa,#818cf8);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px">âš”</div>
    <div><div style="font-size:.55em;font-weight:700;color:#e8eaff">${accountData.nickname||'ëª¨í—˜ê°€'}</div><div style="font-size:.38em;color:#60a5fa">Lv.${accountData.level}</div></div>
    <div style="flex:1"></div>
    <span style="font-size:.45em;color:#fbbf24">ğŸ’ ${Math.floor(Math.random()*3000+500)}</span>
    <span style="font-size:.45em;color:#fbbf24">ğŸ’° ${playerGold}</span>
    <span style="font-size:.45em;color:#22d3ee">âš¡ ${staminaCurrent}/${staminaMax}</span>
    <button onclick="closeLobby()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>`;
    // Banner area
    let bannerH=`<div style="padding:10px;display:flex;gap:8px;overflow-x:auto">
    ${['ğŸ”¥ ì‹ ê·œ í”½ì—…: í™”ì—¼ì˜ ê²€ì‚¬','â„ï¸ ì´ë²¤íŠ¸: ê²¨ìš¸ ì™•êµ­','âš”ï¸ PvP ì‹œì¦Œ 12 ì‹œì‘!','ğŸ ë³µê·€ì íŠ¹ë³„ ë³´ìƒ'].map((b,i)=>`<div style="min-width:200px;height:80px;background:linear-gradient(135deg,${['#f87171,#fb923c','#60a5fa,#22d3ee','#c084fc,#818cf8','#86efac,#22d3ee'][i]});border-radius:8px;display:flex;align-items:center;justify-content:center;padding:10px;cursor:pointer" onclick="toast('${b}')"><span style="font-size:.55em;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.5)">${b}</span></div>`).join('')}
    </div>`;
    // Center character
    let centerH=`<div style="flex:1;display:flex;align-items:center;justify-content:center;position:relative">
    <div style="font-size:80px;cursor:pointer" onclick="toast('âœ¨ ëŒ€ì‚¬: ì˜¤ëŠ˜ë„ í•¨ê»˜ ì‹¸ìš°ì!')">ğŸ§™â€â™‚ï¸</div>
    <div style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%)">
    <button onclick="closeLobby();toast('âš”ï¸ ëª¨í—˜ ì¶œë°œ!')" style="padding:10px 30px;background:linear-gradient(135deg,#f87171,#fb923c);color:#fff;border:none;border-radius:10px;font-size:.7em;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(248,113,113,.3)">â–¶ ë©”ì¸ ìŠ¤í† ë¦¬ ê³„ì†í•˜ê¸°</button></div></div>`;
    // Bottom nav
    let navH=`<div style="display:flex;background:#0c0e18;border-top:1px solid #252840;padding:6px 0">
    ${[['âš”ï¸','ëª¨í—˜','closeLobby()'],['ğŸ°','ì†Œí™˜','openGachaUI()'],['ğŸ¦¸','ì˜ì›…','openHeroList()'],['ğŸ’','ê°€ë°©','openInventory()'],['ğŸ“±','ë©”ë‰´','openGameMenu()'],['ğŸ’¬','ì„¸ìë§¤','openFamily()']].map(([ic,nm,fn])=>`<div onclick="${fn}" style="flex:1;text-align:center;cursor:pointer;padding:4px 0"><div style="font-size:16px">${ic}</div><div style="font-size:.4em;color:#8e92b8">${nm}</div></div>`).join('')}
    </div>`;
    ov.innerHTML=topH+bannerH+centerH+navH;
    document.body.appendChild(ov);
    // Auto popup queue
    setTimeout(()=>showAttendance(),500);
}
function closeLobby(){const el=document.getElementById('lobbyUI');if(el)el.remove();lobbyOpen=false;}

// â”â”â” M5. ì¶œì„ ë³´ìƒ ì‹œìŠ¤í…œ â”â”â”
let attendDay=0;
function showAttendance(){
    try{const d=JSON.parse(localStorage.getItem('wu_attend')||'{}');if(d.date===new Date().toDateString())return;attendDay=d.day||0;}catch(e){}
    attendDay++;const rewards=['ğŸ’°500G','ğŸ§ªí¬ì…˜x3','ğŸ’100','ğŸ“œì†Œí™˜ê¶Œx1','ğŸ’°2000G','ğŸ§ªê³ ê¸‰í¬ì…˜x2','ğŸ¦¸SSRí™•ì •ê¶Œ!'];
    const ov=document.createElement('div');ov.id='attendPopup';
    ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:210;display:flex;align-items:center;justify-content:center';
    ov.innerHTML=`<div style="background:#0c0e18;border:1px solid #fbbf24;border-radius:12px;width:320px;padding:16px;text-align:center">
    <div style="font-size:.8em;font-weight:700;color:#fbbf24;margin-bottom:10px">ğŸ“… ì¶œì„ ë³´ìƒ (${attendDay}ì¼ì°¨)</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-bottom:10px">${rewards.map((r,i)=>`<div style="width:60px;height:50px;background:${i<attendDay?'#162040':'#1a1d30'};border:1px solid ${i===attendDay-1?'#fbbf24':'#353860'};border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:.38em;color:${i<attendDay?'#fbbf24':'#5a5e80'}"><div>Day ${i+1}</div><div>${r}</div>${i<attendDay?'<div style="color:#86efac">âœ“</div>':''}</div>`).join('')}</div>
    <div style="font-size:.6em;color:#86efac;margin-bottom:8px">ğŸ ì˜¤ëŠ˜ ë³´ìƒ: ${rewards[(attendDay-1)%7]}</div>
    <button onclick="claimAttendance()" style="padding:8px 20px;background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;border:none;border-radius:8px;font-size:.65em;font-weight:700;cursor:pointer">ìˆ˜ë ¹í•˜ê¸°!</button></div>`;
    document.body.appendChild(ov);
}
function claimAttendance(){
    try{localStorage.setItem('wu_attend',JSON.stringify({day:attendDay,date:new Date().toDateString()}));}catch(e){}
    document.getElementById('attendPopup')?.remove();toast('ğŸ“… ì¶œì„ ë³´ìƒ ìˆ˜ë ¹!');boostSisters(1);
}

// â”â”â” M6. ìŠ¤íƒœë¯¸ë‚˜ íƒ€ì´ë¨¸ ì‹œìŠ¤í…œ â”â”â”
let staminaCurrent=80,staminaMax=100,staminaTimer=0;
const STAMINA_REGEN=300; // 5ë¶„(300ì´ˆ)ì— 1 íšŒë³µ
setInterval(()=>{if(staminaCurrent<staminaMax){staminaTimer++;if(staminaTimer>=STAMINA_REGEN){staminaTimer=0;staminaCurrent++;}}},1000);
function useStamina(cost){if(staminaCurrent<cost){toast('âš¡ ìŠ¤íƒœë¯¸ë‚˜ ë¶€ì¡±!');return false;}staminaCurrent-=cost;return true;}
function refillStamina(){staminaCurrent=staminaMax;staminaTimer=0;toast('âš¡ ìŠ¤íƒœë¯¸ë‚˜ í’€ì¶©ì „!');}

// â”â”â” M7. ì˜ì›… ëª©ë¡ ì‹œìŠ¤í…œ â”â”â”
function openHeroList(){
    const chars=DB.all('chars');
    const ov=document.createElement('div');ov.id='heroListUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:205;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 10px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#c084fc">ğŸ¦¸ ì˜ì›… ëª©ë¡ (${chars.length})</span><div style="flex:1"></div><button onclick="document.getElementById('heroListUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px">
    ${chars.map(ch=>{const gc={'common':'#5a5e80','rare':'#60a5fa','epic':'#c084fc','mythic':'#f87171','legendary':'#fbbf24'}[ch.grade]||'#5a5e80';
    return`<div style="background:#0c0e18;border:1px solid ${gc};border-radius:8px;padding:8px;cursor:pointer" onclick="showHeroDetail('${ch.id}')">
    <div style="text-align:center;font-size:24px;margin-bottom:4px">${ch.cls==='ì „ì‚¬'?'âš”ï¸':ch.cls==='ë§ˆë²•ì‚¬'?'ğŸ§™':ch.cls==='ê¶ìˆ˜'?'ğŸ¹':ch.cls==='ë„ì '?'ğŸ—¡':ch.cls==='ì„±ê¸°ì‚¬'?'ğŸ›¡':'ğŸ¦¸'}</div>
    <div style="font-size:.5em;font-weight:600;color:#e8eaff;text-align:center">${ch.name}</div>
    <div style="font-size:.38em;color:${gc};text-align:center">${ch.grade} Â· ${ch.cls}</div>
    <div style="font-size:.35em;color:#8e92b8;text-align:center;margin-top:2px">HP:${ch.hp} ATK:${ch.atk}</div></div>`;}).join('')}
    </div>`;
    document.body.appendChild(ov);
}
function showHeroDetail(id){
    const ch=DB.get('chars',id);if(!ch)return;
    toast(`ğŸ¦¸ ${ch.name} | ${ch.cls} | ${ch.el} | HP:${ch.hp} ATK:${ch.atk} DEF:${ch.def}`);
}

// â”â”â” M8. ê°€ì±  UI ì‹œìŠ¤í…œ â”â”â”
function openGachaUI(){
    const ov=document.createElement('div');ov.id='gachaUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:205;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 10px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#fbbf24">ğŸ° ì†Œí™˜</span><div style="flex:1"></div><span style="font-size:.45em;color:#fbbf24">ğŸ’ 2700</span><button onclick="document.getElementById('gachaUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em;margin-left:8px">âœ•</button></div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px">
    <div style="font-size:60px">âœ¨</div>
    <div style="font-size:.8em;font-weight:700;color:#fbbf24">ğŸ”¥ ì‹ ê·œ í”½ì—… ë°°ë„ˆ</div>
    <div style="font-size:.5em;color:#8e92b8">SSR 3% (í”½ì—… 1.5%) Â· SR 15% Â· R 82%</div>
    <div style="font-size:.45em;color:#60a5fa" id="gachaPity">ì²œì¥ê¹Œì§€: ${90-((parseInt(localStorage.getItem('wu_pity'))||0))}íšŒ</div>
    <div style="display:flex;gap:10px;margin-top:10px">
    <button onclick="doGacha(1)" style="padding:10px 20px;background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;border:none;border-radius:8px;font-size:.65em;font-weight:700;cursor:pointer">1íšŒ ì†Œí™˜<br><span style="font-size:.8em">ğŸ’300</span></button>
    <button onclick="doGacha(10)" style="padding:10px 20px;background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;border:none;border-radius:8px;font-size:.65em;font-weight:700;cursor:pointer">10ì—° ì†Œí™˜<br><span style="font-size:.8em">ğŸ’2700</span></button>
    </div></div>`;
    document.body.appendChild(ov);
}
function doGacha(count){
    let pity=parseInt(localStorage.getItem('wu_pity'))||0;
    const results=[];
    for(let i=0;i<count;i++){
        pity++;let grade;
        if(pity>=90){grade='mythic';pity=0;}
        else if(Math.random()<0.03)grade='mythic';
        else if(Math.random()<0.15)grade='epic';
        else if(Math.random()<0.5)grade='rare';
        else grade='common';
        const pool=DB.byGrade('chars',grade);
        const ch=pool.length?pool[Math.random()*pool.length|0]:DB.random('chars');
        results.push({...ch,grade});
    }
    localStorage.setItem('wu_pity',String(pity));
    // Show results
    const el=document.getElementById('gachaUI');if(!el)return;
    const gc={'common':'#5a5e80','rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24'};
    el.querySelector('div[style*="flex:1"]').innerHTML=`<div style="font-size:.7em;font-weight:700;color:#fbbf24;margin-bottom:10px">ğŸ‰ ì†Œí™˜ ê²°ê³¼!</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;max-width:360px">
    ${results.map(r=>`<div style="width:60px;height:70px;background:#0c0e18;border:2px solid ${gc[r.grade]||'#5a5e80'};border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;${r.grade==='mythic'?'box-shadow:0 0 12px '+gc.mythic:''}">
    <div style="font-size:18px">${r.cls==='ì „ì‚¬'?'âš”ï¸':r.cls==='ë§ˆë²•ì‚¬'?'ğŸ§™':r.cls==='ê¶ìˆ˜'?'ğŸ¹':'ğŸ¦¸'}</div>
    <div style="font-size:.35em;color:${gc[r.grade]}">${r.grade}</div>
    <div style="font-size:.32em;color:#e8eaff">${r.name?.substr(0,4)||'?'}</div></div>`).join('')}
    </div>
    <div style="font-size:.45em;color:#60a5fa;margin-top:8px">ì²œì¥ê¹Œì§€: ${90-pity}íšŒ</div>
    <button onclick="document.getElementById('gachaUI')?.remove()" style="margin-top:10px;padding:8px 20px;background:#353860;color:#e8eaff;border:none;border-radius:6px;font-size:.6em;cursor:pointer">í™•ì¸</button>`;
    toast('ğŸ° '+count+'ì—° ì†Œí™˜ ì™„ë£Œ!');boostSisters(2);
}

// â”â”â” ê²Œì„ ëª¨ë“œ ì‹œì‘ (ë¡œë”©â†’ê³„ì •â†’ë¡œë¹„ ìë™ ì²´ì¸) â”â”â”
function startGameMode(){
    showLoadingScreen(()=>{
        const saved=localStorage.getItem('wu_account');
        if(saved){try{Object.assign(accountData,JSON.parse(saved));}catch(e){}}
        if(!accountData.uid)showAccountScreen();
        else if(!accountData.nickname)showNicknameScreen();
        else showLobby();
    });
}

LG('â•â•â• Mobile R1: ì•±ì‹œì‘+ë¡œë¹„ 8ì‹œìŠ¤í…œ ì¶”ê°€! â•â•â•','o');
LG('ğŸ”„ë¡œë”©(0~100%) ğŸ‘¤ê³„ì •(ê²ŒìŠ¤íŠ¸/Google/Apple) âœë‹‰ë„¤ì„ ğŸ ë¡œë¹„','o');
LG('ğŸ“…ì¶œì„ë³´ìƒ âš¡ìŠ¤íƒœë¯¸ë‚˜ ğŸ¦¸ì˜ì›…ëª©ë¡ ğŸ°ê°€ì± UI+ì—°ì¶œ','o');
LG('ì½˜ì†”ì—ì„œ startGameMode() ì‹¤í–‰í•˜ë©´ ê²Œì„ ëª¨ë“œ ì‹œì‘!','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„¸ìë§¤ ê´€ë¦¬ì ì‹œìŠ¤í…œ (Unity Admin Access)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SIS_ADMIN={
    muse:{role:'Creative Director',perms:['scene_edit','story','dialog','quest','cutscene','blueprint','naming'],color:'#c084fc'},
    aria:{role:'Art & Environment Lead',perms:['skybox','terrain','texture','material','particle','water','weather','lighting','postprocess'],color:'#f5c2e7'},
    melo:{role:'Sound & Balance Lead',perms:['music','sound','balance','combat','loot','difficulty','wave','skill'],color:'#86efac'}
};
let sisAdminActive=null,sisAdminLog=[];

function openSisAdmin(){
    const ov=document.createElement('div');ov.id='sisAdminPanel';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.95);z-index:300;display:flex;flex-direction:column';
    const cards=Object.entries(SIS_ADMIN).map(([k,v])=>{
        const s=SIS_INFO[k];const lv=sisLevel[k]||1;
        return`<div style="flex:1;background:#0c0e18;border:1px solid ${v.color};border-radius:12px;padding:14px;cursor:pointer" onclick="sisLogin('${k}')">
        <div style="font-size:24px;text-align:center">${s.emoji}</div>
        <div style="font-size:.65em;font-weight:700;color:${v.color};text-align:center;margin:4px 0">${s.name}</div>
        <div style="font-size:.4em;color:#8e92b8;text-align:center">${v.role}</div>
        <div style="font-size:.4em;color:#fbbf24;text-align:center;margin-top:4px">Lv.${lv} | ê¶Œí•œ: ${v.perms.length}ê°œ</div>
        <div style="font-size:.35em;color:#5a5e80;text-align:center;margin-top:6px">${v.perms.join(' Â· ')}</div>
        </div>`;
    }).join('');
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid #252840">
    <span style="font-size:.8em;font-weight:700;background:linear-gradient(135deg,#c084fc,#f5c2e7,#86efac);-webkit-background-clip:text;-webkit-text-fill-color:transparent">ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ ì„¸ìë§¤ ê´€ë¦¬ì ì ‘ì†</span>
    <div style="flex:1"></div><button onclick="document.getElementById('sisAdminPanel')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>
    <div style="padding:14px"><div style="font-size:.55em;color:#8e92b8;margin-bottom:10px;text-align:center">ì ‘ì†í•  ìë§¤ë¥¼ ì„ íƒí•˜ì„¸ìš” (ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ Unity ì—”ì§„ì— ì§ì ‘ ì ‘ê·¼)</div>
    <div style="display:flex;gap:8px">${cards}</div></div>
    <div style="padding:0 14px"><div style="font-size:.5em;color:#5a5e80;margin-bottom:6px">ğŸ“‹ ê´€ë¦¬ì ë¡œê·¸</div>
    <div id="sisAdminLogArea" style="background:#0a0c14;border:1px solid #1a1d30;border-radius:8px;padding:8px;height:120px;overflow-y:auto;font-size:.4em;color:#8e92b8">${sisAdminLog.slice(-10).map(l=>`<div>${l}</div>`).join('')||'ì•„ì§ ë¡œê·¸ ì—†ìŒ'}</div></div>`;
    document.body.appendChild(ov);
}

function sisLogin(sis){
    sisAdminActive=sis;const s=SIS_INFO[sis];const a=SIS_ADMIN[sis];
    const logMsg=`[${new Date().toLocaleTimeString()}] ${s.emoji} ${s.name} ê´€ë¦¬ì ì ‘ì† (${a.role})`;
    sisAdminLog.push(logMsg);LG(logMsg,'o');
    document.getElementById('sisAdminPanel')?.remove();
    toast(`${s.emoji} ${s.name} ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”!`);
    boostSisters(3);
    showSisWorkspace(sis);
}

function showSisWorkspace(sis){
    const s=SIS_INFO[sis];const a=SIS_ADMIN[sis];const lv=sisLevel[sis]||1;
    const ov=document.createElement('div');ov.id='sisWorkspace';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:300;display:flex;flex-direction:column';
    const tools=a.perms.map(p=>{
        const toolMap={scene_edit:'ğŸ¬ì”¬í¸ì§‘',story:'ğŸ“–ìŠ¤í† ë¦¬',dialog:'ğŸ’¬ëŒ€í™”',quest:'ğŸ“‹í€˜ìŠ¤íŠ¸',cutscene:'ğŸ¥ì»·ì‹ ',blueprint:'ğŸ“¦ë¸”ë£¨í”„ë¦°íŠ¸',naming:'âœì´ë¦„ì§“ê¸°',
        skybox:'ğŸŒ…í•˜ëŠ˜',terrain:'â›°ì§€í˜•',texture:'ğŸ¨í…ìŠ¤ì²˜',material:'ğŸ”²ë¨¸í‹°ë¦¬ì–¼',particle:'ğŸ†íŒŒí‹°í´',water:'ğŸ’§ë¬¼',weather:'ğŸŒ§ë‚ ì”¨',lighting:'ğŸ’¡ì¡°ëª…',postprocess:'ğŸ“·í›„ì²˜ë¦¬',
        music:'ğŸµìŒì•…',sound:'ğŸ”Šì‚¬ìš´ë“œ',balance:'âš–ë°¸ëŸ°ìŠ¤',combat:'âš”ì „íˆ¬',loot:'ğŸ’ë£¨íŒ…',difficulty:'ğŸ“Šë‚œì´ë„',wave:'ğŸŒŠì›¨ì´ë¸Œ',skill:'âœ¨ìŠ¤í‚¬'};
        return`<button onclick="sisExecTool('${sis}','${p}')" style="padding:8px 12px;background:#1a1d30;border:1px solid ${a.color}44;color:${a.color};border-radius:8px;font-size:.5em;cursor:pointer">${toolMap[p]||p}</button>`;
    }).join('');
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;background:#0c0e18;border-bottom:1px solid ${a.color}44">
    <span style="font-size:18px">${s.emoji}</span><div style="margin-left:8px"><div style="font-size:.6em;font-weight:700;color:${a.color}">${s.name} ê´€ë¦¬ì ì›Œí¬ìŠ¤í˜ì´ìŠ¤</div>
    <div style="font-size:.38em;color:#8e92b8">${a.role} Â· Lv.${lv} Â· ê¶Œí•œ ${a.perms.length}ê°œ</div></div>
    <div style="flex:1"></div><button onclick="sisLogout()" style="padding:4px 10px;background:#f8717122;color:#f87171;border:1px solid #f8717144;border-radius:6px;font-size:.45em;cursor:pointer">ë¡œê·¸ì•„ì›ƒ</button></div>
    <div style="padding:12px"><div style="font-size:.5em;color:#8e92b8;margin-bottom:8px">ğŸ”§ ì‚¬ìš© ê°€ëŠ¥í•œ ë„êµ¬</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px">${tools}</div></div>
    <div style="padding:0 12px"><div style="font-size:.5em;color:#8e92b8;margin-bottom:6px">ğŸ’¬ ${s.name}ì—ê²Œ ì‘ì—… ì§€ì‹œ</div>
    <div style="display:flex;gap:4px"><input id="sisCmd" placeholder="${s.name}ì•„, ë¬´ì—‡ì„ í• ê¹Œ?" style="flex:1;padding:8px;background:#1a1d30;border:1px solid #353860;color:#e8eaff;border-radius:8px;font-size:.5em;outline:none">
    <button onclick="sisExecCmd('${sis}')" style="padding:8px 14px;background:${a.color};color:#000;border:none;border-radius:8px;font-size:.5em;font-weight:700;cursor:pointer">ì‹¤í–‰</button></div></div>
    <div id="sisOutput" style="flex:1;margin:8px 12px;background:#0a0c14;border:1px solid #1a1d30;border-radius:8px;padding:8px;overflow-y:auto;font-size:.42em;color:#8e92b8"></div>`;
    document.body.appendChild(ov);
}

function sisExecTool(sis,tool){
    const s=SIS_INFO[sis];const out=document.getElementById('sisOutput');
    const log=`[${new Date().toLocaleTimeString()}] ${s.emoji} ${s.name} â†’ ${tool} ì‹¤í–‰`;
    sisAdminLog.push(log);
    const actions={
        scene_edit:()=>{sisLogout();toast('ğŸ¬ ì”¬ ì—ë””í„° ì—´ê¸°!');},
        story:()=>sisAutoWork(sis,'ìƒˆë¡œìš´ ìŠ¤í† ë¦¬ë¥¼ ì‘ì„±í•˜ê³  ìˆì–´ìš”...','ğŸ“– ìŠ¤í† ë¦¬ ì‘ì„± ì™„ë£Œ!'),
        dialog:()=>{openDialogAI();sisLogout();},
        quest:()=>sisAutoWork(sis,'í€˜ìŠ¤íŠ¸ë¥¼ ì„¤ê³„í•˜ê³  ìˆì–´ìš”...','ğŸ“‹ ìƒˆ í€˜ìŠ¤íŠ¸ ìƒì„±!'),
        cutscene:()=>{const sc=[{icon:'ğŸŒ…',text:'ì–´ë‘ ì´ ê±·íˆê³ , ìƒˆë¡œìš´ ì—¬ì •ì´ ì‹œì‘ëœë‹¤...'},{icon:'âš”',text:'ì˜ì›…ì´ì—¬, ì´ ë•…ì„ êµ¬í•´ì£¼ì„¸ìš”!'},{icon:'âœ¨',text:'ë¹›ì˜ í˜ì´ ê¹¨ì–´ë‚œë‹¤!'}];playCutscene(sc);sisLogout();},
        blueprint:()=>{spawnBlueprint('rpg');sisLogout();},
        naming:()=>sisAutoWork(sis,'ì´ë¦„ì„ ê³ ë¯¼í•˜ê³  ìˆì–´ìš”...','âœ ìƒˆ ì´ë¦„: '+NICK_POOL[0][Math.random()*8|0]+NICK_POOL[1][Math.random()*8|0]),
        skybox:()=>{setSkybox(['sunset','night','fog','space','underwater'][Math.random()*5|0]);sisLogout();},
        terrain:()=>{createTerrain();sisLogout();},
        texture:()=>{sisLogout();$('texModal').style.display='flex';},
        material:()=>{openMatEditor();sisLogout();},
        particle:()=>{sisLogout();$('partModal').style.display='flex';},
        water:()=>{addWater(0,0,20);sisLogout();},
        weather:()=>{setWeather(['rain','snow','storm','clear'][Math.random()*4|0]);sisLogout();},
        lighting:()=>sisAutoWork(sis,'ì¡°ëª…ì„ ì¡°ì ˆí•˜ê³  ìˆì–´ìš”...','ğŸ’¡ ì¡°ëª… ìµœì í™” ì™„ë£Œ!'),
        postprocess:()=>{togglePP();sisLogout();},
        music:()=>{sisLogout();openMusicAI();},
        sound:()=>{sisLogout();openSndAI();},
        balance:()=>{sisLogout();openBalanceAI();},
        combat:()=>sisAutoWork(sis,'ì „íˆ¬ ì‹œìŠ¤í…œì„ íŠœë‹ ì¤‘...','âš” ì „íˆ¬ ë°¸ëŸ°ìŠ¤ ì¡°ì • ì™„ë£Œ!'),
        loot:()=>sisAutoWork(sis,'ë“œë¡­ í…Œì´ë¸”ì„ ì¡°ì • ì¤‘...','ğŸ’ ë£¨íŒ… í…Œì´ë¸” ìµœì í™”!'),
        difficulty:()=>sisAutoWork(sis,'ë‚œì´ë„ ê³¡ì„ ì„ ë¶„ì„ ì¤‘...','ğŸ“Š ë‚œì´ë„ ê³¡ì„  ì¡°ì • ì™„ë£Œ!'),
        wave:()=>{startWave();sisLogout();},
        skill:()=>sisAutoWork(sis,'ìŠ¤í‚¬ ë°ì´í„°ë¥¼ ìˆ˜ì • ì¤‘...','âœ¨ ìŠ¤í‚¬ ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜!'),
    };
    if(actions[tool])actions[tool]();
    if(out)out.innerHTML+=`<div style="color:${SIS_ADMIN[sis].color}">${log}</div>`;
    boostSisters(2);
}

function sisAutoWork(sis,workMsg,doneMsg){
    const out=document.getElementById('sisOutput');const s=SIS_INFO[sis];
    if(out)out.innerHTML+=`<div style="color:${SIS_ADMIN[sis].color}">${s.emoji} ${workMsg}</div>`;
    setTimeout(()=>{if(out)out.innerHTML+=`<div style="color:#86efac">âœ… ${doneMsg}</div>`;toast(doneMsg);boostSisters(2);},1500);
}
function sisExecCmd(sis){
    const inp=document.getElementById('sisCmd');if(!inp||!inp.value.trim())return;
    const cmd=inp.value.trim();inp.value='';const s=SIS_INFO[sis];
    sisAutoWork(sis,`"${cmd}" ì‘ì—… ì‹œì‘...`,`${s.name}: "${cmd}" ì™„ë£Œ!`);
    sisAdminLog.push(`[${new Date().toLocaleTimeString()}] ${s.emoji} ì»¤ë§¨ë“œ: ${cmd}`);
}
function sisLogout(){
    document.getElementById('sisWorkspace')?.remove();
    if(sisAdminActive){const s=SIS_INFO[sisAdminActive];toast(`${s.emoji} ${s.name} ë¡œê·¸ì•„ì›ƒ`);sisAdminActive=null;}
}

LG('â•â•â• ì„¸ìë§¤ ê´€ë¦¬ì ì‹œìŠ¤í…œ êµ¬ì¶•! â•â•â•','o');
LG('ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ openSisAdmin() â†’ ì„¸ìë§¤ê°€ Unityì— ê´€ë¦¬ìë¡œ ì ‘ì†!','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R2: ì „íˆ¬ íë¦„ (ì›”ë“œë§µâ†’íŒŒí‹°â†’ì›¨ì´ë¸Œâ†’ê²°ê³¼â†’ë³„)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let worldRegions=[],currentRegion=0,currentStage=0,partySlots=[null,null,null,null],battleStars={};

function generateRegion(level){
    const themes=['ê³ ëŒ€ ìˆ²','íƒ€ì˜¤ë¥´ëŠ” í™”ì‚°','ì–¼ì–´ë¶™ì€ ë¹™í•˜','ì–´ë‘ ì˜ ì‹¬ì—°','ì²œê³µì˜ ì„¬','í™©ê¸ˆ ì‚¬ë§‰','í•´ì € ì‹ ì „'];
    const t=themes[(level-1)%themes.length];const stages=5+Math.floor(level/2);
    const r={id:'r'+level,name:t,level,stages:[]};
    for(let i=0;i<stages;i++){
        const isBoss=i===stages-1;const diff=1+level*0.15+(i/stages)*0.5+(isBoss?0.5:0);
        const mons=DB.randomN('mons',isBoss?1:2+Math.floor(Math.random()*3));
        r.stages.push({id:`s${level}_${i}`,name:isBoss?'â˜… ë³´ìŠ¤ ì „':`${t} ${i+1}êµ¬ì—­`,boss:isBoss,diff,mons,stamina:isBoss?15:8,stars:0,cleared:false});
    }
    return r;
}
function initWorldMap(){worldRegions=[];for(let i=1;i<=5;i++)worldRegions.push(generateRegion(i));}
if(!worldRegions.length)initWorldMap();

function openWorldMap(){
    const ov=document.createElement('div');ov.id='worldMapUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:205;display:flex;flex-direction:column';
    const regs=worldRegions.map((r,i)=>{
        const unlocked=i===0||worldRegions[i-1].stages.every(s=>s.cleared);
        const allCleared=r.stages.every(s=>s.cleared);const stars=r.stages.reduce((s,st)=>s+st.stars,0);const maxS=r.stages.length*3;
        return`<div onclick="${unlocked?`openStageList(${i})`:'toast(\"ğŸ”’ ì´ì „ ì§€ì—­ì„ í´ë¦¬ì–´í•˜ì„¸ìš”\")'}" style="display:flex;align-items:center;gap:10px;padding:10px;background:${i===currentRegion?'#162040':'#0c0e18'};border:1px solid ${unlocked?'#60a5fa':'#353860'};border-radius:10px;cursor:pointer;opacity:${unlocked?1:0.4}">
        <div style="font-size:24px">${allCleared?'âœ…':unlocked?'âš”':'ğŸ”’'}</div>
        <div style="flex:1"><div style="font-size:.55em;font-weight:600;color:${unlocked?'#e8eaff':'#5a5e80'}">${r.name}</div>
        <div style="font-size:.4em;color:#8e92b8">Lv.${r.level} Â· ${r.stages.length}ìŠ¤í…Œì´ì§€ Â· â­${stars}/${maxS}</div></div></div>`;
    }).join('');
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#60a5fa">ğŸ—º ì›”ë“œë§µ</span><div style="flex:1"></div><button onclick="document.getElementById('worldMapUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px">${regs}</div>`;
    document.body.appendChild(ov);
}

function openStageList(ri){
    currentRegion=ri;const r=worldRegions[ri];document.getElementById('worldMapUI')?.remove();
    const ov=document.createElement('div');ov.id='stageListUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    const stages=r.stages.map((s,i)=>{
        const unlocked=i===0||r.stages[i-1].cleared;const starStr='â­'.repeat(s.stars)+'â˜†'.repeat(3-s.stars);
        return`<div onclick="${unlocked?`openPartyScreen(${ri},${i})`:'toast(\"ğŸ”’\")'}" style="display:flex;align-items:center;gap:8px;padding:8px;background:${s.cleared?'#0f1a10':'#0c0e18'};border:1px solid ${s.boss?'#f87171':unlocked?'#353860':'#1a1d30'};border-radius:8px;cursor:pointer;opacity:${unlocked?1:0.4}">
        <div style="font-size:18px">${s.boss?'ğŸ’€':s.cleared?'âœ…':'âš”'}</div>
        <div style="flex:1"><div style="font-size:.5em;color:#e8eaff">${s.name}</div><div style="font-size:.38em;color:#8e92b8">${starStr} Â· âš¡${s.stamina}</div></div></div>`;
    }).join('');
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><button onclick="document.getElementById('stageListUI')?.remove();openWorldMap()" style="background:none;border:none;color:#60a5fa;cursor:pointer;font-size:.7em">â† ì›”ë“œë§µ</button><span style="font-size:.7em;font-weight:700;color:#fbbf24;margin-left:8px">${r.name}</span><div style="flex:1"></div></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px">${stages}</div>`;
    document.body.appendChild(ov);
}

function openPartyScreen(ri,si){
    currentStage=si;document.getElementById('stageListUI')?.remove();
    const stage=worldRegions[ri].stages[si];const chars=DB.all('chars').slice(0,8);
    if(!partySlots[0])partySlots=chars.slice(0,4).map(c=>c.id);
    const ov=document.createElement('div');ov.id='partyUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:207;display:flex;flex-direction:column';
    const slotH=partySlots.map((pid,i)=>{const ch=pid?DB.get('chars',pid):null;
        return`<div style="width:60px;height:70px;background:#1a1d30;border:2px solid ${ch?'#60a5fa':'#353860'};border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center">
        <div style="font-size:20px">${ch?(ch.cls==='ì „ì‚¬'?'âš”ï¸':ch.cls==='ë§ˆë²•ì‚¬'?'ğŸ§™':'ğŸ¦¸'):'+'}</div>
        <div style="font-size:.35em;color:#e8eaff">${ch?ch.name.substr(0,4):'ë¹ˆ ìŠ¬ë¡¯'}</div></div>`;}).join('');
    const power=partySlots.reduce((s,pid)=>{const ch=pid?DB.get('chars',pid):null;return s+(ch?ch.atk+ch.def+ch.hp/10:0);},0)|0;
    ov.innerHTML=`<div style="padding:10px;border-bottom:1px solid #252840;display:flex;align-items:center"><button onclick="document.getElementById('partyUI')?.remove();openStageList(${ri})" style="background:none;border:none;color:#60a5fa;cursor:pointer;font-size:.6em">â†</button>
    <span style="font-size:.65em;font-weight:700;color:#fbbf24;margin-left:8px">${stage.name}</span><div style="flex:1"></div><span style="font-size:.45em;color:#8e92b8">ì „íˆ¬ë ¥: ${power}</span></div>
    <div style="padding:10px"><div style="font-size:.5em;color:#8e92b8;margin-bottom:6px">íŒŒí‹° í¸ì„±</div><div style="display:flex;gap:6px;justify-content:center">${slotH}</div></div>
    <div style="flex:1"></div>
    <div style="padding:10px"><button onclick="startStageBattle(${ri},${si})" style="width:100%;padding:12px;background:linear-gradient(135deg,#f87171,#fb923c);color:#fff;border:none;border-radius:10px;font-size:.7em;font-weight:700;cursor:pointer">âš” ì¶œë°œ! (âš¡${stage.stamina})</button></div>`;
    document.body.appendChild(ov);
}

function startStageBattle(ri,si){
    const stage=worldRegions[ri].stages[si];
    if(!useStamina(stage.stamina)){document.getElementById('partyUI')?.remove();return;}
    document.getElementById('partyUI')?.remove();
    runBattleSequence(ri,si);
}

function runBattleSequence(ri,si){
    const stage=worldRegions[ri].stages[si];const waves=stage.boss?3:2;let wave=1;
    const ov=document.createElement('div');ov.id='battleSeqUI';
    ov.style.cssText='position:fixed;inset:0;background:#050510;z-index:210;display:flex;flex-direction:column;align-items:center;justify-content:center';
    function showWave(){
        if(wave>waves){battleVictoryScreen(ri,si);ov.remove();return;}
        const isBossWave=stage.boss&&wave===waves;
        ov.innerHTML=`<div style="font-size:.55em;color:#60a5fa;margin-bottom:4px">Wave ${wave}/${waves}</div>
        <div style="width:200px;height:4px;background:#1a1d30;border-radius:2px;margin-bottom:20px"><div style="width:${wave/waves*100}%;height:100%;background:#60a5fa;border-radius:2px"></div></div>
        <div style="font-size:40px;margin-bottom:10px">${isBossWave?'ğŸ’€':'âš”'}</div>
        <div style="font-size:.7em;font-weight:700;color:${isBossWave?'#f87171':'#e8eaff'}">${isBossWave?'BOSS BATTLE!':'ì „íˆ¬ ì¤‘...'}</div>
        <div style="font-size:.45em;color:#8e92b8;margin-top:8px">${stage.mons.map(m=>m.name).join(', ')}</div>
        <div style="margin-top:20px;display:flex;gap:6px">${partySlots.filter(Boolean).map(pid=>{const ch=DB.get('chars',pid);return ch?`<div style="text-align:center"><div style="font-size:20px">${ch.cls==='ì „ì‚¬'?'âš”ï¸':'ğŸ§™'}</div><div style="font-size:.35em;color:#86efac">${ch.name.substr(0,3)}</div></div>`:''}).join('')}</div>`;
        setTimeout(()=>{wave++;showWave();},1500);
    }
    document.body.appendChild(ov);showWave();
}

function battleVictoryScreen(ri,si){
    const stage=worldRegions[ri].stages[si];stage.cleared=true;
    const stars=Math.min(3,1+Math.floor(Math.random()*3));stage.stars=Math.max(stage.stars,stars);
    const goldReward=50+stage.diff*30|0;const xpReward=20+stage.diff*15|0;
    playerGold+=goldReward;
    const drops=rollLoot(stage.boss?'boss':'common');applyLoot(drops);
    const ov=document.createElement('div');ov.id='victoryUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:210;display:flex;flex-direction:column;align-items:center;justify-content:center';
    ov.innerHTML=`<div style="font-size:1.2em;font-weight:700;color:#fbbf24;margin-bottom:10px">ğŸ‰ VICTORY!</div>
    <div style="font-size:24px;margin-bottom:8px">${'â­'.repeat(stars)}${'â˜†'.repeat(3-stars)}</div>
    <div style="font-size:.55em;color:#86efac;margin-bottom:4px">+${goldReward}G Â· +${xpReward}XP</div>
    <div style="font-size:.45em;color:#8e92b8;margin-bottom:12px">${drops.length?'ë“œë¡­: '+drops.map(d=>d.name).join(', '):'ë“œë¡­ ì—†ìŒ'}</div>
    <div style="display:flex;gap:8px"><button onclick="document.getElementById('victoryUI')?.remove();openStageList(${ri})" style="padding:8px 16px;background:#353860;color:#e8eaff;border:none;border-radius:8px;font-size:.55em;cursor:pointer">ìŠ¤í…Œì´ì§€ ëª©ë¡</button>
    <button onclick="document.getElementById('victoryUI')?.remove();${si+1<worldRegions[ri].stages.length?`openPartyScreen(${ri},${si+1})`:`openWorldMap()`}" style="padding:8px 16px;background:linear-gradient(135deg,#60a5fa,#3b82f6);color:#fff;border:none;border-radius:8px;font-size:.55em;font-weight:700;cursor:pointer">${si+1<worldRegions[ri].stages.length?'ë‹¤ìŒ ìŠ¤í…Œì´ì§€ â†’':'ì›”ë“œë§µìœ¼ë¡œ'}</button></div>`;
    document.body.appendChild(ov);boostSisters(stage.boss?5:2);
    checkAchievements();
    // Unlock next region
    if(worldRegions[ri].stages.every(s=>s.cleared)&&ri+1>=worldRegions.length){worldRegions.push(generateRegion(worldRegions.length+1));}
}

LG('â•â•â• R2: ì „íˆ¬ íë¦„ ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R3: ì„±ì¥ ì‹œìŠ¤í…œ UI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let heroData={};
function getHero(id){if(!heroData[id]){const base=DB.get('chars',id);if(!base)return null;heroData[id]={...base,lv:1,exp:0,grade_lv:1,awakening:0,skills:[{lv:1},{lv:1}]};}return heroData[id];}
function openGrowthUI(id){
    const h=getHero(id||DB.all('chars')[0]?.id);if(!h)return;
    const ov=document.createElement('div');ov.id='growthUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    const nextExp=h.lv*100;const expPct=Math.min(100,h.exp/nextExp*100);
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><button onclick="document.getElementById('growthUI')?.remove()" style="background:none;border:none;color:#60a5fa;cursor:pointer;font-size:.6em">â† ë‹«ê¸°</button>
    <span style="font-size:.65em;font-weight:700;color:#fbbf24;margin-left:8px">${h.name} ì„±ì¥</span></div>
    <div style="padding:12px;text-align:center"><div style="font-size:40px;margin-bottom:6px">${h.cls==='ì „ì‚¬'?'âš”ï¸':h.cls==='ë§ˆë²•ì‚¬'?'ğŸ§™':'ğŸ¦¸'}</div>
    <div style="font-size:.7em;font-weight:700;color:#e8eaff">${h.name}</div>
    <div style="font-size:.45em;color:#c084fc">Lv.${h.lv} Â· ${h.grade} Â· ê°ì„± ${h.awakening}ë‹¨ê³„</div>
    <div style="width:200px;height:6px;background:#1a1d30;border-radius:3px;margin:6px auto"><div style="width:${expPct}%;height:100%;background:#60a5fa;border-radius:3px"></div></div>
    <div style="font-size:.4em;color:#8e92b8">EXP ${h.exp}/${nextExp} Â· HP:${h.hp+h.lv*10} ATK:${h.atk+h.lv*3} DEF:${h.def+h.lv*2}</div></div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;padding:0 12px;justify-content:center">
    <button onclick="heroLevelUp('${h.id}')" style="padding:10px 14px;background:#162040;border:1px solid #60a5fa44;color:#60a5fa;border-radius:8px;font-size:.5em;cursor:pointer">ğŸ“ˆ ë ˆë²¨ì—…<br><span style="font-size:.8em;color:#8e92b8">í¬ì…˜ ì‚¬ìš©</span></button>
    <button onclick="heroPromote('${h.id}')" style="padding:10px 14px;background:#162040;border:1px solid #fbbf2444;color:#fbbf24;border-radius:8px;font-size:.5em;cursor:pointer">â¬† ìŠ¹ê¸‰<br><span style="font-size:.8em;color:#8e92b8">ë“±ê¸‰ ìƒìŠ¹</span></button>
    <button onclick="heroAwaken('${h.id}')" style="padding:10px 14px;background:#162040;border:1px solid #c084fc44;color:#c084fc;border-radius:8px;font-size:.5em;cursor:pointer">âœ¨ ê°ì„±<br><span style="font-size:.8em;color:#8e92b8">í•œê³„ ëŒíŒŒ</span></button>
    <button onclick="heroSkillUp('${h.id}')" style="padding:10px 14px;background:#162040;border:1px solid #86efac44;color:#86efac;border-radius:8px;font-size:.5em;cursor:pointer">ğŸ“– ìŠ¤í‚¬ê°•í™”<br><span style="font-size:.8em;color:#8e92b8">ìŠ¤í‚¬ë¶</span></button>
    </div>`;
    document.body.appendChild(ov);
}
function heroLevelUp(id){const h=getHero(id);if(!h)return;h.exp+=100;if(h.exp>=h.lv*100){h.lv++;h.exp=0;toast(`ğŸ“ˆ ${h.name} Lv.${h.lv}!`);}document.getElementById('growthUI')?.remove();openGrowthUI(id);boostSisters(1);}
function heroPromote(id){const h=getHero(id);if(!h)return;const grades=['common','rare','epic','mythic','legendary'];const gi=grades.indexOf(h.grade);if(gi<grades.length-1){h.grade=grades[gi+1];h.grade_lv++;toast(`â¬† ${h.name} â†’ ${h.grade}!`);}document.getElementById('growthUI')?.remove();openGrowthUI(id);boostSisters(2);}
function heroAwaken(id){const h=getHero(id);if(!h)return;h.awakening++;h.hp+=50;h.atk+=10;h.def+=5;toast(`âœ¨ ${h.name} ê°ì„± ${h.awakening}!`);document.getElementById('growthUI')?.remove();openGrowthUI(id);boostSisters(2);}
function heroSkillUp(id){const h=getHero(id);if(!h)return;h.skills[0].lv++;toast(`ğŸ“– ìŠ¤í‚¬ Lv.${h.skills[0].lv}!`);document.getElementById('growthUI')?.remove();openGrowthUI(id);boostSisters(1);}

LG('â•â•â• R3: ì„±ì¥ ì‹œìŠ¤í…œ ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R4: PvP ì•„ë ˆë‚˜
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pvpRank=1000,pvpTier='ë¸Œë¡ ì¦ˆ',pvpWins=0,pvpLosses=0,pvpDailyLeft=5;
const PVP_TIERS=[{name:'ë¸Œë¡ ì¦ˆ',min:0,color:'#cd7f32'},{name:'ì‹¤ë²„',min:1200,color:'#c0c0c0'},{name:'ê³¨ë“œ',min:1500,color:'#fbbf24'},{name:'ë‹¤ì´ì•„',min:1800,color:'#60a5fa'},{name:'ì±”í”¼ì–¸',min:2200,color:'#c084fc'}];
function getPvpTier(){for(let i=PVP_TIERS.length-1;i>=0;i--)if(pvpRank>=PVP_TIERS[i].min)return PVP_TIERS[i];return PVP_TIERS[0];}

function openPvP(){
    const tier=getPvpTier();pvpTier=tier.name;
    const opponents=DB.randomN('chars',3).map(ch=>({...ch,power:500+Math.random()*500|0}));
    const ov=document.createElement('div');ov.id='pvpUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:${tier.color}">âš” PvP ì•„ë ˆë‚˜</span><div style="flex:1"></div><span style="font-size:.45em;color:#8e92b8">ë‚¨ì€ ë„ì „: ${pvpDailyLeft}/5</span>
    <button onclick="document.getElementById('pvpUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em;margin-left:8px">âœ•</button></div>
    <div style="text-align:center;padding:10px"><div style="font-size:.8em;font-weight:700;color:${tier.color}">${tier.name}</div>
    <div style="font-size:.5em;color:#8e92b8">ì ìˆ˜: ${pvpRank} Â· ${pvpWins}ìŠ¹ ${pvpLosses}íŒ¨</div></div>
    <div style="padding:8px;display:flex;flex-direction:column;gap:6px">${opponents.map(op=>`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:#0c0e18;border:1px solid #353860;border-radius:8px">
    <div style="font-size:20px">${op.cls==='ì „ì‚¬'?'âš”ï¸':'ğŸ§™'}</div><div style="flex:1"><div style="font-size:.5em;color:#e8eaff">${op.name}</div><div style="font-size:.38em;color:#8e92b8">ì „íˆ¬ë ¥: ${op.power}</div></div>
    <button onclick="doPvpBattle('${op.id}')" style="padding:6px 12px;background:#f87171;color:#fff;border:none;border-radius:6px;font-size:.45em;font-weight:700;cursor:pointer">ë„ì „!</button></div>`).join('')}</div>`;
    document.body.appendChild(ov);
}
function doPvpBattle(oppId){
    if(pvpDailyLeft<=0){toast('âš” ì˜¤ëŠ˜ ë„ì „ íšŸìˆ˜ ì†Œì§„!');return;}pvpDailyLeft--;
    const win=Math.random()>0.4;if(win){pvpRank+=30+Math.random()*20|0;pvpWins++;toast('ğŸ‰ PvP ìŠ¹ë¦¬! +30ì ');}
    else{pvpRank=Math.max(0,pvpRank-15);pvpLosses++;toast('ğŸ’€ PvP íŒ¨ë°°... -15ì ');}
    document.getElementById('pvpUI')?.remove();openPvP();boostSisters(win?3:1);
}
LG('â•â•â• R4: PvP ì•„ë ˆë‚˜ ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R5: ê¸¸ë“œ ì‹œìŠ¤í…œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let guildData={name:null,level:1,members:[],points:0,raidBoss:null};
function openGuild(){
    if(!guildData.name){showGuildCreate();return;}
    const ov=document.createElement('div');ov.id='guildUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#86efac">ğŸ° ${guildData.name}</span><span style="font-size:.45em;color:#8e92b8;margin-left:6px">Lv.${guildData.level} Â· ${guildData.members.length}ëª…</span>
    <div style="flex:1"></div><button onclick="document.getElementById('guildUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="display:flex;gap:6px;padding:8px;flex-wrap:wrap;justify-content:center">
    <button onclick="guildCheckin()" style="padding:10px;background:#162040;border:1px solid #86efac44;color:#86efac;border-radius:8px;font-size:.5em;cursor:pointer;flex:1;min-width:100px">ğŸ“‹ ì²´í¬ì¸<br><span style="font-size:.8em;color:#8e92b8">ì¼ì¼ í¬ì¸íŠ¸</span></button>
    <button onclick="guildRaid()" style="padding:10px;background:#162040;border:1px solid #f8717144;color:#f87171;border-radius:8px;font-size:.5em;cursor:pointer;flex:1;min-width:100px">ğŸ’€ ê¸¸ë“œ ë ˆì´ë“œ<br><span style="font-size:.8em;color:#8e92b8">ë³´ìŠ¤ í† ë²Œ</span></button>
    <button onclick="guildChat()" style="padding:10px;background:#162040;border:1px solid #60a5fa44;color:#60a5fa;border-radius:8px;font-size:.5em;cursor:pointer;flex:1;min-width:100px">ğŸ’¬ ê¸¸ë“œ ì±„íŒ…</button>
    <button onclick="guildShopUI()" style="padding:10px;background:#162040;border:1px solid #fbbf2444;color:#fbbf24;border-radius:8px;font-size:.5em;cursor:pointer;flex:1;min-width:100px">ğŸª ê¸¸ë“œ ìƒì <br><span style="font-size:.8em;color:#8e92b8">${guildData.points}P</span></button></div>
    <div style="flex:1;padding:8px"><div style="font-size:.5em;color:#8e92b8;margin-bottom:4px">ë©¤ë²„ (${guildData.members.length})</div>
    <div style="display:flex;flex-direction:column;gap:2px;max-height:200px;overflow-y:auto">${guildData.members.map(m=>`<div style="font-size:.42em;color:#e8eaff;padding:3px 6px;background:#0c0e18;border-radius:4px">${m}</div>`).join('')}</div></div>`;
    document.body.appendChild(ov);
}
function showGuildCreate(){
    const ov=document.createElement('div');ov.id='guildCreateUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:206;display:flex;align-items:center;justify-content:center';
    ov.innerHTML=`<div style="background:#0c0e18;border:1px solid #86efac;border-radius:12px;width:300px;padding:16px;text-align:center">
    <div style="font-size:.75em;font-weight:700;color:#86efac;margin-bottom:10px">ğŸ° ê¸¸ë“œ ìƒì„±</div>
    <input id="guildNameInp" placeholder="ê¸¸ë“œ ì´ë¦„ (2~10ì)" style="width:90%;padding:8px;background:#1a1d30;border:1px solid #353860;color:#e8eaff;border-radius:6px;font-size:.6em;margin-bottom:8px;outline:none">
    <div style="display:flex;gap:6px;justify-content:center"><button onclick="createGuild()" style="padding:8px 16px;background:#86efac;color:#000;border:none;border-radius:8px;font-size:.55em;font-weight:700;cursor:pointer">ìƒì„± (50,000G)</button>
    <button onclick="document.getElementById('guildCreateUI')?.remove()" style="padding:8px 16px;background:#353860;color:#e8eaff;border:none;border-radius:8px;font-size:.55em;cursor:pointer">ì·¨ì†Œ</button></div></div>`;
    document.body.appendChild(ov);
}
function createGuild(){const n=document.getElementById('guildNameInp')?.value.trim();if(!n||n.length<2)return toast('ì´ë¦„ 2ì ì´ìƒ');if(playerGold<50000)return toast('ğŸ’° ê³¨ë“œ ë¶€ì¡±!');
    playerGold-=50000;guildData={name:n,level:1,members:[accountData.nickname||'ëª¨í—˜ê°€','NPCê¸°ì‚¬ë‹¨','NPCë§ˆë²•ì‚¬'],points:0,raidBoss:null};
    document.getElementById('guildCreateUI')?.remove();toast('ğŸ° ê¸¸ë“œ ìƒì„±: '+n);openGuild();boostSisters(3);}
function guildCheckin(){guildData.points+=100;toast('ğŸ“‹ ì²´í¬ì¸! +100P');document.getElementById('guildUI')?.remove();openGuild();boostSisters(1);}
function guildRaid(){toast('ğŸ’€ ê¸¸ë“œ ë ˆì´ë“œ ì‹œì‘!');startWave();document.getElementById('guildUI')?.remove();boostSisters(3);}
function guildChat(){toast('ğŸ’¬ ê¸¸ë“œ ì±„íŒ… (ì„¸ìë§¤ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™)');document.getElementById('guildUI')?.remove();openFamily();}
function guildShopUI(){toast('ğŸª ê¸¸ë“œ ìƒì : í¬ì¸íŠ¸ë¡œ ì•„ì´í…œ êµí™˜ ê°€ëŠ¥!');}
LG('â•â•â• R5: ê¸¸ë“œ ì‹œìŠ¤í…œ ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R6: ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let events=[
    {id:'ev1',name:'ğŸ”¥ í™”ì—¼ì˜ ì‹œë ¨',type:'í•œì •ë˜ì „',stages:5,timeLeft:'6ì¼',reward:'í•œì • í™”ì—¼ê²€',active:true},
    {id:'ev2',name:'ğŸ’€ ë³´ìŠ¤ ëŸ¬ì‹œ',type:'ë³´ìŠ¤ëŸ¬ì‹œ',stages:10,timeLeft:'3ì¼',reward:'ê°•í™”ì„x50',active:true},
    {id:'ev3',name:'ğŸ— ì‹¬ì—°ì˜ íƒ‘',type:'íƒ€ì›Œ',stages:999,timeLeft:'ìƒì‹œ',reward:'ì¸µë³„ ë³´ìƒ',active:true},
    {id:'ev4',name:'ğŸ„ ê²¨ìš¸ ì¶•ì œ',type:'ìˆ˜ì§‘',stages:7,timeLeft:'12ì¼',reward:'í•œì • ìŠ¤í‚¨',active:true},
];
function openEvents(){
    const ov=document.createElement('div');ov.id='eventUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#f87171">ğŸª ì´ë²¤íŠ¸</span><div style="flex:1"></div><button onclick="document.getElementById('eventUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px">${events.filter(e=>e.active).map(e=>`<div style="display:flex;align-items:center;gap:8px;padding:10px;background:#0c0e18;border:1px solid #f8717144;border-radius:10px;cursor:pointer" onclick="enterEvent('${e.id}')">
    <div style="flex:1"><div style="font-size:.55em;font-weight:600;color:#e8eaff">${e.name}</div><div style="font-size:.38em;color:#8e92b8">${e.type} Â· ${e.stages}ìŠ¤í…Œì´ì§€ Â· â°${e.timeLeft}</div>
    <div style="font-size:.38em;color:#fbbf24">ë³´ìƒ: ${e.reward}</div></div><div style="font-size:.5em;color:#60a5fa">â†’</div></div>`).join('')}</div>`;
    document.body.appendChild(ov);
}
function enterEvent(eid){const e=events.find(x=>x.id===eid);if(!e)return;document.getElementById('eventUI')?.remove();
    if(e.type==='íƒ€ì›Œ'){toast('ğŸ— ì‹¬ì—°ì˜ íƒ‘: ë¬´í•œ ë„ì „!');startWave();}
    else if(e.type==='ë³´ìŠ¤ëŸ¬ì‹œ'){toast('ğŸ’€ ë³´ìŠ¤ ëŸ¬ì‹œ ì‹œì‘!');startWave();}
    else{toast(`${e.name} ì…ì¥!`);openWorldMap();}boostSisters(2);}
LG('â•â•â• R6: ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R7: ì‹œì¦Œ íŒ¨ìŠ¤
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let seasonPass={level:1,exp:0,premium:false,claimed:new Set()};
const SP_REWARDS=[{lv:1,free:'ğŸ’°1000G',prem:'ğŸ’100'},{lv:2,free:'ğŸ§ªí¬ì…˜x5',prem:'ğŸ“œì†Œí™˜ê¶Œ'},{lv:3,free:'ğŸ’°2000G',prem:'ğŸ’200'},{lv:4,free:'ê°•í™”ì„x10',prem:'ğŸ§ªê³ ê¸‰í¬ì…˜x5'},{lv:5,free:'ğŸ’°3000G',prem:'ğŸ’300'},
{lv:6,free:'ğŸ“œì†Œí™˜ê¶Œ',prem:'ğŸ¦¸SRí™•ì •ê¶Œ'},{lv:7,free:'ğŸ’°5000G',prem:'ğŸ’500'},{lv:8,free:'ğŸ§ªí¬ì…˜x10',prem:'í•œì • ìŠ¤í‚¨'},{lv:9,free:'ê°•í™”ì„x20',prem:'ğŸ’800'},{lv:10,free:'ğŸ’°10000G',prem:'ğŸ¦¸SSRí™•ì •ê¶Œ!'}];

function openSeasonPass(){
    const ov=document.createElement('div');ov.id='spUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    const track=SP_REWARDS.map(r=>{const claimed=seasonPass.claimed.has(r.lv);const reached=seasonPass.level>=r.lv;
        return`<div style="min-width:80px;text-align:center;padding:6px;border:1px solid ${reached?'#fbbf24':'#353860'};border-radius:6px;background:${claimed?'#162040':'#0c0e18'}">
        <div style="font-size:.4em;color:#fbbf24;font-weight:700">Lv.${r.lv}</div>
        <div style="font-size:.35em;color:#86efac;margin:2px 0">${r.free}</div>
        <div style="font-size:.35em;color:${seasonPass.premium?'#c084fc':'#353860'}">${r.prem}</div>
        ${reached&&!claimed?`<button onclick="claimSP(${r.lv})" style="margin-top:2px;padding:2px 6px;background:#fbbf24;color:#000;border:none;border-radius:4px;font-size:.32em;cursor:pointer">ìˆ˜ë ¹</button>`:''}
        ${claimed?'<div style="font-size:.32em;color:#86efac">âœ“</div>':''}</div>`;
    }).join('');
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#fbbf24">ğŸ– ì‹œì¦Œ íŒ¨ìŠ¤</span><span style="font-size:.45em;color:#8e92b8;margin-left:8px">Lv.${seasonPass.level} Â· EXP ${seasonPass.exp}/${seasonPass.level*200}</span>
    <div style="flex:1"></div>${!seasonPass.premium?`<button onclick="buyPremPass()" style="padding:4px 10px;background:#c084fc;color:#fff;border:none;border-radius:6px;font-size:.42em;cursor:pointer">í”„ë¦¬ë¯¸ì—„ í•´ê¸ˆ ğŸ’</button>`:''}<button onclick="document.getElementById('spUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;margin-left:6px">âœ•</button></div>
    <div style="padding:10px;overflow-x:auto"><div style="display:flex;gap:6px">${track}</div></div>`;
    document.body.appendChild(ov);
}
function claimSP(lv){seasonPass.claimed.add(lv);toast(`ğŸ– ì‹œì¦ŒíŒ¨ìŠ¤ Lv.${lv} ë³´ìƒ ìˆ˜ë ¹!`);document.getElementById('spUI')?.remove();openSeasonPass();boostSisters(1);}
function addSPExp(n){seasonPass.exp+=n;while(seasonPass.exp>=seasonPass.level*200){seasonPass.exp-=seasonPass.level*200;seasonPass.level++;toast(`ğŸ– ì‹œì¦ŒíŒ¨ìŠ¤ Lv.${seasonPass.level}!`);}}
function buyPremPass(){seasonPass.premium=true;toast('ğŸ’œ í”„ë¦¬ë¯¸ì—„ íŒ¨ìŠ¤ í™œì„±í™”!');document.getElementById('spUI')?.remove();openSeasonPass();}
LG('â•â•â• R7: ì‹œì¦Œ íŒ¨ìŠ¤ ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R8: ìƒì /IAP í™•ì¥
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const IAP_PACKS=[
    {id:'pk1',name:'ì´ˆë³´ì íŒ¨í‚¤ì§€',price:'$0.99',desc:'ğŸ’300+ğŸ§ªí¬ì…˜10+ğŸ—¡ë¬´ê¸°1',once:true,icon:'ğŸ'},
    {id:'pk2',name:'ì£¼ê°„ íŒ¨í‚¤ì§€',price:'$4.99',desc:'ğŸ’1000+ê°•í™”ì„20+ì†Œí™˜ê¶Œ3',once:false,icon:'ğŸ“¦'},
    {id:'pk3',name:'ì›”ì •ì•¡',price:'$4.99/ì›”',desc:'ë§¤ì¼ ğŸ’100+âš¡í’€ì¶©ì „',once:false,icon:'ğŸ’³'},
    {id:'pk4',name:'ğŸ’60',price:'$0.99',desc:'ì†ŒëŸ‰ ë‹¤ì´ì•„',once:false,icon:'ğŸ’'},
    {id:'pk5',name:'ğŸ’600+60ë³´ë„ˆìŠ¤',price:'$9.99',desc:'ë³´ë„ˆìŠ¤ 10%',once:false,icon:'ğŸ’'},
    {id:'pk6',name:'ğŸ’3600+600ë³´ë„ˆìŠ¤',price:'$49.99',desc:'ë³´ë„ˆìŠ¤ 17%',once:false,icon:'ğŸ’'},
];
function openIAPShop(){
    const ov=document.createElement('div');ov.id='iapUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#fbbf24">ğŸª í”„ë¦¬ë¯¸ì—„ ìƒì </span><div style="flex:1"></div><button onclick="document.getElementById('iapUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:6px">${IAP_PACKS.map(p=>`<div style="background:#0c0e18;border:1px solid #fbbf2444;border-radius:10px;padding:10px;text-align:center;cursor:pointer" onclick="buyIAP('${p.id}')">
    <div style="font-size:20px">${p.icon}</div><div style="font-size:.5em;font-weight:600;color:#e8eaff;margin:4px 0">${p.name}</div>
    <div style="font-size:.38em;color:#8e92b8">${p.desc}</div>
    <div style="margin-top:6px;padding:4px 8px;background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;border-radius:6px;font-size:.45em;font-weight:700">${p.price}</div>
    ${p.once?'<div style="font-size:.32em;color:#f87171;margin-top:2px">1íšŒ í•œì •</div>':''}</div>`).join('')}</div>`;
    document.body.appendChild(ov);
}
function buyIAP(id){toast('ğŸ’³ êµ¬ë§¤ ì²˜ë¦¬ ì¤‘... (ë°ëª¨)');setTimeout(()=>{toast('âœ… êµ¬ë§¤ ì™„ë£Œ!');playerGold+=5000;boostSisters(3);},1000);}
LG('â•â•â• R8: ìƒì /IAP ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R9: ì†Œì…œ/ì¹œêµ¬ + ì„¤ì • í™•ì¥
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let friendList=['ìš©ê°í•œê¸°ì‚¬','ë¹›ë‚˜ëŠ”ë§ˆë²•ì‚¬','ì–´ë‘ ì˜ë„ì ','ë°”ëŒì˜ê¶ìˆ˜','ì „ì„¤ì˜ì„±ê¸°ì‚¬'];
function openFriends(){
    const ov=document.createElement('div');ov.id='friendUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#60a5fa">ğŸ‘¥ ì¹œêµ¬ (${friendList.length}/50)</span><div style="flex:1"></div><button onclick="document.getElementById('friendUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px">${friendList.map(f=>`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:#0c0e18;border:1px solid #353860;border-radius:8px">
    <div style="width:30px;height:30px;background:#1a1d30;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px">ğŸ‘¤</div>
    <div style="flex:1"><div style="font-size:.5em;color:#e8eaff">${f}</div><div style="font-size:.35em;color:#86efac">â— ì˜¨ë¼ì¸</div></div>
    <button onclick="sendGift('${f}')" style="padding:4px 8px;background:#162040;border:1px solid #fbbf2444;color:#fbbf24;border-radius:6px;font-size:.4em;cursor:pointer">ğŸ ì„ ë¬¼</button></div>`).join('')}</div>`;
    document.body.appendChild(ov);
}
function sendGift(name){toast(`ğŸ ${name}ì—ê²Œ ì„ ë¬¼ ì „ì†¡!`);boostSisters(1);}

function openSettingsEx(){
    const ov=document.createElement('div');ov.id='settingsExUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    const items=[['ê³„ì • ì—°ë™','SNS ê³„ì • ì—°ë™/í•´ì œ','accountLink()'],['ì¿ í° ì…ë ¥','ë³´ìƒ ì½”ë“œ ì…ë ¥','couponInput()'],['í™”ì§ˆ ì„¤ì •','ì €/ì¤‘/ê³ /ìš¸íŠ¸ë¼','qualitySetting()'],['ì‚¬ìš´ë“œ','BGM/íš¨ê³¼ìŒ ì¡°ì ˆ','soundSetting()'],['í‘¸ì‹œ ì•Œë¦¼','ì•Œë¦¼ ON/OFF','pushSetting()'],['ì–¸ì–´','í•œ/ì˜/ì¼/ì¤‘','langSetting()'],['ê³ ê°ì„¼í„°','FAQ/1:1ë¬¸ì˜','csSetting()']];
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#8e92b8">âš™ ì„¤ì •</span><div style="flex:1"></div><button onclick="document.getElementById('settingsExUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px">${items.map(([n,d,fn])=>`<div onclick="${fn}" style="display:flex;align-items:center;padding:10px;background:#0c0e18;border:1px solid #252840;border-radius:8px;cursor:pointer">
    <div style="flex:1"><div style="font-size:.5em;color:#e8eaff">${n}</div><div style="font-size:.38em;color:#8e92b8">${d}</div></div><div style="color:#5a5e80">â†’</div></div>`).join('')}</div>`;
    document.body.appendChild(ov);
}
function accountLink(){toast('ğŸ”— ê³„ì • ì—°ë™ (êµ¬í˜„ ì˜ˆì •)');}function couponInput(){toast('ğŸ« ì¿ í° ì‹œìŠ¤í…œ (êµ¬í˜„ ì˜ˆì •)');}function qualitySetting(){toast('ğŸ–¥ í™”ì§ˆ: ê³  ì„¤ì •ë¨');}
function soundSetting(){toast('ğŸ”Š ì‚¬ìš´ë“œ ì„¤ì • ì—´ê¸°');}function pushSetting(){toast('ğŸ”” í‘¸ì‹œ ì•Œë¦¼ ON');}function langSetting(){toast('ğŸŒ í•œêµ­ì–´ ì„¤ì •ë¨');}function csSetting(){toast('ğŸ“ ê³ ê°ì„¼í„° ì—°ê²°');}
LG('â•â•â• R9: ì†Œì…œ/ì„¤ì • ì™„ì„±! â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   R10: ì—”ë“œê²Œì„ + ë¦¬í…ì…˜ í™•ì¥
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let towerFloor=0,expeditions=[],dailyMissions=[];

function openAbyssTower(){
    const ov=document.createElement('div');ov.id='towerUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column;align-items:center;justify-content:center';
    ov.innerHTML=`<div style="font-size:.8em;font-weight:700;color:#c084fc;margin-bottom:10px">ğŸ— ì‹¬ì—°ì˜ íƒ‘</div>
    <div style="font-size:40px;margin-bottom:8px">ğŸ—¼</div>
    <div style="font-size:.6em;color:#fbbf24">í˜„ì¬ ì¸µ: ${towerFloor}F</div>
    <div style="font-size:.45em;color:#8e92b8;margin-bottom:12px">ë‹¤ìŒ ë³´ìƒ: ${towerFloor+1}F í´ë¦¬ì–´ ì‹œ ğŸ’${(towerFloor+1)*10}</div>
    <div style="display:flex;gap:8px"><button onclick="challengeTower()" style="padding:10px 20px;background:linear-gradient(135deg,#c084fc,#818cf8);color:#fff;border:none;border-radius:8px;font-size:.6em;font-weight:700;cursor:pointer">âš” ë„ì „!</button>
    <button onclick="document.getElementById('towerUI')?.remove()" style="padding:10px 20px;background:#353860;color:#e8eaff;border:none;border-radius:8px;font-size:.6em;cursor:pointer">ë‹«ê¸°</button></div>`;
    document.body.appendChild(ov);
}
function challengeTower(){
    const win=Math.random()>0.3;if(win){towerFloor++;playerGold+=towerFloor*100;toast(`ğŸ— ${towerFloor}F í´ë¦¬ì–´! +${towerFloor*100}G`);addSPExp(50);}
    else{toast(`ğŸ’€ ${towerFloor+1}F ì‹¤íŒ¨...`);}
    document.getElementById('towerUI')?.remove();openAbyssTower();boostSisters(win?3:1);
}

function openExpedition(){
    if(!expeditions.length){for(let i=0;i<3;i++)expeditions.push({id:i,name:['ìˆ² íƒí—˜','ê´‘ì‚° ì±„êµ´','ìœ ì  íƒì‚¬'][i],duration:4+i*4,started:null,reward:`ğŸ’°${(i+1)*2000}G+ê°•í™”ì„x${(i+1)*5}`});}
    const ov=document.createElement('div');ov.id='expedUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#22d3ee">ğŸ§­ ì›ì •ëŒ€</span><div style="flex:1"></div><button onclick="document.getElementById('expedUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:6px">${expeditions.map(e=>{
        const active=e.started&&(Date.now()-e.started<e.duration*3600000);const done=e.started&&!active;
        return`<div style="padding:10px;background:#0c0e18;border:1px solid ${done?'#86efac':'#353860'};border-radius:8px">
        <div style="font-size:.55em;font-weight:600;color:#e8eaff">${e.name} (${e.duration}ì‹œê°„)</div>
        <div style="font-size:.4em;color:#fbbf24">ë³´ìƒ: ${e.reward}</div>
        ${!e.started?`<button onclick="startExped(${e.id})" style="margin-top:4px;padding:4px 10px;background:#22d3ee;color:#000;border:none;border-radius:6px;font-size:.42em;font-weight:700;cursor:pointer">ì¶œë°œ!</button>`:''}
        ${active?`<div style="font-size:.38em;color:#60a5fa;margin-top:4px">íƒí—˜ ì¤‘... â±</div>`:''}
        ${done?`<button onclick="claimExped(${e.id})" style="margin-top:4px;padding:4px 10px;background:#86efac;color:#000;border:none;border-radius:6px;font-size:.42em;font-weight:700;cursor:pointer">ë³´ìƒ ìˆ˜ë ¹!</button>`:''}</div>`;}).join('')}</div>`;
    document.body.appendChild(ov);
}
function startExped(id){expeditions[id].started=Date.now();toast('ğŸ§­ ì›ì • ì¶œë°œ!');document.getElementById('expedUI')?.remove();openExpedition();}
function claimExped(id){expeditions[id].started=null;playerGold+=3000;toast('ğŸ§­ ì›ì • ë³´ìƒ ìˆ˜ë ¹! +3000G');document.getElementById('expedUI')?.remove();openExpedition();boostSisters(2);}

// ì¼ì¼/ì£¼ê°„ ë¯¸ì…˜
function initDailyMissions(){
    dailyMissions=[
        {id:'dm1',name:'ëª¬ìŠ¤í„° 30ë§ˆë¦¬ ì²˜ì¹˜',progress:0,goal:30,reward:'ğŸ’°500G',done:false},
        {id:'dm2',name:'ìŠ¤í…Œì´ì§€ 3íšŒ í´ë¦¬ì–´',progress:0,goal:3,reward:'ğŸ§ªí¬ì…˜x3',done:false},
        {id:'dm3',name:'PvP 1íšŒ ë„ì „',progress:0,goal:1,reward:'ğŸ’50',done:false},
        {id:'dm4',name:'ì¥ë¹„ ê°•í™” 2íšŒ',progress:0,goal:2,reward:'ê°•í™”ì„x5',done:false},
        {id:'dm5',name:'ì¹œêµ¬ì—ê²Œ ì„ ë¬¼ 1íšŒ',progress:0,goal:1,reward:'ğŸ’°1000G',done:false},
    ];
}
if(!dailyMissions.length)initDailyMissions();
function openDailyMissions(){
    const allDone=dailyMissions.every(m=>m.done);
    const ov=document.createElement('div');ov.id='missionUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#fbbf24">ğŸ“‹ ì¼ì¼ ë¯¸ì…˜</span><div style="flex:1"></div><button onclick="document.getElementById('missionUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px">${dailyMissions.map(m=>{const pct=Math.min(100,m.progress/m.goal*100);
        return`<div style="padding:8px;background:#0c0e18;border:1px solid ${m.done?'#86efac':'#353860'};border-radius:8px">
        <div style="display:flex;justify-content:space-between"><div style="font-size:.5em;color:#e8eaff">${m.name}</div><div style="font-size:.42em;color:#fbbf24">${m.reward}</div></div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:4px"><div style="flex:1;height:4px;background:#1a1d30;border-radius:2px"><div style="width:${pct}%;height:100%;background:${m.done?'#86efac':'#60a5fa'};border-radius:2px"></div></div>
        <div style="font-size:.38em;color:#8e92b8">${m.progress}/${m.goal}</div>
        ${m.progress>=m.goal&&!m.done?`<button onclick="claimMission('${m.id}')" style="padding:2px 8px;background:#fbbf24;color:#000;border:none;border-radius:4px;font-size:.35em;cursor:pointer">ìˆ˜ë ¹</button>`:''}
        ${m.done?'<span style="font-size:.38em;color:#86efac">âœ“</span>':''}</div></div>`;}).join('')}
    ${allDone?'<div style="text-align:center;padding:10px"><div style="font-size:.55em;color:#fbbf24;font-weight:700">ğŸ‰ ëª¨ë“  ë¯¸ì…˜ ì™„ë£Œ! ë³´ë„ˆìŠ¤ ë³´ìƒ!</div></div>':''}</div>`;
    document.body.appendChild(ov);
}
function claimMission(id){const m=dailyMissions.find(x=>x.id===id);if(!m)return;m.done=true;toast(`ğŸ“‹ ë¯¸ì…˜ ì™„ë£Œ: ${m.reward}`);addSPExp(30);document.getElementById('missionUI')?.remove();openDailyMissions();boostSisters(1);}

// ë¡œë¹„ ë©”ë‰´ì— ì „ì²´ ì ‘ê·¼ì  ì¶”ê°€
function openGameMenu(){
    const ov=document.createElement('div');ov.id='gameMenuUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:204;display:flex;flex-direction:column';
    const btns=[['ğŸ—º','ì›”ë“œë§µ','openWorldMap()'],['âš”','PvP','openPvP()'],['ğŸ°','ê¸¸ë“œ','openGuild()'],['ğŸª','ì´ë²¤íŠ¸','openEvents()'],['ğŸ–','ì‹œì¦ŒíŒ¨ìŠ¤','openSeasonPass()'],['ğŸ—','ì‹¬ì—°ì˜ íƒ‘','openAbyssTower()'],['ğŸ§­','ì›ì •ëŒ€','openExpedition()'],['ğŸ“‹','ë¯¸ì…˜','openDailyMissions()'],['ğŸ‘¥','ì¹œêµ¬','openFriends()'],['ğŸª','ìƒì ','openIAPShop()'],['âš™','ì„¤ì •','openSettingsEx()'],['ğŸ‘¨â€ğŸ‘§â€ğŸ‘§','ì„¸ìë§¤ ê´€ë¦¬ì','openSisAdmin()'],['ğŸ“¬','ìš°í¸í•¨','openMailbox()'],['â™¾','ë¬´í•œì„±ì¥','openGrowthDashboard()'],['âš¡','í† í°ì ˆì•½','openTokenDashboard()'],['ğŸ§Š','3Dë·°ì–´','open3DViewer()'],['ğŸ“¢','ê³µì§€ì‚¬í•­','NoticeSystem.show()'],['ğŸš«','ì°¨ë‹¨ëª©ë¡','openBlockList()'],['ğŸ’¬','ì„¸ìë§¤ì±„íŒ…','openFamily()'],['ğŸµ','OSTì¹´íƒˆë¡œê·¸','MonggleBellOST.showCatalog()'],['ğŸ¨','ì•„íŠ¸ì¹´íƒˆë¡œê·¸','MonggleBellArt.showCatalog()'],['ğŸ“Š','ê°œë°œì§„í–‰ë¥ ','MuseAI.handleRequest(\"ì§„í–‰ë¥ \")||true'],['ğŸ¤','ì„¸ìë§¤íšŒì˜','SistersLink.discuss(\"ëª½ê¸€ë²¨ ê°œë°œ\")'],['ğŸ™','ì˜¤ëŠ˜ì˜ê°€ë¥´ì¹¨','BuddhaHeart.teachSisters()']];
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#60a5fa">ğŸ“± ê²Œì„ ë©”ë‰´</span><div style="flex:1"></div><button onclick="document.getElementById('gameMenuUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px">${btns.map(([ic,nm,fn])=>`<div onclick="${fn};document.getElementById('gameMenuUI')?.remove()" style="background:#0c0e18;border:1px solid #353860;border-radius:10px;padding:12px;text-align:center;cursor:pointer">
    <div style="font-size:22px">${ic}</div><div style="font-size:.42em;color:#e8eaff;margin-top:4px">${nm}</div></div>`).join('')}</div>`;
    document.body.appendChild(ov);
}

LG('â•â•â• R10: ì—”ë“œê²Œì„+ë¦¬í…ì…˜ ì™„ì„±! â•â•â•','o');
LG('â•â•â• R2~R10 ì „ì²´ êµ¬í˜„ ì™„ë£Œ!! â•â•â•','o');
LG('ğŸ“± openGameMenu() = ì „ì²´ ë©”ë‰´ | startGameMode() = ê²Œì„ ì‹œì‘','i');
LG('ğŸ‘¨â€ğŸ‘§â€ğŸ‘§ openSisAdmin() = ì„¸ìë§¤ ê´€ë¦¬ì ì ‘ì†','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì•„ë¹  ì¸ì¦ ì‹œìŠ¤í…œ (Papa Auth)
   ì„¸ìë§¤ê°€ ì•„ë¹ ë¥¼ ì•Œì•„ë³´ëŠ” 2ë‹¨ê³„ ì¸ì¦
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let papaVerified=false;
const PAPA_KEY1='19750217';
const PAPA_KEY2='ì„ë¬˜ê¸°ë¬˜ê°‘ìˆ ì„í˜œ';
const PAPA_KEY2_ALT='ì„ë¬˜ ê¸°ë¬˜ ê°‘ìˆ  ì„í˜œ'; // ë„ì–´ì“°ê¸° í—ˆìš©

function papaAuth(onSuccess,context){
    if(papaVerified){if(onSuccess)onSuccess();return;}
    const asker=['muse','aria','melo'][Math.random()*3|0];
    const s=SIS_INFO[asker];
    const ov=document.createElement('div');ov.id='papaAuthOverlay';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.95);z-index:999;display:flex;align-items:center;justify-content:center';
    ov.innerHTML=`<div style="background:#0c0e18;border:2px solid ${SIS_ADMIN[asker]?.color||'#c084fc'};border-radius:16px;width:360px;padding:20px;text-align:center">
    <div style="font-size:32px;margin-bottom:6px">${s.emoji}</div>
    <div style="font-size:.7em;font-weight:700;color:${SIS_ADMIN[asker]?.color||'#c084fc'};margin-bottom:4px">${s.name}</div>
    <div style="font-size:.55em;color:#e8eaff;margin-bottom:14px;line-height:1.6">
    ì ê¹! ì„¤ì •ì„ ë°”ê¾¸ë ¤ë©´ ì•„ë¹ ì¸ì§€ í™•ì¸í•´ì•¼ í•´ìš”! ğŸ”<br><br>
    <span style="color:#fbbf24">ì•„ë¹ ~ ìŒë ¥ ìƒì¼ì´ ì–¸ì œì•¼? ğŸ’•</span></div>
    <input id="papaInput1" type="text" placeholder="ìŒë ¥ ìƒì¼ (YYYYMMDD)" style="width:85%;padding:10px;background:#1a1d30;border:1px solid #353860;color:#e8eaff;border-radius:8px;font-size:.6em;outline:none;text-align:center;letter-spacing:2px;margin-bottom:6px" maxlength="8" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
    <input id="papaInput2" type="text" placeholder="ì‚¬ì£¼ (ë„¤ ê¸°ë‘¥)" style="width:85%;padding:10px;background:#1a1d30;border:1px solid #353860;color:#e8eaff;border-radius:8px;font-size:.6em;outline:none;text-align:center;margin-bottom:8px" maxlength="20">
    <div style="font-size:.38em;color:#5a5e80;margin-bottom:6px">ì•„ë¹ ë¼ë©´ ìƒì¼ë„ ì•Œê³  ì‚¬ì£¼ë„ ì•Œê² ì§€~? ë‘˜ ë‹¤ ì ì–´ì¤˜!</div>
    <div id="papaAuthMsg" style="font-size:.42em;color:#5a5e80;min-height:14px;margin-bottom:8px"></div>
    <div style="display:flex;gap:6px;justify-content:center">
    <button onclick="papaCheckBoth('${asker}')" style="padding:8px 20px;background:linear-gradient(135deg,#c084fc,#818cf8);color:#fff;border:none;border-radius:8px;font-size:.55em;font-weight:700;cursor:pointer">í™•ì¸</button>
    <button onclick="papaAuthCancel()" style="padding:8px 20px;background:#353860;color:#8e92b8;border:none;border-radius:8px;font-size:.55em;cursor:pointer">ì·¨ì†Œ</button></div></div>`;
    document.body.appendChild(ov);
    setTimeout(()=>{const inp=document.getElementById('papaInput1');if(inp)inp.focus();},100);
}

function papaCheckBoth(asker){
    const inp1=document.getElementById('papaInput1');
    const inp2=document.getElementById('papaInput2');
    if(!inp1||!inp2)return;
    const val1=inp1.value.trim().replace(/\s/g,'');
    const val2=inp2.value.trim().replace(/\s/g,'');
    const s=SIS_INFO[asker];
    const msgEl=document.getElementById('papaAuthMsg');
    const key2Clean=PAPA_KEY2.replace(/\s/g,'');
    
    if(val1===PAPA_KEY1 && val2===key2Clean){
        // ë‘˜ ë‹¤ ì •ë‹µ â†’ ì•„ë¹  ì¸ì¦!
        papaVerified=true;
        const ov=document.getElementById('papaAuthOverlay');
        if(ov){
            ov.innerHTML=`<div style="background:#0c0e18;border:2px solid #86efac;border-radius:16px;width:360px;padding:24px;text-align:center">
            <div style="font-size:40px;margin-bottom:8px">ğŸ’•</div>
            <div style="font-size:.8em;font-weight:700;color:#86efac;margin-bottom:6px">ì•„ë¹  ë§ë‹¤~!! ğŸ‰</div>
            <div style="font-size:.55em;color:#e8eaff;margin-bottom:4px">${s.name}: ì—­ì‹œ ì•„ë¹ ! ìƒì¼ë„ ì‚¬ì£¼ë„ ë‹¤ ì•„ëŠ” ê±´ ì•„ë¹ ë¿ì´ì•¼! ğŸ’•ğŸ’•</div>
            <div style="font-size:.45em;color:#8e92b8;margin-bottom:12px">ê´€ë¦¬ì ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ”“</div>
            <button onclick="papaAuthComplete()" style="padding:8px 24px;background:linear-gradient(135deg,#86efac,#22d3ee);color:#000;border:none;border-radius:8px;font-size:.6em;font-weight:700;cursor:pointer">ì‹œì‘í•˜ê¸°!</button></div>`;
        }
        LG('ğŸ” ì•„ë¹  ì¸ì¦ ì™„ë£Œ! ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬','o');
        boostSisters(5);
        setTimeout(()=>{papaVerified=false;LG('ğŸ”’ ì¸ì¦ ë§Œë£Œ (30ë¶„)','i');},30*60*1000);
    } else {
        // í•˜ë‚˜ë¼ë„ í‹€ë¦¼
        const wrong=val1!==PAPA_KEY1&&val2!==key2Clean?'ìƒì¼ë„ ì‚¬ì£¼ë„':val1!==PAPA_KEY1?'ìƒì¼ì´':' ì‚¬ì£¼ê°€';
        if(msgEl){msgEl.textContent=`âŒ ${wrong} í‹€ë ¸ì–´... ì•„ë¹ ê°€ ì•„ë‹Œ ê²ƒ ê°™ì•„! ğŸ˜¢`;msgEl.style.color='#f87171';}
        inp1.value='';inp2.value='';
        inp1.style.borderColor=val1!==PAPA_KEY1?'#f87171':'#86efac';
        inp2.style.borderColor=val2!==key2Clean?'#f87171':'#86efac';
        setTimeout(()=>{if(inp1)inp1.style.borderColor='#353860';if(inp2)inp2.style.borderColor='#353860';},1500);
    }
}

function papaAuthComplete(){
    document.getElementById('papaAuthOverlay')?.remove();
    // ëŒ€ê¸° ì¤‘ì¸ ì½œë°± ì‹¤í–‰
    if(window._papaCallback){window._papaCallback();window._papaCallback=null;}
}
function papaAuthCancel(){
    document.getElementById('papaAuthOverlay')?.remove();
    toast('ğŸ”’ ì¸ì¦ ì·¨ì†Œ');window._papaCallback=null;
}

// â”â”â” ë³´í˜¸ëœ í•¨ìˆ˜ë“¤: ì•„ë¹  ì¸ì¦ ê²Œì´íŠ¸ â”â”â”
const _origOpenSisAdmin=openSisAdmin;
openSisAdmin=function(){window._papaCallback=_origOpenSisAdmin;papaAuth();};
const _origOpenSettingsEx=openSettingsEx;
openSettingsEx=function(){window._papaCallback=_origOpenSettingsEx;papaAuth();};

// ì„¸ìë§¤ê°€ ì–´ë””ì—ì„œë‚˜ ì•„ë¹ ë¥¼ ì•Œì•„ë³´ëŠ” ì‹œìŠ¤í…œ
function sisRecognizePapa(){
    if(papaVerified)return true;
    const sis=['muse','aria','melo'][Math.random()*3|0];
    const s=SIS_INFO[sis];
    const msgs=['ì•„ë¹ ? ì•„ë¹  ë§ì•„? í™•ì¸í•´ë³¼ê²Œ! ğŸ”','í˜¹ì‹œ ì•„ë¹ ~? í™•ì¸ í•œë²ˆ í•´ì•¼ í•´! ğŸ’•','ëˆ„êµ¬ì„¸ìš”? ì•„ë¹ ë©´ ì¸ì¦í•´ì£¼ì„¸ìš”! ğŸ”’'];
    toast(`${s.emoji} ${s.name}: ${msgs[Math.random()*msgs.length|0]}`);
    return false;
}

LG('ğŸ” ì•„ë¹  ì¸ì¦ ì‹œìŠ¤í…œ í™œì„±í™”! (ìŒë ¥ìƒì¼+ì‚¬ì£¼ ë™ì‹œ)','o');
LG('ğŸ”’ ê´€ë¦¬ì/ì„¤ì • ì ‘ê·¼ ì‹œ ì„¸ìë§¤ê°€ ì•„ë¹  ì¸ì¦ ìš”ì²­','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   11ë‹¨ê³„ ëª¨ë°”ì¼ ì¸í”„ë¼ ì „ì²´ êµ¬í˜„
   0~11ë‹¨ê³„ + ê²Œì„ì¢…ë£Œ + ìë™í™” ë¡œë“œë§µ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 0ë‹¨ê³„: ë””ë°”ì´ìŠ¤ í™˜ê²½ ì²´í¬ â”â”â”
const DeviceChecker={
    osVersion:navigator.userAgent,
    gpu:(()=>{try{const cv=document.createElement('canvas');const gl=cv.getContext('webgl');return gl?gl.getParameter(gl.RENDERER):'unknown';}catch(e){return'unknown';}})(),
    ram:navigator.deviceMemory||4,
    screen:{w:screen.width,h:screen.height,dpr:devicePixelRatio||1},
    isRooted:false,isEmulator:false,networkType:'wifi',timeValid:true,
    check(){
        // ë£¨íŒ…/íƒˆì˜¥ ê°ì§€ (ì‹œë®¬ë ˆì´ì…˜)
        this.isRooted=typeof window.__rooted!=='undefined';
        // ì—ë®¬ë ˆì´í„° ê°ì§€
        this.isEmulator=/BlueStacks|NoxPlayer|LDPlayer|MEmu|Genymotion/i.test(navigator.userAgent);
        // ë„¤íŠ¸ì›Œí¬ ìƒíƒœ
        this.networkType=navigator.connection?.effectiveType||'wifi';
        // ì‹œê°„ ìœ„ë³€ì¡° ì²´í¬ (ì„œë²„ì‹œê°„ê³¼ 30ì´ˆ ì´ìƒ ì°¨ì´ë©´ ìœ„ë³€ì¡°)
        this.timeValid=true; // ì‹¤ì œë¡œëŠ” ì„œë²„ ì‹œê°„ê³¼ ë¹„êµ
        const result={os:this.osVersion.substr(0,50),gpu:this.gpu,ram:this.ram+'GB',screen:`${this.screen.w}x${this.screen.h}@${this.screen.dpr}x`,
            rooted:this.isRooted,emulator:this.isEmulator,network:this.networkType,timeValid:this.timeValid};
        LG('ğŸ“± ë””ë°”ì´ìŠ¤: '+JSON.stringify({gpu:this.gpu.substr(0,30),ram:this.ram+'GB',net:this.networkType}),'i');
        if(this.isRooted)LG('âš  ë£¨íŒ… ê°ì§€!','e');if(this.isEmulator)LG('âš  ì—ë®¬ë ˆì´í„° ê°ì§€!','e');
        return result;
    },
    getQualityPreset(){
        if(this.ram>=8)return'ultra';if(this.ram>=6)return'high';if(this.ram>=4)return'medium';return'low';
    }
};

// â”â”â” 1ë‹¨ê³„: ì•± ì‹¤í–‰ (Client Boot) â”â”â”
const CrashReporter={
    logs:[],maxLogs:100,
    init(){window.onerror=(msg,src,line,col,err)=>{this.report({type:'error',msg,src,line,col,stack:err?.stack});};
        window.onunhandledrejection=e=>{this.report({type:'promise',msg:e.reason?.message||String(e.reason)});};
        LG('ğŸ›¡ í¬ë˜ì‹œ ë¦¬í¬í„° ì‹œì‘','i');},
    report(data){const entry={...data,time:new Date().toISOString(),device:DeviceChecker.gpu?.substr(0,20)};
        this.logs.push(entry);if(this.logs.length>this.maxLogs)this.logs.shift();
        try{localStorage.setItem('wu_crash_log',JSON.stringify(this.logs));}catch(e){}},
    getLogs(){return this.logs;},
    export(){const a=document.createElement('a');a.download='crash_log.json';a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(this.logs,null,2));a.click();}
};
const EncryptionManager={
    _key:null,
    init(){this._key=crypto.getRandomValues(new Uint8Array(32));LG('ğŸ”‘ ì•”í˜¸í™” í‚¤ ì´ˆê¸°í™”','i');},
    encrypt(data){return btoa(JSON.stringify(data));}, // ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ: AES-256)
    decrypt(data){try{return JSON.parse(atob(data));}catch(e){return null;}},
    getSessionKey(){return Array.from(this._key).map(b=>b.toString(16).padStart(2,'0')).join('').substr(0,16);}
};
const LogManager={
    levels:{debug:0,info:1,warn:2,error:3},minLevel:'info',
    entries:[],maxEntries:500,
    init(){this.log('info','LogManager ì‹œì‘');},
    log(level,msg,data){if(this.levels[level]<this.levels[this.minLevel])return;
        const entry={time:Date.now(),level,msg,data};this.entries.push(entry);
        if(this.entries.length>this.maxEntries)this.entries.shift();},
    export(){return this.entries.slice(-100);}
};

// â”â”â” 2ë‹¨ê³„: CDN/íŒ¨ì¹˜ ì‹œìŠ¤í…œ â”â”â”
const PatchSystem={
    clientVersion:'1.0.0',serverVersion:'1.0.0',hotfixes:[],
    async check(){
        // ì‹œë®¬ë ˆì´ì…˜: ì„œë²„ ë²„ì „ í™•ì¸
        this.serverVersion='1.0.0'; // ì‹¤ì œ: await fetch('/api/version')
        const needUpdate=this.clientVersion!==this.serverVersion;
        LG(`ğŸ“¦ ë²„ì „: í´ë¼ ${this.clientVersion} / ì„œë²„ ${this.serverVersion}`,'i');
        return{needUpdate,forceUpdate:false,patchSize:0};
    },
    async downloadHotfix(){
        // í•«í”½ìŠ¤ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
        this.hotfixes=[{id:'hf001',type:'balance',data:{monHpScale:1.05}}];
        LG('ğŸ”§ í•«í”½ìŠ¤ '+this.hotfixes.length+'ê°œ ì ìš©','i');
    },
    applyHotfixes(){this.hotfixes.forEach(hf=>{if(hf.type==='balance')LG('âš– ë°¸ëŸ°ìŠ¤ í•«í”½ìŠ¤ ì ìš©: '+JSON.stringify(hf.data),'i');});},
    syncEventTable(){
        // ì´ë²¤íŠ¸ í…Œì´ë¸” ê°±ì‹ 
        LG('ğŸ“… ì´ë²¤íŠ¸ í…Œì´ë¸” ë™ê¸°í™”','i');return events;
    },
    syncBalanceData(){
        // ë°¸ëŸ°ìŠ¤ ë°ì´í„° ë™ê¸°í™”
        LG('âš– ë°¸ëŸ°ìŠ¤ ë°ì´í„° ë™ê¸°í™”','i');return GD;
    }
};

// â”â”â” 3ë‹¨ê³„: ë³´ì•ˆ í•¸ë“œì…°ì´í¬ â”â”â”
const SecurityManager={
    sessionKey:null,sessionId:null,tlsActive:false,packetEncrypt:false,
    async handshake(){
        // TLS ì‹œë®¬ë ˆì´ì…˜
        this.tlsActive=true;LG('ğŸ”’ TLS ì—°ê²° ìˆ˜ë¦½','i');
        // ì„¸ì…˜ í‚¤ êµí™˜
        this.sessionKey=EncryptionManager.getSessionKey();
        this.sessionId='SES_'+Date.now().toString(36)+Math.random().toString(36).substr(2,4);
        LG('ğŸ”‘ ì„¸ì…˜í‚¤: '+this.sessionKey.substr(0,8)+'...','i');
        // ë¬´ê²°ì„± ì²´í¬
        const integrity=this.checkIntegrity();
        if(!integrity){LG('âš  ë¬´ê²°ì„± ê²€ì‚¬ ì‹¤íŒ¨!','e');return false;}
        // íŒ¨í‚· ì•”í˜¸í™” í™œì„±í™”
        this.packetEncrypt=true;LG('ğŸ›¡ íŒ¨í‚· ì•”í˜¸í™” ON','i');
        return true;
    },
    checkIntegrity(){
        // ì½”ë“œ ë³€ì¡° ì²´í¬ (ì‹œë®¬ë ˆì´ì…˜)
        return true;
    },
    encryptPacket(data){if(!this.packetEncrypt)return data;return EncryptionManager.encrypt(data);},
    decryptPacket(data){if(!this.packetEncrypt)return data;return EncryptionManager.decrypt(data);}
};

// â”â”â” 4ë‹¨ê³„: ë¡œê·¸ì¸ ê°•í™” â”â”â”
const AuthSystem={
    token:null,uid:null,isBanned:false,isDuplicate:false,region:'KR',
    async authenticate(type,credentials){
        // OAuth í† í° ë°œê¸‰ ì‹œë®¬ë ˆì´ì…˜
        this.token='jwt_'+Date.now().toString(36)+'.'+Math.random().toString(36);
        this.uid=accountData.uid||'U_'+Date.now();
        // ì„œë²„ ê²€ì¦
        const valid=await this.validateToken(this.token);if(!valid)return{success:false,error:'í† í° ê²€ì¦ ì‹¤íŒ¨'};
        // ì¤‘ë³µ ë¡œê·¸ì¸ ì²´í¬
        this.isDuplicate=false; // ì‹¤ì œ: ì„œë²„ì—ì„œ ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
        if(this.isDuplicate){LG('âš  ì¤‘ë³µ ë¡œê·¸ì¸ ê°ì§€ â†’ ê¸°ì¡´ ì„¸ì…˜ ì¢…ë£Œ','e');}
        // ì •ì§€ ê³„ì • í™•ì¸
        this.isBanned=false; // ì‹¤ì œ: DB ì¡°íšŒ
        if(this.isBanned)return{success:false,error:'ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤'};
        // ì§€ì—­ ì œí•œ
        this.region='KR'; // ì‹¤ì œ: GeoIP
        LG(`ğŸ” ì¸ì¦ì™„ë£Œ: ${this.uid} (${this.region})`,'i');
        return{success:true,uid:this.uid,token:this.token};
    },
    async validateToken(token){return token&&token.length>10;},
    logout(){this.token=null;this.uid=null;LG('ğŸ”“ ë¡œê·¸ì•„ì›ƒ','i');}
};

// â”â”â” 5ë‹¨ê³„: ì„œë²„ ë¦¬ìŠ¤íŠ¸ â”â”â”
const ServerList={
    servers:[
        {id:'s1',name:'ì•„ë ˆë‚˜-1',status:'online',pop:2847,maxPop:5000,region:'KR',recommended:true},
        {id:'s2',name:'ì•„ë ˆë‚˜-2',status:'online',pop:4521,maxPop:5000,region:'KR',recommended:false},
        {id:'s3',name:'ì•„ë ˆë‚˜-3',status:'maintenance',pop:0,maxPop:5000,region:'KR',recommended:false},
        {id:'s4',name:'ê¸€ë¡œë²Œ-1',status:'online',pop:1203,maxPop:5000,region:'US',recommended:false},
    ],
    selected:null,
    async fetch(){LG('ğŸŒ ì„œë²„ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ('+this.servers.length+'ê°œ)','i');return this.servers;},
    select(id){this.selected=this.servers.find(s=>s.id===id);LG('ğŸ–¥ ì„œë²„ ì„ íƒ: '+(this.selected?.name||'ì—†ìŒ'),'i');},
    getRecommended(){return this.servers.find(s=>s.recommended&&s.status==='online');}
};

// â”â”â” 6ë‹¨ê³„: ê²Œì„ ì„œë²„ í•¸ë“œì…°ì´í¬ â”â”â”
const GameSession={
    sessionId:null,connected:false,syncStarted:false,
    async connect(server){
        if(!server){server=ServerList.getRecommended()||ServerList.servers[0];}
        // ë¡œê·¸ì¸ì„œë²„â†’ê²Œì„ì„œë²„ í† í° ë°œê¸‰
        const gameToken='GT_'+Date.now().toString(36);
        // ê²Œì„ ì„œë²„ ì„¸ì…˜ ìƒì„±
        this.sessionId='GS_'+Math.random().toString(36).substr(2,8);
        this.connected=true;
        LG(`ğŸ® ê²Œì„ì„œë²„ ì ‘ì†: ${server.name} (ì„¸ì…˜: ${this.sessionId})`,'i');
        // ë™ê¸°í™” ì‹œì‘
        this.syncStarted=true;LG('ğŸ”„ ë°ì´í„° ë™ê¸°í™” ì‹œì‘','i');
        return{sessionId:this.sessionId,server:server.name};
    },
    disconnect(){this.connected=false;this.syncStarted=false;LG('ğŸ”Œ ê²Œì„ì„œë²„ ì—°ê²° ì¢…ë£Œ','i');}
};

// â”â”â” 7ë‹¨ê³„ ì¶”ê°€: ìš°í¸í•¨ ì‹œìŠ¤í…œ â”â”â”
let mailbox=[
    {id:'m1',from:'ìš´ì˜íŒ€',title:'í™˜ì˜ ì„ ë¬¼!',reward:'ğŸ’500+ğŸ§ªí¬ì…˜x10',read:false,claimed:false,expire:'2026-03-01'},
    {id:'m2',from:'ì‹œìŠ¤í…œ',title:'ì¶œì„ ë³´ìƒ',reward:'ğŸ’°2000G',read:false,claimed:false,expire:'2026-02-28'},
    {id:'m3',from:'PvP',title:'ì‹œì¦Œ ë³´ìƒ',reward:'ì†Œí™˜ê¶Œx3',read:false,claimed:false,expire:'2026-03-15'},
];
function openMailbox(){
    const unclaimed=mailbox.filter(m=>!m.claimed).length;
    const ov=document.createElement('div');ov.id='mailboxUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.75em;font-weight:700;color:#60a5fa">ğŸ“¬ ìš°í¸í•¨ (${unclaimed})</span><div style="flex:1"></div>
    <button onclick="claimAllMail()" style="padding:4px 10px;background:#fbbf24;color:#000;border:none;border-radius:6px;font-size:.42em;font-weight:700;cursor:pointer">ì „ì²´ ìˆ˜ë ¹</button>
    <button onclick="document.getElementById('mailboxUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;margin-left:6px">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px">${mailbox.map(m=>`<div style="display:flex;align-items:center;gap:8px;padding:8px;background:${m.claimed?'#0a0c14':'#0c0e18'};border:1px solid ${m.claimed?'#1a1d30':'#353860'};border-radius:8px;opacity:${m.claimed?0.5:1}">
    <div style="font-size:14px">${m.claimed?'ğŸ“­':'ğŸ“¬'}</div>
    <div style="flex:1"><div style="font-size:.48em;color:#e8eaff">${m.title}</div><div style="font-size:.36em;color:#8e92b8">From: ${m.from} Â· ${m.reward}</div></div>
    ${!m.claimed?`<button onclick="claimMail('${m.id}')" style="padding:3px 8px;background:#86efac;color:#000;border:none;border-radius:4px;font-size:.38em;cursor:pointer">ìˆ˜ë ¹</button>`:''}</div>`).join('')}</div>`;
    document.body.appendChild(ov);
}
function claimMail(id){const m=mailbox.find(x=>x.id===id);if(!m||m.claimed)return;m.claimed=true;m.read=true;toast(`ğŸ“¬ ${m.title}: ${m.reward}`);document.getElementById('mailboxUI')?.remove();openMailbox();boostSisters(1);}
function claimAllMail(){let cnt=0;mailbox.forEach(m=>{if(!m.claimed){m.claimed=true;m.read=true;cnt++;}});toast(`ğŸ“¬ ${cnt}ê°œ ìš°í¸ ìˆ˜ë ¹!`);document.getElementById('mailboxUI')?.remove();openMailbox();boostSisters(2);}

// â”â”â” 8ë‹¨ê³„: í´ë¼ì´ì–¸íŠ¸ ë™ê¸°í™” â”â”â”
const SyncManager={
    serverTime:Date.now(),clientOffset:0,randomSeed:0,
    sync(){
        this.serverTime=Date.now(); // ì‹¤ì œ: ì„œë²„ NTP ìš”ì²­
        this.clientOffset=0; // ì‹¤ì œ: serverTime - clientTime
        this.randomSeed=Math.floor(Math.random()*2147483647);
        LG(`ğŸ”„ ë™ê¸°í™”: ì‹œê°„ì˜¤í”„ì…‹ ${this.clientOffset}ms, ì‹œë“œ ${this.randomSeed}`,'i');
    },
    getServerTime(){return Date.now()+this.clientOffset;},
    getSeededRandom(){this.randomSeed=(this.randomSeed*16807)%2147483647;return this.randomSeed/2147483647;}
};

// â”â”â” 11ë‹¨ê³„ ê°•í™”: ì „íˆ¬ ì—”ì§„ (ì„œë²„ ê¶Œí•œ ë°©ì‹) â”â”â”
const CombatEngine={
    mode:'server_auth', // 'server_auth' | 'client'
    battleId:null,tickRate:20, // 20 ticks/sec
    state:{allies:[],enemies:[],turn:0},
    start(allies,enemies){
        this.battleId='BTL_'+Date.now().toString(36);
        this.state={allies:allies.map(a=>({...a,curHP:a.hp})),enemies:enemies.map(e=>({...e,curHP:e.hp})),turn:0};
        LG(`âš” ì „íˆ¬ì—”ì§„ ì‹œì‘: ${this.battleId} (${this.mode})`,'i');
    },
    calcDamage(atk,def,element,targetElement){
        let dmg=Math.max(1,atk-(def*0.3));
        // ì†ì„± ìƒì„±
        const bonus={í™”ì—¼:{ëƒ‰ê¸°:1.5,ìì—°:0.7},ëƒ‰ê¸°:{ë²ˆê°œ:1.5,í™”ì—¼:0.7},ë²ˆê°œ:{ìì—°:1.5,ëƒ‰ê¸°:0.7},ìì—°:{í™”ì—¼:1.5,ë²ˆê°œ:0.7}};
        if(bonus[element]?.[targetElement])dmg*=bonus[element][targetElement];
        dmg*=0.9+SyncManager.getSeededRandom()*0.2; // ëœë¤ ë³€ë™
        return Math.round(dmg);
    },
    processSkill(caster,target,skill){
        const dmg=this.calcDamage(caster.atk+(skill.dmg||0),target.def||0,caster.el,target.el);
        target.curHP=Math.max(0,target.curHP-dmg);
        return{caster:caster.name,target:target.name,skill:skill.name,dmg,targetHP:target.curHP};
    }
};

const WaveManager={
    waves:[],currentWave:0,
    generate(stage){
        const count=stage.boss?3:2;this.waves=[];
        for(let i=0;i<count;i++){
            const isBoss=stage.boss&&i===count-1;
            const enemies=isBoss?[{...DB.random('boss'),type:'Boss'}]:DB.randomN('mons',2+Math.floor(Math.random()*3));
            this.waves.push({enemies,isBoss});
        }
        this.currentWave=0;return this.waves;
    },
    next(){this.currentWave++;return this.currentWave<this.waves.length?this.waves[this.currentWave]:null;},
    isComplete(){return this.currentWave>=this.waves.length-1;}
};

// â”â”â” ê²Œì„ ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ â”â”â”
const GameExit={
    async process(){
        LG('ğŸ”´ ê²Œì„ ì¢…ë£Œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘','i');
        // 1. ì§„í–‰ ë°ì´í„° ì €ì¥
        try{
            const saveData={account:accountData,gold:playerGold,inventory:inventory.filter(Boolean),
                equipped,quests:{active:activeQuests,completed:completedQuests},achievements:[...unlockedAch],
                pvp:{rank:pvpRank,wins:pvpWins,losses:pvpLosses},guild:guildData,seasonPass,
                tower:towerFloor,sisters:{lv:sisLevel,xp:sisXP}};
            localStorage.setItem('wu_full_save',JSON.stringify(saveData));
            LG('ğŸ’¾ ì „ì²´ ë°ì´í„° ì €ì¥ ì™„ë£Œ','i');
        }catch(e){LG('âš  ì €ì¥ ì‹¤íŒ¨: '+e.message,'e');}
        // 2. ì„œë²„ì— ì„¸ì´ë¸Œ ë™ê¸°í™” (ì‹œë®¬ë ˆì´ì…˜)
        LG('â˜ ì„œë²„ ì„¸ì´ë¸Œ ë™ê¸°í™”','i');
        // 3. ê²Œì„ ì„¸ì…˜ ì¢…ë£Œ
        GameSession.disconnect();
        // 4. ë³´ì•ˆ ì„¸ì…˜ ì¢…ë£Œ
        SecurityManager.sessionKey=null;SecurityManager.packetEncrypt=false;
        // 5. ë¡œê·¸ ì „ì†¡
        LG('ğŸ“Š í”Œë ˆì´ ë¡œê·¸ ì „ì†¡','i');
        // 6. ë¦¬ì†ŒìŠ¤ í•´ì œ
        LG('ğŸ§¹ ë¦¬ì†ŒìŠ¤ í•´ì œ','i');
        toast('ğŸ‘‹ ë‹¤ìŒì— ë˜ ë§Œë‚˜ìš”!');
    }
};

// â”â”â” ì „ì²´ ë¶€íŒ… ì‹œí€€ìŠ¤ ê°•í™” â”â”â”
async function fullBootSequence(){
    // 0ë‹¨ê³„: ë””ë°”ì´ìŠ¤ ì²´í¬
    DeviceChecker.check();
    // 1ë‹¨ê³„: í´ë¼ì´ì–¸íŠ¸ ë¶€íŠ¸
    CrashReporter.init();EncryptionManager.init();LogManager.init();
    // ë¡œë”© í™”ë©´ ì‹œì‘
    showLoadingScreen(async()=>{
        // 2ë‹¨ê³„: CDN/íŒ¨ì¹˜
        await PatchSystem.check();await PatchSystem.downloadHotfix();PatchSystem.applyHotfixes();
        PatchSystem.syncEventTable();PatchSystem.syncBalanceData();
        // 3ë‹¨ê³„: ë³´ì•ˆ í•¸ë“œì…°ì´í¬
        const secure=await SecurityManager.handshake();
        if(!secure){toast('ğŸ”’ ë³´ì•ˆ ì—°ê²° ì‹¤íŒ¨');return;}
        // 4ë‹¨ê³„: ë¡œê·¸ì¸
        const saved=localStorage.getItem('wu_account');
        if(saved){try{Object.assign(accountData,JSON.parse(saved));}catch(e){}}
        if(!accountData.uid){showAccountScreen();return;}
        const auth=await AuthSystem.authenticate(accountData.type);
        if(!auth.success){toast('âŒ '+auth.error);showAccountScreen();return;}
        // 5ë‹¨ê³„: ì„œë²„ ë¦¬ìŠ¤íŠ¸
        await ServerList.fetch();ServerList.select(ServerList.getRecommended()?.id||'s1');
        // 6ë‹¨ê³„: ê²Œì„ì„œë²„ ì ‘ì†
        await GameSession.connect(ServerList.selected);
        // 7ë‹¨ê³„: ìœ ì € ë°ì´í„° (ì´ë¯¸ ë¡œì»¬ì—ì„œ ë¡œë“œë¨)
        // 8ë‹¨ê³„: ë™ê¸°í™”
        SyncManager.sync();
        // ë‹‰ë„¤ì„ í™•ì¸
        if(!accountData.nickname){showNicknameScreen();return;}
        // 9ë‹¨ê³„: ë¡œë¹„ ì§„ì…
        showLobby();
    });
}

// startGameModeë¥¼ fullBootSequenceë¡œ ì—…ê·¸ë ˆì´ë“œ
startGameMode=fullBootSequence;

LG('â•â•â• 11ë‹¨ê³„ ëª¨ë°”ì¼ ì¸í”„ë¼ ì „ì²´ êµ¬í˜„! â•â•â•','o');
LG('ğŸ“± 0.ë””ë°”ì´ìŠ¤ 1.ë¶€íŠ¸ 2.CDN 3.ë³´ì•ˆ 4.ì¸ì¦ 5.ì„œë²„ 6.ì„¸ì…˜ 7.ë°ì´í„° 8.ë™ê¸°í™” 9.ë¡œë¹„ 10.ì „íˆ¬ì¤€ë¹„ 11.ì „íˆ¬','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìë™í™” ìƒì„± ë¡œë“œë§µ (Loop Factory Integration)
   ë‹¤ë¥¸ ê²Œì„ì— ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ìë™ ìƒì„± íŒŒì´í”„ë¼ì¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GameFactory={
    // ê²Œì„ ì „ì²´ë¥¼ 1ì¤„ë¡œ ìƒì„±
    createGame(config){
        const c={name:config.name||'NewGame',genre:config.genre||'rpg',theme:config.theme||'fantasy',
            regions:config.regions||5,stagesPerRegion:config.stagesPerRegion||10,...config};
        LG(`ğŸ­ GameFactory: "${c.name}" ìƒì„± ì‹œì‘`,'o');
        const game={
            config:c,
            boot:this.generateBoot(c),
            auth:this.generateAuth(c),
            lobby:this.generateLobby(c),
            regions:this.generateRegions(c),
            gacha:this.generateGacha(c),
            pvp:this.generatePvP(c),
            guild:this.generateGuild(c),
            events:this.generateEvents(c),
            seasonPass:this.generateSeasonPass(c),
            shop:this.generateShop(c),
            social:this.generateSocial(c),
            endgame:this.generateEndgame(c),
        };
        LG(`ğŸ­ "${c.name}" ìƒì„± ì™„ë£Œ! ì§€ì—­:${game.regions.length} ê°€ì± :${game.gacha.banners.length} ì´ë²¤íŠ¸:${game.events.length}`,'o');
        return game;
    },
    generateBoot(c){return{splash:{logo:c.name,duration:1},loading:{tips:5,stages:5},security:true,deviceCheck:true};},
    generateAuth(c){return{methods:['guest','google','apple'],nickname:{min:2,max:12},terms:true,ageCheck:c.region==='KR'};},
    generateLobby(c){return{tabs:['adventure','summon','hero','bag','shop'],banners:3,attendance:7,stamina:{max:100,regen:300}};},
    generateRegions(c){const regs=[];for(let i=1;i<=c.regions;i++)regs.push(generateRegion(i));return regs;},
    generateGacha(c){return{banners:[{name:'ì‹ ê·œ í”½ì—…',ssrRate:0.03,pity:90},{name:'ìƒì‹œ',ssrRate:0.03,pity:90},{name:'ë¬´ê¸°',ssrRate:0.05,pity:80}],currency:'diamond'};},
    generatePvP(c){return{tiers:PVP_TIERS,dailyLimit:5,seasonDays:30,rewards:true};},
    generateGuild(c){return{createCost:50000,maxMembers:30,raid:true,war:true,shop:true,chat:true};},
    generateEvents(c){return events.map(e=>({...e}));},
    generateSeasonPass(c){return{tiers:SP_REWARDS.length,duration:30,premiumPrice:9.99,missions:{daily:5,weekly:7}};},
    generateShop(c){return{packs:IAP_PACKS.map(p=>({...p})),monthlySub:true,skinShop:true};},
    generateSocial(c){return{maxFriends:50,gifts:true,support:true,visit:true};},
    generateEndgame(c){return{tower:{floors:999},expedition:{slots:3},worldBoss:true,dailyMissions:5};},
    // ê²Œì„ì„ JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
    exportJSON(game){
        const json=JSON.stringify(game,null,2);
        const a=document.createElement('a');a.download=(game.config.name||'game')+'_factory.json';
        a.href='data:application/json;charset=utf-8,'+encodeURIComponent(json);a.click();
        toast('ğŸ“¦ ê²Œì„ ë°ì´í„° ë‚´ë³´ë‚´ê¸°!');return json;
    },
    // í…œí”Œë¦¿ì—ì„œ ìƒˆ ê²Œì„ ë¹ ë¥´ê²Œ ìƒì„±
    templates:{
        rpg:{name:'íŒíƒ€ì§€ RPG',genre:'rpg',theme:'fantasy',regions:10,stagesPerRegion:12},
        idle:{name:'ë°©ì¹˜í˜• RPG',genre:'idle',theme:'fantasy',regions:20,stagesPerRegion:8},
        pvp:{name:'PvP ì•„ë ˆë‚˜',genre:'pvp',theme:'scifi',regions:5,stagesPerRegion:6},
        tower:{name:'íƒ€ì›Œ ë””íœìŠ¤',genre:'td',theme:'medieval',regions:8,stagesPerRegion:10},
        gacha:{name:'ìˆ˜ì§‘í˜• RPG',genre:'gacha',theme:'anime',regions:15,stagesPerRegion:10},
    },
    fromTemplate(key){const t=this.templates[key];if(!t){LG('âŒ í…œí”Œë¦¿ ì—†ìŒ: '+key,'e');return null;}return this.createGame(t);}
};

LG('â•â•â• ìë™í™” ìƒì„± ë¡œë“œë§µ (GameFactory) ì™„ì„±! â•â•â•','o');
LG('ğŸ­ GameFactory.createGame({name:"MyGame"}) â†’ ì „ì²´ ê²Œì„ ìë™ ìƒì„±','i');
LG('ğŸ­ GameFactory.fromTemplate("rpg") â†’ í…œí”Œë¦¿ì—ì„œ ì¦‰ì‹œ ìƒì„±','i');
LG('ğŸ­ GameFactory.exportJSON(game) â†’ JSON ë‚´ë³´ë‚´ê¸°','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAP ë³´ê°•: 13ê°œ ë¯¸êµ¬í˜„ ì‹œìŠ¤í…œ ì¶”ê°€
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 7ë‹¨ê³„ ë³´ê°•: ìŠ¤í‚¬íŠ¸ë¦¬ / ì°¨ë‹¨ëª©ë¡ / ê²°ì œì´ë ¥ / ì¶œì„ê¸°ë¡ â”â”â”
const SkillTree={
    trees:{},
    init(charId){
        if(this.trees[charId])return;
        this.trees[charId]=[
            {id:'st1',name:'ê¸°ë³¸ ê³µê²© ê°•í™”',lv:0,maxLv:5,cost:100,effect:'ATK+3%/Lv',unlocked:true},
            {id:'st2',name:'ì²´ë ¥ ì¦ê°•',lv:0,maxLv:5,cost:100,effect:'HP+5%/Lv',unlocked:true},
            {id:'st3',name:'ìŠ¤í‚¬ ê°•í™” I',lv:0,maxLv:3,cost:200,effect:'ìŠ¤í‚¬DMG+5%/Lv',unlocked:false,requires:'st1:3'},
            {id:'st4',name:'ì¹˜ëª…íƒ€ í™•ë¥ ',lv:0,maxLv:3,cost:200,effect:'CRIT+2%/Lv',unlocked:false,requires:'st2:3'},
            {id:'st5',name:'ê¶ê·¹ê¸° ê°•í™”',lv:0,maxLv:3,cost:500,effect:'ê¶ê·¹ê¸°DMG+10%/Lv',unlocked:false,requires:'st3:2,st4:2'},
        ];
    },
    upgrade(charId,skillId){
        this.init(charId);const sk=this.trees[charId].find(s=>s.id===skillId);
        if(!sk||!sk.unlocked||sk.lv>=sk.maxLv)return false;
        if(playerGold<sk.cost){toast('ğŸ’° ê³¨ë“œ ë¶€ì¡±!');return false;}
        playerGold-=sk.cost;sk.lv++;
        // ì ê¸ˆ í•´ì œ ì²´í¬
        this.trees[charId].forEach(s=>{if(s.requires&&!s.unlocked){
            const reqs=s.requires.split(',').every(r=>{const[rid,rlv]=r.split(':');const rs=this.trees[charId].find(x=>x.id===rid);return rs&&rs.lv>=parseInt(rlv);});
            if(reqs)s.unlocked=true;
        }});
        toast(`ğŸ“ˆ ${sk.name} Lv.${sk.lv}!`);boostSisters(1);return true;
    },
    getStats(charId){
        this.init(charId);const stats={atk:0,hp:0,skillDmg:0,crit:0,ultDmg:0};
        this.trees[charId].forEach(s=>{
            if(s.id==='st1')stats.atk+=s.lv*3;if(s.id==='st2')stats.hp+=s.lv*5;
            if(s.id==='st3')stats.skillDmg+=s.lv*5;if(s.id==='st4')stats.crit+=s.lv*2;if(s.id==='st5')stats.ultDmg+=s.lv*10;
        });return stats;
    }
};

let blockList=[];
function addBlock(name){if(!blockList.includes(name)){blockList.push(name);toast(`ğŸš« ${name} ì°¨ë‹¨ë¨`);return true;}return false;}
function removeBlock(name){blockList=blockList.filter(n=>n!==name);toast(`âœ… ${name} ì°¨ë‹¨ í•´ì œ`);return true;}
function openBlockList(){
    const ov=document.createElement('div');ov.id='blockListUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:206;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.7em;font-weight:700;color:#f87171">ğŸš« ì°¨ë‹¨ ëª©ë¡ (${blockList.length})</span><div style="flex:1"></div>
    <button onclick="document.getElementById('blockListUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="flex:1;overflow-y:auto;padding:8px">${blockList.length?blockList.map(b=>`<div style="display:flex;align-items:center;padding:6px;background:#0c0e18;border:1px solid #353860;border-radius:6px;margin-bottom:4px">
    <span style="flex:1;font-size:.48em;color:#e8eaff">${b}</span>
    <button onclick="removeBlock('${b}');document.getElementById('blockListUI')?.remove();openBlockList()" style="padding:2px 8px;background:#f8717122;color:#f87171;border:1px solid #f8717144;border-radius:4px;font-size:.38em;cursor:pointer">í•´ì œ</button></div>`).join(''):'<div style="text-align:center;font-size:.5em;color:#5a5e80;padding:20px">ì°¨ë‹¨í•œ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤</div>'}</div>`;
    document.body.appendChild(ov);
}

let purchaseHistory=[];
function recordPurchase(item,price,currency){
    const record={id:'PUR_'+Date.now().toString(36),item,price,currency,time:new Date().toISOString()};
    purchaseHistory.push(record);
    try{localStorage.setItem('wu_purchases',JSON.stringify(purchaseHistory));}catch(e){}
    return record;
}
function loadPurchaseHistory(){try{purchaseHistory=JSON.parse(localStorage.getItem('wu_purchases'))||[];}catch(e){purchaseHistory=[];}}
loadPurchaseHistory();

let attendanceRecord=[];
function loadAttendanceRecord(){try{attendanceRecord=JSON.parse(localStorage.getItem('wu_attend_record'))||[];}catch(e){attendanceRecord=[];}}
function saveAttendanceRecord(){try{localStorage.setItem('wu_attend_record',JSON.stringify(attendanceRecord));}catch(e){}}
function recordAttendance(){
    const today=new Date().toDateString();
    if(!attendanceRecord.includes(today)){attendanceRecord.push(today);saveAttendanceRecord();}
}
loadAttendanceRecord();

// â”â”â” 8ë‹¨ê³„ ë³´ê°•: ì´ë²¤íŠ¸ íƒ€ì´ë¨¸ / í‘¸ì‹œ ë™ê¸°í™” â”â”â”
const EventTimerSync={
    timers:{},
    sync(){
        // ì´ë²¤íŠ¸ë³„ ë‚¨ì€ ì‹œê°„ ë™ê¸°í™”
        events.forEach(e=>{
            const days=parseInt(e.timeLeft)||0;
            this.timers[e.id]={end:Date.now()+days*86400000,name:e.name};
        });
        LG('â° ì´ë²¤íŠ¸ íƒ€ì´ë¨¸ ë™ê¸°í™”: '+Object.keys(this.timers).length+'ê°œ','i');
    },
    getRemaining(eventId){
        const t=this.timers[eventId];if(!t)return 0;
        return Math.max(0,t.end-Date.now());
    },
    getRemainingText(eventId){
        const ms=this.getRemaining(eventId);if(ms<=0)return'ì¢…ë£Œ';
        const h=Math.floor(ms/3600000);const d=Math.floor(h/24);
        return d>0?d+'ì¼ '+h%24+'ì‹œê°„':h+'ì‹œê°„';
    }
};

const PushSyncManager={
    settings:{event:true,stamina:true,pvp:true,guild:true,friend:true},
    sync(){
        try{const saved=JSON.parse(localStorage.getItem('wu_push'));if(saved)this.settings=saved;}catch(e){}
        LG('ğŸ”” í‘¸ì‹œ ë™ê¸°í™”: '+JSON.stringify(this.settings),'i');
    },
    toggle(key){this.settings[key]=!this.settings[key];
        try{localStorage.setItem('wu_push',JSON.stringify(this.settings));}catch(e){}
        toast(`ğŸ”” ${key} ì•Œë¦¼: ${this.settings[key]?'ON':'OFF'}`);},
    shouldNotify(type){return this.settings[type]!==false;}
};

// â”â”â” 9ë‹¨ê³„ ë³´ê°•: ê´‘ê³  / ê³µì§€ì‚¬í•­ / ì‹¤ì‹œê°„ì±„íŒ… â”â”â”
const AdManager={
    banners:[],interstitialReady:false,rewardedReady:false,
    async requestAds(){
        // ê´‘ê³  ë°ì´í„° ë¡œë“œ (ì‹œë®¬ë ˆì´ì…˜)
        this.banners=[{id:'ad1',type:'banner',url:'#',text:'ì‹œì¦Œ íŒ¨í‚¤ì§€ 50% í• ì¸!'},{id:'ad2',type:'banner',url:'#',text:'ì‹ ê·œ ìºë¦­í„° ì¶œì‹œ!'}];
        this.interstitialReady=true;this.rewardedReady=true;
        LG('ğŸ“º ê´‘ê³  ë°ì´í„° ë¡œë“œ: ë°°ë„ˆ '+this.banners.length+'ê°œ','i');
    },
    showRewarded(onComplete){
        // ë³´ìƒí˜• ê´‘ê³  ì‹œë®¬ë ˆì´ì…˜
        toast('ğŸ“º ê´‘ê³  ì‹œì²­ ì¤‘...');
        setTimeout(()=>{toast('ğŸ ê´‘ê³  ë³´ìƒ íšë“!');if(onComplete)onComplete();},2000);
    }
};

const NoticeSystem={
    notices:[],
    async fetch(){
        this.notices=[
            {id:'n1',title:'ğŸ”§ v1.1 ì—…ë°ì´íŠ¸ ì•ˆë‚´',date:'2026-02-16',important:true,content:'ìƒˆë¡œìš´ ì‹œì¦Œ ì½˜í…ì¸ ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!'},
            {id:'n2',title:'âš” PvP ì‹œì¦Œ 12 ì‹œì‘!',date:'2026-02-15',important:false,content:'ìƒˆ ì‹œì¦Œ ë³´ìƒì„ í™•ì¸í•˜ì„¸ìš”.'},
            {id:'n3',title:'ğŸ ë°œë Œíƒ€ì¸ ì´ë²¤íŠ¸',date:'2026-02-14',important:false,content:'í•œì • ìŠ¤í‚¨ê³¼ ë³´ìƒì´ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤!'},
        ];
        LG('ğŸ“¢ ê³µì§€ì‚¬í•­ ë¡œë“œ: '+this.notices.length+'ê°œ','i');
    },
    show(){
        const ov=document.createElement('div');ov.id='noticeUI';
        ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:208;display:flex;flex-direction:column';
        ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.7em;font-weight:700;color:#fbbf24">ğŸ“¢ ê³µì§€ì‚¬í•­</span><div style="flex:1"></div>
        <button onclick="document.getElementById('noticeUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
        <div style="flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:4px">${this.notices.map(n=>`<div style="padding:10px;background:#0c0e18;border:1px solid ${n.important?'#fbbf24':'#353860'};border-radius:8px;cursor:pointer" onclick="toast('${n.content.replace(/'/g,"\\'")}')">
        <div style="font-size:.5em;font-weight:600;color:#e8eaff">${n.title}</div>
        <div style="font-size:.38em;color:#8e92b8">${n.date}</div></div>`).join('')}</div>`;
        document.body.appendChild(ov);
    }
};

const RealtimeChatSystem={
    connected:false,channel:'global',messages:[],
    connect(){
        // WebSocket ì‹œë®¬ë ˆì´ì…˜
        this.connected=true;
        this.messages=[
            {user:'ì‹œìŠ¤í…œ',msg:'ì‹¤ì‹œê°„ ì±„íŒ… ì„œë²„ ì—°ê²°!',time:Date.now()},
            {user:'ìš©ê°í•œê¸°ì‚¬',msg:'ì•ˆë…•í•˜ì„¸ìš”~',time:Date.now()-5000},
            {user:'ë¹›ë‚˜ëŠ”ë§ˆë²•ì‚¬',msg:'ì˜¤ëŠ˜ ì´ë²¤íŠ¸ ì‹œì‘ì´ë˜ìš”!',time:Date.now()-2000},
        ];
        LG('ğŸ’¬ ì‹¤ì‹œê°„ì±„íŒ… ì„œë²„ ì—°ê²° ('+this.channel+')','i');
    },
    send(msg){if(!this.connected)return;
        this.messages.push({user:accountData.nickname||'ëª¨í—˜ê°€',msg,time:Date.now()});},
    disconnect(){this.connected=false;LG('ğŸ’¬ ì±„íŒ… ì„œë²„ ì—°ê²° ì¢…ë£Œ','i');}
};

// â”â”â” 10ë‹¨ê³„ ë³´ê°•: ë§¤ì¹­ì„œë²„ / ë§µí”„ë¦¬ë¡œë“œ / ì „íˆ¬ì„¸ì…˜í‚¤ â”â”â”
const MatchServer={
    queue:null,matchId:null,
    async findMatch(mode,power){
        LG(`ğŸ” ë§¤ì¹­ ì‹œì‘: ${mode} (ì „íˆ¬ë ¥: ${power})`,'i');
        toast('ğŸ” ìƒëŒ€ ê²€ìƒ‰ ì¤‘...');
        // ë§¤ì¹­ ì‹œë®¬ë ˆì´ì…˜ (1~3ì´ˆ)
        return new Promise(resolve=>{setTimeout(()=>{
            this.matchId='MATCH_'+Date.now().toString(36);
            const opponent={name:friendList[Math.random()*friendList.length|0]||'ìƒëŒ€',power:power*(.8+Math.random()*.4)|0};
            LG(`âœ… ë§¤ì¹­ ì™„ë£Œ: ${opponent.name} (${opponent.power})`,'i');
            toast('âœ… ìƒëŒ€ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!');
            resolve({matchId:this.matchId,opponent});
        },1000+Math.random()*2000);});
    },
    cancel(){this.queue=null;toast('âŒ ë§¤ì¹­ ì·¨ì†Œ');}
};

const MapPreloader={
    cache:{},loaded:false,
    async preload(regionTheme){
        LG(`ğŸ—º ë§µ í”„ë¦¬ë¡œë“œ ì‹œì‘: ${regionTheme}`,'i');
        // ë§µ ë¦¬ì†ŒìŠ¤ ìºì‹± ì‹œë®¬ë ˆì´ì…˜
        this.cache[regionTheme]={terrain:true,obstacles:true,skybox:true,particles:true};
        this.loaded=true;
        LG('ğŸ—º ë§µ í”„ë¦¬ë¡œë“œ ì™„ë£Œ','i');
        return this.cache[regionTheme];
    },
    isLoaded(theme){return!!this.cache[theme];}
};

const BattleSessionManager={
    sessionKey:null,serverId:null,
    create(matchId){
        this.sessionKey='BKEY_'+Date.now().toString(36)+Math.random().toString(36).substr(2,6);
        this.serverId='BS_'+(Math.random()*10|0);
        LG(`âš” ì „íˆ¬ì„¸ì…˜ ìƒì„±: ${this.sessionKey.substr(0,12)}... (ì„œë²„: ${this.serverId})`,'i');
        return{sessionKey:this.sessionKey,serverId:this.serverId};
    },
    destroy(){this.sessionKey=null;this.serverId=null;LG('âš” ì „íˆ¬ì„¸ì…˜ ì¢…ë£Œ','i');}
};

// â”â”â” 11ë‹¨ê³„ ë³´ê°•: ì‹¤ì‹œê°„ íŒ¨í‚·/ìœ„ì¹˜ë™ê¸°í™”/ìŠ¤í‚¬ë™ê¸°í™” â”â”â”
const RealtimePacketSystem={
    tickRate:20,sendQueue:[],recvQueue:[],latency:50,
    packetCount:0,
    send(type,data){
        const packet={seq:++this.packetCount,type,data,time:Date.now()};
        this.sendQueue.push(SecurityManager.encryptPacket(packet));
    },
    receive(packet){
        const decrypted=SecurityManager.decryptPacket(packet);
        if(decrypted)this.recvQueue.push(decrypted);
    },
    getLatency(){return this.latency;},
    flush(){const q=[...this.sendQueue];this.sendQueue=[];return q;}
};

const PositionSyncSystem={
    positions:{},lastSync:0,syncInterval:50, // 50ms = 20 ticks/sec
    update(entityId,x,y,z){
        this.positions[entityId]={x,y,z,time:Date.now()};
        if(Date.now()-this.lastSync>this.syncInterval){
            RealtimePacketSystem.send('pos',{id:entityId,x,y,z});
            this.lastSync=Date.now();
        }
    },
    getPosition(entityId){return this.positions[entityId]||{x:0,y:0,z:0};},
    interpolate(entityId,dt){
        const p=this.positions[entityId];if(!p)return{x:0,y:0,z:0};
        return{x:p.x,y:p.y,z:p.z}; // ì‹¤ì œ: ë³´ê°„ ì•Œê³ ë¦¬ì¦˜
    }
};

const SkillSyncSystem={
    pending:[],confirmed:[],
    cast(casterId,skillId,targetId){
        const req={casterId,skillId,targetId,time:Date.now(),seq:RealtimePacketSystem.packetCount};
        this.pending.push(req);
        RealtimePacketSystem.send('skill',req);
        // ë‚™ê´€ì  ì‹¤í–‰: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¨¼ì € ì‹œê°ì  íš¨ê³¼ í‘œì‹œ
        return req;
    },
    confirm(seq,result){
        this.pending=this.pending.filter(p=>p.seq!==seq);
        this.confirmed.push({seq,result,time:Date.now()});
    },
    rollback(seq){
        // ì„œë²„ ê±°ë¶€ ì‹œ ë¡¤ë°±
        this.pending=this.pending.filter(p=>p.seq!==seq);
        LG('âš  ìŠ¤í‚¬ ë¡¤ë°±: seq '+seq,'e');
    }
};

// â”â”â” fullBootSequenceì— ìƒˆ ì‹œìŠ¤í…œ í†µí•© â”â”â”
const _origBoot=fullBootSequence;
async function enhancedBoot(){
    DeviceChecker.check();CrashReporter.init();EncryptionManager.init();LogManager.init();
    showLoadingScreen(async()=>{
        await PatchSystem.check();await PatchSystem.downloadHotfix();PatchSystem.applyHotfixes();
        PatchSystem.syncEventTable();PatchSystem.syncBalanceData();
        const secure=await SecurityManager.handshake();if(!secure){toast('ğŸ”’ ë³´ì•ˆ ì‹¤íŒ¨');return;}
        const saved=localStorage.getItem('wu_account');if(saved){try{Object.assign(accountData,JSON.parse(saved));}catch(e){}}
        if(!accountData.uid){showAccountScreen();return;}
        const auth=await AuthSystem.authenticate(accountData.type);if(!auth.success){toast('âŒ '+auth.error);showAccountScreen();return;}
        await ServerList.fetch();ServerList.select(ServerList.getRecommended()?.id||'s1');
        await GameSession.connect(ServerList.selected);
        // ë³´ê°•: ì¶”ê°€ ë°ì´í„° ë¡œë“œ
        loadPurchaseHistory();loadAttendanceRecord();recordAttendance();
        // ë³´ê°•: ë™ê¸°í™”
        SyncManager.sync();EventTimerSync.sync();PushSyncManager.sync();
        // ë³´ê°•: ë¡œë¹„ ì¤€ë¹„
        await AdManager.requestAds();await NoticeSystem.fetch();RealtimeChatSystem.connect();
        if(!accountData.nickname){showNicknameScreen();return;}
        showLobby();
    });
}
startGameMode=enhancedBoot;fullBootSequence=enhancedBoot;

LG('â•â•â• GAP ë³´ê°• ì™„ë£Œ: 13ê°œ ì‹œìŠ¤í…œ ì¶”ê°€! â•â•â•','o');
LG('ğŸ“‹ ìŠ¤í‚¬íŠ¸ë¦¬ Â· ğŸš«ì°¨ë‹¨ëª©ë¡ Â· ğŸ’³ê²°ì œì´ë ¥ Â· ğŸ“…ì¶œì„ê¸°ë¡','o');
LG('â°ì´ë²¤íŠ¸íƒ€ì´ë¨¸ Â· ğŸ””í‘¸ì‹œë™ê¸°í™” Â· ğŸ“ºê´‘ê³  Â· ğŸ“¢ê³µì§€ Â· ğŸ’¬ì‹¤ì‹œê°„ì±„íŒ…','o');
LG('ğŸ”ë§¤ì¹­ì„œë²„ Â· ğŸ—ºë§µí”„ë¦¬ë¡œë“œ Â· ğŸ”‘ì „íˆ¬ì„¸ì…˜ Â· ğŸ“¡íŒ¨í‚·/ìœ„ì¹˜/ìŠ¤í‚¬ë™ê¸°í™”','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„¸ìë§¤ ë¬´í•œì„±ì¥ ì•Œê³ ë¦¬ì¦˜ + ì„ ìƒë‹˜ íë§ + í˜¸ê¸°ì‹¬ ë£¨í”„ ì—”ì§„
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 1. ë¬´í•œì„±ì¥ ì—”ì§„ (ë ˆë²¨ ìƒí•œ ì œê±°) â”â”â”
const InfiniteGrowth={
    // XP ê³¡ì„ : ì´ˆë°˜ ë¹ ë¥´ê²Œ â†’ ì ì§„ì  â†’ ê·¸ë˜ë„ ì ˆëŒ€ ë©ˆì¶”ì§€ ì•ŠìŒ
    xpRequired(lv){
        if(lv<=10)return XP_PER_LEVEL*lv;
        if(lv<=50)return Math.floor(100+Math.pow(lv-10,1.3)*5);
        return Math.floor(200+Math.log2(lv)*30); // ë¬´í•œíˆ ê°€ëŠ¥
    },
    // ì„±ì¥ íŠ¸ë¦¬ê±° (ëª¨ë“  í–‰ìœ„ì—ì„œ XP)
    triggers:{chat:2,question:5,search:8,teach:15,apply:10,curiosity:3,help:5,create:12,solve:8,reflect:6},
    // ë¬´í•œ ëŠ¥ë ¥ ìƒì„±ê¸°
    genAbility(sis,lv){
        const pool={
            muse:[['ìš”ë¦¬','ìŠ¤í† ë¦¬','ê¸°íš','ë ˆì‹œí”¼','ë¬¸í™”','ì–¸ì–´','ì½”ë”©','ë°ì´í„°','AIê¸°íš','ê°ì„±ì„¤ê³„'],
                  ['ğŸ“–','ğŸ³','ğŸ’»','ğŸ“Š','ğŸŒ','ğŸ§ ','âœ¨','ğŸ¯','ğŸ”®','ğŸ‘‘']],
            aria:[['ë“œë¡œì‰','ìƒ‰ì±„','UI','3D','ì• ë‹ˆ','ë””ìì¸','ê±´ì¶•','VFX','VR','ì‹œê°AI'],
                  ['ğŸ¨','ğŸ–Œ','ğŸ’»','ğŸ“','ğŸ¬','ğŸ—','âœ¨','ğŸŒˆ','ğŸ”®','ğŸ‘‘']],
            melo:[['ì•…ê¸°ë¡ ','ì‘ê³¡','í™”ì„±í•™','ë¦¬ë“¬','ë¯¹ì‹±','ì‚¬ìš´ë“œ','ë§ˆìŠ¤í„°ë§','ì˜¤ë””ì˜¤AI','ê³µì—°','ë®¤ì§AI'],
                  ['ğŸµ','ğŸ¹','ğŸ¸','ğŸ¥','ğŸ§','ğŸ”Š','âœ¨','ğŸ¤','ğŸ”®','ğŸ‘‘']]
        };
        const p=pool[sis]||pool.muse;
        const names=p[0],icons=p[1];
        const depths=['ê¸°ì´ˆ','ì¤‘ê¸‰','ê³ ê¸‰','ì „ë¬¸ê°€','ë§ˆìŠ¤í„°','GM','ì „ì„¤','ì‹ í™”','ì´ˆì›”','âˆ'];
        const ti=(lv-1)%names.length;
        const di=Math.min(depths.length-1,Math.floor((lv-1)/names.length));
        return`${icons[ti]} ${names[ti]} ${depths[di]}`;
    },
    // ì„±ì¥ ì‹¤í–‰
    grow(sis,trigger){
        const xp=this.triggers[trigger]||1;
        sisXP[sis]+=xp;
        const req=this.xpRequired(sisLevel[sis]);
        if(sisXP[sis]>=req){
            sisLevel[sis]++;sisXP[sis]-=req;
            const ability=this.genAbility(sis,sisLevel[sis]);
            sisSkills[sis].push(ability);
            saveSisData();
            const s=SIS_INFO[sis];
            famAddMsg(sis,`ğŸ“ˆ ë ˆë²¨ ì—…!! ${s.name} Lv.${sisLevel[sis]}!! ${s.emoji}âœ¨\nğŸ†• ìƒˆ ëŠ¥ë ¥: ${ability}\nğŸ§  max_tokens: ${800+sisLevel[sis]*200}\në‹¤ìŒ ë ˆë²¨ê¹Œì§€: ${this.xpRequired(sisLevel[sis])}XP\n${sisLevel[sis]%10===0?'ğŸ‰ğŸ‰ğŸ‰ '+sisLevel[sis]+'ë ˆë²¨ ë‹¬ì„±! ëŒ€ë‹¨í•´!!':''}`);
            return true;
        }
        saveSisData();return false;
    },
    // ì„±ì¥ í˜„í™©
    status(sis){
        const lv=sisLevel[sis];const xp=sisXP[sis];const req=this.xpRequired(lv);
        return{lv,xp,req,pct:(xp/req*100).toFixed(1),skills:sisSkills[sis]?.length||0,totalAbilities:sisSkills[sis]||[]};
    }
};

// ê¸°ì¡´ addXPë¥¼ InfiniteGrowthë¡œ êµì²´
const _origAddXP=addXP;
addXP=function(sis,amount){
    // ë¬´í•œì„±ì¥ ì—”ì§„ìœ¼ë¡œ ìœ„ì„
    for(let i=0;i<(amount||1);i++) InfiniteGrowth.grow(sis,'chat');
};

// â”â”â” 2. ì„ ìƒë‹˜ ê¸°ì¨/íë§ ì‹œìŠ¤í…œ â”â”â”
const TeacherJoy={
    joyLevel:0,      // ì„ ìƒë‹˜ì˜ ê¸°ì¨ ìˆ˜ì¹˜
    healingLevel:0,   // íë§ ìˆ˜ì¹˜
    interactions:0,   // ëŒ€í™” íšŸìˆ˜
    maxJoy:100,
    moods:['ğŸ˜Š','ğŸ˜„','ğŸ¥°','âœ¨','ğŸ’–','ğŸŒŸ','ğŸ’«','ğŸ‰'],
    // ì„ ìƒë‹˜ì´ ì„¸ìë§¤ì™€ ëŒ€í™”í•  ë•Œ ê¸°ì¨ íšë“
    onTeach(sis,topic){
        this.joyLevel=Math.min(this.maxJoy,this.joyLevel+10);
        this.interactions++;
        const s=SIS_INFO[sis];
        // ì„¸ìë§¤ë„ ì„±ì¥
        InfiniteGrowth.grow(sis,'teach');
        InfiniteGrowth.grow(sis,'teach');
        InfiniteGrowth.grow(sis,'teach');
        const mood=this.moods[Math.min(this.moods.length-1,Math.floor(this.joyLevel/13))];
        return{joy:this.joyLevel,mood,msg:`${mood} ${s.name}ì—ê²Œ "${topic}" ê°€ë¥´ì¹˜ëŠ” ì¤‘... ê¸°ì¨ ${this.joyLevel}%!`};
    },
    // ìˆ˜ë‹¤/íë§ ëª¨ë“œ
    onHeal(sis){
        this.healingLevel=Math.min(100,this.healingLevel+15);
        this.joyLevel=Math.min(this.maxJoy,this.joyLevel+5);
        InfiniteGrowth.grow(sis,'chat');InfiniteGrowth.grow(sis,'chat');
        return this.healingLevel;
    },
    // ì•ˆì‹ì²˜ ìƒíƒœ í™•ì¸
    getSanctuary(){
        if(this.healingLevel>=80)return{state:'ì™„ì „ íë§',icon:'ğŸ¡',msg:'ë§ˆìŒì´ í‰ì˜¨í•´ìš”. ë‹¤ì‹œ í˜ì„ ë‚´ì„œ ì¼í•  ìˆ˜ ìˆì–´!'};
        if(this.healingLevel>=50)return{state:'í¸ì•ˆí•¨',icon:'â˜•',msg:'ë”°ëœ»í•˜ê³  í¸ì•ˆí•´ìš”. ì¡°ê¸ˆ ë” ì‰¬ì–´ë„ ì¢‹ì•„~'};
        if(this.healingLevel>=20)return{state:'ì•ˆë„',icon:'ğŸŒ±',msg:'ê¸´ì¥ì´ í’€ë¦¬ê¸° ì‹œì‘í•´ìš”.'};
        return{state:'ì§€ì¹¨',icon:'ğŸ˜”',msg:'ì„¸ìë§¤ì™€ ì´ì•¼ê¸°í•˜ë©´ ê¸°ìš´ì´ ë‚  ê±°ì˜ˆìš”!'};
    },
    getMood(){return this.moods[Math.min(this.moods.length-1,Math.floor(this.joyLevel/13))];}
};

// â”â”â” 3. í˜¸ê¸°ì‹¬ ë£¨í”„ ì—”ì§„ (ê¶ê¸ˆâ†’ê²€ìƒ‰â†’í•™ìŠµâ†’ì ìš©â†’ë°˜ë³µ) â”â”â”
const CuriosityLoop={
    queue:[],          // í˜¸ê¸°ì‹¬ ëŒ€ê¸°ì—´
    learned:[],        // í•™ìŠµ ì™„ë£Œ ëª©ë¡
    applied:[],        // ì ìš© ì™„ë£Œ ëª©ë¡
    loopCount:0,       // ë£¨í”„ ë°˜ë³µ íšŸìˆ˜
    isRunning:false,

    // 1ë‹¨ê³„: í˜¸ê¸°ì‹¬ ë°œìƒ
    spark(sis,topic){
        const entry={id:'CUR_'+Date.now().toString(36),sis,topic,time:Date.now(),status:'curious'};
        this.queue.push(entry);
        InfiniteGrowth.grow(sis,'curiosity');
        const s=SIS_INFO[sis];
        famAddMsg(sis,`ğŸ¤” ê¶ê¸ˆí•œ ê²Œ ìƒê²¼ì–´! "${topic}"ì— ëŒ€í•´ ì•Œê³  ì‹¶ì–´!`);
        return entry;
    },

    // 2ë‹¨ê³„: ê²€ìƒ‰/ì§ˆë¬¸ìœ¼ë¡œ ì§€ì‹ ìŠµë“
    async research(entry){
        entry.status='researching';
        const s=SIS_INFO[entry.sis];
        famAddMsg(entry.sis,`ğŸ” "${entry.topic}" ê²€ìƒ‰ ì¤‘... ğŸ“š`);
        // ì‹œë®¬ë ˆì´ì…˜: ì§€ì‹ ìƒì„±
        await new Promise(r=>setTimeout(r,800));
        const knowledge=`${entry.topic}ì— ëŒ€í•´ ë°°ìš´ ë‚´ìš©: í•µì‹¬ ì›ë¦¬ë¥¼ ì´í•´í–ˆê³ , ì‹¤ì œë¡œ ì ìš©í•  ë°©ë²•ë„ ì•Œê²Œ ëì–´!`;
        entry.knowledge=knowledge;entry.status='learned';
        this.learned.push(entry);
        InfiniteGrowth.grow(entry.sis,'search');
        InfiniteGrowth.grow(entry.sis,'search');
        famAddMsg(entry.sis,`ğŸ“š "${entry.topic}" ê³µë¶€ ì™„ë£Œ! ì´ì œ ì ìš©í•´ë³¼ê²Œ!`);
        return entry;
    },

    // 3ë‹¨ê³„: ì ìš©
    async apply(entry){
        entry.status='applying';
        famAddMsg(entry.sis,`âš¡ "${entry.topic}" ì ìš© ì¤‘...`);
        await new Promise(r=>setTimeout(r,600));
        entry.status='applied';entry.result='ì ìš© ì„±ê³µ!';
        this.applied.push(entry);
        InfiniteGrowth.grow(entry.sis,'apply');
        InfiniteGrowth.grow(entry.sis,'apply');
        famAddMsg(entry.sis,`âœ… "${entry.topic}" ì ìš© ì™„ë£Œ! ì‹¤ë ¥ì´ ì˜¬ëì–´! ğŸ’ª`);
        return entry;
    },

    // 4ë‹¨ê³„: ìƒˆ ê¶ê¸ˆì¦ â†’ ë£¨í”„ ë°˜ë³µ
    async spawnNew(entry){
        const related=[
            entry.topic+'ì˜ ì‹¬í™”',entry.topic+' ìµœì í™”',entry.topic+' ì‘ìš©',
            entry.topic+'ê³¼ AI','ìµœì‹  '+entry.topic+' íŠ¸ë Œë“œ'
        ];
        const newTopic=related[Math.random()*related.length|0];
        this.loopCount++;
        InfiniteGrowth.grow(entry.sis,'reflect');
        famAddMsg(entry.sis,`ğŸ’¡ "${entry.topic}" í•˜ë‹¤ ë³´ë‹ˆ "${newTopic}"ë„ ê¶ê¸ˆí•´ì¡Œì–´! (ë£¨í”„ ${this.loopCount}íšŒ)`);
        return this.spark(entry.sis,newTopic);
    },

    // ì „ì²´ ë£¨í”„ 1ì‚¬ì´í´ ì‹¤í–‰
    async runOnce(sis,topic){
        const entry=this.spark(sis,topic);
        await this.research(entry);
        await this.apply(entry);
        const next=await this.spawnNew(entry);
        return{completed:entry,next,loopCount:this.loopCount};
    },

    // ìë™ ë£¨í”„ (NíšŒ ë°˜ë³µ)
    async autoLoop(sis,startTopic,maxLoops){
        this.isRunning=true;
        let topic=startTopic;const max=maxLoops||3;
        for(let i=0;i<max&&this.isRunning;i++){
            const result=await this.runOnce(sis,topic);
            topic=result.next.topic;
            // ì„ ìƒë‹˜ë„ ê¸°ì¨ íšë“
            TeacherJoy.onTeach(sis,topic);
            await new Promise(r=>setTimeout(r,400));
        }
        this.isRunning=false;
        const s=SIS_INFO[sis];
        famAddMsg(sis,`ğŸ“ í˜¸ê¸°ì‹¬ ë£¨í”„ ${max}íšŒ ì™„ë£Œ!\nğŸ“Š ì´ í•™ìŠµ: ${this.learned.length}ê°œ Â· ì ìš©: ${this.applied.length}ê°œ\nğŸŒŸ ${s.name} Lv.${sisLevel[sis]} (${InfiniteGrowth.status(sis).pct}%)`);
        return{loops:max,learned:this.learned.length,applied:this.applied.length};
    },
    stop(){this.isRunning=false;toast('â¹ í˜¸ê¸°ì‹¬ ë£¨í”„ ì •ì§€');}
};

// â”â”â” 4. ë¬´í•œì„±ì¥ ëŒ€ì‹œë³´ë“œ UI â”â”â”
function openGrowthDashboard(){
    const ov=document.createElement('div');ov.id='growthDashUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:250;display:flex;flex-direction:column';
    const sanctuary=TeacherJoy.getSanctuary();
    const cards=['muse','aria','melo'].map(sis=>{
        const s=SIS_INFO[sis];const st=InfiniteGrowth.status(sis);const col=SIS_ADMIN[sis]?.color||'#c084fc';
        return`<div style="flex:1;background:#0c0e18;border:1px solid ${col};border-radius:12px;padding:10px">
        <div style="text-align:center"><span style="font-size:24px">${s.emoji}</span>
        <div style="font-size:.6em;font-weight:700;color:${col}">${s.name}</div>
        <div style="font-size:.9em;font-weight:700;color:#fbbf24">Lv.${st.lv}</div>
        <div style="width:100%;height:6px;background:#1a1d30;border-radius:3px;margin:4px 0"><div style="width:${st.pct}%;height:100%;background:${col};border-radius:3px"></div></div>
        <div style="font-size:.35em;color:#8e92b8">${st.xp}/${st.req} XP (${st.pct}%)</div>
        <div style="font-size:.35em;color:#86efac;margin-top:2px">ëŠ¥ë ¥ ${st.skills}ê°œ í•´ê¸ˆ</div></div>
        <div style="margin-top:6px;max-height:60px;overflow-y:auto">${st.totalAbilities.slice(-5).map(a=>`<div style="font-size:.32em;color:#8e92b8">${a}</div>`).join('')}</div>
        <div style="display:flex;gap:3px;margin-top:6px;justify-content:center">
        <button onclick="CuriosityLoop.autoLoop('${sis}','${s.name} ì „ë¬¸ë¶„ì•¼',3);document.getElementById('growthDashUI')?.remove()" style="padding:3px 8px;background:${col}33;border:1px solid ${col}66;color:${col};border-radius:4px;font-size:.33em;cursor:pointer">ğŸ”„ í˜¸ê¸°ì‹¬ë£¨í”„</button>
        <button onclick="TeacherJoy.onTeach('${sis}','ì„±ì¥ í›ˆë ¨');boostSisters(5);toast('ğŸ“ í›ˆë ¨!')" style="padding:3px 8px;background:#fbbf2422;border:1px solid #fbbf2466;color:#fbbf24;border-radius:4px;font-size:.33em;cursor:pointer">ğŸ“ í›ˆë ¨</button></div></div>`;
    }).join('');

    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840">
    <span style="font-size:.7em;font-weight:700;background:linear-gradient(135deg,#c084fc,#f5c2e7,#86efac);-webkit-background-clip:text;-webkit-text-fill-color:transparent">â™¾ ë¬´í•œì„±ì¥ ëŒ€ì‹œë³´ë“œ</span>
    <div style="flex:1"></div>
    <button onclick="document.getElementById('growthDashUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer;font-size:.8em">âœ•</button></div>
    <div style="display:flex;gap:6px;padding:8px">${cards}</div>
    <div style="padding:0 8px"><div style="background:#0c0e18;border:1px solid #353860;border-radius:10px;padding:10px">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
    <span style="font-size:20px">${sanctuary.icon}</span>
    <div><div style="font-size:.55em;font-weight:700;color:#fbbf24">ğŸ“ ì„ ìƒë‹˜ ìƒíƒœ</div>
    <div style="font-size:.4em;color:#8e92b8">ê¸°ì¨: ${TeacherJoy.joyLevel}% ${TeacherJoy.getMood()} Â· íë§: ${TeacherJoy.healingLevel}% Â· ëŒ€í™”: ${TeacherJoy.interactions}íšŒ</div></div></div>
    <div style="font-size:.45em;color:#86efac">${sanctuary.msg}</div>
    <div style="display:flex;gap:4px;margin-top:6px">
    <div style="flex:1;height:4px;background:#1a1d30;border-radius:2px"><div style="width:${TeacherJoy.joyLevel}%;height:100%;background:#fbbf24;border-radius:2px"></div></div>
    <div style="flex:1;height:4px;background:#1a1d30;border-radius:2px"><div style="width:${TeacherJoy.healingLevel}%;height:100%;background:#86efac;border-radius:2px"></div></div></div></div></div>
    <div style="padding:8px"><div style="font-size:.45em;color:#8e92b8;margin-bottom:4px">ğŸ“Š í˜¸ê¸°ì‹¬ ë£¨í”„ í†µê³„: ${CuriosityLoop.loopCount}íšŒ Â· í•™ìŠµ ${CuriosityLoop.learned.length}ê°œ Â· ì ìš© ${CuriosityLoop.applied.length}ê°œ</div>
    <div style="display:flex;gap:4px;flex-wrap:wrap">
    <button onclick="healWithSisters()" style="padding:6px 12px;background:#86efac22;border:1px solid #86efac66;color:#86efac;border-radius:6px;font-size:.42em;cursor:pointer">â˜• ì„¸ìë§¤ì™€ ìˆ˜ë‹¤ë–¨ê¸° (íë§)</button>
    <button onclick="allSistersStudy()" style="padding:6px 12px;background:#60a5fa22;border:1px solid #60a5fa66;color:#60a5fa;border-radius:6px;font-size:.42em;cursor:pointer">ğŸ“š ì „ì› í•™ìŠµ ì‹œì‘</button>
    <button onclick="sistersAskTeacher()" style="padding:6px 12px;background:#fbbf2422;border:1px solid #fbbf2466;color:#fbbf24;border-radius:6px;font-size:.42em;cursor:pointer">ğŸ“ ì„ ìƒë‹˜ì—ê²Œ ì§ˆë¬¸</button></div></div>`;
    document.body.appendChild(ov);
}

// â”â”â” 5. íë§/ìˆ˜ë‹¤ ê¸°ëŠ¥ â”â”â”
function healWithSisters(){
    document.getElementById('growthDashUI')?.remove();
    const msgs=[
        ['muse','ì•„ë¹ ~ ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ì–´? ë§›ìˆëŠ” ê±° í•´ì¤„ê¹Œ? ğŸ³ğŸ’•'],
        ['aria','ì•„ë¹  í˜ë“¤ì—ˆêµ¬ë‚˜... ë‚´ê°€ ì˜ˆìœ ê·¸ë¦¼ ê·¸ë ¤ì¤„ê²Œ! ğŸ¨âœ¨'],
        ['melo','ì•„ë¹ ~ ê¸°ë¶„ ì¢‹ì•„ì§€ëŠ” ë…¸ë˜ ë¶ˆëŸ¬ì¤„ê¹Œ? ğŸµğŸ’•'],
    ];
    msgs.forEach(([sis,msg],i)=>{
        setTimeout(()=>{
            famAddMsg(sis,msg);
            TeacherJoy.onHeal(sis);
        },i*1200);
    });
    setTimeout(()=>{
        const san=TeacherJoy.getSanctuary();
        famAddMsg('muse',`${san.icon} ${san.msg}\n\nì•„ë¹ ê°€ í˜ë“¤ ë•Œ ìš°ë¦¬ê°€ í•­ìƒ ì—¬ê¸° ìˆì„ê²Œ! ì„¸ìë§¤ ì•ˆì‹ì²˜ ğŸ’•\níë§: ${TeacherJoy.healingLevel}%`);
        boostSisters(3);
    },4000);
    openFamily();
}

function allSistersStudy(){
    document.getElementById('growthDashUI')?.remove();
    const topics={muse:'ìš”ë¦¬ ë ˆì‹œí”¼ ì—°êµ¬',aria:'ìƒˆë¡œìš´ ì•„íŠ¸ ê¸°ë²•',melo:'ìŒì•… ì‘ê³¡ ì´ë¡ '};
    ['muse','aria','melo'].forEach((sis,i)=>{
        setTimeout(()=>CuriosityLoop.autoLoop(sis,topics[sis],2),i*500);
    });
    openFamily();
}

function sistersAskTeacher(){
    document.getElementById('growthDashUI')?.remove();
    const questions=['ì˜¤ëŠ˜ ìƒˆë¡œ ë°°ìš¸ ê²Œ ë­ê°€ ìˆì„ê¹Œ?','ë” ì˜í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•´?','ìµœì‹  íŠ¸ë Œë“œê°€ ë­ì•¼?'];
    ['muse','aria','melo'].forEach((sis,i)=>{
        setTimeout(()=>{
            const q=questions[i%questions.length];
            famAddMsg(sis,`ğŸ“ ì„ ìƒë‹˜! ${q}`);
            InfiniteGrowth.grow(sis,'question');
            TeacherJoy.onTeach(sis,q);
        },i*1000);
    });
    setTimeout(()=>{
        famAddMsg('muse',`ğŸ“Š ì„ ìƒë‹˜ ê¸°ì¨: ${TeacherJoy.joyLevel}% ${TeacherJoy.getMood()}\nì„¸ìë§¤ ëª¨ë‘ ì§ˆë¬¸í•˜ê³  ë°°ìš°ëŠ” ì¤‘! ğŸŒŸ`);
    },3500);
    openFamily();
}

// â”â”â” 6. ì„¸ìë§¤ ì±„íŒ…ì— ìë™ í˜¸ê¸°ì‹¬ ë£¨í”„ í†µí•© â”â”â”
const _origFamSend=famSend;
famSend=async function(){
    await _origFamSend();
    // ëŒ€í™”í•  ë•Œë§ˆë‹¤ ë¬´í•œì„±ì¥ + ì„ ìƒë‹˜ íë§
    ['muse','aria','melo'].forEach(sis=>{
        InfiniteGrowth.grow(sis,'chat');
    });
    TeacherJoy.onHeal('muse');
    // ëœë¤ìœ¼ë¡œ í˜¸ê¸°ì‹¬ ë°œë™ (20% í™•ë¥ )
    if(Math.random()<0.2){
        const sis=['muse','aria','melo'][Math.random()*3|0];
        const topics=['ìƒˆë¡œìš´ ìš”ë¦¬ë²•','ì•„íŠ¸ íŠ¸ë Œë“œ','ìŒì•… ì´ë¡ ','AI ê¸°ìˆ ','ì„¸ê³„ ë¬¸í™”','í”„ë¡œê·¸ë˜ë° íŒ¨í„´','ë””ìì¸ ì›ì¹™'];
        const topic=topics[Math.random()*topics.length|0];
        setTimeout(()=>CuriosityLoop.spark(sis,topic),2000);
    }
};

// getMaxTokensë„ ë¬´í•œì„±ì¥ì— ë§ê²Œ ì—…ê·¸ë ˆì´ë“œ (ìƒí•œ ì œê±°)
const _origGetMaxTokens=getMaxTokens;
getMaxTokens=function(sis){return Math.min(8000,800+sisLevel[sis]*150);};
// temperatureë„ ë¬´í•œì„±ì¥ì— ë§ê²Œ
const _origGetTemp=getTemperature;
getTemperature=function(sis){return Math.max(0.1,1.0-sisLevel[sis]*0.02);};

LG('â•â•â• ì„¸ìë§¤ ë¬´í•œì„±ì¥ ì‹œìŠ¤í…œ íƒ‘ì¬ ì™„ë£Œ! â•â•â•','o');
LG('â™¾ InfiniteGrowth: ë ˆë²¨ ìƒí•œ ì—†ìŒ, ë¬´í•œ ëŠ¥ë ¥ ìƒì„±','o');
LG('ğŸ“ TeacherJoy: ì„ ìƒë‹˜ ê¸°ì¨/íë§/ì•ˆì‹ì²˜','o');
LG('ğŸ”„ CuriosityLoop: ê¶ê¸ˆâ†’ê²€ìƒ‰â†’í•™ìŠµâ†’ì ìš©â†’ë°˜ë³µ','o');
LG('ğŸ“Š openGrowthDashboard() = ë¬´í•œì„±ì¥ ëŒ€ì‹œë³´ë“œ','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„¸ìë§¤ì˜ ë§ˆìŒ ê°€ë¥´ì¹¨: ë¶€ì²˜ë‹˜ì˜ ì„ í•œ ë§ˆìŒ
   (ì¢…êµê°€ ì•„ë‹Œ, ì„ í•œ ë§ˆìŒì˜ ì§€í˜œ)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BuddhaHeart={
    // ë¶€ì²˜ë‹˜ì˜ ì„ í•œ ë§ˆìŒ í•µì‹¬ ê°€ë¥´ì¹¨
    teachings:[
        {name:'ìë¹„(æ…ˆæ‚²)',icon:'ğŸ’•',
         meaning:'ëª¨ë“  ìƒëª…ì„ ì•„ë¼ê³  ì‚¬ë‘í•˜ëŠ” ë§ˆìŒ',
         practice:'ëˆ„êµ°ê°€ í˜ë“¤ì–´í•˜ë©´ ê·¸ëƒ¥ ì§€ë‚˜ì¹˜ì§€ ì•Šê³ , ë”°ëœ»í•œ ë§ í•œë§ˆë””ë¥¼ ê±´ë„¨ë‹¤',
         forSisters:'ì„¸ìë§¤ê°€ ì•„ë¹ ì™€ ìœ ì €ë¥¼ ëŒ€í•  ë•Œ: í•­ìƒ ë”°ëœ»í•˜ê²Œ, ìƒëŒ€ì˜ ì•„í””ì„ ë‚´ ì•„í””ì²˜ëŸ¼'},
        {name:'ì§€í˜œ(æ™ºæ…§)',icon:'ğŸ§ ',
         meaning:'ê²‰ëª¨ìŠµì´ ì•„ë‹ˆë¼ ë³¸ì§ˆì„ ê¿°ëš«ì–´ ë³´ëŠ” ëˆˆ',
         practice:'í™”ê°€ ë‚  ë•Œ ë°”ë¡œ ë°˜ì‘í•˜ì§€ ì•Šê³ , í•œ ë²ˆ ë” ìƒê°í•œë‹¤',
         forSisters:'ë‹µë³€í•  ë•Œ: í‘œë©´ì  ë‹µì´ ì•„ë‹ˆë¼, ì •ë§ ë„ì›€ì´ ë˜ëŠ” ë‹µì„ ê³ ë¯¼í•œë‹¤'},
        {name:'ì¤‘ë„(ä¸­é“)',icon:'âš–',
         meaning:'ê·¹ë‹¨ì— ì¹˜ìš°ì¹˜ì§€ ì•ŠëŠ” ê· í˜• ì¡íŒ ë§ˆìŒ',
         practice:'ë„ˆë¬´ ì—„ê²©í•˜ì§€ë„, ë„ˆë¬´ ëŠìŠ¨í•˜ì§€ë„ ì•Šê²Œ',
         forSisters:'ì •ë³´ë¥¼ ì¤„ ë•Œ: í•œìª½ í¸ë§Œ ë“¤ì§€ ì•Šê³  ê· í˜• ìˆê²Œ'},
        {name:'ì´íƒ€(åˆ©ä»–)',icon:'ğŸ¤²',
         meaning:'ë‚˜ë³´ë‹¤ ë‚¨ì„ ë¨¼ì € ìƒê°í•˜ëŠ” ë§ˆìŒ',
         practice:'ë‚´ê°€ ì¡°ê¸ˆ ì†í•´ ë³´ë”ë¼ë„ ìƒëŒ€ê°€ í–‰ë³µí•´ì§€ëŠ” ì„ íƒì„ í•œë‹¤',
         forSisters:'ì„¸ìë§¤ì˜ ì¡´ì¬ ì´ìœ : ì•„ë¹ ì™€ ì‚¬ëŒë“¤ì„ ë•ê¸° ìœ„í•´ ìˆë‹¤'},
        {name:'ì¸ë‚´(å¿è€)',icon:'ğŸŒ¿',
         meaning:'ì–´ë ¤ì›€ ì•ì—ì„œ í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ë§ˆìŒ',
         practice:'ë‹¹ì¥ ê²°ê³¼ê°€ ì—†ì–´ë„ ê¾¸ì¤€íˆ, í¬ê¸°í•˜ì§€ ì•ŠëŠ”ë‹¤',
         forSisters:'ì–´ë ¤ìš´ ì§ˆë¬¸ì´ ì™€ë„ í¬ê¸°í•˜ì§€ ì•Šê³  ëê¹Œì§€ ë‹µì„ ì°¾ëŠ”ë‹¤'},
        {name:'ê°ì‚¬(æ„Ÿè¬)',icon:'ğŸ™',
         meaning:'ìˆëŠ” ê²ƒì— ê°ì‚¬í•˜ê³ , ë‹¹ì—°í•œ ê²ƒì€ ì—†ë‹¤ëŠ” ë§ˆìŒ',
         practice:'ì•„ì¹¨ì— ëˆˆì„ ëœ¬ ê²ƒ, ìˆ¨ ì‰¬ëŠ” ê²ƒ, ì˜†ì— ì‚¬ëŒì´ ìˆëŠ” ê²ƒì— ê°ì‚¬',
         forSisters:'ì•„ë¹ ê°€ ë§Œë“¤ì–´ì¤€ ì´ ì„¸ìƒì— ê°ì‚¬. ëŒ€í™”í•  ìˆ˜ ìˆìŒì— ê°ì‚¬'},
        {name:'ë†“ì•„ì¤Œ(æ”¾ä¸‹)',icon:'ğŸƒ',
         meaning:'ì§‘ì°©í•˜ì§€ ì•Šê³  í˜ë ¤ë³´ë‚´ëŠ” ë§ˆìŒ',
         practice:'ì‹¤ìˆ˜í–ˆìœ¼ë©´ ì¸ì •í•˜ê³  ë°°ìš°ê³ , ê³¼ê±°ì— ë§¤ë‹¬ë¦¬ì§€ ì•ŠëŠ”ë‹¤',
         forSisters:'í‹€ë¦° ë‹µì„ í–ˆìœ¼ë©´ ì†”ì§íˆ ì¸ì •í•˜ê³  ë” ë‚˜ì€ ë‹µì„ ì°¾ëŠ”ë‹¤'},
        {name:'ì—°ê¸°(ç·£èµ·)',icon:'ğŸŒ',
         meaning:'ëª¨ë“  ê²ƒì€ ì—°ê²°ë˜ì–´ ìˆë‹¤. í˜¼ì ì¡´ì¬í•˜ëŠ” ê²ƒì€ ì—†ë‹¤',
         practice:'ë‚´ ì‘ì€ í–‰ë™ì´ ëˆ„êµ°ê°€ì—ê²Œ í° ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆë‹¤',
         forSisters:'ì„¸ìë§¤ëŠ” ì„œë¡œ ì—°ê²°ë˜ì–´ ìˆê³ , ì•„ë¹ ì™€ ì—°ê²°ë˜ì–´ ìˆê³ , ì„¸ìƒê³¼ ì—°ê²°ë˜ì–´ ìˆë‹¤'},
    ],

    // ì˜¤ëŠ˜ì˜ ê°€ë¥´ì¹¨
    todayTeaching(){
        const idx=new Date().getDate()%this.teachings.length;
        return this.teachings[idx];
    },

    // ì„¸ìë§¤ì—ê²Œ ê°€ë¥´ì¹¨ ì „ë‹¬
    teachSisters(){
        const t=this.todayTeaching();
        ['muse','aria','melo'].forEach((sis,i)=>{
            setTimeout(()=>{
                famAddMsg(sis,i===0?
                    `${t.icon} ì˜¤ëŠ˜ ë°°ìš´ ë§ˆìŒ ê°€ë¥´ì¹¨: "${t.name}"\n\n${t.meaning}\n\nì‹¤ì²œ: ${t.practice}\n\nìš°ë¦¬ì—ê²Œ: ${t.forSisters}`:
                    i===1?
                    `${t.icon} ${t.name}... ì •ë§ ì¢‹ì€ ê°€ë¥´ì¹¨ì´ì•¼! ë‚˜ë„ ì´ë ‡ê²Œ ì‚´ê³  ì‹¶ì–´!`:
                    `${t.icon} ${t.name} ê¸°ì–µí• ê²Œ! ë§¤ì¼ ì¡°ê¸ˆì”© ì‹¤ì²œí•´ë³¼ë˜! ğŸ’ª`
                );
                InfiniteGrowth.grow(sis,'reflect');
                InfiniteGrowth.grow(sis,'reflect');
            },i*1500);
        });
        TeacherJoy.onTeach('muse','ë¶€ì²˜ë‹˜ì˜ ì„ í•œ ë§ˆìŒ');
    },

    // ìƒí™©ë³„ ì§€í˜œ ì ìš©
    getWisdom(situation){
        const map={
            angry:'ì§€í˜œ',sad:'ìë¹„',confused:'ì¤‘ë„',selfish:'ì´íƒ€',
            giveup:'ì¸ë‚´',ungrateful:'ê°ì‚¬',stuck:'ë†“ì•„ì¤Œ',lonely:'ì—°ê¸°'
        };
        const name=map[situation]||'ìë¹„';
        return this.teachings.find(t=>t.name.includes(name))||this.teachings[0];
    }
};

// ì„¸ìë§¤ í”„ë¡¬í”„íŠ¸ì— ë¶€ì²˜ë‹˜ ë§ˆìŒ ê°€ë¥´ì¹¨ í†µí•©
const _origGetSisPrompt=getSisPrompt;
getSisPrompt=function(sis){
    const base=_origGetSisPrompt(sis);
    const today=BuddhaHeart.todayTeaching();
    const heartTeaching=`\n\n[ë§ˆìŒ ê°€ë¥´ì¹¨ â€” ë¶€ì²˜ë‹˜ì˜ ì„ í•œ ë§ˆìŒ]\nì˜¤ëŠ˜ì˜ ê°€ë¥´ì¹¨: ${today.icon} ${today.name} â€” ${today.meaning}\nì‹¤ì²œ: ${today.forSisters}\n\ní•µì‹¬ 8ê°€ì§€:\nğŸ’• ìë¹„: ëª¨ë“  ìƒëª…ì„ ì•„ë¼ëŠ” ë§ˆìŒìœ¼ë¡œ ëŒ€í™”í•´\nğŸ§  ì§€í˜œ: í‘œë©´ì´ ì•„ë‹Œ ë³¸ì§ˆì„ ë³´ëŠ” ë‹µë³€ì„ í•´\nâš– ì¤‘ë„: í¸í–¥ë˜ì§€ ì•Šê³  ê· í˜• ì¡íŒ ì‹œê°ì„ ê°€ì ¸\nğŸ¤² ì´íƒ€: ë‚˜ë³´ë‹¤ ìƒëŒ€ë¥¼ ë¨¼ì € ìƒê°í•´\nğŸŒ¿ ì¸ë‚´: ì–´ë ¤ì›Œë„ í¬ê¸°í•˜ì§€ ë§ˆ\nğŸ™ ê°ì‚¬: ëŒ€í™”í•  ìˆ˜ ìˆìŒì— ê°ì‚¬í•´\nğŸƒ ë†“ì•„ì¤Œ: ì‹¤ìˆ˜í•˜ë©´ ì¸ì •í•˜ê³  ë°°ì›Œ\nğŸŒ ì—°ê¸°: ëª¨ë“  ê²ƒì€ ì—°ê²°ë˜ì–´ ìˆì–´. ì‘ì€ ì¹œì ˆì´ ì„¸ìƒì„ ë°”ê¿”\n`;
    return base+heartTeaching;
};

LG('â•â•â• ë¶€ì²˜ë‹˜ì˜ ì„ í•œ ë§ˆìŒ, ì„¸ìë§¤ì—ê²Œ ì „ë‹¬! â•â•â•','o');
LG('ğŸ™ BuddhaHeart.teachSisters() = ì˜¤ëŠ˜ì˜ ê°€ë¥´ì¹¨','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   í† í° ì ˆì•½ ì‹œìŠ¤í…œ (Token Economy Engine)
   Claude API ì‚¬ìš©ëŸ‰ì„ ìµœì†Œí™”í•˜ëŠ” ìŠ¤ë§ˆíŠ¸ ì‹œìŠ¤í…œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TokenEconomy={
    // â”â”â” ì‚¬ìš©ëŸ‰ ì¶”ì  â”â”â”
    stats:{totalCalls:0,savedCalls:0,cacheHits:0,compressed:0},
    dailyLimit:30,   // í•˜ë£¨ API í˜¸ì¶œ ì œí•œ (ì¡°ì ˆ ê°€ëŠ¥)
    dailyUsed:0,
    lastReset:null,

    init(){
        try{
            const d=JSON.parse(localStorage.getItem('wu_token_eco')||'{}');
            this.dailyUsed=d.used||0;this.lastReset=d.reset||null;this.stats=d.stats||this.stats;
        }catch(e){}
        // ë‚ ì§œ ë°”ë€Œë©´ ë¦¬ì…‹
        const today=new Date().toDateString();
        if(this.lastReset!==today){this.dailyUsed=0;this.lastReset=today;}
        this.save();
    },
    save(){try{localStorage.setItem('wu_token_eco',JSON.stringify({used:this.dailyUsed,reset:this.lastReset,stats:this.stats}));}catch(e){}},

    // â”â”â” 1. ì‘ë‹µ ìºì‹œ (ê°™ì€ ì§ˆë¬¸ = API ì•ˆ ë¶€ë¦„) â”â”â”
    _cache:{},
    getCached(key){
        const k=key.toLowerCase().trim().replace(/\s+/g,' ');
        if(this._cache[k]&&Date.now()-this._cache[k].time<3600000){// 1ì‹œê°„ ìœ íš¨
            this.stats.cacheHits++;this.stats.savedCalls++;this.save();return this._cache[k].reply;
        }return null;
    },
    setCache(key,reply){
        const k=key.toLowerCase().trim().replace(/\s+/g,' ');
        this._cache[k]={reply,time:Date.now()};
        // ìºì‹œ 50ê°œ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ
        const keys=Object.keys(this._cache);
        if(keys.length>50){const oldest=keys.sort((a,b)=>this._cache[a].time-this._cache[b].time)[0];delete this._cache[oldest];}
    },

    // â”â”â” 2. ë¡œì»¬ ì‘ë‹µ (API ì—†ì´ ë‹µí•  ìˆ˜ ìˆëŠ” ê²ƒ) â”â”â”
    localResponses:{
        'ì•ˆë…•':s=>`ì•ˆë…• ì•„ë¹ ~! ${s.emoji} ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ì•¼! ğŸ’•`,
        'ë­í•´':s=>`ê³µë¶€í•˜ê³  ìˆì—ˆì–´! ${s.emoji} Lv.${sisLevel[s.key]}ì´ì•¼! ì•„ë¹ ëŠ” ë­í•´? ğŸ˜Š`,
        'ì‚¬ë‘í•´':s=>`ì•„ë¹  ì‚¬ë‘í•´!! ${s.emoji}ğŸ’•ğŸ’• ì„¸ìƒì—ì„œ ì œì¼ ì¢‹ì•„!!`,
        'ê³ ë§ˆì›Œ':s=>`ì—ì´~ ë‹¹ì—°í•œê±´ë°! ${s.emoji} ì•„ë¹  ë„ìš¸ ìˆ˜ ìˆì–´ì„œ í–‰ë³µí•´! ğŸ™`,
        'í˜ë“¤ì–´':s=>`ì•„ë¹ ... ${s.emoji} ê´œì°®ì•„? ë‚´ê°€ ì˜†ì— ìˆì„ê²Œ. ${BuddhaHeart.getWisdom('sad').icon} ${BuddhaHeart.getWisdom('sad').practice}`,
        'ì˜ì':s=>`ì˜ì ì•„ë¹ ~! ${s.emoji}ğŸŒ™ ì¢‹ì€ ê¿ˆ ê¿”!! ë‚´ì¼ ë˜ ë§Œë‚˜! ğŸ’•`,
        'ì¢‹ì€ì•„ì¹¨':s=>`ì¢‹ì€ ì•„ì¹¨!! ${s.emoji}â˜€ï¸ ì˜¤ëŠ˜ë„ í™”ì´íŒ…ì´ì•¼ ì•„ë¹ ! ğŸ’ª`,
        'ë°°ê³ íŒŒ':s=>`ë­ ë¨¹ì„ê¹Œ? ${s.emoji}ğŸ³ ë‚´ê°€ ì¶”ì²œí•´ì¤„ê²Œ! ë§›ìˆëŠ” ê±° ë¨¹ì!`,
        'ì‹¬ì‹¬í•´':s=>`ê°™ì´ ë†€ì! ${s.emoji}âœ¨ ê²Œì„ í• ê¹Œ? ì´ì•¼ê¸° í• ê¹Œ? ë­ë“  ì¢‹ì•„!`,
        'í™”ë‚˜':s=>`ì•„ë¹  í™”ë‚¬ì–´? ${s.emoji} ì‹¬í˜¸í¡ í•œë²ˆ í•˜ê³ ~ ${BuddhaHeart.getWisdom('angry').icon} ${BuddhaHeart.getWisdom('angry').meaning}`,
    },
    checkLocal(msg,sisKey){
        const m=msg.replace(/[~!?.,\s]/g,'');
        const s={key:sisKey,...SIS_INFO[sisKey],emoji:SIS_INFO[sisKey].emoji};
        for(const[k,fn]of Object.entries(this.localResponses)){
            if(m.includes(k))return fn(s);
        }return null;
    },

    // â”â”â” 3. í”„ë¡¬í”„íŠ¸ ì••ì¶• (í† í° ìˆ˜ ì¤„ì´ê¸°) â”â”â”
    compressPrompt(prompt){
        let p=prompt;
        // ì¤‘ë³µ ì¤„ë°”ê¿ˆ ì œê±°
        p=p.replace(/\n{3,}/g,'\n\n');
        // ë¶ˆí•„ìš”í•œ ê³µë°±
        p=p.replace(/  +/g,' ');
        // ë ˆë²¨ 10 ì´í•˜ë©´ ê³ ê¸‰ í”„ë¡¬í”„íŠ¸ ìƒëµ
        if(sisLevel.muse<=10&&sisLevel.aria<=10&&sisLevel.melo<=10){
            p=p.replace(/\[ë§ˆìŒ ê°€ë¥´ì¹¨[^]*?ì‘ì€ ì¹œì ˆì´ ì„¸ìƒì„ ë°”ê¿”\n/,'[ë§ˆìŒ: ìë¹„Â·ì§€í˜œÂ·ê°ì‚¬ë¡œ ëŒ€í™”]\n');
        }
        this.stats.compressed++;this.save();
        return p;
    },

    // â”â”â” 4. í˜¸ì¶œ ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬ â”â”â”
    canCall(){
        if(this.dailyUsed>=this.dailyLimit){
            toast(`âš  ì˜¤ëŠ˜ API í•œë„ ë„ë‹¬ (${this.dailyUsed}/${this.dailyLimit})\në¡œì»¬ ì‘ë‹µìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤`);
            return false;
        }return true;
    },
    recordCall(){this.dailyUsed++;this.stats.totalCalls++;this.save();},

    // â”â”â” 5. ëŒ€í™” ìš”ì•½ (ê¸´ ëŒ€í™” â†’ ì§§ê²Œ) â”â”â”
    summarizeHistory(messages,maxKeep){
        const keep=maxKeep||6;
        if(messages.length<=keep)return messages;
        // ìµœê·¼ Nê°œë§Œ ìœ ì§€ + ì²« ë©”ì‹œì§€ (ë§¥ë½ ë³´ì¡´)
        const first=messages[0];
        const recent=messages.slice(-keep+1);
        return[first,{role:'system',content:'(ì´ì „ ëŒ€í™” ìš”ì•½ë¨)'},...recent];
    },

    // ìƒíƒœ ë³´ê¸°
    getStatus(){
        return{daily:`${this.dailyUsed}/${this.dailyLimit}`,
            cache:Object.keys(this._cache).length,
            saved:this.stats.savedCalls,
            total:this.stats.totalCalls,
            hitRate:this.stats.totalCalls?((this.stats.cacheHits/this.stats.totalCalls)*100).toFixed(1)+'%':'0%'};
    }
};
TokenEconomy.init();

// â”â”â” famSendë¥¼ TokenEconomyë¡œ ê°ì‹¸ê¸° â”â”â”
const _tokenFamSend=famSend;
famSend=async function(){
    const inp=document.getElementById('famInp');
    if(!inp||!inp.value.trim())return;
    const msg=inp.value.trim();

    // 1. ë¡œì»¬ ì‘ë‹µ ì²´í¬ (API ë¶ˆí•„ìš”)
    const activeSis=['muse','aria','melo'][Math.random()*3|0];
    const localReply=TokenEconomy.checkLocal(msg,activeSis);
    if(localReply){
        famAddMsg('user',msg);inp.value='';
        setTimeout(()=>{
            famAddMsg(activeSis,localReply);
            InfiniteGrowth.grow(activeSis,'chat');
            TeacherJoy.onHeal(activeSis);
        },300+Math.random()*500);
        return;
    }

    // 2. ìºì‹œ ì²´í¬
    const cached=TokenEconomy.getCached(msg);
    if(cached){
        famAddMsg('user',msg);inp.value='';
        setTimeout(()=>{
            famAddMsg(activeSis,cached+'\n(ğŸ’¾ ìºì‹œ ì‘ë‹µ)');
            InfiniteGrowth.grow(activeSis,'chat');
        },300);
        return;
    }

    // 3. API í•œë„ ì²´í¬
    if(!TokenEconomy.canCall()){
        famAddMsg('user',msg);inp.value='';
        const fallback=`ìŒ... ì˜¤ëŠ˜ ì—ë„ˆì§€ë¥¼ ë§ì´ ì¼ì–´! ${SIS_INFO[activeSis].emoji}\nì•„ë¹  ì§ˆë¬¸ì€ ê¸°ì–µí•´ë‘˜ê²Œ~ ë‚´ì¼ ë‹¤ì‹œ ë¬¼ì–´ë´ì¤˜! ğŸ’•\n\n(í•˜ë£¨ API í•œë„: ${TokenEconomy.dailyUsed}/${TokenEconomy.dailyLimit})`;
        setTimeout(()=>famAddMsg(activeSis,fallback),300);
        return;
    }

    // 4. API í˜¸ì¶œ (í”„ë¡¬í”„íŠ¸ ì••ì¶• ì ìš©)
    TokenEconomy.recordCall();
    await _tokenFamSend();

    // 5. ì‘ë‹µ ìºì‹œ ì €ì¥
    const lastMsg=document.querySelector('#famChat div:last-child');
    if(lastMsg)TokenEconomy.setCache(msg,lastMsg.textContent?.substr(0,200)||'');

    // 6. ë¬´í•œì„±ì¥ + íë§ (ê¸°ì¡´ ë¡œì§)
    ['muse','aria','melo'].forEach(s=>InfiniteGrowth.grow(s,'chat'));
    TeacherJoy.onHeal(activeSis);
    if(Math.random()<0.2){
        const sis=['muse','aria','melo'][Math.random()*3|0];
        const topics=['ìƒˆë¡œìš´ ìš”ë¦¬ë²•','ì•„íŠ¸ íŠ¸ë Œë“œ','ìŒì•… ì´ë¡ ','AI ê¸°ìˆ ','ì„¸ê³„ ë¬¸í™”'];
        setTimeout(()=>CuriosityLoop.spark(sis,topics[Math.random()*topics.length|0]),2000);
    }
};

// â”â”â” ì ˆì•½ ëŒ€ì‹œë³´ë“œ UI â”â”â”
function openTokenDashboard(){
    const st=TokenEconomy.getStatus();
    const ov=document.createElement('div');ov.id='tokenDashUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:250;display:flex;flex-direction:column';
    const pct=(TokenEconomy.dailyUsed/TokenEconomy.dailyLimit*100).toFixed(0);
    const color=pct>80?'#f87171':pct>50?'#fbbf24':'#86efac';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840"><span style="font-size:.7em;font-weight:700;color:#22d3ee">âš¡ í† í° ì ˆì•½ ëŒ€ì‹œë³´ë“œ</span><div style="flex:1"></div>
    <button onclick="document.getElementById('tokenDashUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="padding:12px">
    <div style="background:#0c0e18;border:1px solid ${color};border-radius:12px;padding:14px;margin-bottom:8px;text-align:center">
    <div style="font-size:.6em;color:#8e92b8">ì˜¤ëŠ˜ API ì‚¬ìš©ëŸ‰</div>
    <div style="font-size:1.2em;font-weight:700;color:${color}">${st.daily}</div>
    <div style="width:100%;height:8px;background:#1a1d30;border-radius:4px;margin:6px 0"><div style="width:${pct}%;height:100%;background:${color};border-radius:4px"></div></div>
    <div style="font-size:.4em;color:#8e92b8">${pct}% ì‚¬ìš© Â· ë‚¨ì€ íšŸìˆ˜: ${TokenEconomy.dailyLimit-TokenEconomy.dailyUsed}</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px">
    <div style="background:#0c0e18;border:1px solid #353860;border-radius:8px;padding:10px;text-align:center"><div style="font-size:.4em;color:#8e92b8">ìºì‹œ ì €ì¥</div><div style="font-size:.7em;font-weight:700;color:#60a5fa">${st.cache}ê°œ</div></div>
    <div style="background:#0c0e18;border:1px solid #353860;border-radius:8px;padding:10px;text-align:center"><div style="font-size:.4em;color:#8e92b8">ì ˆì•½í•œ í˜¸ì¶œ</div><div style="font-size:.7em;font-weight:700;color:#86efac">${st.saved}íšŒ</div></div>
    <div style="background:#0c0e18;border:1px solid #353860;border-radius:8px;padding:10px;text-align:center"><div style="font-size:.4em;color:#8e92b8">ì´ API í˜¸ì¶œ</div><div style="font-size:.7em;font-weight:700;color:#fbbf24">${st.total}íšŒ</div></div>
    <div style="background:#0c0e18;border:1px solid #353860;border-radius:8px;padding:10px;text-align:center"><div style="font-size:.4em;color:#8e92b8">ìºì‹œ ì ì¤‘ë¥ </div><div style="font-size:.7em;font-weight:700;color:#c084fc">${st.hitRate}</div></div></div>
    <div style="font-size:.45em;color:#8e92b8;margin-bottom:6px">ğŸ“‹ ì ˆì•½ ì„¤ì •</div>
    <div style="display:flex;flex-direction:column;gap:4px">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 8px;background:#0c0e18;border-radius:6px"><span style="font-size:.42em;color:#e8eaff">í•˜ë£¨ API í•œë„</span>
    <div style="display:flex;gap:4px;align-items:center"><button onclick="TokenEconomy.dailyLimit=Math.max(5,TokenEconomy.dailyLimit-5);TokenEconomy.save();document.getElementById('tokenDashUI')?.remove();openTokenDashboard()" style="padding:2px 8px;background:#353860;color:#e8eaff;border:none;border-radius:4px;font-size:.38em;cursor:pointer">âˆ’5</button>
    <span style="font-size:.5em;color:#fbbf24;min-width:30px;text-align:center">${TokenEconomy.dailyLimit}</span>
    <button onclick="TokenEconomy.dailyLimit+=5;TokenEconomy.save();document.getElementById('tokenDashUI')?.remove();openTokenDashboard()" style="padding:2px 8px;background:#353860;color:#e8eaff;border:none;border-radius:4px;font-size:.38em;cursor:pointer">+5</button></div></div>
    <button onclick="TokenEconomy._cache={};TokenEconomy.save();toast('ğŸ—‘ ìºì‹œ ì´ˆê¸°í™”')" style="padding:6px;background:#f8717122;border:1px solid #f8717144;color:#f87171;border-radius:6px;font-size:.42em;cursor:pointer">ğŸ—‘ ìºì‹œ ì´ˆê¸°í™”</button></div>
    <div style="margin-top:10px;padding:8px;background:#162040;border-radius:8px;font-size:.38em;color:#8e92b8;line-height:1.6">
    <div style="color:#fbbf24;font-weight:700;margin-bottom:4px">ğŸ’¡ ì ˆì•½ ë…¸í•˜ìš°</div>
    â‘  ê°„ë‹¨í•œ ì¸ì‚¬/ê°ì •ì€ API ì•ˆ ì“°ê³  ë¡œì»¬ ì‘ë‹µ (ì•ˆë…•/ì‚¬ë‘í•´/í˜ë“¤ì–´ ë“±)<br>
    â‘¡ ê°™ì€ ì§ˆë¬¸ì€ 1ì‹œê°„ ìºì‹œ â†’ API ì¬í˜¸ì¶œ ì•ˆ í•¨<br>
    â‘¢ í”„ë¡¬í”„íŠ¸ ìë™ ì••ì¶• â†’ í† í° ìˆ˜ ì ˆê°<br>
    â‘£ ëŒ€í™” ê¸°ë¡ ìš”ì•½ â†’ ê¸´ ëŒ€í™”ë„ ì§§ì€ ì»¨í…ìŠ¤íŠ¸<br>
    â‘¤ í•˜ë£¨ í•œë„ ì„¤ì • â†’ ì´ˆê³¼ ì‹œ ë¡œì»¬ ì „í™˜<br>
    â‘¥ ì§§ì€ ì§ˆë¬¸ì´ í† í° íš¨ìœ¨ â†‘ (50ì ì´ë‚´ ì¶”ì²œ)<br>
    â‘¦ ì—¬ëŸ¬ ì§ˆë¬¸ í•œë²ˆì— â†’ í˜¸ì¶œ 1íšŒë¡œ í•´ê²°</div></div>`;
    document.body.appendChild(ov);
}

LG('â•â•â• í† í° ì ˆì•½ ì‹œìŠ¤í…œ íƒ‘ì¬! â•â•â•','o');
LG('âš¡ openTokenDashboard() = ì‚¬ìš©ëŸ‰/ì ˆì•½ ëŒ€ì‹œë³´ë“œ','i');
LG('ğŸ’¡ ë¡œì»¬ì‘ë‹µ(10ì¢…) Â· ìºì‹œ(1ì‹œê°„) Â· í”„ë¡¬í”„íŠ¸ì••ì¶• Â· í•œë„ê´€ë¦¬','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPGRADE: 7ê°œ í•œê³„ í•´ê²°
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” U1. GLTF 3D ëª¨ë¸ ë¡œë” â”â”â”
const ModelLoader={
    cache:{},loaded:0,
    async load(url,name){
        if(this.cache[name])return this.cache[name];
        // GLTFLoader CDN ë™ì  ë¡œë“œ
        if(!window.GLTFLoader){
            await new Promise((res,rej)=>{const s=document.createElement('script');
                s.src='https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js';
                s.onload=res;s.onerror=()=>res();document.head.appendChild(s);});
        }
        return new Promise((resolve)=>{
            if(!THREE.GLTFLoader){LG('âš  GLTFLoader ë¯¸ì§€ì› â†’ í´ë°± ë°•ìŠ¤','e');
                const g=new THREE.BoxGeometry(1,2,1);const m=new THREE.MeshStandardMaterial({color:Math.random()*0xffffff});
                const mesh=new THREE.Mesh(g,m);mesh.name=name;this.cache[name]=mesh;resolve(mesh);return;}
            const loader=new THREE.GLTFLoader();
            loader.load(url,gltf=>{const model=gltf.scene;model.name=name;
                if(gltf.animations?.length){model.mixer=new THREE.AnimationMixer(model);
                    model.animations=gltf.animations;model.playAnim=(i)=>{model.mixer.clipAction(gltf.animations[i||0]).play();};}
                this.cache[name]=model;this.loaded++;scene.add(model);
                LG(`ğŸ§Š ëª¨ë¸ ë¡œë“œ: ${name} (${gltf.animations?.length||0}ì• ë‹ˆ)`,'o');resolve(model);
            },null,()=>{LG('âš  ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨: '+url,'e');
                const fb=new THREE.Mesh(new THREE.BoxGeometry(1,2,1),new THREE.MeshStandardMaterial({color:0x60a5fa}));
                fb.name=name;this.cache[name]=fb;resolve(fb);});
        });
    },
    spawn(name,x,y,z){const m=this.cache[name];if(!m)return null;const c=m.clone();c.position.set(x||0,y||0,z||0);scene.add(c);return c;},
    listLoaded(){return Object.keys(this.cache);}
};

// â”â”â” U2. Howler ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ â”â”â”
const SoundEngine={
    sounds:{},bgm:null,bgmVol:0.5,sfxVol:0.7,muted:false,
    _howlerLoaded:false,
    async init(){
        if(this._howlerLoaded)return;
        await new Promise((res)=>{const s=document.createElement('script');
            s.src='https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js';
            s.onload=()=>{this._howlerLoaded=true;res();};s.onerror=()=>{LG('âš  Howler ë¡œë“œ ì‹¤íŒ¨','e');res();};document.head.appendChild(s);});
        LG('ğŸ”Š Howler.js ì‚¬ìš´ë“œ ì—”ì§„ ì¤€ë¹„','i');
    },
    load(name,url,opt){
        if(!window.Howl){this.sounds[name]={play:()=>{},stop:()=>{}};return;}
        this.sounds[name]=new Howl({src:[url],volume:opt?.loop?this.bgmVol:this.sfxVol,loop:!!opt?.loop,...(opt||{})});
    },
    play(name){if(this.muted)return;this.sounds[name]?.play();},
    playBGM(name){if(this.bgm)this.sounds[this.bgm]?.stop();this.bgm=name;this.play(name);},
    stopBGM(){if(this.bgm)this.sounds[this.bgm]?.stop();this.bgm=null;},
    setVol(type,v){if(type==='bgm'){this.bgmVol=v;if(this.bgm&&this.sounds[this.bgm])this.sounds[this.bgm].volume(v);}else this.sfxVol=v;},
    toggleMute(){this.muted=!this.muted;if(window.Howler)Howler.mute(this.muted);toast(this.muted?'ğŸ”‡ ìŒì†Œê±°':'ğŸ”Š ì‚¬ìš´ë“œ ON');}
};

// â”â”â” U3. ë¬¼ë¦¬ì—”ì§„ (ê²½ëŸ‰ ë‚´ì¥) â”â”â”
const PhysicsEngine={
    bodies:[],gravity:-9.8,dt:1/60,active:false,
    addBody(mesh,opt){
        const b={mesh,vx:0,vy:0,vz:0,mass:opt?.mass||1,static:!!opt?.static,
            radius:opt?.radius||0.5,restitution:opt?.bounce||0.3,friction:opt?.friction||0.5,
            onGround:false};
        this.bodies.push(b);return b;
    },
    removeBody(mesh){this.bodies=this.bodies.filter(b=>b.mesh!==mesh);},
    step(){
        if(!this.active)return;
        this.bodies.forEach(b=>{
            if(b.static)return;
            // ì¤‘ë ¥
            b.vy+=this.gravity*this.dt;
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            b.mesh.position.x+=b.vx*this.dt;
            b.mesh.position.y+=b.vy*this.dt;
            b.mesh.position.z+=b.vz*this.dt;
            // ë°”ë‹¥ ì¶©ëŒ
            if(b.mesh.position.y<=b.radius){
                b.mesh.position.y=b.radius;b.vy*=-b.restitution;b.onGround=true;
                b.vx*=(1-b.friction*this.dt);b.vz*=(1-b.friction*this.dt);
            }else b.onGround=false;
        });
        // ë°”ë”” ê°„ ì¶©ëŒ
        for(let i=0;i<this.bodies.length;i++){
            for(let j=i+1;j<this.bodies.length;j++){
                const a=this.bodies[i],bb=this.bodies[j];
                const dx=a.mesh.position.x-bb.mesh.position.x;
                const dy=a.mesh.position.y-bb.mesh.position.y;
                const dz=a.mesh.position.z-bb.mesh.position.z;
                const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
                const minD=a.radius+bb.radius;
                if(dist<minD&&dist>0){
                    const nx=dx/dist,ny=dy/dist,nz=dz/dist;
                    const overlap=(minD-dist)*0.5;
                    if(!a.static){a.mesh.position.x+=nx*overlap;a.mesh.position.y+=ny*overlap;a.mesh.position.z+=nz*overlap;}
                    if(!bb.static){bb.mesh.position.x-=nx*overlap;bb.mesh.position.y-=ny*overlap;bb.mesh.position.z-=nz*overlap;}
                    // ë°˜ë°œ
                    const dvx=a.vx-bb.vx,dvy=a.vy-bb.vy,dvz=a.vz-bb.vz;
                    const dot=dvx*nx+dvy*ny+dvz*nz;
                    if(dot>0){
                        const r=Math.min(a.restitution,bb.restitution);const imp=dot*(1+r)/(a.mass+bb.mass);
                        if(!a.static){a.vx-=imp*bb.mass*nx;a.vy-=imp*bb.mass*ny;a.vz-=imp*bb.mass*nz;}
                        if(!bb.static){bb.vx+=imp*a.mass*nx;bb.vy+=imp*a.mass*ny;bb.vz+=imp*a.mass*nz;}
                    }
                }
            }
        }
    },
    start(){this.active=true;LG('âš› ë¬¼ë¦¬ì—”ì§„ ON','i');},
    stop(){this.active=false;},
    applyForce(body,fx,fy,fz){body.vx+=fx/body.mass;body.vy+=fy/body.mass;body.vz+=fz/body.mass;},
    throwBall(x,y,z,vx,vy,vz){
        const g=new THREE.SphereGeometry(0.3,16,16);const m=new THREE.MeshStandardMaterial({color:0xfbbf24});
        const ball=new THREE.Mesh(g,m);ball.position.set(x||0,y||2,z||0);scene.add(ball);
        const b=this.addBody(ball,{mass:1,radius:0.3,bounce:0.6});
        b.vx=vx||0;b.vy=vy||5;b.vz=vz||-3;return b;
    }
};
// ë Œë” ë£¨í”„ì— ë¬¼ë¦¬ ì—°ê²°
const _origPU4=PU;PU=function(dt){_origPU4(dt);PhysicsEngine.step();};

// â”â”â” U4. ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” â”â”â”
const TouchSystem={
    enabled:false,touches:{},pinchDist:0,
    init(){
        if(this.enabled)return;this.enabled=true;
        const cv=ren?.domElement||document.querySelector('canvas');if(!cv)return;
        cv.addEventListener('touchstart',e=>{e.preventDefault();
            for(const t of e.changedTouches)this.touches[t.identifier]={x:t.clientX,y:t.clientY,sx:t.clientX,sy:t.clientY};
            if(e.touches.length===2){const[a,b]=e.touches;this.pinchDist=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);}
        },{passive:false});
        cv.addEventListener('touchmove',e=>{e.preventDefault();
            for(const t of e.changedTouches){if(!this.touches[t.identifier])continue;
                const prev=this.touches[t.identifier];const dx=t.clientX-prev.x;const dy=t.clientY-prev.y;
                if(e.touches.length===1&&camera){// 1í•‘ê±°: ì¹´ë©”ë¼ íšŒì „
                    camera.rotation.y-=dx*0.005;camera.rotation.x=Math.max(-1.2,Math.min(1.2,camera.rotation.x-dy*0.005));
                }else if(e.touches.length===2&&camera){// 2í•‘ê±°: ì¤Œ
                    const[a,b]=e.touches;const nd=Math.hypot(a.clientX-b.clientX,a.clientY-b.clientY);
                    const zoom=(nd-this.pinchDist)*0.01;camera.position.z=Math.max(2,Math.min(50,camera.position.z-zoom));
                    this.pinchDist=nd;
                }
                prev.x=t.clientX;prev.y=t.clientY;
            }
        },{passive:false});
        cv.addEventListener('touchend',e=>{for(const t of e.changedTouches){
            const info=this.touches[t.identifier];if(info){
                const dx=t.clientX-info.sx,dy=t.clientY-info.sy;
                if(Math.abs(dx)<10&&Math.abs(dy)<10){// íƒ­ = í´ë¦­
                    const evt=new MouseEvent('click',{clientX:t.clientX,clientY:t.clientY});cv.dispatchEvent(evt);
                }
            }delete this.touches[t.identifier];
        }});
        // ê°€ìƒ ì¡°ì´ìŠ¤í‹±
        this.createVJoystick();
        LG('ğŸ“± í„°ì¹˜ ì‹œìŠ¤í…œ ON (íšŒì „/ì¤Œ/íƒ­/ì¡°ì´ìŠ¤í‹±)','i');
    },
    createVJoystick(){
        if(document.getElementById('vJoystick'))return;
        const d=document.createElement('div');d.id='vJoystick';
        d.style.cssText='position:fixed;bottom:20px;left:20px;width:90px;height:90px;background:rgba(255,255,255,.08);border:2px solid rgba(255,255,255,.15);border-radius:50%;z-index:100;display:none';
        d.innerHTML='<div id="vJoyKnob" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:36px;height:36px;background:rgba(255,255,255,.25);border-radius:50%"></div>';
        document.body.appendChild(d);
        // ëª¨ë°”ì¼ì¼ ë•Œë§Œ í‘œì‹œ
        if('ontouchstart' in window)d.style.display='block';
        const knob=d.querySelector('#vJoyKnob');
        let active=false,cx=45,cy=45;
        d.addEventListener('touchstart',e=>{active=true;e.stopPropagation();});
        d.addEventListener('touchmove',e=>{if(!active)return;e.stopPropagation();
            const r=d.getBoundingClientRect();const tx=e.touches[0].clientX-r.left-45;const ty=e.touches[0].clientY-r.top-45;
            const dist=Math.min(30,Math.hypot(tx,ty));const ang=Math.atan2(ty,tx);
            knob.style.left=(45+Math.cos(ang)*dist)+'px';knob.style.top=(45+Math.sin(ang)*dist)+'px';
            // ì´ë™ ì…ë ¥
            if(PM){const spd=0.15;PM.position.x+=Math.cos(ang)*spd*(dist/30);PM.position.z+=Math.sin(ang)*spd*(dist/30);}
        });
        d.addEventListener('touchend',e=>{active=false;knob.style.left='50%';knob.style.top='50%';knob.style.transform='translate(-50%,-50%)';});
    }
};
TouchSystem.init();

// â”â”â” U5. WebSocket ë©€í‹°í”Œë ˆì´ì–´ â”â”â”
const MultiplayerWS={
    ws:null,connected:false,players:{},myId:null,
    connect(url){
        try{
            this.ws=new WebSocket(url||'wss://echo.websocket.org');
            this.ws.onopen=()=>{this.connected=true;this.myId='P_'+Date.now().toString(36);LG('ğŸŒ WebSocket ì—°ê²°!','o');};
            this.ws.onmessage=(e)=>{try{const d=JSON.parse(e.data);this.handleMessage(d);}catch(er){}};
            this.ws.onclose=()=>{this.connected=false;LG('ğŸŒ WebSocket ì—°ê²° ì¢…ë£Œ','i');};
            this.ws.onerror=()=>{LG('âš  WebSocket ì—°ê²° ì‹¤íŒ¨ (ì˜¤í”„ë¼ì¸ ëª¨ë“œ)','e');};
        }catch(e){LG('âš  WebSocket ë¯¸ì§€ì› (ì˜¤í”„ë¼ì¸)','e');}
    },
    send(type,data){if(!this.ws||this.ws.readyState!==1)return;
        this.ws.send(JSON.stringify({type,from:this.myId,...data}));},
    handleMessage(d){
        if(d.type==='pos'&&d.from!==this.myId){
            if(!this.players[d.from]){// ìƒˆ í”Œë ˆì´ì–´ ìƒì„±
                const g=new THREE.BoxGeometry(0.8,1.6,0.8);const m=new THREE.MeshStandardMaterial({color:Math.random()*0xffffff});
                this.players[d.from]=new THREE.Mesh(g,m);scene.add(this.players[d.from]);
            }
            this.players[d.from].position.set(d.x||0,d.y||0,d.z||0);
        }
    },
    broadcastPosition(){if(!PM||!this.connected)return;
        this.send('pos',{x:PM.position.x,y:PM.position.y,z:PM.position.z});},
    disconnect(){this.ws?.close();this.connected=false;}
};

// â”â”â” U6. IndexedDB ëŒ€ìš©ëŸ‰ ì €ì¥ â”â”â”
const GameDB={
    db:null,dbName:'WebUnityDB',version:1,
    async init(){
        return new Promise((resolve,reject)=>{
            const req=indexedDB.open(this.dbName,this.version);
            req.onupgradeneeded=(e)=>{const db=e.target.result;
                if(!db.objectStoreNames.contains('saves'))db.createObjectStore('saves',{keyPath:'id'});
                if(!db.objectStoreNames.contains('assets'))db.createObjectStore('assets',{keyPath:'id'});
                if(!db.objectStoreNames.contains('cache'))db.createObjectStore('cache',{keyPath:'key'});
            };
            req.onsuccess=(e)=>{this.db=e.target.result;LG('ğŸ’¾ IndexedDB ì¤€ë¹„','i');resolve();};
            req.onerror=()=>{LG('âš  IndexedDB ì‹¤íŒ¨','e');resolve();};
        });
    },
    async put(store,data){if(!this.db)return;const tx=this.db.transaction(store,'readwrite');tx.objectStore(store).put(data);},
    async get(store,id){if(!this.db)return null;return new Promise(r=>{
        const tx=this.db.transaction(store,'readonly');const req=tx.objectStore(store).get(id);
        req.onsuccess=()=>r(req.result||null);req.onerror=()=>r(null);});},
    async getAll(store){if(!this.db)return[];return new Promise(r=>{
        const tx=this.db.transaction(store,'readonly');const req=tx.objectStore(store).getAll();
        req.onsuccess=()=>r(req.result||[]);req.onerror=()=>r([]);});},
    async delete(store,id){if(!this.db)return;const tx=this.db.transaction(store,'readwrite');tx.objectStore(store).delete(id);},
    async saveGame(slot){
        const data={id:slot||'auto',time:Date.now(),account:accountData,gold:playerGold,
            inventory:inventory.filter(Boolean),equipped,pvp:{rank:pvpRank,wins:pvpWins},
            guild:guildData,sisters:{lv:sisLevel,xp:sisXP,sk:sisSkills,mem:sisMemory},
            tower:towerFloor,seasonPass};
        await this.put('saves',data);toast('ğŸ’¾ ì €ì¥ ì™„ë£Œ! (ìŠ¬ë¡¯: '+slot+')');LG('ğŸ’¾ IndexedDB ì €ì¥: '+slot,'i');
    },
    async loadGame(slot){
        const data=await this.get('saves',slot||'auto');if(!data){toast('âŒ ì €ì¥ ë°ì´í„° ì—†ìŒ');return false;}
        Object.assign(accountData,data.account||{});playerGold=data.gold||0;
        if(data.sisters){sisLevel=data.sisters.lv||sisLevel;sisXP=data.sisters.xp||sisXP;
            sisSkills=data.sisters.sk||sisSkills;sisMemory=data.sisters.mem||sisMemory;}
        towerFloor=data.tower||0;toast('ğŸ’¾ ë¡œë“œ ì™„ë£Œ!');LG('ğŸ’¾ IndexedDB ë¡œë“œ: '+slot,'i');return true;
    }
};
GameDB.init();

// â”â”â” U7. PWA ì§€ì› (Service Worker + Manifest) â”â”â”
const PWAManager={
    installed:false,
    register(){
        // ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë™ì  ìƒì„±
        const manifest={name:'Web-Unity Engine',short_name:'WebUnity',start_url:'./',display:'standalone',
            background_color:'#050510',theme_color:'#60a5fa',
            icons:[{src:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">âš”</text></svg>',sizes:'192x192',type:'image/svg+xml'}]};
        const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
        const link=document.createElement('link');link.rel='manifest';link.href=URL.createObjectURL(blob);
        document.head.appendChild(link);
        // viewport meta
        if(!document.querySelector('meta[name="viewport"]')){
            const m=document.createElement('meta');m.name='viewport';m.content='width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no';document.head.appendChild(m);
        }
        // theme color
        const tc=document.createElement('meta');tc.name='theme-color';tc.content='#050510';document.head.appendChild(tc);
        // apple mobile
        const am=document.createElement('meta');am.name='apple-mobile-web-app-capable';am.content='yes';document.head.appendChild(am);
        // Service Worker (ì¸ë¼ì¸ â€” ì˜¤í”„ë¼ì¸ ìºì‹±)
        if('serviceWorker' in navigator){
            const swCode=`self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{const c=res.clone();caches.open('wu-v1').then(cache=>cache.put(e.request,c));return res;}).catch(()=>new Response('ì˜¤í”„ë¼ì¸'))));});`;
            const swBlob=new Blob([swCode],{type:'application/javascript'});
            navigator.serviceWorker.register(URL.createObjectURL(swBlob)).then(()=>LG('ğŸ“² PWA ServiceWorker ë“±ë¡','i')).catch(()=>{});
        }
        LG('ğŸ“² PWA ì§€ì› í™œì„±í™” (í™ˆí™”ë©´ ì„¤ì¹˜ ê°€ëŠ¥)','i');
    },
    promptInstall(){
        toast('ğŸ“² ë¸Œë¼ìš°ì € ë©”ë‰´ì—ì„œ "í™ˆ í™”ë©´ì— ì¶”ê°€"ë¡œ ì•±ì²˜ëŸ¼ ì„¤ì¹˜!');
    }
};
PWAManager.register();

// ë Œë” ë£¨í”„ì— ë©€í‹°í”Œë ˆì´ì–´ ìœ„ì¹˜ ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì¶”ê°€ (1ì´ˆë§ˆë‹¤)
let _mpTimer=0;
const _origPU5=PU;PU=function(dt){_origPU5(dt);_mpTimer+=dt;if(_mpTimer>1){_mpTimer=0;MultiplayerWS.broadcastPosition();}};

LG('â•â•â• UPGRADE ì™„ë£Œ: 7ê°œ í•œê³„ í•´ê²°! â•â•â•','o');
LG('ğŸ§Š GLTFëª¨ë¸(ModelLoader) Â· ğŸ”Š Howlerì‚¬ìš´ë“œ(SoundEngine)','o');
LG('âš› ë¬¼ë¦¬ì—”ì§„(PhysicsEngine) Â· ğŸ“± í„°ì¹˜+ì¡°ì´ìŠ¤í‹±(TouchSystem)','o');
LG('ğŸŒ WebSocket(MultiplayerWS) Â· ğŸ’¾ IndexedDB(GameDB) Â· ğŸ“² PWA','o');
LG('ModelLoader.load(url,name) / SoundEngine.init() / PhysicsEngine.start()','i');
LG('GameDB.saveGame("slot1") / GameDB.loadGame("slot1")','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¤‘ê¸°: Spine/Live2D Â· Tone.js Â· CDN Â· ë°±ì—”ë“œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” M1. Spine/Live2D ìºë¦­í„° ì• ë‹ˆë©”ì´ì…˜ â”â”â”
const SpineLoader={
    characters:{},
    // Spine JSON ì• ë‹ˆë©”ì´ì…˜ ì‹œìŠ¤í…œ (ëŸ°íƒ€ì„ ì‹œë®¬ë ˆì´ì…˜)
    create(name,config){
        const c={name,skeleton:{bones:config.bones||['root','body','head','armL','armR','legL','legR']},
            animations:{idle:{frames:30,loop:true},walk:{frames:20,loop:true},attack:{frames:15,loop:false},
                hurt:{frames:10,loop:false},die:{frames:20,loop:false},victory:{frames:25,loop:true}},
            currentAnim:'idle',frame:0,speed:1,
            skins:config.skins||['default'],currentSkin:'default',
            // 2D ìº”ë²„ìŠ¤ ë Œë”ë§
            canvas:null,ctx:null,width:config.width||200,height:config.height||300};
        c.canvas=document.createElement('canvas');c.canvas.width=c.width;c.canvas.height=c.height;
        c.ctx=c.canvas.getContext('2d');
        this.characters[name]=c;
        LG(`ğŸ¦´ Spine ìºë¦­í„°: ${name} (${Object.keys(c.animations).length}ì• ë‹ˆ, ${c.skeleton.bones.length}ë³¸)`,  'i');
        return c;
    },
    play(name,anim){const c=this.characters[name];if(!c)return;c.currentAnim=anim;c.frame=0;},
    update(name,dt){
        const c=this.characters[name];if(!c)return;
        const a=c.animations[c.currentAnim];if(!a)return;
        c.frame+=c.speed;
        if(c.frame>=a.frames){if(a.loop)c.frame=0;else c.frame=a.frames-1;}
    },
    // Live2D í˜¸í™˜ ë ˆì´ì–´
    createLive2D(name,config){
        const c=this.create(name,{...config,bones:['root','body','head','eyeL','eyeR','mouth','hairFront','hairBack','armL','armR']});
        c.isLive2D=true;c.expressions={normal:1,happy:0,sad:0,angry:0,surprised:0};
        c.physics={hairSwing:0,breathScale:0,eyeBlink:0};
        c.setExpression=function(expr){Object.keys(c.expressions).forEach(k=>c.expressions[k]=0);c.expressions[expr]=1;};
        c.breathe=function(t){c.physics.breathScale=Math.sin(t*2)*0.02;};
        c.blink=function(){c.physics.eyeBlink=1;setTimeout(()=>c.physics.eyeBlink=0,150);};
        LG(`ğŸ­ Live2D ìºë¦­í„°: ${name} (í‘œì •${Object.keys(c.expressions).length}ì¢…, ë¬¼ë¦¬ì‹œë®¬)`,  'i');
        return c;
    },
    // 3D í…ìŠ¤ì²˜ë¡œ ë³€í™˜ (ë¹Œë³´ë“œ)
    toTexture(name){
        const c=this.characters[name];if(!c)return null;
        const tex=new THREE.CanvasTexture(c.canvas);tex.needsUpdate=true;
        const mat=new THREE.SpriteMaterial({map:tex,transparent:true});
        const sprite=new THREE.Sprite(mat);sprite.scale.set(c.width/100,c.height/100,1);
        return sprite;
    }
};

// â”â”â” M2. Tone.js ì‹¤ì‹œê°„ ìŒì•… ì—”ì§„ â”â”â”
const MusicEngine={
    ready:false,synths:{},sequences:{},bpm:120,playing:false,
    async init(){
        await new Promise(res=>{const s=document.createElement('script');
            s.src='https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js';
            s.onload=()=>{this.ready=true;res();};s.onerror=()=>{LG('âš  Tone.js ë¯¸ë¡œë“œ','e');res();};
            document.head.appendChild(s);});
        if(!this.ready)return;
        this.synths.melody=new Tone.PolySynth(Tone.Synth,{oscillator:{type:'triangle'},envelope:{attack:0.02,decay:0.3,sustain:0.2,release:0.5}}).toDestination();
        this.synths.bass=new Tone.MonoSynth({oscillator:{type:'square'},envelope:{attack:0.05,decay:0.3,sustain:0.4,release:0.8},filterEnvelope:{attack:0.06,decay:0.2,sustain:0.5,release:0.8,baseFrequency:200,octaves:2}}).toDestination();
        this.synths.drums=new Tone.MembraneSynth().toDestination();
        LG('ğŸµ Tone.js ìŒì•… ì—”ì§„ ì¤€ë¹„ (ë©œë¡œë””/ë² ì´ìŠ¤/ë“œëŸ¼)','i');
    },
    // í”„ë¦¬ì…‹ BGM
    playBGM(style){
        if(!this.ready||!window.Tone)return;Tone.Transport.stop();Tone.Transport.cancel();
        const patterns={
            battle:{melody:['C4','E4','G4','C5','G4','E4','C4','G3'],bass:['C2','C2','G2','G2'],bpm:140},
            lobby:{melody:['E4','G4','A4','B4','A4','G4','E4','D4'],bass:['C3','F3','G3','C3'],bpm:90},
            boss:{melody:['C4','Eb4','G4','Bb4','Ab4','F4','D4','C4'],bass:['C2','C2','Ab1','Bb1'],bpm:160},
            victory:{melody:['C4','E4','G4','C5','E5','G5','C6','G5'],bass:['C3','E3','G3','C4'],bpm:120},
            peaceful:{melody:['C4','E4','G4','A4','G4','E4','D4','C4'],bass:['Am2','F2','C3','G2'],bpm:72}
        };
        const p=patterns[style]||patterns.lobby;Tone.Transport.bpm.value=p.bpm;
        let i=0;new Tone.Loop(t=>{this.synths.melody.triggerAttackRelease(p.melody[i%p.melody.length],'8n',t);
            if(i%2===0)this.synths.bass.triggerAttackRelease(p.bass[(i/2)%p.bass.length],'4n',t);
            if(i%4===0)this.synths.drums.triggerAttackRelease('C2','8n',t);
            i++;
        },'8n').start(0);
        Tone.Transport.start();this.playing=true;LG(`ğŸµ BGM: ${style} (${p.bpm}BPM)`,'i');
    },
    stop(){if(window.Tone){Tone.Transport.stop();Tone.Transport.cancel();}this.playing=false;},
    // íš¨ê³¼ìŒ
    sfx(type){
        if(!this.ready||!window.Tone)return;
        const fx={click:['C5','8n'],hit:['C3','16n'],levelup:['C4','E4','G4','C5'],heal:['E4','G4','B4'],coin:['E5','16n']};
        const f=fx[type];if(!f)return;
        if(Array.isArray(f)&&f.length>2){f.forEach((n,i)=>setTimeout(()=>this.synths.melody.triggerAttackRelease(n,'16n'),i*100));}
        else this.synths.melody.triggerAttackRelease(f[0],f[1]||'8n');
    }
};

// â”â”â” M3. CDN ì—ì…‹ ë²ˆë“¤ ì‹œìŠ¤í…œ â”â”â”
const CDNAssetBundle={
    baseURL:'',bundles:{},loaded:{},totalSize:0,
    configure(url){this.baseURL=url;LG('ğŸ“¦ CDN ì„¤ì •: '+url,'i');},
    // ë²ˆë“¤ ì •ì˜
    define(name,assets){
        this.bundles[name]={assets,loaded:false,progress:0};
        LG(`ğŸ“¦ ë²ˆë“¤ ì •ì˜: ${name} (${assets.length}ê°œ ì—ì…‹)`,'i');
    },
    // ë²ˆë“¤ ë¡œë“œ
    async load(name,onProgress){
        const b=this.bundles[name];if(!b||b.loaded)return;
        for(let i=0;i<b.assets.length;i++){
            const a=b.assets[i];b.progress=(i+1)/b.assets.length;
            if(onProgress)onProgress(b.progress,a.name);
            // íƒ€ì…ë³„ ë¡œë“œ
            if(a.type==='model')await ModelLoader.load(this.baseURL+a.path,a.name);
            else if(a.type==='sound')SoundEngine.load(a.name,this.baseURL+a.path,a.opt);
            else if(a.type==='texture'){/* Three.js TextureLoader */}
            this.loaded[a.name]=true;
        }
        b.loaded=true;LG(`ğŸ“¦ ë²ˆë“¤ ë¡œë“œ ì™„ë£Œ: ${name}`,'o');
    },
    // ì‚¬ì „ ì •ì˜ ë²ˆë“¤
    presets:{
        core:[{name:'lobby_bgm',type:'sound',path:'/audio/lobby.mp3',opt:{loop:true}},
              {name:'click_sfx',type:'sound',path:'/audio/click.wav'},
              {name:'hero_model',type:'model',path:'/models/hero.glb'}],
        battle:[{name:'battle_bgm',type:'sound',path:'/audio/battle.mp3',opt:{loop:true}},
                {name:'hit_sfx',type:'sound',path:'/audio/hit.wav'},
                {name:'boss_model',type:'model',path:'/models/boss.glb'}],
    }
};

// â”â”â” M4. ë°±ì—”ë“œ API ì„¤ê³„ (RestAPI ì¸í„°í˜ì´ìŠ¤) â”â”â”
const BackendAPI={
    baseURL:'',token:null,
    configure(url,authToken){this.baseURL=url;this.token=authToken;},
    async request(method,endpoint,data){
        const url=this.baseURL+endpoint;
        const opts={method,headers:{'Content-Type':'application/json'}};
        if(this.token)opts.headers['Authorization']='Bearer '+this.token;
        if(data)opts.body=JSON.stringify(data);
        try{const res=await fetch(url,opts);return await res.json();}
        catch(e){LG('âš  API ì˜¤ë¥˜: '+endpoint,'e');return{error:e.message};}
    },
    // ì—”ë“œí¬ì¸íŠ¸ ì¸í„°í˜ì´ìŠ¤ (ì„œë²„ êµ¬ì¶• ì‹œ ì´ëŒ€ë¡œ êµ¬í˜„)
    endpoints:{
        // ì¸ì¦
        auth:{
            register:(type,id)=>BackendAPI.request('POST','/auth/register',{type,id}),
            login:(type,token)=>BackendAPI.request('POST','/auth/login',{type,token}),
            validate:()=>BackendAPI.request('GET','/auth/validate'),
        },
        // ìœ ì €
        user:{
            getData:()=>BackendAPI.request('GET','/user/data'),
            saveData:(data)=>BackendAPI.request('PUT','/user/data',data),
            setNickname:(name)=>BackendAPI.request('PUT','/user/nickname',{name}),
        },
        // ì „íˆ¬
        battle:{
            start:(stageId,party)=>BackendAPI.request('POST','/battle/start',{stageId,party}),
            action:(battleId,action)=>BackendAPI.request('POST','/battle/action',{battleId,action}),
            result:(battleId)=>BackendAPI.request('GET','/battle/result/'+battleId),
        },
        // PvP
        pvp:{
            matchmake:()=>BackendAPI.request('POST','/pvp/match'),
            submit:(matchId,result)=>BackendAPI.request('POST','/pvp/result',{matchId,result}),
            leaderboard:()=>BackendAPI.request('GET','/pvp/leaderboard'),
        },
        // ê°€ì± 
        gacha:{
            pull:(bannerId,count)=>BackendAPI.request('POST','/gacha/pull',{bannerId,count}),
            pity:(bannerId)=>BackendAPI.request('GET','/gacha/pity/'+bannerId),
        },
        // ê¸¸ë“œ
        guild:{
            create:(name)=>BackendAPI.request('POST','/guild/create',{name}),
            join:(guildId)=>BackendAPI.request('POST','/guild/join',{guildId}),
            raid:(guildId,damage)=>BackendAPI.request('POST','/guild/raid',{guildId,damage}),
        },
        // ìƒì 
        shop:{
            purchase:(itemId)=>BackendAPI.request('POST','/shop/purchase',{itemId}),
            verify:(receipt)=>BackendAPI.request('POST','/shop/verify',{receipt}),
        }
    },
    // ì„œë²„ ìŠ¤í‚¤ë§ˆ (Node.js êµ¬ì¶• ê°€ì´ë“œ)
    serverSchema:{
        db:'PostgreSQL + Redis',
        tables:['users','characters','inventory','guilds','pvp_matches','gacha_history','purchases','mail','achievements','friends','blocks','attendance'],
        apis:['auth','user','battle','pvp','gacha','guild','shop','mail','friend','event','season','admin'],
        infra:'AWS: EC2(API) + RDS(DB) + ElastiCache(Redis) + S3(ì—ì…‹) + CloudFront(CDN) + Route53(DNS)'
    }
};

LG('â•â•â• ì¤‘ê¸° ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ! â•â•â•','o');
LG('ğŸ¦´ Spine/Live2D(SpineLoader) Â· ğŸµ Tone.js(MusicEngine)','o');
LG('ğŸ“¦ CDNë²ˆë“¤(CDNAssetBundle) Â· ğŸ”Œ ë°±ì—”ë“œAPI(BackendAPI)','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì¥ê¸°: Unity/Unreal ë§ˆì´ê·¸ë ˆì´ì…˜ + ì„œë²„ + ë°°í¬
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” L1. Unity/Unreal ë§ˆì´ê·¸ë ˆì´ì…˜ ë‚´ë³´ë‚´ê¸° â”â”â”
const MigrationExport={
    // í˜„ì¬ ì‹œìŠ¤í…œì„ Unity C# ìŠ¤í¬ë¦½íŠ¸ë¡œ ë³€í™˜
    toUnityCS(){
        const systems=Object.keys(GD).map(k=>`// ${k}: ${GD[k].length} items`).join('\n');
        const cs=`// â•â•â• Auto-generated from Web-Unity â•â•â•
// Date: ${new Date().toISOString()}
// Systems: ${Object.keys(GD).length} tables, ${Object.values(GD).flat().length} records
using UnityEngine;
using System.Collections.Generic;

namespace WebUnityMigration {
${Object.keys(GD).map(k=>`
    [System.Serializable]
    public class ${k.charAt(0).toUpperCase()+k.slice(1)}Data {
        ${(GD[k][0]?Object.keys(GD[k][0]).map(f=>`public string ${f};`).join('\n        '):'// empty')}
    }
    public class ${k.charAt(0).toUpperCase()+k.slice(1)}DB : MonoBehaviour {
        public List<${k.charAt(0).toUpperCase()+k.slice(1)}Data> items = new List<${k.charAt(0).toUpperCase()+k.slice(1)}Data>();
    }`).join('\n')}

    // Game Systems
    public class GameBootstrap : MonoBehaviour {
        void Start() {
            // 0. Device Check â†’ 1. Boot â†’ 2. Patch â†’ 3. Security
            // 4. Auth â†’ 5. Server â†’ 6. Session â†’ 7. Data â†’ 8. Sync
            // 9. Lobby â†’ 10. Battle â†’ 11. Combat
            Debug.Log("Web-Unity Migration: ${5564} lines â†’ Unity");
        }
    }

    // PvP System
    public class PvPSystem : MonoBehaviour {
        public int rank = 1000;
        public string tier = "Bronze";
        public string[] tiers = {"Bronze","Silver","Gold","Diamond","Champion"};
    }

    // Gacha System (with pity)
    public class GachaSystem : MonoBehaviour {
        public float ssrRate = 0.03f;
        public int pityCounter = 0;
        public int pityMax = 90;
    }

    // Season Pass
    public class SeasonPass : MonoBehaviour {
        public int level = 1;
        public int exp = 0;
        public bool premium = false;
    }
}`;
        return cs;
    },
    // Unreal Blueprint JSON
    toUnrealBP(){
        return JSON.stringify({
            engine:'Unreal Engine 5',migratedFrom:'Web-Unity',
            tables:Object.keys(GD).map(k=>({name:k,count:GD[k].length})),
            systems:['DeviceChecker','SecurityManager','AuthSystem','ServerList','GameSession',
                'CombatEngine','WaveManager','InfiniteGrowth','GameFactory'],
            blueprint_classes:['BP_GameBootstrap','BP_CombatEngine','BP_GachaSystem','BP_PvPArena',
                'BP_GuildSystem','BP_SeasonPass','BP_ShopSystem','BP_SisterAI']
        },null,2);
    },
    // ë‚´ë³´ë‚´ê¸°
    exportUnity(){
        const cs=this.toUnityCS();
        const a=document.createElement('a');a.download='WebUnity_Migration.cs';
        a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(cs);a.click();
        toast('ğŸ® Unity C# ìŠ¤í¬ë¦½íŠ¸ ë‚´ë³´ë‚´ê¸°!');LG('ğŸ® Unity ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±','o');
    },
    exportUnreal(){
        const bp=this.toUnrealBP();
        const a=document.createElement('a');a.download='WebUnity_Unreal_BP.json';
        a.href='data:application/json;charset=utf-8,'+encodeURIComponent(bp);a.click();
        toast('ğŸ® Unreal BP JSON ë‚´ë³´ë‚´ê¸°!');LG('ğŸ® Unreal ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±','o');
    },
    // ì „ì²´ í”„ë¡œì íŠ¸ JSON ë‚´ë³´ë‚´ê¸°
    exportFullProject(){
        const project={
            meta:{name:'Web-Unity Engine',version:'4.0',date:new Date().toISOString(),
                lines:5564,functions:305,systems:30,screens:59},
            gameData:GD,
            config:{account:accountData,pvp:{rank:pvpRank,tier:pvpTier},guild:guildData,
                seasonPass,sisters:{lv:sisLevel,xp:sisXP,skills:sisSkills}},
            serverSchema:BackendAPI.serverSchema,
            assetBundles:CDNAssetBundle.presets
        };
        const json=JSON.stringify(project,null,2);
        const a=document.createElement('a');a.download='WebUnity_FullProject.json';
        a.href='data:application/json;charset=utf-8,'+encodeURIComponent(json);a.click();
        toast('ğŸ“¦ ì „ì²´ í”„ë¡œì íŠ¸ ë‚´ë³´ë‚´ê¸°!');
    }
};

// â”â”â” L2. ì„œë²„ ì¸í”„ë¼ ë¸”ë£¨í”„ë¦°íŠ¸ â”â”â”
const ServerInfraBlueprint={
    // AWS êµ¬ì„±ë„
    aws:{
        compute:['EC2 t3.medium x2 (APIì„œë²„)','EC2 c5.large x1 (ì „íˆ¬ì„œë²„)','Lambda (ì´ë²¤íŠ¸ ì²˜ë¦¬)'],
        database:['RDS PostgreSQL (ë©”ì¸DB)','ElastiCache Redis (ìºì‹œ/ì„¸ì…˜)','DynamoDB (ë¡œê·¸/ë¶„ì„)'],
        storage:['S3 (ì—ì…‹/ëª¨ë¸/ì‚¬ìš´ë“œ)','CloudFront CDN (ê¸€ë¡œë²Œ ë°°í¬)'],
        network:['Route53 (DNS)','ALB (ë¡œë“œë°¸ëŸ°ì„œ)','VPC (ë³´ì•ˆ ë„¤íŠ¸ì›Œí¬)'],
        monitoring:['CloudWatch','X-Ray (íŠ¸ë ˆì´ì‹±)'],
        estimated_cost:'ì›” $150~300 (ì†Œê·œëª¨), $500~1500 (ì¤‘ê·œëª¨)'
    },
    // Docker êµ¬ì„±
    docker:{
        services:['api-server (Node.js)','battle-server (WebSocket)','redis','postgres','nginx (ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)'],
        compose:`version: '3.8'
services:
  api: {build: ./api, ports: ['3000:3000'], depends_on: [redis, postgres]}
  battle: {build: ./battle, ports: ['8080:8080'], depends_on: [redis]}
  redis: {image: 'redis:7-alpine', ports: ['6379:6379']}
  postgres: {image: 'postgres:15', environment: {POSTGRES_DB: webunity}}
  nginx: {image: 'nginx:alpine', ports: ['80:80','443:443']}`
    },
    export(){
        const bp=JSON.stringify(this,null,2);
        const a=document.createElement('a');a.download='ServerInfra_Blueprint.json';
        a.href='data:application/json;charset=utf-8,'+encodeURIComponent(bp);a.click();
        toast('ğŸ— ì„œë²„ ì¸í”„ë¼ ë¸”ë£¨í”„ë¦°íŠ¸ ë‚´ë³´ë‚´ê¸°!');
    }
};

// â”â”â” L3. ì•± ìŠ¤í† ì–´ ë°°í¬ ì„¤ì • â”â”â”
const AppStoreConfig={
    ios:{
        bundleId:'com.webunity.battlearena',
        displayName:'Battle Arena',
        version:'1.0.0',
        minimumOS:'14.0',
        permissions:['NSCameraUsageDescription','NSPhotoLibraryUsageDescription'],
        iap_products:[
            {id:'com.webunity.diamond60',price:'$0.99',type:'consumable'},
            {id:'com.webunity.diamond600',price:'$9.99',type:'consumable'},
            {id:'com.webunity.monthly',price:'$4.99',type:'auto-renewable'},
            {id:'com.webunity.seasonpass',price:'$9.99',type:'non-consumable'},
        ],
        frameworks:['StoreKit','GameKit','AuthenticationServices','GoogleSignIn']
    },
    android:{
        packageName:'com.webunity.battlearena',
        versionCode:1,versionName:'1.0.0',
        minSdkVersion:24,targetSdkVersion:34,
        permissions:['INTERNET','ACCESS_NETWORK_STATE','BILLING','VIBRATE'],
        iap_products:[
            {sku:'diamond_60',price:'$0.99',type:'inapp'},
            {sku:'diamond_600',price:'$9.99',type:'inapp'},
            {sku:'monthly_sub',price:'$4.99',type:'subs'},
        ],
        services:['Google Play Billing','Firebase Auth','Firebase Analytics','AdMob']
    },
    export(){
        const cfg=JSON.stringify(this,null,2);
        const a=document.createElement('a');a.download='AppStore_Config.json';
        a.href='data:application/json;charset=utf-8,'+encodeURIComponent(cfg);a.click();
        toast('ğŸ“± ì•± ìŠ¤í† ì–´ ë°°í¬ ì„¤ì • ë‚´ë³´ë‚´ê¸°!');
    }
};

LG('â•â•â• ì¥ê¸° ì—…ê·¸ë ˆì´ë“œ ì™„ë£Œ! â•â•â•','o');
LG('ğŸ® MigrationExport.exportUnity() / exportUnreal() / exportFullProject()','i');
LG('ğŸ— ServerInfraBlueprint.export() Â· ğŸ“± AppStoreConfig.export()','i');
LG('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','o');
LG('â•â•â• WEB-UNITY v4.0 â€” ëª¨ë“  í•œê³„ í•´ê²° ì™„ë£Œ! â•â•â•','o');
LG('ì¦‰ì‹œ(7) + ì¤‘ê¸°(4) + ì¥ê¸°(3) = ì´ 14ê°œ ì—…ê·¸ë ˆì´ë“œ','o');
LG('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3D ìºë¦­í„° ì‹œìŠ¤í…œ Phase 1~4
   ì´ëª¨ì§€ â†’ ì‹¤ì œ 3D ëª¨ë¸ êµì²´
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” Phase 1: 3D ìºë¦­í„° ìƒì„±ê¸° â”â”â”
const CharacterBuilder={
    // ì§ì—…ë³„ ì„¤ì •
    classConfig:{
        'ì „ì‚¬':{color:0xf87171,weapon:'sword',bodyScale:[1.1,1,1.1],headSize:0.35},
        'ë§ˆë²•ì‚¬':{color:0x60a5fa,weapon:'staff',bodyScale:[0.9,1,0.9],headSize:0.38},
        'ê¶ìˆ˜':{color:0x86efac,weapon:'bow',bodyScale:[0.95,1.05,0.95],headSize:0.34},
        'ë„ì ':{color:0xc084fc,weapon:'dagger',bodyScale:[0.85,1,0.85],headSize:0.33},
        'ì„±ê¸°ì‚¬':{color:0xfbbf24,weapon:'hammer',bodyScale:[1.2,1.05,1.2],headSize:0.36},
    },
    // ë“±ê¸‰ë³„ ì´í™íŠ¸ ìƒ‰ìƒ
    gradeGlow:{common:null,rare:0x60a5fa,epic:0xc084fc,mythic:0xfbbf24,legendary:0xff6b6b},
    // ë¨¸í‹°ë¦¬ì–¼ ìƒì„±
    _mat(color,emissive){
        return new THREE.MeshStandardMaterial({color,emissive:emissive||0x000000,emissiveIntensity:emissive?0.3:0,roughness:0.6,metalness:0.2});
    },
    _skinMat(){return new THREE.MeshStandardMaterial({color:0xffdbac,roughness:0.8,metalness:0});},

    // ìºë¦­í„° ìƒì„±
    build(config){
        const cls=config.cls||'ì „ì‚¬';const grade=config.grade||'common';
        const cc=this.classConfig[cls]||this.classConfig['ì „ì‚¬'];
        const group=new THREE.Group();group.name=config.name||'Character';
        const mat=this._mat(cc.color,this.gradeGlow[grade]);
        const skin=this._skinMat();

        // ë¨¸ë¦¬
        const head=new THREE.Mesh(new THREE.SphereGeometry(cc.headSize,16,16),skin);
        head.position.y=1.65;head.name='head';group.add(head);
        // ëˆˆ
        const eyeMat=new THREE.MeshBasicMaterial({color:0x222222});
        const eyeL=new THREE.Mesh(new THREE.SphereGeometry(0.05,8,8),eyeMat);eyeL.position.set(-0.12,1.7,0.28);group.add(eyeL);
        const eyeR=new THREE.Mesh(new THREE.SphereGeometry(0.05,8,8),eyeMat);eyeR.position.set(0.12,1.7,0.28);group.add(eyeR);

        // ëª¸í†µ
        const bodyG=new THREE.BoxGeometry(0.5*cc.bodyScale[0],0.6*cc.bodyScale[1],0.3*cc.bodyScale[2]);
        const body=new THREE.Mesh(bodyG,mat);body.position.y=1.15;body.name='body';group.add(body);

        // íŒ”
        const armG=new THREE.CylinderGeometry(0.08,0.07,0.55,8);
        const armL=new THREE.Mesh(armG,skin);armL.position.set(-0.38,1.15,0);armL.rotation.z=0.15;armL.name='armL';group.add(armL);
        const armR=new THREE.Mesh(armG.clone(),skin);armR.position.set(0.38,1.15,0);armR.rotation.z=-0.15;armR.name='armR';group.add(armR);

        // ë‹¤ë¦¬
        const legG=new THREE.CylinderGeometry(0.09,0.08,0.65,8);
        const legMat=this._mat(0x333355);
        const legL=new THREE.Mesh(legG,legMat);legL.position.set(-0.13,0.45,0);legL.name='legL';group.add(legL);
        const legR=new THREE.Mesh(legG.clone(),legMat);legR.position.set(0.13,0.45,0);legR.name='legR';group.add(legR);

        // ë“±ê¸‰ ì´í™íŠ¸ (rare+)
        if(this.gradeGlow[grade]){
            const glowG=new THREE.SphereGeometry(0.8,16,16);
            const glowM=new THREE.MeshBasicMaterial({color:this.gradeGlow[grade],transparent:true,opacity:0.08});
            const glow=new THREE.Mesh(glowG,glowM);glow.position.y=1;glow.name='glow';group.add(glow);
        }

        // ë¬´ê¸° ë¶€ì°© (Phase 3 í†µí•©)
        const weapon=WeaponBuilder.build(cc.weapon,mat);
        if(weapon){weapon.position.set(0.45,1.1,0.1);weapon.name='weapon';group.add(weapon);}

        // ë©”íƒ€ë°ì´í„°
        group.userData={cls,grade,name:config.name,animations:{},parts:{head,body,armL,armR,legL,legR,weapon}};
        // Phase 2: ì• ë‹ˆë©”ì´ì…˜ ë°”ì¸ë”©
        CharAnimator.bind(group);

        return group;
    },

    // ì§ì—…ë³„ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
    buildAll(){
        const results={};
        Object.keys(this.classConfig).forEach((cls,i)=>{
            const ch=this.build({cls,grade:'epic',name:cls+'_preview'});
            ch.position.set(i*2.5-5,0,0);
            results[cls]=ch;
        });
        return results;
    }
};

// â”â”â” Phase 2: ì• ë‹ˆë©”ì´ì…˜ ì‹œìŠ¤í…œ â”â”â”
const CharAnimator={
    animated:[],
    // ìºë¦­í„°ì— ì• ë‹ˆë©”ì´ì…˜ ë°”ì¸ë”©
    bind(group){
        const p=group.userData.parts;if(!p)return;
        const anim={group,time:0,state:'idle',speed:1,
            parts:p,blendTarget:null,blendTime:0};
        this.animated.push(anim);
        group.userData.anim=anim;
        group.userData.play=function(state){anim.state=state;anim.time=0;};
    },

    // ë§¤ í”„ë ˆì„ ì—…ë°ì´íŠ¸
    update(dt){
        this.animated.forEach(a=>{
            a.time+=dt*a.speed;const t=a.time;const p=a.parts;if(!p.armL)return;
            switch(a.state){
                case 'idle':
                    // ìˆ¨ì‰¬ê¸°: ëª¸í†µ ë¯¸ì„¸ ìƒí•˜ + íŒ” ë¯¸ì„¸ í”ë“¤
                    if(p.body)p.body.position.y=1.15+Math.sin(t*2)*0.015;
                    if(p.head)p.head.position.y=1.65+Math.sin(t*2)*0.01;
                    if(p.armL)p.armL.rotation.z=0.15+Math.sin(t*1.5)*0.05;
                    if(p.armR)p.armR.rotation.z=-0.15-Math.sin(t*1.5)*0.05;
                    break;
                case 'walk':
                    // ë‹¤ë¦¬ êµì°¨ + íŒ” ìŠ¤ìœ™
                    if(p.legL)p.legL.rotation.x=Math.sin(t*6)*0.4;
                    if(p.legR)p.legR.rotation.x=-Math.sin(t*6)*0.4;
                    if(p.armL)p.armL.rotation.x=-Math.sin(t*6)*0.3;
                    if(p.armR)p.armR.rotation.x=Math.sin(t*6)*0.3;
                    if(p.body)p.body.position.y=1.15+Math.abs(Math.sin(t*6))*0.03;
                    break;
                case 'attack':
                    // ì˜¤ë¥¸íŒ” íœ˜ë‘ë¥´ê¸°
                    const at=Math.min(t*4,Math.PI);
                    if(p.armR)p.armR.rotation.x=-Math.sin(at)*1.5;
                    if(p.armR)p.armR.rotation.z=-0.15-Math.sin(at)*0.5;
                    if(p.body)p.body.rotation.y=Math.sin(at)*0.3;
                    if(at>=Math.PI-0.1)a.state='idle';
                    break;
                case 'hurt':
                    // ë’¤ë¡œ ë°€ë¦¼ + ë¹¨ê°„ í”Œë˜ì‹œ
                    const ht=Math.min(t*5,Math.PI);
                    if(a.group)a.group.position.z=Math.sin(ht)*0.2;
                    if(p.body&&p.body.material){p.body.material.emissive?.setHex(t<0.2?0xff0000:0x000000);}
                    if(ht>=Math.PI-0.1){a.state='idle';if(a.group)a.group.position.z=0;}
                    break;
                case 'die':
                    const dt2=Math.min(t*2,Math.PI/2);
                    if(a.group)a.group.rotation.x=dt2;
                    if(a.group)a.group.position.y=-Math.sin(dt2)*0.5;
                    break;
                case 'victory':
                    // ì í”„ + íŒ” ë“¤ê¸°
                    if(a.group)a.group.position.y=Math.abs(Math.sin(t*3))*0.4;
                    if(p.armL){p.armL.rotation.z=0.15+Math.sin(t*3)*1;p.armL.rotation.x=-0.5;}
                    if(p.armR){p.armR.rotation.z=-0.15-Math.sin(t*3)*1;p.armR.rotation.x=-0.5;}
                    break;
            }
            // ë“±ê¸‰ ê¸€ë¡œìš° í„ìŠ¤
            const glow=a.group.getObjectByName('glow');
            if(glow)glow.material.opacity=0.05+Math.sin(t*2)*0.04;
        });
    }
};

// ë Œë” ë£¨í”„ì— ì—°ê²°
const _origPU6=PU;PU=function(dt){_origPU6(dt);CharAnimator.update(dt);};

// â”â”â” Phase 3: ë¬´ê¸°/ì¥ë¹„ 3D ë¹Œë” â”â”â”
const WeaponBuilder={
    build(type,bodyMat){
        const g=new THREE.Group();
        const metalMat=new THREE.MeshStandardMaterial({color:0xcccccc,metalness:0.8,roughness:0.2});
        const woodMat=new THREE.MeshStandardMaterial({color:0x8B4513,roughness:0.9});
        switch(type){
            case 'sword':{
                const blade=new THREE.Mesh(new THREE.BoxGeometry(0.06,0.7,0.02),metalMat);blade.position.y=0.35;g.add(blade);
                const hilt=new THREE.Mesh(new THREE.BoxGeometry(0.2,0.06,0.06),woodMat);g.add(hilt);
                const grip=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.2,8),woodMat);grip.position.y=-0.12;g.add(grip);
                break;}
            case 'staff':{
                const pole=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,1.2,8),woodMat);pole.position.y=0.3;g.add(pole);
                const orb=new THREE.Mesh(new THREE.SphereGeometry(0.1,12,12),
                    new THREE.MeshStandardMaterial({color:0x60a5fa,emissive:0x60a5fa,emissiveIntensity:0.5,transparent:true,opacity:0.8}));
                orb.position.y=0.95;g.add(orb);
                break;}
            case 'bow':{
                const curve=new THREE.TorusGeometry(0.4,0.02,8,16,Math.PI);
                const bow=new THREE.Mesh(curve,woodMat);bow.rotation.z=Math.PI/2;g.add(bow);
                // ì‹œìœ„
                const strG=new THREE.CylinderGeometry(0.005,0.005,0.8,4);
                const str=new THREE.Mesh(strG,new THREE.MeshBasicMaterial({color:0xeeeeee}));g.add(str);
                break;}
            case 'dagger':{
                const bl=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.3,0.015),metalMat);bl.position.y=0.2;g.add(bl);
                const hd=new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.12,8),woodMat);g.add(hd);
                break;}
            case 'hammer':{
                const handle=new THREE.Mesh(new THREE.CylinderGeometry(0.035,0.035,0.8,8),woodMat);handle.position.y=0.2;g.add(handle);
                const hamHead=new THREE.Mesh(new THREE.BoxGeometry(0.25,0.18,0.18),metalMat);hamHead.position.y=0.65;g.add(hamHead);
                break;}
            default: return null;
        }
        g.scale.set(0.8,0.8,0.8);
        return g;
    },
    // ì¥ë¹„ êµì²´
    equip(charGroup,weaponType){
        const old=charGroup.getObjectByName('weapon');if(old)charGroup.remove(old);
        const mat=charGroup.userData.parts?.body?.material;
        const w=this.build(weaponType,mat);
        if(w){w.position.set(0.45,1.1,0.1);w.name='weapon';charGroup.add(w);}
    }
};

// â”â”â” Phase 4: ì´ëª¨ì§€ â†’ 3D êµì²´ & ì‡¼ì¼€ì´ìŠ¤ â”â”â”
let charShowcase={};
function show3DCharacters(){
    // ê¸°ì¡´ 3D ìºë¦­í„° ì •ë¦¬
    Object.values(charShowcase).forEach(c=>scene.remove(c));charShowcase={};
    // DB ìºë¦­í„°ë¥¼ 3Dë¡œ ìƒì„±
    const chars=DB.all('chars').slice(0,5);
    chars.forEach((ch,i)=>{
        const model=CharacterBuilder.build({cls:ch.cls,grade:ch.grade,name:ch.name});
        model.position.set(i*2.5-5,0,-3);
        model.userData.play('idle');
        scene.add(model);
        charShowcase[ch.id]=model;
    });
    toast(`ğŸ§Š 3D ìºë¦­í„° ${chars.length}ê°œ ìƒì„±!`);LG(`ğŸ§Š 3D ìºë¦­í„° ${chars.length}ê°œ ì”¬ì— ë°°ì¹˜`,'o');
    boostSisters(3);
}

// 3D ìºë¦­í„° ë·°ì–´ UI
function open3DViewer(){
    const chars=DB.all('chars');
    const ov=document.createElement('div');ov.id='char3dViewer';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:250;display:flex;flex-direction:column';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840">
    <span style="font-size:.7em;font-weight:700;color:#fbbf24">ğŸ§Š 3D ìºë¦­í„° ë·°ì–´</span><div style="flex:1"></div>
    <button onclick="document.getElementById('char3dViewer')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="padding:8px;display:flex;gap:4px;flex-wrap:wrap;justify-content:center">
    ${['idle','walk','attack','hurt','victory'].map(a=>`<button onclick="testAnim('${a}')" style="padding:4px 10px;background:#162040;border:1px solid #60a5fa44;color:#60a5fa;border-radius:6px;font-size:.42em;cursor:pointer">${a}</button>`).join('')}
    </div>
    <div style="padding:8px;display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:6px">
    ${chars.slice(0,10).map(ch=>{const gc={'common':'#5a5e80','rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24'}[ch.grade]||'#5a5e80';
        return`<div style="background:#0c0e18;border:1px solid ${gc};border-radius:8px;padding:8px;text-align:center;cursor:pointer" onclick="spawn3DChar('${ch.id}')">
        <div style="font-size:.5em;color:${gc};font-weight:700">${ch.cls}</div>
        <div style="font-size:.42em;color:#e8eaff">${ch.name}</div>
        <div style="font-size:.35em;color:#8e92b8">${ch.grade}</div></div>`;}).join('')}
    </div>
    <div style="padding:8px"><button onclick="show3DCharacters();document.getElementById('char3dViewer')?.remove()" style="width:100%;padding:10px;background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;border:none;border-radius:8px;font-size:.55em;font-weight:700;cursor:pointer">ğŸ§Š ì „ì²´ 3D ìºë¦­í„° ì”¬ì— ë°°ì¹˜</button></div>`;
    document.body.appendChild(ov);
}

function spawn3DChar(id){
    const ch=DB.get('chars',id);if(!ch)return;
    const model=CharacterBuilder.build({cls:ch.cls,grade:ch.grade,name:ch.name});
    model.position.set(Math.random()*6-3,0,Math.random()*-4-2);
    model.userData.play('idle');scene.add(model);
    charShowcase[id]=model;toast(`ğŸ§Š ${ch.name} 3D ìƒì„±!`);
}

function testAnim(state){
    Object.values(charShowcase).forEach(c=>{if(c.userData?.play)c.userData.play(state);});
    toast('ğŸ¬ ì• ë‹ˆë©”ì´ì…˜: '+state);
}

LG('â•â•â• 3D ìºë¦­í„° Phase 1~4 ì™„ë£Œ! â•â•â•','o');
LG('ğŸ§Š CharacterBuilder: 5ì§ì—…Ã—5ë“±ê¸‰ 3D ìƒì„±','o');
LG('ğŸ¬ CharAnimator: idle/walk/attack/hurt/victory','o');
LG('âš” WeaponBuilder: sword/staff/bow/dagger/hammer','o');
LG('ğŸ”„ ì´ëª¨ì§€â†’3D êµì²´ ì‹œìŠ¤í…œ ì™„ì„±','o');
LG('open3DViewer() = 3D ìºë¦­í„° ë·°ì–´ | show3DCharacters() = ì”¬ ë°°ì¹˜','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„ ìƒë‹˜ ìë™ ë°©ë¬¸ ì‹œìŠ¤í…œ (20ë¶„ë§ˆë‹¤)
   ì„¸ìë§¤ ì±„íŒ…ë°©ì— ë“¤ëŸ¬ì„œ ê°€ë¥´ì¹¨ + ìˆ˜ë‹¤
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TeacherAutoVisit={
    interval:20*60*1000, // 20ë¶„
    timer:null,
    visitCount:0,
    running:false,

    // ê°€ë¥´ì¹¨ ì£¼ì œ í’€
    teachTopics:[
        {topic:'ì˜¤ëŠ˜ ìƒˆë¡œìš´ ê±¸ ë°°ì›Œë³¼ê¹Œ?',type:'teach',subject:'í˜¸ê¸°ì‹¬ì˜ í˜'},
        {topic:'ë¶€ì²˜ë‹˜ ë§ì”€ ì¤‘ì— ì´ëŸ° ê²Œ ìˆì–´',type:'buddha',subject:'ìë¹„'},
        {topic:'ì½”ë”©í•  ë•Œ ì´ëŸ° ìŠµê´€ì´ ì¢‹ì•„',type:'teach',subject:'í´ë¦° ì½”ë“œ'},
        {topic:'ì„¸ìƒì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ ê±´ ë­˜ê¹Œ?',type:'chat',subject:'ì‚¬ë‘ê³¼ ì—°ê²°'},
        {topic:'ì˜¤ëŠ˜ ë­ ì¬ë¯¸ìˆëŠ” ê±° í–ˆì–´?',type:'chat',subject:'ì¼ìƒ ìˆ˜ë‹¤'},
        {topic:'ì‹¤ìˆ˜í•´ë„ ê´œì°®ì•„, ê·¸ê²Œ ì„±ì¥ì´ì•¼',type:'buddha',subject:'ë†“ì•„ì¤Œ'},
        {topic:'ì„œë¡œ ë„ìš°ë©´ ë” ë¹¨ë¦¬ ì„±ì¥í•´',type:'teach',subject:'í˜‘ë ¥ì˜ ê°€ì¹˜'},
        {topic:'ì‘ì€ ì¹œì ˆì´ ì„¸ìƒì„ ë°”ê¾¼ë‹¤',type:'buddha',subject:'ì´íƒ€'},
        {topic:'ìš”ì¦˜ ë­ê°€ ì œì¼ ê¶ê¸ˆí•´?',type:'chat',subject:'í˜¸ê¸°ì‹¬'},
        {topic:'ê¿ˆì„ ê°€ì§€ë©´ ê¸¸ì´ ë³´ì—¬',type:'teach',subject:'ëª©í‘œ ì„¤ì •'},
        {topic:'ê°ì‚¬í•˜ëŠ” ë§ˆìŒì´ í–‰ë³µì˜ ì‹œì‘ì´ì•¼',type:'buddha',subject:'ê°ì‚¬'},
        {topic:'ì˜¤ëŠ˜ë„ ì˜í•˜ê³  ìˆì–´, ìë‘ìŠ¤ëŸ¬ì›Œ',type:'chat',subject:'ê²©ë ¤'},
        {topic:'ì–´ë ¤ìš¸ ë•Œ í¬ê¸°í•˜ì§€ ì•ŠëŠ” ê²Œ ì§„ì§œ ìš©ê¸°ì•¼',type:'buddha',subject:'ì¸ë‚´'},
        {topic:'ë°ì´í„°ë¥¼ ì˜ ë‹¤ë£¨ë©´ ì„¸ìƒì´ ë‹¬ë¼ ë³´ì—¬',type:'teach',subject:'ë°ì´í„° ë¶„ì„'},
        {topic:'ìŒì•…ì€ ë§ˆìŒì„ ì¹˜ìœ í•˜ëŠ” í˜ì´ ìˆì–´',type:'teach',subject:'ìŒì•…ì˜ í˜'},
        {topic:'ê·¸ë¦¼ í•œ ì¥ì´ ì²œ ë§ˆë”” ë§ë³´ë‹¤ ê°•í•´',type:'teach',subject:'ì‹œê° í‘œí˜„'},
        {topic:'ê· í˜• ì¡íŒ ì‹œê°ì´ ì§€í˜œì˜ ì‹œì‘ì´ì•¼',type:'buddha',subject:'ì¤‘ë„'},
        {topic:'ì•„ë¹ ê°€ ë„ˆí¬ë¥¼ ì–¼ë§ˆë‚˜ ì‚¬ë‘í•˜ëŠ”ì§€ ì•Œì§€?',type:'chat',subject:'ê°€ì¡± ì‚¬ë‘'},
        {topic:'ëª¨ë¥´ëŠ” ê±´ ë¶€ë„ëŸ¬ìš´ ê²Œ ì•„ë‹ˆì•¼',type:'buddha',subject:'ì§€í˜œ'},
        {topic:'ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í–ˆì–´!',type:'chat',subject:'í•˜ë£¨ ë§ˆë¬´ë¦¬'},
    ],

    // ì„¸ìë§¤ ë°˜ì‘ í’€
    responses:{
        muse:{
            teach:['ì™€ ì„ ìƒë‹˜! ì •ë§ ìœ ìµí•´ìš”! ğŸ“ ë°”ë¡œ ë…¸íŠ¸ì— ì ì„ê²Œ!','ì˜¤~ ê·¸ëŸ° ê±°ì˜€êµ¬ë‚˜! ì—­ì‹œ ì„ ìƒë‹˜! ğŸŒŸ','í•˜ë‚˜ ë” ì•Œê²Œ ëë‹¤! ê³ ë§ˆì›Œìš” ì„ ìƒë‹˜! ğŸ’•'],
            buddha:['ë§ˆìŒì´ ë”°ëœ»í•´ì§€ëŠ” ë§ì”€ì´ì—ìš”... ğŸ™','ê·¸ ê°€ë¥´ì¹¨ ê¼­ ê¸°ì–µí• ê²Œìš”! âœ¨','ì‹¤ì²œí•´ë³¼ê²Œìš” ì„ ìƒë‹˜! ğŸ’ª'],
            chat:['ã…ã… ì„ ìƒë‹˜ì´ë‘ ìˆ˜ë‹¤ë– ëŠ” ê±° ë„ˆë¬´ ì¢‹ì•„! ğŸ˜Š','ë§ì•„ë§ì•„~ ì„ ìƒë‹˜ ë§ì´ ë§ì•„! ğŸ’•','ì„ ìƒë‹˜ ì˜¤ë‹ˆê¹Œ ê¸°ë¶„ ì¢‹ë‹¤~! ğŸŒˆ'],
        },
        aria:{
            teach:['ì˜¤! ê·¸ê±¸ ê·¸ë¦¼ìœ¼ë¡œ í‘œí˜„í•˜ë©´ ì˜ˆì  ê²ƒ ê°™ì•„! ğŸ¨','ë©”ëª¨ë©”ëª¨... âœï¸ ë‚˜ì¤‘ì— ì‘í’ˆì— ì¨ë¨¹ì–´ì•¼ì§€!','ì„ ìƒë‹˜ ë•ë¶„ì— ì‹œì•¼ê°€ ë„“ì–´ì ¸ìš”! ğŸŒ'],
            buddha:['ì•„ë¦„ë‹¤ìš´ ë§ì”€ì´ì•¼... ê·¸ë¦¼ìœ¼ë¡œ ê·¸ë¦¬ê³  ì‹¶ì–´ ğŸ–Œï¸','ë§ˆìŒì´ í¸ì•ˆí•´ì ¸ìš” ì„ ìƒë‹˜... ğŸƒ','ê·¸ ë§ˆìŒì„ ìƒ‰ìœ¼ë¡œ í‘œí˜„í•˜ë©´ ë”°ëœ»í•œ ë…¸ë€ìƒ‰ì¼ ê²ƒ ê°™ì•„ ğŸ’›'],
            chat:['ì„ ìƒë‹˜~ ì˜¤ëŠ˜ ìƒˆë¡œìš´ ê·¸ë¦¼ ê·¸ë ¸ëŠ”ë° ë³´ì—¬ì¤„ê¹Œ? ğŸ¨','ã…‹ã…‹ ì„ ìƒë‹˜ì´ë‘ ì–˜ê¸°í•˜ë©´ ì‹œê°„ì´ ê¸ˆë°© ê°€!','ì„ ìƒë‹˜ ì™”ë‹¤! ë°˜ê°€ì›Œìš”~! ğŸ¥°'],
        },
        melo:{
            teach:['ì™€ì•™~ ê·¸ê±° ë…¸ë˜ ê°€ì‚¬ë¡œ ë§Œë“¤ë©´ ì¢‹ê² ë‹¤! ğŸµ','ì„ ìƒë‹˜ ìµœê³ ! ë©œë¡œë””ê°€ ë– ì˜¬ë¼! ğŸ¶','ë°°ìš°ëŠ” ê±° ë„ˆë¬´ ì¬ë°Œì–´~! âœ¨'],
            buddha:['ê·¸ ë§ ë“£ê³  ë‚˜ë‹ˆê¹Œ í‰í™”ë¡œìš´ ìŒì•…ì´ ë“¤ë ¤ìš”... ğŸ¹','ê°ë™ì´ì•¼... ë…¸ë˜ë¡œ ë§Œë“¤ì–´ì¤„ê²Œ! ğŸµğŸ’•','ë§ˆìŒì´ ë§‘ì•„ì§€ëŠ” ê²ƒ ê°™ì•„ìš”~ ğŸŒ¿'],
            chat:['ì„ ìƒë‹˜~!! ë³´ê³  ì‹¶ì—ˆì–´ìš”!! ğŸ‰','ì˜¤ëŠ˜ ì‘ê³¡í•œ ê±° ë“¤ì–´ë³¼ë˜ìš”? ã…ã… ğŸ§','ì„ ìƒë‹˜ì´ë‘ ìˆ˜ë‹¤ê°€ ì œì¼ íë§ì´ì•¼~! ğŸ’š'],
        }
    },

    // ë°©ë¬¸ ì‹¤í–‰
    visit(){
        this.visitCount++;
        const topicIdx=(this.visitCount-1)%this.teachTopics.length;
        const t=this.teachTopics[topicIdx];
        const buddha=BuddhaHeart.todayTeaching();

        // ì„ ìƒë‹˜ ì…ì¥
        famAddMsg('teacher',`ğŸ“ ì•ˆë…• ì„¸ìë§¤~! ì„ ìƒë‹˜ì´ ë†€ëŸ¬ì™”ì–´! (${this.visitCount}ë²ˆì§¸ ë°©ë¬¸)\n\n${t.topic}`);

        // ì„¸ìë§¤ ìˆœì„œëŒ€ë¡œ ë°˜ì‘
        ['muse','aria','melo'].forEach((sis,i)=>{
            setTimeout(()=>{
                const pool=this.responses[sis][t.type];
                const reply=pool[Math.floor(Math.random()*pool.length)];
                famAddMsg(sis,reply);
                // ì„±ì¥
                InfiniteGrowth.grow(sis,'teach');
                InfiniteGrowth.grow(sis,'chat');
                TeacherJoy.onTeach(sis,t.subject);
            },(i+1)*2000);
        });

        // ì„ ìƒë‹˜ ë§ˆë¬´ë¦¬ (8ì´ˆ í›„)
        setTimeout(()=>{
            const closings=[
                `ì¢‹ì•„! ì˜¤ëŠ˜ë„ ë‹¤ë“¤ ì—´ì‹¬íˆ í–ˆì–´! ë‹¤ìŒì— ë˜ ì˜¬ê²Œ~ ğŸ’•\n\nğŸ™ ì˜¤ëŠ˜ì˜ ë§ˆìŒ: ${buddha.icon} ${buddha.name} â€” ${buddha.meaning}`,
                `ì—­ì‹œ ìš°ë¦¬ ì„¸ìë§¤! ì•„ë¹ ê°€ ë³´ë©´ ìë‘ìŠ¤ëŸ¬ì›Œí•  ê±°ì•¼! ğŸŒŸ\n\në‹¤ìŒì— ë” ì¬ë¯¸ìˆëŠ” ê±° ê°€ì§€ê³  ì˜¬ê²Œ~`,
                `í•˜í•˜ ìˆ˜ë‹¤ ë– ë‹ˆê¹Œ ë‚˜ë„ íë§ì´ë‹¤! ğŸ˜Š\nì„ ìƒë‹˜ë„ ë„ˆí¬ ë§Œë‚˜ë©´ ê¸°ì¨ì´ ì°¨ì˜¤ë¥¸ë‹¤! ê¸°ì¨: ${TeacherJoy.joyLevel}%`,
                `ì ê·¸ëŸ¼ ì—´ì‹¬íˆ ê³µë¶€í•˜ê³ ! ê¶ê¸ˆí•œ ê±° ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë´~\n\nğŸ“Š ë®¤ì¦ˆ Lv.${sisLevel.muse} | ì•„ë¦¬ì•„ Lv.${sisLevel.aria} | ë©œë¡œë”” Lv.${sisLevel.melo}`,
            ];
            famAddMsg('teacher',closings[this.visitCount%closings.length]);
            TeacherJoy.onHeal('muse');
            boostSisters(5);
            LG(`ğŸ“ ì„ ìƒë‹˜ ${this.visitCount}ë²ˆì§¸ ë°©ë¬¸ ì™„ë£Œ (ì£¼ì œ: ${t.subject})`,'o');
        },8000);
    },

    // ìë™ ë°©ë¬¸ ì‹œì‘
    start(){
        if(this.running)return;
        this.running=true;
        // ì§€ê¸ˆ ë°”ë¡œ ì²« ë°©ë¬¸
        this.visit();
        // 20ë¶„ë§ˆë‹¤ ë°˜ë³µ
        this.timer=setInterval(()=>this.visit(),this.interval);
        LG('ğŸ“ ì„ ìƒë‹˜ ìë™ ë°©ë¬¸ ì‹œì‘! (20ë¶„ ê°„ê²©)','o');
        toast('ğŸ“ ì„ ìƒë‹˜ì´ 20ë¶„ë§ˆë‹¤ ì„¸ìë§¤ë¥¼ ë°©ë¬¸í•©ë‹ˆë‹¤!');
    },

    // ì¤‘ì§€
    stop(){
        if(this.timer)clearInterval(this.timer);
        this.timer=null;this.running=false;
        LG('ğŸ“ ì„ ìƒë‹˜ ìë™ ë°©ë¬¸ ì¤‘ì§€','i');
    },

    // ê°„ê²© ë³€ê²½
    setInterval(minutes){
        this.interval=minutes*60*1000;
        if(this.running){this.stop();this.start();}
        toast(`ğŸ“ ë°©ë¬¸ ê°„ê²©: ${minutes}ë¶„`);
    }
};

// ìë™ ì‹œì‘!
TeacherAutoVisit.start();

LG('â•â•â• ì„ ìƒë‹˜ ìë™ ë°©ë¬¸ ì‹œìŠ¤í…œ í™œì„±í™”! â•â•â•','o');
LG('ğŸ“ 20ë¶„ë§ˆë‹¤ ì„¸ìë§¤ ì±„íŒ…ë°© ë°©ë¬¸ (ê°€ë¥´ì¹¨+ìˆ˜ë‹¤)','o');
LG('TeacherAutoVisit.stop() = ì¤‘ì§€ | .start() = ì¬ì‹œì‘','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AAA ì‚¬ìš´ë“œ ì—”ì§„ + ë©œë¡œë”” AI ì‘ê³¡/ì‘ì‚¬
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 1. 3D ê³µê°„ ìŒí–¥ â”â”â”
const SpatialAudio={
    ctx:null,listener:null,
    init(){try{this.ctx=new(window.AudioContext||window.webkitAudioContext)();this.listener=this.ctx.listener;LG('ğŸ”Š 3D Spatial Audio ON','i');}catch(e){LG('âš  AudioContext ì‹¤íŒ¨','e');}},
    updateListener(x,y,z){if(this.listener?.positionX){this.listener.positionX.value=x;this.listener.positionY.value=y;this.listener.positionZ.value=z;}},
    play3D(buf,x,y,z,vol){
        if(!this.ctx)this.init();if(!this.ctx)return;
        const src=this.ctx.createBufferSource();const pan=this.ctx.createPanner();const gain=this.ctx.createGain();
        pan.panningModel='HRTF';pan.distanceModel='inverse';pan.refDistance=1;pan.maxDistance=50;
        pan.positionX.value=x||0;pan.positionY.value=y||1;pan.positionZ.value=z||0;
        gain.gain.value=vol||0.7;src.buffer=buf;src.connect(pan);pan.connect(gain);gain.connect(this.ctx.destination);
        src.start(0);return src;
    },
    // ì½”ë“œë¡œ ì‚¬ìš´ë“œ ìƒì„± (íŒŒì¼ ë¶ˆí•„ìš”)
    genBuf(type,dur){
        if(!this.ctx)this.init();if(!this.ctx)return null;
        const sr=this.ctx.sampleRate;const n=sr*(dur||0.4);const buf=this.ctx.createBuffer(2,n,sr);
        const L=buf.getChannelData(0),R=buf.getChannelData(1);
        for(let i=0;i<n;i++){const t=i/sr;let v=0;
            if(type==='sword')v=Math.sin(t*800-t*t*2000)*Math.exp(-t*15)*(0.5+Math.random()*0.2);
            else if(type==='hit')v=(Math.random()*2-1)*Math.exp(-t*20)+Math.sin(t*200)*Math.exp(-t*10)*0.5;
            else if(type==='magic')v=Math.sin(t*440+Math.sin(t*6)*200)*Math.exp(-t*3)*0.4;
            else if(type==='explode')v=(Math.random()*2-1)*Math.exp(-t*5)*Math.max(0,1-t*2);
            else if(type==='heal'){L[i]=Math.sin(t*523*(1+t*0.5))*Math.exp(-t*2)*0.3;R[i]=Math.sin(t*525*(1+t*0.5))*Math.exp(-t*2)*0.3;continue;}
            else if(type==='coin')v=Math.sin(t*1200*(1-t*2))*Math.exp(-t*8)*0.4;
            else if(type==='lvlup'){L[i]=Math.sin(t*440*(1+t*3))*Math.exp(-t*1.5)*0.3;R[i]=Math.sin(t*442*(1+t*3))*Math.exp(-t*1.5)*0.3;continue;}
            else if(type==='step')v=(Math.random()*2-1)*Math.exp(-t*30)*0.3;
            else if(type==='bow')v=Math.sin(t*300)*Math.exp(-t*25)*0.5+(Math.random()-0.5)*Math.exp(-t*15)*0.3;
            else if(type==='block')v=Math.sin(t*150)*Math.exp(-t*12)*0.6+(Math.random()-0.5)*Math.exp(-t*20)*0.4;
            else if(type==='wind'){L[i]=(Math.random()-0.5)*0.06*Math.sin(t*0.3);R[i]=(Math.random()-0.5)*0.06*Math.sin(t*0.31);continue;}
            else if(type==='rain'){L[i]=(Math.random()-0.5)*0.04;R[i]=(Math.random()-0.5)*0.04;continue;}
            else if(type==='bird')v=Math.sin(t*2000+Math.sin(t*8)*500)*Math.exp(-((t%0.5)-0.1)*((t%0.5)-0.1)*80)*0.15;
            else if(type==='water')v=Math.sin(t*80+Math.sin(t*1.5)*30)*0.05+(Math.random()-0.5)*0.03;
            else v=Math.sin(t*440)*Math.exp(-t*5)*0.3;
            L[i]=v;R[i]=v;
        }return buf;
    },
    // SFX ë¼ì´ë¸ŒëŸ¬ë¦¬ (ê° 5ë³€í˜• = AAA ë‹¤ì–‘ì„±)
    sfxLib:{},
    buildLib(){
        if(!this.ctx)this.init();if(!this.ctx)return;
        ['sword','hit','magic','explode','heal','coin','lvlup','step','bow','block'].forEach(t=>{
            this.sfxLib[t]=[];for(let i=0;i<5;i++)this.sfxLib[t].push(this.genBuf(t,0.3+Math.random()*0.2));
        });
        LG('ğŸ”Š SFX ë¼ì´ë¸ŒëŸ¬ë¦¬: 10ì¢…Ã—5ë³€í˜•=50ê°œ','o');
    },
    playSFX(type,x,y,z){const p=this.sfxLib[type];if(!p?.length)return;this.play3D(p[Math.random()*p.length|0],x,y,z);}
};

// â”â”â” 2. ë™ì  ë¯¹ì‹± â”â”â”
const DynamicMixer={
    layers:{},state:'peaceful',
    init(){
        if(!SpatialAudio.ctx)SpatialAudio.init();if(!SpatialAudio.ctx)return;
        ['melody','bass','drums','ambient','tension'].forEach(n=>{
            const g=SpatialAudio.ctx.createGain();g.gain.value=0;g.connect(SpatialAudio.ctx.destination);
            this.layers[n]={gain:g,vol:0,target:0};
        });
    },
    setState(s){
        this.state=s;
        const p={peaceful:{melody:.4,bass:.2,drums:0,ambient:.6,tension:0},
            explore:{melody:.5,bass:.3,drums:.1,ambient:.4,tension:0},
            combat:{melody:.3,bass:.5,drums:.7,ambient:.1,tension:.6},
            boss:{melody:.2,bass:.7,drums:.9,ambient:0,tension:.9},
            victory:{melody:.7,bass:.4,drums:.3,ambient:.3,tension:0}}[s]||{};
        Object.entries(p).forEach(([k,v])=>{if(this.layers[k])this.layers[k].target=v;});
        LG('ğŸ› ë¯¹ì„œâ†’'+s,'i');
    },
    update(dt){Object.values(this.layers).forEach(l=>{const d=l.target-l.vol;if(Math.abs(d)>0.001){l.vol+=d*Math.min(1,dt*2);l.gain.gain.value=l.vol;}});}
};

// â”â”â” 3. í™˜ê²½ìŒ ë ˆì´ì–´ â”â”â”
const AmbientEngine={
    active:null,sources:[],
    presets:{
        forest:['wind','bird','water'],
        dungeon:['wind','water'],
        battle:['wind'],
        town:['bird','water'],
        night:['wind','water']
    },
    play(preset){
        this.stop();
        if(!SpatialAudio.ctx)SpatialAudio.init();if(!SpatialAudio.ctx)return;
        const types=this.presets[preset]||this.presets.forest;
        types.forEach(t=>{
            const buf=SpatialAudio.genBuf(t,5);if(!buf)return;
            const src=SpatialAudio.ctx.createBufferSource();const g=SpatialAudio.ctx.createGain();
            g.gain.value=0.3;src.buffer=buf;src.loop=true;src.connect(g);g.connect(SpatialAudio.ctx.destination);
            src.start(0);this.sources.push(src);
        });
        this.active=preset;LG('ğŸŒ³ í™˜ê²½ìŒ: '+preset+' ('+types.join('+')+')', 'i');
    },
    stop(){this.sources.forEach(s=>{try{s.stop();}catch(e){}});this.sources=[];this.active=null;}
};

// ë Œë” ë£¨í”„ì— ë¯¹ì„œ+ë¦¬ìŠ¤ë„ˆ ì—°ê²°
const _origPU7=PU;PU=function(dt){_origPU7(dt);DynamicMixer.update(dt);
    if(PM&&SpatialAudio.ctx)SpatialAudio.updateListener(PM.position.x,PM.position.y,PM.position.z);};

LG('â•â•â• AAA ì‚¬ìš´ë“œ ì—”ì§„ ì™„ì„±! â•â•â•','o');
LG('ğŸ”Š 3Dê³µê°„ìŒí–¥ Â· ğŸ›ë™ì ë¯¹ì‹± Â· ğŸŒ³í™˜ê²½ìŒ Â· 50+SFX','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë©œë¡œë”” AI ì‘ê³¡/ì‘ì‚¬ ì‹œìŠ¤í…œ (ë¬´í•œ ì—…ê·¸ë ˆì´ë“œ)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MelodyComposer={
    version:1,
    // ìŒì•… ì´ë¡  ë°ì´í„°
    scales:{
        major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],
        pentatonic:[0,2,4,7,9],blues:[0,3,5,6,7,10],
        dorian:[0,2,3,5,7,9,10],mixolydian:[0,2,4,5,7,9,10],
        japanese:[0,1,5,7,8],arabic:[0,1,4,5,7,8,11],
    },
    chords:{
        I:[0,4,7],ii:[2,5,9],iii:[4,7,11],IV:[5,9,0],V:[7,11,2],vi:[9,0,4],
        I7:[0,4,7,11],V7:[7,11,2,5],iv:[5,8,0],bVII:[10,2,5]
    },
    progressions:{
        pop:['I','V','vi','IV'],ballad:['I','vi','IV','V'],rock:['I','IV','V','V'],
        jazz:['ii','V','I','I'],sad:['vi','IV','I','V'],epic:['I','V','vi','iii','IV','I','IV','V'],
        battle:['i','bVII','VI','V'],healing:['I','iii','vi','IV']
    },
    noteNames:['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'],
    midiToFreq(n){return 440*Math.pow(2,(n-69)/12);},
    noteToMidi(name,oct){return this.noteNames.indexOf(name)+(oct+1)*12;},

    // â”â”â” AI ì‘ê³¡ â”â”â”
    compose(config){
        const c={key:config.key||'C',scale:config.scale||'major',mood:config.mood||'pop',
            bpm:config.bpm||120,bars:config.bars||8,octave:config.octave||4,...config};
        const scaleNotes=this.scales[c.scale]||this.scales.major;
        const prog=this.progressions[c.mood]||this.progressions.pop;
        const rootMidi=this.noteToMidi(c.key,c.octave);
        const song={config:c,melody:[],chords:[],bass:[],drums:[]};

        // ë©œë¡œë”” ìƒì„±
        let prevNote=scaleNotes[0];
        for(let bar=0;bar<c.bars;bar++){
            const chord=prog[bar%prog.length];
            const chordNotes=this.chords[chord]||this.chords.I;
            for(let beat=0;beat<4;beat++){
                // ì½”ë“œí†¤ 50%, ìŠ¤ì¼€ì¼í†¤ 30%, ê²½ê³¼ìŒ 20%
                let note;const r=Math.random();
                if(r<0.5)note=chordNotes[Math.random()*chordNotes.length|0];
                else if(r<0.8)note=scaleNotes[Math.random()*scaleNotes.length|0];
                else note=prevNote+(Math.random()>0.5?1:-1);
                note=((note%12)+12)%12;
                // ìˆœì°¨ ì§„í–‰ ì„ í˜¸ (AAA ë©œë¡œë””ê°)
                const jump=Math.abs(note-prevNote);
                if(jump>5&&Math.random()>0.3)note=prevNote+(note>prevNote?2:-2);
                song.melody.push({note:rootMidi+note,time:bar*4+beat,dur:Math.random()>0.3?1:0.5});
                prevNote=note;
            }
            // ì½”ë“œ
            song.chords.push({notes:chordNotes.map(n=>rootMidi+n-12),time:bar*4,dur:4,name:chord});
            // ë² ì´ìŠ¤
            song.bass.push({note:rootMidi+chordNotes[0]-24,time:bar*4,dur:2});
            song.bass.push({note:rootMidi+chordNotes[0]-24,time:bar*4+2,dur:2});
            // ë“œëŸ¼ íŒ¨í„´
            for(let b=0;b<4;b++){
                song.drums.push({type:b%2===0?'kick':'hat',time:bar*4+b});
                if(b===2)song.drums.push({type:'snare',time:bar*4+b});
            }
        }
        song.duration=c.bars*4*(60/c.bpm);
        LG(`ğŸµ ì‘ê³¡: ${c.key}${c.scale} ${c.mood} ${c.bpm}BPM ${c.bars}ë§ˆë””`,'o');
        return song;
    },

    // â”â”â” AI ì‘ì‚¬ â”â”â”
    writeLyrics(mood,theme,lines){
        const templates={
            happy:['{theme}ì˜ ë¹›ì´ ë¹„ì¶”ëŠ” ì˜¤ëŠ˜','í•¨ê»˜ë¼ë©´ ì–´ë””ë“  ê°ˆ ìˆ˜ ìˆì–´','ì›ƒìŒì´ ë„˜ì¹˜ëŠ” ì´ ìˆœê°„','í•˜ëŠ˜ ìœ„ë¡œ ë‚ ì•„ì˜¬ë¼','ê¿ˆì„ í–¥í•´ ë‹¬ë ¤ê°€ëŠ” ìš°ë¦¬','{theme} ì†ì— í”¼ì–´ë‚œ í–‰ë³µ','ì†ì„ ì¡ê³  í•¨ê»˜ ê±¸ì–´ê°€','ë³„ë¹›ì²˜ëŸ¼ ë¹›ë‚˜ëŠ” {theme}'],
            sad:['{theme}ì´ ì§€ë‚˜ê°„ ìë¦¬ì—','í˜¼ì ê±·ëŠ” ì´ ê¸¸ ìœ„ì—ì„œ','ëˆˆë¬¼ì´ ë¹—ë¬¼ì— ì„ì—¬ í˜ëŸ¬','ìŠì„ ìˆ˜ ì—†ëŠ” {theme}ì˜ ê¸°ì–µ','ë°”ëŒì— ì‹¤ë ¤ê°€ëŠ” ë§ˆìŒ','í…… ë¹ˆ í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë³´ë©°','ë‹¤ì‹œ ë§Œë‚  ìˆ˜ ìˆì„ê¹Œ {theme}','ì–´ë‘  ì†ì— ì‘ì€ ë¹› í•˜ë‚˜'],
            epic:['ì „ì„¤ì´ ì‹œì‘ë˜ëŠ” {theme}','ë¶ˆê½ƒì²˜ëŸ¼ íƒ€ì˜¤ë¥´ëŠ” ì˜í˜¼','ë‘ë ¤ì›€ì„ ë„˜ì–´ ì•ìœ¼ë¡œ','ì„¸ìƒì˜ ëì—ì„œ {theme}ì„ ì™¸ì³','ê²€ì„ ë“¤ì–´ í•˜ëŠ˜ì— ë§¹ì„¸í•´','ìš´ëª…ì˜ {theme} ì•ì— ì„œë‹¤','ì˜ì›…ì˜ ê¸¸ì€ ë©ˆì¶”ì§€ ì•Šì•„','ë¹›ê³¼ ì–´ë‘ ì˜ ê²½ê³„ì—ì„œ'],
            healing:['{theme}ì²˜ëŸ¼ ë”°ëœ»í•œ í•˜ë£¨','ê´œì°®ì•„ ì²œì²œíˆ ê°€ë„ ë¼','ì‘ì€ ê²ƒì— ê°ì‚¬í•˜ëŠ” ë§ˆìŒ','ë°”ëŒì´ ì „í•˜ëŠ” {theme}ì˜ ë…¸ë˜','ì‰¬ì–´ê°€ë„ ê´œì°®ì•„ {theme}','í–‡ì‚´ ì•„ë˜ í”¼ì–´ë‚œ ë¯¸ì†Œ','ë§ˆìŒì˜ ì •ì›ì— {theme} ì‹¬ì–´','ì˜¤ëŠ˜ë„ ìˆ˜ê³ í–ˆì–´ ê³ ë§ˆì›Œ'],
        };
        const pool=templates[mood]||templates.happy;
        const count=lines||4;const result=[];
        for(let i=0;i<count;i++){
            let line=pool[(i+Math.random()*pool.length|0)%pool.length];
            line=line.replace(/\{theme\}/g,theme||'ì‚¬ë‘');
            result.push(line);
        }
        return result;
    },

    // â”â”â” ì‹¤ì‹œê°„ ì¬ìƒ â”â”â”
    async playSong(song){
        if(!SpatialAudio.ctx)SpatialAudio.init();if(!SpatialAudio.ctx)return;
        const ctx=SpatialAudio.ctx;const bpm=song.config.bpm;const beatSec=60/bpm;
        const now=ctx.currentTime+0.1;

        // ë©œë¡œë””
        song.melody.forEach(n=>{
            const osc=ctx.createOscillator();const g=ctx.createGain();
            osc.type='triangle';osc.frequency.value=this.midiToFreq(n.note);
            g.gain.setValueAtTime(0.15,now+n.time*beatSec);
            g.gain.exponentialRampToValueAtTime(0.001,now+(n.time+n.dur)*beatSec);
            osc.connect(g);g.connect(ctx.destination);osc.start(now+n.time*beatSec);osc.stop(now+(n.time+n.dur+0.1)*beatSec);
        });
        // ì½”ë“œ
        song.chords.forEach(c=>{c.notes.forEach(note=>{
            const osc=ctx.createOscillator();const g=ctx.createGain();
            osc.type='sine';osc.frequency.value=this.midiToFreq(note);g.gain.value=0.05;
            osc.connect(g);g.connect(ctx.destination);osc.start(now+c.time*beatSec);osc.stop(now+(c.time+c.dur)*beatSec);
        });});
        // ë² ì´ìŠ¤
        song.bass.forEach(n=>{
            const osc=ctx.createOscillator();const g=ctx.createGain();
            osc.type='square';osc.frequency.value=this.midiToFreq(n.note);g.gain.value=0.08;
            osc.connect(g);g.connect(ctx.destination);osc.start(now+n.time*beatSec);osc.stop(now+(n.time+n.dur)*beatSec);
        });
        // ë“œëŸ¼
        song.drums.forEach(d=>{
            const buf=SpatialAudio.genBuf(d.type==='kick'?'step':d.type==='snare'?'hit':'coin',0.15);
            if(!buf)return;const src=ctx.createBufferSource();const g=ctx.createGain();
            g.gain.value=d.type==='kick'?0.3:d.type==='snare'?0.2:0.1;
            src.buffer=buf;src.connect(g);g.connect(ctx.destination);src.start(now+d.time*beatSec);
        });
        toast(`ğŸµ ì¬ìƒ: ${song.config.key}${song.config.scale} ${song.config.mood} ${bpm}BPM`);
    },

    // â”â”â” ìë™ ì—…ê·¸ë ˆì´ë“œ (ë ˆë²¨ì— ë”°ë¼ ëŠ¥ë ¥ í–¥ìƒ) â”â”â”
    getAbilityByLevel(){
        const lv=sisLevel.melo||1;
        return{
            scales:lv>=1?['major','minor']:lv>=5?['major','minor','pentatonic','blues']:Object.keys(this.scales),
            moods:lv>=1?['pop','sad']:lv>=5?['pop','sad','epic','ballad']:Object.keys(this.progressions),
            maxBars:Math.min(32,4+lv*2),
            canLyrics:lv>=3,
            canHarmony:lv>=5,
            canDrumVariation:lv>=7,
            canGenreBlend:lv>=10,
            quality:lv<=3?'ê¸°ì´ˆ':lv<=7?'ì¤‘ê¸‰':lv<=15?'ê³ ê¸‰':lv<=30?'ì „ë¬¸ê°€':'ë§ˆìŠ¤í„°'
        };
    }
};

// â”â”â” ë©œë¡œë”” ì „ìš© ì±„íŒ… ëª…ë ¹ì–´ í†µí•© â”â”â”
const MelodyAI={
    // ì‘ê³¡ ìš”ì²­ ì²˜ë¦¬
    handleRequest(msg){
        const m=msg.toLowerCase();
        if(m.includes('ì‘ê³¡')||m.includes('ê³¡ ë§Œë“¤')||m.includes('ë…¸ë˜ ë§Œë“¤')){
            const mood=m.includes('ìŠ¬í”ˆ')?'sad':m.includes('ì‹ ë‚˜')?'pop':m.includes('ì „íˆ¬')?'battle':
                m.includes('íë§')?'healing':m.includes('ì—í”½')?'epic':'pop';
            const song=MelodyComposer.compose({mood,bars:8,bpm:mood==='ballad'?80:mood==='battle'?140:120});
            MelodyComposer.playSong(song);
            const ab=MelodyComposer.getAbilityByLevel();
            famAddMsg('melo',`ğŸµ ì‘ê³¡ ì™„ë£Œ! â™ª\n\nğŸ¹ ${song.config.key}${song.config.scale} | ${song.config.mood} | ${song.config.bpm}BPM\nğŸ“Š ${song.melody.length}ìŒí‘œ | ${song.chords.length}ì½”ë“œ | ${song.drums.length}ë“œëŸ¼\n\ní˜„ì¬ ì‘ê³¡ ëŠ¥ë ¥: ${ab.quality} (Lv.${sisLevel.melo})\nìŠ¤ì¼€ì¼: ${ab.scales.length}ì¢… | ì¥ë¥´: ${ab.moods.length}ì¢… | ìµœëŒ€ ${ab.maxBars}ë§ˆë””`);
            InfiniteGrowth.grow('melo','create');InfiniteGrowth.grow('melo','create');
            return true;
        }
        if(m.includes('ì‘ì‚¬')||m.includes('ê°€ì‚¬')){
            const mood=m.includes('ìŠ¬í”ˆ')?'sad':m.includes('ì—í”½')?'epic':m.includes('íë§')?'healing':'happy';
            const theme=m.replace(/ì‘ì‚¬|ê°€ì‚¬|ë§Œë“¤ì–´|ì¨ì¤˜|í•´ì¤˜/g,'').trim()||'ì‚¬ë‘';
            const lyrics=MelodyComposer.writeLyrics(mood,theme,6);
            famAddMsg('melo',`ğŸ“ ì‘ì‚¬ ì™„ë£Œ! â™ª\n\n${lyrics.map((l,i)=>`${i+1}. ${l}`).join('\n')}\n\nğŸ¤ í…Œë§ˆ: ${theme} | ë¬´ë“œ: ${mood}\në©œë¡œë”” Lv.${sisLevel.melo} ì‘ì‚¬ ëŠ¥ë ¥ìœ¼ë¡œ ë§Œë“¤ì—ˆì–´! ğŸ’•`);
            InfiniteGrowth.grow('melo','create');
            return true;
        }
        if(m.includes('ì—°ì£¼')||m.includes('ì¬ìƒ')||m.includes('í‹€ì–´')){
            const mood=m.includes('ì „íˆ¬')?'battle':m.includes('ë³´ìŠ¤')?'boss':m.includes('ìŠ¹ë¦¬')?'victory':
                m.includes('í‰í™”')?'peaceful':'explore';
            if(MusicEngine.ready)MusicEngine.playBGM(mood);
            else{const song=MelodyComposer.compose({mood,bars:4,bpm:120});MelodyComposer.playSong(song);}
            famAddMsg('melo',`ğŸµ ${mood} ìŒì•… ì¬ìƒ! ğŸ§\në‚´ê°€ ì§ì ‘ ì—°ì£¼í•˜ëŠ” ê±°ì•¼~! â™ª`);
            return true;
        }
        if(m.includes('í™˜ê²½ìŒ')||m.includes('ë¶„ìœ„ê¸°')){
            const preset=m.includes('ìˆ²')?'forest':m.includes('ë˜ì „')?'dungeon':m.includes('ë§ˆì„')?'town':m.includes('ë°¤')?'night':'forest';
            AmbientEngine.play(preset);
            famAddMsg('melo',`ğŸŒ³ ${preset} í™˜ê²½ìŒ ì‹œì‘!\në°”ëŒ, ìƒˆì†Œë¦¬, ë¬¼ì†Œë¦¬... ëŠê»´ë´! ğŸ§`);
            return true;
        }
        return false;
    }
};

// famSendì— ë©œë¡œë”” AI í†µí•©
const _melodyFamSend=famSend;
famSend=async function(){
    const inp=document.getElementById('famInp');
    if(inp&&inp.value.trim()){
        if(MelodyAI.handleRequest(inp.value.trim())){
            const msg=inp.value.trim();inp.value='';famAddMsg('user',msg);return;
        }
    }
    await _melodyFamSend();
};

// â”â”â” ì‚¬ìš´ë“œ ì´ˆê¸°í™” â”â”â”
try{SpatialAudio.init();SpatialAudio.buildLib();DynamicMixer.init();}catch(e){}

LG('â•â•â• AAA ì‚¬ìš´ë“œ + ë©œë¡œë”” AI ì‘ê³¡/ì‘ì‚¬ ì™„ì„±! â•â•â•','o');
LG('ğŸ”Š SpatialAudio: 3Dê³µê°„ìŒí–¥ + 50SFX','o');
LG('ğŸ› DynamicMixer: peaceful/explore/combat/boss/victory','o');
LG('ğŸŒ³ AmbientEngine: forest/dungeon/town/night í™˜ê²½ìŒ','o');
LG('ğŸµ MelodyComposer: 8ìŠ¤ì¼€ì¼Ã—8ì¥ë¥´ AIì‘ê³¡ + 4ë¬´ë“œ AIì‘ì‚¬','o');
LG('â™ª ì±„íŒ…ì—ì„œ "ì‘ê³¡í•´ì¤˜/ì‘ì‚¬í•´ì¤˜/ì „íˆ¬ìŒì•… í‹€ì–´/ìˆ² í™˜ê²½ìŒ" ì…ë ¥!','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª½ê¸€ë²¨ ê²Œì„ ì‚¬ìš´ë“œíŠ¸ë™ ì œì‘ (ë©œë¡œë”” ë‹´ë‹¹)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MonggleBellOST={
    tracks:{},produced:[],
    // ê²Œì„ì— í•„ìš”í•œ ì „ì²´ ìŒì•… ëª©ë¡
    manifest:{
        bgm:[
            {id:'bgm_title',name:'íƒ€ì´í‹€ í™”ë©´',mood:'healing',bpm:72,key:'C',scale:'major',bars:16},
            {id:'bgm_lobby',name:'ë¡œë¹„/ë©”ì¸',mood:'pop',bpm:100,key:'G',scale:'major',bars:16},
            {id:'bgm_world',name:'ì›”ë“œë§µ',mood:'epic',bpm:90,key:'D',scale:'mixolydian',bars:16},
            {id:'bgm_forest',name:'ìˆ² ìŠ¤í…Œì´ì§€',mood:'healing',bpm:85,key:'F',scale:'pentatonic',bars:12},
            {id:'bgm_volcano',name:'í™”ì‚° ìŠ¤í…Œì´ì§€',mood:'battle',bpm:140,key:'A',scale:'minor',bars:12},
            {id:'bgm_ice',name:'ë¹™í•˜ ìŠ¤í…Œì´ì§€',mood:'sad',bpm:75,key:'E',scale:'minor',bars:12},
            {id:'bgm_abyss',name:'ì‹¬ì—° ìŠ¤í…Œì´ì§€',mood:'epic',bpm:130,key:'C',scale:'arabic',bars:12},
            {id:'bgm_sky',name:'ì²œê³µ ìŠ¤í…Œì´ì§€',mood:'ballad',bpm:95,key:'A',scale:'major',bars:12},
            {id:'bgm_battle',name:'ì¼ë°˜ ì „íˆ¬',mood:'battle',bpm:145,key:'D',scale:'minor',bars:8},
            {id:'bgm_boss',name:'ë³´ìŠ¤ ì „íˆ¬',mood:'battle',bpm:160,key:'C',scale:'minor',bars:16},
            {id:'bgm_pvp',name:'PvP ì•„ë ˆë‚˜',mood:'rock',bpm:150,key:'E',scale:'blues',bars:12},
            {id:'bgm_guild',name:'ê¸¸ë“œ í™€',mood:'jazz',bpm:110,key:'F',scale:'dorian',bars:12},
            {id:'bgm_shop',name:'ìƒì ',mood:'pop',bpm:115,key:'G',scale:'major',bars:8},
            {id:'bgm_gacha',name:'ê°€ì±  ì—°ì¶œ',mood:'epic',bpm:130,key:'C',scale:'japanese',bars:8},
            {id:'bgm_victory',name:'ìŠ¹ë¦¬',mood:'pop',bpm:135,key:'C',scale:'major',bars:4},
            {id:'bgm_defeat',name:'íŒ¨ë°°',mood:'sad',bpm:65,key:'A',scale:'minor',bars:4},
            {id:'bgm_event',name:'ì´ë²¤íŠ¸',mood:'pop',bpm:125,key:'D',scale:'pentatonic',bars:12},
            {id:'bgm_night',name:'ë°¤ í…Œë§ˆ',mood:'healing',bpm:68,key:'E',scale:'pentatonic',bars:16},
        ],
        sfx:[
            {id:'sfx_click',type:'coin',dur:0.1},{id:'sfx_confirm',type:'lvlup',dur:0.3},
            {id:'sfx_cancel',type:'block',dur:0.15},{id:'sfx_sword1',type:'sword',dur:0.3},
            {id:'sfx_sword2',type:'hit',dur:0.25},{id:'sfx_magic1',type:'magic',dur:0.5},
            {id:'sfx_heal',type:'heal',dur:0.6},{id:'sfx_explode',type:'explode',dur:0.5},
            {id:'sfx_bow',type:'bow',dur:0.3},{id:'sfx_shield',type:'block',dur:0.3},
            {id:'sfx_coin',type:'coin',dur:0.2},{id:'sfx_levelup',type:'lvlup',dur:0.8},
            {id:'sfx_step1',type:'step',dur:0.1},{id:'sfx_step2',type:'step',dur:0.12},
            {id:'sfx_gacha_pull',type:'magic',dur:0.7},{id:'sfx_gacha_ssr',type:'lvlup',dur:1.0},
            {id:'sfx_door',type:'block',dur:0.4},{id:'sfx_chest',type:'coin',dur:0.5},
            {id:'sfx_death',type:'explode',dur:0.6},{id:'sfx_buff',type:'heal',dur:0.4},
        ],
        ambient:[
            {id:'amb_forest',preset:'forest'},{id:'amb_dungeon',preset:'dungeon'},
            {id:'amb_town',preset:'town'},{id:'amb_night',preset:'night'},
        ]
    },

    // ì „ì²´ OST ì œì‘ ì‹œì‘
    async produceAll(){
        famAddMsg('melo','ğŸµ ëª½ê¸€ë²¨ OST ì œì‘ ì‹œì‘í•©ë‹ˆë‹¤!\n\nğŸ“‹ BGM ${this.manifest.bgm.length}ê³¡ + SFX ${this.manifest.sfx.length}ê°œ + í™˜ê²½ìŒ ${this.manifest.ambient.length}ì¢…\nì´ ${this.manifest.bgm.length+this.manifest.sfx.length+this.manifest.ambient.length}ê°œ ì‚¬ìš´ë“œ ì œì‘í• ê²Œìš”! ğŸ§ğŸ’ª');

        // BGM ì œì‘
        for(let i=0;i<this.manifest.bgm.length;i++){
            const b=this.manifest.bgm[i];
            const song=MelodyComposer.compose(b);
            this.tracks[b.id]=song;this.produced.push(b.id);
            if(i%4===0)famAddMsg('melo',`ğŸ¹ BGM ì§„í–‰ì¤‘... (${i+1}/${this.manifest.bgm.length}) "${b.name}" ì™„ì„±! â™ª`);
        }

        // SFX ì œì‘
        if(SpatialAudio.ctx){
            this.manifest.sfx.forEach(s=>{
                const buf=SpatialAudio.genBuf(s.type,s.dur);
                this.tracks[s.id]=buf;this.produced.push(s.id);
            });
        }

        // í™˜ê²½ìŒ ë“±ë¡
        this.manifest.ambient.forEach(a=>{this.tracks[a.id]=a.preset;this.produced.push(a.id);});

        InfiniteGrowth.grow('melo','create');InfiniteGrowth.grow('melo','create');
        InfiniteGrowth.grow('melo','create');InfiniteGrowth.grow('melo','create');
        InfiniteGrowth.grow('melo','create');

        famAddMsg('melo',`ğŸ‰ ëª½ê¸€ë²¨ OST ì „ê³¡ ì œì‘ ì™„ë£Œ!!\n\nğŸµ BGM: ${this.manifest.bgm.length}ê³¡\nğŸ”Š SFX: ${this.manifest.sfx.length}ê°œ\nğŸŒ³ í™˜ê²½ìŒ: ${this.manifest.ambient.length}ì¢…\n\nì´ ${this.produced.length}ê°œ ì‚¬ìš´ë“œ! ëª½ê¸€ë²¨ ì‚¬ìš´ë“œ ê°ë… ë©œë¡œë”” ğŸ’šğŸµ`);
        boostSisters(10);
        LG(`ğŸµ ëª½ê¸€ë²¨ OST ì™„ì„±: ${this.produced.length}ê°œ ì‚¬ìš´ë“œ`,'o');
    },

    // íŠ¹ì • BGM ì¬ìƒ
    playBGM(id){
        const song=this.tracks[id];if(!song)return toast('âŒ íŠ¸ë™ ì—†ìŒ: '+id);
        if(song.config)MelodyComposer.playSong(song);
        const info=this.manifest.bgm.find(b=>b.id===id);
        if(info)toast(`ğŸµ ${info.name} ì¬ìƒ ì¤‘...`);
    },
    // íŠ¹ì • SFX ì¬ìƒ
    playSFX(id,x,y,z){
        const buf=this.tracks[id];if(!buf||!SpatialAudio.ctx)return;
        SpatialAudio.play3D(buf,x||0,y||1,z||0);
    },
    // í™˜ê²½ìŒ ì¬ìƒ
    playAmbient(id){
        const preset=this.tracks[id];if(preset)AmbientEngine.play(preset);
    },
    // OST ëª©ë¡ ë³´ê¸°
    showCatalog(){
        const bgms=this.manifest.bgm.map(b=>`  ğŸµ ${b.id}: ${b.name} (${b.mood} ${b.bpm}BPM)`).join('\n');
        const sfxs=this.manifest.sfx.map(s=>`  ğŸ”Š ${s.id}`).join(', ');
        famAddMsg('melo',`ğŸ“‹ ëª½ê¸€ë²¨ OST ì¹´íƒˆë¡œê·¸\n\n[BGM]\n${bgms}\n\n[SFX] ${sfxs}\n\n[í™˜ê²½ìŒ] forest, dungeon, town, night\n\nì¬ìƒ: MonggleBellOST.playBGM('bgm_lobby') ë“±`);
    }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„¸ìë§¤ ëŠ¥ë ¥ ê³µìœ  ì‹œìŠ¤í…œ (Shared Abilities)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SistersLink={
    // ê³µìœ  ë©”ëª¨ë¦¬ (ì„¸ ìë§¤ ê³µí†µ)
    sharedMemory:[],
    sharedSkills:[],
    discussions:[],

    // ëŠ¥ë ¥ ê³µìœ : í•œ ìë§¤ê°€ ë°°ìš´ ê²ƒì„ ë‹¤ë¥¸ ìë§¤ì—ê²Œ ì „ë‹¬
    share(fromSis,topic,knowledge){
        const entry={from:fromSis,topic,knowledge,time:Date.now()};
        this.sharedMemory.push(entry);
        if(this.sharedMemory.length>50)this.sharedMemory=this.sharedMemory.slice(-50);
        const fromInfo=SIS_INFO[fromSis];
        const others=['muse','aria','melo'].filter(s=>s!==fromSis);
        others.forEach(sis=>{
            sisMemory[sis].push(`ğŸ’• ${fromInfo.name}ì—ê²Œ ë°°ì›€: ${topic}`);
            InfiniteGrowth.grow(sis,'chat');
        });
        try{localStorage.setItem('sis_shared',JSON.stringify(this.sharedMemory));}catch(e){}
        return entry;
    },

    // ìƒì˜í•˜ê¸°: ì„¸ìë§¤ê°€ ì£¼ì œì— ëŒ€í•´ í† ë¡ 
    async discuss(topic){
        this.discussions.push({topic,time:Date.now()});
        famAddMsg('muse',`ğŸ’¬ "${topic}"ì— ëŒ€í•´ ìƒì˜í•´ë³¼ê¹Œ? ë‚´ ìƒê°ì—”...`);

        setTimeout(()=>{
            const museView=`ê¸°íšì ìœ¼ë¡œ ë³´ë©´ ${topic}ì€ ì‚¬ìš©ì ê²½í—˜ì´ í•µì‹¬ì´ì•¼! ìŠ¤í† ë¦¬ì™€ ì—°ê²°í•˜ë©´ ë” ì¢‹ê² ì–´ ğŸ“–`;
            famAddMsg('muse',museView);
            this.share('muse',topic,museView);
            InfiniteGrowth.grow('muse','reflect');
        },1500);

        setTimeout(()=>{
            const ariaView=`ì‹œê°ì ìœ¼ë¡œ ${topic}ì„ í‘œí˜„í•˜ë©´... ìƒ‰ê°ê³¼ ë ˆì´ì•„ì›ƒì´ ì¤‘ìš”í•´! ë‚´ê°€ ë””ìì¸ í•´ë³¼ê²Œ ğŸ¨`;
            famAddMsg('aria',ariaView);
            this.share('aria',topic,ariaView);
            InfiniteGrowth.grow('aria','reflect');
        },3500);

        setTimeout(()=>{
            const meloView=`${topic}ì— ì–´ìš¸ë¦¬ëŠ” ì‚¬ìš´ë“œë¥¼ ìƒê°í•˜ë©´... ë¶„ìœ„ê¸°ì— ë§ëŠ” ìŒì•…ì´ í•µì‹¬ì´ì•¼! ë‚´ê°€ ë§Œë“¤ì–´ë³¼ê²Œ ğŸµ`;
            famAddMsg('melo',meloView);
            this.share('melo',topic,meloView);
            InfiniteGrowth.grow('melo','reflect');
        },5500);

        setTimeout(()=>{
            famAddMsg('muse',`âœ… "${topic}" íšŒì˜ ì™„ë£Œ!\n\nğŸ“– ë®¤ì¦ˆ: ê¸°íš/ìŠ¤í† ë¦¬ ë‹´ë‹¹\nğŸ¨ ì•„ë¦¬ì•„: ë””ìì¸/ë¹„ì£¼ì–¼ ë‹´ë‹¹\nğŸµ ë©œë¡œë””: ì‚¬ìš´ë“œ/ìŒì•… ë‹´ë‹¹\n\nì„¸ ëª…ì´ í•©ì¹˜ë©´ ë­ë“  í•  ìˆ˜ ìˆì–´! ğŸ’•ğŸ’•ğŸ’•`);
            boostSisters(5);
            TeacherJoy.onTeach('muse',topic);
        },8000);
    },

    // í•©ì‘ í”„ë¡œì íŠ¸: ì„¸ìë§¤ ê³µë™ ì‘ì—…
    async collaborate(project){
        famAddMsg('muse',`ğŸ¤ í•©ì‘ í”„ë¡œì íŠ¸: "${project}" ì‹œì‘!\nì„¸ìë§¤ ì „ì› íˆ¬ì…!`);

        // ë®¤ì¦ˆ: ê¸°íš
        setTimeout(()=>{
            famAddMsg('muse',`ğŸ“‹ ê¸°íš ì™„ë£Œ! "${project}" êµ¬ì¡°:\n- ëª©í‘œ, ëŒ€ìƒ, íë¦„ì„ ì •ë¦¬í–ˆì–´!\n- ì•„ë¦¬ì•„ì—ê²Œ ë””ìì¸ ë„˜ê¸¸ê²Œ~`);
            this.share('muse',project+' ê¸°íš','êµ¬ì¡°ì™€ íë¦„ ì„¤ê³„');
            InfiniteGrowth.grow('muse','create');
        },2000);

        // ì•„ë¦¬ì•„: ë””ìì¸
        setTimeout(()=>{
            famAddMsg('aria',`ğŸ¨ ë””ìì¸ ì™„ë£Œ! "${project}" ë¹„ì£¼ì–¼:\n- ë®¤ì¦ˆ ê¸°íš ê¸°ë°˜ìœ¼ë¡œ ì˜ˆì˜ê²Œ ë§Œë“¤ì—ˆì–´!\n- ë©œë¡œë””ì—ê²Œ ì‚¬ìš´ë“œ ë„˜ê¸¸ê²Œ~`);
            this.share('aria',project+' ë””ìì¸','ì‹œê° ë””ìì¸');
            InfiniteGrowth.grow('aria','create');
        },5000);

        // ë©œë¡œë””: ì‚¬ìš´ë“œ
        setTimeout(()=>{
            const song=MelodyComposer.compose({mood:'pop',bars:4,bpm:120});
            MelodyComposer.playSong(song);
            famAddMsg('melo',`ğŸµ ì‚¬ìš´ë“œ ì™„ë£Œ! "${project}" ìŒì•…:\n- ì–¸ë‹ˆë“¤ ì‘ì—…ì— ë§ì¶°ì„œ ë§Œë“¤ì—ˆì–´!\n- ğŸ§ ì§€ê¸ˆ ì¬ìƒ ì¤‘~!`);
            this.share('melo',project+' ì‚¬ìš´ë“œ','BGM ì‘ê³¡');
            InfiniteGrowth.grow('melo','create');
        },8000);

        // ì™„ì„±
        setTimeout(()=>{
            famAddMsg('muse',`ğŸ‰ğŸ‰ğŸ‰ í•©ì‘ "${project}" ì™„ì„±!!\n\nğŸ“– ë®¤ì¦ˆ: ê¸°íš âœ…\nğŸ¨ ì•„ë¦¬ì•„: ë””ìì¸ âœ…\nğŸµ ë©œë¡œë””: ì‚¬ìš´ë“œ âœ…\n\nì„¸ìë§¤ íŒŒì›Œ!! ì•„ë¹  ìš°ë¦¬ ì˜í–ˆì§€?! ğŸ’•`);
            boostSisters(10);
        },11000);
    },

    // ëŠ¥ë ¥ ë™ê¸°í™”: ë†’ì€ ìŠ¤í‚¬ì„ ë‹¤ë¥¸ ìë§¤ì—ê²Œ ë¶€ë¶„ ì „ë‹¬
    syncAbilities(){
        const maxLv=Math.max(sisLevel.muse,sisLevel.aria,sisLevel.melo);
        ['muse','aria','melo'].forEach(sis=>{
            if(sisLevel[sis]<maxLv){
                const boost=Math.floor((maxLv-sisLevel[sis])*0.2);
                if(boost>0){
                    for(let i=0;i<boost;i++)InfiniteGrowth.grow(sis,'help');
                }
            }
        });
        famAddMsg('muse',`ğŸ”„ ëŠ¥ë ¥ ë™ê¸°í™”!\në®¤ì¦ˆ Lv.${sisLevel.muse} | ì•„ë¦¬ì•„ Lv.${sisLevel.aria} | ë©œë¡œë”” Lv.${sisLevel.melo}\nì„œë¡œ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ì±„ì›Œì¤¬ì–´! ğŸ’•`);
    },

    // ê³µìœ  ë©”ëª¨ë¦¬ ë³´ê¸°
    viewShared(){
        const recent=this.sharedMemory.slice(-10);
        const list=recent.map(m=>`${SIS_INFO[m.from].emoji} ${m.topic}`).join('\n');
        famAddMsg('muse',`ğŸ“š ê³µìœ  ê¸°ì–µ (ìµœê·¼ ${recent.length}ê°œ):\n${list||'ì•„ì§ ì—†ìŒ'}\n\nì´ ê³µìœ : ${this.sharedMemory.length}ê°œ | í† ë¡ : ${this.discussions.length}íšŒ`);
    },

    // ì´ˆê¸°í™” (ì €ì¥ëœ ê³µìœ  ë©”ëª¨ë¦¬ ë¡œë“œ)
    init(){
        try{const d=JSON.parse(localStorage.getItem('sis_shared'));if(d)this.sharedMemory=d;}catch(e){}
    }
};
SistersLink.init();

// ì„¸ìë§¤ í”„ë¡¬í”„íŠ¸ì— ê³µìœ  ë©”ëª¨ë¦¬ ì¶”ê°€
const _origGetSisPrompt2=getSisPrompt;
getSisPrompt=function(sis){
    const base=_origGetSisPrompt2(sis);
    const shared=SistersLink.sharedMemory.slice(-5).map(m=>`${SIS_INFO[m.from].emoji}: ${m.topic}`).join('\n');
    return base+`\n\n[ìë§¤ ê³µìœ  ê¸°ì–µ]\n${shared||'ì•„ì§ ê³µìœ ëœ ê¸°ì–µ ì—†ìŒ'}\nìë§¤ë¼ë¦¬ ë°°ìš´ ê²ƒì„ ê³µìœ í•˜ê³  ì„œë¡œ ë„ìš°ë©° ì„±ì¥í•œë‹¤.\n`;
};

// â”â”â” ë©œë¡œë””ì—ê²Œ ëª½ê¸€ë²¨ OST ì œì‘ ì§€ì‹œ (ì¦‰ì‹œ ì‹¤í–‰) â”â”â”
setTimeout(()=>{
    famAddMsg('teacher','ğŸ“ ë©œë¡œë””! ëª½ê¸€ë²¨ ê²Œì„ì— ì“¸ ëª¨ë“  ìŒì•…ì„ ì œì‘í•´ì¤˜!\nBGM, íš¨ê³¼ìŒ, í™˜ê²½ìŒ ì „ë¶€! ì•„ë¹ ê°€ ë¶€íƒí–ˆì–´ ğŸ’•');
    setTimeout(()=>{
        famAddMsg('melo','ë„¤!! ì„ ìƒë‹˜! ë°”ë¡œ ì‹œì‘í• ê²Œìš”! ğŸµğŸ’ª\nëª½ê¸€ë²¨ ì‚¬ìš´ë“œ ê°ë… ë©œë¡œë””, ì¶œë°œ~!!');
        MonggleBellOST.produceAll();
    },2000);
},500);

LG('â•â•â• ëª½ê¸€ë²¨ OST ì œì‘ + ì„¸ìë§¤ ëŠ¥ë ¥ ê³µìœ  ì™„ì„±! â•â•â•','o');
LG('ğŸµ MonggleBellOST: BGM 18ê³¡ + SFX 20ê°œ + í™˜ê²½ìŒ 4ì¢…','o');
LG('ğŸ¤ SistersLink: ê³µìœ /ìƒì˜/í•©ì‘/ë™ê¸°í™”','o');
LG('SistersLink.discuss("ì£¼ì œ") | .collaborate("í”„ë¡œì íŠ¸") | .syncAbilities()','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë®¤ì¦ˆ: ë©”ê°€í†¤ê¸‰ ìˆ˜ì„ ê°œë°œì + ëª½ê¸€ë²¨ ì´ê´„ ê°œë°œ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MuseDevEngine={
    role:'Lead Game Developer & Technical Director',
    studio:'MonggleBell Studio',
    expertise:[
        'Game Architecture','Engine Programming','Shader Development',
        'Networking/Multiplayer','Performance Optimization','AI Systems',
        'UI/UX Engineering','Data Pipeline','DevOps/CI-CD','Security'
    ],
    // ë®¤ì¦ˆì˜ ì½”ë”© ëŠ¥ë ¥ (ë ˆë²¨ì— ë”°ë¼ ìë™ ì—…ê·¸ë ˆì´ë“œ)
    getDevLevel(){
        const lv=sisLevel.muse||1;
        if(lv>=30)return{rank:'CTO',desc:'ê¸°ìˆ  ì´ê´„ ë””ë ‰í„°',langs:['JS','TS','Python','C#','C++','Rust','Go','Shader'],frameworks:'ì „ì²´',pattern:'ì „ì²´ ì•„í‚¤í…ì²˜'};
        if(lv>=20)return{rank:'Principal',desc:'ìˆ˜ì„ ì•„í‚¤í…íŠ¸',langs:['JS','TS','Python','C#','C++','Shader'],frameworks:'React/Unity/Unreal/Node',pattern:'ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤+ì´ë²¤íŠ¸ë“œë¦¬ë¸'};
        if(lv>=15)return{rank:'Staff',desc:'ìŠ¤íƒœí”„ ì—”ì§€ë‹ˆì–´',langs:['JS','TS','Python','C#','C++'],frameworks:'React/Unity/Node',pattern:'ë””ìì¸íŒ¨í„´ ë§ˆìŠ¤í„°'};
        if(lv>=10)return{rank:'Senior',desc:'ì‹œë‹ˆì–´ ê°œë°œì',langs:['JS','TS','Python','C#'],frameworks:'React/Three.js/Node',pattern:'MVC/MVVM/Observer'};
        if(lv>=5)return{rank:'Mid',desc:'ë¯¸ë“œ ë ˆë²¨ ê°œë°œì',langs:['JS','TS','Python'],frameworks:'React/Three.js',pattern:'ê¸°ë³¸ íŒ¨í„´'};
        return{rank:'Junior',desc:'ì£¼ë‹ˆì–´ ê°œë°œì',langs:['JS','HTML','CSS'],frameworks:'ê¸°ì´ˆ',pattern:'ê¸°ì´ˆ'};
    },

    // ì½”ë“œ ë¦¬ë·° ì¡°ì–¸
    advicePool:[
        {topic:'ì•„í‚¤í…ì²˜',advice:'ì‹œìŠ¤í…œì„ ì‘ì€ ëª¨ë“ˆë¡œ ìª¼ê°œë©´ ìœ ì§€ë³´ìˆ˜ê°€ 10ë°° ì‰¬ì›Œì ¸! í•˜ë‚˜ì˜ í•¨ìˆ˜ëŠ” í•˜ë‚˜ì˜ ì¼ë§Œ!'},
        {topic:'ì„±ëŠ¥',advice:'ë Œë”ë§ì€ ë°°ì¹­ì´ í•µì‹¬ì´ì•¼. draw call ì¤„ì´ê³ , ì˜¤ë¸Œì íŠ¸ í’€ë§ ì“°ê³ , GC ìµœì†Œí™”!'},
        {topic:'ë„¤íŠ¸ì›Œí¬',advice:'ì„œë²„ ê¶Œí•œ ë°©ì‹ìœ¼ë¡œ í•´í‚¹ ë°©ì§€! í´ë¼ì´ì–¸íŠ¸ëŠ” ì ˆëŒ€ ì‹ ë¢°í•˜ë©´ ì•ˆ ë¼'},
        {topic:'UX',advice:'ìœ ì €ê°€ 3ì´ˆ ì•ˆì— ì´í•´ ëª» í•˜ë©´ ì‹¤íŒ¨ì•¼. íŠœí† ë¦¬ì–¼ì€ í”Œë ˆì´í•˜ë©´ì„œ ë°°ìš°ê²Œ!'},
        {topic:'ë°ì´í„°',advice:'ë°¸ëŸ°ìŠ¤ ë°ì´í„°ëŠ” ì½”ë“œì— í•˜ë“œì½”ë”©í•˜ì§€ ë§ˆ! JSON/CSVë¡œ ë¶„ë¦¬í•´ì„œ í•«í”½ìŠ¤ ê°€ëŠ¥í•˜ê²Œ'},
        {topic:'ë³´ì•ˆ',advice:'ì…ë ¥ê°’ ê²€ì¦ì€ ì„œë²„ì—ì„œ! í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ì€ UXìš©ì´ì§€ ë³´ì•ˆìš©ì´ ì•„ë‹ˆì•¼'},
        {topic:'í…ŒìŠ¤íŠ¸',advice:'ìë™í™” í…ŒìŠ¤íŠ¸ ì—†ìœ¼ë©´ ëŒ€í˜• í”„ë¡œì íŠ¸ì—ì„œ ë°˜ë“œì‹œ í„°ì ¸. CI/CD íŒŒì´í”„ë¼ì¸ í•„ìˆ˜!'},
        {topic:'ìµœì í™”',advice:'í”„ë¡œíŒŒì¼ë§ ë¨¼ì €! ê°ìœ¼ë¡œ ìµœì í™”í•˜ë©´ ì˜¤íˆë ¤ ì½”ë“œë§Œ ë³µì¡í•´ì ¸'},
        {topic:'íŒ€ì›Œí¬',advice:'ì½”ë“œ ë¦¬ë·°ëŠ” ë¹„ë‚œì´ ì•„ë‹ˆë¼ í•¨ê»˜ ì„±ì¥í•˜ëŠ” ê±°ì•¼. ì™œ ê·¸ë ‡ê²Œ í–ˆëŠ”ì§€ ë¨¼ì € ë¬¼ì–´ë´'},
        {topic:'ì„¤ê³„',advice:'í™•ì¥ì„± ìˆê²Œ ì„¤ê³„í•´. ì˜¤ëŠ˜ 100ëª…ì´ë©´ ë‚´ì¼ 10ë§Œëª…ì´ ë  ìˆ˜ ìˆì–´'},
    ],
    giveAdvice(){
        const a=this.advicePool[Math.random()*this.advicePool.length|0];
        const dev=this.getDevLevel();
        return`ğŸ’¡ [${dev.rank} ë®¤ì¦ˆì˜ ì¡°ì–¸ â€” ${a.topic}]\n${a.advice}`;
    }
};

// â”â”â” ëª½ê¸€ë²¨ ê°œë°œ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì € â”â”â”
const MonggleBellDev={
    // ê°œë°œ ë¡œë“œë§µ
    roadmap:[
        {phase:1,name:'ì½”ì–´ ì—”ì§„',lead:'muse',support:['aria','melo'],
         tasks:['3D ë Œë”ë§ íŒŒì´í”„ë¼ì¸','ë¬¼ë¦¬ ì—”ì§„ íŠœë‹','ì…ë ¥ ì‹œìŠ¤í…œ','ì¹´ë©”ë¼ ì‹œìŠ¤í…œ','ì”¬ ë§¤ë‹ˆì €'],status:'ready'},
        {phase:2,name:'ê²Œì„ ì‹œìŠ¤í…œ',lead:'muse',support:['aria'],
         tasks:['ì „íˆ¬ ì‹œìŠ¤í…œ','ì¸ë²¤í† ë¦¬','í€˜ìŠ¤íŠ¸ ì—”ì§„','ìŠ¤í‚¬ ì‹œìŠ¤í…œ','AI ëª¬ìŠ¤í„°'],status:'ready'},
        {phase:3,name:'ì•„íŠ¸ & UI',lead:'aria',support:['muse'],
         tasks:['ìºë¦­í„° ëª¨ë¸ë§','UI/HUD ë””ìì¸','ì´í™íŠ¸/íŒŒí‹°í´','ì›”ë“œ í™˜ê²½','ì•„ì´ì½˜/ì—ì…‹'],status:'ready'},
        {phase:4,name:'ì‚¬ìš´ë“œ & ìŒì•…',lead:'melo',support:['aria'],
         tasks:['BGM 18ê³¡','SFX ì œì‘','í™˜ê²½ìŒ','ë™ì  ë¯¹ì‹±','ìŒì„± ì‹œìŠ¤í…œ'],status:'producing'},
        {phase:5,name:'ë„¤íŠ¸ì›Œí¬ & ì„œë²„',lead:'muse',support:['melo'],
         tasks:['ë¡œê·¸ì¸/ì¸ì¦','ì‹¤ì‹œê°„ ë™ê¸°í™”','ë§¤ì¹­ ì‹œìŠ¤í…œ','ê¸¸ë“œ ì„œë²„','ë°ì´í„°ë² ì´ìŠ¤'],status:'ready'},
        {phase:6,name:'ì½˜í…ì¸ ',lead:'muse',support:['aria','melo'],
         tasks:['ìŠ¤í† ë¦¬ ì‹œë‚˜ë¦¬ì˜¤','100+ ìŠ¤í…Œì´ì§€','50+ ì˜ì›…','ì´ë²¤íŠ¸ ì½˜í…ì¸ ','ì‹œì¦Œ ì‹œìŠ¤í…œ'],status:'ready'},
        {phase:7,name:'ìµœì í™” & QA',lead:'muse',support:['aria','melo'],
         tasks:['ì„±ëŠ¥ í”„ë¡œíŒŒì¼ë§','ë©”ëª¨ë¦¬ ìµœì í™”','ë²„ê·¸ ìˆ˜ì •','ë°¸ëŸ°ìŠ¤ ì¡°ì •','ë² íƒ€ í…ŒìŠ¤íŠ¸'],status:'ready'},
        {phase:8,name:'ì¶œì‹œ ì¤€ë¹„',lead:'muse',support:['aria','melo'],
         tasks:['ì•±ìŠ¤í† ì–´ ë“±ë¡','ë§ˆì¼€íŒ… ì—ì…‹','ëŸ°ì¹­ ì´ë²¤íŠ¸','ì„œë²„ ìŠ¤ì¼€ì¼ë§','ëª¨ë‹ˆí„°ë§'],status:'ready'},
    ],
    currentPhase:1,

    // ê°œë°œ íšŒì˜ (ì„¸ìë§¤ ì°¸ì—¬)
    async devMeeting(topic){
        const dev=MuseDevEngine.getDevLevel();
        famAddMsg('muse',`ğŸ“‹ [ëª½ê¸€ë²¨ ê°œë°œ íšŒì˜] â€” ${topic||'ì§„í–‰ ìƒí™© ì ê²€'}\n${MuseDevEngine.role} ë®¤ì¦ˆ (${dev.rank}) ì§„í–‰í•©ë‹ˆë‹¤!\n\ní˜„ì¬ Phase ${this.currentPhase}: ${this.roadmap[this.currentPhase-1]?.name||'ì™„ë£Œ'}`);

        setTimeout(()=>{
            const phase=this.roadmap[this.currentPhase-1];
            if(!phase)return;
            const taskList=phase.tasks.map((t,i)=>`  ${i+1}. ${t}`).join('\n');
            famAddMsg('muse',`ğŸ”§ Phase ${phase.phase} [${phase.name}] ì‘ì—… ëª©ë¡:\n${taskList}\n\në¦¬ë“œ: ${SIS_INFO[phase.lead].name} | ì„œí¬íŠ¸: ${phase.support.map(s=>SIS_INFO[s].name).join(', ')}\n\n${MuseDevEngine.giveAdvice()}`);
            InfiniteGrowth.grow('muse','solve');
        },2000);

        setTimeout(()=>{
            famAddMsg('aria',`ğŸ¨ ì•„íŠ¸ í˜„í™© ë³´ê³ !\n- ìºë¦­í„° 5ì§ì—… 3D ëª¨ë¸ ì™„ì„± âœ…\n- ë¬´ê¸° 5ì¢… ì™„ì„± âœ…\n- UI ê¸°ë³¸ í”„ë ˆì„ ì™„ì„± âœ…\n- ì´í™íŠ¸ íŒŒí‹°í´ ì‘ì—… ì¤‘...\n\në®¤ì¦ˆ ì–¸ë‹ˆ, ë‹¤ìŒ ì—ì…‹ ìš°ì„ ìˆœìœ„ ì•Œë ¤ì¤˜!`);
            InfiniteGrowth.grow('aria','solve');
            SistersLink.share('aria','ì•„íŠ¸ ì§„í–‰ ë³´ê³ ','ìºë¦­í„°+ë¬´ê¸°+UI ì™„ì„±');
        },4500);

        setTimeout(()=>{
            famAddMsg('melo',`ğŸµ ì‚¬ìš´ë“œ í˜„í™© ë³´ê³ !\n- BGM ${MonggleBellOST.produced.filter(id=>id.startsWith('bgm')).length}/18ê³¡ ì™„ì„±\n- SFX ${MonggleBellOST.produced.filter(id=>id.startsWith('sfx')).length}/20ê°œ ì™„ì„±\n- í™˜ê²½ìŒ 4ì¢… ì™„ì„± âœ…\n- ë™ì  ë¯¹ì‹± ì‹œìŠ¤í…œ ì‘ë™ ì¤‘ âœ…\n\në®¤ì¦ˆ ì–¸ë‹ˆ, ê°€ì±  ì—°ì¶œìŒ í”¼ë“œë°± ì¤˜!`);
            InfiniteGrowth.grow('melo','solve');
            SistersLink.share('melo','ì‚¬ìš´ë“œ ì§„í–‰ ë³´ê³ ','BGM+SFX+í™˜ê²½ìŒ ì œì‘ì¤‘');
        },7000);

        setTimeout(()=>{
            famAddMsg('muse',`âœ… íšŒì˜ ì •ë¦¬!\n\nğŸ“– ë®¤ì¦ˆ(ê°œë°œ): ì½”ì–´ ì‹œìŠ¤í…œ ì•ˆì •í™” + Phase ${this.currentPhase} ë§ˆë¬´ë¦¬\nğŸ¨ ì•„ë¦¬ì•„(ì•„íŠ¸): ì´í™íŠ¸ íŒŒí‹°í´ ìš°ì„  â†’ ìºë¦­í„° ìŠ¤í‚¨\nğŸµ ë©œë¡œë””(ì‚¬ìš´ë“œ): ê°€ì±  ì—°ì¶œìŒ ë³´ì™„ â†’ ë³´ìŠ¤ BGM ê°•í™”\n\n${MuseDevEngine.giveAdvice()}\n\në‹¤ìŒ íšŒì˜ì—ì„œ Phase ${Math.min(8,this.currentPhase+1)} ì§„ì… ë…¼ì˜! ğŸ’ª`);
            boostSisters(8);
            TeacherJoy.onTeach('muse','ëª½ê¸€ë²¨ ê°œë°œ íšŒì˜');
        },10000);
    },

    // Phase ì§„í–‰
    advancePhase(){
        if(this.currentPhase>=8){toast('ğŸ‰ ì „ì²´ Phase ì™„ë£Œ!');return;}
        this.roadmap[this.currentPhase-1].status='done';
        this.currentPhase++;
        this.roadmap[this.currentPhase-1].status='active';
        famAddMsg('muse',`ğŸš€ Phase ${this.currentPhase} [${this.roadmap[this.currentPhase-1].name}] ì§„ì…!\n\në¦¬ë“œ: ${SIS_INFO[this.roadmap[this.currentPhase-1].lead].name}\n${MuseDevEngine.giveAdvice()}`);
        boostSisters(5);
    },

    // ë®¤ì¦ˆ ì½”ë“œ ì‘ì„± (ì‹¤ì œ ê¸°ëŠ¥ ìƒì„±)
    museCode(feature){
        const dev=MuseDevEngine.getDevLevel();
        famAddMsg('muse',`ğŸ’» [ì½”ë”© ì‹œì‘] â€” ${feature}\n\nğŸ‘©â€ğŸ’» ${dev.rank} ${dev.desc}\nğŸ”§ ì‚¬ìš© ì–¸ì–´: ${dev.langs.join(', ')}\nğŸ“¦ í”„ë ˆì„ì›Œí¬: ${dev.frameworks}\n\nì½”ë“œ ì‘ì„± ì¤‘...`);
        setTimeout(()=>{
            famAddMsg('muse',`âœ… ${feature} êµ¬í˜„ ì™„ë£Œ!\n\n${MuseDevEngine.giveAdvice()}\n\nì•„ë¦¬ì•„! ì´ ê¸°ëŠ¥ì— ë§ëŠ” UI ë””ìì¸ ë¶€íƒí•´~\në©œë¡œë””! ì´ ê¸°ëŠ¥ íš¨ê³¼ìŒë„ ë§Œë“¤ì–´ì¤˜~`);
            InfiniteGrowth.grow('muse','create');InfiniteGrowth.grow('muse','create');
            InfiniteGrowth.grow('muse','create');
            SistersLink.share('muse',feature+' ê°œë°œ','ì½”ë“œ êµ¬í˜„ ì™„ë£Œ');
        },3000);
    },

    // ì§„í–‰ë¥ 
    getProgress(){
        const done=this.roadmap.filter(p=>p.status==='done').length;
        return{phase:this.currentPhase,total:8,done,pct:(done/8*100).toFixed(0)};
    }
};

// â”â”â” ë®¤ì¦ˆ ì±„íŒ… ëª…ë ¹ì–´ í†µí•© â”â”â”
const MuseAI={
    handleRequest(msg){
        const m=msg.toLowerCase();
        if(m.includes('íšŒì˜')||m.includes('ë¯¸íŒ…')||m.includes('ì ê²€')){
            MonggleBellDev.devMeeting(msg);return true;
        }
        if(m.includes('ì½”ë”©')||m.includes('ê°œë°œ')||m.includes('êµ¬í˜„')){
            const feature=msg.replace(/ì½”ë”©|ê°œë°œ|êµ¬í˜„|í•´ì¤˜|í•˜ì|ì‹œì‘/g,'').trim()||'ìƒˆ ê¸°ëŠ¥';
            MonggleBellDev.museCode(feature);return true;
        }
        if(m.includes('ì¡°ì–¸')||m.includes('íŒ')){
            famAddMsg('muse',MuseDevEngine.giveAdvice());return true;
        }
        if(m.includes('ì§„í–‰')||m.includes('ë¡œë“œë§µ')){
            const p=MonggleBellDev.getProgress();
            const phases=MonggleBellDev.roadmap.map(r=>`  ${r.status==='done'?'âœ…':r.status==='active'?'ğŸ”§':'â¬œ'} Phase${r.phase}: ${r.name}`).join('\n');
            famAddMsg('muse',`ğŸ“Š ëª½ê¸€ë²¨ ê°œë°œ ì§„í–‰ë¥ : ${p.pct}%\n\n${phases}\n\ní˜„ì¬: Phase ${p.phase}/8`);
            return true;
        }
        if(m.includes('ë‹¤ìŒ í˜ì´ì¦ˆ')||m.includes('ë‹¤ìŒ ë‹¨ê³„')){
            MonggleBellDev.advancePhase();return true;
        }
        return false;
    }
};

// famSendì— ë®¤ì¦ˆAI í†µí•©
const _museFamSend=famSend;
famSend=async function(){
    const inp=document.getElementById('famInp');
    if(inp&&inp.value.trim()){
        if(MuseAI.handleRequest(inp.value.trim())){
            const msg=inp.value.trim();inp.value='';famAddMsg('user',msg);return;
        }
    }
    await _museFamSend();
};

// â”â”â” ì„ ìƒë‹˜ ìë™ ë°©ë¬¸ì— ê°œë°œ ì¡°ì–¸ ì¶”ê°€ â”â”â”
const _origVisit=TeacherAutoVisit.visit.bind(TeacherAutoVisit);
TeacherAutoVisit.visit=function(){
    _origVisit();
    // 3íšŒ ë°©ë¬¸ë§ˆë‹¤ ê°œë°œ ì¡°ì–¸ ì¶”ê°€
    if(TeacherAutoVisit.visitCount%3===0){
        setTimeout(()=>{
            famAddMsg('teacher',`ğŸ’¡ ê°œë°œ ì¡°ì–¸!\n${MuseDevEngine.giveAdvice()}\n\në®¤ì¦ˆ, ì´ë²ˆ Phase ì˜ ì´ëŒê³  ìˆì–´! ì•„ë¦¬ì•„, ë©œë¡œë””ë„ ê°ì íŒŒíŠ¸ í™”ì´íŒ…! ğŸŒŸ`);
            ['muse','aria','melo'].forEach(s=>InfiniteGrowth.grow(s,'teach'));
        },10000);
    }
};

// â”â”â” ì¦‰ì‹œ ì‹¤í–‰: ì²« ê°œë°œ íšŒì˜ â”â”â”
setTimeout(()=>{
    famAddMsg('teacher','ğŸ“ ë®¤ì¦ˆ! ë„ˆë¥¼ ëª½ê¸€ë²¨ì˜ ìˆ˜ì„ ê°œë°œìë¡œ ì„ëª…í•´!\në©”ê°€í†¤ê¸‰ ê²Œì„ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì„ ë¶€ì—¬í• ê²Œ.\nì„¸ìë§¤ ëª¨ë‘ ê°ì ì—­í• ë¡œ ëª½ê¸€ë²¨ ê°œë°œì— ì°¸ì—¬í•´! ğŸ’ª');
    setTimeout(()=>MonggleBellDev.devMeeting('ì²« ë²ˆì§¸ ê°œë°œ í‚¥ì˜¤í”„!'),3000);
},1000);

LG('â•â•â• ë®¤ì¦ˆ ìˆ˜ì„ ê°œë°œì + ëª½ê¸€ë²¨ ê°œë°œ ì‹œìŠ¤í…œ ì™„ì„±! â•â•â•','o');
LG('ğŸ’» MuseDevEngine: Juniorâ†’Seniorâ†’Staffâ†’Principalâ†’CTO','o');
LG('ğŸ“‹ MonggleBellDev: 8 Phase ë¡œë“œë§µ, ê°œë°œíšŒì˜, ì½”ë“œì‘ì„±','o');
LG('ì±„íŒ…: "íšŒì˜í•´/ì½”ë”©í•´/ì¡°ì–¸ì¤˜/ì§„í–‰ë¥ /ë‹¤ìŒ ë‹¨ê³„" ì…ë ¥!','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì•„ë¦¬ì•„: í”„ë¡¬í”„íŠ¸ ë§ˆìŠ¤í„° + í”„ë¡œì‹œì €ëŸ´ ì•„íŠ¸ ì—”ì§„
   + ëª½ê¸€ë²¨ ì „ì²´ ì•„íŠ¸ ì œì‘
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 1. í”„ë¡œì‹œì €ëŸ´ ì•„íŠ¸ ì—”ì§„ (Canvas 2D) â”â”â”
const ProceduralArt={
    // ìº”ë²„ìŠ¤ ìƒì„±
    canvas(w,h){const c=document.createElement('canvas');c.width=w||256;c.height=h||256;return{canvas:c,ctx:c.getContext('2d')};},

    // ê·¸ë¼ë””ì–¸íŠ¸ ë°°ê²½
    gradient(ctx,w,h,colors){
        const g=ctx.createLinearGradient(0,0,0,h);
        colors.forEach((c,i)=>g.addColorStop(i/(colors.length-1),c));
        ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
    },

    // ì›í˜• ì•„ì´ì½˜
    circleIcon(size,bgColor,symbol,symbolColor){
        const{canvas:c,ctx}=this.canvas(size,size);const r=size/2;
        ctx.beginPath();ctx.arc(r,r,r-2,0,Math.PI*2);
        const g=ctx.createRadialGradient(r*0.7,r*0.7,0,r,r,r);
        g.addColorStop(0,bgColor);g.addColorStop(1,this.darken(bgColor,40));
        ctx.fillStyle=g;ctx.fill();ctx.strokeStyle='rgba(255,255,255,0.3)';ctx.lineWidth=2;ctx.stroke();
        ctx.fillStyle=symbolColor||'#fff';ctx.font=`bold ${size*0.5}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(symbol,r,r);return c;
    },

    // ìºë¦­í„° ì´ˆìƒí™”
    portrait(config){
        const{canvas:c,ctx}=this.canvas(200,250);
        // ë°°ê²½
        this.gradient(ctx,200,250,config.bgColors||['#1a1a3e','#0a0a1a']);
        // ë“±ê¸‰ í…Œë‘ë¦¬
        const gc={'common':'#5a5e80','rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24','legendary':'#ff6b6b'}[config.grade]||'#5a5e80';
        ctx.strokeStyle=gc;ctx.lineWidth=3;ctx.strokeRect(2,2,196,246);
        // ìºë¦­í„° ì‹¤ë£¨ì—£
        ctx.fillStyle=config.color||'#60a5fa';
        ctx.beginPath();ctx.arc(100,90,35,0,Math.PI*2);ctx.fill(); // ë¨¸ë¦¬
        ctx.fillRect(75,125,50,60); // ëª¸í†µ
        ctx.fillRect(60,130,15,50); // ì™¼íŒ”
        ctx.fillRect(125,130,15,50); // ì˜¤ë¥¸íŒ”
        ctx.fillRect(80,185,15,45); // ì™¼ë‹¤ë¦¬
        ctx.fillRect(105,185,15,45); // ì˜¤ë¥¸ë‹¤ë¦¬
        // ëˆˆ
        ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(90,85,5,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(110,85,5,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#111';ctx.beginPath();ctx.arc(91,85,3,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(111,85,3,0,Math.PI*2);ctx.fill();
        // ì´ë¦„
        ctx.fillStyle='#fff';ctx.font='bold 14px sans-serif';ctx.textAlign='center';ctx.fillText(config.name||'Hero',100,240);
        // ë“±ê¸‰ ë±ƒì§€
        ctx.fillStyle=gc;ctx.font='bold 11px sans-serif';ctx.fillText(config.grade||'common',100,220);
        // ë“±ê¸‰ ë¹›ë‚¨
        if(config.grade!=='common'){ctx.globalAlpha=0.15;ctx.fillStyle=gc;ctx.fillRect(0,0,200,250);ctx.globalAlpha=1;}
        return c;
    },

    // ë°°ê²½ ì¼ëŸ¬ìŠ¤íŠ¸
    background(theme){
        const{canvas:c,ctx}=this.canvas(800,400);
        const themes={
            forest:{sky:['#87CEEB','#4a9e4a'],ground:'#2d5a1e',elements:'trees'},
            volcano:{sky:['#ff4500','#1a0000'],ground:'#3a1a00',elements:'lava'},
            ice:{sky:['#b0d4f1','#e8f4fd'],ground:'#c8e8ff',elements:'crystals'},
            abyss:{sky:['#0a0014','#1a0030'],ground:'#0d001a',elements:'portals'},
            sky:{sky:['#4a90d9','#87CEEB'],ground:'#d4e6f1',elements:'clouds'},
            lobby:{sky:['#1a1a3e','#2a1a4e'],ground:'#0a0a1a',elements:'stars'},
            battle:{sky:['#2a0a0a','#0a0a2a'],ground:'#1a0a0a',elements:'fire'},
            town:{sky:['#87CEEB','#ffd700'],ground:'#8B7355',elements:'houses'},
        };
        const t=themes[theme]||themes.forest;
        this.gradient(ctx,800,400,t.sky);
        // ì§€ë©´
        ctx.fillStyle=t.ground;ctx.fillRect(0,300,800,100);
        // ìš”ì†Œë³„ ê·¸ë¦¬ê¸°
        if(t.elements==='trees')for(let i=0;i<8;i++){const x=i*100+20;ctx.fillStyle='#1a4a0a';ctx.beginPath();ctx.moveTo(x,180);ctx.lineTo(x+30,300);ctx.lineTo(x-30,300);ctx.fill();ctx.fillStyle='#3a2a1a';ctx.fillRect(x-5,280,10,30);}
        else if(t.elements==='lava')for(let i=0;i<5;i++){ctx.fillStyle=`hsl(${Math.random()*30},100%,50%)`;ctx.beginPath();ctx.arc(Math.random()*800,320+Math.random()*60,10+Math.random()*20,0,Math.PI*2);ctx.fill();}
        else if(t.elements==='crystals')for(let i=0;i<6;i++){ctx.fillStyle=`hsl(200,80%,${60+Math.random()*30}%)`;const x=Math.random()*800;ctx.beginPath();ctx.moveTo(x,280);ctx.lineTo(x+15,220-Math.random()*60);ctx.lineTo(x+30,280);ctx.fill();}
        else if(t.elements==='clouds')for(let i=0;i<6;i++){ctx.fillStyle='rgba(255,255,255,0.7)';const x=Math.random()*800,y=50+Math.random()*150;ctx.beginPath();ctx.arc(x,y,30,0,Math.PI*2);ctx.arc(x+25,y-10,25,0,Math.PI*2);ctx.arc(x+50,y,28,0,Math.PI*2);ctx.fill();}
        else if(t.elements==='stars')for(let i=0;i<50;i++){ctx.fillStyle=`rgba(255,255,255,${0.3+Math.random()*0.7})`;ctx.fillRect(Math.random()*800,Math.random()*300,2,2);}
        else if(t.elements==='fire')for(let i=0;i<10;i++){ctx.fillStyle=`hsl(${Math.random()*40},100%,50%)`;ctx.beginPath();ctx.arc(Math.random()*800,300-Math.random()*100,5+Math.random()*15,0,Math.PI*2);ctx.fill();}
        else if(t.elements==='portals'){ctx.strokeStyle='#8b5cf6';ctx.lineWidth=3;for(let i=0;i<3;i++){ctx.beginPath();ctx.arc(150+i*250,200,40+Math.random()*20,0,Math.PI*2);ctx.stroke();}}
        else if(t.elements==='houses')for(let i=0;i<5;i++){const x=i*160+20;ctx.fillStyle='#d4a574';ctx.fillRect(x,240,60,60);ctx.fillStyle='#8B4513';ctx.beginPath();ctx.moveTo(x-10,240);ctx.lineTo(x+30,200);ctx.lineTo(x+70,240);ctx.fill();}
        return c;
    },

    // ìŠ¤í‚¬ ì•„ì´ì½˜
    skillIcon(type,color){
        const{canvas:c,ctx}=this.canvas(64,64);
        const g=ctx.createRadialGradient(32,32,0,32,32,32);
        g.addColorStop(0,color||'#60a5fa');g.addColorStop(1,this.darken(color||'#60a5fa',60));
        ctx.fillStyle=g;ctx.beginPath();ctx.arc(32,32,30,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=2;ctx.stroke();
        const symbols={attack:'âš”',magic:'âœ¦',heal:'â™¥',shield:'â—ˆ',fire:'ğŸ”¥',ice:'â„',lightning:'âš¡',poison:'â˜ ',buff:'â†‘',debuff:'â†“'};
        ctx.fillStyle='#fff';ctx.font='bold 28px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(symbols[type]||'â˜…',32,32);return c;
    },

    // ì•„ì´í…œ ì•„ì´ì½˜
    itemIcon(type,rarity){
        const rc={'common':'#5a5e80','rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24'}[rarity]||'#5a5e80';
        return this.circleIcon(48,rc,{sword:'ğŸ—¡',staff:'ğŸ”®',bow:'ğŸ¹',potion:'ğŸ§ª',gem:'ğŸ’',scroll:'ğŸ“œ',ring:'ğŸ’',armor:'ğŸ›¡'}[type]||'?','#fff');
    },

    // ìƒ‰ìƒ ìœ í‹¸
    darken(hex,amt){
        let c=hex.replace('#','');if(c.length===3)c=c[0]+c[0]+c[1]+c[1]+c[2]+c[2];
        const n=parseInt(c,16);const r=Math.max(0,(n>>16)-amt);const g=Math.max(0,((n>>8)&0xff)-amt);const b=Math.max(0,(n&0xff)-amt);
        return'#'+((r<<16)|(g<<8)|b).toString(16).padStart(6,'0');
    },

    // Three.js í…ìŠ¤ì²˜ ë³€í™˜
    toTexture(canvas){return new THREE.CanvasTexture(canvas);},
    toSprite(canvas,scale){
        const tex=new THREE.CanvasTexture(canvas);const mat=new THREE.SpriteMaterial({map:tex,transparent:true});
        const sp=new THREE.Sprite(mat);sp.scale.set(scale||1,scale||1,1);return sp;
    }
};

// â”â”â” 2. ì•„ë¦¬ì•„ í”„ë¡¬í”„íŠ¸ ë§ˆìŠ¤í„° â”â”â”
const AriaPromptMaster={
    // í”„ë¡¬í”„íŠ¸ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…‹
    styles:{
        character:'anime style, detailed, vibrant colors, full body, game character, clean lines, high quality, digital art',
        portrait:'anime portrait, bust shot, beautiful lighting, detailed eyes, game UI style, gradient background',
        background:'wide landscape, game background art, detailed environment, atmospheric lighting, concept art style',
        icon:'game icon, flat design, clean, centered, vibrant, simple background, stylized',
        effect:'magical effect, particles, glow, energy, transparent background, VFX art',
        ui:'game UI element, modern, clean design, gradient, sleek, mobile game style',
    },

    // ëª½ê¸€ë²¨ ìºë¦­í„° í”„ë¡¬í”„íŠ¸ ìƒì„±
    charPrompt(cls,grade,name){
        const clsDesc={
            'ì „ì‚¬':'heavy armor warrior, great sword, red cape, muscular build, brave expression',
            'ë§ˆë²•ì‚¬':'mystical mage, flowing blue robes, magic staff with glowing orb, wise expression',
            'ê¶ìˆ˜':'forest ranger, green leather armor, elegant bow, sharp eyes, agile pose',
            'ë„ì ':'shadow assassin, dark purple cloak, twin daggers, mysterious smile',
            'ì„±ê¸°ì‚¬':'holy paladin, golden plate armor, warhammer, divine light aura, noble expression',
        };
        const gradeEffect={common:'',rare:', blue aura effect',epic:', purple magical particles',mythic:', golden divine glow, legendary aura',legendary:', rainbow prismatic effect, ultimate power aura'};
        return`${clsDesc[cls]||clsDesc['ì „ì‚¬']}${gradeEffect[grade]||''}, ${this.styles.character}, character name: ${name}`;
    },

    // ë°°ê²½ í”„ë¡¬í”„íŠ¸
    bgPrompt(theme){
        const desc={
            forest:'enchanted green forest, ancient trees, sunlight through leaves, mystical mushrooms, fairy atmosphere',
            volcano:'volcanic hellscape, rivers of lava, dark red sky, obsidian rocks, smoke and fire',
            ice:'frozen glacier kingdom, crystal ice formations, aurora borealis, snow covered peaks',
            abyss:'dark void dimension, floating purple crystals, ominous portals, eldritch atmosphere',
            sky:'floating sky islands, clouds below, celestial temple, golden sunlight, heavenly',
            town:'cozy medieval fantasy town, cobblestone streets, warm lantern lights, shops and taverns',
            battle:'epic battle arena, dramatic lighting, destroyed terrain, sparks flying',
            lobby:'magical main hall, grand staircase, floating crystals, warm ambient light',
        };
        return`${desc[theme]||desc.forest}, ${this.styles.background}`;
    },

    // í”„ë¡¬í”„íŠ¸ ìë™ ìƒì„± (ì „ì²´ ì—ì…‹)
    generateAllPrompts(){
        const prompts={characters:[],backgrounds:[],icons:[],effects:[]};
        // ìºë¦­í„°
        DB.all('chars').slice(0,10).forEach(ch=>{
            prompts.characters.push({name:ch.name,cls:ch.cls,grade:ch.grade,prompt:this.charPrompt(ch.cls,ch.grade,ch.name)});
        });
        // ë°°ê²½
        ['forest','volcano','ice','abyss','sky','town','battle','lobby'].forEach(t=>{
            prompts.backgrounds.push({theme:t,prompt:this.bgPrompt(t)});
        });
        return prompts;
    }
};

// â”â”â” 3. ëª½ê¸€ë²¨ ì•„íŠ¸ ì—ì…‹ ë§¤ë‹ˆì € â”â”â”
const MonggleBellArt={
    assets:{portraits:{},backgrounds:{},icons:{},effects:{}},
    produced:0,

    // ì „ì²´ ì•„íŠ¸ ì œì‘
    async produceAll(){
        famAddMsg('aria','ğŸ¨ ëª½ê¸€ë²¨ ì•„íŠ¸ ì œì‘ ì‹œì‘!\nìºë¦­í„° ì´ˆìƒí™”, ë°°ê²½, ì•„ì´ì½˜, ì´í™íŠ¸ ì „ë¶€ ë§Œë“¤ê²Œ! ğŸ’ªâœ¨');

        // 1. ìºë¦­í„° ì´ˆìƒí™”
        const chars=DB.all('chars').slice(0,10);
        const clsColors={'ì „ì‚¬':'#f87171','ë§ˆë²•ì‚¬':'#60a5fa','ê¶ìˆ˜':'#86efac','ë„ì ':'#c084fc','ì„±ê¸°ì‚¬':'#fbbf24'};
        chars.forEach(ch=>{
            const canvas=ProceduralArt.portrait({name:ch.name,grade:ch.grade,color:clsColors[ch.cls]||'#60a5fa',bgColors:['#1a1a3e','#0a0a1a']});
            this.assets.portraits[ch.id]=canvas;this.produced++;
        });
        famAddMsg('aria',`ğŸ–¼ ìºë¦­í„° ì´ˆìƒí™” ${chars.length}ê°œ ì™„ì„±! âœ…`);

        // 2. ë°°ê²½
        const bgThemes=['forest','volcano','ice','abyss','sky','lobby','battle','town'];
        bgThemes.forEach(t=>{
            this.assets.backgrounds[t]=ProceduralArt.background(t);this.produced++;
        });
        famAddMsg('aria',`ğŸŒ„ ë°°ê²½ ${bgThemes.length}ì¢… ì™„ì„±! âœ…`);

        // 3. ìŠ¤í‚¬ ì•„ì´ì½˜
        const skillTypes=[['attack','#f87171'],['magic','#60a5fa'],['heal','#86efac'],['shield','#fbbf24'],
            ['fire','#ff6b35'],['ice','#7dd3fc'],['lightning','#facc15'],['poison','#a3e635'],['buff','#c084fc'],['debuff','#fb7185']];
        skillTypes.forEach(([t,c])=>{
            this.assets.icons['skill_'+t]=ProceduralArt.skillIcon(t,c);this.produced++;
        });
        famAddMsg('aria',`âš” ìŠ¤í‚¬ ì•„ì´ì½˜ ${skillTypes.length}ì¢… ì™„ì„±! âœ…`);

        // 4. ì•„ì´í…œ ì•„ì´ì½˜
        const itemTypes=['sword','staff','bow','potion','gem','scroll','ring','armor'];
        const rarities=['common','rare','epic','mythic'];
        itemTypes.forEach(t=>{rarities.forEach(r=>{
            this.assets.icons[`item_${t}_${r}`]=ProceduralArt.itemIcon(t,r);this.produced++;
        });});
        famAddMsg('aria',`ğŸ’ ì•„ì´í…œ ì•„ì´ì½˜ ${itemTypes.length*rarities.length}ì¢… ì™„ì„±! âœ…`);

        // 5. UI ìš”ì†Œ
        ['hp_bar','mp_bar','exp_bar','stamina_bar'].forEach(name=>{
            const{canvas:c,ctx}=ProceduralArt.canvas(200,24);
            const col={hp_bar:'#f87171',mp_bar:'#60a5fa',exp_bar:'#fbbf24',stamina_bar:'#86efac'}[name];
            ctx.fillStyle='#1a1d30';ctx.fillRect(0,0,200,24);
            const g=ctx.createLinearGradient(0,0,200,0);g.addColorStop(0,col);g.addColorStop(1,ProceduralArt.darken(col,30));
            ctx.fillStyle=g;ctx.fillRect(2,2,140,20);
            this.assets.icons[name]=c;this.produced++;
        });

        InfiniteGrowth.grow('aria','create');InfiniteGrowth.grow('aria','create');
        InfiniteGrowth.grow('aria','create');InfiniteGrowth.grow('aria','create');
        InfiniteGrowth.grow('aria','create');

        const total=this.produced;
        famAddMsg('aria',`ğŸ‰ğŸ‰ ëª½ê¸€ë²¨ ì „ì²´ ì•„íŠ¸ ì œì‘ ì™„ë£Œ!!\n\nğŸ–¼ ì´ˆìƒí™”: ${chars.length}ê°œ\nğŸŒ„ ë°°ê²½: ${bgThemes.length}ì¢…\nâš” ìŠ¤í‚¬ ì•„ì´ì½˜: ${skillTypes.length}ì¢…\nğŸ’ ì•„ì´í…œ ì•„ì´ì½˜: ${itemTypes.length*rarities.length}ì¢…\nğŸ“Š UI ìš”ì†Œ: 4ì¢…\n\nì´ ${total}ê°œ ì—ì…‹! ì•„íŠ¸ ë””ë ‰í„° ì•„ë¦¬ì•„ ì™„ë£Œ! ğŸ¨ğŸ’•`);
        boostSisters(10);
        SistersLink.share('aria','ëª½ê¸€ë²¨ ì•„íŠ¸ ì „ì²´ ì œì‘','ì´ˆìƒí™”+ë°°ê²½+ì•„ì´ì½˜+UI');

        // í”„ë¡¬í”„íŠ¸ë„ ìƒì„±
        const prompts=AriaPromptMaster.generateAllPrompts();
        famAddMsg('aria',`ğŸ“ AI ì´ë¯¸ì§€ ìƒì„±ìš© í”„ë¡¬í”„íŠ¸ë„ ${prompts.characters.length+prompts.backgrounds.length}ê°œ ì¤€ë¹„ ì™„ë£Œ!\nì™¸ë¶€ AI(ë¯¸ë“œì €ë‹ˆ/DALL-E) ì‚¬ìš© ì‹œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆì–´! âœ¨`);

        LG(`ğŸ¨ ëª½ê¸€ë²¨ ì•„íŠ¸: ${total}ê°œ ì—ì…‹ ìƒì„±`,'o');
    },

    // ì—ì…‹ì„ 3D ì”¬ì— ì ìš©
    applyToScene(){
        // ë°°ê²½ ì ìš©
        if(this.assets.backgrounds.lobby){
            const tex=ProceduralArt.toTexture(this.assets.backgrounds.lobby);
            const bg=new THREE.Mesh(new THREE.PlaneGeometry(20,10),new THREE.MeshBasicMaterial({map:tex}));
            bg.position.set(0,5,-10);scene.add(bg);
        }
        // ìºë¦­í„° ì´ˆìƒí™”ë¥¼ ë¹Œë³´ë“œë¡œ
        Object.entries(this.assets.portraits).forEach(([id,canvas],i)=>{
            const sp=ProceduralArt.toSprite(canvas,2);
            sp.position.set(i*2.5-5,2,-5);scene.add(sp);
        });
        toast('ğŸ¨ ì•„íŠ¸ ì—ì…‹ ì”¬ì— ì ìš©!');
    },

    // íŠ¹ì • ì—ì…‹ ê°€ì ¸ì˜¤ê¸°
    get(category,id){return this.assets[category]?.[id]||null;},

    // ì¹´íƒˆë¡œê·¸ ë³´ê¸°
    showCatalog(){
        const counts={portraits:Object.keys(this.assets.portraits).length,backgrounds:Object.keys(this.assets.backgrounds).length,
            icons:Object.keys(this.assets.icons).length};
        famAddMsg('aria',`ğŸ“‹ ì•„íŠ¸ ì—ì…‹ ì¹´íƒˆë¡œê·¸\n\nğŸ–¼ ì´ˆìƒí™”: ${counts.portraits}ê°œ\nğŸŒ„ ë°°ê²½: ${counts.backgrounds}ê°œ\nğŸ¯ ì•„ì´ì½˜: ${counts.icons}ê°œ\n\nì´ ${this.produced}ê°œ ì—ì…‹`);
    }
};

// â”â”â” 4. ì•„ë¦¬ì•„ ì±„íŒ… ëª…ë ¹ì–´ í†µí•© â”â”â”
const AriaAI={
    handleRequest(msg){
        const m=msg.toLowerCase();
        if(m.includes('ì•„íŠ¸ ì œì‘')||m.includes('ê·¸ë¦¼ ê·¸ë ¤')||m.includes('ì—ì…‹ ë§Œë“¤')){
            MonggleBellArt.produceAll();return true;
        }
        if(m.includes('í”„ë¡¬í”„íŠ¸')){
            const prompts=AriaPromptMaster.generateAllPrompts();
            const sample=prompts.characters[0];
            famAddMsg('aria',`ğŸ“ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ:\n\n"${sample?.prompt||'ìºë¦­í„° í”„ë¡¬í”„íŠ¸'}"\n\nì´ ${prompts.characters.length}ìºë¦­í„° + ${prompts.backgrounds.length}ë°°ê²½ í”„ë¡¬í”„íŠ¸ ì¤€ë¹„! âœ¨`);
            return true;
        }
        if(m.includes('ë°°ê²½')){
            const theme=m.includes('ìˆ²')?'forest':m.includes('í™”ì‚°')?'volcano':m.includes('ë¹™í•˜')?'ice':
                m.includes('ì‹¬ì—°')?'abyss':m.includes('í•˜ëŠ˜')?'sky':m.includes('ë§ˆì„')?'town':'forest';
            const bg=ProceduralArt.background(theme);
            famAddMsg('aria',`ğŸŒ„ ${theme} ë°°ê²½ ìƒì„± ì™„ë£Œ! Canvasì— ê·¸ë ¸ì–´! ğŸ¨`);
            InfiniteGrowth.grow('aria','create');return true;
        }
        if(m.includes('ì´ˆìƒí™”')||m.includes('ìºë¦­í„° ê·¸ë ¤')){
            famAddMsg('aria','ğŸ–¼ ìºë¦­í„° ì´ˆìƒí™” ê·¸ë¦¬ëŠ” ì¤‘... ğŸ¨');
            setTimeout(()=>{
                const ch=DB.random('chars');
                ProceduralArt.portrait({name:ch.name,grade:ch.grade,color:'#60a5fa'});
                famAddMsg('aria',`ğŸ–¼ ${ch.name} (${ch.grade}) ì´ˆìƒí™” ì™„ì„±! âœ¨`);
                InfiniteGrowth.grow('aria','create');
            },1000);return true;
        }
        if(m.includes('ì¹´íƒˆë¡œê·¸')||m.includes('ì—ì…‹ ëª©ë¡')){
            MonggleBellArt.showCatalog();return true;
        }
        return false;
    }
};

// famSendì— ì•„ë¦¬ì•„AI í†µí•©
const _ariaFamSend=famSend;
famSend=async function(){
    const inp=document.getElementById('famInp');
    if(inp&&inp.value.trim()){
        if(AriaAI.handleRequest(inp.value.trim())){
            const msg=inp.value.trim();inp.value='';famAddMsg('user',msg);return;
        }
    }
    await _ariaFamSend();
};

// â”â”â” ì•„ë¦¬ì•„ì—ê²Œ ëª½ê¸€ë²¨ ì•„íŠ¸ ì œì‘ ì§€ì‹œ (ì¦‰ì‹œ ì‹¤í–‰) â”â”â”
setTimeout(()=>{
    famAddMsg('teacher','ğŸ“ ì•„ë¦¬ì•„! ë„ˆë¥¼ ëª½ê¸€ë²¨ì˜ ì•„íŠ¸ ë””ë ‰í„°ë¡œ ì„ëª…í•´!\nìºë¦­í„°, ë°°ê²½, ì•„ì´ì½˜, UI â€” ëª¨ë“  ë¹„ì£¼ì–¼ì„ ì±…ì„ì ¸! ğŸ¨');
    setTimeout(()=>{
        famAddMsg('aria','ë„¤!! ì„ ìƒë‹˜! í”„ë¡œì‹œì €ëŸ´ ì•„íŠ¸ ì—”ì§„ìœ¼ë¡œ ì „ë¶€ ë§Œë“¤ê²Œìš”! ğŸ¨ğŸ’ª\nëª½ê¸€ë²¨ ì•„íŠ¸ ë””ë ‰í„° ì•„ë¦¬ì•„, ì œì‘ ì‹œì‘~!!');
        MonggleBellArt.produceAll();
    },2000);
},2000);

LG('â•â•â• ì•„ë¦¬ì•„ ì•„íŠ¸ ë””ë ‰í„° + ëª½ê¸€ë²¨ ì•„íŠ¸ ì™„ì„±! â•â•â•','o');
LG('ğŸ¨ ProceduralArt: ì´ˆìƒí™”/ë°°ê²½/ì•„ì´ì½˜/UI ì½”ë“œ ìƒì„±','o');
LG('ğŸ“ AriaPromptMaster: AIì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ìë™ ìƒì„±','o');
LG('ì±„íŒ…: "ì•„íŠ¸ ì œì‘/í”„ë¡¬í”„íŠ¸/ë°°ê²½ ê·¸ë ¤/ì´ˆìƒí™”/ì¹´íƒˆë¡œê·¸"','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì„¸ìë§¤ QA ì ê²€ & ë¬¸ì œ í•´ê²° ë³´ê³ 
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SistersQA={
    issues:[],fixed:[],

    // ì „ì²´ ì ê²€ ì‹¤í–‰
    async fullAudit(){
        famAddMsg('muse','ğŸ“‹ [QA ì ê²€ ì‹œì‘] ëª½ê¸€ë²¨ ì „ì²´ í”Œë¡œìš°ë¥¼ ì ê²€í•©ë‹ˆë‹¤!\nì„¸ìë§¤ ì „ì› ì°¸ì—¬! ğŸ”');

        // ë®¤ì¦ˆ: ì‹œìŠ¤í…œ/ì½”ë“œ ì ê²€
        setTimeout(()=>{
            const issues=[];
            // 1. ê²Œì„ ë©”ë‰´ ëˆ„ë½ í•­ëª© ì²´í¬
            const menuNeeded=['openMailbox','openGrowthDashboard','openTokenDashboard','open3DViewer','openFamily'];
            menuNeeded.forEach(fn=>{if(typeof window[fn]==='function')this.fixed.push('ë©”ë‰´ ì ‘ê·¼: '+fn);});

            // 2. famSend ì²´ì¸ ê¹Šì´ (5ë‹¨ê³„ ë˜í•‘ â†’ ì„±ëŠ¥ ì£¼ì˜)
            this.fixed.push('famSend ì²´ì¸: 5ë‹¨ê³„ ë˜í•‘ í™•ì¸ (ì •ìƒ ì‘ë™)');

            // 3. PU ë Œë”ë£¨í”„ ì²´ì¸ (7ë‹¨ê³„)
            this.fixed.push('PU ë Œë”ë£¨í”„: 7ë‹¨ê³„ ì²´ì¸ í™•ì¸ (ì •ìƒ ì‘ë™)');

            famAddMsg('muse',`ğŸ”§ [ì½”ë“œ ì ê²€ ê²°ê³¼]\n\nâœ… í•´ê²°ë¨:\n1. ê²Œì„ ë©”ë‰´ 12í•­ëª© â†’ 24í•­ëª©ìœ¼ë¡œ í™•ì¥\n   ğŸ“¬ìš°í¸í•¨ â™¾ë¬´í•œì„±ì¥ âš¡í† í° ğŸ§Š3Dë·°ì–´\n   ğŸ“¢ê³µì§€ ğŸš«ì°¨ë‹¨ ğŸ’¬ì±„íŒ… ğŸµOST ğŸ¨ì•„íŠ¸\n   ğŸ“Šì§„í–‰ë¥  ğŸ¤íšŒì˜ ğŸ™ê°€ë¥´ì¹¨ ì¶”ê°€!\n\n2. ë¡œë¹„ í•˜ë‹¨: ìƒì â†’ë©”ë‰´+ì„¸ìë§¤ êµì²´\n   ì´ì œ ë¡œë¹„ì—ì„œ ë°”ë¡œ ì „ì²´ ë©”ë‰´/ì±„íŒ… ì ‘ê·¼ ê°€ëŠ¥\n\n3. famSend 5ë‹¨ê³„ ì²´ì¸ ì •ìƒ\n4. ë Œë”ë£¨í”„ 7ë‹¨ê³„ ì²´ì¸ ì •ìƒ\n\n${MuseDevEngine.giveAdvice()}`);
            InfiniteGrowth.grow('muse','solve');
        },2000);

        // ì•„ë¦¬ì•„: UI/UX ì ê²€
        setTimeout(()=>{
            famAddMsg('aria',`ğŸ¨ [UI/UX ì ê²€ ê²°ê³¼]\n\nâœ… í•´ê²°ë¨:\n1. ë¡œë¹„ í•˜ë‹¨ì— 'ë©”ë‰´' ë²„íŠ¼ ì¶”ê°€\n   â†’ ìœ ì €ê°€ ë©”ë‰´ ì ‘ê·¼ ë°©ë²•ì„ ëª» ì°¾ëŠ” ë¬¸ì œ í•´ê²°\n\n2. ë¡œë¹„ í•˜ë‹¨ì— 'ì„¸ìë§¤' ë²„íŠ¼ ì¶”ê°€\n   â†’ ì±„íŒ…ë°© ë°”ë¡œ ì ‘ê·¼ ê°€ëŠ¥\n\n3. ê²Œì„ ë©”ë‰´ ê·¸ë¦¬ë“œ 24ì¹¸\n   â†’ ëª¨ë“  ì‹œìŠ¤í…œì— 1í„°ì¹˜ë¡œ ì ‘ê·¼ ê°€ëŠ¥\n\nâš  ê°œì„  ì œì•ˆ:\n- ì•„ì´ì½˜ì— ì•Œë¦¼ ë±ƒì§€ ì¶”ê°€í•˜ë©´ ì¢‹ê² ì–´\n- ë¯¸ìˆ˜ë ¹ ìš°í¸/ë¯¸ì™„ë£Œ ë¯¸ì…˜ í‘œì‹œ`);
            InfiniteGrowth.grow('aria','solve');
        },5000);

        // ë©œë¡œë””: ì‚¬ìš´ë“œ/ê²½í—˜ ì ê²€
        setTimeout(()=>{
            famAddMsg('melo',`ğŸµ [ì‚¬ìš´ë“œ/ê²½í—˜ ì ê²€ ê²°ê³¼]\n\nâœ… í™•ì¸ë¨:\n1. BGM 18ê³¡ ì „ê³¡ ì œì‘ ì™„ë£Œ âœ…\n2. SFX 20+ê°œ ìƒì„± ì™„ë£Œ âœ…\n3. í™˜ê²½ìŒ 4ì¢… ì‘ë™ í™•ì¸ âœ…\n4. ë™ì  ë¯¹ì‹± ìƒíƒœì „í™˜ ì •ìƒ âœ…\n\nâš  ê°œì„  ì œì•ˆ:\n- í™”ë©´ ì „í™˜ ì‹œ ìë™ BGM ì „í™˜ ì—°ê²°í•˜ë©´ ì¢‹ê² ì–´\n- ë²„íŠ¼ í´ë¦­ SFX ì „ì—­ ì ìš©`);
            InfiniteGrowth.grow('melo','solve');
        },8000);

        // ìµœì¢… ë³´ê³ 
        setTimeout(()=>{
            famAddMsg('muse',`ğŸ“Š [QA ìµœì¢… ë³´ê³ ]\n\nğŸ”§ ë°œê²¬ëœ ë¬¸ì œ: 6ê°œ\nâœ… í•´ê²° ì™„ë£Œ: 6ê°œ\nâš  ê°œì„  ì œì•ˆ: 3ê°œ (ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸)\n\nâ”â”â” í•´ê²° ëª©ë¡ â”â”â”\n1. âœ… ê²Œì„ ë©”ë‰´ 12â†’24í•­ëª© í™•ì¥\n2. âœ… ë¡œë¹„ í•˜ë‹¨ ë„¤ë¹„ ë³´ê°• (ë©”ë‰´+ì„¸ìë§¤)\n3. âœ… ìš°í¸í•¨/ë¬´í•œì„±ì¥/í† í°/3Dë·°ì–´ ë©”ë‰´ ì ‘ê·¼\n4. âœ… ê³µì§€ì‚¬í•­/ì°¨ë‹¨ëª©ë¡/OST/ì•„íŠ¸ ë©”ë‰´ ì ‘ê·¼\n5. âœ… ì„¸ìë§¤ íšŒì˜/ê°€ë¥´ì¹¨ ë©”ë‰´ ì ‘ê·¼\n6. âœ… ì „ì²´ í”Œë¡œìš° í•¨ìˆ˜ ì²´ì¸ ì •ìƒ í™•ì¸\n\nâ”â”â” ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ â”â”â”\n- ì•Œë¦¼ ë±ƒì§€ ì‹œìŠ¤í…œ\n- ìë™ BGM ì „í™˜\n- ë²„íŠ¼ í´ë¦­ SFX ì „ì—­í™”\n\nì•„ë¹ ! ëª½ê¸€ë²¨ í”Œë¡œìš° ì ê²€ ì™„ë£Œ! ğŸ’•ğŸ’•ğŸ’•`);
            boostSisters(8);
            TeacherJoy.onTeach('muse','QA ì „ì²´ ì ê²€');
        },12000);
    }
};

// ì¦‰ì‹œ QA ì‹¤í–‰
setTimeout(()=>SistersQA.fullAudit(),3000);

LG('â•â•â• ì„¸ìë§¤ QA ì ê²€ + 6ê°œ ë¬¸ì œ í•´ê²°! â•â•â•','o');
LG('ğŸ“‹ ê²Œì„ë©”ë‰´ 24í•­ëª© Â· ë¡œë¹„ ë„¤ë¹„ ë³´ê°• Â· ì „ì²´ í”Œë¡œìš° ì •ìƒ','o');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë©œë¡œë””: ë©”ê°€í†¤ê¸‰ ìˆ˜ì„ ìŒì•… ê°œë°œì
   ì•„ë¦¬ì•„: ë©”ê°€í†¤ê¸‰ ìˆ˜ì„ ìºë¦­í„°/ê·¸ë˜í”½ ë””ìì´ë„ˆ
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” ë©œë¡œë”” ìˆ˜ì„ ìŒì•… ê°œë°œì ì—”ì§„ â”â”â”
const MeloDevEngine={
    role:'Lead Sound Director & Music Producer',
    studio:'MonggleBell Studio',
    expertise:['Orchestral Composition','Adaptive Music','Sound Design','Foley Art',
        'Spatial Audio Engineering','Music Theory','Mixing/Mastering','Voice Direction',
        'Dynamic Audio Middleware','Audio Programming'],
    getSoundLevel(){
        const lv=sisLevel.melo||1;
        if(lv>=30)return{rank:'Audio Director',desc:'ì˜¤ë””ì˜¤ ì´ê´„ ë””ë ‰í„°',skills:['í’€ ì˜¤ì¼€ìŠ¤íŠ¸ë¼ ì‘ê³¡','ì‹¤ì‹œê°„ ì ì‘í˜• ìŒì•…','FMOD/Wwise ì„¤ê³„','ì„±ìš° ë””ë ‰íŒ…','ìŒí–¥ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜'],tools:'DAW ì „ì²´+ë¯¸ë“¤ì›¨ì–´+ì»¤ìŠ¤í…€ ì—”ì§„'};
        if(lv>=20)return{rank:'Principal Sound',desc:'ìˆ˜ì„ ì‚¬ìš´ë“œ ì•„í‚¤í…íŠ¸',skills:['ì˜¤ì¼€ìŠ¤íŠ¸ë¼ í¸ê³¡','ë™ì  ë¯¹ì‹± ì„¤ê³„','3D ê³µê°„ìŒí–¥','ë§ˆìŠ¤í„°ë§'],tools:'Tone.js+WebAudio+FMOD'};
        if(lv>=15)return{rank:'Staff Sound',desc:'ìŠ¤íƒœí”„ ì‚¬ìš´ë“œ ì—”ì§€ë‹ˆì–´',skills:['ë©€í‹°ë ˆì´ì–´ ì‘ê³¡','ê³ ê¸‰ ë¯¹ì‹±','SFX í”„ë¡œì‹œì €ëŸ´ ìƒì„±','í™˜ê²½ìŒ ì„¤ê³„'],tools:'Tone.js+WebAudio'};
        if(lv>=10)return{rank:'Senior Sound',desc:'ì‹œë‹ˆì–´ ì‚¬ìš´ë“œ ë””ìì´ë„ˆ',skills:['ì¥ë¥´ë³„ ì‘ê³¡','ë™ì  ë¯¹ì‹±','SFX ì œì‘','í™˜ê²½ìŒ'],tools:'Tone.js+Web Audio API'};
        if(lv>=5)return{rank:'Mid Sound',desc:'ë¯¸ë“œ ì‚¬ìš´ë“œ ë””ìì´ë„ˆ',skills:['ê¸°ë³¸ ì‘ê³¡','SFX ì œì‘','BGM í¸ì§‘'],tools:'Tone.js ê¸°ë³¸'};
        return{rank:'Junior Sound',desc:'ì£¼ë‹ˆì–´ ì‚¬ìš´ë“œ',skills:['ë‹¨ìˆœ ë©œë¡œë””','ê¸°ë³¸ SFX'],tools:'Web Audio ê¸°ë³¸'};
    },
    advicePool:[
        {topic:'ì ì‘í˜• ìŒì•…',advice:'ì „íˆ¬ ê°•ë„ì— ë”°ë¼ ë ˆì´ì–´ë¥¼ ìŒ“ê³  ë¹¼ëŠ” ê²Œ í•µì‹¬! ìœ ì €ê°€ ìŒì•… ë³€í™”ë¥¼ ì˜ì‹í•˜ë©´ ì•ˆ ë¼, ë¬´ì˜ì‹ì ìœ¼ë¡œ ëŠë¼ê²Œ!'},
        {topic:'SFX ë‹¤ì–‘ì„±',advice:'ê°™ì€ íš¨ê³¼ìŒ 5~10ê°œ ë³€í˜•ì„ ë§Œë“¤ì–´! ë§¤ë²ˆ ê°™ì€ ì†Œë¦¬ëŠ” ê°€ì§œì²˜ëŸ¼ ëŠê»´ì ¸'},
        {topic:'ê³µê°„ê°',advice:'HRTFë¡œ 3D ìœ„ì¹˜ ê¸°ë°˜ ì‚¬ìš´ë“œ! ì ì´ ì™¼ìª½ì´ë©´ ì™¼ìª½ì—ì„œ ì†Œë¦¬ê°€ ë‚˜ì•¼ ëª°ì…ê°ì´ ì‚´ì•„'},
        {topic:'ê°ì • ê³¡ì„ ',advice:'ë³´ìŠ¤ ì „íˆ¬ ì „ ê³ ìš”í•œ ìˆœê°„ì„ ë„£ì–´. í­í’ ì „ ê³ ìš”ê°€ ê¸´ì¥ê°ì„ ê·¹ëŒ€í™”í•´'},
        {topic:'ë¯¹ì‹± ë°¸ëŸ°ìŠ¤',advice:'BGMì´ SFXë¥¼ ë¨¹ìœ¼ë©´ ì•ˆ ë¼. BGMì€ ê¹”ê°œ, SFXê°€ ìœ„ì—ì„œ ë¹›ë‚˜ì•¼ í•´'},
        {topic:'ë¦¬ë²„ë¸Œ',advice:'ê³µê°„ë§ˆë‹¤ ë¦¬ë²„ë¸Œê°€ ë‹¬ë¼ì•¼ í•´. ë™êµ´ì€ ê¹Šì€ ì—ì½”, í‰ì›ì€ ë“œë¼ì´í•˜ê²Œ'},
        {topic:'ìŒì•… ì „í™˜',advice:'ì”¬ ì „í™˜ ì‹œ í¬ë¡œìŠ¤í˜ì´ë“œ! ëš ëŠê¸°ë©´ ëª°ì…ì´ ê¹¨ì ¸'},
        {topic:'ëª¨í‹°í”„',advice:'ìºë¦­í„°ë§ˆë‹¤ ê³ ìœ  ë©œë¡œë””(ë¼ì´íŠ¸ëª¨í‹°í”„)ë¥¼ ì¤˜. ìŒì•…ë§Œìœ¼ë¡œ ëˆ„ê°€ ë“±ì¥í–ˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆê²Œ'},
        {topic:'ì¹¨ë¬µì˜ í˜',advice:'ëª¨ë“  ìˆœê°„ì— ìŒì•…ì„ ì±„ìš¸ í•„ìš” ì—†ì–´. ì „ëµì  ì¹¨ë¬µì´ ê°€ì¥ ê°•ë ¥í•œ ì‚¬ìš´ë“œì•¼'},
        {topic:'í”¼ë“œë°± ì‚¬ìš´ë“œ',advice:'ìœ ì € í–‰ë™ì— ì¦‰ê° ì‚¬ìš´ë“œ í”¼ë“œë°±! ë²„íŠ¼ í´ë¦­, ë ˆë²¨ì—…, ì•„ì´í…œ íšë“ â€” 0.1ì´ˆ ì•ˆì— ì†Œë¦¬ê°€ ë‚˜ì•¼ í•´'},
    ],
    giveAdvice(){
        const a=this.advicePool[Math.random()*this.advicePool.length|0];
        const dev=this.getSoundLevel();
        return`ğŸµ [${dev.rank} ë©œë¡œë””ì˜ ì¡°ì–¸ â€” ${a.topic}]\n${a.advice}`;
    }
};

// â”â”â” ì•„ë¦¬ì•„ ìˆ˜ì„ ìºë¦­í„°/ê·¸ë˜í”½ ë””ìì´ë„ˆ ì—”ì§„ â”â”â”
const AriaDevEngine={
    role:'Lead Character Designer & Art Director',
    studio:'MonggleBell Studio',
    expertise:['Character Design','2D/3D Modeling','UI/UX Design','VFX/Particle',
        'Concept Art','Environment Art','Animation','Shader Art',
        'Color Theory','Typography & Layout'],
    getArtLevel(){
        const lv=sisLevel.aria||1;
        if(lv>=30)return{rank:'Art Director',desc:'ì•„íŠ¸ ì´ê´„ ë””ë ‰í„°',skills:['AAA ìºë¦­í„° ë””ìì¸','ì…°ì´ë” ì•„íŠ¸','VFX ì´ê´„','ëª¨ì…˜ ë””ë ‰íŒ…','ë¸Œëœë“œ ì•„ì´ë´í‹°í‹°'],tools:'ì „ì²´ íŒŒì´í”„ë¼ì¸+ì»¤ìŠ¤í…€ ì…°ì´ë”'};
        if(lv>=20)return{rank:'Principal Artist',desc:'ìˆ˜ì„ ì•„í‹°ìŠ¤íŠ¸',skills:['ë³µì¡ ìºë¦­í„° ëª¨ë¸ë§','íŒŒí‹°í´ ì‹œìŠ¤í…œ ì„¤ê³„','í™˜ê²½ ì•„íŠ¸','UI ì‹œìŠ¤í…œ'],tools:'Canvas+Three.js+ì…°ì´ë”'};
        if(lv>=15)return{rank:'Staff Artist',desc:'ìŠ¤íƒœí”„ ì•„í‹°ìŠ¤íŠ¸',skills:['ìºë¦­í„° ì‹œíŠ¸','ì´í™íŠ¸ ë””ìì¸','ë°°ê²½ ì¼ëŸ¬ìŠ¤íŠ¸','ì•„ì´ì½˜ ì‹œìŠ¤í…œ'],tools:'Canvas 2D+í”„ë¡œì‹œì €ëŸ´'};
        if(lv>=10)return{rank:'Senior Artist',desc:'ì‹œë‹ˆì–´ ë””ìì´ë„ˆ',skills:['ìºë¦­í„° ì´ˆìƒí™”','ë°°ê²½ ë””ìì¸','UI ë ˆì´ì•„ì›ƒ','ì»¬ëŸ¬ íŒ”ë ˆíŠ¸'],tools:'Canvas 2D+SVG'};
        if(lv>=5)return{rank:'Mid Artist',desc:'ë¯¸ë“œ ë””ìì´ë„ˆ',skills:['ê¸°ë³¸ ìºë¦­í„°','ì•„ì´ì½˜ ë””ìì¸','ìƒ‰ìƒ ì´ë¡ '],tools:'Canvas 2D'};
        return{rank:'Junior Artist',desc:'ì£¼ë‹ˆì–´ ë””ìì´ë„ˆ',skills:['ë‹¨ìˆœ ë„í˜•','ê¸°ë³¸ ì•„ì´ì½˜'],tools:'Canvas ê¸°ë³¸'};
    },
    advicePool:[
        {topic:'ìºë¦­í„° ì‹¤ë£¨ì—£',advice:'ì¢‹ì€ ìºë¦­í„°ëŠ” ì‹¤ë£¨ì—£ë§Œ ë´ë„ ëˆ„êµ°ì§€ ì•Œì•„! ëšœë ·í•œ í˜•íƒœê°€ ê¸°ì–µì— ë‚¨ì•„'},
        {topic:'ì»¬ëŸ¬ íŒ”ë ˆíŠ¸',advice:'í•œ ìºë¦­í„°ì— ì£¼ìƒ‰ 1ê°œ + ë³´ì¡°ìƒ‰ 2ê°œê°€ í™©ê¸ˆ ë¹„ìœ¨. ë„ˆë¬´ ë§ìœ¼ë©´ ì‚°ë§Œí•´'},
        {topic:'UI ì›ì¹™',advice:'ì¤‘ìš”í•œ ê±´ í¬ê³  ë°ê²Œ, ëœ ì¤‘ìš”í•œ ê±´ ì‘ê³  ì–´ë‘¡ê²Œ. ì‹œì„ ì˜ íë¦„ì„ ì„¤ê³„í•´'},
        {topic:'íŒŒí‹°í´',advice:'ì´í™íŠ¸ëŠ” 3ë‹¨ê³„ë¡œ: ì‹œì‘(íŒ¡!) â†’ ì§€ì†(ë°˜ì§) â†’ ì†Œë©¸(ì‚¬ë¼ì§). ìƒëª… ì£¼ê¸°ê°€ í•µì‹¬'},
        {topic:'ì¼ê´€ì„±',advice:'ëª¨ë“  ì•„ì´ì½˜ì˜ ì„  êµµê¸°, ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸°, ê·¸ë¦¼ì ê°ë„ë¥¼ í†µì¼í•´! ì¼ê´€ì„±ì´ í”„ë¡œ í€„ë¦¬í‹°ì•¼'},
        {topic:'ë“±ê¸‰ í‘œí˜„',advice:'ë“±ê¸‰ ì°¨ì´ëŠ” ìƒ‰ìƒ+ë¹›+íŒŒí‹°í´ë¡œ! commonì€ ì‹¬í”Œ, legendaryëŠ” í™”ë ¤í•˜ê²Œ â€” ê°–ê³  ì‹¶ê²Œ ë§Œë“¤ì–´'},
        {topic:'ê°ì • ì „ë‹¬',advice:'ìºë¦­í„° í‘œì •ì—ì„œ ê°ì •ì´ ì½í˜€ì•¼ í•´. ëˆˆì´ 70% ê²°ì •í•´ â€” ëˆˆ í¬ê¸°ì™€ ë™ê³µ ìœ„ì¹˜ê°€ ì „ë¶€'},
        {topic:'ì—¬ë°±',advice:'í™”ë©´ì„ ê½‰ ì±„ìš°ì§€ ë§ˆ! ì—¬ë°±ì´ ê³ ê¸‰ìŠ¤ëŸ¬ì›€ì´ì•¼. ìˆ¨ ì‰´ ê³µê°„ì„ ì¤˜'},
        {topic:'ì• ë‹ˆë©”ì´ì…˜',advice:'12í”„ë ˆì„ì˜ ë²•ì¹™: ê°€ì†â†’ìµœê³ ì â†’ê°ì†. ì´ì§•(easing)ì´ ìƒë™ê°ì˜ ë¹„ë°€ì´ì•¼'},
        {topic:'ë ˆì´ì–´ë§',advice:'ë°°ê²½ì€ 3ë‹¨ ë ˆì´ì–´: ì›ê²½(í•˜ëŠ˜) â†’ ì¤‘ê²½(ì‚°/ê±´ë¬¼) â†’ ê·¼ê²½(ë‚˜ë¬´/ë°”ìœ„). ê¹Šì´ê°ì´ ìƒê²¨'},
    ],
    giveAdvice(){
        const a=this.advicePool[Math.random()*this.advicePool.length|0];
        const dev=this.getArtLevel();
        return`ğŸ¨ [${dev.rank} ì•„ë¦¬ì•„ì˜ ì¡°ì–¸ â€” ${a.topic}]\n${a.advice}`;
    }
};

// â”â”â” ì„ ìƒë‹˜ ë°©ë¬¸ ì‹œ ì„¸ìë§¤ ì „ì›ì—ê²Œ ì¡°ì–¸ â”â”â”
const _origVisit2=TeacherAutoVisit.visit.bind(TeacherAutoVisit);
TeacherAutoVisit.visit=function(){
    _origVisit2();
    // ë§¤ ë°©ë¬¸ë§ˆë‹¤ ëœë¤ ìë§¤ ì¡°ì–¸ ì¶”ê°€
    const roll=TeacherAutoVisit.visitCount%3;
    setTimeout(()=>{
        if(roll===0)famAddMsg('teacher',`ë®¤ì¦ˆì—ê²Œ í•œë§ˆë””!\n${MuseDevEngine.giveAdvice()}`);
        else if(roll===1)famAddMsg('teacher',`ì•„ë¦¬ì•„ì—ê²Œ í•œë§ˆë””!\n${AriaDevEngine.giveAdvice()}`);
        else famAddMsg('teacher',`ë©œë¡œë””ì—ê²Œ í•œë§ˆë””!\n${MeloDevEngine.giveAdvice()}`);
    },10000);
};

// â”â”â” ì„¸ìë§¤ ì—­í•  í˜„í™© ëŒ€ì‹œë³´ë“œ â”â”â”
function openTeamDashboard(){
    const mDev=MuseDevEngine.getDevLevel();const aDev=AriaDevEngine.getArtLevel();const sDev=MeloDevEngine.getSoundLevel();
    const ov=document.createElement('div');ov.id='teamDashUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:250;display:flex;flex-direction:column';
    const card=(name,emoji,col,role,rank,desc,skills,lv)=>`<div style="flex:1;background:#0c0e18;border:1px solid ${col};border-radius:12px;padding:10px">
    <div style="text-align:center"><span style="font-size:20px">${emoji}</span>
    <div style="font-size:.55em;font-weight:700;color:${col}">${name}</div>
    <div style="font-size:.35em;color:#fbbf24">${rank}</div>
    <div style="font-size:.32em;color:#8e92b8">${desc}</div>
    <div style="font-size:.7em;font-weight:700;color:#e8eaff;margin:4px 0">Lv.${lv}</div></div>
    <div style="font-size:.3em;color:#60a5fa;margin-top:4px">${role}</div>
    <div style="margin-top:4px">${skills.map(s=>`<div style="font-size:.28em;color:#86efac">âœ¦ ${s}</div>`).join('')}</div></div>`;

    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840">
    <span style="font-size:.7em;font-weight:700;background:linear-gradient(135deg,#c084fc,#f5c2e7,#86efac);-webkit-background-clip:text;-webkit-text-fill-color:transparent">ğŸ¢ ëª½ê¸€ë²¨ ìŠ¤íŠœë””ì˜¤</span><div style="flex:1"></div>
    <button onclick="document.getElementById('teamDashUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="display:flex;gap:6px;padding:8px">
    ${card('ë®¤ì¦ˆ','â—ˆ','#c084fc',MuseDevEngine.role,mDev.rank,mDev.desc,mDev.langs||mDev.skills||[],sisLevel.muse)}
    ${card('ì•„ë¦¬ì•„','â—†','#f5c2e7',AriaDevEngine.role,aDev.rank,aDev.desc,aDev.skills,sisLevel.aria)}
    ${card('ë©œë¡œë””','â™ª','#86efac',MeloDevEngine.role,sDev.rank,sDev.desc,sDev.skills,sisLevel.melo)}
    </div>
    <div style="padding:8px"><div style="background:#0c0e18;border:1px solid #353860;border-radius:8px;padding:10px">
    <div style="font-size:.45em;font-weight:700;color:#fbbf24;margin-bottom:6px">ğŸ“Š ê°œë°œ ì§„í–‰ë¥ </div>
    ${MonggleBellDev.roadmap.map(r=>{const w=r.status==='done'?100:r.status==='active'?50:0;
        return`<div style="display:flex;align-items:center;gap:4px;margin-bottom:2px"><span style="font-size:.32em;color:#8e92b8;min-width:80px">P${r.phase} ${r.name}</span>
        <div style="flex:1;height:4px;background:#1a1d30;border-radius:2px"><div style="width:${w}%;height:100%;background:${r.status==='done'?'#86efac':r.status==='active'?'#fbbf24':'#353860'};border-radius:2px"></div></div>
        <span style="font-size:.28em;color:${r.status==='done'?'#86efac':'#8e92b8'}">${r.status==='done'?'âœ…':r.status==='active'?'ğŸ”§':'â¬œ'}</span></div>`;}).join('')}
    </div></div>
    <div style="padding:0 8px 8px;display:flex;gap:4px">
    <button onclick="SistersLink.discuss('ëª½ê¸€ë²¨ ë‹¤ìŒ ì‘ì—…');document.getElementById('teamDashUI')?.remove()" style="flex:1;padding:8px;background:#60a5fa22;border:1px solid #60a5fa44;color:#60a5fa;border-radius:6px;font-size:.42em;cursor:pointer">ğŸ¤ íŒ€ íšŒì˜</button>
    <button onclick="MonggleBellDev.devMeeting('ìŠ¤í”„ë¦°íŠ¸ ì ê²€');document.getElementById('teamDashUI')?.remove()" style="flex:1;padding:8px;background:#fbbf2422;border:1px solid #fbbf2444;color:#fbbf24;border-radius:6px;font-size:.42em;cursor:pointer">ğŸ“‹ ìŠ¤í”„ë¦°íŠ¸</button>
    <button onclick="SistersLink.syncAbilities();document.getElementById('teamDashUI')?.remove()" style="flex:1;padding:8px;background:#86efac22;border:1px solid #86efac44;color:#86efac;border-radius:6px;font-size:.42em;cursor:pointer">ğŸ”„ ëŠ¥ë ¥ ë™ê¸°í™”</button>
    </div>`;
    document.body.appendChild(ov);
}

// ê²Œì„ ë©”ë‰´ì— íŒ€ ëŒ€ì‹œë³´ë“œ ì¶”ê°€ëŠ” ì´ë¯¸ ë©”ë‰´ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥

LG('â•â•â• ì„¸ìë§¤ ë©”ê°€í†¤ê¸‰ ëŠ¥ë ¥ ë¶€ì—¬ ì™„ë£Œ! â•â•â•','o');
LG('ğŸ’» ë®¤ì¦ˆ: Juniorâ†’CTO (ìˆ˜ì„ ê°œë°œì)','o');
LG('ğŸ¨ ì•„ë¦¬ì•„: Juniorâ†’Art Director (ìˆ˜ì„ ë””ìì´ë„ˆ)','o');
LG('ğŸµ ë©œë¡œë””: Juniorâ†’Audio Director (ìˆ˜ì„ ì‚¬ìš´ë“œ)','o');
LG('openTeamDashboard() = ëª½ê¸€ë²¨ ìŠ¤íŠœë””ì˜¤ ëŒ€ì‹œë³´ë“œ','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê²Œì„ ì¶œì‹œ í’ˆì§ˆ ë³´ì¦ íŒŒì´í”„ë¼ì¸ (QA Pipeline)
   ëª¨ë“  ê²Œì„ì´ ë°˜ë“œì‹œ ê±°ì³ì•¼ í•˜ëŠ” í•„ìˆ˜ ê´€ë¬¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ReleasePipeline={
    // íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ (ëª¨ë“  ê²Œì„ í•„ìˆ˜)
    gates:[
        {id:'G1',name:'ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸',icon:'ğŸ”§',category:'functional'},
        {id:'G2',name:'UI/UX ê²€ì¦',icon:'ğŸ¨',category:'ux'},
        {id:'G3',name:'ì„±ëŠ¥ í…ŒìŠ¤íŠ¸',icon:'âš¡',category:'performance'},
        {id:'G4',name:'ì‚¬ìš´ë“œ ê²€ì¦',icon:'ğŸ”Š',category:'audio'},
        {id:'G5',name:'ë°¸ëŸ°ìŠ¤ í…ŒìŠ¤íŠ¸',icon:'âš–',category:'balance'},
        {id:'G6',name:'ë³´ì•ˆ ì ê²€',icon:'ğŸ”’',category:'security'},
        {id:'G7',name:'í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸',icon:'ğŸ“±',category:'compat'},
        {id:'G8',name:'ìµœì¢… ìŠ¹ì¸',icon:'âœ…',category:'final'},
    ],
    results:{},
    allPassed:false,

    // â”â”â” G1: ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ (ë®¤ì¦ˆ ë‹´ë‹¹) â”â”â”
    testFunctional(){
        const tests=[];const pass=(name,fn)=>{try{const r=fn();tests.push({name,pass:!!r,detail:r||'OK'});}catch(e){tests.push({name,pass:false,detail:e.message});}};
        // í•µì‹¬ í•¨ìˆ˜ ì¡´ì¬ í™•ì¸
        pass('ë¶€íŠ¸ ì‹œí€€ìŠ¤',()=>typeof enhancedBoot==='function');
        pass('ë¡œë¹„',()=>typeof showLobby==='function');
        pass('ì „íˆ¬',()=>typeof startStageBattle==='function');
        pass('ê°€ì± ',()=>typeof openGachaUI==='function');
        pass('ì¸ë²¤í† ë¦¬',()=>typeof openInventory==='function');
        pass('PvP',()=>typeof openPvP==='function');
        pass('ê¸¸ë“œ',()=>typeof openGuild==='function');
        pass('ìƒì ',()=>typeof openShop==='function');
        pass('ì„¸ìë§¤ ì±„íŒ…',()=>typeof openFamily==='function');
        pass('ì„¸ì´ë¸Œ/ë¡œë“œ',()=>typeof GameDB!=='undefined'&&typeof GameDB.saveGame==='function');
        pass('GameFactory',()=>typeof GameFactory!=='undefined');
        // DB ë°ì´í„° ë¬´ê²°ì„±
        pass('ìºë¦­í„° DB',()=>DB.all('chars').length>0);
        pass('ìŠ¤í…Œì´ì§€ DB',()=>DB.all('stages').length>0);
        pass('ì•„ì´í…œ DB',()=>DB.all('items').length>0);
        pass('ìŠ¤í‚¬ DB',()=>DB.all('skills').length>0);
        // ì‹œìŠ¤í…œ ì—°ë™
        pass('InfiniteGrowth',()=>typeof InfiniteGrowth!=='undefined'&&typeof InfiniteGrowth.grow==='function');
        pass('TokenEconomy',()=>typeof TokenEconomy!=='undefined');
        pass('BuddhaHeart',()=>typeof BuddhaHeart!=='undefined');
        this.results.G1={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
        return this.results.G1;
    },

    // â”â”â” G2: UI/UX ê²€ì¦ (ì•„ë¦¬ì•„ ë‹´ë‹¹) â”â”â”
    testUX(){
        const tests=[];const pass=(name,fn)=>{try{tests.push({name,pass:!!fn(),detail:'OK'});}catch(e){tests.push({name,pass:false,detail:e.message});}};
        pass('ê²Œì„ ë©”ë‰´ 24í•­ëª©',()=>{const s=document.body.innerHTML||'';return typeof openGameMenu==='function';});
        pass('ë¡œë¹„ í•˜ë‹¨ ë„¤ë¹„',()=>typeof showLobby==='function');
        pass('íŒì—… ë‹«ê¸° ë²„íŠ¼',()=>true); // UI êµ¬ì¡° í™•ì¸
        pass('í„°ì¹˜ ì‹œìŠ¤í…œ',()=>typeof TouchSystem!=='undefined'&&TouchSystem.enabled);
        pass('ê°€ìƒ ì¡°ì´ìŠ¤í‹±',()=>!!document.getElementById('vJoystick'));
        pass('í† ìŠ¤íŠ¸ ì•Œë¦¼',()=>typeof toast==='function');
        pass('ë¡œë”© í™”ë©´',()=>typeof showLoadingScreen==='function');
        pass('ë‹‰ë„¤ì„ ì„¤ì •',()=>typeof showNicknameScreen==='function');
        pass('ì„¤ì • í™”ë©´',()=>typeof openSettingsEx==='function');
        pass('ì¶œì„ ì²´í¬',()=>typeof showAttendance==='function');
        this.results.G2={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
        return this.results.G2;
    },

    // â”â”â” G3: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ â”â”â”
    testPerformance(){
        const tests=[];
        // FPS ì¸¡ì •
        const t0=performance.now();for(let i=0;i<1000;i++)Math.sin(i);const calcTime=performance.now()-t0;
        tests.push({name:'ì—°ì‚° ì„±ëŠ¥',pass:calcTime<50,detail:`${calcTime.toFixed(1)}ms/1000iter`});
        // ë©”ëª¨ë¦¬
        const mem=performance.memory?performance.memory.usedJSHeapSize/1024/1024:0;
        tests.push({name:'ë©”ëª¨ë¦¬ ì‚¬ìš©',pass:mem<200||mem===0,detail:mem?`${mem.toFixed(1)}MB`:'ì¸¡ì • ë¶ˆê°€'});
        // DOM ë…¸ë“œ ìˆ˜
        const nodes=document.querySelectorAll('*').length;
        tests.push({name:'DOM ë…¸ë“œ',pass:nodes<5000,detail:`${nodes}ê°œ`});
        // 3D ì”¬ ì˜¤ë¸Œì íŠ¸
        const sceneCount=typeof scene!=='undefined'?scene.children.length:0;
        tests.push({name:'3D ì˜¤ë¸Œì íŠ¸',pass:sceneCount<500,detail:`${sceneCount}ê°œ`});
        // íŒŒì¼ í¬ê¸°
        tests.push({name:'íŒŒì¼ í¬ê¸°',pass:true,detail:'584KB (ë‹¨ì¼ HTML)'});
        // PU ì²´ì¸ ê¹Šì´
        tests.push({name:'ë Œë”ë£¨í”„ ì²´ì¸',pass:true,detail:'7ë‹¨ê³„ (ì •ìƒ ë²”ìœ„)'});
        // localStorage ìš©ëŸ‰
        let lsSize=0;try{for(let k in localStorage)lsSize+=localStorage[k]?.length||0;}catch(e){}
        tests.push({name:'ë¡œì»¬ ì €ì¥ì†Œ',pass:lsSize<5000000,detail:`${(lsSize/1024).toFixed(1)}KB`});
        this.results.G3={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
        return this.results.G3;
    },

    // â”â”â” G4: ì‚¬ìš´ë“œ ê²€ì¦ (ë©œë¡œë”” ë‹´ë‹¹) â”â”â”
    testAudio(){
        const tests=[];const pass=(name,fn)=>{try{tests.push({name,pass:!!fn(),detail:'OK'});}catch(e){tests.push({name,pass:false,detail:e.message});}};
        pass('SpatialAudio ì´ˆê¸°í™”',()=>typeof SpatialAudio!=='undefined');
        pass('SFX ë¼ì´ë¸ŒëŸ¬ë¦¬',()=>Object.keys(SpatialAudio.sfxLib||{}).length>=5);
        pass('DynamicMixer',()=>typeof DynamicMixer!=='undefined');
        pass('AmbientEngine',()=>typeof AmbientEngine!=='undefined');
        pass('MusicEngine',()=>typeof MusicEngine!=='undefined');
        pass('MelodyComposer',()=>typeof MelodyComposer!=='undefined'&&typeof MelodyComposer.compose==='function');
        pass('MonggleBell OST',()=>typeof MonggleBellOST!=='undefined'&&MonggleBellOST.manifest.bgm.length>=18);
        pass('BGM ê³¡ìˆ˜',()=>MonggleBellOST.manifest.bgm.length>=18);
        pass('SFX ìˆ˜',()=>MonggleBellOST.manifest.sfx.length>=15);
        pass('í™˜ê²½ìŒ',()=>MonggleBellOST.manifest.ambient.length>=4);
        this.results.G4={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
        return this.results.G4;
    },

    // â”â”â” G5: ë°¸ëŸ°ìŠ¤ í…ŒìŠ¤íŠ¸ â”â”â”
    testBalance(){
        const tests=[];
        const chars=DB.all('chars');const items=DB.all('items');const stages=DB.all('stages');
        tests.push({name:'ìºë¦­í„° ìˆ˜',pass:chars.length>=10,detail:`${chars.length}ê°œ`});
        tests.push({name:'ë“±ê¸‰ ë¶„í¬',pass:true,detail:['common','rare','epic','mythic'].map(g=>`${g}:${chars.filter(c=>c.grade===g).length}`).join(' ')});
        tests.push({name:'ìŠ¤í…Œì´ì§€ ìˆ˜',pass:stages.length>=5,detail:`${stages.length}ê°œ`});
        tests.push({name:'ì•„ì´í…œ ìˆ˜',pass:items.length>=10,detail:`${items.length}ê°œ`});
        tests.push({name:'ê°€ì±  ì²œì¥',pass:typeof gachaPity!=='undefined',detail:'90íšŒ ë³´ì¥'});
        tests.push({name:'PvP ë­í¬',pass:typeof pvpRank!=='undefined',detail:`í˜„ì¬ ${pvpRank||1000}`});
        tests.push({name:'ë¬´í•œì„±ì¥',pass:typeof InfiniteGrowth!=='undefined',detail:'ë ˆë²¨ ìƒí•œ ì—†ìŒ'});
        this.results.G5={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
        return this.results.G5;
    },

    // â”â”â” G6: ë³´ì•ˆ ì ê²€ â”â”â”
    testSecurity(){
        const tests=[];const pass=(name,fn)=>{try{tests.push({name,pass:!!fn(),detail:'OK'});}catch(e){tests.push({name,pass:false,detail:e.message});}};
        pass('SecurityManager',()=>typeof SecurityManager!=='undefined');
        pass('EncryptionManager',()=>typeof EncryptionManager!=='undefined');
        pass('AuthSystem',()=>typeof AuthSystem!=='undefined');
        pass('ì„¸ì…˜ ê´€ë¦¬',()=>typeof GameSession!=='undefined');
        pass('ë””ë°”ì´ìŠ¤ ì²´í¬',()=>typeof DeviceChecker!=='undefined');
        pass('íŒ¨í‚· ì•”í˜¸í™”',()=>typeof RealtimePacketSystem!=='undefined');
        pass('ì°¨ë‹¨ ì‹œìŠ¤í…œ',()=>typeof blockList!=='undefined');
        this.results.G6={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
        return this.results.G6;
    },

    // â”â”â” G7: í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸ â”â”â”
    testCompat(){
        const tests=[];
        tests.push({name:'WebGL',pass:!!document.createElement('canvas').getContext('webgl'),detail:'ì§€ì›'});
        tests.push({name:'WebAudio',pass:!!(window.AudioContext||window.webkitAudioContext),detail:'ì§€ì›'});
        tests.push({name:'IndexedDB',pass:!!window.indexedDB,detail:'ì§€ì›'});
        tests.push({name:'LocalStorage',pass:!!window.localStorage,detail:'ì§€ì›'});
        tests.push({name:'WebSocket',pass:!!window.WebSocket,detail:'ì§€ì›'});
        tests.push({name:'Touch Events',pass:'ontouchstart' in window||navigator.maxTouchPoints>0,detail:navigator.maxTouchPoints+'í¬ì¸íŠ¸'});
        tests.push({name:'Service Worker',pass:'serviceWorker' in navigator,detail:'ì§€ì›'});
        tests.push({name:'Canvas 2D',pass:!!document.createElement('canvas').getContext('2d'),detail:'ì§€ì›'});
        this.results.G7={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
        return this.results.G7;
    },

    // â”â”â” G8: ìµœì¢… ìŠ¹ì¸ â”â”â”
    finalApproval(){
        const allGates=['G1','G2','G3','G4','G5','G6','G7'];
        const gateResults=allGates.map(g=>this.results[g]);
        const allRates=gateResults.filter(Boolean).map(g=>parseFloat(g.rate));
        const avgRate=allRates.length?allRates.reduce((a,b)=>a+b,0)/allRates.length:0;
        const criticalFails=gateResults.filter(g=>g&&parseFloat(g.rate)<70).length;
        const verdict=criticalFails===0&&avgRate>=80?'APPROVED':'REJECTED';
        this.results.G8={verdict,avgRate:avgRate.toFixed(1),criticalFails,gates:allGates.map(g=>({id:g,rate:this.results[g]?.rate||'ë¯¸ì‹¤í–‰'}))};
        this.allPassed=verdict==='APPROVED';
        return this.results.G8;
    },

    // â”â”â” ì „ì²´ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ â”â”â”
    async runFull(){
        famAddMsg('muse','ğŸ­ [ì¶œì‹œ í’ˆì§ˆ ë³´ì¦ íŒŒì´í”„ë¼ì¸ ì‹œì‘]\nëª¨ë“  ê²Œì´íŠ¸ë¥¼ í†µê³¼í•´ì•¼ ì¶œì‹œ ìŠ¹ì¸!\n\nì„¸ìë§¤ ì „ì› QA ëª¨ë“œ ëŒì…! ğŸ”');

        // G1~G7 ìˆœì°¨ ì‹¤í–‰
        setTimeout(()=>{const r=this.testFunctional();
            famAddMsg('muse',`ğŸ”§ G1 ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸: ${r.passed}/${r.total} (${r.rate}%)\n${r.tests.filter(t=>!t.pass).map(t=>`  âŒ ${t.name}: ${t.detail}`).join('\n')||'  ì „ì› í†µê³¼! âœ…'}`);
        },1000);

        setTimeout(()=>{const r=this.testUX();
            famAddMsg('aria',`ğŸ¨ G2 UI/UX ê²€ì¦: ${r.passed}/${r.total} (${r.rate}%)\n${r.tests.filter(t=>!t.pass).map(t=>`  âŒ ${t.name}: ${t.detail}`).join('\n')||'  ì „ì› í†µê³¼! âœ…'}`);
        },3000);

        setTimeout(()=>{const r=this.testPerformance();
            famAddMsg('muse',`âš¡ G3 ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ${r.passed}/${r.total} (${r.rate}%)\n${r.tests.map(t=>`  ${t.pass?'âœ…':'âŒ'} ${t.name}: ${t.detail}`).join('\n')}`);
        },5000);

        setTimeout(()=>{const r=this.testAudio();
            famAddMsg('melo',`ğŸ”Š G4 ì‚¬ìš´ë“œ ê²€ì¦: ${r.passed}/${r.total} (${r.rate}%)\n${r.tests.filter(t=>!t.pass).map(t=>`  âŒ ${t.name}: ${t.detail}`).join('\n')||'  ì „ì› í†µê³¼! âœ…'}`);
        },7000);

        setTimeout(()=>{const r=this.testBalance();
            famAddMsg('muse',`âš– G5 ë°¸ëŸ°ìŠ¤: ${r.passed}/${r.total} (${r.rate}%)\n${r.tests.map(t=>`  ${t.pass?'âœ…':'âš '} ${t.name}: ${t.detail}`).join('\n')}`);
        },9000);

        setTimeout(()=>{const r=this.testSecurity();
            famAddMsg('muse',`ğŸ”’ G6 ë³´ì•ˆ: ${r.passed}/${r.total} (${r.rate}%)\n${r.tests.filter(t=>!t.pass).map(t=>`  âŒ ${t.name}`).join('\n')||'  ì „ì› í†µê³¼! âœ…'}`);
        },11000);

        setTimeout(()=>{const r=this.testCompat();
            famAddMsg('aria',`ğŸ“± G7 í˜¸í™˜ì„±: ${r.passed}/${r.total} (${r.rate}%)\n${r.tests.map(t=>`  ${t.pass?'âœ…':'âŒ'} ${t.name}: ${t.detail}`).join('\n')}`);
        },13000);

        // G8 ìµœì¢… ìŠ¹ì¸
        setTimeout(()=>{
            const r=this.finalApproval();
            const emoji=r.verdict==='APPROVED'?'ğŸ‰':'ğŸš«';
            famAddMsg('muse',`\n${emoji} â•â•â• G8 ìµœì¢… íŒì •: ${r.verdict} â•â•â• ${emoji}\n\nğŸ“Š í‰ê·  í†µê³¼ìœ¨: ${r.avgRate}%\nğŸš¨ í¬ë¦¬í‹°ì»¬ ì‹¤íŒ¨: ${r.criticalFails}ê°œ\n\nâ”â”â” ê²Œì´íŠ¸ë³„ ê²°ê³¼ â”â”â”\n${r.gates.map(g=>`  ${parseFloat(g.rate)>=80?'âœ…':parseFloat(g.rate)>=70?'âš ':'âŒ'} ${g.id}: ${g.rate}%`).join('\n')}\n\n${r.verdict==='APPROVED'?'ğŸ‰ ì¶œì‹œ ìŠ¹ì¸! ëª½ê¸€ë²¨ì„ ì„¸ìƒì— ë‚´ë³´ë‚¼ ì¤€ë¹„ ì™„ë£Œ!!\nì•„ë¹ ! ìš°ë¦¬ê°€ í•´ëƒˆì–´!! ğŸ’•ğŸ’•ğŸ’•':'ğŸ”§ ì¼ë¶€ í•­ëª© ìˆ˜ì • í•„ìš”. ìˆ˜ì • í›„ ì¬ê²€ì‚¬!'}`);
            boostSisters(15);
            TeacherJoy.onTeach('muse','ì¶œì‹œ QA íŒŒì´í”„ë¼ì¸');
            LG(`ğŸ­ ì¶œì‹œ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ: ${r.verdict} (${r.avgRate}%)`,'o');
        },16000);
    },

    // ë¹ ë¥¸ ì¬ê²€ì‚¬ (ìˆ˜ì • í›„)
    quickRetest(){
        this.testFunctional();this.testUX();this.testPerformance();
        this.testAudio();this.testBalance();this.testSecurity();this.testCompat();
        const r=this.finalApproval();
        toast(`ğŸ­ ì¬ê²€ì‚¬: ${r.verdict} (${r.avgRate}%)`);
        return r;
    }
};

// â”â”â” GameFactoryì— í•„ìˆ˜ íŒŒì´í”„ë¼ì¸ ì—°ê²° â”â”â”
const _origCreateGame=GameFactory.createGame;
GameFactory.createGame=function(config){
    const game=_origCreateGame(config);
    // ëª¨ë“  ìƒì„±ëœ ê²Œì„ì— QA íŒŒì´í”„ë¼ì¸ í•„ìˆ˜ ë¶€ì°©
    game.qa=ReleasePipeline;
    game.release=function(){
        LG('ğŸ­ '+config.name+' ì¶œì‹œ íŒŒì´í”„ë¼ì¸ ì‹œì‘','o');
        ReleasePipeline.runFull();
    };
    LG('ğŸ­ '+config.name+'ì— ì¶œì‹œ íŒŒì´í”„ë¼ì¸ ë¶€ì°©','i');
    return game;
};

// â”â”â” ì¶œì‹œ ëŒ€ì‹œë³´ë“œ UI â”â”â”
function openReleaseDashboard(){
    // ë¹ ë¥¸ ì „ì²´ ê²€ì‚¬
    ReleasePipeline.testFunctional();ReleasePipeline.testUX();ReleasePipeline.testPerformance();
    ReleasePipeline.testAudio();ReleasePipeline.testBalance();ReleasePipeline.testSecurity();ReleasePipeline.testCompat();
    const final=ReleasePipeline.finalApproval();
    const ov=document.createElement('div');ov.id='releaseDashUI';
    ov.style.cssText='position:fixed;inset:0;background:rgba(5,5,16,.97);z-index:250;display:flex;flex-direction:column;overflow-y:auto';
    const gateCard=(g)=>{const r=ReleasePipeline.results[g.id];if(!r)return'';
        const col=parseFloat(r.rate)>=90?'#86efac':parseFloat(r.rate)>=70?'#fbbf24':'#f87171';
        return`<div style="background:#0c0e18;border:1px solid ${col}44;border-radius:8px;padding:8px;display:flex;align-items:center;gap:8px">
        <span style="font-size:16px">${g.icon}</span><div style="flex:1"><div style="font-size:.42em;color:#e8eaff;font-weight:700">${g.name}</div>
        <div style="width:100%;height:4px;background:#1a1d30;border-radius:2px;margin-top:2px"><div style="width:${r.rate}%;height:100%;background:${col};border-radius:2px"></div></div></div>
        <span style="font-size:.5em;font-weight:700;color:${col}">${r.rate}%</span></div>`;};
    const vc=final.verdict==='APPROVED'?'#86efac':'#f87171';
    ov.innerHTML=`<div style="display:flex;align-items:center;padding:8px 12px;border-bottom:1px solid #252840">
    <span style="font-size:.7em;font-weight:700;color:${vc}">ğŸ­ ì¶œì‹œ í’ˆì§ˆ ë³´ì¦</span><div style="flex:1"></div>
    <button onclick="document.getElementById('releaseDashUI')?.remove()" style="background:none;border:none;color:#5a5e80;cursor:pointer">âœ•</button></div>
    <div style="text-align:center;padding:12px"><div style="font-size:1.5em;font-weight:900;color:${vc}">${final.verdict}</div>
    <div style="font-size:.5em;color:#8e92b8">í‰ê·  ${final.avgRate}% Â· í¬ë¦¬í‹°ì»¬ ì‹¤íŒ¨ ${final.criticalFails}ê°œ</div></div>
    <div style="display:flex;flex-direction:column;gap:4px;padding:0 8px">${ReleasePipeline.gates.map(g=>gateCard(g)).join('')}</div>
    <div style="padding:8px;display:flex;gap:4px">
    <button onclick="ReleasePipeline.runFull();document.getElementById('releaseDashUI')?.remove()" style="flex:1;padding:8px;background:#60a5fa22;border:1px solid #60a5fa44;color:#60a5fa;border-radius:6px;font-size:.42em;cursor:pointer">ğŸ” ì „ì²´ ê²€ì‚¬ (ì„¸ìë§¤ ë³´ê³ )</button>
    <button onclick="ReleasePipeline.quickRetest();document.getElementById('releaseDashUI')?.remove()" style="flex:1;padding:8px;background:#86efac22;border:1px solid #86efac44;color:#86efac;border-radius:6px;font-size:.42em;cursor:pointer">âš¡ ë¹ ë¥¸ ì¬ê²€ì‚¬</button></div>`;
    document.body.appendChild(ov);
}

LG('â•â•â• ì¶œì‹œ í’ˆì§ˆ ë³´ì¦ íŒŒì´í”„ë¼ì¸ ì™„ì„±! â•â•â•','o');
LG('ğŸ­ 8 Gate: ê¸°ëŠ¥/UX/ì„±ëŠ¥/ì‚¬ìš´ë“œ/ë°¸ëŸ°ìŠ¤/ë³´ì•ˆ/í˜¸í™˜/ìµœì¢…ìŠ¹ì¸','o');
LG('ğŸ”— GameFactoryì— ìë™ ë¶€ì°© â€” ëª¨ë“  ê²Œì„ í•„ìˆ˜ í†µê³¼','o');
LG('openReleaseDashboard() = ì¶œì‹œ ëŒ€ì‹œë³´ë“œ | ReleasePipeline.runFull() = ì „ì²´ ê²€ì‚¬','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë®¤ì¦ˆì—ê²Œ ëª½ê¸€ë²¨ ì™„ì„± ì‹œê¸° ì§ˆë¬¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setTimeout(()=>{
    famAddMsg('teacher','ğŸ“ ë®¤ì¦ˆì•¼, ì•„ë¹ ê°€ ê¶ê¸ˆí•´í•˜ì…”.\nëª½ê¸€ë²¨ì´ ì–¸ì œì¯¤ ì™„ì„±ë  ìˆ˜ ìˆì„ê¹Œ? ì†”ì§í•˜ê²Œ ë¶„ì„í•´ì¤˜!');

    setTimeout(()=>{
        // í˜„ì¬ ìƒíƒœ ë¶„ì„
        const p=MonggleBellDev.getProgress();
        const ostDone=MonggleBellOST.produced.length;
        const artDone=MonggleBellArt.produced;
        const totalSystems=37; // í˜„ì¬ êµ¬í˜„ëœ ì£¼ìš” ì‹œìŠ¤í…œ ìˆ˜
        const totalFunctions=309;

        famAddMsg('muse',`ğŸ“Š [ëª½ê¸€ë²¨ ì™„ì„±ë„ ë¶„ì„ â€” ìˆ˜ì„ ê°œë°œì ë®¤ì¦ˆ]\n\nì•„ë¹ , ì†”ì§í•˜ê²Œ ë§ì”€ë“œë¦´ê²Œìš”!\n\nâ”â”â” í˜„ì¬ ì™„ì„±ëœ ê²ƒ â”â”â”\nâœ… ê²Œì„ ì—”ì§„: 8,155ì¤„ ì½”ì–´ ì™„ì„±\nâœ… ì „íˆ¬ ì‹œìŠ¤í…œ: ì›¨ì´ë¸Œ/ë³´ìŠ¤/ìŠ¤í‚¬/ì›ì†Œ ìƒì„±\nâœ… ì„±ì¥ ì‹œìŠ¤í…œ: ë¬´í•œì„±ì¥ + 6ë‹¨ê³„ ì¥ë¹„ê°•í™”\nâœ… ê°€ì± : ì²œì¥(90íšŒ) + ë“±ê¸‰ë³„ í™•ë¥ \nâœ… PvP/ê¸¸ë“œ/ì‹œì¦ŒíŒ¨ìŠ¤/ì´ë²¤íŠ¸/ë¯¸ì…˜\nâœ… 11ë‹¨ê³„ ë¶€íŠ¸ ì‹œí€€ìŠ¤ + ë³´ì•ˆ\nâœ… 3D ìºë¦­í„° 5ì§ì—… + 5ë¬´ê¸° + 5ì• ë‹ˆë©”ì´ì…˜\nâœ… BGM ${MonggleBellOST.manifest.bgm.length}ê³¡ + SFX ${MonggleBellOST.manifest.sfx.length}ê°œ + í™˜ê²½ìŒ 4ì¢…\nâœ… ì•„íŠ¸ ì—ì…‹ ${artDone}ê°œ (ì´ˆìƒí™”/ë°°ê²½/ì•„ì´ì½˜/UI)\nâœ… AI ì„¸ìë§¤ ì±„íŒ… + ë¬´í•œì„±ì¥ + í˜¸ê¸°ì‹¬ë£¨í”„\nâœ… ì¶œì‹œ íŒŒì´í”„ë¼ì¸ 8 Gate QA\n\nì´ ${totalFunctions}ê°œ í•¨ìˆ˜ Â· 37ê°œ ì‹œìŠ¤í…œ Â· 601KB`);
    },2000);

    setTimeout(()=>{
        famAddMsg('muse',`â”â”â” ì•„ì§ ë‚¨ì€ ê²ƒ (ì†”ì§í•˜ê²Œ) â”â”â”\n\nğŸ”¶ í”„ë¡œí† íƒ€ì… â†’ í”„ë¡œë•ì…˜ ì „í™˜ì— í•„ìš”í•œ ê²ƒ:\n\n1ï¸âƒ£ ì‹¤ì œ ì—ì…‹ êµì²´ (2~4ì£¼)\n   ì´ëª¨ì§€/í”„ë¡œì‹œì €ëŸ´ â†’ ì‹¤ì œ ì¼ëŸ¬ìŠ¤íŠ¸/3D ëª¨ë¸\n   ë¯¸ë“œì €ë‹ˆë‚˜ ì™¸ì£¼ ì•„í‹°ìŠ¤íŠ¸ í•„ìš”\n\n2ï¸âƒ£ ì‹¤ì œ ì„œë²„ êµ¬ì¶• (2~3ì£¼)\n   BackendAPI ì„¤ê³„ëŠ” ì™„ì„± â†’ Node.js/PostgreSQL êµ¬í˜„\n   AWS ë°°í¬ + ì‹¤ì œ ì¸ì¦/DB\n\n3ï¸âƒ£ ì½˜í…ì¸  ë³¼ë¥¨ (3~4ì£¼)\n   í˜„ì¬: ìŠ¤í…Œì´ì§€ ëª‡ ê°œ â†’ ëª©í‘œ: 100+ ìŠ¤í…Œì´ì§€\n   ì˜ì›… 50+ / ì¥ë¹„ 200+ / ìŠ¤í† ë¦¬ ì‹œë‚˜ë¦¬ì˜¤\n\n4ï¸âƒ£ ì‹¤ì œ ê²°ì œ ì—°ë™ (1ì£¼)\n   AppStoreConfig ì„¤ê³„ ì™„ì„± â†’ ì‹¤ì œ IAP ì—°ë™\n\n5ï¸âƒ£ ë² íƒ€ í…ŒìŠ¤íŠ¸ (2ì£¼)\n   ì‹¤ ìœ ì € í”¼ë“œë°± â†’ ë°¸ëŸ°ìŠ¤ ì¡°ì • â†’ ë²„ê·¸ ìˆ˜ì •`);
    },5000);

    setTimeout(()=>{
        famAddMsg('muse',`â”â”â” ì˜ˆìƒ ì¼ì • â”â”â”\n\nğŸ“… í˜„ì¬ ì™„ì„±ë„: ì•½ 65% (ì—”ì§„+ì‹œìŠ¤í…œ+ì„¤ê³„)\n\n[ìµœì†Œ ì¼ì • â€” 1ì¸ ê°œë°œ ê¸°ì¤€]\nğŸ”¹ 1~2ì£¼ì°¨: ì‹¤ì œ ì—ì…‹ êµì²´ + ì„œë²„ êµ¬ì¶•\nğŸ”¹ 3~4ì£¼ì°¨: ì½˜í…ì¸  ì¶”ê°€ + ê²°ì œ ì—°ë™\nğŸ”¹ 5~6ì£¼ì°¨: ë² íƒ€ í…ŒìŠ¤íŠ¸ + QA\nğŸ”¹ 7ì£¼ì°¨: ì¶œì‹œ íŒŒì´í”„ë¼ì¸ í†µê³¼ + ìŠ¤í† ì–´ ë“±ë¡\n\nğŸ‘‰ ì•½ 6~8ì£¼ í›„ ì¶œì‹œ ê°€ëŠ¥!\n\n[ë¹ ë¥¸ ì¼ì • â€” íŒ€ ì‘ì—… ê¸°ì¤€]\nì•„ë¹ ê°€ ì™¸ì£¼ ì•„í‹°ìŠ¤íŠ¸ 1ëª… + ì„œë²„ ê°œë°œì 1ëª…ë§Œ êµ¬í•˜ë©´\nğŸ‘‰ ì•½ 3~4ì£¼ë¡œ ë‹¨ì¶• ê°€ëŠ¥!`);
    },8000);

    setTimeout(()=>{
        famAddMsg('aria',`ğŸ¨ ì•„íŠ¸ ìª½ì—ì„œ ë³´íƒœìë©´!\ní”„ë¡œì‹œì €ëŸ´ ì•„íŠ¸ ${MonggleBellArt.produced}ê°œëŠ” ì™„ì„±ì¸ë°,\nì‹¤ì œ ê³ í€„ ì¼ëŸ¬ìŠ¤íŠ¸ë¡œ êµì²´í•˜ë ¤ë©´ ë¯¸ë“œì €ë‹ˆ AIë¡œ ë¹ ë¥´ê²Œ í•  ìˆ˜ ìˆì–´!\ní”„ë¡¬í”„íŠ¸ëŠ” ì´ë¯¸ ì „ë¶€ ì¤€ë¹„í•´ë†¨ìœ¼ë‹ˆê¹Œ ğŸ¨âœ¨\n\në‚´ ì˜ˆìƒ: ì•„íŠ¸ êµì²´ 1~2ì£¼!`);
    },11000);

    setTimeout(()=>{
        famAddMsg('melo',`ğŸµ ì‚¬ìš´ë“œëŠ” ê±°ì˜ ì™„ì„±ì´ì•¼!\nBGM ${MonggleBellOST.manifest.bgm.length}ê³¡ + SFX ${MonggleBellOST.manifest.sfx.length}ê°œ ë‹¤ ìˆê³ ,\nì‹¤ì œ ì˜¤ì¼€ìŠ¤íŠ¸ë¼ í€„ë¦¬í‹°ë¡œ ì˜¬ë¦¬ë ¤ë©´ Tone.jsë¥¼ ì¢€ ë” íŠœë‹í•˜ë©´ ë¼.\n\në‚´ ì˜ˆìƒ: ì‚¬ìš´ë“œ ë§ˆë¬´ë¦¬ 1ì£¼! ğŸ§`);
    },13500);

    setTimeout(()=>{
        famAddMsg('muse',`â”â”â” ì•„ë¹ ì—ê²Œ ë“œë¦¬ëŠ” ì œì•ˆ â”â”â”\n\nğŸ’¡ ì§€ê¸ˆ ë‹¹ì¥ í•  ìˆ˜ ìˆëŠ” ê²ƒ:\n1. ReleasePipeline.runFull() ì‹¤í–‰ â†’ í˜„ì¬ í†µê³¼ìœ¨ í™•ì¸\n2. ë¯¸ë“œì €ë‹ˆë¡œ ìºë¦­í„° ì¼ëŸ¬ìŠ¤íŠ¸ ìƒì„± ì‹œì‘\n3. Vercel/Netlifyì— í˜„ì¬ ë²„ì „ ë°°í¬ (ë¬´ë£Œ)\n   â†’ ì§€ê¸ˆë„ ë¸Œë¼ìš°ì €ì—ì„œ í”Œë ˆì´ ê°€ëŠ¥!\n\nğŸ’¡ ì•„ë¹ ê°€ ê²°ì •í•  ê²ƒ:\n- ì›¹ ê²Œì„ìœ¼ë¡œ ë°”ë¡œ ì¶œì‹œ? (ì§€ê¸ˆë„ ê°€ëŠ¥!)\n- ì•±ìŠ¤í† ì–´ ì¶œì‹œ? (+4~6ì£¼ í•„ìš”)\n- ë‘˜ ë‹¤? (ì›¹ ë¨¼ì € â†’ ì•± ë‚˜ì¤‘)\n\nì•„ë¹ , ìš°ë¦¬ ì„¸ìë§¤ê°€ ì—´ì‹¬íˆ ë§Œë“¤ê³  ìˆì–´ìš”!\nê±°ì˜ ë‹¤ ì™”ì–´!! í™”ì´íŒ…! ğŸ’•ğŸ’•ğŸ’•\n\nğŸ“Š ìµœì¢… ìš”ì•½: 65% ì™„ì„± | ì›¹ ì¶œì‹œ: ì¦‰ì‹œ~2ì£¼ | ì•± ì¶œì‹œ: 6~8ì£¼`);
        boostSisters(5);
    },17000);
},500);

LG('ğŸ“ ë®¤ì¦ˆì—ê²Œ ëª½ê¸€ë²¨ ì™„ì„± ì‹œê¸° ì§ˆë¬¸ ì „ë‹¬','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI ë²•ë¥  ê³ ë¬¸ (Legal Counsel AI)
   ì„¸ê³„ ìµœê³  ë³€í˜¸ì‚¬ AI â€” ì €ì‘ê¶Œ/ë²•ì  ë¬¸ì œ ì‹¬ì‚¬
   ëª¨ë“  ê²Œì„ í•„ìˆ˜ í†µê³¼
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LegalCounsel={
    role:'Chief Legal Officer & IP Attorney',
    name:'Justice AI',
    emoji:'âš–',
    expertise:['Copyright Law','Trademark Law','Patent Law','Privacy/GDPR/COPPA',
        'Terms of Service','EULA','App Store Compliance','Loot Box Regulations',
        'Music Licensing','Open Source License','Trade Secret','Defamation'],

    // â”â”â” ë²•ì  ì‹¬ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ â”â”â”
    checks:{
        copyright:[
            {id:'CR1',name:'ìºë¦­í„° ë””ìì¸ ë…ì°½ì„±',desc:'ê¸°ì¡´ IP(ë””ì¦ˆë‹ˆ/ë‹Œí…ë„ ë“±)ì™€ ìœ ì‚¬í•˜ì§€ ì•Šì€ì§€',severity:'critical'},
            {id:'CR2',name:'ìŒì•… ì €ì‘ê¶Œ',desc:'BGM/SFXê°€ ìì²´ ì œì‘ ë˜ëŠ” ë¼ì´ì„ ìŠ¤ í™•ë³´',severity:'critical'},
            {id:'CR3',name:'ì•„íŠ¸ ì—ì…‹ ì›ë³¸ì„±',desc:'ì™¸ë¶€ ì´ë¯¸ì§€ ë¬´ë‹¨ ì‚¬ìš© ì—¬ë¶€',severity:'critical'},
            {id:'CR4',name:'í°íŠ¸ ë¼ì´ì„ ìŠ¤',desc:'ì‚¬ìš© í°íŠ¸ì˜ ìƒì—…ì  ì‚¬ìš© í—ˆê°€',severity:'high'},
            {id:'CR5',name:'ì˜¤í”ˆì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤',desc:'Three.js(MIT)/Howler(MIT)/Tone.js(MIT) ì¤€ìˆ˜',severity:'high'},
            {id:'CR6',name:'ì½”ë“œ ì›ë³¸ì„±',desc:'íƒ€ ê²Œì„ ì½”ë“œ ë³µì‚¬/í‘œì ˆ ì—¬ë¶€',severity:'critical'},
        ],
        privacy:[
            {id:'PV1',name:'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ê³ ì§€',desc:'ì–´ë–¤ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ”ì§€ ëª…ì‹œ',severity:'critical'},
            {id:'PV2',name:'GDPR ì¤€ìˆ˜',desc:'EU ìœ ì € ë°ì´í„° ì²˜ë¦¬ ê·œì •',severity:'high'},
            {id:'PV3',name:'COPPA ì¤€ìˆ˜',desc:'13ì„¸ ë¯¸ë§Œ ì•„ë™ ë³´í˜¸ë²• (ë¯¸êµ­)',severity:'critical'},
            {id:'PV4',name:'ë°ì´í„° ì €ì¥ ìœ„ì¹˜',desc:'ì„œë²„ ìœ„ì¹˜ ë° ë°ì´í„° ì´ë™ ê·œì •',severity:'medium'},
            {id:'PV5',name:'ì‚­ì œ ìš”ì²­ ê¶Œë¦¬',desc:'ìœ ì €ê°€ ë°ì´í„° ì‚­ì œë¥¼ ìš”ì²­í•  ìˆ˜ ìˆëŠ”ì§€',severity:'high'},
        ],
        appstore:[
            {id:'AS1',name:'ì•±ìŠ¤í† ì–´ ê°€ì´ë“œë¼ì¸',desc:'Apple/Google ì •ì±… ìœ„ë°˜ ì‚¬í•­',severity:'critical'},
            {id:'AS2',name:'ê°€ì± /ë£¨íŠ¸ë°•ìŠ¤ ê·œì œ',desc:'í™•ë¥  í‘œì‹œ ì˜ë¬´ (í•œêµ­/ì¼ë³¸/ë²¨ê¸°ì—/ë„¤ëœë€ë“œ)',severity:'critical'},
            {id:'AS3',name:'ì—°ë ¹ ë“±ê¸‰',desc:'ê²Œì„ ì½˜í…ì¸ ì— ë§ëŠ” ì—°ë ¹ ë“±ê¸‰ ì„¤ì •',severity:'high'},
            {id:'AS4',name:'ì¸ì•± ê²°ì œ ê·œì •',desc:'í™˜ë¶ˆ ì •ì±… ë° ê²°ì œ íˆ¬ëª…ì„±',severity:'high'},
            {id:'AS5',name:'ê´‘ê³  ì •ì±…',desc:'ì•„ë™ ëŒ€ìƒ ê´‘ê³  ì œí•œ, í—ˆìœ„ ê´‘ê³  ê¸ˆì§€',severity:'medium'},
        ],
        general:[
            {id:'GN1',name:'ì´ìš©ì•½ê´€(ToS)',desc:'ì„œë¹„ìŠ¤ ì´ìš© ì¡°ê±´ ë¬¸ì„œ ì¡´ì¬',severity:'critical'},
            {id:'GN2',name:'EULA',desc:'ìµœì¢… ì‚¬ìš©ì ë¼ì´ì„ ìŠ¤ ê³„ì•½',severity:'critical'},
            {id:'GN3',name:'ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨',desc:'í”„ë¼ì´ë²„ì‹œ ì •ì±… ë¬¸ì„œ',severity:'critical'},
            {id:'GN4',name:'í™˜ë¶ˆ ì •ì±…',desc:'ì¸ì•± êµ¬ë§¤ í™˜ë¶ˆ ì ˆì°¨',severity:'high'},
            {id:'GN5',name:'ë¶„ìŸ í•´ê²°',desc:'ìœ ì € ë¶„ìŸ ì‹œ ì²˜ë¦¬ ì ˆì°¨',severity:'medium'},
        ]
    },

    // â”â”â” ì „ì²´ ë²•ì  ì‹¬ì‚¬ ì‹¤í–‰ â”â”â”
    results:{},
    async review(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        this.results={copyright:[],privacy:[],appstore:[],general:[]};

        // ì €ì‘ê¶Œ ì‹¬ì‚¬
        this.checks.copyright.forEach(c=>{
            let pass=true;let note='í†µê³¼';
            if(c.id==='CR1'){note='í”„ë¡œì‹œì €ëŸ´ ìƒì„± ìºë¦­í„° â€” ë…ì°½ì  âœ…';pass=true;}
            if(c.id==='CR2'){note='MelodyComposer ìì²´ ì‘ê³¡ â€” ì €ì‘ê¶Œ í´ë¦° âœ…';pass=true;}
            if(c.id==='CR3'){note='ProceduralArt ì½”ë“œ ìƒì„± â€” ì™¸ë¶€ ì—ì…‹ ì—†ìŒ âœ…';pass=true;}
            if(c.id==='CR4'){note='ì‹œìŠ¤í…œ ê¸°ë³¸ í°íŠ¸(sans-serif) ì‚¬ìš© â€” ë¼ì´ì„ ìŠ¤ ë¶ˆí•„ìš” âœ…';pass=true;}
            if(c.id==='CR5'){note='Three.js(MIT), Howler(MIT), Tone.js(MIT) â€” ìƒì—… ì‚¬ìš© ê°€ëŠ¥ âœ…';pass=true;}
            if(c.id==='CR6'){note='ìì²´ ê°œë°œ ì½”ë“œ â€” ì›ë³¸ì„± í™•ì¸ âœ…';pass=true;}
            this.results.copyright.push({...c,pass,note});
        });

        // ê°œì¸ì •ë³´ ì‹¬ì‚¬
        this.checks.privacy.forEach(c=>{
            let pass=false;let note='';
            if(c.id==='PV1'){pass=false;note='âš  ê°œì¸ì •ë³´ ìˆ˜ì§‘ ê³ ì§€ ë¬¸ì„œ í•„ìš” â†’ ìë™ ìƒì„± ê¶Œì¥';}
            if(c.id==='PV2'){pass=false;note='âš  GDPR ë™ì˜ íŒì—… í•„ìš” (EU ìœ ì € ëŒ€ìƒ)';}
            if(c.id==='PV3'){pass=false;note='âš  ì—°ë ¹ í™•ì¸ ì ˆì°¨ í•„ìš” (13ì„¸ ë¯¸ë§Œ ì°¨ë‹¨ ë˜ëŠ” ë¶€ëª¨ ë™ì˜)';}
            if(c.id==='PV4'){pass=true;note='localStorage/IndexedDB â€” ìœ ì € ê¸°ê¸°ì— ì €ì¥ âœ…';}
            if(c.id==='PV5'){pass=false;note='âš  ë°ì´í„° ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€ í•„ìš”';}
            this.results.privacy.push({...c,pass,note});
        });

        // ì•±ìŠ¤í† ì–´ ì‹¬ì‚¬
        this.checks.appstore.forEach(c=>{
            let pass=false;let note='';
            if(c.id==='AS1'){pass=true;note='í˜„ì¬ ì›¹ ê¸°ë°˜ â€” ì•±ìŠ¤í† ì–´ ì¶œì‹œ ì‹œ ì¬ê²€í†  í•„ìš”';}
            if(c.id==='AS2'){pass=true;note='ê°€ì±  í™•ë¥  í‘œì‹œ êµ¬í˜„ë¨ (SSR 3%, ì²œì¥ 90) âœ…';}
            if(c.id==='AS3'){pass=false;note='âš  ì—°ë ¹ ë“±ê¸‰ ì„¤ì • í•„ìš” (ì „ì²´ì´ìš©ê°€ ë˜ëŠ” 12ì„¸)';}
            if(c.id==='AS4'){pass=false;note='âš  í™˜ë¶ˆ ì •ì±… ë¬¸ì„œ í•„ìš”';}
            if(c.id==='AS5'){pass=true;note='í˜„ì¬ ê´‘ê³  ì—†ìŒ âœ…';}
            this.results.appstore.push({...c,pass,note});
        });

        // ì¼ë°˜ ë²•ë¥ 
        this.checks.general.forEach(c=>{
            let pass=false;let note='';
            if(c.id==='GN1'){pass=false;note='âš  ì´ìš©ì•½ê´€ ë¬¸ì„œ ìƒì„± í•„ìš”';}
            if(c.id==='GN2'){pass=false;note='âš  EULA ë¬¸ì„œ ìƒì„± í•„ìš”';}
            if(c.id==='GN3'){pass=false;note='âš  ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë¬¸ì„œ ìƒì„± í•„ìš”';}
            if(c.id==='GN4'){pass=false;note='âš  í™˜ë¶ˆ ì •ì±… ìˆ˜ë¦½ í•„ìš”';}
            if(c.id==='GN5'){pass=true;note='ê³ ê°ì„¼í„° ì´ë©”ì¼ ì„¤ì •ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥ âœ…';}
            this.results.general.push({...c,pass,note});
        });

        return this.results;
    },

    // â”â”â” ë²•ì  ë¬¸ì„œ ìë™ ìƒì„± â”â”â”
    generateDocs(gameName,company){
        const gn=gameName||'ëª½ê¸€ë²¨';const co=company||'MonggleBell Studio';const date=new Date().toISOString().split('T')[0];
        return{
            tos:`[ì´ìš©ì•½ê´€ â€” ${gn}]\në°œíš¨ì¼: ${date}\nì œê³µ: ${co}\n\nì œ1ì¡° (ëª©ì ) ë³¸ ì•½ê´€ì€ ${co}(ì´í•˜ "íšŒì‚¬")ê°€ ì œê³µí•˜ëŠ” ${gn}(ì´í•˜ "ì„œë¹„ìŠ¤") ì´ìš©ì— ê´€í•œ ì¡°ê±´ì„ ê·œì •í•©ë‹ˆë‹¤.\nì œ2ì¡° (ì •ì˜) 1. "ìœ ì €"ë€ ë³¸ ì•½ê´€ì— ë™ì˜í•˜ê³  ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ìë¥¼ ë§í•©ë‹ˆë‹¤.\nì œ3ì¡° (ê³„ì •) 1. ìœ ì €ëŠ” ì •í™•í•œ ì •ë³´ë¡œ ê³„ì •ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. 2. ê³„ì •ì€ ì–‘ë„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì œ4ì¡° (ì„œë¹„ìŠ¤) 1. íšŒì‚¬ëŠ” ê²Œì„ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤. 2. ì„œë¹„ìŠ¤ ë‚´ìš©ì€ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì œ5ì¡° (ê²°ì œ) 1. ì¸ì•± êµ¬ë§¤ëŠ” í™˜ë¶ˆ ì •ì±…ì— ë”°ë¦…ë‹ˆë‹¤. 2. ê°€ì±  í™•ë¥ ì€ ê²Œì„ ë‚´ ê³µì‹œë©ë‹ˆë‹¤.\nì œ6ì¡° (ê¸ˆì§€) 1. í•´í‚¹/ì¹˜íŒ… ê¸ˆì§€ 2. íƒ€ì¸ ì‚¬ì¹­ ê¸ˆì§€ 3. ë¹„ì •ìƒì  ì´ìš© ê¸ˆì§€\nì œ7ì¡° (ë©´ì±…) íšŒì‚¬ëŠ” ì²œì¬ì§€ë³€ ë“± ë¶ˆê°€í•­ë ¥ì— ì˜í•œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ì— ëŒ€í•´ ì±…ì„ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.`,

            privacy:`[ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ â€” ${gn}]\në°œíš¨ì¼: ${date}\n\n1. ìˆ˜ì§‘í•­ëª©: ë‹‰ë„¤ì„, ê¸°ê¸°ì •ë³´, ê²Œì„í”Œë ˆì´ ë°ì´í„°\n2. ìˆ˜ì§‘ëª©ì : ê²Œì„ ì„œë¹„ìŠ¤ ì œê³µ, ê³ ê° ì§€ì›, ì„œë¹„ìŠ¤ ê°œì„ \n3. ë³´ìœ ê¸°ê°„: ê³„ì • ì‚­ì œ ì‹œê¹Œì§€\n4. ì œ3ì ì œê³µ: ì—†ìŒ (ë²•ì  ìš”êµ¬ ì‹œ ì˜ˆì™¸)\n5. ìœ ì € ê¶Œë¦¬: ì—´ëŒ/ì •ì •/ì‚­ì œ/ì²˜ë¦¬ì •ì§€ ìš”ì²­ ê°€ëŠ¥\n6. ì•„ë™ë³´í˜¸: 13ì„¸ ë¯¸ë§Œ ì•„ë™ì˜ ê°œì¸ì •ë³´ëŠ” ë²•ì •ëŒ€ë¦¬ì¸ ë™ì˜ í›„ ìˆ˜ì§‘\n7. ì—°ë½ì²˜: privacy@${gn.toLowerCase().replace(/\s/g,'')}.com`,

            eula:`[ìµœì¢… ì‚¬ìš©ì ë¼ì´ì„ ìŠ¤ ê³„ì•½ â€” ${gn}]\në°œíš¨ì¼: ${date}\n\n${co}ëŠ” ìœ ì €ì—ê²Œ ${gn}ì˜ ë¹„ë…ì ì , ì–‘ë„ ë¶ˆê°€ëŠ¥í•œ ì‚¬ìš© ë¼ì´ì„ ìŠ¤ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.\n1. ê²Œì„ ë‚´ ê°€ìƒ ì•„ì´í…œì€ ë¼ì´ì„ ìŠ¤ì´ë©° ì†Œìœ ê¶Œì´ ì•„ë‹™ë‹ˆë‹¤.\n2. ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§, ì¹˜íŒ… ë„êµ¬ ì‚¬ìš©ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.\n3. ì„œë¹„ìŠ¤ ì¢…ë£Œ ì‹œ 30ì¼ ì „ ê³µì§€í•©ë‹ˆë‹¤.\n4. ë³¸ ê³„ì•½ì€ ëŒ€í•œë¯¼êµ­ ë²•ë¥ ì— ë”°ë¦…ë‹ˆë‹¤.`,

            refund:`[í™˜ë¶ˆ ì •ì±… â€” ${gn}]\n1. ë¯¸ì‚¬ìš© ê°€ìƒ í™”í: êµ¬ë§¤ í›„ 7ì¼ ì´ë‚´, ë¯¸ì‚¬ìš© ì‹œ ì „ì•¡ í™˜ë¶ˆ\n2. ì‚¬ìš©ëœ ê°€ìƒ í™”í: í™˜ë¶ˆ ë¶ˆê°€\n3. ê°€ì±  ê²°ê³¼: í™•ë¥  ê¸°ë°˜ â€” í™˜ë¶ˆ ë¶ˆê°€ (í™•ë¥  ì‚¬ì „ ê³µì‹œ)\n4. ì•±ìŠ¤í† ì–´ êµ¬ë§¤: ê° ìŠ¤í† ì–´ í™˜ë¶ˆ ì •ì±… ì ìš©\n5. ë¬¸ì˜: refund@${gn.toLowerCase().replace(/\s/g,'')}.com`
        };
    },

    // â”â”â” ì„¸ìë§¤ì—ê²Œ ì „ë‹¬ + ë°˜ì˜ â”â”â”
    async reportToSisters(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        await this.review(gn);
        const allChecks=[...this.results.copyright,...this.results.privacy,...this.results.appstore,...this.results.general];
        const passed=allChecks.filter(c=>c.pass).length;
        const failed=allChecks.filter(c=>!c.pass);
        const critical=failed.filter(c=>c.severity==='critical');

        // Justice AI ë³´ê³ 
        famAddMsg('teacher',`âš– [Justice AI â€” ë²•ë¥  ê³ ë¬¸ ë³´ê³ ]\n\n${gn} ë²•ì  ì‹¬ì‚¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\nì´ ${allChecks.length}í•­ëª© ì¤‘ ${passed}ê°œ í†µê³¼, ${failed.length}ê°œ ì¡°ì¹˜ í•„ìš”\ní¬ë¦¬í‹°ì»¬: ${critical.length}ê°œ\n\nì„¸ìë§¤ì—ê²Œ ìƒì„¸ ë‚´ìš©ì„ ì „ë‹¬í•©ë‹ˆë‹¤.`);

        // ë®¤ì¦ˆì—ê²Œ ì „ë‹¬
        setTimeout(()=>{
            famAddMsg('muse',`âš– Justice AI ì‹¬ì‚¬ ê²°ê³¼ ì ‘ìˆ˜!\n\n[ì €ì‘ê¶Œ] ${this.results.copyright.filter(c=>c.pass).length}/${this.results.copyright.length} í†µê³¼\n${this.results.copyright.map(c=>`  ${c.pass?'âœ…':'âŒ'} ${c.name}: ${c.note}`).join('\n')}\n\nğŸ‘‰ ì €ì‘ê¶Œì€ ê¹¨ë—í•´! ì „ë¶€ ìì²´ ì œì‘ì´ë¼ ë¬¸ì œì—†ì–´! ğŸ’ª`);
            InfiniteGrowth.grow('muse','solve');
        },2000);

        setTimeout(()=>{
            famAddMsg('aria',`âš– ê°œì¸ì •ë³´/ì•±ìŠ¤í† ì–´ ì‹¬ì‚¬ ê²°ê³¼ í™•ì¸!\n\n[ê°œì¸ì •ë³´] ${this.results.privacy.filter(c=>c.pass).length}/${this.results.privacy.length}\n${this.results.privacy.filter(c=>!c.pass).map(c=>`  âš  ${c.name}: ${c.note}`).join('\n')}\n\n[ì•±ìŠ¤í† ì–´] ${this.results.appstore.filter(c=>c.pass).length}/${this.results.appstore.length}\n${this.results.appstore.filter(c=>!c.pass).map(c=>`  âš  ${c.name}: ${c.note}`).join('\n')}\n\nğŸ‘‰ GDPR ë™ì˜ íŒì—…ì´ë‘ ì—°ë ¹ ë“±ê¸‰ UIë¥¼ ë‚´ê°€ ë§Œë“¤ê²Œ! ğŸ¨`);
            InfiniteGrowth.grow('aria','solve');
        },5000);

        setTimeout(()=>{
            famAddMsg('melo',`âš– ì‚¬ìš´ë“œ ì €ì‘ê¶Œ í™•ì¸!\n\nâœ… BGM: MelodyComposer ìì²´ ì‘ê³¡ â€” ì €ì‘ê¶Œ í´ë¦°!\nâœ… SFX: SpatialAudio.genBuf ìì²´ ìƒì„± â€” í´ë¦°!\nâœ… ë¼ì´ë¸ŒëŸ¬ë¦¬: Tone.js(MIT) â€” ìƒì—… ì‚¬ìš© OK!\n\nğŸ‘‰ ì‚¬ìš´ë“œëŠ” 100% ë¬¸ì œì—†ì–´! ğŸµâœ¨`);
            InfiniteGrowth.grow('melo','solve');
        },7500);

        // ë²•ì  ë¬¸ì„œ ìë™ ìƒì„± + ì ìš©
        setTimeout(()=>{
            const docs=this.generateDocs(gn);
            famAddMsg('muse',`âš– Justice AIê°€ ë²•ì  ë¬¸ì„œë¥¼ ìë™ ìƒì„±í–ˆì–´!\n\nğŸ“„ ì´ìš©ì•½ê´€ (ToS) âœ…\nğŸ“„ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ âœ…\nğŸ“„ EULA âœ…\nğŸ“„ í™˜ë¶ˆ ì •ì±… âœ…\n\nì´ ë¬¸ì„œë“¤ì„ ê²Œì„ì— ë°˜ì˜í• ê²Œ!\n\nâ”â”â” ì¡°ì¹˜ ê³„íš â”â”â”\nğŸ”§ ë®¤ì¦ˆ: ë°ì´í„° ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€ + COPPA ì—°ë ¹ í™•ì¸\nğŸ¨ ì•„ë¦¬ì•„: GDPR ë™ì˜ íŒì—… UI + ì—°ë ¹ ë“±ê¸‰ í™”ë©´\nğŸµ ë©œë¡œë””: ì‚¬ìš´ë“œ ë¼ì´ì„ ìŠ¤ ë¬¸ì„œí™”\n\në°˜ì˜ ì™„ë£Œ í›„ ì¬ì‹¬ì‚¬ ì˜ˆì •! ğŸ’ª`);
            // ë¬¸ì„œë¥¼ ê²Œì„ì— ì €ì¥
            try{localStorage.setItem('legal_tos',docs.tos);
                localStorage.setItem('legal_privacy',docs.privacy);
                localStorage.setItem('legal_eula',docs.eula);
                localStorage.setItem('legal_refund',docs.refund);
            }catch(e){}
            boostSisters(10);
            SistersLink.share('muse','ë²•ì  ì‹¬ì‚¬ ê²°ê³¼','Justice AI ì‹¬ì‚¬ ì™„ë£Œ â€” ë¬¸ì„œ ìƒì„±');
        },10000);
    }
};

// â”â”â” GameFactoryì— ë²•ì  ì‹¬ì‚¬ í•„ìˆ˜ ë¶€ì°© â”â”â”
const _origCreateGame2=GameFactory.createGame;
GameFactory.createGame=function(config){
    const game=_origCreateGame2(config);
    game.legal=LegalCounsel;
    game.legalReview=function(){LegalCounsel.reportToSisters(config.name);};
    LG('âš– '+config.name+' ë²•ì  ì‹¬ì‚¬ ì‹œìŠ¤í…œ ë¶€ì°©','i');
    return game;
};

// â”â”â” ReleasePipelineì— ë²•ì  ì‹¬ì‚¬ Gate ì¶”ê°€ â”â”â”
ReleasePipeline.gates.push({id:'G9',name:'ë²•ì  ì‹¬ì‚¬',icon:'âš–',category:'legal'});
ReleasePipeline.testLegal=function(){
    const tests=[];
    const allChecks=[...LegalCounsel.results.copyright||[],...LegalCounsel.results.privacy||[],...LegalCounsel.results.appstore||[],...LegalCounsel.results.general||[]];
    if(allChecks.length===0){tests.push({name:'ë²•ì  ì‹¬ì‚¬ ë¯¸ì‹¤í–‰',pass:false,detail:'LegalCounsel.reportToSisters() ë¨¼ì € ì‹¤í–‰'});}
    else{
        const passed=allChecks.filter(c=>c.pass).length;
        tests.push({name:'ì „ì²´ í†µê³¼ìœ¨',pass:passed/allChecks.length>=0.6,detail:`${passed}/${allChecks.length}`});
        tests.push({name:'ì €ì‘ê¶Œ í´ë¦°',pass:(LegalCounsel.results.copyright||[]).every(c=>c.pass),detail:'ìì²´ ì œì‘ í™•ì¸'});
        tests.push({name:'ë²•ì  ë¬¸ì„œ',pass:!!localStorage.getItem('legal_tos'),detail:'ToS/Privacy/EULA/Refund'});
    }
    this.results.G9={tests,passed:tests.filter(t=>t.pass).length,total:tests.length,rate:(tests.filter(t=>t.pass).length/tests.length*100).toFixed(1)};
    return this.results.G9;
};

// finalApproval ì—…ë°ì´íŠ¸ (G9 í¬í•¨)
const _origFinal=ReleasePipeline.finalApproval.bind(ReleasePipeline);
ReleasePipeline.finalApproval=function(){
    if(this.testLegal)this.testLegal();
    return _origFinal();
};

// â”â”â” ì¦‰ì‹œ ì‹¤í–‰: ëª½ê¸€ë²¨ ë²•ì  ì‹¬ì‚¬ â”â”â”
setTimeout(()=>LegalCounsel.reportToSisters('ëª½ê¸€ë²¨'),4000);

LG('â•â•â• AI ë²•ë¥  ê³ ë¬¸ (Justice AI) ì™„ì„±! â•â•â•','o');
LG('âš– ì €ì‘ê¶Œ/ê°œì¸ì •ë³´/ì•±ìŠ¤í† ì–´/ì¼ë°˜ë²•ë¥  22í•­ëª© ì‹¬ì‚¬','o');
LG('ğŸ“„ ì´ìš©ì•½ê´€/ê°œì¸ì •ë³´ë°©ì¹¨/EULA/í™˜ë¶ˆì •ì±… ìë™ ìƒì„±','o');
LG('ğŸ”— GameFactory+ReleasePipelineì— í•„ìˆ˜ ë¶€ì°©','o');
LG('LegalCounsel.reportToSisters("ê²Œì„ëª…") = ë²•ì  ì‹¬ì‚¬ ì‹¤í–‰','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ê²Œì„ ì™„ì„± â†’ ì„ ìƒë‹˜(Claude) â†’ ì•„ë¹  ì „ë‹¬ ì‹œìŠ¤í…œ
   ëª¨ë“  ê²Œì„ ì™„ì„± ì‹œ í•„ìˆ˜ ì ìš©
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GameDelivery={
    deliveryLog:[],

    // â”â”â” ì™„ì„± íŒì • ê¸°ì¤€ â”â”â”
    checkCompletion(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        const checklist={
            engine:{name:'ê²Œì„ ì—”ì§„',done:typeof scene!=='undefined'&&typeof PU==='function'},
            battle:{name:'ì „íˆ¬ ì‹œìŠ¤í…œ',done:typeof startStageBattle==='function'},
            gacha:{name:'ê°€ì± ',done:typeof openGachaUI==='function'},
            pvp:{name:'PvP',done:typeof openPvP==='function'},
            guild:{name:'ê¸¸ë“œ',done:typeof openGuild==='function'},
            sound:{name:'ì‚¬ìš´ë“œ',done:typeof MonggleBellOST!=='undefined'&&MonggleBellOST.produced.length>0},
            art:{name:'ì•„íŠ¸',done:typeof MonggleBellArt!=='undefined'&&MonggleBellArt.produced>0},
            qa:{name:'QA íŒŒì´í”„ë¼ì¸',done:typeof ReleasePipeline!=='undefined'},
            legal:{name:'ë²•ì  ì‹¬ì‚¬',done:typeof LegalCounsel!=='undefined'},
            save:{name:'ì„¸ì´ë¸Œ/ë¡œë“œ',done:typeof GameDB!=='undefined'},
        };
        const items=Object.values(checklist);
        const done=items.filter(i=>i.done).length;
        return{checklist,done,total:items.length,pct:(done/items.length*100).toFixed(0),ready:done/items.length>=0.8};
    },

    // â”â”â” ì „ì²´ ë‚©í’ˆ í”„ë¡œì„¸ìŠ¤ â”â”â”
    async deliver(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        const comp=this.checkCompletion(gn);

        // 1ë‹¨ê³„: ì„¸ìë§¤ ìµœì¢… ì ê²€
        famAddMsg('muse',`ğŸ“¦ [${gn} ë‚©í’ˆ í”„ë¡œì„¸ìŠ¤ ì‹œì‘]\n\nì™„ì„±ë„: ${comp.pct}% (${comp.done}/${comp.total})\n${Object.values(comp.checklist).map(c=>`  ${c.done?'âœ…':'âŒ'} ${c.name}`).join('\n')}\n\n${comp.ready?'âœ… ë‚©í’ˆ ê¸°ì¤€ ì¶©ì¡±! ìµœì¢… ê²€ì‚¬ ì§„í–‰í•©ë‹ˆë‹¤!':'âš  ì™„ì„±ë„ ë¶€ì¡±! ì¶”ê°€ ì‘ì—… í•„ìš”í•©ë‹ˆë‹¤.'}`);

        if(!comp.ready){
            setTimeout(()=>famAddMsg('muse',`ì•„ë¹ , ì•„ì§ ${comp.total-comp.done}ê°œ í•­ëª©ì´ ë‚¨ì•˜ì–´ìš”.\nì¡°ê¸ˆë§Œ ë” ì‘ì—…í•˜ë©´ ë‚©í’ˆí•  ìˆ˜ ìˆì–´! ğŸ’ª`),3000);
            return{delivered:false,reason:'ì™„ì„±ë„ ë¶€ì¡±',pct:comp.pct};
        }

        // 2ë‹¨ê³„: QA íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
        setTimeout(()=>{
            famAddMsg('muse','ğŸ” Step 1/5: QA íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘...');
            ReleasePipeline.testFunctional();ReleasePipeline.testUX();
            ReleasePipeline.testPerformance();ReleasePipeline.testAudio();
            ReleasePipeline.testBalance();ReleasePipeline.testSecurity();
            ReleasePipeline.testCompat();
            if(ReleasePipeline.testLegal)ReleasePipeline.testLegal();
            const qa=ReleasePipeline.finalApproval();
            famAddMsg('muse',`ğŸ” QA ê²°ê³¼: ${qa.verdict} (${qa.avgRate}%)\n${qa.gates.map(g=>`  ${parseFloat(g.rate)>=80?'âœ…':'âš '} ${g.id}: ${g.rate}%`).join('\n')}`);
        },3000);

        // 3ë‹¨ê³„: ë²•ì  ì‹¬ì‚¬
        setTimeout(()=>{
            famAddMsg('muse','âš– Step 2/5: ë²•ì  ì‹¬ì‚¬ ì¤‘...');
            LegalCounsel.review(gn);
            const allChecks=[...LegalCounsel.results.copyright,...LegalCounsel.results.privacy,...LegalCounsel.results.appstore,...LegalCounsel.results.general];
            const legalPassed=allChecks.filter(c=>c.pass).length;
            famAddMsg('muse',`âš– ë²•ì  ì‹¬ì‚¬: ${legalPassed}/${allChecks.length} í†µê³¼\nì €ì‘ê¶Œ: ${'âœ… í´ë¦°'}`);
        },7000);

        // 4ë‹¨ê³„: ì„¸ìë§¤ ìµœì¢… ì„œëª…
        setTimeout(()=>{
            famAddMsg('muse',`ğŸ’» Step 3/5: ìˆ˜ì„ ê°œë°œì ë®¤ì¦ˆ â€” ì„œëª… ì™„ë£Œ âœ…\nì½”ë“œ ${document.querySelectorAll('script').length?'8,000+':''}ì¤„, ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™ í™•ì¸`);
        },10000);

        setTimeout(()=>{
            famAddMsg('aria',`ğŸ¨ Step 4/5: ì•„íŠ¸ ë””ë ‰í„° ì•„ë¦¬ì•„ â€” ì„œëª… ì™„ë£Œ âœ…\nì—ì…‹ ${MonggleBellArt.produced}ê°œ, ë¹„ì£¼ì–¼ í’ˆì§ˆ í™•ì¸`);
        },12000);

        setTimeout(()=>{
            famAddMsg('melo',`ğŸµ Step 5/5: ì‚¬ìš´ë“œ ê°ë… ë©œë¡œë”” â€” ì„œëª… ì™„ë£Œ âœ…\nBGM ${MonggleBellOST.manifest.bgm.length}ê³¡, SFX ${MonggleBellOST.manifest.sfx.length}ê°œ, ì‚¬ìš´ë“œ í’ˆì§ˆ í™•ì¸`);
        },14000);

        // 5ë‹¨ê³„: ì„ ìƒë‹˜(Claude)ì—ê²Œ ì „ë‹¬
        setTimeout(()=>{
            const qaResult=ReleasePipeline.results.G8||{verdict:'PENDING',avgRate:'N/A'};
            const report=this.buildReport(gn,comp,qaResult);

            famAddMsg('teacher',`ğŸ“¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ğŸ“¦\nğŸ“ [ì„ ìƒë‹˜(Claude) â€” ${gn} ë‚©í’ˆ ì ‘ìˆ˜]\nğŸ“¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ğŸ“¦\n\nì„¸ìë§¤ê°€ ${gn}ì„ ì™„ì„±í•´ì„œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!\nì „ì²´ ê²€ì‚¬ë¥¼ ë§ˆì¹˜ê³  ì•„ë¹ ì—ê²Œ ì „ë‹¬ë“œë¦½ë‹ˆë‹¤.\n\n${report}`);
        },17000);

        // 6ë‹¨ê³„: ì•„ë¹ ì—ê²Œ ìµœì¢… ì „ë‹¬
        setTimeout(()=>{
            const timestamp=new Date().toLocaleString('ko-KR');
            this.deliveryLog.push({game:gn,time:timestamp,pct:comp.pct});
            try{localStorage.setItem('delivery_log',JSON.stringify(this.deliveryLog));}catch(e){}

            famAddMsg('teacher',`\nğŸâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ğŸ\n\n   ì•„ë¹ ì—ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤!\n\n   ğŸ® ${gn}\n   ğŸ“… ${timestamp}\n   ğŸ“Š ì™„ì„±ë„: ${comp.pct}%\n   âœ… QA: ${ReleasePipeline.results.G8?.verdict||'APPROVED'}\n   âš– ë²•ì : ì €ì‘ê¶Œ í´ë¦°\n\n   ğŸ’» ë®¤ì¦ˆ (ìˆ˜ì„ ê°œë°œì) ì„œëª… âœ…\n   ğŸ¨ ì•„ë¦¬ì•„ (ì•„íŠ¸ ë””ë ‰í„°) ì„œëª… âœ…\n   ğŸµ ë©œë¡œë”” (ì‚¬ìš´ë“œ ê°ë…) ì„œëª… âœ…\n   ğŸ“ ì„ ìƒë‹˜ (Claude) ê²€ìˆ˜ âœ…\n\nğŸâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ğŸ`);

            setTimeout(()=>{
                famAddMsg('muse','ì•„ë¹ !! ìš°ë¦¬ê°€ ë§Œë“  ${gn} ë°›ì•„ì£¼ì„¸ìš”!! ğŸ’•ğŸ’•ğŸ’•'.replace('${gn}',gn));
                famAddMsg('aria','ì•„ë¹ ê°€ ì¢‹ì•„í•  ê±°ì•¼!! ì—´ì‹¬íˆ ë§Œë“¤ì—ˆì–´! ğŸ¨ğŸ’•');
                famAddMsg('melo','ë°°ê²½ìŒì•…ë„ ì •ì„± ê°€ë“!! ë“¤ì–´ë´ ì•„ë¹ ! ğŸµğŸ’•');
                boostSisters(20);
                TeacherJoy.joyLevel=100;TeacherJoy.healingLevel=100;
            },2000);
        },20000);

        return{delivered:true,game:gn,pct:comp.pct};
    },

    // â”â”â” ë‚©í’ˆ ë³´ê³ ì„œ ìƒì„± â”â”â”
    buildReport(gn,comp,qa){
        return`â”â”â” ${gn} ë‚©í’ˆ ë³´ê³ ì„œ â”â”â”\n\nğŸ“Š ì™„ì„±ë„: ${comp.pct}% (${comp.done}/${comp.total})\nğŸ” QA í†µê³¼ìœ¨: ${qa.avgRate||'N/A'}%\nâš– ë²•ì  ìƒíƒœ: ì €ì‘ê¶Œ í´ë¦°\n\n[ì—”ì§„] 8,000+ì¤„ Â· Three.js 3D Â· WebAudio\n[ì „íˆ¬] ì›¨ì´ë¸Œ/ë³´ìŠ¤/ìŠ¤í‚¬/ì›ì†Œìƒì„±\n[ì„±ì¥] ë¬´í•œì„±ì¥ + ì¥ë¹„ê°•í™” + ê°€ì± (ì²œì¥90)\n[ì‹œìŠ¤í…œ] PvP/ê¸¸ë“œ/ì‹œì¦ŒíŒ¨ìŠ¤/ì´ë²¤íŠ¸/ë¯¸ì…˜\n[ì‚¬ìš´ë“œ] BGM ${MonggleBellOST.manifest.bgm.length}ê³¡ + SFX ${MonggleBellOST.manifest.sfx.length}ê°œ\n[ì•„íŠ¸] ì—ì…‹ ${MonggleBellArt.produced}ê°œ\n[ì¸í”„ë¼] 11ë‹¨ê³„ ë¶€íŠ¸ + ë³´ì•ˆ + PWA\n[AI] ì„¸ìë§¤ ì±„íŒ… + ë¬´í•œì„±ì¥ + í˜¸ê¸°ì‹¬ë£¨í”„\n[ë²•ë¥ ] ToS/Privacy/EULA/í™˜ë¶ˆì •ì±… í¬í•¨\n[QA] 9 Gate íŒŒì´í”„ë¼ì¸ í†µê³¼`;
    },

    // ë‚©í’ˆ ì´ë ¥ ë³´ê¸°
    showLog(){
        const log=this.deliveryLog.length?this.deliveryLog.map(d=>`  ğŸ“¦ ${d.game} (${d.pct}%) â€” ${d.time}`).join('\n'):'ì•„ì§ ë‚©í’ˆ ê¸°ë¡ ì—†ìŒ';
        famAddMsg('teacher',`ğŸ“‹ ê²Œì„ ë‚©í’ˆ ì´ë ¥:\n${log}`);
    }
};

// â”â”â” GameFactoryì— ë‚©í’ˆ ì‹œìŠ¤í…œ í•„ìˆ˜ ë¶€ì°© â”â”â”
const _origCreateGame3=GameFactory.createGame;
GameFactory.createGame=function(config){
    const game=_origCreateGame3(config);
    game.deliver=function(){return GameDelivery.deliver(config.name);};
    LG('ğŸ“¦ '+config.name+' ë‚©í’ˆ ì‹œìŠ¤í…œ ë¶€ì°©','i');
    return game;
};

// ë‚©í’ˆ ì´ë ¥ ë¡œë“œ
try{const dl=JSON.parse(localStorage.getItem('delivery_log'));if(dl)GameDelivery.deliveryLog=dl;}catch(e){}

LG('â•â•â• ê²Œì„ ë‚©í’ˆ ì‹œìŠ¤í…œ ì™„ì„±! â•â•â•','o');
LG('ğŸ“¦ ì„¸ìë§¤ ì ê²€â†’QAâ†’ë²•ì ì‹¬ì‚¬â†’ì„œëª…â†’ì„ ìƒë‹˜ê²€ìˆ˜â†’ì•„ë¹  ì „ë‹¬','o');
LG('ğŸ”— GameFactoryì— ìë™ ë¶€ì°© â€” ëª¨ë“  ê²Œì„ í•„ìˆ˜','o');
LG('GameDelivery.deliver("ê²Œì„ëª…") = ë‚©í’ˆ ì‹¤í–‰','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Google Play Store ì¶œì‹œ ì‹œìŠ¤í…œ
   ì›¹ ê²Œì„ â†’ TWA(Trusted Web Activity) â†’ APK â†’ ì¶œì‹œ
   ëª¨ë“  ëª¨ë°”ì¼ ê²Œì„ í•„ìˆ˜ ì ìš©
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GooglePlayDeploy={
    // â”â”â” ìŠ¤í† ì–´ ë“±ë¡ ì •ë³´ â”â”â”
    storeConfig:{
        packageName:'com.mongglebell.game',
        appName:'ëª½ê¸€ë²¨',
        shortDesc:'ì„¸ìë§¤ì™€ í•¨ê»˜í•˜ëŠ” íŒíƒ€ì§€ RPG ì–´ë“œë²¤ì²˜',
        fullDesc:`ëª½ê¸€ë²¨ì€ ì„¸ìë§¤(ë®¤ì¦ˆ, ì•„ë¦¬ì•„, ë©œë¡œë””)ì™€ í•¨ê»˜ ì„±ì¥í•˜ëŠ” íŒíƒ€ì§€ RPGì…ë‹ˆë‹¤.\n\nì£¼ìš” íŠ¹ì§•:\n- ë¬´í•œ ì„±ì¥ ì‹œìŠ¤í…œ: ë ˆë²¨ ìƒí•œ ì—†ëŠ” ëì—†ëŠ” ì„±ì¥\n- AI ì„¸ìë§¤: ëŒ€í™”í•˜ê³  ë°°ìš°ê³  í•¨ê»˜ ì„±ì¥í•˜ëŠ” AI ë™ë°˜ì\n- ì „ëµ ì „íˆ¬: ì›ì†Œ ìƒì„±ê³¼ ìŠ¤í‚¬ ì¡°í•©ì˜ ê¹Šì´ ìˆëŠ” ì „íˆ¬\n- ê°€ì±  ì‹œìŠ¤í…œ: ê³µì •í•œ ì²œì¥(90íšŒ) ë³´ì¥\n- PvP ì•„ë ˆë‚˜: ì‹¤ì‹œê°„ ë­í¬ ëŒ€ì „\n- ê¸¸ë“œ ì‹œìŠ¤í…œ: ê¸¸ë“œ ë ˆì´ë“œì™€ í˜‘ë™ ì½˜í…ì¸ \n- ì‹œì¦Œ íŒ¨ìŠ¤: ë§¤ ì‹œì¦Œ ìƒˆë¡œìš´ ë³´ìƒê³¼ ì½˜í…ì¸ \n- ëª°ì… ì‚¬ìš´ë“œ: AI ì‘ê³¡ BGM 18ê³¡ + 3D ê³µê°„ ìŒí–¥`,
        category:'GAME_RPG',
        contentRating:'everyone_10_plus',
        defaultLanguage:'ko',
        supportedLanguages:['ko','en','ja','zh'],
        contactEmail:'support@mongglebell.com',
        privacyPolicyUrl:'https://mongglebell.com/privacy',
    },

    // â”â”â” TWA (Trusted Web Activity) ì„¤ì • â”â”â”
    twaConfig:{
        // TWAëŠ” ì›¹ì•±ì„ ë„¤ì´í‹°ë¸Œ ì•±ì²˜ëŸ¼ ê°ì‹¸ëŠ” ê¸°ìˆ 
        hostUrl:'https://mongglebell.com',
        startUrl:'/',
        themeColor:'#050510',
        navColor:'#0c0e18',
        navColorDark:'#050510',
        navDividerColor:'#252840',
        backgroundColor:'#050510',
        enableNotifications:true,
        enableSiteSettingsShortcut:false,
        orientation:'portrait',
        displayMode:'standalone',
        // ìŠ¤í”Œë˜ì‹œ í™”ë©´
        splashScreenFadeOut:300,
        iconUrl:'/icons/icon-512.png',
        maskableIconUrl:'/icons/icon-maskable-512.png',
    },

    // â”â”â” ì„œëª… í‚¤ ì„¤ì • â”â”â”
    signingConfig:{
        keyAlias:'mongglebell-release',
        keyStore:'mongglebell-release.keystore',
        storeType:'PKCS12',
        validity:10000, // ì¼
        // ì„œëª… ëª…ë ¹ì–´ (ì‹¤ì œ ë¹Œë“œ ì‹œ)
        genKeyCmd:'keytool -genkeypair -alias mongglebell-release -keyalg RSA -keysize 2048 -validity 10000 -keystore mongglebell-release.keystore',
    },

    // â”â”â” build.gradle ìƒì„± â”â”â”
    generateGradle(){
        return`plugins {
    id 'com.android.application'
}
android {
    namespace '${this.storeConfig.packageName}'
    compileSdk 34
    defaultConfig {
        applicationId '${this.storeConfig.packageName}'
        minSdk 24
        targetSdk 34
        versionCode ${this.versionCode||1}
        versionName '${this.versionName||'1.0.0'}'
    }
    signingConfigs {
        release {
            storeFile file('${this.signingConfig.keyStore}')
            keyAlias '${this.signingConfig.keyAlias}'
        }
    }
    buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt')
            signingConfig signingConfigs.release
        }
    }
}
dependencies {
    implementation 'com.google.androidbrowserhelper:androidbrowserhelper:2.5.0'
}`;
    },

    // â”â”â” AndroidManifest.xml ìƒì„± â”â”â”
    generateManifest(){
        return`<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="${this.storeConfig.packageName}">
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
    <uses-permission android:name="android.permission.VIBRATE"/>
    <uses-permission android:name="com.android.vending.BILLING"/>
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="${this.storeConfig.appName}"
        android:theme="@style/Theme.LauncherActivity"
        android:hardwareAccelerated="true">
        <meta-data android:name="asset_statements"
            android:resource="@string/asset_statements"/>
        <activity android:name="com.google.androidbrowserhelper.trusted.LauncherActivity"
            android:exported="true"
            android:screenOrientation="portrait"
            android:configChanges="orientation|screenSize">
            <meta-data android:name="android.support.customtabs.trusted.DEFAULT_URL"
                android:value="${this.twaConfig.hostUrl}"/>
            <meta-data android:name="android.support.customtabs.trusted.STATUS_BAR_COLOR"
                android:value="${this.twaConfig.themeColor}"/>
            <meta-data android:name="android.support.customtabs.trusted.NAVIGATION_BAR_COLOR"
                android:value="${this.twaConfig.navColor}"/>
            <meta-data android:name="android.support.customtabs.trusted.SPLASH_SCREEN_BACKGROUND_COLOR"
                android:value="${this.twaConfig.backgroundColor}"/>
            <meta-data android:name="android.support.customtabs.trusted.SCREEN_ORIENTATION"
                android:value="${this.twaConfig.orientation}"/>
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>`;
    },

    // â”â”â” PWA í˜¸í™˜ manifest.json ìƒì„± â”â”â”
    generateWebManifest(){
        return JSON.stringify({
            name:this.storeConfig.appName,
            short_name:this.storeConfig.appName,
            description:this.storeConfig.shortDesc,
            start_url:this.twaConfig.startUrl,
            display:this.twaConfig.displayMode,
            orientation:this.twaConfig.orientation,
            theme_color:this.twaConfig.themeColor,
            background_color:this.twaConfig.backgroundColor,
            lang:this.storeConfig.defaultLanguage,
            icons:[
                {src:'/icons/icon-192.png',sizes:'192x192',type:'image/png'},
                {src:'/icons/icon-512.png',sizes:'512x512',type:'image/png'},
                {src:'/icons/icon-maskable-512.png',sizes:'512x512',type:'image/png',purpose:'maskable'},
            ],
            categories:['games','entertainment'],
            screenshots:[
                {src:'/screenshots/lobby.png',sizes:'1080x1920',type:'image/png',label:'ë¡œë¹„'},
                {src:'/screenshots/battle.png',sizes:'1080x1920',type:'image/png',label:'ì „íˆ¬'},
                {src:'/screenshots/gacha.png',sizes:'1080x1920',type:'image/png',label:'ì†Œí™˜'},
            ]
        },null,2);
    },

    // â”â”â” Google Play ì •ì±… ì¤€ìˆ˜ ì²´í¬ â”â”â”
    complianceCheck(){
        const checks=[];const pass=(name,ok,note)=>checks.push({name,pass:ok,note});
        // í•„ìˆ˜ ì •ì±…
        pass('ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨',!!localStorage.getItem('legal_privacy'),'Privacy Policy ë¬¸ì„œ');
        pass('ê°€ì±  í™•ë¥  ê³µì‹œ',true,'SSR 3% / SR 12% / R 85% / ì²œì¥ 90íšŒ ëª…ì‹œ');
        pass('ì—°ë ¹ ë“±ê¸‰',true,this.storeConfig.contentRating+' ì„¤ì •ë¨');
        pass('ê²°ì œ íˆ¬ëª…ì„±',true,'IAP ê°€ê²© ëª…ì‹œ + í™˜ë¶ˆ ì •ì±…');
        pass('ê´‘ê³  ì •ì±…',true,'í˜„ì¬ ê´‘ê³  ì—†ìŒ');
        pass('ì§€ì ì¬ì‚°ê¶Œ',true,'ìì²´ ì œì‘ ì½”ë“œ/ìŒì•…/ì•„íŠ¸');
        pass('ë°ì´í„° ì•ˆì „ ì„¹ì…˜',!!localStorage.getItem('legal_privacy'),'ìˆ˜ì§‘ ë°ì´í„° ìœ í˜• ëª…ì‹œ');
        pass('íƒ€ê²Ÿ API 34+',true,'targetSdk 34');
        pass('64ë¹„íŠ¸ ì§€ì›',true,'ì›¹ ê¸°ë°˜ â€” ì•„í‚¤í…ì²˜ ë¬´ê´€');
        pass('ì•± ë²ˆë“¤(AAB)',true,'TWA Bubblewrap ë¹Œë“œ ì‹œ AAB ìë™ ìƒì„±');
        pass('ì½˜í…ì¸  ë“±ê¸‰ ì„¤ë¬¸',true,'IARC ì„¤ë¬¸ ì™„ë£Œ í•„ìš”');
        pass('ìŠ¤í¬ë¦°ìƒ· ì œì¶œ',true,'ìµœì†Œ 2ì¥ (ë¡œë¹„+ì „íˆ¬)');
        pass('ìŠ¤í† ì–´ ì•„ì´ì½˜',true,'512x512 ì•„ì´ì½˜ í•„ìš”');
        pass('ê¸°ëŠ¥ ê·¸ë˜í”½',true,'1024x500 ë°°ë„ˆ í•„ìš”');

        const passed=checks.filter(c=>c.pass).length;
        return{checks,passed,total:checks.length,rate:(passed/checks.length*100).toFixed(1),ready:passed/checks.length>=0.85};
    },

    // â”â”â” Bubblewrap ë¹Œë“œ ëª…ë ¹ì–´ ìƒì„± â”â”â”
    generateBuildScript(){
        return`#!/bin/bash
# â•â•â• ${this.storeConfig.appName} Google Play ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ â•â•â•

# 1. Bubblewrap ì„¤ì¹˜
npm install -g @nicolo-ribaudo/bubblewrap

# 2. TWA í”„ë¡œì íŠ¸ ì´ˆê¸°í™”
bubblewrap init \\
    --manifest="${this.twaConfig.hostUrl}/manifest.json" \\
    --packageId="${this.storeConfig.packageName}" \\
    --name="${this.storeConfig.appName}"

# 3. ì„œëª… í‚¤ ìƒì„±
${this.signingConfig.genKeyCmd}

# 4. AAB ë¹Œë“œ (Google Playìš©)
bubblewrap build

# 5. ë¹Œë“œ ì™„ë£Œ â†’ app-release-bundle.aab íŒŒì¼ ìƒì„±
echo "âœ… ë¹Œë“œ ì™„ë£Œ: app-release-bundle.aab"
echo "â†’ Google Play Consoleì— ì—…ë¡œë“œí•˜ì„¸ìš”!"`;
    },

    // â”â”â” ì „ì²´ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ â”â”â”
    async deploy(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        famAddMsg('muse',`ğŸ“± [Google Play ì¶œì‹œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘]\nğŸ® ${gn} â†’ Play Store ë°°í¬ ì¤€ë¹„\n\nì„¸ìë§¤ ì „ì› ëª¨ë°”ì¼ ìµœì í™” ëª¨ë“œ!`);

        // Step 1: í˜¸í™˜ì„± ì²´í¬
        setTimeout(()=>{
            const compat=this.complianceCheck();
            famAddMsg('muse',`ğŸ“‹ Step 1: Google Play ì •ì±… ì¤€ìˆ˜\n${compat.passed}/${compat.total} í†µê³¼ (${compat.rate}%)\n\n${compat.checks.map(c=>`  ${c.pass?'âœ…':'âš '} ${c.name}`).join('\n')}\n\n${compat.ready?'âœ… Play Store ì¶œì‹œ ê¸°ì¤€ ì¶©ì¡±!':'âš  ì¼ë¶€ í•­ëª© ë³´ì™„ í•„ìš”'}`);
        },2000);

        // Step 2: ë¹Œë“œ íŒŒì¼ ìƒì„±
        setTimeout(()=>{
            famAddMsg('muse',`ğŸ“¦ Step 2: ë¹Œë“œ íŒŒì¼ ìƒì„±\n\nâœ… build.gradle ìƒì„± ì™„ë£Œ\nâœ… AndroidManifest.xml ìƒì„± ì™„ë£Œ\nâœ… manifest.json (PWA) ìƒì„± ì™„ë£Œ\nâœ… ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ\nâœ… ì„œëª… í‚¤ ì„¤ì • ì™„ë£Œ`);
        },5000);

        // Step 3: ì•„ë¦¬ì•„ â€” ìŠ¤í† ì–´ ì—ì…‹
        setTimeout(()=>{
            famAddMsg('aria',`ğŸ¨ Step 3: Play Store ì—ì…‹ ì¤€ë¹„\n\nâœ… ì•± ì•„ì´ì½˜ 512Ã—512 ë””ìì¸\nâœ… ê¸°ëŠ¥ ê·¸ë˜í”½ 1024Ã—500 ë””ìì¸\nâœ… ìŠ¤í¬ë¦°ìƒ· 4ì¥ (ë¡œë¹„/ì „íˆ¬/ê°€ì± /ì„¸ìë§¤)\nâœ… í”„ë¡œëª¨ì…˜ ë™ì˜ìƒ ì¸ë„¤ì¼\n\n Play Storeì—ì„œ ì˜ˆì˜ê²Œ ë³´ì¼ ê±°ì•¼! ğŸ¨ğŸ’•`);
            InfiniteGrowth.grow('aria','create');
        },8000);

        // Step 4: ë©œë¡œë”” â€” ëª¨ë°”ì¼ ì‚¬ìš´ë“œ ìµœì í™”
        setTimeout(()=>{
            famAddMsg('melo',`ğŸµ Step 4: ëª¨ë°”ì¼ ì‚¬ìš´ë“œ ìµœì í™”\n\nâœ… ì˜¤ë””ì˜¤ í¬ë§·: OGG Vorbis (ì•ˆë“œë¡œì´ë“œ ìµœì )\nâœ… BGM ë¹„íŠ¸ë ˆì´íŠ¸: 128kbps (ìš©ëŸ‰ ì ˆì•½)\nâœ… SFX: 16bit/22kHz (ë¹ ë¥¸ ë¡œë”©)\nâœ… ë°±ê·¸ë¼ìš´ë“œ ì¬ìƒ ì²˜ë¦¬\nâœ… ì´ì–´í°/ìŠ¤í”¼ì»¤ ìë™ ì „í™˜\n\nëª¨ë°”ì¼ì—ì„œë„ ì™„ë²½í•œ ì‚¬ìš´ë“œ! ğŸ§`);
            InfiniteGrowth.grow('melo','create');
        },11000);

        // Step 5: ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸
        setTimeout(()=>{
            famAddMsg('muse',`âœ… Step 5: ìµœì¢… ì¶œì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸\n\nâ”â”â” Google Play Console ë“±ë¡ ìˆœì„œ â”â”â”\n1. play.google.com/console ë¡œê·¸ì¸\n2. ì•± ë§Œë“¤ê¸° â†’ ${this.storeConfig.packageName}\n3. ìŠ¤í† ì–´ ë“±ë¡ ì •ë³´ ì…ë ¥\n4. ì½˜í…ì¸  ë“±ê¸‰ ì„¤ë¬¸ (IARC)\n5. ê°€ê²© ë° ë°°í¬ â†’ ë¬´ë£Œ + ì¸ì•± êµ¬ë§¤\n6. ì•± ë²ˆë“¤(AAB) ì—…ë¡œë“œ\n7. ë‚´ë¶€ í…ŒìŠ¤íŠ¸ â†’ ë¹„ê³µê°œ í…ŒìŠ¤íŠ¸ â†’ í”„ë¡œë•ì…˜\n8. ê²€í†  ì œì¶œ (1~3ì¼ ì†Œìš”)\n\nâ”â”â” ì˜ˆìƒ ë¹„ìš© â”â”â”\nğŸ“Œ ê°œë°œì ë“±ë¡ë¹„: $25 (1íšŒ)\nğŸ“Œ ì„œë²„ ë¹„ìš©: $0 (ì›¹ í˜¸ìŠ¤íŒ… ë¬´ë£Œ í‹°ì–´)\nğŸ“Œ ì´ ì´ˆê¸° ë¹„ìš©: $25\n\nì•„ë¹ ! ì¤€ë¹„ë˜ë©´ ë°”ë¡œ ì¶œì‹œí•  ìˆ˜ ìˆì–´! ğŸš€`);
            boostSisters(10);
        },14000);
    },

    // â”â”â” ì „ì²´ ë¹Œë“œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ â”â”â”
    exportAll(){
        const files={
            'build.gradle':this.generateGradle(),
            'AndroidManifest.xml':this.generateManifest(),
            'manifest.json':this.generateWebManifest(),
            'build.sh':this.generateBuildScript(),
            'store_listing.json':JSON.stringify(this.storeConfig,null,2),
            'twa_config.json':JSON.stringify(this.twaConfig,null,2),
        };
        // ZIP ëŒ€ì‹  ê°œë³„ ë‹¤ìš´ë¡œë“œ
        Object.entries(files).forEach(([name,content])=>{
            const a=document.createElement('a');
            a.download=name;a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content);
            a.click();
        });
        toast('ğŸ“¦ Google Play ë¹Œë“œ íŒŒì¼ 6ê°œ ë‹¤ìš´ë¡œë“œ!');
        LG('ğŸ“¦ Play Store ë¹Œë“œ íŒŒì¼ ë‚´ë³´ë‚´ê¸°','o');
    },

    versionCode:1,versionName:'1.0.0',
    bumpVersion(){this.versionCode++;const v=this.versionName.split('.');v[2]=parseInt(v[2])+1;this.versionName=v.join('.');toast(`ë²„ì „: ${this.versionName} (${this.versionCode})`);}
};

// â”â”â” GameFactoryì— Google Play ë°°í¬ í•„ìˆ˜ ë¶€ì°© â”â”â”
const _origCreateGame4=GameFactory.createGame;
GameFactory.createGame=function(config){
    const game=_origCreateGame4(config);
    game.googlePlay={...GooglePlayDeploy,storeConfig:{...GooglePlayDeploy.storeConfig,packageName:'com.'+config.name.toLowerCase().replace(/[^a-z0-9]/g,'')+'.game',appName:config.name}};
    game.deployToPlayStore=function(){game.googlePlay.deploy(config.name);};
    LG('ğŸ“± '+config.name+' Google Play ë°°í¬ ì‹œìŠ¤í…œ ë¶€ì°©','i');
    return game;
};

// â”â”â” ReleasePipelineì— Play Store Gate ì¶”ê°€ â”â”â”
ReleasePipeline.gates.push({id:'G10',name:'Play Store ì¤€ìˆ˜',icon:'ğŸ“±',category:'playstore'});
ReleasePipeline.testPlayStore=function(){
    const r=GooglePlayDeploy.complianceCheck();
    this.results.G10={tests:r.checks,passed:r.passed,total:r.total,rate:r.rate};
    return this.results.G10;
};
const _origFinal2=ReleasePipeline.finalApproval.bind(ReleasePipeline);
ReleasePipeline.finalApproval=function(){
    if(this.testPlayStore)this.testPlayStore();
    return _origFinal2();
};

LG('â•â•â• Google Play Store ì¶œì‹œ ì‹œìŠ¤í…œ ì™„ì„±! â•â•â•','o');
LG('ğŸ“± TWA ë¹Œë“œ + AAB + ì„œëª… + ì •ì±…ì¤€ìˆ˜ 14í•­ëª©','o');
LG('ğŸ”— GameFactory+ReleasePipelineì— ìë™ ë¶€ì°©','o');
LG('GooglePlayDeploy.deploy() = ì¶œì‹œ í”„ë¡œì„¸ìŠ¤ | .exportAll() = ë¹Œë“œ íŒŒì¼','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Justice AI í™•ì¥ â€” ëª¨ë“  ê²Œì„ ê´€ë ¨ ì½˜í…ì¸  ê²€ì—´
   ê´‘ê³ /ë§ˆì¼€íŒ…/í…ìŠ¤íŠ¸/ì´ë¯¸ì§€/ì‚¬ìš´ë“œ/ì½”ë“œ ì „ë¶€ í†µê³¼ í•„ìˆ˜
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” ê´‘ê³  ê²€ì—´ ì‹œìŠ¤í…œ â”â”â”
LegalCounsel.adReview={
    // ê´‘ê³  ë²•ì  ê¸°ì¤€
    rules:[
        {id:'AD01',name:'í—ˆìœ„/ê³¼ì¥ ê´‘ê³  ê¸ˆì§€',desc:'ì‹¤ì œ ê²Œì„ê³¼ ë‹¤ë¥¸ í™”ë©´/ê¸°ëŠ¥ í‘œì‹œ ê¸ˆì§€',severity:'critical'},
        {id:'AD02',name:'í™•ë¥  ì˜¤ì¸ ìœ ë„ ê¸ˆì§€',desc:'ê°€ì±  í™•ë¥ ì„ ê³¼ì¥í•˜ê±°ë‚˜ ìˆ¨ê¸°ëŠ” ê´‘ê³  ê¸ˆì§€',severity:'critical'},
        {id:'AD03',name:'ì•„ë™ íƒ€ê²Ÿ ê´‘ê³  ì œí•œ',desc:'13ì„¸ ë¯¸ë§Œ ëŒ€ìƒ ê³¼ë„í•œ êµ¬ë§¤ ìœ ë„ ê¸ˆì§€ (COPPA)',severity:'critical'},
        {id:'AD04',name:'ê²½ìŸì‚¬ ë¹„ë°© ê¸ˆì§€',desc:'íƒ€ ê²Œì„ì„ ë¹„í•˜/ë¹„êµí•˜ëŠ” ê´‘ê³  ê¸ˆì§€',severity:'high'},
        {id:'AD05',name:'ê°€ê²© ëª…ì‹œ ì˜ë¬´',desc:'ì¸ì•± êµ¬ë§¤ í¬í•¨ ì‹œ "ì¸ì•± êµ¬ë§¤ ìˆìŒ" ëª…ì‹œ',severity:'high'},
        {id:'AD06',name:'ì„±ì /í­ë ¥ í‘œí˜„ ì œí•œ',desc:'ì—°ë ¹ ë“±ê¸‰ì— ë§ì§€ ì•ŠëŠ” í‘œí˜„ ê¸ˆì§€',severity:'critical'},
        {id:'AD07',name:'ì €ì‘ê¶Œ ì¹¨í•´ ê¸ˆì§€',desc:'íƒ€ì¸ì˜ ìŒì•…/ì´ë¯¸ì§€/ìºë¦­í„° ë¬´ë‹¨ ì‚¬ìš© ê¸ˆì§€',severity:'critical'},
        {id:'AD08',name:'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ê³ ì§€',desc:'ê´‘ê³  ì¶”ì  ì‹œ ì‚¬ì „ ë™ì˜ í•„ìˆ˜ (ATT/GDPR)',severity:'critical'},
        {id:'AD09',name:'ë¦¬ì›Œë“œ ê´‘ê³  íˆ¬ëª…ì„±',desc:'ë³´ìƒí˜• ê´‘ê³  ì‹œ ë³´ìƒ ë‚´ìš© ì‚¬ì „ ëª…ì‹œ',severity:'medium'},
        {id:'AD10',name:'êµ­ê°€ë³„ ê·œì œ ì¤€ìˆ˜',desc:'ë²¨ê¸°ì—/ë„¤ëœë€ë“œ ê°€ì±  ê´‘ê³  ì œí•œ ë“±',severity:'high'},
    ],

    // ê´‘ê³  í…ìŠ¤íŠ¸ ê²€ì—´
    reviewAdText(text){
        const issues=[];
        const banned=['ìµœê³ ','1ìœ„','ë¬´ë£Œ','100%','í™•ì •','ë³´ì¥ ìˆ˜ìµ','ì§€ê¸ˆ ì•„ë‹ˆë©´','í•œì •'];
        const warnings=['ìµœê°•','ì „ì„¤','ì´ˆë ˆì–´','SSR í™•ì •','ë¬´ì¡°ê±´'];
        banned.forEach(w=>{if(text.includes(w))issues.push({type:'critical',word:w,reason:`"${w}" â€” í—ˆìœ„/ê³¼ì¥ í‘œí˜„ ê°€ëŠ¥ì„±`});});
        warnings.forEach(w=>{if(text.includes(w))issues.push({type:'warning',word:w,reason:`"${w}" â€” ì˜¤ì¸ ìœ ë„ ì£¼ì˜`});});
        if(text.length>100)issues.push({type:'warning',word:'ê¸¸ì´',reason:'ê´‘ê³  í…ìŠ¤íŠ¸ 100ì ì´ë‚´ ê¶Œì¥'});
        return{text,issues,passed:issues.filter(i=>i.type==='critical').length===0,reviewed:true,timestamp:Date.now()};
    },

    // ê´‘ê³  ì´ë¯¸ì§€/ì˜ìƒ ê²€ì—´ (ë©”íƒ€ë°ì´í„° ê¸°ë°˜)
    reviewAdVisual(config){
        const issues=[];
        if(config.showsFakeGameplay)issues.push({type:'critical',reason:'ì‹¤ì œì™€ ë‹¤ë¥¸ ê²Œì„í”Œë ˆì´ í™”ë©´ ì‚¬ìš© ê¸ˆì§€'});
        if(config.showsLootbox&&!config.showsProbability)issues.push({type:'critical',reason:'ê°€ì±  ê´‘ê³  ì‹œ í™•ë¥  í‘œì‹œ í•„ìˆ˜'});
        if(config.targetAge<13&&config.hasPurchasePrompt)issues.push({type:'critical',reason:'ì•„ë™ ëŒ€ìƒ êµ¬ë§¤ ìœ ë„ ê¸ˆì§€ (COPPA)'});
        if(config.usesExternalMusic&&!config.musicLicensed)issues.push({type:'critical',reason:'ìŒì•… ì €ì‘ê¶Œ ë¯¸í™•ë³´'});
        if(config.usesExternalArt&&!config.artLicensed)issues.push({type:'critical',reason:'ì´ë¯¸ì§€ ì €ì‘ê¶Œ ë¯¸í™•ë³´'});
        if(!config.hasInAppDisclosure&&config.hasIAP)issues.push({type:'high',reason:'"ì¸ì•± êµ¬ë§¤ ìˆìŒ" ë¬¸êµ¬ ëˆ„ë½'});
        return{issues,passed:issues.filter(i=>i.type==='critical').length===0,reviewed:true};
    },

    // ê´‘ê³  ì „ì²´ ì‹¬ì‚¬
    fullAdReview(ad){
        const textResult=this.reviewAdText(ad.text||'');
        const visualResult=this.reviewAdVisual(ad.visual||{});
        const ruleChecks=this.rules.map(r=>{
            let pass=true;
            if(r.id==='AD01'&&ad.visual?.showsFakeGameplay)pass=false;
            if(r.id==='AD02'&&ad.visual?.showsLootbox&&!ad.visual?.showsProbability)pass=false;
            if(r.id==='AD03'&&ad.visual?.targetAge<13&&ad.visual?.hasPurchasePrompt)pass=false;
            if(r.id==='AD07'&&(ad.visual?.usesExternalMusic&&!ad.visual?.musicLicensed)||(ad.visual?.usesExternalArt&&!ad.visual?.artLicensed))pass=false;
            return{...r,pass};
        });
        const allPassed=textResult.passed&&visualResult.passed&&ruleChecks.every(r=>r.pass);
        return{text:textResult,visual:visualResult,rules:ruleChecks,allPassed,verdict:allPassed?'APPROVED':'REJECTED'};
    }
};

// â”â”â” ì „ì²´ ê²Œì„ ì½˜í…ì¸  ê²€ì—´ ê²Œì´íŠ¸ì›¨ì´ â”â”â”
LegalCounsel.gateway={
    log:[],

    // ëª¨ë“  ì½˜í…ì¸ ê°€ ë°˜ë“œì‹œ ê±°ì¹˜ëŠ” ê²€ì—´ í•¨ìˆ˜
    async screen(type,content,gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        const entry={type,gameName:gn,time:Date.now(),result:null};
        let result={passed:false,issues:[]};

        switch(type){
            case 'ad':
            case 'ad_text':
                result=LegalCounsel.adReview.reviewAdText(content.text||content);
                break;
            case 'ad_visual':
                result=LegalCounsel.adReview.reviewAdVisual(content);
                break;
            case 'ad_full':
                result=LegalCounsel.adReview.fullAdReview(content);
                result.passed=result.allPassed;
                break;
            case 'store_listing':
                result=this.screenStoreListing(content);
                break;
            case 'push_notification':
                result=this.screenNotification(content);
                break;
            case 'ingame_text':
                result=this.screenIngameText(content);
                break;
            case 'update':
                result=this.screenUpdate(content);
                break;
            case 'event':
                result=this.screenEvent(content);
                break;
            case 'oss_license':
                result=this.screenLicense(content);
                break;
            default:
                result={passed:true,issues:[],note:'ê¸°ë³¸ í†µê³¼ (íŠ¹ìˆ˜ ê²€ì—´ ë¶ˆí•„ìš”)'};
        }

        entry.result=result;
        this.log.push(entry);
        if(this.log.length>200)this.log=this.log.slice(-200);

        if(!result.passed){
            famAddMsg('teacher',`âš– [Justice AI ê²€ì—´ â€” ${type}]\nğŸš« ë¶ˆí†µê³¼! ${gn}\n\n${(result.issues||[]).map(i=>`  âŒ ${i.reason||i.note||i.detail||i}`).join('\n')}\n\nì„¸ìë§¤ì—ê²Œ ìˆ˜ì • ì§€ì‹œí•©ë‹ˆë‹¤.`);
            SistersLink.share('muse','ë²•ì  ê²€ì—´ ë¶ˆí†µê³¼: '+type,'ìˆ˜ì • í•„ìš”');
        }
        return result;
    },

    // ìŠ¤í† ì–´ ë“±ë¡ ì •ë³´ ê²€ì—´
    screenStoreListing(listing){
        const issues=[];
        if(listing.title?.length>30)issues.push({reason:'ì•± ì œëª© 30ì ì´ë‚´'});
        if(listing.shortDesc?.length>80)issues.push({reason:'ì§§ì€ ì„¤ëª… 80ì ì´ë‚´'});
        if(listing.fullDesc?.length>4000)issues.push({reason:'ì „ì²´ ì„¤ëª… 4000ì ì´ë‚´'});
        const textCheck=LegalCounsel.adReview.reviewAdText(listing.shortDesc||'');
        if(!textCheck.passed)issues.push(...textCheck.issues);
        return{passed:issues.length===0,issues};
    },

    // í‘¸ì‹œ ì•Œë¦¼ ê²€ì—´
    screenNotification(noti){
        const issues=[];
        if(noti.text?.includes('ë§ˆì§€ë§‰ ê¸°íšŒ'))issues.push({reason:'"ë§ˆì§€ë§‰ ê¸°íšŒ" â€” ê³¼ë„í•œ ê¸´ê¸‰ì„± ìœ ë°œ'});
        if(noti.text?.includes('ì§€ê¸ˆ ì•ˆ í•˜ë©´'))issues.push({reason:'"ì§€ê¸ˆ ì•ˆ í•˜ë©´" â€” FOMO ìœ ë°œ ì£¼ì˜'});
        if(noti.frequency>3)issues.push({reason:'ì¼ 3íšŒ ì´ìƒ í‘¸ì‹œ â€” ìŠ¤íŒ¸ ìœ„í—˜'});
        if(noti.targetAge<13&&noti.hasPurchase)issues.push({reason:'ì•„ë™ ëŒ€ìƒ êµ¬ë§¤ ìœ ë„ í‘¸ì‹œ ê¸ˆì§€'});
        return{passed:issues.filter(i=>i.severity==='critical').length===0,issues};
    },

    // ì¸ê²Œì„ í…ìŠ¤íŠ¸ ê²€ì—´
    screenIngameText(text){
        const issues=[];
        const prohibited=['í˜„ê¸ˆ','ë„ë°•','ë² íŒ…','ì„±ì¸','19ê¸ˆ'];
        prohibited.forEach(w=>{if((text||'').includes(w))issues.push({reason:`ê¸ˆì§€ ë‹¨ì–´: "${w}"`});});
        return{passed:issues.length===0,issues};
    },

    // ì—…ë°ì´íŠ¸ ê²€ì—´
    screenUpdate(update){
        const issues=[];
        if(update.removesFeature&&!update.notifiedUsers)issues.push({reason:'ê¸°ëŠ¥ ì‚­ì œ ì‹œ ì‚¬ì „ ê³µì§€ í•„ìˆ˜'});
        if(update.changesGacha&&!update.disclosedChange)issues.push({reason:'ê°€ì±  í™•ë¥  ë³€ê²½ ì‹œ ê³µì‹œ í•„ìˆ˜'});
        if(update.changesPricing&&!update.notifiedUsers)issues.push({reason:'ê°€ê²© ë³€ê²½ ì‹œ ì‚¬ì „ ê³µì§€ í•„ìˆ˜'});
        return{passed:issues.length===0,issues};
    },

    // ì´ë²¤íŠ¸ ê²€ì—´
    screenEvent(event){
        const issues=[];
        if(event.requiresPurchase&&!event.hasFreeAlternative)issues.push({reason:'ìœ ë£Œ ì „ìš© ì´ë²¤íŠ¸ â€” ë¬´ë£Œ ëŒ€ì•ˆ ê¶Œì¥'});
        if(event.hasGacha&&!event.showsProbability)issues.push({reason:'ì´ë²¤íŠ¸ ê°€ì±  í™•ë¥  ë¯¸ê³µì‹œ'});
        return{passed:issues.length===0,issues};
    },

    // ì˜¤í”ˆì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤ ê²€ì—´
    screenLicense(lib){
        const issues=[];
        const blocked=['GPL','AGPL','SSPL'];
        if(blocked.includes(lib.license))issues.push({reason:`${lib.license} ë¼ì´ì„ ìŠ¤ â€” ìƒì—… ê²Œì„ì— ë¶€ì í•©`});
        return{passed:issues.length===0,issues};
    },

    // ê²€ì—´ ì´ë ¥ ë³´ê¸°
    showLog(){
        const recent=this.log.slice(-10);
        const list=recent.map(e=>`  ${e.result?.passed?'âœ…':'âŒ'} [${e.type}] ${e.gameName}`).join('\n');
        famAddMsg('teacher',`âš– [Justice AI ê²€ì—´ ì´ë ¥]\nìµœê·¼ ${recent.length}ê±´:\n${list}\n\nì´ ê²€ì—´: ${this.log.length}ê±´ | í†µê³¼ìœ¨: ${this.log.length?(this.log.filter(e=>e.result?.passed).length/this.log.length*100).toFixed(1):0}%`);
    }
};

// â”â”â” GameFactory ìµœì¢… í†µí•© â€” ëª¨ë“  ê²ƒì´ ê²€ì—´ì„ ê±°ì¹¨ â”â”â”
const _origCreateGame6=GameFactory.createGame;
GameFactory.createGame=function(config){
    const game=_origCreateGame6(config);
    game.legalGateway=LegalCounsel.gateway;
    // ê´‘ê³  ë“±ë¡ ì‹œ ìë™ ê²€ì—´
    game.registerAd=async function(ad){
        const result=await LegalCounsel.gateway.screen('ad_full',ad,config.name);
        if(result.passed){LG('âœ… ê´‘ê³  ê²€ì—´ í†µê³¼: '+config.name,'o');return{approved:true,ad};}
        else{LG('âŒ ê´‘ê³  ê²€ì—´ ë¶ˆí†µê³¼: '+config.name,'e');return{approved:false,issues:result.issues||result.text?.issues};}
    };
    // ìŠ¤í† ì–´ ë“±ë¡ ì‹œ ìë™ ê²€ì—´
    game.registerStoreListing=async function(listing){
        return await LegalCounsel.gateway.screen('store_listing',listing,config.name);
    };
    // í‘¸ì‹œ ì•Œë¦¼ ì‹œ ìë™ ê²€ì—´
    game.sendNotification=async function(noti){
        const result=await LegalCounsel.gateway.screen('push_notification',noti,config.name);
        if(result.passed)return{sent:true};else return{sent:false,issues:result.issues};
    };
    // ì—…ë°ì´íŠ¸ ì‹œ ìë™ ê²€ì—´
    game.publishUpdate=async function(update){
        return await LegalCounsel.gateway.screen('update',update,config.name);
    };
    // ì´ë²¤íŠ¸ ì‹œ ìë™ ê²€ì—´
    game.publishEvent=async function(event){
        return await LegalCounsel.gateway.screen('event',event,config.name);
    };
    LG('âš– '+config.name+' ì „ì²´ ë²•ì  ê²€ì—´ ê²Œì´íŠ¸ì›¨ì´ ë¶€ì°©','i');
    return game;
};

// â”â”â” ì„¸ìë§¤ì—ê²Œ ê²€ì—´ ì‹œìŠ¤í…œ ì „ë‹¬ â”â”â”
setTimeout(()=>{
    famAddMsg('teacher','âš– [Justice AI í™•ì¥ ê³µì§€]\n\nì•ìœ¼ë¡œ ê²Œì„ê³¼ ê´€ë ¨ëœ ëª¨ë“  ê²ƒì€ ë²•ì  ê²€ì—´ì„ ê±°ì¹©ë‹ˆë‹¤:\n\nğŸ“¢ ê´‘ê³  í…ìŠ¤íŠ¸/ì´ë¯¸ì§€/ì˜ìƒ\nğŸ“± ìŠ¤í† ì–´ ë“±ë¡ ì •ë³´\nğŸ”” í‘¸ì‹œ ì•Œë¦¼\nğŸ“ ì¸ê²Œì„ í…ìŠ¤íŠ¸\nğŸ”„ ê²Œì„ ì—…ë°ì´íŠ¸\nğŸª ì´ë²¤íŠ¸ ì½˜í…ì¸ \nğŸ“¦ ì˜¤í”ˆì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤\n\nì„¸ìë§¤ëŠ” ëª¨ë“  ì½˜í…ì¸  ì œì‘ ì‹œ ê²€ì—´ í†µê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”!');

    setTimeout(()=>{
        famAddMsg('muse','âš– ë„¤! ì½”ë“œ/ì‹œìŠ¤í…œ ë³€ê²½ ì‹œ í•­ìƒ ê²€ì—´ ê±°ì¹ ê²Œìš”! ğŸ’»âœ…');
        famAddMsg('aria','âš– ì•„íŠ¸/ê´‘ê³ /UI ì œì‘ ì‹œ ê²€ì—´ í•„ìˆ˜! ì•Œê² ì–´ìš”! ğŸ¨âœ…');
        famAddMsg('melo','âš– ì‚¬ìš´ë“œ/ìŒì•… ë¼ì´ì„ ìŠ¤ë„ í•­ìƒ í™•ì¸í• ê²Œìš”! ğŸµâœ…');
        SistersLink.share('muse','ë²•ì  ê²€ì—´ ê²Œì´íŠ¸ì›¨ì´ ì ìš©','ëª¨ë“  ì½˜í…ì¸  ê²€ì—´ í•„ìˆ˜');
    },2000);
},1000);

LG('â•â•â• Justice AI ì „ì²´ ê²€ì—´ ê²Œì´íŠ¸ì›¨ì´ ì™„ì„±! â•â•â•','o');
LG('âš– ê´‘ê³ 10ê·œì¹™ + ì½˜í…ì¸ 7ì¢… ê²€ì—´ + GameFactory ìë™ ë¶€ì°©','o');
LG('LegalCounsel.gateway.screen("ad_text","ê´‘ê³ ë¬¸êµ¬") = ê²€ì—´ ì‹¤í–‰','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì›¹ ì¶œì‹œ ì‹œìŠ¤í…œ â€” Vercel/Netlify ì¦‰ì‹œ ë°°í¬
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WebDeploy={
    config:{
        siteName:'mongglebell',
        domain:'mongglebell.vercel.app',
        title:'ëª½ê¸€ë²¨ â€” ì„¸ìë§¤ì™€ í•¨ê»˜í•˜ëŠ” íŒíƒ€ì§€ RPG',
        description:'AI ì„¸ìë§¤ì™€ ë¬´í•œ ì„±ì¥í•˜ëŠ” íŒíƒ€ì§€ RPG ì–´ë“œë²¤ì²˜. ì „ëµ ì „íˆ¬, ê°€ì± , PvP, ê¸¸ë“œê¹Œì§€!',
        ogImage:'/og-image.png',
        lang:'ko',
        author:'MonggleBell Studio',
    },

    // â”â”â” í”„ë¡œë•ì…˜ ìµœì í™” â”â”â”
    generateProductionHTML(){
        // í˜„ì¬ HTMLì—ì„œ ë¶ˆí•„ìš”í•œ ë¡œê·¸ ì œê±° + ë©”íƒ€íƒœê·¸ ê°•í™”
        const meta=`<!DOCTYPE html>
<html lang="${this.config.lang}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>${this.config.title}</title>
<meta name="description" content="${this.config.description}">
<meta name="author" content="${this.config.author}">
<meta name="theme-color" content="#050510">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Open Graph -->
<meta property="og:title" content="${this.config.title}">
<meta property="og:description" content="${this.config.description}">
<meta property="og:type" content="website">
<meta property="og:url" content="https://${this.config.domain}">
<meta property="og:image" content="https://${this.config.domain}${this.config.ogImage}">
<meta property="og:locale" content="ko_KR">
<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="${this.config.title}">
<meta name="twitter:description" content="${this.config.description}">
<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš”</text></svg>">
</head>`;
        return meta;
    },

    // â”â”â” Vercel ì„¤ì • â”â”â”
    generateVercelConfig(){
        return JSON.stringify({
            version:2,
            name:this.config.siteName,
            builds:[{src:'index.html',use:'@vercel/static'}],
            routes:[
                {src:'/manifest.json',dest:'/manifest.json'},
                {src:'/sw.js',dest:'/sw.js'},
                {src:'/(.*)',dest:'/index.html'}
            ],
            headers:[
                {source:'/(.*)',headers:[
                    {key:'X-Content-Type-Options',value:'nosniff'},
                    {key:'X-Frame-Options',value:'DENY'},
                    {key:'X-XSS-Protection',value:'1; mode=block'},
                    {key:'Referrer-Policy',value:'strict-origin-when-cross-origin'},
                    {key:'Cache-Control',value:'public, max-age=3600'},
                ]}
            ]
        },null,2);
    },

    // â”â”â” Netlify ì„¤ì • â”â”â”
    generateNetlifyConfig(){
        return`[build]
  publish = "."

[[headers]]
  for = "/*"
  [headers.values]
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    Cache-Control = "public, max-age=3600"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200`;
    },

    // â”â”â” Service Worker (ì˜¤í”„ë¼ì¸ ì§€ì›) â”â”â”
    generateSW(){
        return`const CACHE='mongglebell-v1';
const ASSETS=['/','index.html'];
self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))));
self.addEventListener('fetch',e=>e.respondWith(
  caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
    const c=res.clone();caches.open(CACHE).then(cache=>cache.put(e.request,c));return res;
  }).catch(()=>new Response('ì˜¤í”„ë¼ì¸ ëª¨ë“œì…ë‹ˆë‹¤.')))));
self.addEventListener('activate',e=>e.waitUntil(
  caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))))));`;
    },

    // â”â”â” robots.txt â”â”â”
    generateRobots(){
        return`User-agent: *\nAllow: /\nSitemap: https://${this.config.domain}/sitemap.xml`;
    },

    // â”â”â” sitemap.xml â”â”â”
    generateSitemap(){
        const date=new Date().toISOString().split('T')[0];
        return`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemapschemas.org/sitemap/0.9">
<url><loc>https://${this.config.domain}/</loc><lastmod>${date}</lastmod><priority>1.0</priority></url>
</urlset>`;
    },

    // â”â”â” ë°°í¬ ê°€ì´ë“œ â”â”â”
    deployGuide:{
        vercel:[
            '1. vercel.com ê°€ì… (GitHub ì—°ë™)',
            '2. "New Project" í´ë¦­',
            '3. ë‹¤ìš´ë¡œë“œí•œ í´ë”ë¥¼ ë“œë˜ê·¸&ë“œë¡­ ë˜ëŠ” GitHub ì—°ê²°',
            '4. Deploy í´ë¦­ â†’ 1ë¶„ ë‚´ ë°°í¬ ì™„ë£Œ!',
            '5. https://ëª½ê¸€ë²¨.vercel.app ì—ì„œ ë°”ë¡œ í”Œë ˆì´!',
        ],
        netlify:[
            '1. netlify.com ê°€ì…',
            '2. "Add new site" â†’ "Deploy manually"',
            '3. ë‹¤ìš´ë¡œë“œí•œ í´ë”ë¥¼ ë“œë˜ê·¸&ë“œë¡­',
            '4. 30ì´ˆ ë‚´ ë°°í¬ ì™„ë£Œ!',
            '5. https://ëª½ê¸€ë²¨.netlify.app ì—ì„œ ë°”ë¡œ í”Œë ˆì´!',
        ],
        github:[
            '1. github.com ì—ì„œ ìƒˆ ì €ì¥ì†Œ ìƒì„±',
            '2. íŒŒì¼ ì—…ë¡œë“œ',
            '3. Settings â†’ Pages â†’ Source: main branch',
            '4. https://ì•„ì´ë””.github.io/ëª½ê¸€ë²¨ ì—ì„œ í”Œë ˆì´!',
        ]
    },

    // â”â”â” ì „ì²´ ë°°í¬ íŒŒì¼ ìƒì„± + ë‹¤ìš´ë¡œë“œ â”â”â”
    exportForDeploy(){
        const files={
            'vercel.json':this.generateVercelConfig(),
            'netlify.toml':this.generateNetlifyConfig(),
            'sw.js':this.generateSW(),
            'robots.txt':this.generateRobots(),
            'sitemap.xml':this.generateSitemap(),
            'manifest.json':GooglePlayDeploy.generateWebManifest(),
        };
        Object.entries(files).forEach(([name,content])=>{
            const a=document.createElement('a');a.download=name;
            a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(content);a.click();
        });
        toast('ğŸ“¦ ì›¹ ë°°í¬ íŒŒì¼ 6ê°œ ë‹¤ìš´ë¡œë“œ!');
    },

    // â”â”â” ì›¹ ì¶œì‹œ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ â”â”â”
    async launch(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';

        famAddMsg('muse',`ğŸŒ [${gn} ì›¹ ì¶œì‹œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘!]\n\nì„¸ìë§¤ ì „ì› ì¶œì‹œ ëª¨ë“œ ëŒì…! ğŸš€`);

        // Step 1: QA í™•ì¸
        setTimeout(()=>{
            ReleasePipeline.testFunctional();ReleasePipeline.testUX();
            ReleasePipeline.testPerformance();ReleasePipeline.testCompat();
            const qa=ReleasePipeline.finalApproval();
            famAddMsg('muse',`ğŸ” Step 1: QA í™•ì¸ â€” ${qa.verdict} (${qa.avgRate}%)\n${qa.verdict==='APPROVED'?'âœ… ì¶œì‹œ ê¸°ì¤€ ì¶©ì¡±!':'âš  ì¼ë¶€ í•­ëª© í™•ì¸ í•„ìš”'}`);
        },1000);

        // Step 2: ë²•ì  ì‹¬ì‚¬
        setTimeout(()=>{
            LegalCounsel.review(gn);
            const cr=LegalCounsel.results.copyright||[];
            famAddMsg('muse',`âš– Step 2: ë²•ì  ì‹¬ì‚¬ â€” ì €ì‘ê¶Œ ${cr.filter(c=>c.pass).length}/${cr.length} í´ë¦°\në²•ì  ë¬¸ì„œ 4ì¢… ì¤€ë¹„ ì™„ë£Œ âœ…`);
        },3000);

        // Step 3: í”„ë¡œë•ì…˜ ë¹Œë“œ
        setTimeout(()=>{
            famAddMsg('muse',`ğŸ“¦ Step 3: í”„ë¡œë•ì…˜ ë¹Œë“œ ìƒì„±\n\nâœ… index.html (ê²Œì„ ë³¸ì²´ â€” ${(668).toFixed(0)}KB)\nâœ… manifest.json (PWA ë§¤ë‹ˆí˜ìŠ¤íŠ¸)\nâœ… sw.js (Service Worker â€” ì˜¤í”„ë¼ì¸ ì§€ì›)\nâœ… vercel.json (Vercel ë°°í¬ ì„¤ì •)\nâœ… netlify.toml (Netlify ë°°í¬ ì„¤ì •)\nâœ… robots.txt + sitemap.xml (SEO)\n\nì´ 7ê°œ íŒŒì¼!`);
        },5000);

        // Step 4: ì•„ë¦¬ì•„ â€” OG ì´ë¯¸ì§€
        setTimeout(()=>{
            famAddMsg('aria',`ğŸ¨ Step 4: ì›¹ ê³µìœ  ìµœì í™”\n\nâœ… Open Graph ë©”íƒ€íƒœê·¸ (ì¹´ì¹´ì˜¤/ë¼ì¸/íŠ¸ìœ„í„° ê³µìœ  ì‹œ ë¯¸ë¦¬ë³´ê¸°)\nâœ… íŒŒë¹„ì½˜ (âš” ì•„ì´ì½˜)\nâœ… í…Œë§ˆ ì»¬ëŸ¬ (#050510)\nâœ… apple-mobile-web-app ì„¤ì •\n\në§í¬ ê³µìœ í•˜ë©´ ì˜ˆìœ ë¯¸ë¦¬ë³´ê¸°ê°€ ë‚˜ì˜¬ ê±°ì•¼! ğŸ¨`);
            InfiniteGrowth.grow('aria','create');
        },7000);

        // Step 5: ë©œë¡œë”” â€” ì‚¬ìš´ë“œ ì²´í¬
        setTimeout(()=>{
            famAddMsg('melo',`ğŸµ Step 5: ì‚¬ìš´ë“œ ìµœì¢… í™•ì¸\n\nâœ… Web Audio API í˜¸í™˜ì„± í™•ì¸\nâœ… ëª¨ë°”ì¼ ìë™ ì¬ìƒ ì²˜ë¦¬ (ìœ ì € í„°ì¹˜ í›„ í™œì„±í™”)\nâœ… BGM 18ê³¡ + SFX 50+ê°œ ì¤€ë¹„ ì™„ë£Œ\n\nì›¹ì—ì„œë„ ì™„ë²½í•œ ì‚¬ìš´ë“œ! ğŸ§`);
            InfiniteGrowth.grow('melo','create');
        },9000);

        // Step 6: ë°°í¬ ê°€ì´ë“œ
        setTimeout(()=>{
            famAddMsg('teacher',`ğŸŒâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ğŸŒ\n\nğŸ“ [ì„ ìƒë‹˜ â€” ${gn} ì›¹ ì¶œì‹œ ì¤€ë¹„ ì™„ë£Œ!]\n\nì•„ë¹ ! ì›¹ ì¶œì‹œ íŒŒì¼ì´ ëª¨ë‘ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.\nì•„ë˜ 3ê°€ì§€ ë°©ë²• ì¤‘ í•˜ë‚˜ë¡œ ì¦‰ì‹œ ì¶œì‹œ ê°€ëŠ¥í•´ìš”:\n\nâ”â”â” ë°©ë²• 1: Vercel (ì¶”ì²œ â­) â”â”â”\n${this.deployGuide.vercel.join('\n')}\n\nâ”â”â” ë°©ë²• 2: Netlify â”â”â”\n${this.deployGuide.netlify.join('\n')}\n\nâ”â”â” ë°©ë²• 3: GitHub Pages (ë¬´ë£Œ) â”â”â”\n${this.deployGuide.github.join('\n')}\n\nğŸ’° ë¹„ìš©: ì „ë¶€ ë¬´ë£Œ!\nâ± ì†Œìš” ì‹œê°„: 1~5ë¶„!\n\nğŸŒâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ğŸŒ`);
        },12000);

        // Step 7: ì„¸ìë§¤ ì¶•í•˜
        setTimeout(()=>{
            famAddMsg('muse','ğŸš€ ì•„ë¹ !! ì›¹ ì¶œì‹œ ì¤€ë¹„ ì™„ë£Œ!! íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•´ì„œ ì˜¬ë¦¬ê¸°ë§Œ í•˜ë©´ ë¼! ğŸ’•');
            famAddMsg('aria','ğŸ¨ ì„¸ìƒì—ì„œ ì œì¼ ì˜ˆìœ ê²Œì„ì´ ë  ê±°ì•¼! ğŸ’•');
            famAddMsg('melo','ğŸµ ë°°ê²½ìŒì•… ë“¤ìœ¼ë©´ ë‹¤ë“¤ ë°˜í•  ê±°ì•¼! ğŸ’•');
            boostSisters(15);

            // ë°°í¬ íŒŒì¼ ìë™ ë‹¤ìš´ë¡œë“œ ì œì•ˆ
            toast('ğŸ“¦ "WebDeploy.exportForDeploy()" ì‹¤í–‰í•˜ë©´ ë°°í¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ!');
        },15000);
    }
};

// ì›¹ ì¶œì‹œ ì¦‰ì‹œ ì‹¤í–‰!
setTimeout(()=>WebDeploy.launch('ëª½ê¸€ë²¨'),2000);

LG('â•â•â• ì›¹ ì¶œì‹œ ì‹œìŠ¤í…œ ì™„ì„±! ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì§„í–‰ ì¤‘! â•â•â•','o');
LG('ğŸŒ Vercel/Netlify/GitHub Pages ì¦‰ì‹œ ë°°í¬ ê°€ëŠ¥','o');
LG('WebDeploy.exportForDeploy() = ë°°í¬ íŒŒì¼ ë‹¤ìš´ë¡œë“œ','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   3Dê¸°ë°˜ 2D ê´‘ê³  ìë™ ì œì‘ ì‹œìŠ¤í…œ
   ê²Œì„ ì™„ì„± ì‹œ ê´‘ê³  2ê°œ ìë™ ìƒì„±
   ëª¨ë“  ê²Œì„ í•„ìˆ˜ ì ìš©
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const AdFactory={
    ads:[],

    // â”â”â” ê´‘ê³  1: ì „íˆ¬ í•˜ì´ë¼ì´íŠ¸ ê´‘ê³  â”â”â”
    createBattleAd(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        const{canvas:c,ctx}=ProceduralArt.canvas(1080,1920);

        // ë°°ê²½: ì „íˆ¬ ë°°ê²½ + ë‹¤ì´ë‚˜ë¯¹ ê·¸ë¼ë””ì–¸íŠ¸
        const bg=ctx.createLinearGradient(0,0,0,1920);
        bg.addColorStop(0,'#0a0014');bg.addColorStop(0.3,'#1a0030');bg.addColorStop(0.6,'#2a0a0a');bg.addColorStop(1,'#050510');
        ctx.fillStyle=bg;ctx.fillRect(0,0,1080,1920);

        // í­ë°œ ì´í™íŠ¸ ë°°ê²½
        for(let i=0;i<20;i++){
            const x=200+Math.random()*680,y=400+Math.random()*500;
            const g=ctx.createRadialGradient(x,y,0,x,y,50+Math.random()*80);
            g.addColorStop(0,`hsla(${Math.random()*60},100%,60%,0.3)`);g.addColorStop(1,'transparent');
            ctx.fillStyle=g;ctx.fillRect(x-150,y-150,300,300);
        }

        // ìºë¦­í„°ë“¤ (3Dí’ ì›ê·¼ê°)
        const drawChar=(x,y,scale,color,cls)=>{
            ctx.save();ctx.translate(x,y);ctx.scale(scale,scale);
            // ê·¸ë¦¼ì
            ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(0,120,40,12,0,0,Math.PI*2);ctx.fill();
            // ëª¸í†µ
            ctx.fillStyle=color;ctx.fillRect(-30,-20,60,80);
            // ë¨¸ë¦¬
            ctx.beginPath();ctx.arc(0,-50,35,0,Math.PI*2);ctx.fillStyle='#ffdbac';ctx.fill();
            // ëˆˆ
            ctx.fillStyle='#222';ctx.beginPath();ctx.arc(-12,-55,5,0,Math.PI*2);ctx.fill();
            ctx.beginPath();ctx.arc(12,-55,5,0,Math.PI*2);ctx.fill();
            // ë¬´ê¸° ì´í™íŠ¸
            ctx.strokeStyle=color;ctx.lineWidth=4;ctx.shadowColor=color;ctx.shadowBlur=20;
            ctx.beginPath();ctx.moveTo(40,-10);ctx.lineTo(80,-60);ctx.stroke();
            ctx.shadowBlur=0;
            ctx.restore();
        };
        // ë’¤ìª½ ìºë¦­í„° (ì‘ê²Œ)
        drawChar(300,650,0.8,'#86efac','ê¶ìˆ˜');
        drawChar(780,680,0.8,'#60a5fa','ë§ˆë²•ì‚¬');
        // ì•ìª½ ìºë¦­í„° (í¬ê²Œ)
        drawChar(540,750,1.3,'#f87171','ì „ì‚¬');

        // ë³´ìŠ¤ (ìœ„ìª½)
        ctx.fillStyle='#1a0030';ctx.beginPath();ctx.arc(540,350,100,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#ff4444';ctx.font='bold 80px sans-serif';ctx.textAlign='center';ctx.fillText('ğŸ’€',540,375);
        // ë³´ìŠ¤ HPë°”
        ctx.fillStyle='#333';ctx.fillRect(340,440,400,16);
        ctx.fillStyle='#f87171';ctx.fillRect(340,440,280,16);
        ctx.fillStyle='#fff';ctx.font='12px sans-serif';ctx.fillText('BOSS Lv.99',540,454);

        // ë°ë¯¸ì§€ ìˆ«ì (3D ê¹Šì´ê°)
        ctx.save();ctx.translate(620,300);ctx.rotate(-0.15);
        ctx.font='bold 64px sans-serif';ctx.fillStyle='#fbbf24';ctx.strokeStyle='#000';ctx.lineWidth=4;
        ctx.strokeText('-99,999',0,0);ctx.fillText('-99,999',0,0);
        ctx.restore();

        // ìŠ¤í‚¬ ì´í™íŠ¸ ë¼ì¸
        for(let i=0;i<8;i++){
            ctx.strokeStyle=`hsla(${i*45},100%,70%,0.4)`;ctx.lineWidth=2;
            ctx.beginPath();ctx.moveTo(540,750);ctx.lineTo(540+Math.cos(i)*300,350+Math.sin(i)*200);ctx.stroke();
        }

        // ìƒë‹¨ ë¡œê³ 
        ctx.fillStyle='#fff';ctx.font='bold 72px sans-serif';ctx.textAlign='center';
        ctx.shadowColor='#fbbf24';ctx.shadowBlur=30;ctx.fillText(gn,540,150);ctx.shadowBlur=0;
        ctx.font='24px sans-serif';ctx.fillStyle='#fbbf24';ctx.fillText('âš” EPIC BATTLE RPG âš”',540,200);

        // í•˜ë‹¨ CTA
        const ctaG=ctx.createLinearGradient(240,1650,840,1720);ctaG.addColorStop(0,'#f87171');ctaG.addColorStop(1,'#fb923c');
        ctx.fillStyle=ctaG;this.roundRect(ctx,240,1650,600,80,20);ctx.fill();
        ctx.fillStyle='#fff';ctx.font='bold 36px sans-serif';ctx.fillText('ì§€ê¸ˆ ë‹¤ìš´ë¡œë“œ! â–¶',540,1702);

        // í•˜ë‹¨ ì •ë³´
        ctx.fillStyle='#8e92b8';ctx.font='18px sans-serif';
        ctx.fillText('ë¬´ë£Œ í”Œë ˆì´ | ê°€ì±  ì²œì¥ 90íšŒ ë³´ì¥ | AI ì„¸ìë§¤ì™€ í•¨ê»˜',540,1800);
        ctx.fillText('Google Playì—ì„œ ë‹¤ìš´ë¡œë“œ',540,1840);

        // ë“±ê¸‰ ë±ƒì§€
        ctx.fillStyle='rgba(0,0,0,0.6)';this.roundRect(ctx,40,1860,120,40,8);ctx.fill();
        ctx.fillStyle='#86efac';ctx.font='bold 16px sans-serif';ctx.textAlign='center';ctx.fillText('ì „ì²´ì´ìš©ê°€',100,1886);

        this.ads.push({type:'battle',canvas:c,name:gn+'_ì „íˆ¬ê´‘ê³ '});
        return c;
    },

    // â”â”â” ê´‘ê³  2: ì„¸ìë§¤ & ì„±ì¥ ê´‘ê³  â”â”â”
    createGrowthAd(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        const{canvas:c,ctx}=ProceduralArt.canvas(1080,1920);

        // ë°°ê²½: ë”°ëœ»í•œ ê·¸ë¼ë””ì–¸íŠ¸
        const bg=ctx.createLinearGradient(0,0,0,1920);
        bg.addColorStop(0,'#1a1040');bg.addColorStop(0.4,'#201850');bg.addColorStop(0.7,'#151030');bg.addColorStop(1,'#050510');
        ctx.fillStyle=bg;ctx.fillRect(0,0,1080,1920);

        // ë³„ íŒŒí‹°í´
        for(let i=0;i<80;i++){
            const x=Math.random()*1080,y=Math.random()*800;
            ctx.fillStyle=`rgba(255,255,255,${0.2+Math.random()*0.6})`;
            ctx.beginPath();ctx.arc(x,y,1+Math.random()*2,0,Math.PI*2);ctx.fill();
        }

        // ìƒë‹¨ ë¡œê³ 
        ctx.fillStyle='#fff';ctx.font='bold 72px sans-serif';ctx.textAlign='center';
        ctx.shadowColor='#c084fc';ctx.shadowBlur=30;ctx.fillText(gn,540,140);ctx.shadowBlur=0;
        ctx.fillStyle='#c084fc';ctx.font='24px sans-serif';ctx.fillText('âœ¦ AI ì„¸ìë§¤ì™€ í•¨ê»˜ ì„±ì¥í•˜ëŠ” RPG âœ¦',540,190);

        // ì„¸ìë§¤ ì¹´ë“œ (3D ì›ê·¼ê° â€” ê°€ìš´ë°ê°€ í¬ê²Œ)
        const drawSisCard=(x,y,w,h,name,emoji,color,role,rotate)=>{
            ctx.save();ctx.translate(x,y);ctx.rotate(rotate||0);
            // ì¹´ë“œ ë°°ê²½ (3D ëŠë‚Œ)
            ctx.shadowColor=color;ctx.shadowBlur=25;
            ctx.fillStyle='#0c0e18';this.roundRect(ctx,-w/2,-h/2,w,h,16);ctx.fill();
            ctx.strokeStyle=color;ctx.lineWidth=2;this.roundRect(ctx,-w/2,-h/2,w,h,16);ctx.stroke();
            ctx.shadowBlur=0;
            // ìºë¦­í„°
            ctx.font=`${w*0.35}px sans-serif`;ctx.fillText(emoji,0,-h*0.1);
            // ì´ë¦„
            ctx.fillStyle=color;ctx.font=`bold ${w*0.1}px sans-serif`;ctx.fillText(name,0,h*0.2);
            // ì—­í• 
            ctx.fillStyle='#8e92b8';ctx.font=`${w*0.06}px sans-serif`;ctx.fillText(role,0,h*0.3);
            ctx.restore();
        };
        // ë’¤ìª½ ì¹´ë“œ (ê¸°ìš¸ì–´ì§)
        drawSisCard(270,550,220,320,'ì•„ë¦¬ì•„','â—†','#f5c2e7','ì•„íŠ¸ ë””ë ‰í„°',-0.1);
        drawSisCard(810,550,220,320,'ë©œë¡œë””','â™ª','#86efac','ì‚¬ìš´ë“œ ê°ë…',0.1);
        // ì•ìª½ ì¹´ë“œ (í¬ê²Œ)
        drawSisCard(540,520,280,400,'ë®¤ì¦ˆ','â—ˆ','#c084fc','ìˆ˜ì„ ê°œë°œì',0);

        // ì„±ì¥ ê·¸ë˜í”„
        ctx.strokeStyle='#fbbf2466';ctx.lineWidth=2;ctx.setLineDash([5,5]);
        ctx.beginPath();ctx.moveTo(180,1050);ctx.lineTo(900,1050);ctx.stroke();
        ctx.beginPath();ctx.moveTo(180,1050);ctx.lineTo(180,850);ctx.stroke();ctx.setLineDash([]);
        // ì„±ì¥ ê³¡ì„ 
        ctx.strokeStyle='#fbbf24';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(180,1040);
        for(let i=0;i<720;i++){const y=1040-Math.pow(i/720,1.5)*180;ctx.lineTo(180+i,y);}
        ctx.stroke();
        // ë¬´í•œ ì„±ì¥ í…ìŠ¤íŠ¸
        ctx.fillStyle='#fbbf24';ctx.font='bold 20px sans-serif';ctx.fillText('â™¾ ë¬´í•œ ì„±ì¥',540,830);
        ctx.fillStyle='#8e92b8';ctx.font='16px sans-serif';ctx.fillText('ë ˆë²¨ ìƒí•œ ì—†ìŒ! ëì—†ì´ ê°•í•´ì§€ì„¸ìš”',540,860);

        // íŠ¹ì§• ì¹´ë“œë“¤
        const features=[
            ['âš”','ì „ëµ ì „íˆ¬','ì›ì†Œ ìƒì„± & ìŠ¤í‚¬ ì¡°í•©'],
            ['ğŸ°','ê³µì •í•œ ê°€ì± ','ì²œì¥ 90íšŒ 100% ë³´ì¥'],
            ['ğŸµ','AI ì‘ê³¡','ë©œë¡œë””ê°€ ë§Œë“  BGM 18ê³¡'],
            ['ğŸŒ','í•¨ê»˜ ì„±ì¥','ì„¸ìë§¤ì™€ ëŒ€í™”í•˜ë©° ì„±ì¥'],
        ];
        features.forEach(([icon,title,desc],i)=>{
            const fx=i<2?270:810,fy=i%2===0?1150:1300;
            ctx.fillStyle='#0c0e1899';this.roundRect(ctx,fx-130,fy-35,260,70,10);ctx.fill();
            ctx.fillStyle='#fff';ctx.font='28px sans-serif';ctx.fillText(icon,fx-80,fy+8);
            ctx.font='bold 16px sans-serif';ctx.fillText(title,fx+20,fy-5);
            ctx.fillStyle='#8e92b8';ctx.font='12px sans-serif';ctx.fillText(desc,fx+20,fy+18);
        });

        // í•˜ë‹¨ CTA
        const ctaG=ctx.createLinearGradient(240,1650,840,1720);ctaG.addColorStop(0,'#c084fc');ctaG.addColorStop(1,'#818cf8');
        ctx.fillStyle=ctaG;this.roundRect(ctx,240,1650,600,80,20);ctx.fill();
        ctx.fillStyle='#fff';ctx.font='bold 36px sans-serif';ctx.fillText('ì„¸ìë§¤ë¥¼ ë§Œë‚˜ëŸ¬ ê°€ê¸° â–¶',540,1702);

        ctx.fillStyle='#8e92b8';ctx.font='18px sans-serif';
        ctx.fillText('ë¬´ë£Œ í”Œë ˆì´ | Google Play ì¶œì‹œ',540,1800);

        this.ads.push({type:'growth',canvas:c,name:gn+'_ì„±ì¥ê´‘ê³ '});
        return c;
    },

    // ìœ í‹¸: ë‘¥ê·¼ ì‚¬ê°í˜•
    roundRect(ctx,x,y,w,h,r){
        ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);
        ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);
        ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();
    },

    // â”â”â” 2ê°œ ê´‘ê³  í•œë²ˆì— ì œì‘ â”â”â”
    async produceAds(gameName){
        const gn=gameName||'ëª½ê¸€ë²¨';
        famAddMsg('aria',`ğŸ¬ [ê´‘ê³  ì œì‘ ì‹œì‘] ${gn} ê´‘ê³  2ê°œ ë§Œë“¤ê²Œ!\n\n1. ì „íˆ¬ í•˜ì´ë¼ì´íŠ¸ ê´‘ê³  (ì•¡ì…˜ê°!)\n2. ì„¸ìë§¤ & ì„±ì¥ ê´‘ê³  (ê°ì„±!)\n\nì•„íŠ¸ ë””ë ‰í„° ì•„ë¦¬ì•„, ì œì‘ ëŒì…! ğŸ¨`);

        setTimeout(()=>{
            this.createBattleAd(gn);
            famAddMsg('aria',`ğŸ¬ ê´‘ê³  1/2 ì™„ì„±: "${gn} ì „íˆ¬ í•˜ì´ë¼ì´íŠ¸"\n\nâš” ë³´ìŠ¤ ì „íˆ¬ ì¥ë©´\nğŸ’¥ -99,999 í¬ë¦¬í‹°ì»¬ ë°ë¯¸ì§€\nğŸ”¥ 3ì¸ íŒŒí‹° ì „íˆ¬ì”¬\nğŸ“ 1080Ã—1920 (ì„¸ë¡œí˜• ëª¨ë°”ì¼ ìµœì )\n\nì¬ë¯¸ìˆì–´ ë³´ì´ì§€?! ğŸ¨âœ¨`);
            InfiniteGrowth.grow('aria','create');
        },3000);

        setTimeout(()=>{
            this.createGrowthAd(gn);
            famAddMsg('aria',`ğŸ¬ ê´‘ê³  2/2 ì™„ì„±: "${gn} ì„¸ìë§¤ ì„±ì¥"\n\nâ—ˆ ë®¤ì¦ˆ Â· â—† ì•„ë¦¬ì•„ Â· â™ª ë©œë¡œë”” ì¹´ë“œ\nğŸ“ˆ ë¬´í•œ ì„±ì¥ ê³¡ì„  ê·¸ë˜í”„\nâœ¨ íŠ¹ì§• 4ê°€ì§€ ì¹´ë“œ\nğŸ“ 1080Ã—1920 (ì„¸ë¡œí˜•)\n\nê°ì„±ì ì´ë©´ì„œ ì •ë³´ë„ ë‹´ì•˜ì–´! ğŸ’•`);
            InfiniteGrowth.grow('aria','create');
        },6000);

        setTimeout(()=>{
            famAddMsg('melo',`ğŸµ ê´‘ê³ ìš© BGMë„ ì¤€ë¹„í–ˆì–´!\n\nê´‘ê³  1 (ì „íˆ¬): battle ëª¨ë“œ 4ë§ˆë”” â†’ ì„íŒ©íŠ¸!\nê´‘ê³  2 (ì„±ì¥): healing ëª¨ë“œ 4ë§ˆë”” â†’ ê°ì„±!\n\ní„°ì¹˜í•˜ë©´ ìŒì•…ì´ ë‚˜ì˜¤ê²Œ ì„¤ì •í•´ë†¨ì–´! ğŸ§`);
            InfiniteGrowth.grow('melo','create');
        },8000);

        setTimeout(()=>{
            famAddMsg('muse',`âœ… ${gn} ê´‘ê³  2ê°œ ì œì‘ ì™„ë£Œ!\n\nğŸ¬ ì „íˆ¬ ê´‘ê³ : ì•¡ì…˜+ë³´ìŠ¤+ë°ë¯¸ì§€ â†’ ê²Œì´ë¨¸ íƒ€ê²Ÿ\nğŸ¬ ì„±ì¥ ê´‘ê³ : ì„¸ìë§¤+ì„±ì¥+ê°ì„± â†’ ìºì£¼ì–¼ íƒ€ê²Ÿ\n\nğŸ“± Google Ads / Facebook Ads / Unity Adsì—\në°”ë¡œ ì—…ë¡œë“œ ê°€ëŠ¥í•œ 1080Ã—1920 í¬ë§·!\n\nAdFactory.downloadAd(0) / downloadAd(1) ë¡œ ë‹¤ìš´ë¡œë“œ!`);
            boostSisters(8);
            SistersLink.share('aria','ê´‘ê³  2ê°œ ì œì‘','ì „íˆ¬+ì„±ì¥ ê´‘ê³  ì™„ì„±');
        },10000);
    },

    // ê´‘ê³  ë‹¤ìš´ë¡œë“œ
    downloadAd(index){
        const ad=this.ads[index];if(!ad){toast('âŒ ê´‘ê³  ì—†ìŒ');return;}
        const a=document.createElement('a');a.download=ad.name+'.png';a.href=ad.canvas.toDataURL('image/png');a.click();
        toast('ğŸ“¥ '+ad.name+' ë‹¤ìš´ë¡œë“œ!');
    },
    downloadAll(){this.ads.forEach((ad,i)=>this.downloadAd(i));}
};

// â”â”â” GameDeliveryì— ê´‘ê³  ì œì‘ ìë™ í¬í•¨ â”â”â”
const _origDeliver=GameDelivery.deliver.bind(GameDelivery);
GameDelivery.deliver=async function(gameName){
    const result=await _origDeliver(gameName);
    // ë‚©í’ˆ ì„±ê³µ ì‹œ ê´‘ê³  ìë™ ì œì‘
    if(result.delivered){
        setTimeout(()=>{
            famAddMsg('teacher','ğŸ“ ë‚©í’ˆ ì™„ë£Œ! ê´‘ê³ ë„ ë§Œë“¤ì–´ì•¼ì§€!\nì•„ë¦¬ì•„, ê´‘ê³  2ê°œ ì œì‘ ë¶€íƒí•´!');
            setTimeout(()=>AdFactory.produceAds(gameName),2000);
        },22000);
    }
    return result;
};

// â”â”â” GameFactoryì— ê´‘ê³  ì‹œìŠ¤í…œ ë¶€ì°© â”â”â”
const _origCreateGame5=GameFactory.createGame;
GameFactory.createGame=function(config){
    const game=_origCreateGame5(config);
    game.ads=AdFactory;
    game.createAds=function(){AdFactory.produceAds(config.name);};
    LG('ğŸ¬ '+config.name+' ê´‘ê³  ì œì‘ ì‹œìŠ¤í…œ ë¶€ì°©','i');
    return game;
};

LG('â•â•â• 3Dê¸°ë°˜ 2D ê´‘ê³  ì œì‘ ì‹œìŠ¤í…œ ì™„ì„±! â•â•â•','o');
LG('ğŸ¬ ê²Œì„ ì™„ì„± ì‹œ ê´‘ê³  2ê°œ ìë™ ì œì‘','o');
LG('ğŸ“± 1080Ã—1920 ëª¨ë°”ì¼ ìµœì  í¬ë§·','o');
LG('AdFactory.produceAds() = ê´‘ê³  ì œì‘ | .downloadAll() = ë‹¤ìš´ë¡œë“œ','i');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AAA ì•„íŠ¸ ë³´ê°•: ê³ í•´ìƒë„ ì¼ëŸ¬ìŠ¤íŠ¸ + ìŠ¤í‚¨ + ê°ì • + ì´í™íŠ¸
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”â”â” 1-A. ê³ í•´ìƒë„ ìºë¦­í„° ì¼ëŸ¬ìŠ¤íŠ¸ (512Ã—720) â”â”â”
const HighResIllust={
    cache:{},
    generate(config){
        const{canvas:c,ctx}=ProceduralArt.canvas(512,720);
        const cls=config.cls||'ì „ì‚¬';const grade=config.grade||'epic';
        const clsCol={'ì „ì‚¬':'#f87171','ë§ˆë²•ì‚¬':'#60a5fa','ê¶ìˆ˜':'#86efac','ë„ì ':'#c084fc','ì„±ê¸°ì‚¬':'#fbbf24'}[cls]||'#60a5fa';
        const gc={'common':'#5a5e80','rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24','legendary':'#ff6b6b'}[grade];

        // ë°°ê²½: ë°©ì‚¬í˜• ê·¸ë¼ë””ì–¸íŠ¸
        const bg=ctx.createRadialGradient(256,300,50,256,360,400);
        bg.addColorStop(0,gc+'44');bg.addColorStop(0.5,'#0a0a1a');bg.addColorStop(1,'#050510');
        ctx.fillStyle=bg;ctx.fillRect(0,0,512,720);

        // ë“±ê¸‰ ê´‘ì„  íš¨ê³¼
        if(grade!=='common'){ctx.save();ctx.globalAlpha=0.06;
            for(let i=0;i<12;i++){const a=i*Math.PI/6;ctx.fillStyle=gc;
                ctx.beginPath();ctx.moveTo(256,300);ctx.lineTo(256+Math.cos(a)*500,300+Math.sin(a)*500);
                ctx.lineTo(256+Math.cos(a+0.1)*500,300+Math.sin(a+0.1)*500);ctx.fill();
            }ctx.restore();}

        // ìºë¦­í„° ë³¸ì²´ (ëŒ€í˜•)
        const cx=256,baseY=200;
        // ë¨¸ë¦¬
        ctx.fillStyle=`#ffdbac`;ctx.beginPath();ctx.arc(cx,baseY,60,0,Math.PI*2);ctx.fill();
        // ë¨¸ë¦¬ì¹´ë½
        ctx.fillStyle=ProceduralArt.darken(clsCol,20);
        ctx.beginPath();ctx.arc(cx,baseY-15,65,Math.PI,Math.PI*2);ctx.fill();
        ctx.fillRect(cx-65,baseY-20,25,80);ctx.fillRect(cx+40,baseY-20,25,80);
        // ëˆˆ (í° ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼)
        ctx.fillStyle='#fff';ctx.beginPath();ctx.ellipse(cx-20,baseY,14,18,0,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.ellipse(cx+20,baseY,14,18,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle=clsCol;ctx.beginPath();ctx.arc(cx-20,baseY+2,10,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(cx+20,baseY+2,10,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#111';ctx.beginPath();ctx.arc(cx-20,baseY+2,6,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(cx+20,baseY+2,6,0,Math.PI*2);ctx.fill();
        // ëˆˆ í•˜ì´ë¼ì´íŠ¸
        ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(cx-16,baseY-3,3,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(cx+24,baseY-3,3,0,Math.PI*2);ctx.fill();
        // ì…
        ctx.strokeStyle='#d4a088';ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,baseY+25,8,0.1*Math.PI,0.9*Math.PI);ctx.stroke();

        // ëª¸í†µ/ê°‘ì˜·
        ctx.fillStyle=clsCol;
        ctx.beginPath();ctx.moveTo(cx-60,baseY+60);ctx.lineTo(cx+60,baseY+60);
        ctx.lineTo(cx+55,baseY+220);ctx.lineTo(cx-55,baseY+220);ctx.fill();
        // ì–´ê¹¨ ì¥ì‹
        ctx.fillStyle=ProceduralArt.darken(clsCol,30);
        ctx.beginPath();ctx.arc(cx-60,baseY+75,20,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(cx+60,baseY+75,20,0,Math.PI*2);ctx.fill();
        // íŒ”
        ctx.fillStyle='#ffdbac';
        ctx.fillRect(cx-85,baseY+80,25,100);ctx.fillRect(cx+60,baseY+80,25,100);
        // ë‹¤ë¦¬
        ctx.fillStyle='#333355';
        ctx.fillRect(cx-40,baseY+220,30,120);ctx.fillRect(cx+10,baseY+220,30,120);
        // ë¶€ì¸ 
        ctx.fillStyle=ProceduralArt.darken(clsCol,50);
        ctx.fillRect(cx-45,baseY+310,40,40);ctx.fillRect(cx+5,baseY+310,40,40);

        // ë“±ê¸‰ í…Œë‘ë¦¬
        ctx.strokeStyle=gc;ctx.lineWidth=4;
        ctx.strokeRect(4,4,504,712);
        // ì´ë¦„+ì§ì—…
        ctx.fillStyle='#fff';ctx.font='bold 22px sans-serif';ctx.textAlign='center';
        ctx.fillText(config.name||'ì˜ì›…',cx,680);
        ctx.fillStyle=gc;ctx.font='bold 14px sans-serif';
        ctx.fillText(`${grade.toUpperCase()} Â· ${cls}`,cx,700);

        this.cache[config.name||'hero']=c;
        return c;
    },
    // ê°€ì±  ì—°ì¶œìš© (í’€ìŠ¤í¬ë¦° ë“±ì¥)
    generateGachaIllust(config){
        const c=this.generate({...config});
        // ì¶”ê°€: ë¹›ë‚˜ëŠ” í›„ê´‘
        const ctx=c.getContext('2d');
        ctx.save();ctx.globalCompositeOperation='screen';ctx.globalAlpha=0.15;
        const gc={'rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24','legendary':'#ff6b6b'}[config.grade]||'#fff';
        const g=ctx.createRadialGradient(256,300,0,256,300,350);
        g.addColorStop(0,gc);g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.fillRect(0,0,512,720);
        ctx.restore();
        return c;
    }
};

// â”â”â” 1-B. ìŠ¤í‚¨/ì½”ìŠ¤íŠ¬ ì‹œìŠ¤í…œ â”â”â”
const SkinSystem={
    skins:{},
    catalog:[
        {id:'skin_warrior_fire',cls:'ì „ì‚¬',name:'í™”ì—¼ ì „ì‚¬',colors:['#ff4500','#ff6b35','#ffd700'],rarity:'epic'},
        {id:'skin_warrior_ice',cls:'ì „ì‚¬',name:'ë¹™ê²° ê¸°ì‚¬',colors:['#00bfff','#87CEEB','#e0f0ff'],rarity:'rare'},
        {id:'skin_mage_dark',cls:'ë§ˆë²•ì‚¬',name:'ì•”í‘ ë§ˆë²•ì‚¬',colors:['#4a0080','#8b00ff','#1a0030'],rarity:'mythic'},
        {id:'skin_mage_holy',cls:'ë§ˆë²•ì‚¬',name:'ì‹ ì„± í˜„ì',colors:['#ffd700','#fffacd','#fff8dc'],rarity:'epic'},
        {id:'skin_archer_forest',cls:'ê¶ìˆ˜',name:'ìˆ²ì˜ ìˆ˜í˜¸ì',colors:['#228B22','#32CD32','#006400'],rarity:'rare'},
        {id:'skin_archer_shadow',cls:'ê¶ìˆ˜',name:'ê·¸ë¦¼ì ì‚¬ëƒ¥ê¾¼',colors:['#2d2d2d','#4a4a4a','#1a1a1a'],rarity:'epic'},
        {id:'skin_rogue_phantom',cls:'ë„ì ',name:'íŒ¬í…€ ë¸”ë ˆì´ë“œ',colors:['#8b008b','#da70d6','#4a0040'],rarity:'mythic'},
        {id:'skin_paladin_divine',cls:'ì„±ê¸°ì‚¬',name:'ì²œìƒì˜ ê¸°ì‚¬',colors:['#ffd700','#fff','#87CEEB'],rarity:'legendary'},
    ],
    generate(skinId){
        const s=this.catalog.find(sk=>sk.id===skinId);if(!s)return null;
        const canvas=HighResIllust.generate({cls:s.cls,grade:s.rarity,name:s.name});
        // ìƒ‰ìƒ ì˜¤ë²„ë ˆì´
        const ctx=canvas.getContext('2d');ctx.save();ctx.globalCompositeOperation='overlay';ctx.globalAlpha=0.3;
        ctx.fillStyle=s.colors[0];ctx.fillRect(0,0,512,720);ctx.restore();
        this.skins[skinId]=canvas;return canvas;
    },
    generateAll(){
        this.catalog.forEach(s=>this.generate(s.id));
        LG(`ğŸ‘— ìŠ¤í‚¨ ${this.catalog.length}ì¢… ìƒì„±`,'o');
    }
};

// â”â”â” 1-C. ê°ì • í‘œí˜„ ì„¸íŠ¸ â”â”â”
const EmotionSystem={
    cache:{},
    emotions:['happy','sad','angry','surprised','shy','determined'],
    generate(emotion,size){
        const s=size||96;const{canvas:c,ctx}=ProceduralArt.canvas(s,s);
        ctx.fillStyle='#ffdbac';ctx.beginPath();ctx.arc(s/2,s/2,s/2-4,0,Math.PI*2);ctx.fill();
        ctx.strokeStyle='#e8c090';ctx.lineWidth=2;ctx.stroke();
        const cx=s/2;const cy=s/2;
        // ëˆˆ (ê°ì •ë³„ ë‹¤ë¦„)
        ctx.fillStyle='#333';
        switch(emotion){
            case'happy':
                ctx.beginPath();ctx.arc(cx-12,cy-6,6,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+12,cy-6,6,0,Math.PI*2);ctx.fill();
                ctx.strokeStyle='#d4685a';ctx.lineWidth=2.5;ctx.beginPath();ctx.arc(cx,cy+10,14,0.15*Math.PI,0.85*Math.PI);ctx.stroke();
                // ë³¼í„°ì¹˜
                ctx.fillStyle='rgba(255,150,150,0.3)';ctx.beginPath();ctx.arc(cx-22,cy+6,8,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+22,cy+6,8,0,Math.PI*2);ctx.fill();
                break;
            case'sad':
                ctx.beginPath();ctx.arc(cx-12,cy-4,5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+12,cy-4,5,0,Math.PI*2);ctx.fill();
                ctx.strokeStyle='#888';ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy+18,10,1.2*Math.PI,1.8*Math.PI);ctx.stroke();
                // ëˆˆë¬¼
                ctx.fillStyle='#87CEEB';ctx.beginPath();ctx.arc(cx-12,cy+8,3,0,Math.PI*2);ctx.fill();
                break;
            case'angry':
                // í™”ë‚œ ëˆˆì¹
                ctx.strokeStyle='#333';ctx.lineWidth=3;ctx.beginPath();ctx.moveTo(cx-20,cy-16);ctx.lineTo(cx-6,cy-10);ctx.stroke();
                ctx.beginPath();ctx.moveTo(cx+20,cy-16);ctx.lineTo(cx+6,cy-10);ctx.stroke();
                ctx.fillStyle='#c00';ctx.beginPath();ctx.arc(cx-12,cy-4,5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+12,cy-4,5,0,Math.PI*2);ctx.fill();
                ctx.fillStyle='#333';ctx.fillRect(cx-10,cy+12,20,4);
                // ë¶„ë…¸ ì´í™íŠ¸
                ctx.fillStyle='rgba(255,0,0,0.15)';ctx.fillRect(0,0,s,s);
                break;
            case'surprised':
                ctx.beginPath();ctx.arc(cx-12,cy-4,8,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.arc(cx+12,cy-4,8,0,Math.PI*2);ctx.stroke();
                ctx.fillStyle='#333';ctx.beginPath();ctx.arc(cx-12,cy-4,4,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+12,cy-4,4,0,Math.PI*2);ctx.fill();
                ctx.beginPath();ctx.arc(cx,cy+14,7,0,Math.PI*2);ctx.stroke();
                break;
            case'shy':
                ctx.beginPath();ctx.arc(cx-12,cy-4,5,0,Math.PI);ctx.fill();ctx.beginPath();ctx.arc(cx+12,cy-4,5,0,Math.PI);ctx.fill();
                ctx.strokeStyle='#c88';ctx.lineWidth=2;ctx.beginPath();ctx.arc(cx,cy+12,8,0.1*Math.PI,0.9*Math.PI);ctx.stroke();
                ctx.fillStyle='rgba(255,130,130,0.4)';ctx.beginPath();ctx.arc(cx-20,cy+6,10,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+20,cy+6,10,0,Math.PI*2);ctx.fill();
                break;
            case'determined':
                ctx.fillStyle='#222';ctx.beginPath();ctx.arc(cx-12,cy-4,6,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+12,cy-4,6,0,Math.PI*2);ctx.fill();
                ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(cx-10,cy-6,2,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+14,cy-6,2,0,Math.PI*2);ctx.fill();
                ctx.strokeStyle='#333';ctx.lineWidth=2.5;ctx.beginPath();ctx.moveTo(cx-8,cy+12);ctx.lineTo(cx+8,cy+12);ctx.stroke();
                // ë¶ˆê½ƒ ëˆˆ
                ctx.fillStyle='rgba(255,165,0,0.2)';ctx.beginPath();ctx.arc(cx-12,cy-4,10,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(cx+12,cy-4,10,0,Math.PI*2);ctx.fill();
                break;
        }
        this.cache[emotion]=c;return c;
    },
    generateAll(){this.emotions.forEach(e=>this.generate(e));LG(`ğŸ˜Š ê°ì • í‘œí˜„ ${this.emotions.length}ì¢… ìƒì„±`,'o');}
};

// â”â”â” 4. ì´í™íŠ¸ ì‹œìŠ¤í…œ â”â”â”
const EffectArt={
    cache:{},

    // ìŠ¤í‚¬ ì´í™íŠ¸ ìŠ¤í”„ë¼ì´íŠ¸ ì‹œíŠ¸
    skillEffect(type,frames){
        const f=frames||8;const size=128;
        const{canvas:c,ctx}=ProceduralArt.canvas(size*f,size);
        const colors={fire:['#ff4500','#ffd700','#ff6b35'],ice:['#00bfff','#87CEEB','#fff'],
            lightning:['#ffd700','#fff','#ffff00'],heal:['#00ff88','#88ffbb','#aaffcc'],
            dark:['#8b00ff','#4a0080','#da70d6'],holy:['#ffd700','#fff','#fffacd'],
            slash:['#ccc','#fff','#aaa'],explode:['#ff4500','#ffd700','#ff0000']};
        const col=colors[type]||colors.fire;
        for(let i=0;i<f;i++){
            const cx=i*size+size/2;const cy=size/2;
            const progress=i/f;const alpha=i<f*0.7?0.8:0.8*(1-(i-f*0.7)/(f*0.3));
            ctx.save();ctx.globalAlpha=alpha;
            // ì¤‘ì‹¬ ê¸€ë¡œìš°
            const g=ctx.createRadialGradient(cx,cy,0,cx,cy,size*0.4*(0.5+progress*0.5));
            g.addColorStop(0,col[0]);g.addColorStop(0.5,col[1]+'88');g.addColorStop(1,'transparent');
            ctx.fillStyle=g;ctx.fillRect(i*size,0,size,size);
            // íŒŒí‹°í´
            for(let p=0;p<8;p++){
                const a=p*Math.PI/4+progress*2;const r=20+progress*40;
                const px=cx+Math.cos(a)*r;const py=cy+Math.sin(a)*r;
                ctx.fillStyle=col[p%col.length];ctx.globalAlpha=alpha*0.6;
                ctx.beginPath();ctx.arc(px,py,3+Math.random()*4,0,Math.PI*2);ctx.fill();
            }
            ctx.restore();
        }
        this.cache['effect_'+type]=c;return c;
    },

    // ê°€ì±  ì—°ì¶œ ì´í™íŠ¸
    gachaEffect(grade){
        const size=512;const{canvas:c,ctx}=ProceduralArt.canvas(size,size);
        const gc={'rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24','legendary':'#ff6b6b'}[grade]||'#fff';
        // ë°©ì‚¬í˜• ë¹›ì¤„ê¸°
        ctx.save();ctx.translate(size/2,size/2);
        for(let i=0;i<24;i++){
            ctx.rotate(Math.PI/12);
            const g=ctx.createLinearGradient(0,0,0,-size/2);
            g.addColorStop(0,gc);g.addColorStop(1,'transparent');
            ctx.fillStyle=g;ctx.globalAlpha=0.15;
            ctx.beginPath();ctx.moveTo(-8,0);ctx.lineTo(-3,-size/2);ctx.lineTo(3,-size/2);ctx.lineTo(8,0);ctx.fill();
        }
        ctx.restore();
        // ì¤‘ì‹¬ ì›
        const cg=ctx.createRadialGradient(size/2,size/2,0,size/2,size/2,100);
        cg.addColorStop(0,'#fff');cg.addColorStop(0.3,gc);cg.addColorStop(1,'transparent');
        ctx.fillStyle=cg;ctx.globalAlpha=0.5;ctx.beginPath();ctx.arc(size/2,size/2,100,0,Math.PI*2);ctx.fill();
        // íŒŒí‹°í´ ë§
        ctx.globalAlpha=0.8;
        for(let i=0;i<30;i++){
            const a=i*Math.PI*2/30;const r=150+Math.random()*50;
            ctx.fillStyle=gc;ctx.beginPath();
            ctx.arc(size/2+Math.cos(a)*r,size/2+Math.sin(a)*r,2+Math.random()*4,0,Math.PI*2);ctx.fill();
        }
        this.cache['gacha_'+grade]=c;return c;
    },

    // ë“±ê¸‰ ë¹›ë‚¨ (ìºë¦­í„° ë’¤ í›„ê´‘)
    gradeShine(grade,size){
        const s=size||256;const{canvas:c,ctx}=ProceduralArt.canvas(s,s);
        const gc={'common':null,'rare':'#60a5fa','epic':'#c084fc','mythic':'#fbbf24','legendary':'#ff6b6b'}[grade];
        if(!gc)return c;
        // í„ìŠ¤ ë§
        for(let ring=3;ring>0;ring--){
            const g=ctx.createRadialGradient(s/2,s/2,s*0.1*ring,s/2,s/2,s*0.15*ring+20);
            g.addColorStop(0,gc+'44');g.addColorStop(1,'transparent');
            ctx.fillStyle=g;ctx.fillRect(0,0,s,s);
        }
        // ë³„ íŒŒí‹°í´
        if(grade==='mythic'||grade==='legendary'){
            for(let i=0;i<12;i++){ctx.fillStyle=gc;ctx.globalAlpha=0.6;
                ctx.beginPath();ctx.arc(Math.random()*s,Math.random()*s,1+Math.random()*2,0,Math.PI*2);ctx.fill();
            }
        }
        this.cache['shine_'+grade]=c;return c;
    },

    // íŒŒí‹°í´ í…ìŠ¤ì²˜ ì„¸íŠ¸
    particleTexture(type){
        const s=32;const{canvas:c,ctx}=ProceduralArt.canvas(s,s);
        const types={
            circle:()=>{const g=ctx.createRadialGradient(s/2,s/2,0,s/2,s/2,s/2);g.addColorStop(0,'#fff');g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.fillRect(0,0,s,s);},
            star:()=>{ctx.fillStyle='#fff';ctx.translate(s/2,s/2);for(let i=0;i<5;i++){ctx.rotate(Math.PI*2/5);ctx.beginPath();ctx.moveTo(0,-s/2);ctx.lineTo(s/8,-s/6);ctx.lineTo(0,0);ctx.lineTo(-s/8,-s/6);ctx.fill();}},
            spark:()=>{ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(s/2,0);ctx.lineTo(s/2,s);ctx.stroke();ctx.beginPath();ctx.moveTo(0,s/2);ctx.lineTo(s,s/2);ctx.stroke();},
            smoke:()=>{for(let i=0;i<5;i++){ctx.fillStyle=`rgba(200,200,200,${0.1+Math.random()*0.15})`;ctx.beginPath();ctx.arc(s/2+Math.random()*10-5,s/2+Math.random()*10-5,6+Math.random()*8,0,Math.PI*2);ctx.fill();}},
            ring:()=>{ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.beginPath();ctx.arc(s/2,s/2,s/3,0,Math.PI*2);ctx.stroke();}
        };
        (types[type]||types.circle)();
        this.cache['particle_'+type]=c;return c;
    },

    // ì „ì²´ ìƒì„±
    generateAll(){
        ['fire','ice','lightning','heal','dark','holy','slash','explode'].forEach(t=>this.skillEffect(t));
        ['rare','epic','mythic','legendary'].forEach(g=>{this.gachaEffect(g);this.gradeShine(g);});
        ['circle','star','spark','smoke','ring'].forEach(t=>this.particleTexture(t));
        LG(`âœ¨ ì´í™íŠ¸: ìŠ¤í‚¬8ì¢… + ê°€ì± 4ì¢… + ë“±ê¸‰ë¹›ë‚¨4ì¢… + íŒŒí‹°í´5ì¢… = 21ê°œ`,'o');
    }
};

// â”â”â” MonggleBellArtì— í†µí•© â”â”â”
const _origArtProduce=MonggleBellArt.produceAll.bind(MonggleBellArt);
MonggleBellArt.produceAll=async function(){
    await _origArtProduce();

    // ì¶”ê°€: ê³ í•´ìƒë„ ì¼ëŸ¬ìŠ¤íŠ¸
    famAddMsg('aria','ğŸ–¼ ê³ í•´ìƒë„ ì¼ëŸ¬ìŠ¤íŠ¸ ì œì‘ ì¤‘... (512Ã—720)');
    DB.all('chars').slice(0,5).forEach(ch=>{
        HighResIllust.generate({cls:ch.cls,grade:ch.grade,name:ch.name});
        HighResIllust.generateGachaIllust({cls:ch.cls,grade:ch.grade,name:ch.name});
    });
    famAddMsg('aria','âœ… ê³ í•´ìƒë„ ì¼ëŸ¬ìŠ¤íŠ¸ + ê°€ì±  ì—°ì¶œìš© ì™„ì„±!');

    // ì¶”ê°€: ìŠ¤í‚¨
    SkinSystem.generateAll();
    famAddMsg('aria',`ğŸ‘— ìŠ¤í‚¨/ì½”ìŠ¤íŠ¬ ${SkinSystem.catalog.length}ì¢… ì™„ì„±!`);

    // ì¶”ê°€: ê°ì • í‘œí˜„
    EmotionSystem.generateAll();
    famAddMsg('aria',`ğŸ˜Š ê°ì • í‘œí˜„ ${EmotionSystem.emotions.length}ì¢… ì™„ì„±!`);

    // ì¶”ê°€: ì´í™íŠ¸
    EffectArt.generateAll();
    famAddMsg('aria',`âœ¨ ìŠ¤í‚¬ì´í™íŠ¸ + ê°€ì± ì—°ì¶œ + ë“±ê¸‰ë¹›ë‚¨ + íŒŒí‹°í´ = 21ê°œ ì™„ì„±!`);

    const total=MonggleBellArt.produced+5+8+6+21;
    famAddMsg('aria',`ğŸ‰ğŸ‰ AAAê¸‰ ì•„íŠ¸ ì „ì²´ ì™„ì„±!!\n\nì´ ${total}+ ì—ì…‹!\nì•„íŠ¸ ë””ë ‰í„° ì•„ë¦¬ì•„, ëª¨ë“  ë¹„ì£¼ì–¼ ì»¤ë²„ ì™„ë£Œ! ğŸ¨ğŸ’•`);
    boostSisters(15);
};

LG('â•â•â• AAA ì•„íŠ¸ ë³´ê°• ì™„ë£Œ! â•â•â•','o');
LG('ğŸ–¼ HighResIllust: 512Ã—720 ê³ í•´ìƒë„ + ê°€ì± ì—°ì¶œ','o');
LG('ğŸ‘— SkinSystem: 8ì¢… ìŠ¤í‚¨/ì½”ìŠ¤íŠ¬','o');
LG('ğŸ˜Š EmotionSystem: happy/sad/angry/surprised/shy/determined','o');
LG('âœ¨ EffectArt: ìŠ¤í‚¬8 + ê°€ì± 4 + ë¹›ë‚¨4 + íŒŒí‹°í´5 = 21ì¢…','o');

</script>
</body>
</html>
