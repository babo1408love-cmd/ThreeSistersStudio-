<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0e1a">
    <title>ğŸŒº ëª¬ìŠ¤í„° ê°€ë“  íŠ¸ë ˆì¸ MOBILE ğŸš‚</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0e1a;
            --bg-mid: #1a2332;
            --bg-card: #243447;
            --accent-gold: #ffd700;
            --accent-green: #00ff88;
            --accent-purple: #a855f7;
            --accent-pink: #ec4899;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
            /* ëª¨ë°”ì¼ ìµœì í™” */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
        }
        
        /* ëª¨ë°”ì¼ í„°ì¹˜ íƒ€ê²Ÿ ìµœì†Œ í¬ê¸° */
        button, .btn, .card, .tab, .plant-slot {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* ì„±ëŠ¥ ìµœì í™” - GPU ê°€ì† */
        .card, .plant-slot, .monster, .btn {
            transform: translateZ(0);
            will-change: transform;
        }
        
        /* ë°°í„°ë¦¬ ì ˆì•½ ëª¨ë“œ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        .power-save-mode .stars,
        .power-save-mode .star,
        .power-save-mode .lightning,
        .power-save-mode .particle {
            display: none !important;
        }
        
        /* ë°°ê²½ ì• ë‹ˆë©”ì´ì…˜ */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
        .game-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 1;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .game-container {
                max-width: 100%;
                padding: 10px;
            }
            
            /* í•¸ë“œ ì¹´ë“œ í•˜ë‹¨ ê³ ì • */
            .hand-section {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(10, 14, 26, 0.98);
                padding: 10px;
                z-index: 200;
                border-top: 3px solid var(--accent-gold);
                box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.8);
            }
            
            /* ë©”ì¸ ì»¨í…ì¸  ìŠ¤í¬ë¡¤ */
            .main-content {
                padding-bottom: 180px;
                overflow-y: auto;
                height: calc(100vh - 60px);
            }
            
            /* í„°ì¹˜ íƒ€ê²Ÿ í™•ëŒ€ */
            .btn {
                padding: 15px 20px;
                font-size: 1em;
                min-height: 50px;
            }
            
            .card {
                min-width: 80px;
            }
            
            .tab {
                padding: 15px 8px;
                font-size: 0.9em;
            }
        }
        
        /* ì„¸ë¡œ ëª¨ë“œ */
        @media (orientation: portrait) and (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .hand {
                grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
                gap: 8px;
            }
            
            .controls {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }
        
        /* ê°€ë¡œ ëª¨ë“œ */
        @media (orientation: landscape) and (max-height: 500px) {
            .game-container {
                display: grid;
                grid-template-columns: 1.5fr 1fr;
                gap: 10px;
                max-width: 100%;
                padding: 10px;
            }
            
            .main-content {
                overflow-y: auto;
                max-height: calc(100vh - 20px);
            }
            
            .hand-section {
                position: relative;
            }
        }
        
        /* ì‘ì€ í™”ë©´ (ì•„ì´í° SE) */
        @media (max-width: 375px) {
            .card {
                font-size: 0.85em;
            }
            
            .plant-slot {
                font-size: 1.3em;
            }
            
            .stat-value {
                font-size: 1.1em;
            }
            
            h1 {
                font-size: 1.5em;
            }
        }
        
        /* íƒœë¸”ë¦¿ */
        @media (min-width: 769px) {
            .game-container {
                max-width: 600px;
            }
            
            .hand {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }
        
        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 25px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(168, 85, 247, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        h1 {
            font-family: 'Righteous', cursive;
            font-size: 2em;
            text-align: center;
            background: linear-gradient(45deg, #ffd700, #ff1493, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8)); }
            50% { filter: drop-shadow(0 0 30px rgba(255, 215, 0, 1)); }
        }
        
        .subtitle {
            text-align: center;
            font-size: 0.9em;
            color: var(--accent-green);
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        /* ìŠ¤íƒ¯ ë°” */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(36, 52, 71, 0.9), rgba(26, 35, 50, 0.9));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
        }
        
        .stat-label {
            font-size: 0.7em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-green), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ìŠ¤í† ë¦¬ ì„¹ì…˜ */
        .story-banner {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(59, 130, 246, 0.3));
            border: 2px solid rgba(168, 85, 247, 0.5);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .story-banner:hover {
            transform: scale(1.02);
            box-shadow: 0 15px 40px rgba(168, 85, 247, 0.6);
        }
        
        .chapter-label {
            font-size: 0.8em;
            color: var(--accent-purple);
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .chapter-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .chapter-desc {
            font-size: 0.85em;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* ê¸°ì°¨ ì‹œìŠ¤í…œ */
        .train-container {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(101, 67, 33, 0.3));
            border: 3px solid rgba(255, 215, 0, 0.4);
            border-radius: 25px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .floor {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .floor-label {
            position: absolute;
            top: -12px;
            left: 15px;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-pink));
            color: #000;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
        }
        
        .plant-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .plant-slot {
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(0, 100, 0, 0.2));
            border: 2px solid rgba(34, 139, 34, 0.5);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .plant-slot:hover {
            transform: scale(1.1) rotate(5deg);
            border-color: var(--accent-gold);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
        }
        
        .plant-slot.empty {
            border-style: dashed;
            opacity: 0.5;
        }
        
        .plant-slot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.5), transparent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s;
        }
        
        .plant-slot:hover::before {
            width: 200%;
            height: 200%;
        }
        
        .plant-level {
            position: absolute;
            top: 3px;
            right: 3px;
            background: var(--accent-gold);
            color: #000;
            padding: 2px 5px;
            border-radius: 8px;
            font-size: 0.35em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.8);
        }
        
        .plant-hp-bar {
            position: absolute;
            bottom: 3px;
            left: 3px;
            right: 3px;
            height: 5px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .plant-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc66);
            transition: width 0.5s;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
        }
        
        /* ëª¬ìŠ¤í„° ì›¨ì´ë¸Œ */
        .wave-section {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(85, 0, 0, 0.3));
            border: 3px solid rgba(255, 0, 0, 0.5);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .wave-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #ff4444;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.8);
        }
        
        .monsters {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .monster {
            font-size: 2.5em;
            position: relative;
            animation: float 2s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(255, 0, 0, 0.6));
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .monster:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 10px 30px rgba(255, 0, 0, 1));
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .monster-hp {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(139, 0, 0, 0.95);
            border: 2px solid #ff0000;
            border-radius: 8px;
            padding: 2px 8px;
            font-size: 0.3em;
            color: #fff;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.8);
        }
        
        /* ì¹´ë“œ í•¸ë“œ */
        .hand-section {
            margin-bottom: 20px;
        }
        
        .sun-display {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 140, 0, 0.3));
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }
        
        .sun-amount {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .hand {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }
        
        .card {
            background: linear-gradient(135deg, rgba(45, 95, 53, 0.9), rgba(26, 58, 27, 0.9));
            border: 3px solid rgba(34, 139, 34, 0.6);
            border-radius: 15px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-20px) scale(1.05);
            border-color: var(--accent-gold);
            box-shadow: 0 20px 50px rgba(0, 255, 136, 0.8);
            z-index: 10;
        }
        
        .card.selected {
            transform: translateY(-15px) scale(1.08);
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(58, 125, 68, 0.9), rgba(45, 95, 53, 0.9));
            box-shadow: 0 25px 60px rgba(255, 215, 0, 1);
        }
        
        .card.hybrid {
            border-color: var(--accent-purple);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.4), rgba(139, 69, 139, 0.4));
        }
        
        .card.legendary {
            border-color: var(--accent-pink);
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.4), rgba(190, 24, 93, 0.4));
            animation: legendary-glow 2s infinite;
            position: relative;
            overflow: visible;
        }
        
        .card.legendary::before {
            content: 'â­';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 1.5em;
            animation: spin 3s linear infinite;
            filter: drop-shadow(0 0 10px #ffd700);
        }
        
        .card.legendary::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.3), transparent 70%);
            pointer-events: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes legendary-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.8), 0 0 40px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(236, 72, 153, 1), 0 0 80px rgba(255, 215, 0, 0.8); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .card-cost {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--accent-gold);
            color: #000;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.8);
        }
        
        .card-icon {
            font-size: 2.5em;
            text-align: center;
            margin: 10px 0;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.8));
        }
        
        .card-name {
            text-align: center;
            font-weight: bold;
            font-size: 0.85em;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .card-stats {
            display: flex;
            justify-content: space-around;
            font-size: 0.75em;
            color: var(--accent-green);
            margin-bottom: 5px;
        }
        
        .card-genes {
            font-size: 0.6em;
            text-align: center;
            color: var(--accent-gold);
            letter-spacing: 2px;
        }
        
        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.8), rgba(101, 67, 33, 0.8));
            border: 3px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s;
        }
        
        .btn:hover::before {
            width: 300%;
            height: 300%;
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.6);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.8), rgba(26, 107, 26, 0.8));
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
        
        /* íƒ­ */
        .tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .tab {
            background: rgba(26, 35, 50, 0.6);
            border: 2px solid rgba(139, 69, 19, 0.5);
            color: var(--text-secondary);
            padding: 12px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }
        
        .tab:hover {
            border-color: var(--accent-gold);
            transform: translateY(-3px);
        }
        
        .tab.active {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.9), rgba(101, 67, 33, 0.9));
            border-color: var(--accent-gold);
            color: var(--accent-gold);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }
        
        .tab-content {
            display: none;
            background: rgba(26, 35, 50, 0.6);
            border: 3px solid rgba(139, 69, 19, 0.5);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* í•©ì„±ì†Œ */
        .fusion-lab {
            background: linear-gradient(135deg, rgba(75, 0, 130, 0.4), rgba(138, 43, 226, 0.4));
            border: 3px solid rgba(168, 85, 247, 0.6);
            border-radius: 20px;
            padding: 25px;
        }
        
        .fusion-title {
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            color: var(--accent-purple);
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(168, 85, 247, 0.8);
        }
        
        .fusion-slots {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .fusion-slot {
            background: rgba(0, 0, 0, 0.5);
            border: 3px dashed rgba(168, 85, 247, 0.5);
            border-radius: 20px;
            padding: 20px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fusion-slot:hover {
            border-color: var(--accent-gold);
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.6);
        }
        
        .fusion-slot.filled {
            border-style: solid;
            border-color: var(--accent-gold);
            background: rgba(168, 85, 247, 0.2);
        }
        
        .fusion-arrow {
            font-size: 2.5em;
            color: var(--accent-gold);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        .fusion-result {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.4), rgba(147, 51, 234, 0.4));
            border: 3px solid var(--accent-gold);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
        }
        
        .fusion-preview-icon {
            font-size: 4em;
            margin: 15px 0;
            filter: drop-shadow(0 10px 30px rgba(255, 215, 0, 0.8));
            animation: rotate 3s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .gene-display {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .gene-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--accent-gold);
        }
        
        .gene-grade {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        /* ë„ê° */
        .codex-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .codex-item {
            aspect-ratio: 1;
            background: rgba(36, 52, 71, 0.6);
            border: 2px solid rgba(100, 100, 100, 0.5);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .codex-item:hover {
            transform: scale(1.1);
        }
        
        .codex-item.discovered {
            border-color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.15);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }
        
        .codex-item.locked {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        
        .codex-new-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #ff0000, #ff4444);
            color: #fff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.6em;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.8);
            animation: newBadge 1s infinite;
        }
        
        @keyframes newBadge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* ë©”ì‹œì§€ */
        .message {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 140, 0, 0.3));
            border: 2px solid var(--accent-gold);
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            animation: messageSlide 0.5s;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.success {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(0, 204, 102, 0.3));
        }
        
        /* ë³´ìƒ íŒì—… */
        .reward-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        
        .reward-popup {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.4), rgba(255, 140, 0, 0.4));
            border: 5px solid var(--accent-gold);
            border-radius: 30px;
            padding: 40px;
            text-align: center;
            max-width: 350px;
            backdrop-filter: blur(20px);
            box-shadow: 0 30px 80px rgba(255, 215, 0, 0.8);
            animation: popupBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes popupBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .reward-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: spin 1s ease-in-out;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg) scale(0); }
            to { transform: rotate(360deg) scale(1); }
        }
        
        .reward-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #000;
            margin-bottom: 10px;
        }
        
        .reward-text {
            font-size: 1.1em;
            color: #333;
            font-weight: bold;
        }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-pink));
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        /* ë ˆë²¨ì—… ì´í™íŠ¸ */
        .levelup-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8em;
            font-weight: bold;
            color: var(--accent-gold);
            text-shadow: 0 0 50px rgba(255, 215, 0, 1);
            pointer-events: none;
            z-index: 2000;
            animation: levelupAnim 1.5s forwards;
        }
        
        @keyframes levelupAnim {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); opacity: 0; }
        }
        
        /* PWA ì„¤ì¹˜ ë²„íŠ¼ */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-pink));
            color: #000;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            z-index: 6000;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
            animation: pulse 2s infinite;
            display: none;
        }
        
        .install-prompt.show {
            display: block;
        }
        
        /* í„°ì¹˜ í”¼ë“œë°± */
        .touch-feedback {
            position: fixed;
            width: 50px;
            height: 50px;
            border: 3px solid var(--accent-gold);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            animation: touchRipple 0.6s forwards;
        }
        
        @keyframes touchRipple {
            from { transform: scale(0); opacity: 1; }
            to { transform: scale(2); opacity: 0; }
        }
        
        /* í–…í‹± í”¼ë“œë°± í‘œì‹œ */
        .vibrate-icon {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            z-index: 1000;
            font-size: 1.5em;
        }
        
        /* ë°°í„°ë¦¬ í‘œì‹œ */
        .battery-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.8em;
            color: var(--accent-green);
            z-index: 1000;
        }
        
        .battery-indicator.low {
            color: #ff0000;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ë ˆì „ë“œ í•©ì„± ì¶•í•˜ */
        .legend-celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3), transparent);
            pointer-events: none;
            z-index: 3000;
            animation: legendCelebrate 2s forwards;
        }
        
        @keyframes legendCelebrate {
            0% { opacity: 0; }
            20% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .legend-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 50px #ffd700, 0 0 100px #ff0000;
            pointer-events: none;
            z-index: 3001;
            animation: legendText 2s forwards;
        }
        
        @keyframes legendText {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
        }
        
        /* ë³´ìŠ¤ ë¹™ì˜ ì„ íƒ UI */
        .possession-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            animation: fadeIn 0.5s;
        }
        
        .possession-panel {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(75, 0, 130, 0.9));
            border: 5px solid #ffd700;
            border-radius: 30px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 30px 80px rgba(255, 0, 0, 0.8);
        }
        
        .possession-title {
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ffd700;
        }
        
        .possession-desc {
            text-align: center;
            color: #fff;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .possession-choices {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .possession-choice {
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .possession-choice:hover {
            transform: scale(1.1);
            border-color: #ffd700;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.8);
        }
        
        .possession-choice.selected {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.2);
            transform: scale(1.1);
        }
        
        .boss-warning {
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid #ff0000;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* ë³´ìŠ¤ ë“±ì¥ ì—°ì¶œ */
        .boss-intro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bossIntro 3s forwards;
        }
        
        @keyframes bossIntro {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .boss-intro-content {
            text-align: center;
            animation: bossAppear 3s;
        }
        
        @keyframes bossAppear {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .lightning {
            position: fixed;
            width: 2px;
            height: 100%;
            background: linear-gradient(to bottom, transparent, #fff, transparent);
            animation: lightning 0.1s;
            z-index: 5001;
        }
        
        @keyframes lightning {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- ë°°ê²½ ë³„ -->
    <div class="stars" id="stars"></div>
    
    <!-- ë°°í„°ë¦¬ í‘œì‹œ -->
    <div class="battery-indicator" id="battery">ğŸ”‹ 100%</div>
    
    <!-- ì§„ë™ í† ê¸€ -->
    <div class="vibrate-icon" id="vibrateToggle" onclick="toggleVibration()">ğŸ“³</div>
    
    <!-- PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ -->
    <div class="install-prompt" id="installPrompt" onclick="installApp()">
        ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°
    </div>
    
    <div class="game-container">
        <div class="main-content">
        <!-- í—¤ë” -->
        <div class="header">
            <h1>ğŸŒº ëª¬ìŠ¤í„° ê°€ë“  íŠ¸ë ˆì¸ ğŸš‚</h1>
            <div class="subtitle">â˜… ULTIMATE EDITION â˜…</div>
        </div>
        
        <!-- ìŠ¤íƒ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ğŸ’° ê³¨ë“œ</div>
                <div class="stat-value" id="gold">5000</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ´ ë±</div>
                <div class="stat-value" id="deckSize">15</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸŒŠ ì›¨ì´ë¸Œ</div>
                <div class="stat-value" id="wave">1</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ğŸ“– ë„ê°</div>
                <div class="stat-value" id="codexPercent">0.8%</div>
            </div>
        </div>
        
        <!-- ë©”ì‹œì§€ -->
        <div class="message" id="msg">ğŸŒŸ ì „ì„¤ì˜ ì •ì›ì‚¬ì—¬, ìƒëª…ì˜ ì •ì›ì„ ë³µì›í•˜ë¼!</div>
        
        <!-- ìŠ¤í† ë¦¬ ë°°ë„ˆ -->
        <div class="story-banner" onclick="showStory()">
            <div class="chapter-label">ğŸ“œ Chapter <span id="chapter">1</span> - ì‹œì‘ì˜ ìˆ²</div>
            <div class="chapter-title">ìƒëª…ì˜ ì”¨ì•—ì„ ì°¾ì•„ì„œ</div>
            <div class="chapter-desc">
                ì–´ë‘ ì— ì ê¸´ ì„¸ê³„... ë‹¹ì‹ ì€ ë§ˆë²• ê¸°ì°¨ë¥¼ íƒ€ê³  ì „ì„¤ì˜ ì •ì›ì„ ì°¾ì•„ ë– ë‚œë‹¤.
            </div>
        </div>
        
        <!-- ëª¬ìŠ¤í„° ì›¨ì´ë¸Œ -->
        <div class="wave-section">
            <div class="wave-title">ğŸ‘¹ ëª¬ìŠ¤í„° ì›¨ì´ë¸Œ <span id="waveNum">1</span>/10</div>
            <div class="monsters" id="monsters"></div>
        </div>
        
        <!-- ê¸°ì°¨ -->
        <div class="train-container">
            <div class="floor">
                <div class="floor-label">3ì¸µ â˜€ï¸+50%</div>
                <div class="plant-grid" id="floor3"></div>
            </div>
            <div class="floor">
                <div class="floor-label">2ì¸µ ì¤‘ë¦½</div>
                <div class="plant-grid" id="floor2"></div>
            </div>
            <div class="floor">
                <div class="floor-label">1ì¸µ ğŸ›¡ï¸+30%</div>
                <div class="plant-grid" id="floor1"></div>
            </div>
        </div>
        
        <!-- í–‡ë¹› -->
        <div class="sun-display">
            â˜€ï¸ í–‡ë¹›: <span class="sun-amount" id="sun">5</span> / 10
        </div>
        
        <!-- ì¹´ë“œ í•¸ë“œ -->
        <div class="hand-section">
            <div class="hand" id="hand"></div>
        </div>
        
        <!-- ì»¨íŠ¸ë¡¤ -->
        <div class="controls">
            <button class="btn btn-primary" onclick="startWave()">â–¶ï¸ ì‹œì‘</button>
            <button class="btn" onclick="drawCard()">ğŸ´ ë“œë¡œìš°</button>
            <button class="btn" onclick="endTurn()">â­ï¸ ì¢…ë£Œ</button>
        </div>
        
        <!-- íƒ­ -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('deck')">ğŸ´ë±</div>
            <div class="tab" onclick="showTab('fusion')">ğŸ§¬í•©ì„±</div>
            <div class="tab" onclick="showTab('codex')">ğŸ“–ë„ê°</div>
            <div class="tab" onclick="showTab('shop')">ğŸ›’ìƒì </div>
        </div>
        
        <!-- ë± íƒ­ -->
        <div class="tab-content active" id="deck-tab">
            <h3 style="color: var(--accent-gold); margin-bottom: 15px; text-align: center;">
                ğŸ´ ë‚´ ë± (<span id="deckCount">15</span>ì¥)
            </h3>
            <div id="deckList"></div>
        </div>
        
        <!-- í•©ì„± íƒ­ -->
        <div class="tab-content" id="fusion-tab">
            <div class="fusion-lab">
                <div class="fusion-title">ğŸ§¬ ìœ ì „ì í•©ì„±ì†Œ</div>
                
                <div class="fusion-slots">
                    <div class="fusion-slot" id="slot1" onclick="selectSlot(1)">
                        <div style="color: var(--accent-purple); font-size: 0.9em; margin-bottom: 10px;">ë¶€ëª¨ 1</div>
                        <div id="slot1Display">í´ë¦­í•˜ì—¬ ì„ íƒ</div>
                    </div>
                    
                    <div class="fusion-arrow">â•</div>
                    
                    <div class="fusion-slot" id="slot2" onclick="selectSlot(2)">
                        <div style="color: var(--accent-purple); font-size: 0.9em; margin-bottom: 10px;">ë¶€ëª¨ 2</div>
                        <div id="slot2Display">í´ë¦­í•˜ì—¬ ì„ íƒ</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <div class="fusion-arrow" style="transform: rotate(90deg);">â¬‡ï¸</div>
                </div>
                
                <div class="fusion-result">
                    <div style="color: var(--accent-gold); font-weight: bold; margin-bottom: 10px;">
                        ğŸ”® ì˜ˆìƒ ê²°ê³¼
                    </div>
                    <div class="fusion-preview-icon" id="previewIcon">â“</div>
                    <div id="previewName" style="font-size: 1.2em; font-weight: bold; margin-bottom: 15px;">???</div>
                    
                    <div class="gene-display" id="genePreview">
                        <div style="color: var(--accent-purple); text-align: center;">
                            ë¶€ëª¨ë¥¼ ì„ íƒí•˜ì„¸ìš”
                        </div>
                    </div>
                    
                    <div style="color: #ff4444; font-size: 0.85em; margin: 15px 0;">
                        âš¡ ëŒì—°ë³€ì´ í™•ë¥ : 10%
                    </div>
                    
                    <button class="btn btn-primary" onclick="doFusion()" style="width: 100%;">
                        âš—ï¸ í•©ì„±í•˜ê¸° (100G)
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ë„ê° íƒ­ -->
        <div class="tab-content" id="codex-tab">
            <h3 style="color: var(--accent-gold); margin-bottom: 15px; text-align: center;">
                ğŸ“– ì‹ë¬¼ ëŒ€ë„ê°
            </h3>
            
            <div style="background: rgba(255,215,0,0.15); border: 2px solid var(--accent-gold); border-radius: 12px; padding: 12px; margin-bottom: 15px;">
                <div style="color: var(--accent-green); margin-bottom: 8px;">
                    ë°œê²¬: <span id="codexFound">8</span> / 999 (<span id="codexPct">0.8</span>%)
                </div>
                <div style="font-size: 0.85em; color: var(--text-secondary);">
                    ğŸ 10ì¢…: 100G | 50ì¢…: 500G | 100ì¢…: ì¹­í˜¸
                </div>
            </div>
            
            <div class="codex-grid" id="codexGrid"></div>
        </div>
        
        <!-- ìƒì  íƒ­ -->
        <div class="tab-content" id="shop-tab">
            <h3 style="color: var(--accent-gold); margin-bottom: 15px; text-align: center;">
                ğŸ›’ ì”¨ì•— ìƒì 
            </h3>
            
            <div style="background: rgba(0,255,136,0.15); border: 2px solid var(--accent-green); border-radius: 15px; padding: 15px; margin-bottom: 15px;">
                <div style="color: var(--accent-green); font-weight: bold; text-align: center; margin-bottom: 12px;">
                    âœ¨ ì¹´ë“œ ëŒ€ëŸ‰ íšë“!
                </div>
                <button class="btn" onclick="buyCard()" style="width: 100%; margin-bottom: 8px;">
                    ëœë¤ ì”¨ì•— (10G)
                </button>
                <button class="btn" onclick="buyPack()" style="width: 100%; margin-bottom: 8px;">
                    ì”¨ì•— íŒ© 5ì¥ (40G)
                </button>
                <button class="btn btn-primary" onclick="buyRare()" style="width: 100%;">
                    ë ˆì–´ ì”¨ì•— (50G)
                </button>
            </div>
            
            <div style="background: rgba(168,85,247,0.15); border: 2px solid var(--accent-purple); border-radius: 15px; padding: 15px;">
                <div style="color: var(--accent-purple); font-weight: bold; text-align: center; margin-bottom: 12px;">
                    ğŸ’ ë ˆì „ë”ë¦¬ ìƒì 
                </div>
                <button class="btn" onclick="buyLegendary()" style="width: 100%;">
                    ë ˆì „ë”ë¦¬ ì”¨ì•— (200G)
                </button>
            </div>
        </div>
        </div>
    </div>
    </div>

    <script>
        // ==================== ê²Œì„ ë°ì´í„° ====================
        const G = {
            gold: 5000,
            sun: 5,
            maxSun: 10,
            wave: 1,
            chapter: 1,
            turn: 0,
            
            deck: [],
            hand: [],
            train: {
                floor1: Array(5).fill(null),
                floor2: Array(5).fill(null),
                floor3: Array(5).fill(null)
            },
            
            monsters: [],
            selectedCard: null,
            fusionSlots: [null, null],
            selectingSlot: null,
            
            codex: new Set(),
            newDiscoveries: new Set(),
            
            battle: false,
            battleInterval: null,
            
            // ì‹œê°„ ì„±ì¥ ì‹œìŠ¤í…œ
            lastSaveTime: Date.now(),
            offlineGrowth: 0,
            
            // âœ¨ ìƒˆë¡œìš´ ì‹œìŠ¤í…œ
            bossSoul: null, // íšë“í•œ ë³´ìŠ¤ ì˜í˜¼
            possessionTarget: null, // ë¹™ì˜ ëŒ€ìƒ
            userBosses: [], // ìœ ì €ê°€ ë§Œë“  ë³´ìŠ¤ë“¤
            legendCount: 0, // ë ˆì „ë“œ íšë“ ìˆ˜
            bossKills: 0, // ë³´ìŠ¤ ì²˜ì¹˜ ìˆ˜
            
            // ğŸ“± ëª¨ë°”ì¼ ì„¤ì •
            vibrationEnabled: true,
            powerSaveMode: false,
            touchFeedback: true
        };
        
        // ëª¨ë°”ì¼ ê°ì§€
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);

        // ìœ ì „ì ë“±ê¸‰
        const GRADES = ['F', 'E', 'D', 'C', 'B', 'A', 'S', 'SS', 'SSS'];
        
        function gradeColor(grade) {
            const colors = {
                'F': '#666', 'E': '#888', 'D': '#aaa',
                'C': '#00ff88', 'B': '#00ccff', 'A': '#ff00ff',
                'S': '#ffd700', 'SS': '#ff8c00', 'SSS': '#ff0000'
            };
            return colors[grade] || '#fff';
        }

        // ì‹ë¬¼ ë°ì´í„°ë² ì´ìŠ¤ (í™•ì¥!)
        const PLANTS = {
            sunflower: {
                id: 'sunflower', name: 'í•´ë°”ë¼ê¸°', icon: 'ğŸŒ»', cost: 2,
                genes: { attack: 'B', defense: 'C', speed: 'B', special: 'S', growth: 'A' },
                attackType: 'projectile', hp: 100, atk: 15, special: 'sun', rarity: 'common'
            },
            cactus: {
                id: 'cactus', name: 'ì„ ì¸ì¥', icon: 'ğŸŒµ', cost: 2,
                genes: { attack: 'A', defense: 'B', speed: 'C', special: 'B', growth: 'B' },
                attackType: 'projectile', hp: 120, atk: 20, special: 'pierce', rarity: 'common'
            },
            rose: {
                id: 'rose', name: 'ì¥ë¯¸', icon: 'ğŸŒ¹', cost: 3,
                genes: { attack: 'A', defense: 'C', speed: 'B', special: 'A', growth: 'B' },
                attackType: 'aoe', hp: 80, atk: 25, special: 'thorns', rarity: 'uncommon'
            },
            tree: {
                id: 'tree', name: 'ë‚˜ë¬´', icon: 'ğŸŒ³', cost: 4,
                genes: { attack: 'C', defense: 'S', speed: 'D', special: 'B', growth: 'C' },
                attackType: 'melee', hp: 300, atk: 10, special: 'tank', rarity: 'common'
            },
            mushroom: {
                id: 'mushroom', name: 'ë…ë²„ì„¯', icon: 'ğŸ„', cost: 2,
                genes: { attack: 'B', defense: 'D', speed: 'C', special: 'S', growth: 'A' },
                attackType: 'projectile', hp: 60, atk: 15, special: 'poison', rarity: 'uncommon'
            },
            lily: {
                id: 'lily', name: 'ë°±í•©', icon: 'ğŸŒ¸', cost: 3,
                genes: { attack: 'C', defense: 'B', speed: 'A', special: 'S', growth: 'A' },
                attackType: 'projectile', hp: 90, atk: 18, special: 'heal', rarity: 'rare'
            },
            tulip: {
                id: 'tulip', name: 'íŠ¤ë¦½', icon: 'ğŸŒ·', cost: 2,
                genes: { attack: 'B', defense: 'C', speed: 'A', special: 'A', growth: 'S' },
                attackType: 'projectile', hp: 85, atk: 22, special: 'speed', rarity: 'uncommon'
            },
            lotus: {
                id: 'lotus', name: 'ì—°ê½ƒ', icon: 'ğŸª·', cost: 4,
                genes: { attack: 'C', defense: 'A', speed: 'C', special: 'SS', growth: 'B' },
                attackType: 'aoe', hp: 150, atk: 20, special: 'support', rarity: 'rare'
            }
        };

        // ëª¬ìŠ¤í„°
        const MONSTERS = [
            { id: 'slime', icon: 'ğŸŸ¢', hp: 50, atk: 5, gold: 25 },
            { id: 'goblin', icon: 'ğŸ‘¹', hp: 100, atk: 10, gold: 50 },
            { id: 'orc', icon: 'ğŸ‘º', hp: 200, atk: 15, gold: 100 },
            { id: 'dragon', icon: 'ğŸ‰', hp: 500, atk: 30, gold: 300 },
            { id: 'demon', icon: 'ğŸ˜ˆ', hp: 800, atk: 50, gold: 500 }
        ];
        
        // ì±•í„° ë³´ìŠ¤ (10 ì›¨ì´ë¸Œë§ˆë‹¤ ì¶œí˜„)
        const CHAPTER_BOSSES = [
            { id: 'boss1', icon: 'ğŸ‘‘', name: 'ìŠ¬ë¼ì„ í‚¹', hp: 1000, atk: 50, gold: 1000, chapter: 1 },
            { id: 'boss2', icon: 'ğŸ”¥', name: 'í™”ì—¼ ì˜¤ìš°ê±°', hp: 3000, atk: 100, gold: 3000, chapter: 2 },
            { id: 'boss3', icon: 'â„ï¸', name: 'ì–¼ìŒ ê±°ì¸', hp: 8000, atk: 200, gold: 8000, chapter: 3 },
            { id: 'boss4', icon: 'ğŸŒ‹', name: 'ìš©ì•” íƒ€ì´íƒ„', hp: 20000, atk: 500, gold: 20000, chapter: 4 },
            { id: 'boss5', icon: 'ğŸ’€', name: 'ì£½ìŒì˜ êµ°ì£¼', hp: 50000, atk: 1000, gold: 50000, chapter: 5 }
        ];
        
        // ë ˆì „ë“œ ì „ìš© ìŠ¤í‚¬
        const LEGEND_SKILLS = [
            { id: 'apocalypse', name: 'ì²œì§€ê°œë²½', desc: 'ëª¨ë“  ì  999 ë°ë¯¸ì§€', dmg: 999, cooldown: 60 },
            { id: 'phoenix', name: 'ë¶ˆì‚¬ì¡°ì˜ ë‚ ê°œ', desc: '1íšŒ ë¶€í™œ', effect: 'revive' },
            { id: 'timestop', name: 'ì‹œê°„ ì •ì§€', desc: '5ì´ˆê°„ ì  ì •ì§€', effect: 'freeze', duration: 5 },
            { id: 'judgment', name: 'ìš°ì£¼ì˜ ì‹¬íŒ', desc: 'ì „ì²´ ê³ ì • 999', dmg: 999, aoe: true },
            { id: 'infinite', name: 'ë¬´í•œ ì¬ìƒ', desc: 'ì´ˆë‹¹ HP 10% íšŒë³µ', effect: 'regen' }
        ];

        // ì±•í„° ìŠ¤í† ë¦¬
        const CHAPTERS = [
            { num: 1, title: 'ì‹œì‘ì˜ ìˆ²', desc: 'ìƒëª…ì˜ ì”¨ì•—ì„ ì°¾ì•„ì„œ...', region: 'forest' },
            { num: 2, title: 'ë¶ˆíƒ€ëŠ” ì‚¬ë§‰', desc: 'íƒœì–‘ì˜ ê½ƒì´ í”¼ëŠ” ê³³', region: 'desert' },
            { num: 3, title: 'ì–¼ìŒ ì •ì›', desc: 'ì–¼ì–´ë¶™ì€ ìƒëª…', region: 'ice' },
            { num: 4, title: 'í™”ì‚°ì˜ ì‹¬ì¥', desc: 'ìš©ì•” ì† ë¹„ë°€', region: 'volcano' },
            { num: 5, title: 'ì„¸ê³„ìˆ˜', desc: 'ì „ì„¤ì˜ ì •ì›ì„ ì°¾ì•˜ë‹¤!', region: 'final' }
        ];

        // ==================== ì´ˆê¸°í™” ====================
        function init() {
            // ë°°ê²½ ë³„ ìƒì„±
            createStars();
            
            // ì‹œì‘ ë±
            for (let i = 0; i < 3; i++) {
                G.deck.push(createPlant('sunflower'));
                G.deck.push(createPlant('cactus'));
            }
            for (let i = 0; i < 2; i++) {
                G.deck.push(createPlant('rose'));
                G.deck.push(createPlant('tree'));
                G.deck.push(createPlant('mushroom'));
            }

            // ë„ê° ë“±ë¡
            Object.keys(PLANTS).forEach(id => G.codex.add(id));

            // ì´ˆê¸° í•¸ë“œ
            for (let i = 0; i < 5; i++) drawCard();

            spawnMonsters();
            checkOfflineProgress();
            updateAll();
        }

        function createStars() {
            const stars = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                stars.appendChild(star);
            }
        }

        function createPlant(id) {
            const t = PLANTS[id];
            if (!t) return null;
            return {
                ...t,
                uid: Date.now() + Math.random(),
                level: 1,
                exp: 0,
                currHp: t.hp,
                maxHp: t.hp,
                battleCount: 0,
                createdAt: Date.now()
            };
        }

        function createHybrid(p1, p2) {
            const genes = {};
            const rand = Math.random();
            
            // ğŸŒŸ 1% ë ˆì „ë“œ í™•ë¥ !
            const isLegendary = rand < 0.01;
            const isEnhanced = !isLegendary && rand < 0.11; // 10% ê°•í™”
            
            if (isLegendary) {
                // âœ¨ ë ˆì „ë“œ! ëª¨ë“  ìœ ì „ì SSS
                Object.keys(p1.genes).forEach(gene => {
                    genes[gene] = 'SSS';
                });
            } else if (isEnhanced) {
                // ğŸ’ ê°•í™” í•©ì„± (+1ë“±ê¸‰)
                Object.keys(p1.genes).forEach(gene => {
                    const g1 = GRADES.indexOf(p1.genes[gene]);
                    const g2 = GRADES.indexOf(p2.genes[gene]);
                    const higher = Math.max(g1, g2);
                    const enhanced = Math.min(higher + 1, GRADES.length - 1);
                    genes[gene] = GRADES[enhanced];
                });
            } else {
                // ì¼ë°˜ í•©ì„±
                Object.keys(p1.genes).forEach(gene => {
                    const g1 = GRADES.indexOf(p1.genes[gene]);
                    const g2 = GRADES.indexOf(p2.genes[gene]);
                    
                    const r = Math.random();
                    if (r < 0.1) {
                        // ëŒì—°ë³€ì´
                        genes[gene] = GRADES[Math.floor(Math.random() * GRADES.length)];
                    } else if (r < 0.3) {
                        // ì¡°í•©
                        const avg = Math.floor((g1 + g2) / 2);
                        genes[gene] = GRADES[Math.min(avg, GRADES.length - 1)];
                    } else {
                        // ìš°ì„±
                        genes[gene] = g1 > g2 ? p1.genes[gene] : p2.genes[gene];
                    }
                });
            }

            // ëŠ¥ë ¥ ì¡°í•©
            let attackType = p1.attackType;
            if (p1.attackType === 'projectile' && p2.attackType === 'aoe') {
                attackType = 'explosive';
            } else if (p1.attackType === 'melee' && p2.attackType === 'melee') {
                attackType = 'heavy';
            }

            const hybridId = p1.id + '_x_' + p2.id + '_' + Date.now();
            const hybridName = p1.name.charAt(0) + p2.name;
            const hybridIcon = Math.random() < 0.5 ? p1.icon : p2.icon;

            // ìŠ¤íƒ¯ ê³„ì‚°
            const statMultiplier = isLegendary ? 3 : isEnhanced ? 1.5 : 1.3;
            
            const hybrid = {
                id: hybridId,
                name: isLegendary ? 'â˜…' + hybridName + 'â˜…' : hybridName,
                icon: hybridIcon,
                cost: Math.max(1, Math.floor((p1.cost + p2.cost) / 2)),
                genes: genes,
                attackType: attackType,
                hp: Math.floor((p1.hp + p2.hp) / 2 * statMultiplier),
                atk: Math.floor((p1.atk + p2.atk) / 2 * statMultiplier),
                special: p1.special || p2.special,
                rarity: isLegendary ? 'legendary' : isEnhanced ? 'rare' : 'hybrid',
                parents: [p1.id, p2.id],
                isLegendary: isLegendary,
                legendSkill: isLegendary ? LEGEND_SKILLS[Math.floor(Math.random() * LEGEND_SKILLS.length)] : null
            };

            const isNew = !G.codex.has(hybridId);
            G.codex.add(hybridId);
            
            if (isLegendary) {
                G.legendCount++;
                showLegendCelebration();
                showReward('ğŸŒŸ ë ˆì „ë“œ íƒ„ìƒ! ğŸŒŸ', `${hybrid.icon} ${hybrid.name}\nìŠ¤í‚¬: ${hybrid.legendSkill.name}`);
            } else if (isNew) {
                G.newDiscoveries.add(hybridId);
                if (!isEnhanced) {
                    showReward('ğŸ†• ì‹ ì¢… ë°œê²¬!', `${hybrid.icon} ${hybrid.name}`);
                } else {
                    showReward('ğŸ’ ê°•í™” í•©ì„±!', `${hybrid.icon} ${hybrid.name} (ìŠ¤íƒ¯ 1.5ë°°)`);
                }
                checkCodexRewards();
            }

            if (!PLANTS[hybridId]) {
                PLANTS[hybridId] = hybrid;
            }

            return createPlant(hybridId);
        }
        
        function showLegendCelebration() {
            // ê°•í•œ ì§„ë™!
            vibrate([100, 50, 100, 50, 200, 100, 300]);
            
            // í™©ê¸ˆë¹› ë°°ê²½
            const celebration = document.createElement('div');
            celebration.className = 'legend-celebration';
            document.body.appendChild(celebration);
            
            // LEGEND í…ìŠ¤íŠ¸
            const text = document.createElement('div');
            text.className = 'legend-text';
            text.textContent = 'â­ LEGEND! â­';
            document.body.appendChild(text);
            
            // ë²ˆê°œ íš¨ê³¼
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const lightning = document.createElement('div');
                    lightning.className = 'lightning';
                    lightning.style.left = Math.random() * 100 + '%';
                    document.body.appendChild(lightning);
                    setTimeout(() => lightning.remove(), 100);
                }, i * 200);
            }
            
            setTimeout(() => {
                celebration.remove();
                text.remove();
            }, 2000);
        }

        function checkCodexRewards() {
            const count = G.codex.size;
            if (count === 10 && !G.rewards10) {
                G.rewards10 = true;
                G.gold += 100;
                showReward('ğŸ ë„ê° ë³´ìƒ!', '10ì¢… ë°œê²¬: 100G!');
            } else if (count === 50 && !G.rewards50) {
                G.rewards50 = true;
                G.gold += 500;
                showReward('ğŸ ë„ê° ë³´ìƒ!', '50ì¢… ë°œê²¬: 500G!');
            }
        }

        function checkOfflineProgress() {
            const now = Date.now();
            const elapsed = (now - G.lastSaveTime) / 1000; // ì´ˆ
            const hours = Math.floor(elapsed / 3600);
            
            if (hours > 0) {
                const offlineGold = hours * 50;
                const offlineCards = hours * 2;
                
                G.gold += offlineGold;
                for (let i = 0; i < offlineCards; i++) {
                    const ids = Object.keys(PLANTS);
                    const randomId = ids[Math.floor(Math.random() * ids.length)];
                    G.deck.push(createPlant(randomId));
                }
                
                showReward('â° ì˜¤í”„ë¼ì¸ ë³´ìƒ!', `${hours}ì‹œê°„: ${offlineGold}G + ì¹´ë“œ ${offlineCards}ì¥!`);
            }
            
            G.lastSaveTime = now;
        }

        // ==================== ì¹´ë“œ ì‹œìŠ¤í…œ ====================
        function drawCard() {
            if (G.deck.length === 0) {
                msg('ë±ì— ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            if (G.hand.length >= 8) {
                msg('í•¸ë“œê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const card = G.deck.pop();
            G.hand.push(card);
            msg(`ğŸ´ ${card.icon} ë“œë¡œìš°!`);
            updateAll();
        }

        function selectCard(i) {
            if (G.selectingSlot !== null) {
                G.fusionSlots[G.selectingSlot] = G.hand[i];
                G.selectingSlot = null;
                vibrate(30);
                showTab('fusion');
                updateAll();
                return;
            }

            G.selectedCard = G.selectedCard === i ? null : i;
            vibrate(10);
            updateAll();
        }

        function playCard(floor, slot) {
            if (G.selectedCard === null) return;
            if (G.train[floor][slot] !== null) return;

            const card = G.hand[G.selectedCard];
            if (G.sun < card.cost) {
                msg('í–‡ë¹›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                return;
            }

            G.sun -= card.cost;
            G.train[floor][slot] = card;
            G.hand.splice(G.selectedCard, 1);
            G.selectedCard = null;

            msg(`${card.icon} ${card.name} ë°°ì¹˜ ì™„ë£Œ!`, 'success');
            updateAll();
        }

        // ==================== í•©ì„± ====================
        function selectSlot(num) {
            G.selectingSlot = num - 1;
            showTab('deck');
            msg('í•©ì„±í•  ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”!');
        }

        function doFusion() {
            if (!G.fusionSlots[0] || !G.fusionSlots[1]) {
                msg('ë¶€ëª¨ ì‹ë¬¼ 2ê°œë¥¼ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }
            if (G.gold < 100) {
                msg('ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!');
                return;
            }

            G.gold -= 100;
            const hybrid = createHybrid(G.fusionSlots[0], G.fusionSlots[1]);
            G.deck.push(hybrid);
            
            msg(`âœ¨ ${hybrid.icon} ${hybrid.name} íƒ„ìƒ!`, 'success');
            
            G.fusionSlots = [null, null];
            updateAll();
        }

        // ==================== ì „íˆ¬ ====================
        function spawnMonsters() {
            G.monsters = [];
            
            // 10 ì›¨ì´ë¸Œë§ˆë‹¤ ë³´ìŠ¤!
            if (G.wave % 10 === 0 && G.wave <= 50) {
                const bossIndex = Math.min(Math.floor(G.wave / 10) - 1, CHAPTER_BOSSES.length - 1);
                const boss = CHAPTER_BOSSES[bossIndex];
                
                G.monsters.push({
                    ...boss,
                    currHp: boss.hp,
                    maxHp: boss.hp,
                    uid: Date.now(),
                    isBoss: true
                });
                
                showBossIntro(boss);
                return;
            }
            
            const count = Math.min(6, 2 + Math.floor(G.wave / 2));
            const baseMonster = MONSTERS[Math.min(Math.floor(G.wave / 3), MONSTERS.length - 1)];
            
            for (let i = 0; i < count; i++) {
                G.monsters.push({
                    ...baseMonster,
                    currHp: baseMonster.hp * Math.ceil(G.wave / 2),
                    maxHp: baseMonster.hp * Math.ceil(G.wave / 2),
                    uid: Date.now() + Math.random()
                });
            }
        }
        
        function showBossIntro(boss) {
            const intro = document.createElement('div');
            intro.className = 'boss-intro';
            intro.innerHTML = `
                <div class="boss-intro-content">
                    <div style="color: #ff0000; font-size: 2em; margin-bottom: 20px;">âš ï¸ ë³´ìŠ¤ ì¶œí˜„! âš ï¸</div>
                    <div style="font-size: 5em; margin: 20px 0;">${boss.icon}</div>
                    <div style="color: #ffd700; font-size: 2.5em; font-weight: bold; margin-bottom: 10px;">${boss.name}</div>
                    <div style="color: #fff; font-size: 1.2em;">
                        HP: ${boss.hp.toLocaleString()} | ATK: ${boss.atk.toLocaleString()}
                    </div>
                </div>
            `;
            document.body.appendChild(intro);
            
            // ë²ˆê°œ íš¨ê³¼
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const lightning = document.createElement('div');
                    lightning.className = 'lightning';
                    lightning.style.left = Math.random() * 100 + '%';
                    document.body.appendChild(lightning);
                    setTimeout(() => lightning.remove(), 100);
                }, i * 300);
            }
            
            setTimeout(() => intro.remove(), 3000);
        }
        
        function onBossDefeated(boss) {
            G.bossKills++;
            G.bossSoul = boss;
            
            // ë³´ìŠ¤ ì²˜ì¹˜ ì§„ë™
            vibrate([50, 100, 50, 100, 50]);
            
            showReward('ğŸ‘‘ ë³´ìŠ¤ ì²˜ì¹˜!', `${boss.icon} ${boss.name}ì˜ ì˜í˜¼ íšë“!`);
            
            setTimeout(() => {
                showPossessionUI();
            }, 2000);
        }
        
        function showPossessionUI() {
            const overlay = document.createElement('div');
            overlay.className = 'possession-overlay';
            
            // íŒŒí‹°ì—ì„œ ì‹ë¬¼ ì„ íƒ
            const availablePlants = G.train.floor1.concat(G.train.floor2, G.train.floor3)
                .filter(p => p !== null)
                .slice(0, 3);
            
            if (availablePlants.length === 0) {
                showReward('âš ï¸ ê²½ê³ ', 'ë¹™ì˜ì‹œí‚¬ ì‹ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤!');
                G.bossSoul = null;
                return;
            }
            
            overlay.innerHTML = `
                <div class="possession-panel">
                    <div class="possession-title">ğŸ‘¹ ë³´ìŠ¤ ë¹™ì˜</div>
                    <div class="possession-desc">
                        ${G.bossSoul.icon} ${G.bossSoul.name}ì˜ ì˜í˜¼ì„<br>
                        ì–´ë–¤ ì‹ë¬¼ì— ë¹™ì˜ì‹œí‚¬ê¹Œìš”?
                    </div>
                    
                    <div class="possession-choices" id="possessionChoices"></div>
                    
                    <div class="boss-warning">
                        âš ï¸ ì„ íƒí•œ ì‹ë¬¼ì€ ìµœì¢… ë³´ìŠ¤ê°€ ë©ë‹ˆë‹¤!<br>
                        ë‹¤ë¥¸ ìœ ì €ê°€ ë„ì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn" onclick="cancelPossession()" style="width: 100%;">ì·¨ì†Œ</button>
                        <button class="btn btn-primary" onclick="confirmPossession()" style="width: 100%;">ë¹™ì˜!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // ì„ íƒì§€ ë Œë”ë§
            const choices = document.getElementById('possessionChoices');
            availablePlants.forEach((plant, i) => {
                const choice = document.createElement('div');
                choice.className = 'possession-choice';
                choice.onclick = () => selectPossessionTarget(i, plant);
                choice.id = 'choice' + i;
                choice.innerHTML = `
                    <div style="font-size: 2.5em; margin-bottom: 5px;">${plant.icon}</div>
                    <div style="color: #fff; font-size: 0.9em; font-weight: bold;">${plant.name}</div>
                    <div style="color: #ffd700; font-size: 0.75em; margin-top: 3px;">Lv.${plant.level}</div>
                `;
                choices.appendChild(choice);
            });
        }
        
        function selectPossessionTarget(index, plant) {
            G.possessionTarget = plant;
            
            document.querySelectorAll('.possession-choice').forEach(c => c.classList.remove('selected'));
            document.getElementById('choice' + index).classList.add('selected');
        }
        
        function confirmPossession() {
            if (!G.possessionTarget || !G.bossSoul) {
                msg('ì‹ë¬¼ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }
            
            // ìƒˆë¡œìš´ ë³´ìŠ¤ ìƒì„±!
            const newBoss = {
                basePlant: {
                    id: G.possessionTarget.id,
                    icon: G.possessionTarget.icon,
                    name: G.possessionTarget.name
                },
                possessedBy: {
                    id: G.bossSoul.id,
                    icon: G.bossSoul.icon,
                    name: G.bossSoul.name
                },
                finalForm: {
                    id: 'boss_' + G.possessionTarget.id + '_' + G.bossSoul.id + '_' + Date.now(),
                    icon: G.bossSoul.icon + G.possessionTarget.icon,
                    name: G.possessionTarget.name + ' ' + G.bossSoul.name,
                    title: '[í”Œë ˆì´ì–´ê°€ ë§Œë“  ë³´ìŠ¤]'
                },
                stats: {
                    hp: G.possessionTarget.hp * 10,
                    atk: G.possessionTarget.atk * 5,
                    def: (G.possessionTarget.def || 0) * 3
                },
                creator: 'Player_' + Date.now(),
                createdAt: Date.now()
            };
            
            G.userBosses.push(newBoss);
            
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            saveBoss(newBoss);
            
            showReward('ğŸ‰ ìƒˆë¡œìš´ ë³´ìŠ¤ íƒ„ìƒ!', `${newBoss.finalForm.icon} ${newBoss.finalForm.name}`);
            
            document.querySelector('.possession-overlay').remove();
            G.bossSoul = null;
            G.possessionTarget = null;
        }
        
        function cancelPossession() {
            document.querySelector('.possession-overlay').remove();
            G.bossSoul = null;
            G.possessionTarget = null;
            msg('ë¹™ì˜ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
        }
        
        function saveBoss(boss) {
            let bosses = JSON.parse(localStorage.getItem('userBosses') || '[]');
            bosses.push(boss);
            localStorage.setItem('userBosses', JSON.stringify(bosses));
        }
        
        function loadBosses() {
            const bosses = JSON.parse(localStorage.getItem('userBosses') || '[]');
            return bosses;
        }

        function startWave() {
            if (G.battle) {
                msg('ì´ë¯¸ ì „íˆ¬ ì¤‘ì…ë‹ˆë‹¤!');
                return;
            }

            G.battle = true;
            msg('âš”ï¸ ì „íˆ¬ ì‹œì‘!', 'success');
            
            G.battleInterval = setInterval(() => {
                // ì‹ë¬¼ ê³µê²©
                ['floor3', 'floor2', 'floor1'].forEach(floor => {
                    G.train[floor].forEach(plant => {
                        if (plant && G.monsters.length > 0) {
                            const target = G.monsters[0];
                            let dmg = plant.atk;
                            
                            // AI í•™ìŠµ (ì „íˆ¬ íšŸìˆ˜ì— ë”°ë¼ ê°•í•´ì§)
                            if (plant.battleCount > 100) dmg *= 1.5;
                            if (plant.battleCount > 1000) dmg *= 2;
                            
                            if (plant.attackType === 'explosive') dmg *= 1.5;
                            if (plant.attackType === 'heavy') dmg *= 2;
                            
                            target.currHp -= dmg;
                            plant.battleCount++;
                            
                            if (target.currHp <= 0) {
                                G.gold += target.gold;
                                
                                // ğŸ† ë³´ìŠ¤ ì²˜ì¹˜ ê°ì§€!
                                const isBoss = target.isBoss;
                                
                                G.monsters.shift();
                                
                                if (isBoss) {
                                    // ë³´ìŠ¤ ì²˜ì¹˜ ì‹œ íŠ¹ë³„ ì²˜ë¦¬
                                    clearInterval(G.battleInterval);
                                    G.battle = false;
                                    onBossDefeated(target);
                                    return;
                                }
                                
                                // ì¹´ë“œ ë“œë¡­
                                if (Math.random() < 0.15) {
                                    const ids = Object.keys(PLANTS);
                                    const randomId = ids[Math.floor(Math.random() * ids.length)];
                                    G.deck.push(createPlant(randomId));
                                }
                            }
                        }
                    });
                });

                // í–‡ë¹› ìƒì‚°
                ['floor1', 'floor2', 'floor3'].forEach(floor => {
                    G.train[floor].forEach(plant => {
                        if (plant && plant.special === 'sun') {
                            G.sun = Math.min(G.maxSun, G.sun + 1);
                        }
                    });
                });

                // ëª¬ìŠ¤í„° ê³µê²©
                if (G.monsters.length > 0) {
                    const monster = G.monsters[0];
                    let damaged = false;
                    
                    ['floor3', 'floor2', 'floor1'].forEach(floor => {
                        if (!damaged) {
                            G.train[floor].forEach((plant, i) => {
                                if (plant && !damaged) {
                                    plant.currHp -= monster.atk;
                                    damaged = true;
                                    if (plant.currHp <= 0) {
                                        G.train[floor][i] = null;
                                    }
                                }
                            });
                        }
                    });
                }

                updateAll();

                // ì „íˆ¬ ì¢…ë£Œ
                if (G.monsters.length === 0) {
                    clearInterval(G.battleInterval);
                    G.battle = false;
                    G.wave++;
                    
                    if (G.wave % 10 === 0) {
                        G.chapter = Math.min(5, Math.floor(G.wave / 10) + 1);
                        showLevelUp();
                    }
                    
                    const bonus = G.wave * 100;
                    G.gold += bonus;
                    
                    // ëŒ€ëŸ‰ ì¹´ë“œ ë³´ìƒ
                    for (let i = 0; i < 5; i++) {
                        const ids = Object.keys(PLANTS);
                        const randomId = ids[Math.floor(Math.random() * ids.length)];
                        G.deck.push(createPlant(randomId));
                    }
                    
                    showReward('ğŸ‰ ì›¨ì´ë¸Œ í´ë¦¬ì–´!', `+${bonus}G + ì¹´ë“œ 5ì¥!`);
                    
                    endTurn();
                    spawnMonsters();
                    updateAll();
                }
            }, 1000);
        }

        function endTurn() {
            G.turn++;
            G.sun = Math.min(G.maxSun, G.sun + 3);
            
            if (G.hand.length < 5 && G.deck.length > 0) {
                drawCard();
            }

            updateAll();
        }

        // ==================== ìƒì  ====================
        function buyCard() {
            if (G.gold < 10) {
                msg('ê³¨ë“œ ë¶€ì¡±!');
                return;
            }
            G.gold -= 10;
            
            const ids = Object.keys(PLANTS).filter(id => PLANTS[id].rarity !== 'hybrid');
            const randomId = ids[Math.floor(Math.random() * ids.length)];
            G.deck.push(createPlant(randomId));
            
            msg(`${PLANTS[randomId].icon} ${PLANTS[randomId].name} íšë“!`, 'success');
            updateAll();
        }

        function buyRare() {
            if (G.gold < 50) {
                msg('ê³¨ë“œ ë¶€ì¡±!');
                return;
            }
            G.gold -= 50;
            
            const rares = Object.keys(PLANTS).filter(id => 
                PLANTS[id].rarity === 'uncommon' || PLANTS[id].rarity === 'rare'
            );
            const randomId = rares[Math.floor(Math.random() * rares.length)] || 'rose';
            G.deck.push(createPlant(randomId));
            
            msg(`âœ¨ ${PLANTS[randomId].icon} ${PLANTS[randomId].name} íšë“!`, 'success');
            updateAll();
        }

        function buyPack() {
            if (G.gold < 40) {
                msg('ê³¨ë“œ ë¶€ì¡±!');
                return;
            }
            G.gold -= 40;
            
            for (let i = 0; i < 5; i++) {
                const ids = Object.keys(PLANTS).filter(id => PLANTS[id].rarity !== 'hybrid');
                const randomId = ids[Math.floor(Math.random() * ids.length)];
                G.deck.push(createPlant(randomId));
            }
            
            showReward('ğŸ ì”¨ì•— íŒ©!', '5ì¥ íšë“!');
            updateAll();
        }

        function buyLegendary() {
            if (G.gold < 200) {
                msg('ê³¨ë“œ ë¶€ì¡±!');
                return;
            }
            G.gold -= 200;
            
            const legendaries = Object.keys(PLANTS).filter(id => PLANTS[id].rarity === 'rare');
            const randomId = legendaries[Math.floor(Math.random() * legendaries.length)] || 'lily';
            G.deck.push(createPlant(randomId));
            
            showReward('ğŸŒŸ ë ˆì „ë”ë¦¬!', `${PLANTS[randomId].icon} ${PLANTS[randomId].name}!`);
            updateAll();
        }

        // ==================== UI ====================
        function updateAll() {
            document.getElementById('gold').textContent = G.gold;
            document.getElementById('deckSize').textContent = G.deck.length;
            document.getElementById('wave').textContent = G.wave;
            document.getElementById('codexPercent').textContent = (G.codex.size / 999 * 100).toFixed(1) + '%';
            document.getElementById('sun').textContent = G.sun;
            document.getElementById('waveNum').textContent = G.wave;
            document.getElementById('deckCount').textContent = G.deck.length;
            document.getElementById('codexFound').textContent = G.codex.size;
            document.getElementById('codexPct').textContent = (G.codex.size / 999 * 100).toFixed(1);
            document.getElementById('chapter').textContent = G.chapter;

            renderTrain();
            renderHand();
            renderMonsters();
            renderDeck();
            renderFusion();
            renderCodex();
        }

        function renderTrain() {
            ['floor1', 'floor2', 'floor3'].forEach(floor => {
                const grid = document.getElementById(floor);
                grid.innerHTML = '';
                
                G.train[floor].forEach((plant, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'plant-slot' + (plant ? '' : ' empty');
                    slot.onclick = () => playCard(floor, i);
                    
                    if (plant) {
                        slot.innerHTML = `
                            ${plant.icon}
                            <div class="plant-level">Lv.${plant.level}</div>
                            <div class="plant-hp-bar">
                                <div class="plant-hp-fill" style="width: ${plant.currHp / plant.maxHp * 100}%"></div>
                            </div>
                        `;
                    } else {
                        slot.innerHTML = 'â•';
                    }
                    
                    grid.appendChild(slot);
                });
            });
        }

        function renderHand() {
            const hand = document.getElementById('hand');
            hand.innerHTML = '';
            
            G.hand.forEach((card, i) => {
                const div = document.createElement('div');
                let classes = 'card';
                if (G.selectedCard === i) classes += ' selected';
                if (card.rarity === 'hybrid') classes += ' hybrid';
                if (card.rarity === 'rare') classes += ' legendary';
                div.className = classes;
                div.onclick = () => selectCard(i);
                
                div.innerHTML = `
                    <div class="card-cost">â˜€ï¸${card.cost}</div>
                    <div class="card-icon">${card.icon}</div>
                    <div class="card-name">${card.name}</div>
                    <div class="card-stats">
                        <span>â¤ï¸${card.hp}</span>
                        <span>âš”ï¸${card.atk}</span>
                    </div>
                    <div class="card-genes">${card.genes.attack}${card.genes.defense}${card.genes.speed}</div>
                `;
                
                hand.appendChild(div);
            });
        }

        function renderMonsters() {
            const monsters = document.getElementById('monsters');
            monsters.innerHTML = '';
            
            G.monsters.forEach(m => {
                const div = document.createElement('div');
                div.className = 'monster';
                div.innerHTML = `
                    ${m.icon}
                    <div class="monster-hp">${m.currHp}/${m.maxHp}</div>
                `;
                monsters.appendChild(div);
            });
        }

        function renderDeck() {
            const list = document.getElementById('deckList');
            list.innerHTML = '';
            
            G.deck.slice().reverse().forEach(card => {
                const div = document.createElement('div');
                div.style.cssText = 'background: rgba(36,52,71,0.6); border: 2px solid rgba(34,139,34,0.6); border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.3s;';
                if (card.rarity === 'hybrid') div.style.borderColor = 'rgba(168,85,247,0.8)';
                
                div.onmouseenter = () => div.style.transform = 'translateX(5px)';
                div.onmouseleave = () => div.style.transform = 'translateX(0)';
                
                div.onclick = () => {
                    if (G.selectingSlot !== null) {
                        G.fusionSlots[G.selectingSlot] = card;
                        G.selectingSlot = null;
                        showTab('fusion');
                        updateAll();
                    }
                };
                
                div.innerHTML = `
                    <span style="font-size: 1.8em;">${card.icon}</span>
                    <span style="color: #fff; flex: 1; margin-left: 12px; font-weight: bold;">${card.name}</span>
                    <span style="color: var(--accent-gold); font-size: 0.85em;">${card.genes.attack}${card.genes.defense}${card.genes.speed}</span>
                `;
                list.appendChild(div);
            });
        }

        function renderFusion() {
            [0, 1].forEach(i => {
                const display = document.getElementById(`slot${i+1}Display`);
                const slot = document.getElementById(`slot${i+1}`);
                
                if (G.fusionSlots[i]) {
                    const p = G.fusionSlots[i];
                    display.innerHTML = `
                        <div style="font-size: 3em; margin: 12px 0;">${p.icon}</div>
                        <div style="color: #fff; font-weight: bold; margin-bottom: 8px;">${p.name}</div>
                        <div style="font-size: 0.8em;">
                            <div style="color: ${gradeColor(p.genes.attack)};">ğŸ”´ ${p.genes.attack}</div>
                            <div style="color: ${gradeColor(p.genes.defense)};">ğŸŸ¢ ${p.genes.defense}</div>
                            <div style="color: ${gradeColor(p.genes.speed)};">ğŸ”µ ${p.genes.speed}</div>
                        </div>
                    `;
                    slot.classList.add('filled');
                } else {
                    display.textContent = 'í´ë¦­í•˜ì—¬ ì„ íƒ';
                    slot.classList.remove('filled');
                }
            });

            const preview = document.getElementById('previewIcon');
            const name = document.getElementById('previewName');
            const genes = document.getElementById('genePreview');
            
            if (G.fusionSlots[0] && G.fusionSlots[1]) {
                const p1 = G.fusionSlots[0];
                const p2 = G.fusionSlots[1];
                
                preview.textContent = Math.random() < 0.5 ? p1.icon : p2.icon;
                name.textContent = p1.name.charAt(0) + p2.name;
                
                genes.innerHTML = `
                    <div class="gene-bar">
                        <span>ğŸ”´ ê³µê²©:</span>
                        <span class="gene-grade">${p1.genes.attack} ~ ${p2.genes.attack}</span>
                    </div>
                    <div class="gene-bar">
                        <span>ğŸŸ¢ ë°©ì–´:</span>
                        <span class="gene-grade">${p1.genes.defense} ~ ${p2.genes.defense}</span>
                    </div>
                    <div class="gene-bar">
                        <span>ğŸ”µ ì†ë„:</span>
                        <span class="gene-grade">${p1.genes.speed} ~ ${p2.genes.speed}</span>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,255,136,0.15); border-radius: 8px;">
                        <div style="color: var(--accent-green);">ì˜ˆìƒ ëŠ¥ë ¥:</div>
                        <div style="color: #fff; margin-top: 5px;">
                            HP: ~${Math.floor((p1.hp + p2.hp) / 2 * 1.3)}<br>
                            ATK: ~${Math.floor((p1.atk + p2.atk) / 2 * 1.2)}
                        </div>
                    </div>
                `;
            } else {
                preview.textContent = 'â“';
                name.textContent = '???';
                genes.innerHTML = '<div style="color: var(--accent-purple); text-align: center;">ë¶€ëª¨ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>';
            }
        }

        function renderCodex() {
            const grid = document.getElementById('codexGrid');
            grid.innerHTML = '';
            
            const allPlants = Object.values(PLANTS).slice(0, 40);
            
            allPlants.forEach(plant => {
                const div = document.createElement('div');
                div.className = 'codex-item';
                
                if (G.codex.has(plant.id)) {
                    div.classList.add('discovered');
                    div.innerHTML = `
                        <div style="font-size: 2.2em; margin-bottom: 5px;">${plant.icon}</div>
                        <div style="color: #fff; font-size: 0.7em; font-weight: bold;">${plant.name}</div>
                    `;
                    
                    if (G.newDiscoveries.has(plant.id)) {
                        div.innerHTML += '<div class="codex-new-badge">NEW!</div>';
                    }
                } else {
                    div.classList.add('locked');
                    div.innerHTML = '<div style="font-size: 2.5em;">â“</div>';
                }
                
                grid.appendChild(div);
            });
        }

        function msg(text, type = 'info') {
            const m = document.getElementById('msg');
            m.textContent = text;
            m.className = 'message' + (type === 'success' ? ' success' : '');
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabNames = { deck: 'ë±', fusion: 'í•©ì„±', codex: 'ë„ê°', shop: 'ìƒì ' };
            const tabEl = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent.includes(tabNames[tab]));
            if (tabEl) tabEl.classList.add('active');
            
            document.getElementById(tab + '-tab').classList.add('active');
            updateAll();
        }

        function showReward(title, text) {
            const overlay = document.createElement('div');
            overlay.className = 'reward-overlay';
            overlay.onclick = () => overlay.remove();
            
            overlay.innerHTML = `
                <div class="reward-popup">
                    <div class="reward-icon">ğŸ‰</div>
                    <div class="reward-title">${title}</div>
                    <div class="reward-text">${text}</div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            setTimeout(() => overlay.remove(), 3000);
        }

        function showLevelUp() {
            const effect = document.createElement('div');
            effect.className = 'levelup-effect';
            effect.textContent = 'â­ LEVEL UP! â­';
            document.body.appendChild(effect);
            setTimeout(() => effect.remove(), 1500);
        }

        function showStory() {
            const chapter = CHAPTERS[G.chapter - 1];
            showReward(`ğŸ“œ Chapter ${chapter.num}`, `${chapter.title}: ${chapter.desc}`);
        }

        // ==================== ì‹œì‘ ====================
        window.onload = init;
        
        // ìë™ ì €ì¥
        setInterval(() => {
            G.lastSaveTime = Date.now();
        }, 60000);
        
        // ==================== ëª¨ë°”ì¼ ê¸°ëŠ¥ ====================
        
        // í–…í‹± í”¼ë“œë°±
        function vibrate(pattern) {
            if (G.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }
        
        function toggleVibration() {
            G.vibrationEnabled = !G.vibrationEnabled;
            const icon = document.getElementById('vibrateToggle');
            icon.textContent = G.vibrationEnabled ? 'ğŸ“³' : 'ğŸ”‡';
            vibrate(50);
        }
        
        // í„°ì¹˜ í”¼ë“œë°±
        function showTouchFeedback(x, y) {
            if (!G.touchFeedback) return;
            
            const feedback = document.createElement('div');
            feedback.className = 'touch-feedback';
            feedback.style.left = x + 'px';
            feedback.style.top = y + 'px';
            document.body.appendChild(feedback);
            
            setTimeout(() => feedback.remove(), 600);
        }
        
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                showTouchFeedback(touch.clientX, touch.clientY);
            }
        });
        
        // PWA ì„¤ì¹˜
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            const installPrompt = document.getElementById('installPrompt');
            if (installPrompt) {
                installPrompt.classList.add('show');
            }
        });
        
        function installApp() {
            if (!deferredPrompt) {
                msg('ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆê±°ë‚˜ ì„¤ì¹˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    msg('ì•± ì„¤ì¹˜ ì™„ë£Œ! ğŸ‰', 'success');
                    vibrate([100, 50, 100]);
                    document.getElementById('installPrompt').classList.remove('show');
                }
                deferredPrompt = null;
            });
        }
        
        // ë°°í„°ë¦¬ ëª¨ë‹ˆí„°ë§
        function updateBattery() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    const percent = Math.floor(battery.level * 100);
                    const batteryEl = document.getElementById('battery');
                    
                    if (batteryEl) {
                        batteryEl.textContent = `ğŸ”‹ ${percent}%`;
                        
                        if (percent < 20) {
                            batteryEl.classList.add('low');
                            if (!G.powerSaveMode) {
                                enablePowerSaveMode();
                            }
                        } else {
                            batteryEl.classList.remove('low');
                        }
                    }
                    
                    battery.addEventListener('levelchange', updateBattery);
                });
            }
        }
        
        function enablePowerSaveMode() {
            G.powerSaveMode = true;
            document.body.classList.add('power-save-mode');
            msg('âš¡ ì ˆì „ ëª¨ë“œ í™œì„±í™”', 'info');
            
            // ë³„ ìˆ¨ê¸°ê¸°
            const stars = document.getElementById('stars');
            if (stars) stars.style.display = 'none';
        }
        
        function disablePowerSaveMode() {
            G.powerSaveMode = false;
            document.body.classList.remove('power-save-mode');
            
            const stars = document.getElementById('stars');
            if (stars) stars.style.display = 'block';
        }
        
        // Service Worker ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('Service Worker ë“±ë¡ ì™„ë£Œ'))
                    .catch(err => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
            });
        }
        
        // ì˜¤í”„ë¼ì¸ ê°ì§€
        window.addEventListener('online', () => {
            msg('ğŸŒ ì˜¨ë¼ì¸ ìƒíƒœ', 'success');
        });
        
        window.addEventListener('offline', () => {
            msg('ğŸ“¡ ì˜¤í”„ë¼ì¸ ëª¨ë“œ', 'info');
        });
        
        // ì•± ì„¤ì¹˜ ê°ì§€
        window.addEventListener('appinstalled', () => {
            msg('âœ… ì•± ì„¤ì¹˜ ì™„ë£Œ!', 'success');
            vibrate([200, 100, 200]);
        });
        
        // í™”ë©´ ë°©í–¥ ë³€ê²½ ê°ì§€
        window.addEventListener('orientationchange', () => {
            setTimeout(updateAll, 300);
        });
        
        // ì´ˆê¸°í™” ì‹œ ëª¨ë°”ì¼ ê¸°ëŠ¥ í™œì„±í™”
        setTimeout(() => {
            updateBattery();
            
            // ëª¨ë°”ì¼ ìµœì í™” ì ìš©
            if (isMobile) {
                // ë³„ ê°œìˆ˜ ì¤„ì´ê¸°
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, i) => {
                    if (i % 2 === 0) star.remove();
                });
            }
        }, 1000);
    </script>
</body>
</html>